# Goè¯­è¨€çš„GPMè°ƒåº¦å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

ç›¸ä¿¡å¾ˆå¤šäººéƒ½å¬è¯´è¿‡Goè¯­è¨€å¤©ç„¶æ”¯æŒé«˜å¹¶å‘ï¼ŒåŸå› æ˜¯å†…éƒ¨æœ‰åç¨‹ï¼ˆgoroutineï¼‰åŠ æŒï¼Œå¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å¯åŠ¨æˆåƒä¸Šä¸‡ä¸ªåç¨‹ã€‚é‚£ä¹ˆï¼Œå®ƒå‡­ä»€ä¹ˆåšåˆ°å¦‚æ­¤é«˜çš„å¹¶å‘å‘¢ï¼Ÿé‚£å°±éœ€è¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯å¹¶å‘æ¨¡å‹ã€‚


## å¹¶å‘æ¨¡å‹

è‘—åçš„C++ä¸“å®¶Herb Sutteræ›¾ç»è¯´è¿‡â€œå…è´¹çš„åˆé¤å·²ç»ç»ˆç»“â€ã€‚ä¸ºäº†è®©ä»£ç è¿è¡Œçš„æ›´å¿«ï¼Œå•çº¯ä¾é æ›´å¿«çš„ç¡¬ä»¶å·²ç»æ— æ³•å¾—åˆ°æ»¡è¶³ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨å¤šæ ¸æ¥æŒ–æ˜å¹¶è¡Œçš„ä»·å€¼ï¼Œè€Œå¹¶å‘æ¨¡å‹çš„ç›®çš„å°±æ˜¯æ¥å‘Šè¯‰ä½ ä¸åŒæ‰§è¡Œå®ä½“ä¹‹é—´æ˜¯å¦‚ä½•åä½œçš„ã€‚

å½“ç„¶ï¼Œä¸åŒçš„å¹¶å‘æ¨¡å‹çš„åä½œæ–¹å¼ä¹Ÿä¸å°½ç›¸åŒï¼Œå¸¸è§çš„å¹¶å‘æ¨¡å‹æœ‰ä¸ƒç§ï¼š

- çº¿ç¨‹ä¸é”
- å‡½æ•°å¼ç¼–ç¨‹
- Clojureä¹‹é“
- actor
- é€šè®¯é¡ºåºè¿›ç¨‹ï¼ˆCSPï¼‰
- æ•°æ®çº§å¹¶è¡Œ
- Lambdaæ¶æ„

è€Œä»Šå¤©ï¼Œæˆ‘ä»¬åªè®²ä¸Goè¯­è¨€ç›¸å…³çš„å¹¶å‘æ¨¡å‹CSPï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ä¹¦ç±ã€Šä¸ƒå‘¨ä¸ƒå¹¶å‘æ¨¡å‹ã€‹ã€‚


### CSPç¯‡

CSPï¼Œå…¨ç§°Communicating Sequential Processesï¼Œæ„ä¸ºé€šè®¯é¡ºåºè¿›ç¨‹ï¼Œå®ƒæ˜¯ä¸ƒå¤§å¹¶å‘æ¨¡å‹ä¸­çš„ä¸€ç§ï¼Œå®ƒçš„æ ¸å¿ƒè§‚å¿µæ˜¯å°†ä¸¤ä¸ªå¹¶å‘æ‰§è¡Œçš„å®ä½“é€šè¿‡é€šé“channelè¿æ¥èµ·æ¥ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½é€šè¿‡channelä¼ è¾“ã€‚å…¶å®CSPæ¦‚å¿µæ—©åœ¨1978å¹´å°±è¢«ä¸œå°¼Â·éœå°”æå‡ºï¼Œç”±äºè¿‘æ¥Goè¯­è¨€çš„å…´èµ·ï¼ŒCSPåˆç«äº†èµ·æ¥ã€‚
é‚£ä¹ˆCSPä¸Goè¯­è¨€æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹Goè¯­è¨€å¯¹CSPå¹¶å‘æ¨¡å‹çš„å®ç°â€”â€”GPMè°ƒåº¦æ¨¡å‹ã€‚


### GPMè°ƒåº¦æ¨¡å‹

GPMä»£è¡¨äº†ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯Goroutineã€Processorã€Machineã€‚

![](../images/17188139512ef9a8.jpg)

- Goroutineï¼šå°±æ˜¯å’±ä»¬å¸¸ç”¨çš„ç”¨goå…³é”®å­—åˆ›å»ºçš„æ‰§è¡Œä½“ï¼Œå®ƒå¯¹åº”ä¸€ä¸ªç»“æ„ä½“gï¼Œç»“æ„ä½“é‡Œä¿å­˜äº†goroutineçš„å †æ ˆä¿¡æ¯
- Machineï¼šè¡¨ç¤ºæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹
- Processorï¼šè¡¨ç¤ºå¤„ç†å™¨ï¼Œæœ‰äº†å®ƒæ‰èƒ½å»ºç«‹Gã€Mçš„è”ç³»

### Goroutine

Goroutineå°±æ˜¯ä»£ç ä¸­ä½¿ç”¨goå…³é”®è¯åˆ›å»ºçš„æ‰§è¡Œå•å…ƒï¼Œä¹Ÿæ˜¯å¤§å®¶ç†ŸçŸ¥çš„æœ‰â€œè½»é‡çº§çº¿ç¨‹â€ä¹‹ç§°çš„åç¨‹ï¼Œåç¨‹æ˜¯ä¸ä¸ºæ“ä½œç³»ç»Ÿæ‰€çŸ¥çš„ï¼Œå®ƒç”±ç¼–ç¨‹è¯­è¨€å±‚é¢å®ç°ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ä¸éœ€è¦ç»è¿‡å†…æ ¸æ€ï¼Œå†åŠ ä¸Šåç¨‹å ç”¨çš„å†…å­˜ç©ºé—´æå°ï¼Œæ‰€ä»¥æœ‰ç€éå¸¸å¤§çš„å‘å±•æ½œåŠ›ã€‚

```go
go func() {}()
```

å¤åˆ¶ä»£ç åœ¨Goè¯­è¨€ä¸­ï¼ŒGoroutineç”±ä¸€ä¸ªåä¸ºruntime.goçš„ç»“æ„ä½“è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä½“éå¸¸å¤æ‚ï¼Œæœ‰40å¤šä¸ªæˆå‘˜å˜é‡ï¼Œä¸»è¦å­˜å‚¨æ‰§è¡Œæ ˆã€çŠ¶æ€ã€å½“å‰å ç”¨çš„çº¿ç¨‹ã€è°ƒåº¦ç›¸å…³çš„æ•°æ®ã€‚è¿˜æœ‰ç©å¤§å®¶å¾ˆæƒ³è·å–çš„goroutineæ ‡è¯†ï¼Œä½†æ˜¯å¾ˆæŠ±æ­‰ï¼Œå®˜æ–¹è€ƒè™‘åˆ°Goè¯­è¨€çš„å‘å±•ï¼Œè®¾ç½®æˆç§æœ‰äº†ï¼Œä¸ç»™ä½ è°ƒç”¨ğŸ˜ã€‚

```go
type g struct {
	stack struct {
		lo uintptr
		hi uintptr
	} 							// æ ˆå†…å­˜ï¼š[stack.lo, stack.hi)
	stackguard0	uintptr
	stackguard1 uintptr

	_panic       *_panic
	_defer       *_defer
	m            *m				// å½“å‰çš„ m
	sched        gobuf
	stktopsp     uintptr		// æœŸæœ› sp ä½äºæ ˆé¡¶ï¼Œç”¨äºå›æº¯æ£€æŸ¥
	param        unsafe.Pointer // wakeup å”¤é†’æ—¶å€™ä¼ é€’çš„å‚æ•°
	atomicstatus uint32
	goid         int64
	preempt      bool       	// æŠ¢å ä¿¡å·ï¼Œstackguard0 = stackpreempt çš„å‰¯æœ¬
	timer        *timer         // ä¸º time.Sleep ç¼“å­˜çš„è®¡æ—¶å™¨

	...
}
```
Goroutineè°ƒåº¦ç›¸å…³çš„æ•°æ®å­˜å‚¨åœ¨schedï¼Œåœ¨åç¨‹åˆ‡æ¢ã€æ¢å¤ä¸Šä¸‹æ–‡çš„æ—¶å€™ç”¨åˆ°ã€‚

```go
type gobuf struct {
	sp   uintptr
	pc   uintptr
	g    guintptr
	ret  sys.Uintreg
	...
}
```

Må°±æ˜¯å¯¹åº”æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ï¼Œæœ€å¤šä¼šæœ‰GOMAXPROCSä¸ªæ´»è·ƒçº¿ç¨‹èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹GOMAXPROCSè¢«è®¾ç½®ä¸ºå†…æ ¸æ•°ï¼Œå‡å¦‚æœ‰å››ä¸ªå†…æ ¸ï¼Œé‚£ä¹ˆé»˜è®¤å°±åˆ›å»ºå››ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªruntime.mç»“æ„ä½“ã€‚çº¿ç¨‹æ•°ç­‰äºCPUä¸ªæ•°çš„åŸå› æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…åˆ°ä¸€ä¸ªCPUä¸Šå°±ä¸è‡³äºå‡ºç°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯ä»¥ä¿è¯ç³»ç»Ÿå¼€é”€é™åˆ°æœ€ä½ã€‚

```go
type m struct {
	g0   *g 
	curg *g
	...
}
```

Mé‡Œé¢å­˜äº†ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯g0ï¼Œä¸€ä¸ªæ˜¯curgã€‚

- g0ï¼šä¼šæ·±åº¦å‚ä¸è¿è¡Œæ—¶çš„è°ƒåº¦è¿‡ç¨‹ï¼Œæ¯”å¦‚goroutineçš„åˆ›å»ºã€å†…å­˜åˆ†é…ç­‰
- curgï¼šä»£è¡¨å½“å‰æ­£åœ¨çº¿ç¨‹ä¸Šæ‰§è¡Œçš„goroutineã€‚

åˆšæ‰è¯´Pæ˜¯è´Ÿè´£Mä¸Gçš„å…³è”ï¼Œæ‰€ä»¥Mé‡Œé¢è¿˜è¦å­˜å‚¨ä¸Pç›¸å…³çš„æ•°æ®ã€‚

```go
type m struct {
  ...
	p             puintptr
	nextp         puintptr
	oldp          puintptr
}
```

- pï¼šæ­£åœ¨è¿è¡Œä»£ç çš„å¤„ç†å™¨
- nextpï¼šæš‚å­˜çš„å¤„ç†å™¨
- oldpï¼šç³»ç»Ÿè°ƒç”¨ä¹‹å‰çš„çº¿ç¨‹çš„å¤„ç†å™¨

### Processor

Proccessorè´Ÿè´£Machineä¸Goroutineçš„è¿æ¥ï¼Œå®ƒèƒ½æä¾›çº¿ç¨‹éœ€è¦çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿèƒ½åˆ†é…Gåˆ°å®ƒåº”è¯¥å»çš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œæœ‰äº†å®ƒï¼Œæ¯ä¸ªGéƒ½èƒ½å¾—åˆ°åˆç†çš„è°ƒç”¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¸å†æµ‘æ°´æ‘¸é±¼ï¼ŒçœŸæ˜¯å±…å®¶å¿…å¤‡ä¹‹è‰¯å“ã€‚

åŒæ ·çš„ï¼Œå¤„ç†å™¨çš„æ•°é‡ä¹Ÿæ˜¯é»˜è®¤æŒ‰ç…§GOMAXPROCSæ¥è®¾ç½®çš„ï¼Œä¸çº¿ç¨‹çš„æ•°é‡ä¸€ä¸€å¯¹åº”ã€‚

```go
type p struct {
	m           muintptr

	runqhead uint32
	runqtail uint32
	runq     [256]guintptr
	runnext guintptr
	...
}
```

ç»“æ„ä½“Pä¸­å­˜å‚¨äº†æ€§èƒ½è¿½è¸ªã€åƒåœ¾å›æ”¶ã€è®¡æ—¶å™¨ç­‰ç›¸å…³çš„å­—æ®µå¤–ï¼Œè¿˜å­˜å‚¨äº†å¤„ç†å™¨çš„å¾…è¿è¡Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ˜¯å¾…æ‰§è¡Œçš„Goroutineåˆ—è¡¨ã€‚

### ä¸‰è€…çš„å…³ç³»

é¦–å…ˆï¼Œé»˜è®¤å¯åŠ¨å››ä¸ªçº¿ç¨‹å››ä¸ªå¤„ç†å™¨ï¼Œç„¶åäº’ç›¸ç»‘å®šã€‚

![](../images/17188139b47a27ca.jpg)

è¿™ä¸ªæ—¶å€™ï¼Œä¸€ä¸ªGoroutineç»“æ„ä½“è¢«åˆ›å»ºï¼Œåœ¨è¿›è¡Œå‡½æ•°ä½“åœ°å€ã€å‚æ•°èµ·å§‹åœ°å€ã€å‚æ•°é•¿åº¦ç­‰ä¿¡æ¯ä»¥åŠè°ƒåº¦ç›¸å…³å±æ€§æ›´æ–°ä¹‹åï¼Œå®ƒå°±è¦è¿›åˆ°ä¸€ä¸ªå¤„ç†å™¨çš„é˜Ÿåˆ—ç­‰å¾…å‘è½¦ã€‚

![](../images/17188139f32b2558.jpg)

å•¥ï¼Œåˆåˆ›å»ºäº†ä¸€ä¸ªGï¼Ÿé‚£å°±è½®æµå¾€å…¶ä»–Pé‡Œé¢æ”¾å‘—ï¼Œç›¸ä¿¡ä½ æ’é˜Ÿå–å·çš„æ—¶å€™çœ‹åˆ°å…¶ä»–çª—å£æ²¡äººæ’é˜Ÿä¹Ÿä¼šè¿‡å»çš„ã€‚

![](../images/1718813a3359a1c0.jpg)

å‡å¦‚æœ‰å¾ˆå¤šGï¼Œéƒ½å¡æ»¡äº†æ€ä¹ˆåŠå‘¢ï¼Ÿé‚£å°±ä¸æŠŠGå¡åˆ°å¤„ç†å™¨çš„ç§æœ‰é˜Ÿåˆ—é‡Œäº†ï¼Œè€Œæ˜¯æŠŠå®ƒå¡åˆ°å…¨å±€é˜Ÿåˆ—é‡Œï¼ˆå€™è½¦å¤§å…ï¼‰ã€‚

![](../images/1718813a71f700a1.jpg)

é™¤äº†å¾€é‡Œå¡ä¹‹å¤–ï¼ŒMè¿™è¾¹è¿˜è¦ç–¯ç‹‚å¾€å¤–å–ï¼Œé¦–å…ˆå»å¤„ç†å™¨çš„ç§æœ‰é˜Ÿåˆ—é‡Œå–Gæ‰§è¡Œï¼Œå¦‚æœå–å®Œçš„è¯å°±å»å…¨å±€é˜Ÿåˆ—å–ï¼Œå¦‚æœå…¨å±€é˜Ÿåˆ—é‡Œä¹Ÿæ²¡æœ‰çš„è¯ï¼Œå°±å»å…¶ä»–å¤„ç†å™¨é˜Ÿåˆ—é‡Œå·ï¼Œå“‡ï¼Œè¿™ä¹ˆé¥¥æ¸´ï¼Œç®€ç›´æ˜¯æ¶é­”å•Šï¼

![](../images/1718813abb679031.jpg)

å¦‚æœå“ªé‡Œéƒ½æ²¡æ‰¾åˆ°è¦æ‰§è¡Œçš„Gå‘¢ï¼Ÿé‚£Må°±ä¼šå› ä¸ºå¤ªå¤±æœ›å’ŒPæ–­å¼€å…³ç³»ï¼Œç„¶åå»ç¡è§‰ï¼ˆidleï¼‰äº†ã€‚

![](../images/1718813afa26977e.jpg)

é‚£å¦‚æœä¸¤ä¸ªGoroutineæ­£åœ¨é€šè¿‡channelåšä¸€äº›æ©æ©çˆ±çˆ±çš„äº‹é˜»å¡ä½äº†æ€ä¹ˆåŠï¼Œéš¾é“Mè¦ç­‰ä»–ä»¬å®Œäº‹äº†å†ç»§ç»­æ‰§è¡Œï¼Ÿæ˜¾ç„¶ä¸ä¼šï¼ŒMå¹¶ä¸ç¨€ç½•è¿™å¯¹Goç”·å¥³ï¼Œè€Œä¼šè½¬èº«å»æ‰¾åˆ«çš„Gæ‰§è¡Œã€‚

![](../images/1718813b326b7c73.jpg)


## ç³»ç»Ÿè°ƒç”¨

å¦‚æœGè¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨syscallï¼ŒMä¹Ÿä¼šè·Ÿç€è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ï¼Œé‚£ä¹ˆè¿™ä¸ªPç•™åœ¨è¿™é‡Œå°±æµªè´¹äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ç‚¹ç²¾å¦™ä¹‹å¤„åœ¨äºï¼ŒPä¸ä¼šå‚»å‚»çš„ç­‰å¾…Gå’ŒMç³»ç»Ÿè°ƒç”¨å®Œæˆï¼Œè€Œä¼šå»æ‰¾å…¶ä»–æ¯”è¾ƒé—²çš„Mæ‰§è¡Œå…¶ä»–çš„Gã€‚

![](../images/1718813b73c47064.jpg)

å½“Gå®Œæˆäº†ç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸ºè¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥å¿…é¡»è¦å†æ‰¾ä¸€ä¸ªç©ºé—²çš„å¤„ç†å™¨å‘è½¦ã€‚

![](../images/1718813bad18d998.jpg)

å¦‚æœæ²¡æœ‰ç©ºé—²çš„å¤„ç†å™¨äº†ï¼Œé‚£å°±åªèƒ½æŠŠGæ”¾å›å…¨å±€é˜Ÿåˆ—å½“ä¸­ç­‰å¾…åˆ†é…ã€‚

![](../images/1718813bec3d6674.jpg)


## sysmon

sysmonæ˜¯æˆ‘ä»¬çš„ä¿æ´é˜¿å§¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªMï¼Œåˆå«ç›‘æ§çº¿ç¨‹ï¼Œä¸éœ€è¦På°±å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œæ¯20us~10msä¼šè¢«å”¤é†’ä¸€æ¬¡å‡ºæ¥æ‰“æ‰«å«ç”Ÿï¼Œä¸»è¦å·¥ä½œå°±æ˜¯å›æ”¶åƒåœ¾ã€å›æ”¶é•¿æ—¶é—´ç³»ç»Ÿè°ƒåº¦é˜»å¡çš„Pã€å‘é•¿æ—¶é—´è¿è¡Œçš„Gå‘å‡ºæŠ¢å è°ƒåº¦ç­‰ç­‰ã€‚

> ä½œè€…ï¼šå¹³ä¹Ÿ
> é“¾æ¥ï¼šhttps://juejin.im/post/5e999ead518825739b2d44d7
> æ¥æºï¼šæ˜é‡‘
> è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚





















# goroutineè°ƒåº¦å™¨æ¦‚è¿°

## goroutineç®€ä»‹

goroutineæ˜¯Goè¯­è¨€å®ç°çš„ç”¨æˆ·æ€çº¿ç¨‹ï¼Œä¸»è¦ç”¨æ¥è§£å†³æ“ä½œç³»ç»Ÿçº¿ç¨‹å¤ªâ€œé‡â€çš„é—®é¢˜ï¼Œæ‰€è°“çš„å¤ªé‡ï¼Œä¸»è¦è¡¨ç°åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š

- åˆ›å»ºå’Œåˆ‡æ¢å¤ªé‡ï¼šæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢éƒ½éœ€è¦è¿›å…¥å†…æ ¸ï¼Œè€Œè¿›å…¥å†…æ ¸æ‰€æ¶ˆè€—çš„æ€§èƒ½ä»£ä»·æ¯”è¾ƒé«˜ï¼Œå¼€é”€è¾ƒå¤§ï¼›
- å†…å­˜ä½¿ç”¨å¤ªé‡ï¼šä¸€æ–¹é¢ï¼Œä¸ºäº†å°½é‡é¿å…æç«¯æƒ…å†µä¸‹æ“ä½œç³»ç»Ÿçº¿ç¨‹æ ˆçš„æº¢å‡ºï¼Œå†…æ ¸åœ¨åˆ›å»ºæ“ä½œç³»ç»Ÿçº¿ç¨‹æ—¶é»˜è®¤ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªè¾ƒå¤§çš„æ ˆå†…å­˜ï¼ˆè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…æ ¸å¹¶ä¸ä¼šä¸€å¼€å§‹å°±åˆ†é…è¿™ä¹ˆå¤šçš„ç‰©ç†å†…å­˜ï¼‰ï¼Œç„¶è€Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç³»ç»Ÿçº¿ç¨‹è¿œè¿œç”¨ä¸äº†è¿™ä¹ˆå¤šå†…å­˜ï¼Œè¿™å¯¼è‡´äº†æµªè´¹ï¼›å¦ä¸€æ–¹é¢ï¼Œæ ˆå†…å­˜ç©ºé—´ä¸€æ—¦åˆ›å»ºå’Œåˆå§‹åŒ–å®Œæˆä¹‹åå…¶å¤§å°å°±ä¸èƒ½å†æœ‰å˜åŒ–ï¼Œè¿™å†³å®šäº†åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹ç³»ç»Ÿçº¿ç¨‹æ ˆè¿˜æ˜¯æœ‰æº¢å‡ºçš„é£é™©ã€‚

è€Œç›¸å¯¹çš„ï¼Œç”¨æˆ·æ€çš„goroutineåˆ™è½»é‡å¾—å¤šï¼š

- goroutineæ˜¯ç”¨æˆ·æ€çº¿ç¨‹ï¼Œå…¶åˆ›å»ºå’Œåˆ‡æ¢éƒ½åœ¨ç”¨æˆ·ä»£ç ä¸­å®Œæˆè€Œæ— éœ€è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ‰€ä»¥å…¶å¼€é”€è¦è¿œè¿œå°äºç³»ç»Ÿçº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢ï¼›
- goroutineå¯åŠ¨æ—¶é»˜è®¤æ ˆå¤§å°åªæœ‰2kï¼Œè¿™åœ¨å¤šæ•°æƒ…å†µä¸‹å·²ç»å¤Ÿç”¨äº†ï¼Œå³ä½¿ä¸å¤Ÿç”¨ï¼Œgoroutineçš„æ ˆä¹Ÿä¼šè‡ªåŠ¨æ‰©å¤§ï¼ŒåŒæ—¶ï¼Œå¦‚æœæ ˆå¤ªå¤§äº†è¿‡äºæµªè´¹å®ƒè¿˜èƒ½è‡ªåŠ¨æ”¶ç¼©ï¼Œè¿™æ ·æ—¢æ²¡æœ‰æ ˆæº¢å‡ºçš„é£é™©ï¼Œä¹Ÿä¸ä¼šé€ æˆæ ˆå†…å­˜ç©ºé—´çš„å¤§é‡æµªè´¹ã€‚

æ­£æ˜¯å› ä¸ºGoè¯­è¨€ä¸­å®ç°äº†å¦‚æ­¤è½»é‡çº§çš„çº¿ç¨‹ï¼Œæ‰ä½¿å¾—æˆ‘ä»¬åœ¨Goç¨‹åºä¸­ï¼Œå¯ä»¥è½»æ˜“çš„åˆ›å»ºæˆåƒä¸Šä¸‡ç”šè‡³ä¸Šç™¾ä¸‡çš„goroutineå‡ºæ¥å¹¶å‘çš„æ‰§è¡Œä»»åŠ¡è€Œä¸ç”¨å¤ªæ‹…å¿ƒæ€§èƒ½å’Œå†…å­˜ç­‰é—®é¢˜ã€‚

**æ³¨æ„ï¼š** ä¸ºäº†é¿å…æ··æ·†ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œåé¢å‡ºç°çš„æ‰€æœ‰çš„çº¿ç¨‹ä¸€è¯å‡æ˜¯æŒ‡æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œè€Œgoroutineæˆ‘ä»¬ä¸å†ç§°ä¹‹ä¸ºä»€ä¹ˆä»€ä¹ˆçº¿ç¨‹è€Œæ˜¯ç›´æ¥ä½¿ç”¨goroutineè¿™ä¸ªè¯ã€‚

## çº¿ç¨‹æ¨¡å‹ä¸è°ƒåº¦å™¨

ç¬¬ä¸€ç« è®¨è®ºæ“ä½œç³»ç»Ÿçº¿ç¨‹è°ƒåº¦çš„æ—¶å€™æˆ‘ä»¬æ›¾ç»æåˆ°è¿‡ï¼Œgoroutineå»ºç«‹åœ¨æ“ä½œç³»ç»Ÿçº¿ç¨‹åŸºç¡€ä¹‹ä¸Šï¼Œå®ƒä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹é—´å®ç°äº†ä¸€ä¸ªå¤šå¯¹å¤š(M:N)çš„ä¸¤çº§çº¿ç¨‹æ¨¡å‹ã€‚

è¿™é‡Œçš„ M:N æ˜¯æŒ‡Mä¸ªgoroutineè¿è¡Œåœ¨Nä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¹‹ä¸Šï¼Œå†…æ ¸è´Ÿè´£å¯¹è¿™Nä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œè€Œè¿™Nä¸ªç³»ç»Ÿçº¿ç¨‹åˆè´Ÿè´£å¯¹è¿™Mä¸ªgoroutineè¿›è¡Œè°ƒåº¦å’Œè¿è¡Œã€‚

æ‰€è°“çš„å¯¹goroutineçš„è°ƒåº¦ï¼Œæ˜¯æŒ‡ç¨‹åºä»£ç æŒ‰ç…§ä¸€å®šçš„ç®—æ³•åœ¨é€‚å½“çš„æ—¶å€™æŒ‘é€‰å‡ºåˆé€‚çš„goroutineå¹¶æ”¾åˆ°CPUä¸Šå»è¿è¡Œçš„è¿‡ç¨‹ï¼Œè¿™äº›è´Ÿè´£å¯¹goroutineè¿›è¡Œè°ƒåº¦çš„ç¨‹åºä»£ç æˆ‘ä»¬ç§°ä¹‹ä¸ºgoroutineè°ƒåº¦å™¨ã€‚ç”¨æåº¦ç®€åŒ–äº†çš„ä¼ªä»£ç æ¥æè¿°goroutineè°ƒåº¦å™¨çš„å·¥ä½œæµç¨‹å¤§æ¦‚æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š

```go
// ç¨‹åºå¯åŠ¨æ—¶çš„åˆå§‹åŒ–ä»£ç 
......
for i := 0; i < N; i++ { // åˆ›å»ºNä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹æ‰§è¡Œscheduleå‡½æ•°
    create_os_thread(schedule) // åˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹æ‰§è¡Œscheduleå‡½æ•°
}

//scheduleå‡½æ•°å®ç°è°ƒåº¦é€»è¾‘
func schedule() {
   for { //è°ƒåº¦å¾ªç¯
         // æ ¹æ®æŸç§ç®—æ³•ä»Mä¸ªgoroutineä¸­æ‰¾å‡ºä¸€ä¸ªéœ€è¦è¿è¡Œçš„goroutine
         g := find_a_runnable_goroutine_from_M_goroutines()
         run_g(g) // CPUè¿è¡Œè¯¥goroutineï¼Œç›´åˆ°éœ€è¦è°ƒåº¦å…¶å®ƒgoroutineæ‰è¿”å›
         save_status_of_g(g) // ä¿å­˜goroutineçš„çŠ¶æ€ï¼Œä¸»è¦æ˜¯å¯„å­˜å™¨çš„å€¼
    }
}
```

è¿™æ®µä¼ªä»£ç è¡¨è¾¾çš„æ„æ€æ˜¯ï¼Œç¨‹åºè¿è¡Œèµ·æ¥ä¹‹ååˆ›å»ºäº†Nä¸ªç”±å†…æ ¸è°ƒåº¦çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘ä»¬ç§°è¿™äº›ç³»ç»Ÿçº¿ç¨‹ä¸ºå·¥ä½œçº¿ç¨‹ï¼‰å»æ‰§è¡Œsheduleå‡½æ•°ï¼Œè€Œscheduleå‡½æ•°åœ¨ä¸€ä¸ªè°ƒåº¦å¾ªç¯ä¸­åå¤ä»Mä¸ªgoroutineä¸­æŒ‘é€‰å‡ºä¸€ä¸ªéœ€è¦è¿è¡Œçš„goroutineå¹¶è·³è½¬åˆ°è¯¥goroutineå»è¿è¡Œï¼Œç›´åˆ°éœ€è¦è°ƒåº¦å…¶å®ƒgoroutineæ—¶æ‰è¿”å›åˆ°scheduleå‡½æ•°ä¸­é€šè¿‡save_status_of_gä¿å­˜åˆšåˆšæ­£åœ¨è¿è¡Œçš„goroutineçš„çŠ¶æ€ç„¶åå†æ¬¡å»å¯»æ‰¾ä¸‹ä¸€ä¸ªgoroutineã€‚

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œè¿™æ®µä¼ªä»£ç å¯¹goroutineçš„è°ƒåº¦ä»£ç åšäº†é«˜åº¦çš„æŠ½è±¡ã€ä¿®æ”¹å’Œç®€åŒ–å¤„ç†ï¼Œæ”¾åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†å¸®åŠ©æˆ‘ä»¬ä»å®è§‚ä¸Šäº†è§£goroutineçš„ä¸¤çº§è°ƒåº¦æ¨¡å‹ï¼Œå…·ä½“çš„å®ç°åŸç†å’Œç»†èŠ‚å°†ä»æœ¬ç« å¼€å§‹è¿›è¡Œå…¨é¢ä»‹ç»ã€‚

## è°ƒåº¦å™¨æ•°æ®ç»“æ„æ¦‚è¿°

ç¬¬ä¸€ç« æˆ‘ä»¬è®¨è®ºæ“ä½œç³»ç»Ÿçº¿ç¨‹åŠå…¶è°ƒåº¦æ—¶è¿˜è¯´è¿‡ï¼Œå¯ä»¥æŠŠå†…æ ¸å¯¹ç³»ç»Ÿçº¿ç¨‹çš„è°ƒåº¦ç®€å•çš„å½’çº³ä¸ºï¼šåœ¨æ‰§è¡Œæ“ä½œç³»ç»Ÿä»£ç æ—¶ï¼Œå†…æ ¸è°ƒåº¦å™¨æŒ‰ç…§ä¸€å®šçš„ç®—æ³•æŒ‘é€‰å‡ºä¸€ä¸ªçº¿ç¨‹å¹¶æŠŠè¯¥çº¿ç¨‹ä¿å­˜åœ¨å†…å­˜ä¹‹ä¸­çš„å¯„å­˜å™¨çš„å€¼æ”¾å…¥CPUå¯¹åº”çš„å¯„å­˜å™¨ä»è€Œæ¢å¤è¯¥çº¿ç¨‹çš„è¿è¡Œã€‚

ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œç³»ç»Ÿçº¿ç¨‹å¯¹goroutineçš„è°ƒåº¦ä¸å†…æ ¸å¯¹ç³»ç»Ÿçº¿ç¨‹çš„è°ƒåº¦åŸç†æ˜¯ä¸€æ ·çš„ï¼Œå®è´¨éƒ½æ˜¯é€šè¿‡ä¿å­˜å’Œä¿®æ”¹CPUå¯„å­˜å™¨çš„å€¼æ¥è¾¾åˆ°åˆ‡æ¢çº¿ç¨‹/goroutineçš„ç›®çš„ã€‚

å› æ­¤ï¼Œä¸ºäº†å®ç°å¯¹goroutineçš„è°ƒåº¦ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªæ•°æ®ç»“æ„æ¥ä¿å­˜CPUå¯„å­˜å™¨çš„å€¼ä»¥åŠgoroutineçš„å…¶å®ƒä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œåœ¨Goè¯­è¨€è°ƒåº¦å™¨æºä»£ç ä¸­ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåå«gçš„ç»“æ„ä½“ï¼Œå®ƒä¿å­˜äº†goroutineçš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯¥ç»“æ„ä½“çš„æ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡éƒ½ä»£è¡¨äº†ä¸€ä¸ªgoroutineï¼Œè°ƒåº¦å™¨ä»£ç å¯ä»¥é€šè¿‡gå¯¹è±¡æ¥å¯¹goroutineè¿›è¡Œè°ƒåº¦ï¼Œå½“goroutineè¢«è°ƒç¦»CPUæ—¶ï¼Œè°ƒåº¦å™¨ä»£ç è´Ÿè´£æŠŠCPUå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨gå¯¹è±¡çš„æˆå‘˜å˜é‡ä¹‹ä¸­ï¼Œå½“goroutineè¢«è°ƒåº¦èµ·æ¥è¿è¡Œæ—¶ï¼Œè°ƒåº¦å™¨ä»£ç åˆè´Ÿè´£æŠŠgå¯¹è±¡çš„æˆå‘˜å˜é‡æ‰€ä¿å­˜çš„å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ°CPUçš„å¯„å­˜å™¨ã€‚

è¦å®ç°å¯¹goroutineçš„è°ƒåº¦ï¼Œä»…ä»…æœ‰gç»“æ„ä½“å¯¹è±¡æ˜¯ä¸å¤Ÿçš„ï¼Œè‡³å°‘è¿˜éœ€è¦ä¸€ä¸ªå­˜æ”¾æ‰€æœ‰ï¼ˆå¯è¿è¡Œï¼‰goroutineçš„å®¹å™¨ï¼Œä¾¿äºå·¥ä½œçº¿ç¨‹å¯»æ‰¾éœ€è¦è¢«è°ƒåº¦èµ·æ¥è¿è¡Œçš„goroutineï¼Œäºæ˜¯Goè°ƒåº¦å™¨åˆå¼•å…¥äº†schedtç»“æ„ä½“ï¼Œä¸€æ–¹é¢ç”¨æ¥ä¿å­˜è°ƒåº¦å™¨è‡ªèº«çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦ä¸€æ–¹é¢å®ƒè¿˜æ‹¥æœ‰ä¸€ä¸ªç”¨æ¥ä¿å­˜goroutineçš„è¿è¡Œé˜Ÿåˆ—ã€‚å› ä¸ºæ¯ä¸ªGoç¨‹åºåªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ªGoç¨‹åºä¸­schedtç»“æ„ä½“åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè¯¥å®ä¾‹å¯¹è±¡åœ¨æºä»£ç ä¸­è¢«å®šä¹‰æˆäº†ä¸€ä¸ªå…±äº«çš„å…¨å±€å˜é‡ï¼Œè¿™æ ·æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å®ƒä»¥åŠå®ƒæ‰€æ‹¥æœ‰çš„goroutineè¿è¡Œé˜Ÿåˆ—ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªè¿è¡Œé˜Ÿåˆ—ä¸ºå…¨å±€è¿è¡Œé˜Ÿåˆ—ã€‚

æ—¢ç„¶è¯´åˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼Œè¯»è€…å¯èƒ½çŒœæƒ³åˆ°åº”è¯¥è¿˜æœ‰ä¸€ä¸ªå±€éƒ¨è¿è¡Œé˜Ÿåˆ—ã€‚ç¡®å®å¦‚æ­¤ï¼Œå› ä¸ºå…¨å±€è¿è¡Œé˜Ÿåˆ—æ˜¯æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¯»å†™çš„ï¼Œå› æ­¤è®¿é—®å®ƒéœ€è¦åŠ é”ï¼Œç„¶è€Œåœ¨ä¸€ä¸ªç¹å¿™çš„ç³»ç»Ÿä¸­ï¼ŒåŠ é”ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚äºæ˜¯ï¼Œè°ƒåº¦å™¨åˆä¸ºæ¯ä¸ªå·¥ä½œçº¿ç¨‹å¼•å…¥äº†ä¸€ä¸ªç§æœ‰çš„å±€éƒ¨goroutineè¿è¡Œé˜Ÿåˆ—ï¼Œå·¥ä½œçº¿ç¨‹ä¼˜å…ˆä½¿ç”¨è‡ªå·±çš„å±€éƒ¨è¿è¡Œé˜Ÿåˆ—ï¼Œåªæœ‰å¿…è¦æ—¶æ‰ä¼šå»è®¿é—®å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼Œè¿™å¤§å¤§å‡å°‘äº†é”å†²çªï¼Œæé«˜äº†å·¥ä½œçº¿ç¨‹çš„å¹¶å‘æ€§ã€‚åœ¨Goè°ƒåº¦å™¨æºä»£ç ä¸­ï¼Œå±€éƒ¨è¿è¡Œé˜Ÿåˆ—è¢«åŒ…å«åœ¨pç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ä¹‹ä¸­ï¼Œæ¯ä¸€ä¸ªè¿è¡Œç€goä»£ç çš„å·¥ä½œçº¿ç¨‹éƒ½ä¼šä¸ä¸€ä¸ªpç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡å…³è”åœ¨ä¸€èµ·ã€‚

é™¤äº†ä¸Šé¢ä»‹ç»çš„gã€schedtå’Œpç»“æ„ä½“ï¼ŒGoè°ƒåº¦å™¨æºä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªç”¨æ¥ä»£è¡¨å·¥ä½œçº¿ç¨‹çš„mç»“æ„ä½“ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªmç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ä¸ä¹‹å¯¹åº”ï¼Œmç»“æ„ä½“å¯¹è±¡é™¤äº†è®°å½•ç€å·¥ä½œçº¿ç¨‹çš„è¯¸å¦‚æ ˆçš„èµ·æ­¢ä½ç½®ã€å½“å‰æ­£åœ¨æ‰§è¡Œçš„goroutineä»¥åŠæ˜¯å¦ç©ºé—²ç­‰ç­‰çŠ¶æ€ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜é€šè¿‡æŒ‡é’ˆç»´æŒç€ä¸pç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ä¹‹é—´çš„ç»‘å®šå…³ç³»ã€‚äºæ˜¯ï¼Œé€šè¿‡mæ—¢å¯ä»¥æ‰¾åˆ°ä¸ä¹‹å¯¹åº”çš„å·¥ä½œçº¿ç¨‹æ­£åœ¨è¿è¡Œçš„goroutineï¼Œåˆå¯ä»¥æ‰¾åˆ°å·¥ä½œçº¿ç¨‹çš„å±€éƒ¨è¿è¡Œé˜Ÿåˆ—ç­‰èµ„æºã€‚ä¸‹é¢æ˜¯gã€pã€må’Œschedtä¹‹é—´çš„å…³ç³»å›¾ï¼š

![](../images/640.webp)

ä¸Šå›¾ä¸­åœ†å½¢å›¾æ¡ˆä»£è¡¨gç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ï¼Œä¸‰è§’å½¢ä»£è¡¨mç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ï¼Œæ­£æ–¹å½¢ä»£è¡¨pç»“æ„ä½“çš„å®ä¾‹å¯¹è±¡ï¼Œå…¶ä¸­çº¢è‰²çš„gè¡¨ç¤ºmå¯¹åº”çš„å·¥ä½œçº¿ç¨‹æ­£åœ¨è¿è¡Œçš„goroutineï¼Œè€Œç°è‰²çš„gè¡¨ç¤ºå¤„äºè¿è¡Œé˜Ÿåˆ—ä¹‹ä¸­æ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦èµ·æ¥è¿è¡Œçš„goroutineã€‚

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªméƒ½ç»‘å®šäº†ä¸€ä¸ªpï¼Œæ¯ä¸ªpéƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°goroutineé˜Ÿåˆ—ï¼Œmå¯¹åº”çš„çº¿ç¨‹ä»æœ¬åœ°å’Œå…¨å±€goroutineé˜Ÿåˆ—ä¸­è·å–goroutineå¹¶è¿è¡Œä¹‹ã€‚

å‰é¢æˆ‘ä»¬è¯´æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªmç»“æ„ä½“å¯¹è±¡ä¸ä¹‹å¯¹åº”ï¼Œä½†å¹¶æœªè¯¦ç»†è¯´æ˜å®ƒä»¬ä¹‹é—´æ˜¯å¦‚ä½•å¯¹åº”èµ·æ¥çš„ï¼Œå·¥ä½œçº¿ç¨‹æ‰§è¡Œçš„ä»£ç æ˜¯å¦‚ä½•æ‰¾åˆ°å±äºè‡ªå·±çš„é‚£ä¸ªmç»“æ„ä½“å®ä¾‹å¯¹è±¡çš„å‘¢ï¼Ÿ

å¦‚æœåªæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±åªä¼šæœ‰ä¸€ä¸ªmç»“æ„ä½“å¯¹è±¡ï¼Œé—®é¢˜å°±å¾ˆç®€å•ï¼Œå®šä¹‰ä¸€ä¸ªå…¨å±€çš„mç»“æ„ä½“å˜é‡å°±è¡Œäº†ã€‚å¯æ˜¯æˆ‘ä»¬æœ‰å¤šä¸ªå·¥ä½œçº¿ç¨‹å’Œå¤šä¸ªméœ€è¦ä¸€ä¸€å¯¹åº”ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿˜è®°å¾—ç¬¬ä¸€ç« æˆ‘ä»¬è®¨è®ºè¿‡çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨å—ï¼Ÿå½“æ—¶æˆ‘ä»¬è¯´è¿‡ï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨å…¶å®å°±æ˜¯çº¿ç¨‹ç§æœ‰çš„å…¨å±€å˜é‡ï¼Œè¿™ä¸æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„å—ï¼Ÿï¼åªè¦æ¯ä¸ªå·¥ä½œçº¿ç¨‹æ‹¥æœ‰äº†å„è‡ªç§æœ‰çš„mç»“æ„ä½“å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨ä¸åŒçš„å·¥ä½œçº¿ç¨‹ä¸­ä½¿ç”¨ç›¸åŒçš„å…¨å±€å˜é‡åæ¥è®¿é—®ä¸åŒçš„mç»“æ„ä½“å¯¹è±¡ï¼Œè¿™å®Œç¾çš„è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚

å…·ä½“åˆ°goroutineè°ƒåº¦å™¨ä»£ç ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨åˆšåˆšè¢«åˆ›å»ºå‡ºæ¥è¿›å…¥è°ƒåº¦å¾ªç¯ä¹‹å‰å°±åˆ©ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æœºåˆ¶ä¸ºè¯¥å·¥ä½œçº¿ç¨‹å®ç°äº†ä¸€ä¸ªæŒ‡å‘mç»“æ„ä½“å®ä¾‹å¯¹è±¡çš„ç§æœ‰å…¨å±€å˜é‡ï¼Œè¿™æ ·åœ¨ä¹‹åçš„ä»£ç ä¸­å°±ä½¿ç”¨è¯¥å…¨å±€å˜é‡æ¥è®¿é—®è‡ªå·±çš„mç»“æ„ä½“å¯¹è±¡ä»¥åŠä¸mç›¸å…³è”çš„på’Œgå¯¹è±¡ã€‚

æœ‰äº†ä¸Šè¿°æ•°æ®ç»“æ„ä»¥åŠå·¥ä½œçº¿ç¨‹ä¸æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå‰é¢çš„è°ƒåº¦ä¼ªä»£ç å†™å¾—æ›´ä¸°æ»¡ä¸€ç‚¹ï¼š

```go
// ç¨‹åºå¯åŠ¨æ—¶çš„åˆå§‹åŒ–ä»£ç 
......
for i := 0; i < N; i++ { // åˆ›å»ºNä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹æ‰§è¡Œscheduleå‡½æ•°
     create_os_thread(schedule) // åˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹æ‰§è¡Œscheduleå‡½æ•°
}


// å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ç§æœ‰å…¨å±€å˜é‡ï¼Œæ³¨æ„å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘mç»“æ„ä½“å¯¹è±¡çš„æŒ‡é’ˆ
// ThreadLocalç”¨æ¥å®šä¹‰çº¿ç¨‹ç§æœ‰å…¨å±€å˜é‡
ThreadLocal self *m
//scheduleå‡½æ•°å®ç°è°ƒåº¦é€»è¾‘
func schedule() {
    // åˆ›å»ºå’Œåˆå§‹åŒ–mç»“æ„ä½“å¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™ç§æœ‰å…¨å±€å˜é‡self
    self = initm()  
    for { //è°ƒåº¦å¾ªç¯
          if (self.p.runqueue is empty) {
                 // æ ¹æ®æŸç§ç®—æ³•ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æ‰¾å‡ºä¸€ä¸ªéœ€è¦è¿è¡Œçš„goroutine
                 g := find_a_runnable_goroutine_from_global_runqueue()
           } else {
                 // æ ¹æ®æŸç§ç®—æ³•ä»ç§æœ‰çš„å±€éƒ¨è¿è¡Œé˜Ÿåˆ—ä¸­æ‰¾å‡ºä¸€ä¸ªéœ€è¦è¿è¡Œçš„goroutine
                 g := find_a_runnable_goroutine_from_local_runqueue()
           }
          run_g(g) // CPUè¿è¡Œè¯¥goroutineï¼Œç›´åˆ°éœ€è¦è°ƒåº¦å…¶å®ƒgoroutineæ‰è¿”å›
          save_status_of_g(g) // ä¿å­˜goroutineçš„çŠ¶æ€ï¼Œä¸»è¦æ˜¯å¯„å­˜å™¨çš„å€¼
     }
}
```


ä»…ä»…ä»ä¸Šé¢è¿™ä¸ªä¼ªä»£ç æ¥çœ‹ï¼Œæˆ‘ä»¬å®Œå…¨ä¸éœ€è¦çº¿ç¨‹ç§æœ‰å…¨å±€å˜é‡ï¼Œåªéœ€åœ¨scheduleå‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡å°±è¡Œäº†ã€‚ä½†çœŸå®çš„è°ƒåº¦ä»£ç é”™ç»¼å¤æ‚ï¼Œä¸å…‰æ˜¯è¿™ä¸ªscheduleå‡½æ•°ä¼šéœ€è¦è®¿é—®mï¼Œå…¶å®ƒå¾ˆå¤šåœ°æ–¹è¿˜éœ€è¦è®¿é—®å®ƒï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å…¨å±€å˜é‡æ¥æ–¹ä¾¿å…¶å®ƒåœ°æ–¹å¯¹mçš„ä»¥åŠä¸mç›¸å…³çš„gå’Œpçš„è®¿é—®ã€‚

åœ¨ç®€å•çš„ä»‹ç»äº†Goè¯­è¨€è°ƒåº¦å™¨ä»¥åŠå®ƒæ‰€éœ€è¦çš„æ•°æ®ç»“æ„ä¹‹åï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Goçš„è°ƒåº¦ä»£ç ä¸­å¯¹ä¸Šè¿°çš„å‡ ä¸ªç»“æ„ä½“çš„å®šä¹‰ã€‚

## é‡è¦çš„ç»“æ„ä½“

ä¸‹é¢ä»‹ç»çš„è¿™äº›ç»“æ„ä½“ä¸­çš„å­—æ®µéå¸¸å¤šï¼Œç‰µæ¶‰åˆ°çš„ç»†èŠ‚ä¹Ÿå¾ˆåºæ‚ï¼Œå…‰æ˜¯çœ‹è¿™äº›ç»“æ„ä½“çš„å®šä¹‰æˆ‘ä»¬æ²¡æœ‰å¿…è¦ä¹Ÿæ— æ³•çœŸæ­£ç†è§£å®ƒä»¬çš„ç”¨é€”ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å¤§æ¦‚äº†è§£ä¸€ä¸‹å°±è¡Œäº†ï¼Œçœ‹ä¸æ‡‚è®°ä¸ä½éƒ½æ²¡æœ‰å…³ç³»ï¼Œéšç€åé¢å¯¹ä»£ç é€æ­¥æ·±å…¥çš„åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿå¿…å°†ä¼šå¯¹è¿™äº›ç»“æ„ä½“æœ‰è¶Šæ¥è¶Šæ¸…æ™°çš„è®¤è¯†ã€‚ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œä¸‹é¢å„ç»“æ„ä½“çš„å®šä¹‰ç•¥å»äº†è·Ÿè°ƒåº¦å™¨æ— å…³çš„æˆå‘˜ã€‚å¦å¤–ï¼Œè¿™äº›ç»“æ„ä½“çš„å®šä¹‰å…¨éƒ¨ä½äºGoè¯­è¨€çš„æºä»£ç è·¯å¾„ä¸‹çš„[runtime/runtime2.go](https://github.com/golang/go/blob/master/src/runtime/runtime2.go)æ–‡ä»¶ä¹‹ä¸­ã€‚

### stackç»“æ„ä½“

stackç»“æ„ä½“ä¸»è¦ç”¨æ¥è®°å½•goroutineæ‰€ä½¿ç”¨çš„æ ˆçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ˆé¡¶å’Œæ ˆåº•ä½ç½®ï¼š

```go
// Stack describes a Go execution stack.
// The bounds of the stack are exactly [lo, hi),
// with no implicit data structures on either side.
//ç”¨äºè®°å½•goroutineä½¿ç”¨çš„æ ˆçš„èµ·å§‹å’Œç»“æŸä½ç½®
type stack struct {  
    lo uintptr    // æ ˆé¡¶ï¼ŒæŒ‡å‘å†…å­˜ä½åœ°å€
    hi uintptr    // æ ˆåº•ï¼ŒæŒ‡å‘å†…å­˜é«˜åœ°å€
}
```

### gobufç»“æ„ä½“

gobufç»“æ„ä½“ç”¨äºä¿å­˜goroutineçš„è°ƒåº¦ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬CPUçš„å‡ ä¸ªå¯„å­˜å™¨çš„å€¼ï¼š

```go
type gobuf struct {
    // The offsets of sp, pc, and g are known to (hard-coded in) libmach.
    //
    // ctxt is unusual with respect to GC: it may be a
    // heap-allocated funcval, so GC needs to track it, but it
    // needs to be set and cleared from assembly, where it's
    // difficult to have write barriers. However, ctxt is really a
    // saved, live register, and we only ever exchange it between
    // the real register and the gobuf. Hence, we treat it as a
    // root during stack scanning, which means assembly that saves
    // and restores it doesn't need write barriers. It's still
    // typed as a pointer so that any other writes from Go get
    // write barriers.
    sp   uintptr  // ä¿å­˜CPUçš„rspå¯„å­˜å™¨çš„å€¼
    pc   uintptr  // ä¿å­˜CPUçš„ripå¯„å­˜å™¨çš„å€¼
    g    guintptr // è®°å½•å½“å‰è¿™ä¸ªgobufå¯¹è±¡å±äºå“ªä¸ªgoroutine
    ctxt unsafe.Pointer
 
    // ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œå› ä¸ºä»ç³»ç»Ÿè°ƒç”¨è¿”å›ä¹‹åå¦‚æœpè¢«å…¶å®ƒå·¥ä½œçº¿ç¨‹æŠ¢å ï¼Œ
    // åˆ™è¿™ä¸ªgoroutineä¼šè¢«æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—è¢«å…¶å®ƒå·¥ä½œçº¿ç¨‹è°ƒåº¦ï¼Œå…¶å®ƒçº¿ç¨‹éœ€è¦çŸ¥é“ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ã€‚
    ret  sys.Uintreg  
    lr   uintptr
 
    // ä¿å­˜CPUçš„ripå¯„å­˜å™¨çš„å€¼
    bp   uintptr // for GOEXPERIMENT=framepointer
}
```

### gç»“æ„ä½“
    
gç»“æ„ä½“ç”¨äºä»£è¡¨ä¸€ä¸ªgoroutineï¼Œè¯¥ç»“æ„ä½“ä¿å­˜äº†goroutineçš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ˆï¼Œgobufç»“æ„ä½“å’Œå…¶å®ƒçš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼š

```go
// å‰æ–‡æ‰€è¯´çš„gç»“æ„ä½“ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªgoroutine
type g struct {
    // Stack parameters.
    // stack describes the actual stack memory: [stack.lo, stack.hi).
    // stackguard0 is the stack pointer compared in the Go stack growth prologue.
    // It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.
    // stackguard1 is the stack pointer compared in the C stack growth prologue.
    // It is stack.lo+StackGuard on g0 and gsignal stacks.
    // It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).
 
    // è®°å½•è¯¥goroutineä½¿ç”¨çš„æ ˆ
    stack       stack   // offset known to runtime/cgo
    // ä¸‹é¢ä¸¤ä¸ªæˆå‘˜ç”¨äºæ ˆæº¢å‡ºæ£€æŸ¥ï¼Œå®ç°æ ˆçš„è‡ªåŠ¨ä¼¸ç¼©ï¼ŒæŠ¢å è°ƒåº¦ä¹Ÿä¼šç”¨åˆ°stackguard0
    stackguard0 uintptr // offset known to liblink
    stackguard1 uintptr // offset known to liblink

    ......
 
    // æ­¤goroutineæ­£åœ¨è¢«å“ªä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œ
    m              *m      // current m; offset known to arm liblink
    // ä¿å­˜è°ƒåº¦ä¿¡æ¯ï¼Œä¸»è¦æ˜¯å‡ ä¸ªå¯„å­˜å™¨çš„å€¼
    sched          gobuf
 
    ......
    // schedlinkå­—æ®µæŒ‡å‘å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªgï¼Œ
    //æ‰€æœ‰ä½äºå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„gå½¢æˆä¸€ä¸ªé“¾è¡¨
    schedlink      guintptr

    ......
    // æŠ¢å è°ƒåº¦æ ‡å¿—ï¼Œå¦‚æœéœ€è¦æŠ¢å è°ƒåº¦ï¼Œè®¾ç½®preemptä¸ºtrue
    preempt        bool       // preemption signal, duplicates stackguard0 = stackpreempt

   ......
}
```

### mç»“æ„ä½“

mç»“æ„ä½“ç”¨æ¥ä»£è¡¨å·¥ä½œçº¿ç¨‹ï¼Œå®ƒä¿å­˜äº†mè‡ªèº«ä½¿ç”¨çš„æ ˆä¿¡æ¯ï¼Œå½“å‰æ­£åœ¨è¿è¡Œçš„goroutineä»¥åŠä¸mç»‘å®šçš„pç­‰ä¿¡æ¯ï¼Œè¯¦è§ä¸‹é¢å®šä¹‰ä¸­çš„æ³¨é‡Šï¼š

```go
type m struct {
    // g0ä¸»è¦ç”¨æ¥è®°å½•å·¥ä½œçº¿ç¨‹ä½¿ç”¨çš„æ ˆä¿¡æ¯ï¼Œåœ¨æ‰§è¡Œè°ƒåº¦ä»£ç æ—¶éœ€è¦ä½¿ç”¨è¿™ä¸ªæ ˆ
    // æ‰§è¡Œç”¨æˆ·goroutineä»£ç æ—¶ï¼Œä½¿ç”¨ç”¨æˆ·goroutineè‡ªå·±çš„æ ˆï¼Œè°ƒåº¦æ—¶ä¼šå‘ç”Ÿæ ˆçš„åˆ‡æ¢
    g0      *g     // goroutine with scheduling stack

    // é€šè¿‡TLSå®ç°mç»“æ„ä½“å¯¹è±¡ä¸å·¥ä½œçº¿ç¨‹ä¹‹é—´çš„ç»‘å®š
    tls           [6]uintptr   // thread-local storage (for x86 extern register)
    mstartfn      func()
    // æŒ‡å‘å·¥ä½œçº¿ç¨‹æ­£åœ¨è¿è¡Œçš„goroutineçš„gç»“æ„ä½“å¯¹è±¡
    curg          *g       // current running goroutine
 
    // è®°å½•ä¸å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„pç»“æ„ä½“å¯¹è±¡
    p             puintptr // attached p for executing go code (nil if not executing go code)
    nextp         puintptr
    oldp          puintptr // the p that was attached before executing a syscall
   
    // spinningçŠ¶æ€ï¼šè¡¨ç¤ºå½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨è¯•å›¾ä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·å–goroutine
    spinning      bool // m is out of work and is actively looking for work
    blocked       bool // m is blocked on a note
   
    // æ²¡æœ‰goroutineéœ€è¦è¿è¡Œæ—¶ï¼Œå·¥ä½œçº¿ç¨‹ç¡çœ åœ¨è¿™ä¸ªparkæˆå‘˜ä¸Šï¼Œ
    // å…¶å®ƒçº¿ç¨‹é€šè¿‡è¿™ä¸ªparkå”¤é†’è¯¥å·¥ä½œçº¿ç¨‹
    park          note
    // è®°å½•æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„ä¸€ä¸ªé“¾è¡¨
    alllink       *m // on allm
    schedlink     muintptr

    // Linuxå¹³å°threadçš„å€¼å°±æ˜¯æ“ä½œç³»ç»Ÿçº¿ç¨‹ID
    thread        uintptr // thread handle
    freelink      *m      // on sched.freem

    ......
}
```

### pç»“æ„ä½“

pç»“æ„ä½“ç”¨äºä¿å­˜å·¥ä½œçº¿ç¨‹æ‰§è¡Œgoä»£ç æ—¶æ‰€å¿…éœ€çš„èµ„æºï¼Œæ¯”å¦‚goroutineçš„è¿è¡Œé˜Ÿåˆ—ï¼Œå†…å­˜åˆ†é…ç”¨åˆ°çš„ç¼“å­˜ç­‰ç­‰ã€‚

```go
type p struct {
    lock mutex

    status       uint32 // one of pidle/prunning/...
    link            puintptr
    schedtick   uint32     // incremented on every scheduler call
    syscalltick  uint32     // incremented on every system call
    sysmontick  sysmontick // last tick observed by sysmon
    m                muintptr   // back-link to associated m (nil if idle)

    ......

    // Queue of runnable goroutines. Accessed without lock.
    //æœ¬åœ°goroutineè¿è¡Œé˜Ÿåˆ—
    runqhead uint32  // é˜Ÿåˆ—å¤´
    runqtail uint32     // é˜Ÿåˆ—å°¾
    runq     [256]guintptr  //ä½¿ç”¨æ•°ç»„å®ç°çš„å¾ªç¯é˜Ÿåˆ—
    // runnext, if non-nil, is a runnable G that was ready'd by
    // the current G and should be run next instead of what's in
    // runq if there's time remaining in the running G's time
    // slice. It will inherit the time left in the current time
    // slice. If a set of goroutines is locked in a
    // communicate-and-wait pattern, this schedules that set as a
    // unit and eliminates the (potentially large) scheduling
    // latency that otherwise arises from adding the ready'd
    // goroutines to the end of the run queue.
    runnext guintptr

    // Available G's (status == Gdead)
    gFree struct {
        gList
        n int32
    }

    ......
}
```

### schedtç»“æ„ä½“

schedtç»“æ„ä½“ç”¨æ¥ä¿å­˜è°ƒåº¦å™¨çš„çŠ¶æ€ä¿¡æ¯å’Œgoroutineçš„å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼š

```go
type schedt struct {
    // accessed atomically. keep at top to ensure alignment on 32-bit systems.
    goidgen  uint64
    lastpoll uint64

    lock mutex

    // When increasing nmidle, nmidlelocked, nmsys, or nmfreed, be
    // sure to call checkdead().

    // ç”±ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ç»„æˆé“¾è¡¨
    midle        muintptr // idle m's waiting for work
    // ç©ºé—²çš„å·¥ä½œçº¿ç¨‹çš„æ•°é‡
    nmidle       int32    // number of idle m's waiting for work
    nmidlelocked int32    // number of locked m's waiting for work
    mnext        int64    // number of m's that have been created and next M ID
    // æœ€å¤šåªèƒ½åˆ›å»ºmaxmcountä¸ªå·¥ä½œçº¿ç¨‹
    maxmcount    int32    // maximum number of m's allowed (or die)
    nmsys        int32    // number of system m's not counted for deadlock
    nmfreed      int64    // cumulative number of freed m's

    ngsys uint32 // number of system goroutines; updated atomically

    // ç”±ç©ºé—²çš„pç»“æ„ä½“å¯¹è±¡ç»„æˆçš„é“¾è¡¨
    pidle      puintptr // idle p's
    // ç©ºé—²çš„pç»“æ„ä½“å¯¹è±¡çš„æ•°é‡
    npidle     uint32
    nmspinning uint32 // See "Worker thread parking/unparking" comment in proc.go.

    // Global runnable queue.
    // goroutineå…¨å±€è¿è¡Œé˜Ÿåˆ—
    runq     gQueue
    runqsize int32

    ......

    // Global cache of dead G's.
    // gFreeæ˜¯æ‰€æœ‰å·²ç»é€€å‡ºçš„goroutineå¯¹åº”çš„gç»“æ„ä½“å¯¹è±¡ç»„æˆçš„é“¾è¡¨
    // ç”¨äºç¼“å­˜gç»“æ„ä½“å¯¹è±¡ï¼Œé¿å…æ¯æ¬¡åˆ›å»ºgoroutineæ—¶éƒ½é‡æ–°åˆ†é…å†…å­˜
    gFree struct {
        lock          mutex
        stack        gList // Gs with stacks
        noStack   gList // Gs without stacks
        n              int32
    }
 
    ......
}
```

## é‡è¦çš„å…¨å±€å˜é‡

```go
allgs     []*g     // ä¿å­˜æ‰€æœ‰çš„g
allm       *m    // æ‰€æœ‰çš„mæ„æˆçš„ä¸€ä¸ªé“¾è¡¨ï¼ŒåŒ…æ‹¬ä¸‹é¢çš„m0
allp       []*p    // ä¿å­˜æ‰€æœ‰çš„pï¼Œlen(allp) == gomaxprocs

ncpu             int32   // ç³»ç»Ÿä¸­cpuæ ¸çš„æ•°é‡ï¼Œç¨‹åºå¯åŠ¨æ—¶ç”±runtimeä»£ç åˆå§‹åŒ–
gomaxprocs int32   // pçš„æœ€å¤§å€¼ï¼Œé»˜è®¤ç­‰äºncpuï¼Œä½†å¯ä»¥é€šè¿‡GOMAXPROCSä¿®æ”¹

sched      schedt     // è°ƒåº¦å™¨ç»“æ„ä½“å¯¹è±¡ï¼Œè®°å½•äº†è°ƒåº¦å™¨çš„å·¥ä½œçŠ¶æ€

m0  m       // ä»£è¡¨è¿›ç¨‹çš„ä¸»çº¿ç¨‹
g0   g        // m0çš„g0ï¼Œä¹Ÿå°±æ˜¯m0.g0 = &g0
```

åœ¨ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œè¿™äº›å…¨å˜é‡éƒ½ä¼šè¢«åˆå§‹åŒ–ä¸º0å€¼ï¼ŒæŒ‡é’ˆä¼šè¢«åˆå§‹åŒ–ä¸ºnilæŒ‡é’ˆï¼Œåˆ‡ç‰‡åˆå§‹åŒ–ä¸ºnilåˆ‡ç‰‡ï¼Œintè¢«åˆå§‹åŒ–ä¸ºæ•°å­—0ï¼Œç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜å˜é‡æŒ‰å…¶æœ¬ç±»å‹åˆå§‹åŒ–ä¸ºå…¶ç±»å‹çš„0å€¼ã€‚æ‰€ä»¥ç¨‹åºåˆšå¯åŠ¨æ—¶allgsï¼Œallmå’Œallpéƒ½ä¸åŒ…å«ä»»ä½•g,må’Œpã€‚

> åŸæ–‡ï¼š <https://mp.weixin.qq.com/s?__biz=MzU1OTg5NDkzOA==&mid=2247483761&idx=1&sn=15949fbeb48985c6c3781583df6956e6&scene=19#wechat_redirect>











## å¸¸è§è¯­æ³•é¢˜ç›® äºŒ


### 1ã€å†™å‡ºä¸‹é¢ä»£ç è¾“å‡ºå†…å®¹ã€‚

```go
package main

import (
	"fmt"
)

func main() {
	defer_call()
}

func defer_call() {
	defer func() { fmt.Println("æ‰“å°å‰") }()
	defer func() { fmt.Println("æ‰“å°ä¸­") }()
	defer func() { fmt.Println("æ‰“å°å") }()

	panic("è§¦å‘å¼‚å¸¸")
}
```

**è§£æï¼š**

`defer` å…³é”®å­—çš„å®ç°è·Ÿgoå…³é”®å­—å¾ˆç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒè°ƒç”¨çš„æ˜¯`runtime.deferproc`è€Œä¸æ˜¯`runtime.newproc`ã€‚

åœ¨`defer`å‡ºç°çš„åœ°æ–¹ï¼Œæ’å…¥äº†æŒ‡ä»¤`call runtime.deferproc`ï¼Œç„¶ååœ¨å‡½æ•°è¿”å›ä¹‹å‰çš„åœ°æ–¹ï¼Œæ’å…¥æŒ‡ä»¤`call runtime.deferreturn`ã€‚

goroutineçš„æ§åˆ¶ç»“æ„ä¸­ï¼Œæœ‰ä¸€å¼ è¡¨è®°å½•`defer`ï¼Œè°ƒç”¨`runtime.deferproc`æ—¶ä¼šå°†éœ€è¦deferçš„è¡¨è¾¾å¼è®°å½•åœ¨è¡¨ä¸­ï¼Œè€Œåœ¨è°ƒç”¨`runtime.deferreturn`çš„æ—¶å€™ï¼Œåˆ™ä¼šä¾æ¬¡ä»deferè¡¨ä¸­å‡ºæ ˆå¹¶æ‰§è¡Œã€‚

å› æ­¤ï¼Œé¢˜ç›®æœ€åè¾“å‡ºé¡ºåºåº”è¯¥æ˜¯`defer` å®šä¹‰é¡ºåºçš„å€’åºã€‚`panic` é”™è¯¯å¹¶ä¸èƒ½ç»ˆæ­¢ `defer` çš„æ‰§è¡Œã€‚

### 2ã€ ä»¥ä¸‹ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè¯´æ˜åŸå› 

```go
type student struct {
	Name string
	Age  int
}

func pase_student() {
	m := make(map[string]*student)
	stus := []student{
		{Name: "zhou", Age: 24},
		{Name: "li", Age: 23},
		{Name: "wang", Age: 22},
	}
	for _, stu := range stus {
		m[stu.Name] = &stu
	}
}
```

**è§£æï¼š**

golang çš„ `for ... range` è¯­æ³•ä¸­ï¼Œ`stu` å˜é‡ä¼šè¢«å¤ç”¨ï¼Œæ¯æ¬¡å¾ªç¯ä¼šå°†é›†åˆä¸­çš„å€¼å¤åˆ¶ç»™è¿™ä¸ªå˜é‡ï¼Œå› æ­¤ï¼Œä¼šå¯¼è‡´æœ€å`m`ä¸­çš„`map`ä¸­å‚¨å­˜çš„éƒ½æ˜¯`stus`æœ€åä¸€ä¸ª`student`çš„å€¼ã€‚


### 3ã€ä¸‹é¢çš„ä»£ç ä¼šè¾“å‡ºä»€ä¹ˆï¼Œå¹¶è¯´æ˜åŸå› 

```go
func main() {
	runtime.GOMAXPROCS(1)
	wg := sync.WaitGroup{}
	wg.Add(20)
	for i := 0; i < 10; i++ {
		go func() {
			fmt.Println("i: ", i)
			wg.Done()
		}()
	}
	for i := 0; i < 10; i++ {
		go func(i int) {
			fmt.Println("i: ", i)
			wg.Done()
		}(i)
	}
	wg.Wait()
}

```

**è§£æï¼š**

è¿™ä¸ªè¾“å‡ºç»“æœå†³å®šæ¥è‡ªäºè°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦å“ªä¸ªGã€‚ä»runtimeçš„æºç å¯ä»¥çœ‹åˆ°ï¼Œå½“åˆ›å»ºä¸€ä¸ªGæ—¶ï¼Œä¼šä¼˜å…ˆæ”¾å…¥åˆ°ä¸‹ä¸€ä¸ªè°ƒåº¦çš„`runnext`å­—æ®µä¸Šä½œä¸ºä¸‹ä¸€æ¬¡ä¼˜å…ˆè°ƒåº¦çš„Gã€‚å› æ­¤ï¼Œæœ€å…ˆè¾“å‡ºçš„æ˜¯æœ€ååˆ›å»ºçš„Gï¼Œä¹Ÿå°±æ˜¯9.

```go
func newproc(siz int32, fn *funcval) {
	argp := add(unsafe.Pointer(&fn), sys.PtrSize)
	gp := getg()
	pc := getcallerpc()
	systemstack(func() {
		newg := newproc1(fn, argp, siz, gp, pc)

		_p_ := getg().m.p.ptr()
        //æ–°åˆ›å»ºçš„Gä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥å†³å®šå¦‚ä½•è°ƒåº¦
		runqput(_p_, newg, true)

		if mainStarted {
			wakep()
		}
	})
}
...

	if next {
	retryNext:
		oldnext := _p_.runnext
        //å½“nextæ˜¯trueæ—¶æ€»ä¼šå°†æ–°è¿›æ¥çš„Gæ”¾å…¥ä¸‹ä¸€æ¬¡è°ƒåº¦å­—æ®µä¸­
		if !_p_.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) {
			goto retryNext
		}
		if oldnext == 0 {
			return
		}
		// Kick the old runnext out to the regular run queue.
		gp = oldnext.ptr()
	}
```


### 4ã€ä¸‹é¢ä»£ç ä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ

```go
type People struct{}

func (p *People) ShowA() {
	fmt.Println("showA")
	p.ShowB()
}
func (p *People) ShowB() {
	fmt.Println("showB")
}

type Teacher struct {
	People
}

func (t *Teacher) ShowB() {
	fmt.Println("teacher showB")
}

func main() {
	t := Teacher{}
	t.ShowA()
}


```


**è§£æï¼š**

è¾“å‡ºç»“æœä¸º`showA`ã€`showB`ã€‚golang è¯­è¨€ä¸­æ²¡æœ‰ç»§æ‰¿æ¦‚å¿µï¼Œåªæœ‰ç»„åˆï¼Œä¹Ÿæ²¡æœ‰è™šæ–¹æ³•ï¼Œæ›´æ²¡æœ‰é‡è½½ã€‚å› æ­¤ï¼Œ`*Teacher` çš„ `ShowB` ä¸ä¼šè¦†å†™è¢«ç»„åˆçš„ `People` çš„æ–¹æ³•ã€‚


### 5ã€ä¸‹é¢ä»£ç ä¼šè§¦å‘å¼‚å¸¸å—ï¼Ÿè¯·è¯¦ç»†è¯´æ˜

```go
func main() {
	runtime.GOMAXPROCS(1)
	int_chan := make(chan int, 1)
	string_chan := make(chan string, 1)
	int_chan <- 1
	string_chan <- "hello"
	select {
	case value := <-int_chan:
		fmt.Println(value)
	case value := <-string_chan:
		panic(value)
	}
}
```

**è§£æï¼š**

ç»“æœæ˜¯éšæœºæ‰§è¡Œã€‚golang åœ¨å¤šä¸ª`case` å¯è¯»çš„æ—¶å€™ä¼šå…¬å¹³çš„é€‰ä¸­ä¸€ä¸ªæ‰§è¡Œã€‚

### 6ã€ä¸‹é¢ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ

```go
func calc(index string, a, b int) int {
	ret := a + b
	fmt.Println(index, a, b, ret)
	return ret
}

func main() {
	a := 1
	b := 2
	defer calc("1", a, calc("10", a, b))
	a = 0
	defer calc("2", a, calc("20", a, b))
	b = 1
}
```

**è§£æï¼š**

è¾“å‡ºç»“æœä¸ºï¼š

```
10 1 2 3
20 0 2 2
2 0 2 2
1 1 3 4
```

`defer` åœ¨å®šä¹‰çš„æ—¶å€™ä¼šè®¡ç®—å¥½è°ƒç”¨å‡½æ•°çš„å‚æ•°ï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆè¾“å‡º`10`ã€`20` ä¸¤ä¸ªå‚æ•°ã€‚ç„¶åæ ¹æ®å®šä¹‰çš„é¡ºåºå€’åºæ‰§è¡Œã€‚


### 7ã€è¯·å†™å‡ºä»¥ä¸‹è¾“å…¥å†…å®¹

```go
func main() {
	s := make([]int, 5)
	s = append(s, 1, 2, 3)
	fmt.Println(s)
}

```

**è§£æï¼š**

è¾“å‡ºä¸º `0 0 0 0 0 1 2 3`ã€‚

`make` åœ¨åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æŒ‡å®šäº†é•¿åº¦ï¼Œæ‰€ä»¥è¿½åŠ æ•°æ®æ—¶ä¼šä»`len(s)` ä½ç½®å¼€å§‹å¡«å……æ•°æ®ã€‚


### 8ã€ä¸‹é¢çš„ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜?

```go
type UserAges struct {
	ages map[string]int
	sync.Mutex
}

func (ua *UserAges) Add(name string, age int) {
	ua.Lock()
	defer ua.Unlock()
	ua.ages[name] = age
}

func (ua *UserAges) Get(name string) int {
	if age, ok := ua.ages[name]; ok {
		return age
	}
	return -1
}
```

**è§£æï¼š**

 åœ¨æ‰§è¡Œ Getæ–¹æ³•æ—¶å¯èƒ½è¢«panicã€‚
 
 è™½ç„¶æœ‰ä½¿ç”¨sync.Mutexåšå†™é”ï¼Œä½†æ˜¯mapæ˜¯å¹¶å‘è¯»å†™ä¸å®‰å…¨çš„ã€‚mapå±äºå¼•ç”¨ç±»å‹ï¼Œå¹¶å‘è¯»å†™æ—¶å¤šä¸ªåç¨‹è§æ˜¯é€šè¿‡æŒ‡é’ˆè®¿é—®åŒä¸€ä¸ªåœ°å€ï¼Œå³è®¿é—®å…±äº«å˜é‡ï¼Œæ­¤æ—¶åŒæ—¶è¯»å†™èµ„æºå­˜åœ¨ç«äº‰å…³ç³»ã€‚ä¼šæŠ¥é”™è¯¯ä¿¡æ¯:â€œfatal error: concurrent map read and map writeâ€ã€‚
 
å› æ­¤ï¼Œåœ¨ `Get` ä¸­ä¹Ÿéœ€è¦åŠ é”ï¼Œå› ä¸ºè¿™é‡Œåªæ˜¯è¯»ï¼Œå»ºè®®ä½¿ç”¨è¯»å†™é” `sync.RWMutex`ã€‚


### 9ã€ä¸‹é¢çš„è¿­ä»£ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```go
func (set *threadSafeSet) Iter() <-chan interface{} {
	ch := make(chan interface{})
	go func() {
		set.RLock()

		for elem := range set.s {
			ch <- elem
		}

		close(ch)
		set.RUnlock()

	}()
	return ch
}
```

**è§£æï¼š**

é»˜è®¤æƒ…å†µä¸‹ `make` åˆå§‹åŒ–çš„ `channel` æ˜¯æ— ç¼“å†²çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿­ä»£å†™æ—¶ä¼šé˜»å¡ã€‚

### 10ã€ä»¥ä¸‹ä»£ç èƒ½ç¼–è¯‘è¿‡å»å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

```go
package main

import (
	"fmt"
)

type People interface {
	Speak(string) string
}

type Student struct{}

func (stu *Student) Speak(think string) (talk string) {
	if think == "bitch" {
		talk = "You are a good boy"
	} else {
		talk = "hi"
	}
	return
}

func main() {
	var peo People = Student{}
	think := "bitch"
	fmt.Println(peo.Speak(think))
}
```

**è§£æï¼š**


ç¼–è¯‘å¤±è´¥ï¼Œå€¼ç±»å‹ `Student{}` æœªå®ç°æ¥å£`People`çš„æ–¹æ³•ï¼Œä¸èƒ½å®šä¹‰ä¸º `People`ç±»å‹ã€‚

åœ¨ golang è¯­è¨€ä¸­ï¼Œ`Student` å’Œ `*Student` æ˜¯ä¸¤ç§ç±»å‹ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¡¨ç¤º `Student` æœ¬èº«ï¼Œç¬¬äºŒä¸ªæ˜¯æŒ‡å‘ `Student` çš„æŒ‡é’ˆã€‚




### 11ã€ä»¥ä¸‹ä»£ç æ‰“å°å‡ºæ¥ä»€ä¹ˆå†…å®¹ï¼Œè¯´å‡ºä¸ºä»€ä¹ˆã€‚ã€‚ã€‚

```go
package main

import (
	"fmt"
)

type People interface {
	Show()
}

type Student struct{}

func (stu *Student) Show() {

}

func live() People {
	var stu *Student
	return stu
}

func main() {
	if live() == nil {
		fmt.Println("AAAAAAA")
	} else {
		fmt.Println("BBBBBBB")
	}
}
```

**è§£æï¼š**

è·Ÿä¸Šä¸€é¢˜ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯`*Student` çš„å®šä¹‰åæœ¬èº«æ²¡æœ‰åˆå§‹åŒ–å€¼ï¼Œæ‰€ä»¥ `*Student` æ˜¯ `nil`çš„ï¼Œä½†æ˜¯`*Student` å®ç°äº† `People` æ¥å£ï¼Œæ¥å£ä¸ä¸º `nil`ã€‚
# åœ¨ golang åç¨‹å’Œchannelé…åˆä½¿ç”¨

> å†™ä»£ç å®ç°ä¸¤ä¸ª goroutineï¼Œå…¶ä¸­ä¸€ä¸ªäº§ç”Ÿéšæœºæ•°å¹¶å†™å…¥åˆ° go channel ä¸­ï¼Œå¦å¤–ä¸€ä¸ªä» channel ä¸­è¯»å–æ•°å­—å¹¶æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚æœ€ç»ˆè¾“å‡ºäº”ä¸ªéšæœºæ•°ã€‚

**è§£æ**

è¿™æ˜¯ä¸€é“å¾ˆç®€å•çš„golangåŸºç¡€é¢˜ç›®ï¼Œå®ç°æ–¹æ³•ä¹Ÿæœ‰å¾ˆå¤šç§ï¼Œä¸€èˆ¬æƒ³ç­”è®©é¢è¯•å®˜æ»¡æ„çš„ç­”æ¡ˆè¿˜æ˜¯æœ‰å‡ ç‚¹æ³¨æ„çš„åœ°æ–¹ã€‚

1. `goroutine` åœ¨golangä¸­å¼éé˜»å¡çš„
2. `channel` æ— ç¼“å†²æƒ…å†µä¸‹ï¼Œè¯»å†™éƒ½æ˜¯é˜»å¡çš„ï¼Œä¸”å¯ä»¥ç”¨`for`å¾ªç¯æ¥è¯»å–æ•°æ®ï¼Œå½“ç®¡é“å…³é—­åï¼Œ`for` é€€å‡ºã€‚
3.  golang ä¸­æœ‰ä¸“ç”¨çš„`select case` è¯­æ³•ä»ç®¡é“è¯»å–æ•°æ®ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
func main() {
    out := make(chan int)
    wg := sync.WaitGroup{}
    wg.Add(2)
    go func() {
        defer wg.Done()
        for i := 0; i < 5; i++ {
            out <- rand.Intn(5)
        }
        close(out)
    }()
    go func() {
        defer wg.Done()
        for i := range out {
            fmt.Println(i)
        }
    }()
    wg.Wait()
}
```# å®ç°é˜»å¡è¯»ä¸”å¹¶å‘å®‰å…¨çš„map

GOé‡Œé¢MAPå¦‚ä½•å®ç°keyä¸å­˜åœ¨ getæ“ä½œç­‰å¾… ç›´åˆ°keyå­˜åœ¨æˆ–è€…è¶…æ—¶ï¼Œä¿è¯å¹¶å‘å®‰å…¨ï¼Œä¸”éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š

```go
type sp interface {
    Out(key string, val interface{})  //å­˜å…¥key /valï¼Œå¦‚æœè¯¥keyè¯»å–çš„goroutineæŒ‚èµ·ï¼Œåˆ™å”¤é†’ã€‚æ­¤æ–¹æ³•ä¸ä¼šé˜»å¡ï¼Œæ—¶åˆ»éƒ½å¯ä»¥ç«‹å³æ‰§è¡Œå¹¶è¿”å›
    Rd(key string, timeout time.Duration) interface{}  //è¯»å–ä¸€ä¸ªkeyï¼Œå¦‚æœkeyä¸å­˜åœ¨é˜»å¡ï¼Œç­‰å¾…keyå­˜åœ¨æˆ–è€…è¶…æ—¶
}
```

**è§£æï¼š**

çœ‹åˆ°é˜»å¡åç¨‹ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å°±æ˜¯`channel`ï¼Œé¢˜ç›®ä¸­è¦æ±‚å¹¶å‘å®‰å…¨ï¼Œé‚£ä¹ˆå¿…é¡»ç”¨é”ï¼Œè¿˜è¦å®ç°å¤šä¸ª`goroutine`è¯»çš„æ—¶å€™å¦‚æœå€¼ä¸å­˜åœ¨åˆ™é˜»å¡ï¼Œç›´åˆ°å†™å…¥å€¼ï¼Œé‚£ä¹ˆæ¯ä¸ªé”®å€¼éœ€è¦æœ‰ä¸€ä¸ªé˜»å¡`goroutine` çš„ `channel`ã€‚

[å®ç°å¦‚ä¸‹ï¼š](../src/q010.go) 

```go
type Map struct {
	c   map[string]*entry
	rmx *sync.RWMutex
}
type entry struct {
	ch      chan struct{}
	value   interface{}
	isExist bool
}

func (m *Map) Out(key string, val interface{}) {
	m.rmx.Lock()
	defer m.rmx.Unlock()
	item, ok := m.c[key]
	if !ok {
		m.c[key] = &entry{
			value: val,
			isExist: true,
		}
		return
	}
	item.value = val
	if !item.isExist {
		if item.ch != nil {
			close(item.ch)
			item.ch = nil
		}
	}
	return
}
```
# é«˜å¹¶å‘ä¸‹çš„é”ä¸mapçš„è¯»å†™

åœºæ™¯ï¼šåœ¨ä¸€ä¸ªé«˜å¹¶å‘çš„webæœåŠ¡å™¨ä¸­ï¼Œè¦é™åˆ¶IPçš„é¢‘ç¹è®¿é—®ã€‚ç°æ¨¡æ‹Ÿ100ä¸ªIPåŒæ—¶å¹¶å‘è®¿é—®æœåŠ¡å™¨ï¼Œæ¯ä¸ªIPè¦é‡å¤è®¿é—®1000æ¬¡ã€‚

æ¯ä¸ªIPä¸‰åˆ†é’Ÿä¹‹å†…åªèƒ½è®¿é—®ä¸€æ¬¡ã€‚ä¿®æ”¹ä»¥ä¸‹ä»£ç å®Œæˆè¯¥è¿‡ç¨‹ï¼Œè¦æ±‚èƒ½æˆåŠŸè¾“å‡º success:100

```go
package main
 
import (
	"fmt"
	"time"
)
 
type Ban struct {
	visitIPs map[string]time.Time
}
 
func NewBan() *Ban {
	return &Ban{visitIPs: make(map[string]time.Time)}
}
func (o *Ban) visit(ip string) bool {
	if _, ok := o.visitIPs[ip]; ok {
		return true
	}
	o.visitIPs[ip] = time.Now()
	return false
}
func main() {
	success := 0
	ban := NewBan()
	for i := 0; i < 1000; i++ {
		for j := 0; j < 100; j++ {
			go func() {
				ip := fmt.Sprintf("192.168.1.%d", j)
				if !ban.visit(ip) {
					success++
				}
			}()
		}
 
	}
	fmt.Println("success:", success)
}
```

**è§£æ**

è¯¥é—®é¢˜ä¸»è¦è€ƒå¯Ÿäº†å¹¶å‘æƒ…å†µä¸‹mapçš„è¯»å†™é—®é¢˜ï¼Œè€Œç»™å‡ºçš„åˆå§‹ä»£ç ï¼Œåˆå­˜åœ¨`for`å¾ªç¯ä¸­å¯åŠ¨`goroutine`æ—¶å˜é‡ä½¿ç”¨é—®é¢˜ä»¥åŠ`goroutine`æ‰§è¡Œæ»åé—®é¢˜ã€‚

å› æ­¤ï¼Œé¦–å…ˆè¦ä¿è¯å¯åŠ¨çš„`goroutine`å¾—åˆ°çš„å‚æ•°æ˜¯æ­£ç¡®çš„ï¼Œç„¶åä¿è¯`map`çš„å¹¶å‘è¯»å†™ï¼Œæœ€åä¿è¯ä¸‰åˆ†é’Ÿåªèƒ½è®¿é—®ä¸€æ¬¡ã€‚

å¤šCPUæ ¸å¿ƒä¸‹ä¿®æ”¹`int`çš„å€¼æç«¯æƒ…å†µä¸‹ä¼šå­˜åœ¨ä¸åŒæ­¥æƒ…å†µï¼Œå› æ­¤éœ€è¦åŸå­æ€§çš„ä¿®æ”¹intå€¼ã€‚

ä¸‹é¢ç»™å‡ºçš„å®ä¾‹ä»£ç ï¼Œæ˜¯å¯åŠ¨äº†ä¸€ä¸ªåç¨‹æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€ä¸‹`map`ä¸­çš„è¿‡æœŸ`ip`ï¼Œ`for`å¯åŠ¨åç¨‹æ—¶ä¼ å‚ã€‚

```go
package main

import (
	"context"
	"fmt"
	"sync"
	"sync/atomic"
	"time"
)

type Ban struct {
	visitIPs map[string]time.Time
	lock      sync.Mutex
}

func NewBan(ctx context.Context) *Ban {
	o := &Ban{visitIPs: make(map[string]time.Time)}
	go func() {
		timer := time.NewTimer(time.Minute * 1)
		for {
			select {
			case <-timer.C:
				o.lock.Lock()
				for k, v := range o.visitIPs {
					if time.Now().Sub(v) >= time.Minute*1 {
						delete(o.visitIPs, k)
					}
				}
				o.lock.Unlock()
				timer.Reset(time.Minute * 1)
			case <-ctx.Done():
				return
			}
		}
	}()
	return o
}
func (o *Ban) visit(ip string) bool {
	o.lock.Lock()
	defer o.lock.Unlock()
	if _, ok := o.visitIPs[ip]; ok {
		return true
	}
	o.visitIPs[ip] = time.Now()
	return false
}
func main() {
	success := int64(0)
	ctx, cancel := context.WithCancel(context.Background())
	defer cancel()

	ban := NewBan(ctx)

	wait := &sync.WaitGroup{}

	wait.Add(1000 * 100)
	for i := 0; i < 1000; i++ {
		for j := 0; j < 100; j++ {
			go func(j int) {
				defer wait.Done()
				ip := fmt.Sprintf("192.168.1.%d", j)
				if !ban.visit(ip) {
					atomic.AddInt64(&success, 1)
				}
			}(j)
		}

	}
	wait.Wait()

	fmt.Println("success:", success)
}
```## 1. å†™å‡ºä»¥ä¸‹é€»è¾‘ï¼Œè¦æ±‚æ¯ç§’é’Ÿè°ƒç”¨ä¸€æ¬¡procå¹¶ä¿è¯ç¨‹åºä¸é€€å‡º?

```go
package main

func main() {
    go func() {
        // 1 åœ¨è¿™é‡Œéœ€è¦ä½ å†™ç®—æ³•
        // 2 è¦æ±‚æ¯ç§’é’Ÿè°ƒç”¨ä¸€æ¬¡procå‡½æ•°
        // 3 è¦æ±‚ç¨‹åºä¸èƒ½é€€å‡º
    }()

    select {}
}

func proc() {
    panic("ok")
}
```

**è§£æ**

é¢˜ç›®ä¸»è¦è€ƒå¯Ÿäº†ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š

1. å®šæ—¶æ‰§è¡Œæ‰§è¡Œä»»åŠ¡
2. æ•è· panic é”™è¯¯

é¢˜ç›®ä¸­è¦æ±‚æ¯ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯ `time.Ticker`å¯¹è±¡ï¼Œè¯¥å‡½æ•°å¯æ¯ç§’é’Ÿå¾€`chan`ä¸­æ”¾ä¸€ä¸ª`Time`,æ­£å¥½ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚

åœ¨ `golang` ä¸­æ•è· `panic` ä¸€èˆ¬ä¼šç”¨åˆ° `recover()` å‡½æ•°ã€‚  

```go
package main

import (
	"fmt"
	"time"
)

func main() {
	go func() {
		// 1 åœ¨è¿™é‡Œéœ€è¦ä½ å†™ç®—æ³•
		// 2 è¦æ±‚æ¯ç§’é’Ÿè°ƒç”¨ä¸€æ¬¡procå‡½æ•°
		// 3 è¦æ±‚ç¨‹åºä¸èƒ½é€€å‡º

		t := time.NewTicker(time.Second * 1)
		for {
			select {
			case <-t.C:
				go func() {
					defer func() {
						if err := recover(); err != nil {
							fmt.Println(err)
						}
					}()
					proc()
				}()
			}
		}
	}()

	select {}
}

func proc() {
	panic("ok")
}

```## ä¸º sync.WaitGroup ä¸­Waitå‡½æ•°æ”¯æŒ WaitTimeout åŠŸèƒ½.

```go
package main

import (
    "fmt"
    "sync"
    "time"
)

func main() {
    wg := sync.WaitGroup{}
    c := make(chan struct{})
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func(num int, close <-chan struct{}) {
            defer wg.Done()
            <-close
            fmt.Println(num)
        }(i, c)
    }

    if WaitTimeout(&wg, time.Second*5) {
        close(c)
        fmt.Println("timeout exit")
    }
    time.Sleep(time.Second * 10)
}

func WaitTimeout(wg *sync.WaitGroup, timeout time.Duration) bool {
    // è¦æ±‚æ‰‹å†™ä»£ç 
    // è¦æ±‚sync.WaitGroupæ”¯æŒtimeoutåŠŸèƒ½
    // å¦‚æœtimeoutåˆ°äº†è¶…æ—¶æ—¶é—´è¿”å›true
    // å¦‚æœWaitGroupè‡ªç„¶ç»“æŸè¿”å›false
}
```


**è§£æ**

é¦–å…ˆ `sync.WaitGroup` å¯¹è±¡çš„ `Wait` å‡½æ•°æœ¬èº«æ˜¯é˜»å¡çš„ï¼ŒåŒæ—¶ï¼Œè¶…æ—¶ç”¨åˆ°çš„`time.Timer` å¯¹è±¡ä¹Ÿéœ€è¦é˜»å¡çš„è¯»ã€‚

åŒæ—¶é˜»å¡çš„ä¸¤ä¸ªå¯¹è±¡è‚¯å®šè¦æ¯ä¸ªå¯åŠ¨ä¸€ä¸ªåç¨‹,æ¯ä¸ªåç¨‹å»å¤„ç†ä¸€ä¸ªé˜»å¡ï¼Œéš¾ç‚¹åœ¨äºæ€ä¹ˆçŸ¥é“å“ªä¸ªé˜»å¡å…ˆå®Œæˆã€‚

ç›®å‰æˆ‘ç”¨çš„æ–¹å¼æ˜¯å£°æ˜ä¸€ä¸ªæ²¡æœ‰ç¼“å†²çš„`chan`ï¼Œè°å…ˆå®Œæˆè°ä¼˜å…ˆå‘ç®¡é“ä¸­å†™å…¥æ•°æ®ã€‚

```go
package main

import (
	"fmt"
	"sync"
	"time"
)

func main() {
	wg := sync.WaitGroup{}
	c := make(chan struct{})
	for i := 0; i < 10; i++ {
		wg.Add(1)
		go func(num int, close <-chan struct{}) {
			defer wg.Done()
			<-close
			fmt.Println(num)
		}(i, c)
	}

	if WaitTimeout(&wg, time.Second*5) {
		close(c)
		fmt.Println("timeout exit")
	}
	time.Sleep(time.Second * 10)
}

func WaitTimeout(wg *sync.WaitGroup, timeout time.Duration) bool {
	// è¦æ±‚æ‰‹å†™ä»£ç 
	// è¦æ±‚sync.WaitGroupæ”¯æŒtimeoutåŠŸèƒ½
	// å¦‚æœtimeoutåˆ°äº†è¶…æ—¶æ—¶é—´è¿”å›true
	// å¦‚æœWaitGroupè‡ªç„¶ç»“æŸè¿”å›false
	ch := make(chan bool, 1)

	go time.AfterFunc(timeout, func() {
		ch <- true
	})

	go func() {
		wg.Wait()
		ch <- false
	}()
	
	return <- ch
}
```
# è¯­æ³•æ‰¾é”™é¢˜

## å†™å‡ºä»¥ä¸‹ä»£ç å‡ºç°çš„é—®é¢˜

```go
package main
import (
    "fmt"
)
func main() {
    var x string = nil
    if x == nil {
        x = "default"
    }
    fmt.Println(x)
}
```

golang ä¸­å­—ç¬¦ä¸²æ˜¯ä¸èƒ½èµ‹å€¼ `nil` çš„ï¼Œä¹Ÿä¸èƒ½è·Ÿ `nil` æ¯”è¾ƒã€‚

## å†™å‡ºä»¥ä¸‹æ‰“å°å†…å®¹
   
```go
   package main
   import "fmt"
   const (
       a = iota
       b = iota
   )
   const (
       name = "menglu"
       c    = iota
       d    = iota
   )
   func main() {
       fmt.Println(a)
       fmt.Println(b)
       fmt.Println(c)
       fmt.Println(d)
   }
```

## æ‰¾å‡ºä¸‹é¢ä»£ç çš„é—®é¢˜

```go
package main
import "fmt"
type query func(string) string

func exec(name string, vs ...query) string {
    ch := make(chan string)
    fn := func(i int) {
        ch <- vs[i](name)
    }
    for i, _ := range vs {
        go fn(i)
    }
    return <-ch
}

func main() {
    ret := exec("111", func(n string) string {
        return n + "func1"
    }, func(n string) string {
        return n + "func2"
    }, func(n string) string {
        return n + "func3"
    }, func(n string) string {
        return n + "func4"
    })
    fmt.Println(ret)
}
```

ä¸Šé¢çš„ä»£ç æœ‰ä¸¥é‡çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå‡ºé”™çš„ä½ç½®æ˜¯ `go fn(i)`ï¼Œå®é™…ä¸Šä»£ç æ‰§è¡Œåä¼šå¯åŠ¨ 4 ä¸ªåç¨‹ï¼Œä½†æ˜¯å› ä¸º `ch` æ˜¯éç¼“å†²çš„ï¼Œåªå¯èƒ½æœ‰ä¸€ä¸ªåç¨‹å†™å…¥æˆåŠŸã€‚è€Œå…¶ä»–ä¸‰ä¸ªåç¨‹ä¼šä¸€ç›´åœ¨åå°ç­‰å¾…å†™å…¥ã€‚

## å†™å‡ºä»¥ä¸‹æ‰“å°ç»“æœï¼Œå¹¶è§£é‡Šä¸‹ä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰“å°çš„ã€‚
   
```go
package main
import (
    "fmt"
)
func main() {
    str1 := []string{"a", "b", "c"}
    str2 := str1[1:]
    str2[1] = "new"
    fmt.Println(str1)
    str2 = append(str2, "z", "x", "y")
    fmt.Println(str1)
}
```

golang ä¸­çš„åˆ‡ç‰‡åº•å±‚å…¶å®ä½¿ç”¨çš„æ˜¯æ•°ç»„ã€‚å½“ä½¿ç”¨`str1[1:]` ä½¿ï¼Œ`str2` å’Œ `str1` åº•å±‚å…±äº«ä¸€ä¸ªæ•°ç»„ï¼Œè¿™å›å¯¼è‡´ `str2[1] = "new"` è¯­å¥å½±å“ `str1`ã€‚

è€Œ `append` ä¼šå¯¼è‡´åº•å±‚æ•°ç»„æ‰©å®¹ï¼Œç”Ÿæˆæ–°çš„æ•°ç»„ï¼Œå› æ­¤è¿½åŠ æ•°æ®åçš„ `str2` ä¸ä¼šå½±å“ `str1`ã€‚

ä½†æ˜¯ä¸ºä»€ä¹ˆå¯¹ `str2` å¤åˆ¶åå½±å“çš„ç¡®å® `str1` çš„ç¬¬ä¸‰ä¸ªå…ƒç´ å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåˆ‡ç‰‡  `str2` æ˜¯ä»æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹ï¼Œ`str2` ç´¢å¼•ä¸º 1 çš„å…ƒç´ å¯¹åº”çš„æ˜¯ `str1` ç´¢å¼•ä¸º 2 çš„å…ƒç´ ã€‚

## å†™å‡ºä»¥ä¸‹æ‰“å°ç»“æœ
   
```go
package main

import (
    "fmt"
)

type Student struct {
    Name string
}

func main() {
    fmt.Println(&Student{Name: "menglu"} == &Student{Name: "menglu"})
    fmt.Println(Student{Name: "menglu"} == Student{Name: "menglu"})
}
```

ä¸ªäººç†è§£ï¼šæŒ‡é’ˆç±»å‹æ¯”è¾ƒçš„æ˜¯æŒ‡é’ˆåœ°å€ï¼ŒéæŒ‡é’ˆç±»å‹æ¯”è¾ƒçš„æ˜¯æ¯ä¸ªå±æ€§çš„å€¼ã€‚

## å†™å‡ºä»¥ä¸‹ä»£ç çš„é—®é¢˜

```go
package main

import (
    "fmt"
)

func main() {
    fmt.Println([...]string{"1"} == [...]string{"1"})
    fmt.Println([]string{"1"} == []string{"1"})
}
```

æ•°ç»„åªèƒ½ä¸ç›¸åŒçº¬åº¦é•¿åº¦ä»¥åŠç±»å‹çš„å…¶ä»–æ•°ç»„æ¯”è¾ƒï¼Œåˆ‡ç‰‡ä¹‹é—´ä¸èƒ½ç›´æ¥æ¯”è¾ƒã€‚ã€‚

## ä¸‹é¢ä»£ç å†™æ³•æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```go
package main
import (
    "fmt"
)
type Student struct {
    Age int
}
func main() {
    kv := map[string]Student{"menglu": {Age: 21}}
    kv["menglu"].Age = 22
    s := []Student{{Age: 21}}
    s[0].Age = 22
    fmt.Println(kv, s)
}
```

golangä¸­çš„`map` é€šè¿‡`key`è·å–åˆ°çš„å®é™…ä¸Šæ˜¯ä¸¤ä¸ªå€¼ï¼Œç¬¬ä¸€ä¸ªæ˜¯è·å–åˆ°çš„å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯æ˜¯å¦å­˜åœ¨è¯¥`key`ã€‚å› æ­¤ä¸èƒ½ç›´æ¥é€šè¿‡`key`æ¥èµ‹å€¼å¯¹è±¡ã€‚
## golang å¹¶å‘é¢˜ç›®æµ‹è¯•

é¢˜ç›®æ¥æºï¼š [Goå¹¶å‘ç¼–ç¨‹å°æµ‹éªŒï¼š ä½ èƒ½ç­”å¯¹å‡ é“é¢˜ï¼Ÿ](https://colobu.com/2019/04/28/go-concurrency-quizzes/)

### 1 Mutex

```go
package main
import (
	"fmt"
	"sync"
)
var mu sync.Mutex
var chain string
func main() {
	chain = "main"
	A()
	fmt.Println(chain)
}
func A() {
	mu.Lock()
	defer mu.Unlock()
	chain = chain + " --> A"
	B()
}
func B() {
	chain = chain + " --> B"
	C()
}
func C() {
	mu.Lock()
	defer mu.Unlock()
	chain = chain + " --> C"
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: è¾“å‡º main --> A --> B --> C
- C: è¾“å‡º main
- D: panic

### 2 RWMutex

```go
package main
import (
	"fmt"
	"sync"
	"time"
)
var mu sync.RWMutex
var count int
func main() {
	go A()
	time.Sleep(2 * time.Second)
	mu.Lock()
	defer mu.Unlock()
	count++
	fmt.Println(count)
}
func A() {
	mu.RLock()
	defer mu.RUnlock()
	B()
}
func B() {
	time.Sleep(5 * time.Second)
	C()
}
func C() {
	mu.RLock()
	defer mu.RUnlock()
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: è¾“å‡º 1
- C: ç¨‹åºhangä½
- D: panic

### 3 Waitgroup

```go
package main
import (
	"sync"
	"time"
)
func main() {
	var wg sync.WaitGroup
	wg.Add(1)
	go func() {
		time.Sleep(time.Millisecond)
		wg.Done()
		wg.Add(1)
	}()
	wg.Wait()
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: æ— è¾“å‡ºï¼Œæ­£å¸¸é€€å‡º
- C: ç¨‹åºhangä½
- D: panic

### 4 åŒæ£€æŸ¥å®ç°å•ä¾‹

```go
package doublecheck
import (
	"sync"
)
type Once struct {
	m    sync.Mutex
	done uint32
}
func (o *Once) Do(f func()) {
	if o.done == 1 {
		return
	}
	o.m.Lock()
	defer o.m.Unlock()
	if o.done == 0 {
		o.done = 1
		f()
	}
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: å¯ä»¥ç¼–è¯‘ï¼Œæ­£ç¡®å®ç°äº†å•ä¾‹
- C: å¯ä»¥ç¼–è¯‘ï¼Œæœ‰å¹¶å‘é—®é¢˜ï¼Œfå‡½æ•°å¯èƒ½ä¼šè¢«æ‰§è¡Œå¤šæ¬¡
- D: å¯ä»¥ç¼–è¯‘ï¼Œä½†æ˜¯ç¨‹åºè¿è¡Œä¼španic

### 5 Mutex

```go
package main
import (
	"fmt"
	"sync"
)
type MyMutex struct {
	count int
	sync.Mutex
}
func main() {
	var mu MyMutex
	mu.Lock()
	var mu2 = mu
	mu.count++
	mu.Unlock()
	mu2.Lock()
	mu2.count++
	mu2.Unlock()
	fmt.Println(mu.count, mu2.count)
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: è¾“å‡º 1, 1
- C: è¾“å‡º 1, 2
- D: panic

### 6 Pool

```go
package main
import (
	"bytes"
	"fmt"
	"runtime"
	"sync"
	"time"
)
var pool = sync.Pool{New: func() interface{} { return new(bytes.Buffer) }}
func main() {
	go func() {
		for {
			processRequest(1 << 28) // 256MiB
		}
	}()
	for i := 0; i < 1000; i++ {
		go func() {
			for {
				processRequest(1 << 10) // 1KiB
			}
		}()
	}
	var stats runtime.MemStats
	for i := 0; ; i++ {
		runtime.ReadMemStats(&stats)
		fmt.Printf("Cycle %d: %dB\n", i, stats.Alloc)
		time.Sleep(time.Second)
		runtime.GC()
	}
}
func processRequest(size int) {
	b := pool.Get().(*bytes.Buffer)
	time.Sleep(500 * time.Millisecond)
	b.Grow(size)
	pool.Put(b)
	time.Sleep(1 * time.Millisecond)
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: å¯ä»¥ç¼–è¯‘ï¼Œè¿è¡Œæ—¶æ­£å¸¸ï¼Œå†…å­˜ç¨³å®š
- C: å¯ä»¥ç¼–è¯‘ï¼Œè¿è¡Œæ—¶å†…å­˜å¯èƒ½æš´æ¶¨
- D: å¯ä»¥ç¼–è¯‘ï¼Œè¿è¡Œæ—¶å†…å­˜å…ˆæš´æ¶¨ï¼Œä½†æ˜¯è¿‡ä¸€ä¼šä¼šå›æ”¶æ‰

### 7 channel

```go
package main
import (
	"fmt"
	"runtime"
	"time"
)
func main() {
	var ch chan int
	go func() {
		ch = make(chan int, 1)
		ch <- 1
	}()
	go func(ch chan int) {
		time.Sleep(time.Second)
		<-ch
	}(ch)
	c := time.Tick(1 * time.Second)
	for range c {
		fmt.Printf("#goroutines: %d\n", runtime.NumGoroutine())
	}
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: ä¸€æ®µæ—¶é—´åæ€»æ˜¯è¾“å‡º `#goroutines: 1`
- C: ä¸€æ®µæ—¶é—´åæ€»æ˜¯è¾“å‡º `#goroutines: 2`
- D: panic

### 8 channel

```go
package main
import "fmt"
func main() {
	var ch chan int
	var count int
	go func() {
		ch <- 1
	}()
	go func() {
		count++
		close(ch)
	}()
	<-ch
	fmt.Println(count)
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: è¾“å‡º 1
- C: è¾“å‡º 0
- D: panic

### 9 Map

```go
package main
import (
	"fmt"
	"sync"
)
func main() {
	var m sync.Map
	m.LoadOrStore("a", 1)
	m.Delete("a")
	fmt.Println(m.Len())
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: è¾“å‡º 1
- C: è¾“å‡º 0
- D: panic

### 10 happens before

```go
package main
var c = make(chan int)
var a int
func f() {
	a = 1
	<-c
}
func main() {
	go f()
	c <- 0
	print(a)
}
```

- A: ä¸èƒ½ç¼–è¯‘
- B: è¾“å‡º 1
- C: è¾“å‡º 0
- D: panic





## ç­”æ¡ˆ

### 1. D

ä¼šäº§ç”Ÿæ­»é”`panic`ï¼Œå› ä¸º`Mutex` æ˜¯äº’æ–¥é”ã€‚

### 2. D

ä¼šäº§ç”Ÿæ­»é”`panic`ï¼Œæ ¹æ®`sync/rwmutex.go` ä¸­æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè¯»å†™é”å½“æœ‰ä¸€ä¸ªåç¨‹åœ¨ç­‰å¾…å†™é”æ—¶ï¼Œå…¶ä»–åç¨‹æ˜¯ä¸èƒ½è·å¾—è¯»é”çš„ï¼Œè€Œåœ¨`A`å’Œ`C`ä¸­åŒä¸€ä¸ªè°ƒç”¨é“¾ä¸­é—´éœ€è¦è®©å‡ºè¯»é”ï¼Œè®©å†™é”ä¼˜å…ˆè·å–ï¼Œè€Œ`A`çš„è¯»é”åˆè¦æ±‚`C`è°ƒç”¨å®Œæˆï¼Œå› æ­¤æ­»é”ã€‚


### 3. D

`WaitGroup` åœ¨è°ƒç”¨ `Wait` ä¹‹åæ˜¯ä¸èƒ½å†è°ƒç”¨ `Add` æ–¹æ³•çš„ã€‚

### 4. C

åœ¨å¤šæ ¸CPUä¸­ï¼Œå› ä¸ºCPUç¼“å­˜ä¼šå¯¼è‡´å¤šä¸ªæ ¸å¿ƒä¸­å˜é‡å€¼ä¸åŒæ­¥ã€‚

### 5. D

åŠ é”åå¤åˆ¶å˜é‡ï¼Œä¼šå°†é”çš„çŠ¶æ€ä¹Ÿå¤åˆ¶ï¼Œæ‰€ä»¥`mu1` å…¶å®æ˜¯å·²ç»åŠ é”çŠ¶æ€ï¼Œå†åŠ é”ä¼šæ­»é”ã€‚

### 6. C

ä¸ªäººç†è§£ï¼Œåœ¨å•æ ¸CPUä¸­ï¼Œå†…å­˜å¯èƒ½ä¼šç¨³å®šåœ¨`256MB`ï¼Œå¦‚æœæ˜¯å¤šæ ¸å¯èƒ½ä¼šæš´æ¶¨ã€‚

### 7. C

å› ä¸º `ch` æœªåˆå§‹åŒ–ï¼Œå†™å’Œè¯»éƒ½ä¼šé˜»å¡ï¼Œä¹‹åè¢«ç¬¬ä¸€ä¸ªåç¨‹é‡æ–°èµ‹å€¼ï¼Œå¯¼è‡´å†™çš„`ch` éƒ½é˜»å¡ã€‚

### 8. D

`ch` æœªæœ‰è¢«åˆå§‹åŒ–ï¼Œå…³é—­æ—¶ä¼šæŠ¥é”™ã€‚

### 9. A

`sync.Map` æ²¡æœ‰ `Len` æ–¹æ³•ã€‚

### 10. B

`c <- 0` ä¼šé˜»å¡ä¾èµ–äº `f()` çš„æ‰§è¡Œã€‚







# è®°ä¸€é“å­—èŠ‚è·³åŠ¨çš„ç®—æ³•é¢è¯•é¢˜

## é¢˜ç›®

è¿™å…¶å®æ˜¯ä¸€é“å˜å½¢çš„é“¾è¡¨åè½¬é¢˜ï¼Œå¤§è‡´æè¿°å¦‚ä¸‹
ç»™å®šä¸€ä¸ªå•é“¾è¡¨çš„å¤´èŠ‚ç‚¹ head,å®ç°ä¸€ä¸ªè°ƒæ•´å•é“¾è¡¨çš„å‡½æ•°ï¼Œä½¿å¾—æ¯Kä¸ªèŠ‚ç‚¹ä¹‹é—´ä¸ºä¸€ç»„è¿›è¡Œé€†åºï¼Œå¹¶ä¸”ä»é“¾è¡¨çš„å°¾éƒ¨å¼€å§‹ç»„èµ·ï¼Œå¤´éƒ¨å‰©ä½™èŠ‚ç‚¹æ•°é‡ä¸å¤Ÿä¸€ç»„çš„ä¸éœ€è¦é€†åºã€‚ï¼ˆä¸èƒ½ä½¿ç”¨é˜Ÿåˆ—æˆ–è€…æ ˆä½œä¸ºè¾…åŠ©ï¼‰

**ä¾‹å¦‚ï¼š**

é“¾è¡¨:`1->2->3->4->5->6->7->8->null, K = 3`ã€‚é‚£ä¹ˆ `6->7->8`ï¼Œ`3->4->5`ï¼Œ`1->2`å„ä½ä¸€ç»„ã€‚è°ƒæ•´åï¼š`1->2->5->4->3->8->7->6->null`ã€‚å…¶ä¸­ 1ï¼Œ2ä¸è°ƒæ•´ï¼Œå› ä¸ºä¸å¤Ÿä¸€ç»„ã€‚

**è§£æ**

åŸæ–‡ï¼š <https://juejin.im/post/5d4f76325188253b49244dd0># å¤šåç¨‹æŸ¥è¯¢åˆ‡ç‰‡é—®é¢˜

## é¢˜ç›®

å‡è®¾æœ‰ä¸€ä¸ªè¶…é•¿çš„åˆ‡ç‰‡ï¼Œåˆ‡ç‰‡çš„å…ƒç´ ç±»å‹ä¸ºintï¼Œåˆ‡ç‰‡ä¸­çš„å…ƒç´ ä¸ºä¹±åºæ’åºã€‚é™æ—¶5ç§’ï¼Œä½¿ç”¨å¤šä¸ªgoroutineæŸ¥æ‰¾åˆ‡ç‰‡ä¸­æ˜¯å¦å­˜åœ¨ç»™å®šçš„å€¼ï¼Œåœ¨æŸ¥æ‰¾åˆ°ç›®æ ‡å€¼æˆ–è€…è¶…æ—¶åç«‹åˆ»ç»“æŸæ‰€æœ‰goroutineçš„æ‰§è¡Œã€‚

æ¯”å¦‚ï¼Œåˆ‡ç‰‡ `[23,32,78,43,76,65,345,762,......915,86]`ï¼ŒæŸ¥æ‰¾ç›®æ ‡å€¼ä¸º 345 ï¼Œå¦‚æœåˆ‡ç‰‡ä¸­å­˜åœ¨ï¼Œåˆ™ç›®æ ‡å€¼è¾“å‡º`"Found it!"`å¹¶ç«‹å³å–æ¶ˆä»åœ¨æ‰§è¡ŒæŸ¥è¯¢ä»»åŠ¡çš„`goroutine`ã€‚

å¦‚æœåœ¨è¶…æ—¶æ—¶é—´æœªæŸ¥åˆ°ç›®æ ‡å€¼ç¨‹åºï¼Œåˆ™è¾“å‡º`"Timeoutï¼Not Found"`ï¼ŒåŒæ—¶ç«‹å³å–æ¶ˆä»åœ¨æ‰§è¡Œçš„æŸ¥æ‰¾ä»»åŠ¡çš„`goroutine`ã€‚

> ç­”æ¡ˆ: <https://mp.weixin.qq.com/s/GhC2WDw3VHP91DrrFVCnag>













# Goroutineè°ƒåº¦ç­–ç•¥

> åŸæ–‡ï¼š [ç¬¬ä¸‰ç«  Goroutineè°ƒåº¦ç­–ç•¥ï¼ˆ16ï¼‰](https://mp.weixin.qq.com/s?__biz=MzU1OTg5NDkzOA==&mid=2247483801&idx=1&sn=ef7f872afccf148661cbd5a3d3b5b0a2&scene=19#wechat_redirect)


åœ¨è°ƒåº¦å™¨æ¦‚è¿°ä¸€èŠ‚æˆ‘ä»¬æåˆ°è¿‡ï¼Œæ‰€è°“çš„goroutineè°ƒåº¦ï¼Œæ˜¯æŒ‡ç¨‹åºä»£ç æŒ‰ç…§ä¸€å®šçš„ç®—æ³•åœ¨é€‚å½“çš„æ—¶å€™æŒ‘é€‰å‡ºåˆé€‚çš„goroutineå¹¶æ”¾åˆ°CPUä¸Šå»è¿è¡Œçš„è¿‡ç¨‹ã€‚è¿™å¥è¯æ­ç¤ºäº†è°ƒåº¦ç³»ç»Ÿéœ€è¦è§£å†³çš„ä¸‰å¤§æ ¸å¿ƒé—®é¢˜ï¼š

- è°ƒåº¦æ—¶æœºï¼šä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿè°ƒåº¦ï¼Ÿ
- è°ƒåº¦ç­–ç•¥ï¼šä½¿ç”¨ä»€ä¹ˆç­–ç•¥æ¥æŒ‘é€‰ä¸‹ä¸€ä¸ªè¿›å…¥è¿è¡Œçš„goroutineï¼Ÿ
- åˆ‡æ¢æœºåˆ¶ï¼šå¦‚ä½•æŠŠæŒ‘é€‰å‡ºæ¥çš„goroutineæ”¾åˆ°CPUä¸Šè¿è¡Œï¼Ÿ

å¯¹è¿™ä¸‰å¤§é—®é¢˜çš„è§£å†³æ„æˆäº†è°ƒåº¦å™¨çš„æ‰€æœ‰å·¥ä½œï¼Œå› è€Œæˆ‘ä»¬å¯¹è°ƒåº¦å™¨çš„åˆ†æä¹Ÿå¿…å°†å›´ç»•ç€å®ƒä»¬æ‰€å±•å¼€ã€‚

ç¬¬äºŒç« æˆ‘ä»¬å·²ç»è¯¦ç»†çš„åˆ†æäº†è°ƒåº¦å™¨çš„åˆå§‹åŒ–ä»¥åŠgoroutineçš„åˆ‡æ¢æœºåˆ¶ï¼Œæœ¬ç« å°†é‡ç‚¹è®¨è®ºè°ƒåº¦å™¨å¦‚ä½•æŒ‘é€‰ä¸‹ä¸€ä¸ªgoroutineå‡ºæ¥è¿è¡Œçš„ç­–ç•¥é—®é¢˜ï¼Œè€Œå‰©ä¸‹çš„ä¸è°ƒåº¦æ—¶æœºç›¸å…³çš„å†…å®¹æˆ‘ä»¬å°†åœ¨ç¬¬4ï½6ç« è¿›è¡Œå…¨é¢çš„åˆ†æã€‚

## å†æ¢scheduleå‡½æ•°

åœ¨è®¨è®ºmain goroutineçš„è°ƒåº¦æ—¶æˆ‘ä»¬å·²ç»è§è¿‡scheduleå‡½æ•°ï¼Œå› ä¸ºå½“æ—¶æˆ‘ä»¬çš„ä¸»è¦å…³æ³¨ç‚¹åœ¨äºmain goroutineæ˜¯å¦‚ä½•è¢«è°ƒåº¦åˆ°CPUä¸Šè¿è¡Œçš„ï¼Œæ‰€ä»¥å¹¶æœªå¯¹scheduleå‡½æ•°å¦‚ä½•æŒ‘é€‰ä¸‹ä¸€ä¸ªgoroutineå‡ºæ¥è¿è¡Œåšæ·±å…¥çš„åˆ†æï¼Œç°åœ¨æ˜¯é‡æ–°å›åˆ°scheduleå‡½æ•°è¯¦ç»†åˆ†æå…¶è°ƒåº¦ç­–ç•¥çš„æ—¶å€™äº†ã€‚

[runtime/proc.go : 2467](https://github.com/golang/go/blob/bcda68447b31b86bc3829fca80454ca1a2a572e0/src/runtime/proc.go#L2551)

```go
// One round of scheduler: find a runnable goroutine and execute it.
// Never returns.
func schedule() {
    _g_ := getg()   //_g_ = m.g0

    ......

    var gp *g

    ......
   
    if gp == nil {
    // Check the global runnable queue once in a while to ensure fairness.
    // Otherwise two goroutines can completely occupy the local runqueue
    // by constantly respawning each other.
       //ä¸ºäº†ä¿è¯è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹æ¯è¿›è¡Œ61æ¬¡è°ƒåº¦å°±éœ€è¦ä¼˜å…ˆä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutineå‡ºæ¥è¿è¡Œï¼Œ
       //å› ä¸ºå¦‚æœåªè°ƒåº¦æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineï¼Œåˆ™å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineæœ‰å¯èƒ½å¾—ä¸åˆ°è¿è¡Œ
        if _g_.m.p.ptr().schedtick%61 == 0 && sched.runqsize > 0 {
            lock(&sched.lock) //æ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½èƒ½è®¿é—®å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥éœ€è¦åŠ é”
            gp = globrunqget(_g_.m.p.ptr(), 1) //ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–1ä¸ªgoroutine
            unlock(&sched.lock)
        }
    }
    if gp == nil {
        //ä»ä¸må…³è”çš„pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutine
        gp, inheritTime = runqget(_g_.m.p.ptr())
        if gp != nil && _g_.m.spinning {
            throw("schedule: spinning with local work")
        }
    }
    if gp == nil {
        //å¦‚æœä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å’Œå…¨å±€è¿è¡Œé˜Ÿåˆ—éƒ½æ²¡æœ‰æ‰¾åˆ°éœ€è¦è¿è¡Œçš„goroutineï¼Œ
        //åˆ™è°ƒç”¨findrunnableå‡½æ•°ä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—ä¸­å·å–ï¼Œå¦‚æœå·å–ä¸åˆ°ï¼Œåˆ™å½“å‰å·¥ä½œçº¿ç¨‹è¿›å…¥ç¡çœ ï¼Œ
        //ç›´åˆ°è·å–åˆ°éœ€è¦è¿è¡Œçš„goroutineä¹‹åfindrunnableå‡½æ•°æ‰ä¼šè¿”å›ã€‚
        gp, inheritTime = findrunnable() // blocks until work is available
    }

    ......

    //å½“å‰è¿è¡Œçš„æ˜¯runtimeçš„ä»£ç ï¼Œå‡½æ•°è°ƒç”¨æ ˆä½¿ç”¨çš„æ˜¯g0çš„æ ˆç©ºé—´
    //è°ƒç”¨execteåˆ‡æ¢åˆ°gpçš„ä»£ç å’Œæ ˆç©ºé—´å»è¿è¡Œ
    execute(gp, inheritTime)  
}
```

scheduleå‡½æ•°åˆ†ä¸‰æ­¥åˆ†åˆ«ä»å„è¿è¡Œé˜Ÿåˆ—ä¸­å¯»æ‰¾å¯è¿è¡Œçš„goroutineï¼š

- ç¬¬ä¸€æ­¥ï¼Œä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­å¯»æ‰¾goroutineã€‚ä¸ºäº†ä¿è¯è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹æ¯ç»è¿‡61æ¬¡è°ƒåº¦å°±éœ€è¦ä¼˜å…ˆå°è¯•ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æ‰¾å‡ºä¸€ä¸ªgoroutineæ¥è¿è¡Œï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ä½äºå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineå¾—åˆ°è°ƒåº¦çš„æœºä¼šã€‚å…¨å±€è¿è¡Œé˜Ÿåˆ—æ˜¯æ‰€æœ‰å·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®çš„ï¼Œæ‰€ä»¥åœ¨è®¿é—®å®ƒä¹‹å‰éœ€è¦åŠ é”ã€‚

- ç¬¬äºŒæ­¥ï¼Œä»å·¥ä½œçº¿ç¨‹æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­å¯»æ‰¾goroutineã€‚å¦‚æœä¸éœ€è¦æˆ–ä¸èƒ½ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–åˆ°goroutineåˆ™ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ã€‚

- ç¬¬ä¸‰æ­¥ï¼Œä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—ä¸­å·å–goroutineã€‚å¦‚æœä¸Šä¸€æ­¥ä¹Ÿæ²¡æœ‰æ‰¾åˆ°éœ€è¦è¿è¡Œçš„goroutineï¼Œåˆ™è°ƒç”¨findrunnableä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—ä¸­å·å–goroutineï¼Œfindrunnableå‡½æ•°åœ¨å·å–ä¹‹å‰ä¼šå†æ¬¡å°è¯•ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—å’Œå½“å‰çº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾éœ€è¦è¿è¡Œçš„goroutineã€‚

ä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹å¦‚ä½•ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutineã€‚

## ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutine

ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–å¯è¿è¡Œçš„goroutineæ˜¯é€šè¿‡globrunqgetå‡½æ•°æ¥å®Œæˆçš„ï¼Œè¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„pï¼Œç¬¬äºŒä¸ªå‚æ•°maxè¡¨ç¤ºæœ€å¤šå¯ä»¥ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å¤šå°‘ä¸ªgåˆ°å½“å‰å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æ¥ã€‚

[runtime/proc.go : 4663](https://github.com/golang/go/blob/bcda68447b31b86bc3829fca80454ca1a2a572e0/src/runtime/proc.go#L4996)

```go
// Try get a batch of G's from the global runnable queue.
// Sched must be locked.
func globrunqget(_p_ *p, max int32) *g {
    if sched.runqsize == 0 {  //å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸ºç©º
        return nil
    }

    //æ ¹æ®pçš„æ•°é‡å¹³åˆ†å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutines
    n := sched.runqsize / gomaxprocs + 1
    if n > sched.runqsize { //ä¸Šé¢è®¡ç®—nçš„æ–¹æ³•å¯èƒ½å¯¼è‡´nå¤§äºå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineæ•°é‡
        n = sched.runqsize
    }
    if max > 0 && n > max {
        n = max   //æœ€å¤šå–maxä¸ªgoroutine
    }
    if n > int32(len(_p_.runq)) / 2 {
        n = int32(len(_p_.runq)) / 2  //æœ€å¤šåªèƒ½å–æœ¬åœ°é˜Ÿåˆ—å®¹é‡çš„ä¸€åŠ
    }

    sched.runqsize -= n

    //ç›´æ¥é€šè¿‡å‡½æ•°è¿”å›gpï¼Œå…¶å®ƒçš„goroutinesé€šè¿‡runqputæ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—
    gp := sched.runq.pop()  //popä»å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´å–
    n--
    for ; n > 0; n-- {
        gp1 := sched.runq.pop()  //ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªgoroutine
        runqput(_p_, gp1, false)  //æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—
    }
    return gp
}
```

globrunqgetå‡½æ•°é¦–å…ˆä¼šæ ¹æ®å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­goroutineçš„æ•°é‡ï¼Œå‡½æ•°å‚æ•°maxä»¥åŠ_p_çš„æœ¬åœ°é˜Ÿåˆ—çš„å®¹é‡è®¡ç®—å‡ºåˆ°åº•åº”è¯¥æ‹¿å¤šå°‘ä¸ªgoroutineï¼Œç„¶åæŠŠç¬¬ä¸€ä¸ªgç»“æ„ä½“å¯¹è±¡é€šè¿‡è¿”å›å€¼çš„æ–¹å¼è¿”å›ç»™è°ƒç”¨å‡½æ•°ï¼Œå…¶å®ƒçš„åˆ™é€šè¿‡runqputå‡½æ•°æ”¾å…¥å½“å‰å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€‚è¿™æ®µä»£ç å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè®¡ç®—åº”è¯¥ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æ‹¿èµ°å¤šå°‘ä¸ªgoroutineæ—¶æ ¹æ®pçš„æ•°é‡ï¼ˆgomaxprocsï¼‰åšäº†è´Ÿè½½å‡è¡¡ã€‚

å¦‚æœæ²¡æœ‰ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–åˆ°goroutineï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±åœ¨å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­å¯»æ‰¾éœ€è¦è¿è¡Œçš„goroutineã€‚

## ä»å·¥ä½œçº¿ç¨‹æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutine

ä»ä»£ç ä¸Šæ¥çœ‹ï¼Œå·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å…¶å®åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç”±pçš„runqã€runqheadå’Œrunqtailè¿™ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„ä¸€ä¸ªæ— é”å¾ªç¯é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—æœ€å¤šå¯åŒ…å«256ä¸ªgoroutineï¼›å¦ä¸€éƒ¨åˆ†æ˜¯pçš„runnextæˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘gç»“æ„ä½“å¯¹è±¡çš„æŒ‡é’ˆï¼Œå®ƒæœ€å¤šåªåŒ…å«ä¸€ä¸ªgoroutineã€‚

ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­å¯»æ‰¾goroutineæ˜¯é€šè¿‡`runqget`å‡½æ•°å®Œæˆçš„ï¼Œå¯»æ‰¾æ—¶ï¼Œä»£ç é¦–å…ˆæŸ¥çœ‹`runnext`æˆå‘˜æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è¿”å›runnextæ‰€æŒ‡çš„goroutineï¼Œå¹¶æŠŠrunnextæˆå‘˜æ¸…é›¶ï¼Œå¦‚æœrunnextä¸ºç©ºï¼Œåˆ™ç»§ç»­ä»å¾ªç¯é˜Ÿåˆ—ä¸­æŸ¥æ‰¾goroutineã€‚

[runtime/proc.go : 4825](https://github.com/golang/go/blob/bcda68447b31b86bc3829fca80454ca1a2a572e0/src/runtime/proc.go#L5192:1)

```go
// Get g from local runnable queue.
// If inheritTime is true, gp should inherit the remaining time in the
// current time slice. Otherwise, it should start a new time slice.
// Executed only by the owner P.
func runqget(_p_ *p) (gp *g, inheritTime bool) {
    // If there's a runnext, it's the next G to run.
    //ä»runnextæˆå‘˜ä¸­è·å–goroutine
    for {
        //æŸ¥çœ‹runnextæˆå‘˜æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è¿”å›è¯¥goroutine
        next := _p_.runnext  
        if next == 0 {
            break
        }
        if _p_.runnext.cas(next, 0) {
            return next.ptr(), true
        }
    }

    //ä»å¾ªç¯é˜Ÿåˆ—ä¸­è·å–goroutine
    for {
        h := atomic.LoadAcq(&_p_.runqhead) // load-acquire, synchronize with other consumers
        t := _p_.runqtail
        if t == h {
            return nil, false
        }
        gp := _p_.runq[h%uint32(len(_p_.runq))].ptr()
        if atomic.CasRel(&_p_.runqhead, h, h+1) { // cas-release, commits consume
            return gp, false
        }
    }
}
```

è¿™é‡Œé¦–å…ˆéœ€è¦æ³¨æ„çš„æ˜¯ä¸ç®¡æ˜¯ä»runnextè¿˜æ˜¯ä»å¾ªç¯é˜Ÿåˆ—ä¸­æ‹¿å–goroutineéƒ½ä½¿ç”¨äº†casæ“ä½œï¼Œè¿™é‡Œçš„casæ“ä½œæ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºå¯èƒ½æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹æ­¤æ—¶æ­¤åˆ»ä¹Ÿæ­£åœ¨è®¿é—®è¿™ä¸¤ä¸ªæˆå‘˜ï¼Œä»è¿™é‡Œå·å–å¯è¿è¡Œçš„goroutineã€‚

å…¶æ¬¡ï¼Œä»£ç ä¸­å¯¹runqheadçš„æ“ä½œä½¿ç”¨äº†`atomic.LoadAcq`å’Œ`atomic.CasRel`ï¼Œå®ƒä»¬åˆ†åˆ«æä¾›äº†`load-acquire`å’Œ`cas-release`è¯­ä¹‰ã€‚

**å¯¹äºatomic.LoadAcqæ¥è¯´ï¼Œå…¶è¯­ä¹‰ä¸»è¦åŒ…å«å¦‚ä¸‹å‡ æ¡ï¼š**

- åŸå­è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡ä»£ç è¿è¡Œåœ¨å“ªç§å¹³å°ï¼Œä¿è¯åœ¨è¯»å–è¿‡ç¨‹ä¸­ä¸ä¼šæœ‰å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡è¿›è¡Œå†™å…¥ï¼›
- ä½äº`atomic.LoadAcq`ä¹‹åçš„ä»£ç ï¼Œå¯¹å†…å­˜çš„è¯»å–å’Œå†™å…¥å¿…é¡»åœ¨`atomic.LoadAcq`è¯»å–å®Œæˆåæ‰èƒ½æ‰§è¡Œï¼Œç¼–è¯‘å™¨å’ŒCPUéƒ½ä¸èƒ½æ‰“ä¹±è¿™ä¸ªé¡ºåºï¼›
- å½“å‰çº¿ç¨‹æ‰§è¡Œ`atomic.LoadAcq`æ—¶å¯ä»¥è¯»å–åˆ°å…¶å®ƒçº¿ç¨‹æœ€è¿‘ä¸€æ¬¡é€šè¿‡`atomic.CasRel`å¯¹åŒä¸€ä¸ªå˜é‡å†™å…¥çš„å€¼ï¼Œä¸æ­¤åŒæ—¶ï¼Œä½äº`atomic.LoadAcq`ä¹‹åçš„ä»£ç ï¼Œä¸ç®¡è¯»å–å“ªä¸ªå†…å­˜åœ°å€ä¸­çš„å€¼ï¼Œéƒ½å¯ä»¥è¯»å–åˆ°å…¶å®ƒçº¿ç¨‹ä¸­ä½äºatomic.CasRelï¼ˆå¯¹åŒä¸€ä¸ªå˜é‡æ“ä½œï¼‰ä¹‹å‰çš„ä»£ç æœ€è¿‘ä¸€æ¬¡å¯¹å†…å­˜çš„å†™å…¥ã€‚

**å¯¹äºatomic.CasRelæ¥è¯´ï¼Œå…¶è¯­ä¹‰ä¸»è¦åŒ…å«å¦‚ä¸‹å‡ æ¡ï¼š**

- åŸå­çš„æ‰§è¡Œæ¯”è¾ƒå¹¶äº¤æ¢çš„æ“ä½œï¼›
- ä½äº`atomic.CasRel`ä¹‹å‰çš„ä»£ç ï¼Œå¯¹å†…å­˜çš„è¯»å–å’Œå†™å…¥å¿…é¡»åœ¨`atomic.CasRel`å¯¹å†…å­˜çš„å†™å…¥ä¹‹å‰å®Œæˆï¼Œç¼–è¯‘å™¨å’ŒCPUéƒ½ä¸èƒ½æ‰“ä¹±è¿™ä¸ªé¡ºåºï¼›
- çº¿ç¨‹æ‰§è¡Œ`atomic.CasRel`å®Œæˆåå…¶å®ƒçº¿ç¨‹é€šè¿‡`atomic.LoadAcq`è¯»å–åŒä¸€ä¸ªå˜é‡å¯ä»¥è¯»åˆ°æœ€æ–°çš„å€¼ï¼Œä¸æ­¤åŒæ—¶ï¼Œä½äº`atomic.CasRel`ä¹‹å‰çš„ä»£ç å¯¹å†…å­˜å†™å…¥çš„å€¼ï¼Œå¯ä»¥è¢«å…¶å®ƒçº¿ç¨‹ä¸­ä½äº`atomic.LoadAcq`ï¼ˆå¯¹åŒä¸€ä¸ªå˜é‡æ“ä½œï¼‰ä¹‹åçš„ä»£ç è¯»å–åˆ°ã€‚

å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹ä¼šå¹¶å‘çš„ä¿®æ”¹å’Œè¯»å–`runqhead`ï¼Œä»¥åŠéœ€è¦ä¾é runqheadçš„å€¼æ¥è¯»å–runqæ•°ç»„çš„å…ƒç´ ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨atomic.LoadAcqå’Œatomic.CasRelæ¥ä¿è¯ä¸Šè¿°è¯­ä¹‰ã€‚

æˆ‘ä»¬å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¯»å–pçš„runqtailæˆå‘˜ä¸éœ€è¦ä½¿ç”¨atomic.LoadAcqæˆ–atomic.loadï¼Ÿå› ä¸ºrunqtailä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹ï¼Œåªä¼šè¢«å½“å‰å·¥ä½œçº¿ç¨‹ä¿®æ”¹ï¼Œæ­¤æ—¶æ²¡æœ‰äººä¿®æ”¹å®ƒï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦ä½¿ç”¨åŸå­ç›¸å…³çš„æ“ä½œã€‚

æœ€åï¼Œç”±`p`çš„`runq`ã€`runqhead`å’Œ`runqtail`è¿™ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„è¿™ä¸ªæ— é”å¾ªç¯é˜Ÿåˆ—éå¸¸ç²¾å¦™ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢çš„ç« èŠ‚å¯¹è¿™ä¸ªå¾ªç¯é˜Ÿåˆ—è¿›è¡Œåˆ†æã€‚

## CASæ“ä½œä¸ABAé—®é¢˜

æˆ‘ä»¬çŸ¥é“ä½¿ç”¨casæ“ä½œéœ€è¦ç‰¹åˆ«æ³¨æ„ABAçš„é—®é¢˜ï¼Œé‚£ä¹ˆrunqgetå‡½æ•°è¿™ä¸¤ä¸ªä½¿ç”¨casçš„åœ°æ–¹ä¼šä¸ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¿™ä¸¤ä¸ªåœ°æ–¹éƒ½ä¸ä¼šæœ‰ABAçš„é—®é¢˜ã€‚åŸå› åˆ†æå¦‚ä¸‹ï¼š

é¦–å…ˆæ¥çœ‹å¯¹runnextçš„casæ“ä½œã€‚åªæœ‰è·Ÿ_p_ç»‘å®šçš„å½“å‰å·¥ä½œçº¿ç¨‹æ‰ä¼šå»ä¿®æ”¹runnextä¸ºä¸€ä¸ªé0å€¼ï¼Œå…¶å®ƒçº¿ç¨‹åªä¼šæŠŠrunnextçš„å€¼ä»ä¸€ä¸ªé0å€¼ä¿®æ”¹ä¸º0å€¼ï¼Œç„¶è€Œè·Ÿ_p_ç»‘å®šçš„å½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨æ­¤å¤„æ‰§è¡Œä»£ç ï¼Œæ‰€ä»¥åœ¨å½“å‰å·¥ä½œçº¿ç¨‹è¯»å–åˆ°å€¼Aä¹‹åï¼Œä¸å¯èƒ½æœ‰çº¿ç¨‹ä¿®æ”¹å…¶å€¼ä¸ºB(0)ä¹‹åå†ä¿®æ”¹å›Aã€‚

å†æ¥çœ‹å¯¹runqçš„casæ“ä½œã€‚å½“å‰å·¥ä½œçº¿ç¨‹æ“ä½œçš„æ˜¯_p_çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œåªæœ‰è·Ÿ_p_ç»‘å®šåœ¨ä¸€èµ·çš„å½“å‰å·¥ä½œçº¿ç¨‹æ‰ä¼šå› ä¸ºå¾€è¯¥é˜Ÿåˆ—é‡Œé¢æ·»åŠ goroutineè€Œå»ä¿®æ”¹runqtailï¼Œè€Œå…¶å®ƒå·¥ä½œçº¿ç¨‹ä¸ä¼šå¾€è¯¥é˜Ÿåˆ—é‡Œé¢æ·»åŠ goroutineï¼Œä¹Ÿå°±ä¸ä¼šå»ä¿®æ”¹runqtailï¼Œå®ƒä»¬åªä¼šä¿®æ”¹runqheadï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬è¿™ä¸ªå·¥ä½œçº¿ç¨‹ä»runqheadè¯»å–åˆ°å€¼Aä¹‹åï¼Œå…¶å®ƒå·¥ä½œçº¿ç¨‹ä¹Ÿå°±ä¸å¯èƒ½ä¿®æ”¹runqheadçš„å€¼ä¸ºBä¹‹åå†ç¬¬äºŒæ¬¡æŠŠå®ƒä¿®æ”¹ä¸ºå€¼Aï¼ˆå› ä¸ºrunqtailåœ¨è¿™æ®µæ—¶é—´ä¹‹å†…ä¸å¯èƒ½è¢«ä¿®æ”¹ï¼Œrunqheadçš„å€¼ä¹Ÿå°±æ— æ³•è¶Šè¿‡runqtailå†å›ç»•åˆ°Aå€¼ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç ä»é€»è¾‘ä¸Šå·²ç»æœç»äº†å¼•å‘ABAçš„æ¡ä»¶ã€‚

åˆ°æ­¤ï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œå·¥ä½œçº¿ç¨‹ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—å’Œæœ¬åœ°è¿è¡Œé˜Ÿåˆ—è·å–goroutineçš„ä»£ç ï¼Œç”±äºç¯‡å¹…çš„é™åˆ¶ï¼Œæˆ‘ä»¬ä¸‹ä¸€èŠ‚å†æ¥åˆ†æä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—å·å–goroutineçš„æµç¨‹ã€‚






































# å¯¹å·²ç»å…³é—­çš„çš„chanè¿›è¡Œè¯»å†™ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

## é¢˜ç›®

å¯¹å·²ç»å…³é—­çš„çš„ chan è¿›è¡Œè¯»å†™ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

## å›ç­”

- è¯»å·²ç»å…³é—­çš„ chan èƒ½ä¸€ç›´è¯»åˆ°ä¸œè¥¿ï¼Œä½†æ˜¯è¯»åˆ°çš„å†…å®¹æ ¹æ®é€šé“å†…å…³é—­å‰æ˜¯å¦æœ‰å…ƒç´ è€Œä¸åŒã€‚
    - å¦‚æœ chan å…³é—­å‰ï¼Œbuffer å†…æœ‰å…ƒç´ è¿˜æœªè¯» , ä¼šæ­£ç¡®è¯»åˆ° chan å†…çš„å€¼ï¼Œä¸”è¿”å›çš„ç¬¬äºŒä¸ª bool å€¼ï¼ˆæ˜¯å¦è¯»æˆåŠŸï¼‰ä¸º trueã€‚
    - å¦‚æœ chan å…³é—­å‰ï¼Œbuffer å†…æœ‰å…ƒç´ å·²ç»è¢«è¯»å®Œï¼Œchan å†…æ— å€¼ï¼Œæ¥ä¸‹æ¥æ‰€æœ‰æ¥æ”¶çš„å€¼éƒ½ä¼šéé˜»å¡ç›´æ¥æˆåŠŸï¼Œè¿”å› channel å…ƒç´ çš„é›¶å€¼ï¼Œä½†æ˜¯ç¬¬äºŒä¸ª bool å€¼ä¸€ç›´ä¸º falseã€‚
- å†™å·²ç»å…³é—­çš„ chan ä¼š panic


## ç¤ºä¾‹

### 1. å†™å·²ç»å…³é—­çš„ chan

```go
func main(){
    c := make(chan int,3)
    close(c)
    c <- 1
}
//è¾“å‡ºç»“æœ
panic: send on closed channel

goroutine 1 [running]
main.main()
...
```

- æ³¨æ„è¿™ä¸ª send on closed channelï¼Œå¾…ä¼šä¼šæåˆ°ã€‚

### 2. è¯»å·²ç»å…³é—­çš„ chan

```go
package main
import "fmt"

func main()  {
    fmt.Println("ä»¥ä¸‹æ˜¯æ•°å€¼çš„chan")
    ci:=make(chan int,3)
    ci<-1
    close(ci)
    num,ok := <- ci
    fmt.Printf("è¯»chançš„åç¨‹ç»“æŸï¼Œnum=%vï¼Œ ok=%v\n",num,ok)
    num1,ok1 := <-ci
    fmt.Printf("å†è¯»chançš„åç¨‹ç»“æŸï¼Œnum=%vï¼Œ ok=%v\n",num1,ok1)
    num2,ok2 := <-ci
    fmt.Printf("å†å†è¯»chançš„åç¨‹ç»“æŸï¼Œnum=%vï¼Œ ok=%v\n",num2,ok2)
    
    fmt.Println("ä»¥ä¸‹æ˜¯å­—ç¬¦ä¸²chan")
    cs := make(chan string,3)
    cs <- "aaa"
    close(cs)
    str,ok := <- cs
    fmt.Printf("è¯»chançš„åç¨‹ç»“æŸï¼Œstr=%vï¼Œ ok=%v\n",str,ok)
    str1,ok1 := <-cs
    fmt.Printf("å†è¯»chançš„åç¨‹ç»“æŸï¼Œstr=%vï¼Œ ok=%v\n",str1,ok1)
    str2,ok2 := <-cs
    fmt.Printf("å†å†è¯»chançš„åç¨‹ç»“æŸï¼Œstr=%vï¼Œ ok=%v\n",str2,ok2)

    fmt.Println("ä»¥ä¸‹æ˜¯ç»“æ„ä½“chan")
    type MyStruct struct{
        Name string
    }
    cstruct := make(chan MyStruct,3)
    cstruct <- MyStruct{Name: "haha"}
    close(cstruct)
    stru,ok := <- cstruct
    fmt.Printf("è¯»chançš„åç¨‹ç»“æŸï¼Œstru=%vï¼Œ ok=%v\n",stru,ok)
    stru1,ok1 := <-cs
    fmt.Printf("å†è¯»chançš„åç¨‹ç»“æŸï¼Œstru=%vï¼Œ ok=%v\n",stru1,ok1)
    stru2,ok2 := <-cs
    fmt.Printf("å†å†è¯»chançš„åç¨‹ç»“æŸï¼Œstru=%vï¼Œ ok=%v\n",stru2,ok2)
}

```

è¾“å‡ºç»“æœ

```bash
ä»¥ä¸‹æ˜¯æ•°å€¼çš„chan
è¯»chançš„åç¨‹ç»“æŸï¼Œnum=1ï¼Œ ok=true
å†è¯»chançš„åç¨‹ç»“æŸï¼Œnum=0ï¼Œ ok=false
å†å†è¯»chançš„åç¨‹ç»“æŸï¼Œnum=0ï¼Œ ok=false
ä»¥ä¸‹æ˜¯å­—ç¬¦ä¸²chan
è¯»chançš„åç¨‹ç»“æŸï¼Œstr=aaaï¼Œ ok=true
å†è¯»chançš„åç¨‹ç»“æŸï¼Œstr=ï¼Œ ok=false
å†å†è¯»chançš„åç¨‹ç»“æŸï¼Œstr=ï¼Œ ok=false
ä»¥ä¸‹æ˜¯ç»“æ„ä½“chan
è¯»chançš„åç¨‹ç»“æŸï¼Œstru={haha}ï¼Œ ok=true
å†è¯»chançš„åç¨‹ç»“æŸï¼Œstru=ï¼Œ ok=false
å†å†è¯»chançš„åç¨‹ç»“æŸï¼Œstru=ï¼Œ ok=false
```


## å¤šé—®ä¸€å¥

### 1. ä¸ºä»€ä¹ˆå†™å·²ç»å…³é—­çš„ `chan` å°±ä¼š `panic` å‘¢ï¼Ÿ

```go
//åœ¨ src/runtime/chan.go
func chansend(c *hchan,ep unsafe.Pointer,block bool,callerpc uintptr) bool {
    //çœç•¥å…¶ä»–
    if c.closed != 0 {
        unlock(&c.lock)
        panic(plainError("send on closed channel"))
    }   
    //çœç•¥å…¶ä»–
}
```

- å½“ `c.closed != 0` åˆ™ä¸ºé€šé“å…³é—­ï¼Œæ­¤æ—¶æ‰§è¡Œå†™ï¼Œæºç æç¤ºç›´æ¥ `panic`ï¼Œè¾“å‡ºçš„å†…å®¹å°±æ˜¯ä¸Šé¢æåˆ°çš„ `"send on closed channel"`ã€‚

### 2. ä¸ºä»€ä¹ˆè¯»å·²å…³é—­çš„ chan ä¼šä¸€ç›´èƒ½è¯»åˆ°å€¼ï¼Ÿ

```go
func chanrecv(c *hchan,ep unsafe.Pointer,block bool) (selected,received bool) {
    //çœç•¥éƒ¨åˆ†é€»è¾‘
    lock(&c.lock)
    //å½“chanè¢«å…³é—­äº†ï¼Œè€Œä¸”ç¼“å­˜ä¸ºç©ºæ—¶
    //ep æ˜¯æŒ‡ val,ok := <-c é‡Œçš„valåœ°å€
    if c.closed != 0 && c.qcount == 0 {
        if receenabled {
            raceacquire(c.raceaddr())
        }
        unlock(&c.lock)
        //å¦‚æœæ¥å—ä¹‹çš„åœ°å€ä¸ç©ºï¼Œé‚£æ¥æ”¶å€¼å°†è·å¾—ä¸€ä¸ªè¯¥å€¼ç±»å‹çš„é›¶å€¼
        //typedmemclr ä¼šæ ¹æ®ç±»å‹æ¸…ç†å“åº”çš„å†…å­˜
        //è¿™å°±è§£é‡Šäº†ä¸Šé¢ä»£ç ä¸ºä»€ä¹ˆå…³é—­çš„chan ä¼šè¿”å›å¯¹åº”ç±»å‹çš„é›¶å€¼
        if ep != null {
            typedmemclr(c.elemtype,ep)
        }   
        //è¿”å›ä¸¤ä¸ªå‚æ•° selected,received
        // ç¬¬äºŒä¸ªé‡‡çº³æ•°å°±æ˜¯ val,ok := <- c é‡Œçš„ ok
        //ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆè¯»å…³é—­çš„chanä¼šä¸€ç›´è¿”å›false
        return true,false
    }   
}
```
- `c.closed != 0 && c.qcount == 0` æŒ‡é€šé“å·²ç»å…³é—­ï¼Œä¸”ç¼“å­˜ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼ˆå·²ç»è¯»å®Œäº†ä¹‹å‰å†™åˆ°é€šé“é‡Œçš„å€¼ï¼‰
- å¦‚æœæ¥æ”¶å€¼çš„åœ°å€ `ep` ä¸ä¸ºç©º
    - é‚£æ¥æ”¶å€¼å°†è·å¾—æ˜¯ä¸€ä¸ªè¯¥ç±»å‹çš„é›¶å€¼
    - `typedmemclr` ä¼šæ ¹æ®ç±»å‹æ¸…ç†ç›¸åº”åœ°å€çš„å†…å­˜
    - è¿™å°±è§£é‡Šäº†ä¸Šé¢ä»£ç ä¸ºä»€ä¹ˆå…³é—­çš„ chan ä¼šè¿”å›å¯¹åº”ç±»å‹çš„é›¶å€¼





# ç®€å•èŠèŠå†…å­˜é€ƒé€¸ï¼Ÿ

## é—®é¢˜

çŸ¥é“golangçš„å†…å­˜é€ƒé€¸å—ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå†…å­˜é€ƒé€¸ï¼Ÿ

## å›ç­”

golangç¨‹åºå˜é‡ä¼šæºå¸¦æœ‰ä¸€ç»„æ ¡éªŒæ•°æ®ï¼Œç”¨æ¥è¯æ˜å®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯å¦åœ¨è¿è¡Œæ—¶å®Œå…¨å¯çŸ¥ã€‚å¦‚æœå˜é‡é€šè¿‡äº†è¿™äº›æ ¡éªŒï¼Œå®ƒå°±å¯ä»¥åœ¨æ ˆä¸Šåˆ†é…ã€‚å¦åˆ™å°±è¯´å®ƒ é€ƒé€¸ äº†ï¼Œå¿…é¡»åœ¨å †ä¸Šåˆ†é…ã€‚

èƒ½å¼•èµ·å˜é‡é€ƒé€¸åˆ°å †ä¸Šçš„å…¸å‹æƒ…å†µï¼š

- **åœ¨æ–¹æ³•å†…æŠŠå±€éƒ¨å˜é‡æŒ‡é’ˆè¿”å›** å±€éƒ¨å˜é‡åŸæœ¬åº”è¯¥åœ¨æ ˆä¸­åˆ†é…ï¼Œåœ¨æ ˆä¸­å›æ”¶ã€‚ä½†æ˜¯ç”±äºè¿”å›æ—¶è¢«å¤–éƒ¨å¼•ç”¨ï¼Œå› æ­¤å…¶ç”Ÿå‘½å‘¨æœŸå¤§äºæ ˆï¼Œåˆ™æº¢å‡ºã€‚
- **å‘é€æŒ‡é’ˆæˆ–å¸¦æœ‰æŒ‡é’ˆçš„å€¼åˆ° channel ä¸­ã€‚**  åœ¨ç¼–è¯‘æ—¶ï¼Œæ˜¯æ²¡æœ‰åŠæ³•çŸ¥é“å“ªä¸ª `goroutine` ä¼šåœ¨ `channel` ä¸Šæ¥æ”¶æ•°æ®ã€‚æ‰€ä»¥ç¼–è¯‘å™¨æ²¡æ³•çŸ¥é“å˜é‡ä»€ä¹ˆæ—¶å€™æ‰ä¼šè¢«é‡Šæ”¾ã€‚
- **åœ¨ä¸€ä¸ªåˆ‡ç‰‡ä¸Šå­˜å‚¨æŒ‡é’ˆæˆ–å¸¦æŒ‡é’ˆçš„å€¼ã€‚** ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ `[]*string` ã€‚è¿™ä¼šå¯¼è‡´åˆ‡ç‰‡çš„å†…å®¹é€ƒé€¸ã€‚å°½ç®¡å…¶åé¢çš„æ•°ç»„å¯èƒ½æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„ï¼Œä½†å…¶å¼•ç”¨çš„å€¼ä¸€å®šæ˜¯åœ¨å †ä¸Šã€‚
- **slice çš„èƒŒåæ•°ç»„è¢«é‡æ–°åˆ†é…äº†ï¼Œå› ä¸º append æ—¶å¯èƒ½ä¼šè¶…å‡ºå…¶å®¹é‡( cap )ã€‚** slice åˆå§‹åŒ–çš„åœ°æ–¹åœ¨ç¼–è¯‘æ—¶æ˜¯å¯ä»¥çŸ¥é“çš„ï¼Œå®ƒæœ€å¼€å§‹ä¼šåœ¨æ ˆä¸Šåˆ†é…ã€‚å¦‚æœåˆ‡ç‰‡èƒŒåçš„å­˜å‚¨è¦åŸºäºè¿è¡Œæ—¶çš„æ•°æ®è¿›è¡Œæ‰©å……ï¼Œå°±ä¼šåœ¨å †ä¸Šåˆ†é…ã€‚
- **åœ¨ interface ç±»å‹ä¸Šè°ƒç”¨æ–¹æ³•ã€‚**  åœ¨ interface ç±»å‹ä¸Šè°ƒç”¨æ–¹æ³•éƒ½æ˜¯åŠ¨æ€è°ƒåº¦çš„ â€”â€” æ–¹æ³•çš„çœŸæ­£å®ç°åªèƒ½åœ¨è¿è¡Œæ—¶çŸ¥é“ã€‚æƒ³åƒä¸€ä¸ª io.Reader ç±»å‹çš„å˜é‡ r , è°ƒç”¨ r.Read(b) ä¼šä½¿å¾— r çš„å€¼å’Œåˆ‡ç‰‡b çš„èƒŒåå­˜å‚¨éƒ½é€ƒé€¸æ‰ï¼Œæ‰€ä»¥ä¼šåœ¨å †ä¸Šåˆ†é…ã€‚

## ä¸¾ä¾‹

**é€šè¿‡ä¸€ä¸ªä¾‹å­åŠ æ·±ç†è§£ï¼Œæ¥ä¸‹æ¥å°è¯•ä¸‹æ€ä¹ˆé€šè¿‡ `go build -gcflags=-m` æŸ¥çœ‹é€ƒé€¸çš„æƒ…å†µã€‚**

```go
package main
import "fmt"
type A struct {
 s string
}
// è¿™æ˜¯ä¸Šé¢æåˆ°çš„ "åœ¨æ–¹æ³•å†…æŠŠå±€éƒ¨å˜é‡æŒ‡é’ˆè¿”å›" çš„æƒ…å†µ
func foo(s string) *A {
 a := new(A) 
 a.s = s
 return a //è¿”å›å±€éƒ¨å˜é‡a,åœ¨Cè¯­è¨€ä¸­å¦¥å¦¥é‡æŒ‡é’ˆï¼Œä½†åœ¨goåˆ™okï¼Œä½†aä¼šé€ƒé€¸åˆ°å †
}
func main() {
 a := foo("hello")
 b := a.s + " world"
 c := b + "!"
 fmt.Println(c)
}
```

æ‰§è¡Œgo build -gcflags=-m main.go

```bash
go build -gcflags=-m main.go
# command-line-arguments
./main.go:7:6: can inline foo
./main.go:13:10: inlining call to foo
./main.go:16:13: inlining call to fmt.Println
/var/folders/45/qx9lfw2s2zzgvhzg3mtzkwzc0000gn/T/go-build409982591/b001/_gomod_.go:6:6: can inline init.0
./main.go:7:10: leaking param: s
./main.go:8:10: new(A) escapes to heap
./main.go:16:13: io.Writer(os.Stdout) escapes to heap
./main.go:16:13: c escapes to heap
./main.go:15:9: b + "!" escapes to heap
./main.go:13:10: main new(A) does not escape
./main.go:14:11: main a.s + " world" does not escape
./main.go:16:13: main []interface {} literal does not escape
<autogenerated>:1: os.(*File).close .this does not escape
```

- `./main.go:8:10: new(A) escapes to heap` è¯´æ˜ `new(A)` é€ƒé€¸äº†,ç¬¦åˆä¸Šè¿°æåˆ°çš„å¸¸è§æƒ…å†µä¸­çš„ç¬¬ä¸€ç§ã€‚
- `./main.go:14:11: main a.s + " world" does not escape` è¯´æ˜ b å˜é‡æ²¡æœ‰é€ƒé€¸ï¼Œå› ä¸ºå®ƒåªåœ¨æ–¹æ³•å†…å­˜åœ¨ï¼Œä¼šåœ¨æ–¹æ³•ç»“æŸæ—¶è¢«å›æ”¶ã€‚
- `./main.go:15:9: b + "!" escapes to heap` è¯´æ˜ c å˜é‡é€ƒé€¸ï¼Œé€šè¿‡`fmt.Println(a ...interface{})`æ‰“å°çš„å˜é‡ï¼Œéƒ½ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å»æŸ¥æŸ¥ä¸ºä»€ä¹ˆã€‚

ä»¥ä¸Šæ“ä½œå…¶å®å°±å«é€ƒé€¸åˆ†æã€‚ä¸‹ç¯‡æ–‡ç« ï¼Œè·Ÿå¤§å®¶èŠèŠæ€ä¹ˆç”¨ä¸€ä¸ªæ¯”è¾ƒtrickçš„æ–¹æ³•ä½¿å˜é‡ä¸é€ƒé€¸ã€‚æ–¹ä¾¿å¤§å®¶åœ¨é¢è¯•å®˜é¢å‰ç§€ä¸€æ³¢ã€‚


>åŸæ–‡ <https://mp.weixin.qq.com/s/4YYR1eYFIFsNOaTxL4Q-eQ>








# å­—ç¬¦ä¸²è½¬æˆbyteæ•°ç»„ï¼Œä¼šå‘ç”Ÿå†…å­˜æ‹·è´å—ï¼Ÿ

## é—®é¢˜

å­—ç¬¦ä¸²è½¬æˆbyteæ•°ç»„ï¼Œä¼šå‘ç”Ÿå†…å­˜æ‹·è´å—ï¼Ÿ

## å›ç­”

å­—ç¬¦ä¸²è½¬æˆåˆ‡ç‰‡ï¼Œä¼šäº§ç”Ÿæ‹·è´ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œåªè¦æ˜¯å‘ç”Ÿç±»å‹å¼ºè½¬éƒ½ä¼šå‘ç”Ÿå†…å­˜æ‹·è´ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ã€‚

é¢‘ç¹çš„å†…å­˜æ‹·è´æ“ä½œå¬èµ·æ¥å¯¹æ€§èƒ½ä¸å¤§å‹å¥½ã€‚æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥åœ¨å­—ç¬¦ä¸²è½¬æˆåˆ‡ç‰‡çš„æ—¶å€™ä¸ç”¨å‘ç”Ÿæ‹·è´å‘¢ï¼Ÿ

## è§£é‡Š

```go
package main

import (
 "fmt"
 "reflect"
 "unsafe"
)

func main() {
 a :="aaa"
 ssh := *(*reflect.StringHeader)(unsafe.Pointer(&a))
 b := *(*[]byte)(unsafe.Pointer(&ssh))  
 fmt.Printf("%v",b)
}
```

**`StringHeader` æ˜¯å­—ç¬¦ä¸²åœ¨goçš„åº•å±‚ç»“æ„ã€‚**

```go
type StringHeader struct {
 Data uintptr
 Len  int
}
```

**`SliceHeader` æ˜¯åˆ‡ç‰‡åœ¨goçš„åº•å±‚ç»“æ„ã€‚**

```go
type SliceHeader struct {
 Data uintptr
 Len  int
 Cap  int
}
```

é‚£ä¹ˆå¦‚æœæƒ³è¦åœ¨åº•å±‚è½¬æ¢äºŒè€…ï¼Œåªéœ€è¦æŠŠ StringHeader çš„åœ°å€å¼ºè½¬æˆ SliceHeader å°±è¡Œã€‚é‚£ä¹ˆgoæœ‰ä¸ªå¾ˆå¼ºçš„åŒ…å« unsafe ã€‚

1. `unsafe.Pointer(&a)`æ–¹æ³•å¯ä»¥å¾—åˆ°å˜é‡açš„åœ°å€ã€‚
2. `(*reflect.StringHeader)(unsafe.Pointer(&a))` å¯ä»¥æŠŠå­—ç¬¦ä¸²aè½¬æˆåº•å±‚ç»“æ„çš„å½¢å¼ã€‚
3. `(*[]byte)(unsafe.Pointer(&ssh))` å¯ä»¥æŠŠsshåº•å±‚ç»“æ„ä½“è½¬æˆbyteçš„åˆ‡ç‰‡çš„æŒ‡é’ˆã€‚
4. å†é€šè¿‡ `*`è½¬ä¸ºæŒ‡é’ˆæŒ‡å‘çš„å®é™…å†…å®¹ã€‚
















# httpåŒ…çš„å†…å­˜æ³„æ¼

## é—®é¢˜

```go
package main

import (
	"fmt"
	"io/ioutil"
	"net/http"
	"runtime"
)

func main() {
	num := 6
	for index := 0; index < num; index++ {
		resp, _ := http.Get("https://www.baidu.com")
		_, _ = ioutil.ReadAll(resp.Body)
	}
	fmt.Printf("æ­¤æ—¶goroutineä¸ªæ•°= %d\n", runtime.NumGoroutine())


}
```

ä¸Šé¢è¿™é“é¢˜åœ¨ä¸æ‰§è¡Œ`resp.Body.Close()`çš„æƒ…å†µä¸‹ï¼Œæ³„æ¼äº†å—ï¼Ÿå¦‚æœæ³„æ¼ï¼Œæ³„æ¼äº†å¤šå°‘ä¸ªgoroutine?

## æ€ä¹ˆç­”

ä¸è¿›è¡Œresp.Body.Close()ï¼Œæ³„æ¼æ˜¯ä¸€å®šçš„ã€‚ä½†æ˜¯æ³„æ¼çš„goroutineä¸ªæ•°å°±è®©æˆ‘è¿·ç³Šäº†ã€‚ç”±äºæ‰§è¡Œäº†6éï¼Œæ¯æ¬¡æ³„æ¼ä¸€ä¸ªè¯»å’Œå†™goroutineï¼Œå°±æ˜¯12ä¸ªgoroutineï¼ŒåŠ ä¸Šmainå‡½æ•°æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªgoroutineï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯13.
ç„¶è€Œæ‰§è¡Œç¨‹åºï¼Œå‘ç°ç­”æ¡ˆæ˜¯3ï¼Œå‡ºå…¥æœ‰ç‚¹å¤§ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

## è§£é‡Š

æˆ‘ä»¬ç›´æ¥çœ‹æºç ã€‚golang çš„ http åŒ…ã€‚

```go
http.Get()

-- DefaultClient.Get
----func (c *Client) do(req *Request)
------func send(ireq *Request, rt RoundTripper, deadline time.Time)
-------- resp, didTimeout, err = send(req, c.transport(), deadline) 
// ä»¥ä¸Šä»£ç åœ¨ go/1.12.7/libexec/src/net/http/client:174 

func (c *Client) transport() RoundTripper {
	if c.Transport != nil {
		return c.Transport
	}
	return DefaultTransport
}
```

- è¯´æ˜ `http.Get` é»˜è®¤ä½¿ç”¨ `DefaultTransport` ç®¡ç†è¿æ¥ã€‚

DefaultTransport æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ

```go
// It establishes network connections as needed
// and caches them for reuse by subsequent calls.
```

- `DefaultTransport` çš„ä½œç”¨æ˜¯æ ¹æ®éœ€è¦å»ºç«‹ç½‘ç»œè¿æ¥å¹¶ç¼“å­˜å®ƒä»¬ä»¥ä¾›åç»­è°ƒç”¨é‡ç”¨ã€‚

é‚£ä¹ˆ `DefaultTransport` ä»€ä¹ˆæ—¶å€™ä¼šå»ºç«‹è¿æ¥å‘¢ï¼Ÿ

æ¥ç€ä¸Šé¢çš„ä»£ç å †æ ˆå¾€ä¸‹ç¿»

```go
func send(ireq *Request, rt RoundTripper, deadline time.Time) 
--resp, err = rt.RoundTrip(req) // ä»¥ä¸Šä»£ç åœ¨ go/1.12.7/libexec/src/net/http/client:250
func (t *Transport) RoundTrip(req *http.Request)
func (t *Transport) roundTrip(req *Request)
func (t *Transport) getConn(treq *transportRequest, cm connectMethod)
func (t *Transport) dialConn(ctx context.Context, cm connectMethod) (*persistConn, error) {
    ...
	go pconn.readLoop()  // å¯åŠ¨ä¸€ä¸ªè¯»goroutine
	go pconn.writeLoop() // å¯åŠ¨ä¸€ä¸ªå†™goroutine
	return pconn, nil
}
```

- ä¸€æ¬¡å»ºç«‹è¿æ¥ï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªè¯»goroutineå’Œå†™goroutineã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€æ¬¡`http.Get()`ä¼šæ³„æ¼ä¸¤ä¸ªgoroutineçš„æ¥æºã€‚
- æ³„æ¼çš„æ¥æºçŸ¥é“äº†ï¼Œä¹ŸçŸ¥é“æ˜¯å› ä¸ºæ²¡æœ‰æ‰§è¡Œclose

**é‚£ä¸ºä»€ä¹ˆä¸æ‰§è¡Œ close ä¼šæ³„æ¼å‘¢ï¼Ÿ**

å›åˆ°åˆšåˆšå¯åŠ¨çš„è¯»goroutine çš„ `readLoop()` ä»£ç é‡Œ

```go
func (pc *persistConn) readLoop() {
	alive := true
	for alive {
        ...
		// Before looping back to the top of this function and peeking on
		// the bufio.Reader, wait for the caller goroutine to finish
		// reading the response body. (or for cancelation or death)
		select {
		case bodyEOF := <-waitForBodyRead:
			pc.t.setReqCanceler(rc.req, nil) // before pc might return to idle pool
			alive = alive &&
				bodyEOF &&
				!pc.sawEOF &&
				pc.wroteRequest() &&
				tryPutIdleConn(trace)
			if bodyEOF {
				eofc <- struct{}{}
			}
		case <-rc.req.Cancel:
			alive = false
			pc.t.CancelRequest(rc.req)
		case <-rc.req.Context().Done():
			alive = false
			pc.t.cancelRequest(rc.req, rc.req.Context().Err())
		case <-pc.closech:
			alive = false
        }
        ...
	}
}
```

å…¶ä¸­ç¬¬ä¸€ä¸ª body è¢«è¯»å–å®Œæˆ–å…³é—­è¿™ä¸ª case:

```go
alive = alive &&
    bodyEOF &&
    !pc.sawEOF &&
    pc.wroteRequest() &&
    tryPutIdleConn(trace)

```

bodyEOF æ¥æºäºåˆ°ä¸€ä¸ªé€šé“ waitForBodyReadï¼Œè¿™ä¸ªå­—æ®µçš„ true å’Œ false ç›´æ¥å†³å®šäº† alive å˜é‡çš„å€¼ï¼ˆalive=trueé‚£è¯»goroutineç»§ç»­æ´»ç€ï¼Œå¾ªç¯ï¼Œå¦åˆ™é€€å‡ºgoroutineï¼‰ã€‚

**é‚£ä¹ˆè¿™ä¸ªé€šé“çš„å€¼æ˜¯ä»å“ªé‡Œè¿‡æ¥çš„å‘¢ï¼Ÿ**


```go
// go/1.12.7/libexec/src/net/http/transport.go: 1758
		body := &bodyEOFSignal{
			body: resp.Body,
			earlyCloseFn: func() error {
				waitForBodyRead <- false
				<-eofc // will be closed by deferred call at the end of the function
				return nil

			},
			fn: func(err error) error {
				isEOF := err == io.EOF
				waitForBodyRead <- isEOF
				if isEOF {
					<-eofc // see comment above eofc declaration
				} else if err != nil {
					if cerr := pc.canceled(); cerr != nil {
						return cerr
					}
				}
				return err
			},
		}
```

- å¦‚æœæ‰§è¡Œ earlyCloseFn ï¼ŒwaitForBodyRead é€šé“è¾“å…¥çš„æ˜¯ falseï¼Œalive ä¹Ÿä¼šæ˜¯ falseï¼Œé‚£ readLoop() è¿™ä¸ª goroutine å°±ä¼šé€€å‡ºã€‚
- å¦‚æœæ‰§è¡Œ fn ï¼Œå…¶ä¸­åŒ…æ‹¬æ­£å¸¸æƒ…å†µä¸‹ body è¯»å®Œæ•°æ®æŠ›å‡º io.EOF æ—¶çš„ caseï¼ŒwaitForBodyRead é€šé“è¾“å…¥çš„æ˜¯ trueï¼Œé‚£ alive ä¼šæ˜¯ trueï¼Œé‚£ä¹ˆ readLoop() è¿™ä¸ª goroutine å°±ä¸ä¼šé€€å‡ºï¼ŒåŒæ—¶è¿˜é¡ºä¾¿æ‰§è¡Œäº† tryPutIdleConn(trace) ã€‚

```go
// tryPutIdleConn adds pconn to the list of idle persistent connections awaiting
// a new request.
// If pconn is no longer needed or not in a good state, tryPutIdleConn returns
// an error explaining why it wasn't registered.
// tryPutIdleConn does not close pconn. Use putOrCloseIdleConn instead for that.
func (t *Transport) tryPutIdleConn(pconn *persistConn) error
```

- tryPutIdleConn å°† pconn æ·»åŠ åˆ°ç­‰å¾…æ–°è¯·æ±‚çš„ç©ºé—²æŒä¹…è¿æ¥åˆ—è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰è¯´çš„è¿æ¥ä¼šå¤ç”¨ã€‚

é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œä»€ä¹ˆæ—¶å€™ä¼šæ‰§è¡Œè¿™ä¸ª `fn` å’Œ `earlyCloseFn` å‘¢ï¼Ÿ

```go
func (es *bodyEOFSignal) Close() error {
	es.mu.Lock()
	defer es.mu.Unlock()
	if es.closed {
		return nil
	}
	es.closed = true
	if es.earlyCloseFn != nil && es.rerr != io.EOF {
		return es.earlyCloseFn() // å…³é—­æ—¶æ‰§è¡Œ earlyCloseFn
	}
	err := es.body.Close()
	return es.condfn(err)
}
```

- ä¸Šé¢è¿™ä¸ªå…¶å®å°±æ˜¯æˆ‘ä»¬æ¯”è¾ƒæ”¶æ‚‰çš„ resp.Body.Close() ,åœ¨é‡Œé¢ä¼šæ‰§è¡Œ earlyCloseFnï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶ readLoop() é‡Œçš„ waitForBodyRead é€šé“è¾“å…¥çš„æ˜¯ falseï¼Œalive ä¹Ÿä¼šæ˜¯ falseï¼Œé‚£ readLoop() è¿™ä¸ª goroutine å°±ä¼šé€€å‡ºï¼Œgoroutine ä¸ä¼šæ³„éœ²ã€‚
  
```go
b, err = ioutil.ReadAll(resp.Body)
--func ReadAll(r io.Reader) 
----func readAll(r io.Reader, capacity int64) 
------func (b *Buffer) ReadFrom(r io.Reader)


// go/1.12.7/libexec/src/bytes/buffer.go:207
func (b *Buffer) ReadFrom(r io.Reader) (n int64, err error) {
	for {
		...
		m, e := r.Read(b.buf[i:cap(b.buf)])  // çœ‹è¿™é‡Œï¼Œæ˜¯bodyåœ¨æ‰§è¡Œreadæ–¹æ³•
		...
	}
}
```

- è¿™ä¸ª`read`ï¼Œå…¶å®å°±æ˜¯ `bodyEOFSignal` é‡Œçš„

```go
func (es *bodyEOFSignal) Read(p []byte) (n int, err error) {
	...
	n, err = es.body.Read(p)
	if err != nil {
		... 
    // è¿™é‡Œä¼šæœ‰ä¸€ä¸ªio.EOFçš„æŠ¥é”™ï¼Œæ„æ€æ˜¯è¯»å®Œäº†
		err = es.condfn(err)
	}
	return
}


func (es *bodyEOFSignal) condfn(err error) error {
	if es.fn == nil {
		return err
	}
	err = es.fn(err)  // è¿™äº†æ‰§è¡Œäº† fn
	es.fn = nil
	return err
}
```

- ä¸Šé¢è¿™ä¸ªå…¶å®å°±æ˜¯æˆ‘ä»¬æ¯”è¾ƒæ”¶æ‚‰çš„è¯»å– body é‡Œçš„å†…å®¹ã€‚ ioutil.ReadAll() ,åœ¨è¯»å®Œ body çš„å†…å®¹æ—¶ä¼šæ‰§è¡Œ fnï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶ readLoop() é‡Œçš„ waitForBodyRead é€šé“è¾“å…¥çš„æ˜¯ trueï¼Œalive ä¹Ÿä¼šæ˜¯ trueï¼Œé‚£ readLoop() è¿™ä¸ª goroutine å°±ä¸ä¼šé€€å‡ºï¼Œgoroutine ä¼šæ³„éœ²ï¼Œç„¶åæ‰§è¡Œ tryPutIdleConn(trace) æŠŠè¿æ¥æ”¾å›æ± å­é‡Œå¤ç”¨ã€‚
  
## æ€»ç»“

- æ‰€ä»¥ç»“è®ºå‘¼ä¹‹æ¬²å‡ºäº†ï¼Œè™½ç„¶æ‰§è¡Œäº† 6 æ¬¡å¾ªç¯ï¼Œè€Œä¸”æ¯æ¬¡éƒ½æ²¡æœ‰æ‰§è¡Œ Body.Close() ,å°±æ˜¯å› ä¸ºæ‰§è¡Œäº†ioutil.ReadAll()æŠŠå†…å®¹éƒ½è¯»å‡ºæ¥äº†ï¼Œè¿æ¥å¾—ä»¥å¤ç”¨ï¼Œå› æ­¤åªæ³„æ¼äº†ä¸€ä¸ªè¯»goroutineå’Œä¸€ä¸ªå†™goroutineï¼Œæœ€ååŠ ä¸Šmain goroutineï¼Œæ‰€ä»¥ç­”æ¡ˆå°±æ˜¯3ä¸ªgoroutineã€‚
- ä»å¦å¤–ä¸€ä¸ªè§’åº¦è¯´ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬çš„ä»£ç éƒ½ä¼šæ‰§è¡Œ ioutil.ReadAll()ï¼Œä½†å¦‚æœæ­¤æ—¶å¿˜äº† resp.Body.Close()ï¼Œç¡®å®ä¼šå¯¼è‡´æ³„æ¼ã€‚ä½†å¦‚æœä½ è°ƒç”¨çš„åŸŸåä¸€ç›´æ˜¯åŒä¸€ä¸ªçš„è¯ï¼Œé‚£ä¹ˆåªä¼šæ³„æ¼ä¸€ä¸ª è¯»goroutine å’Œä¸€ä¸ªå†™goroutineï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»£ç æ˜æ˜ä¸è§„èŒƒä½†å´çœ‹ä¸åˆ°æ˜æ˜¾å†…å­˜æ³„æ¼çš„åŸå› ã€‚
- é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œä¸ºä»€ä¹ˆä¸Šé¢è¦ç‰¹æ„å¼ºè°ƒæ˜¯åŒä¸€ä¸ªåŸŸåå‘¢ï¼Ÿæ”¹å¤©ï¼Œå›å¤´ï¼Œä»¥åæœ‰ç©ºå†è¯´å§ã€‚


>ä½œè€…ï¼š9è™ŸåŒå­¦
é“¾æ¥ï¼šhttps://juejin.cn/post/6896993332019822605
æ¥æºï¼šæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚


ä½œè€…ï¼š9è™ŸåŒå­¦
é“¾æ¥ï¼šhttps://juejin.cn/post/6896993332019822605
æ¥æºï¼šæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚


# sync.Map çš„ç”¨æ³•

## é—®é¢˜

```go
package main

import (
	"fmt"
	"sync"
)

func main(){
	var m sync.Map
	m.Store("address",map[string]string{"province":"æ±Ÿè‹","city":"å—äº¬"})
        v,_ := m.Load("address")
	fmt.Println(v["province"]) 
}
```

- Aï¼Œæ±Ÿè‹ï¼›
- B`ï¼Œv["province"]`å–å€¼é”™è¯¯ï¼›
- Cï¼Œ`m.Store`å­˜å‚¨é”™è¯¯ï¼›
- Dï¼Œä¸çŸ¥é“

## è§£æ

`invalid operation: v["province"] (type interface {} does not support indexing)`
å› ä¸º `func (m *Map) Store(key interface{}, value interface{})`
æ‰€ä»¥ `v`ç±»å‹æ˜¯ `interface {}` ï¼Œè¿™é‡Œéœ€è¦ä¸€ä¸ªç±»å‹æ–­è¨€

```go
fmt.Println(v.(map[string]string)["province"]) //æ±Ÿè‹
```
<!-- TOC -->

- [MongoDB](#mongodb)
  - [1.MongoDBä¸­å¯¹å¤šæ¡è®°å½•åšæ›´æ–°æ“ä½œå‘½ä»¤æ˜¯ä»€ä¹ˆï¼Ÿ](#1mongodb%e4%b8%ad%e5%af%b9%e5%a4%9a%e6%9d%a1%e8%ae%b0%e5%bd%95%e5%81%9a%e6%9b%b4%e6%96%b0%e6%93%8d%e4%bd%9c%e5%91%bd%e4%bb%a4%e6%98%af%e4%bb%80%e4%b9%88)
  - [2.MongoDBå¦‚ä½•æ‰ä¼šæ‹“å±•åˆ°å¤šä¸ªshardé‡Œï¼Ÿ](#2mongodb%e5%a6%82%e4%bd%95%e6%89%8d%e4%bc%9a%e6%8b%93%e5%b1%95%e5%88%b0%e5%a4%9a%e4%b8%aashard%e9%87%8c)

<!-- /TOC -->

## MongoDB
### 1.MongoDBä¸­å¯¹å¤šæ¡è®°å½•åšæ›´æ–°æ“ä½œå‘½ä»¤æ˜¯ä»€ä¹ˆï¼Ÿ
### 2.MongoDBå¦‚ä½•æ‰ä¼šæ‹“å±•åˆ°å¤šä¸ªshardé‡Œï¼Ÿ
# ä¸ºä»€ä¹ˆMySQLä½¿ç”¨B+æ ‘åšç´¢å¼•ï¼Ÿ

ç´¢å¼•è¿™ä¸ªè¯ï¼Œç›¸ä¿¡å¤§å¤šæ•°äººå·²ç»ç›¸å½“ç†Ÿæ‚‰äº†ï¼Œå¾ˆå¤šäººéƒ½çŸ¥é“MySQLçš„ç´¢å¼•ä¸»è¦ä»¥B+æ ‘ä¸ºä¸»ï¼Œä½†æ˜¯è¦é—®åˆ°ä¸ºä»€ä¹ˆç”¨B+æ ‘ï¼Œææ€•å¾ˆå°‘æœ‰äººèƒ½æŠŠå‰å› åæœè®²è¿°çš„å¾ˆå®Œæ•´ã€‚æœ¬æ–‡å°±æ¥ä»å¤´åˆ°å°¾ä»‹ç»ä¸‹æ•°æ®åº“çš„ç´¢å¼•ã€‚

ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨äºå¸®åŠ©æˆ‘ä»¬åœ¨å¤§é‡æ•°æ®ä¸­å¿«é€Ÿå®šä½åˆ°æˆ‘ä»¬æƒ³è¦æŸ¥æ‰¾çš„æ•°æ®ã€‚ ç´¢å¼•æœ€å½¢è±¡çš„æ¯”å–»å°±æ˜¯å›¾ä¹¦çš„ç›®å½•äº†ã€‚æ³¨æ„è¿™é‡Œçš„å¤§é‡ï¼Œæ•°æ®é‡å¤§äº†ç´¢å¼•æ‰æ˜¾å¾—æœ‰æ„ä¹‰ï¼Œå¦‚æœæˆ‘æƒ³è¦åœ¨[1,2,3,4]ä¸­æ‰¾åˆ°4è¿™ä¸ªæ•°æ®ï¼Œç›´æ¥å¯¹å…¨æ•°æ®æ£€ç´¢ä¹Ÿå¾ˆå¿«ï¼Œæ²¡æœ‰å¿…è¦è´¹åŠ›æ°”å»ºç´¢å¼•å†å»æŸ¥æ‰¾ã€‚ç´¢å¼•åœ¨mysqlæ•°æ®åº“ä¸­åˆ†ä¸‰ç±»ï¼š 

B+æ ‘ç´¢å¼•ã€Hashç´¢å¼•ã€å…¨æ–‡ç´¢å¼•

æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„æ˜¯å·¥ä½œå¼€å‘ä¸­æœ€å¸¸æ¥è§¦åˆ°innodbå­˜å‚¨å¼•æ“ä¸­çš„çš„B+æ ‘ç´¢å¼•ã€‚

è¦ä»‹ç»B+æ ‘ç´¢å¼•ï¼Œå°±ä¸å¾—ä¸æäºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå¹³è¡¡äºŒå‰æ ‘å’ŒBæ ‘è¿™ä¸‰ç§æ•°æ®ç»“æ„ã€‚B+æ ‘å°±æ˜¯ä»ä»–ä»¬ä»¨æ¼”åŒ–æ¥çš„ã€‚

## äºŒå‰æŸ¥æ‰¾æ ‘

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å…ˆçœ‹ä¸€å¼ å›¾

![](../images/640.jpeg)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸ºuserè¡¨ï¼ˆç”¨æˆ·ä¿¡æ¯è¡¨ï¼‰å»ºç«‹äº†ä¸€ä¸ªäºŒå‰æŸ¥æ‰¾æ ‘çš„ç´¢å¼•ã€‚å›¾ä¸­çš„åœ†ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¸­å­˜å‚¨äº†é”®(key)å’Œæ•°æ®(data)ã€‚

é”®å¯¹åº”userè¡¨ä¸­çš„idï¼Œæ•°æ®å¯¹åº”userè¡¨ä¸­çš„è¡Œæ•°æ®ã€‚äºŒå‰æŸ¥æ‰¾æ ‘çš„ç‰¹ç‚¹å°±æ˜¯ä»»ä½•èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹çš„é”®å€¼éƒ½å°äºå½“å‰èŠ‚ç‚¹çš„é”®å€¼ï¼Œå³å­èŠ‚ç‚¹çš„é”®å€¼éƒ½å¤§äºå½“å‰èŠ‚ç‚¹çš„é”®å€¼ã€‚ é¡¶ç«¯çš„èŠ‚ç‚¹æˆ‘ä»¬ç§°ä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹æˆ‘ä»¬ç§°ä¹‹ä¸ºå¶èŠ‚ç‚¹ã€‚ 


å¦‚æœæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾id=12çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ©ç”¨æˆ‘ä»¬åˆ›å»ºçš„äºŒå‰æŸ¥æ‰¾æ ‘ç´¢å¼•ï¼ŒæŸ¥æ‰¾æµç¨‹å¦‚ä¸‹ï¼š 

1. å°†æ ¹èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹ï¼ŒæŠŠ12ä¸å½“å‰èŠ‚ç‚¹çš„é”®å€¼10æ¯”è¾ƒï¼Œ12å¤§äº10ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŠŠå½“å‰èŠ‚ç‚¹>çš„å³å­èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹ã€‚ 
2. ç»§ç»­æŠŠ12å’Œå½“å‰èŠ‚ç‚¹çš„é”®å€¼13æ¯”è¾ƒï¼Œå‘ç°12å°äº13ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ä½œä¸ºå½“å‰èŠ‚ç‚¹ã€‚ 
3. æŠŠ12å’Œå½“å‰èŠ‚ç‚¹çš„é”®å€¼12å¯¹æ¯”ï¼Œ12ç­‰äº12ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œæˆ‘ä»¬ä»å½“å‰èŠ‚ç‚¹ä¸­å–å‡ºdataï¼Œå³id=12,name=xmã€‚

åˆ©ç”¨äºŒå‰æŸ¥æ‰¾æ ‘æˆ‘ä»¬åªéœ€è¦3æ¬¡å³å¯æ‰¾åˆ°åŒ¹é…çš„æ•°æ®ã€‚å¦‚æœåœ¨è¡¨ä¸­ä¸€æ¡æ¡çš„æŸ¥æ‰¾çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦6æ¬¡æ‰èƒ½æ‰¾åˆ°ã€‚


## å¹³è¡¡äºŒå‰æ ‘

ä¸Šé¢æˆ‘ä»¬è®²è§£äº†åˆ©ç”¨äºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°æ•°æ®ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸Šé¢çš„äºŒå‰æŸ¥æ‰¾æ ‘æ˜¯è¿™æ ·çš„æ„é€ ï¼š

![](../images/Wohph0xohfa9.jpg)

è¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„äºŒå‰æŸ¥æ‰¾æ ‘å˜æˆäº†ä¸€ä¸ªé“¾è¡¨ã€‚

å¦‚æœæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾id=17çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾7æ¬¡ï¼Œä¹Ÿå°±ç›¸å½“äºå…¨è¡¨æ‰«æäº†ã€‚ 

å¯¼è‡´è¿™ä¸ªç°è±¡çš„åŸå› å…¶å®æ˜¯äºŒå‰æŸ¥æ‰¾æ ‘å˜å¾—ä¸å¹³è¡¡äº†ï¼Œä¹Ÿå°±æ˜¯é«˜åº¦å¤ªé«˜äº†ï¼Œä»è€Œå¯¼è‡´æŸ¥æ‰¾æ•ˆç‡çš„ä¸ç¨³å®šã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯äºŒå‰æŸ¥æ‰¾æ ‘ä¸€ç›´ä¿æŒå¹³è¡¡ï¼Œå°±éœ€è¦ç”¨åˆ°å¹³è¡¡äºŒå‰æ ‘äº†ã€‚ 


å¹³è¡¡äºŒå‰æ ‘åˆç§°AVLæ ‘ï¼Œåœ¨æ»¡è¶³äºŒå‰æŸ¥æ‰¾æ ‘ç‰¹æ€§çš„åŸºç¡€ä¸Šï¼Œè¦æ±‚æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å³å­æ ‘çš„é«˜åº¦å·®ä¸èƒ½è¶…è¿‡1ã€‚ 

ä¸‹é¢æ˜¯å¹³è¡¡äºŒå‰æ ‘å’Œéå¹³è¡¡äºŒå‰æ ‘çš„å¯¹æ¯”ï¼š

![](../images/Shu2ohcohb4j.jpg)


ç”±å¹³è¡¡äºŒå‰æ ‘çš„æ„é€ æˆ‘ä»¬å¯ä»¥å‘ç°ç¬¬ä¸€å¼ å›¾ä¸­çš„äºŒå‰æ ‘å…¶å®å°±æ˜¯ä¸€æ£µå¹³è¡¡äºŒå‰æ ‘ã€‚

å¹³è¡¡äºŒå‰æ ‘ä¿è¯äº†æ ‘çš„æ„é€ æ˜¯å¹³è¡¡çš„ï¼Œå½“æˆ‘ä»¬æ’å…¥æˆ–åˆ é™¤æ•°æ®å¯¼è‡´ä¸æ»¡è¶³å¹³è¡¡äºŒå‰æ ‘ä¸å¹³è¡¡æ—¶ï¼Œå¹³è¡¡äºŒå‰æ ‘ä¼šè¿›è¡Œè°ƒæ•´æ ‘ä¸Šçš„èŠ‚ç‚¹æ¥ä¿æŒå¹³è¡¡ã€‚å…·ä½“çš„è°ƒæ•´æ–¹å¼è¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚

å¹³è¡¡äºŒå‰æ ‘ç›¸æ¯”äºäºŒå‰æŸ¥æ‰¾æ ‘æ¥è¯´ï¼ŒæŸ¥æ‰¾æ•ˆç‡æ›´ç¨³å®šï¼Œæ€»ä½“çš„æŸ¥æ‰¾é€Ÿåº¦ä¹Ÿæ›´å¿«ã€‚


## Bæ ‘

å› ä¸ºå†…å­˜çš„æ˜“å¤±æ€§ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šé€‰æ‹©å°†userè¡¨ä¸­çš„æ•°æ®å’Œç´¢å¼•å­˜å‚¨åœ¨ç£ç›˜è¿™ç§å¤–å›´è®¾å¤‡ä¸­ã€‚

ä½†æ˜¯å’Œå†…å­˜ç›¸æ¯”ï¼Œä»ç£ç›˜ä¸­è¯»å–æ•°æ®çš„é€Ÿåº¦ä¼šæ…¢ä¸Šç™¾å€åƒå€ç”šè‡³ä¸‡å€ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åº”å½“å°½é‡å‡å°‘ä»ç£ç›˜ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•°ã€‚ å¦å¤–ï¼Œä»ç£ç›˜ä¸­è¯»å–æ•°æ®æ—¶ï¼Œéƒ½æ˜¯æŒ‰ç…§ç£ç›˜å—æ¥è¯»å–çš„ï¼Œå¹¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡çš„è¯»ã€‚ 

å¦‚æœæˆ‘ä»¬èƒ½æŠŠå°½é‡å¤šçš„æ•°æ®æ”¾è¿›ç£ç›˜å—ä¸­ï¼Œé‚£ä¸€æ¬¡ç£ç›˜è¯»å–æ“ä½œå°±ä¼šè¯»å–æ›´å¤šæ•°æ®ï¼Œé‚£æˆ‘ä»¬æŸ¥æ‰¾æ•°æ®çš„æ—¶é—´ä¹Ÿä¼šå¤§å¹…åº¦é™ä½ã€‚ 

å¦‚æœæˆ‘ä»¬ç”¨æ ‘è¿™ç§æ•°æ®ç»“æ„ä½œä¸ºç´¢å¼•çš„æ•°æ®ç»“æ„ï¼Œé‚£æˆ‘ä»¬æ¯æŸ¥æ‰¾ä¸€æ¬¡æ•°æ®å°±éœ€è¦ä»ç£ç›˜ä¸­è¯»å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ä¸€ä¸ªç£ç›˜å—ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¹³è¡¡äºŒå‰æ ‘å¯æ˜¯æ¯ä¸ªèŠ‚ç‚¹åªå­˜å‚¨ä¸€ä¸ªé”®å€¼å’Œæ•°æ®çš„ã€‚

é‚£è¯´æ˜ä»€ä¹ˆï¼Ÿ

è¯´æ˜æ¯ä¸ªç£ç›˜å—ä»…ä»…å­˜å‚¨ä¸€ä¸ªé”®å€¼å’Œæ•°æ®ï¼

é‚£å¦‚æœæˆ‘ä»¬è¦å­˜å‚¨æµ·é‡çš„æ•°æ®å‘¢ï¼Ÿ

å¯ä»¥æƒ³è±¡åˆ°äºŒå‰æ ‘çš„èŠ‚ç‚¹å°†ä¼šéå¸¸å¤šï¼Œé«˜åº¦ä¹Ÿä¼šåŠå…¶é«˜ï¼Œæˆ‘ä»¬æŸ¥æ‰¾æ•°æ®æ—¶ä¹Ÿä¼šè¿›è¡Œå¾ˆå¤šæ¬¡ç£ç›˜IOï¼Œæˆ‘ä»¬æŸ¥æ‰¾æ•°æ®çš„æ•ˆç‡å°†ä¼šæä½ï¼

![](../images/ahwu4aihuo1H.jpg)

ä¸ºäº†è§£å†³å¹³è¡¡äºŒå‰æ ‘çš„è¿™ä¸ªå¼Šç«¯ï¼Œæˆ‘ä»¬åº”è¯¥å¯»æ‰¾ä¸€ç§å•ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨å¤šä¸ªé”®å€¼å’Œæ•°æ®çš„å¹³è¡¡æ ‘ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è¯´çš„Bæ ‘ã€‚ 

Bæ ‘ï¼ˆBalance Treeï¼‰å³ä¸ºå¹³è¡¡æ ‘çš„æ„æ€ï¼Œä¸‹å›¾å³æ˜¯ä¸€é¢—Bæ ‘ã€‚

![](../images/iey3Weim7thu.jpg)

å›¾ä¸­çš„pèŠ‚ç‚¹ä¸ºæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼ŒäºŒå‰æŸ¥æ‰¾æ ‘å’Œå¹³è¡¡äºŒå‰æ ‘å…¶å®ä¹Ÿæœ‰ï¼Œå› ä¸ºå›¾çš„ç¾è§‚æ€§ï¼Œè¢«çœç•¥äº†ã€‚- å›¾ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ç§°ä¸ºé¡µï¼Œé¡µå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„ç£ç›˜å—ï¼Œåœ¨mysqlä¸­æ•°æ®è¯»å–çš„åŸºæœ¬å•ä½éƒ½æ˜¯é¡µï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå«åšé¡µæ›´ç¬¦åˆmysqlä¸­ç´¢å¼•çš„åº•å±‚æ•°æ®ç»“æ„ã€‚

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒBæ ‘ç›¸å¯¹äºå¹³è¡¡äºŒå‰æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨äº†æ›´å¤šçš„é”®å€¼(key)å’Œæ•°æ®(data)ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹æ‹¥æœ‰æ›´å¤šçš„å­èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹çš„ä¸ªæ•°ä¸€èˆ¬ç§°ä¸ºé˜¶ï¼Œä¸Šè¿°å›¾ä¸­çš„Bæ ‘ä¸º3é˜¶Bæ ‘ï¼Œé«˜åº¦ä¹Ÿä¼šå¾ˆä½ã€‚ 
åŸºäºè¿™ä¸ªç‰¹æ€§ï¼ŒBæ ‘æŸ¥æ‰¾æ•°æ®è¯»å–ç£ç›˜çš„æ¬¡æ•°å°†ä¼šå¾ˆå°‘ï¼Œæ•°æ®çš„æŸ¥æ‰¾æ•ˆç‡ä¹Ÿä¼šæ¯”å¹³è¡¡äºŒå‰æ ‘é«˜å¾ˆå¤šã€‚ 

å‡å¦‚æˆ‘ä»¬è¦æŸ¥æ‰¾id=28çš„ç”¨æˆ·ä¿¡æ¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ä¸Šå›¾Bæ ‘ä¸­æŸ¥æ‰¾çš„æµç¨‹å¦‚ä¸‹ï¼š 

1. å…ˆæ‰¾åˆ°æ ¹èŠ‚ç‚¹ä¹Ÿå°±æ˜¯é¡µ1ï¼Œåˆ¤æ–­28åœ¨é”®å€¼17å’Œ35ä¹‹é—´ï¼Œæˆ‘ä»¬é‚£ä¹ˆæˆ‘ä»¬æ ¹æ®é¡µ1ä¸­çš„æŒ‡é’ˆp2æ‰¾åˆ°é¡µ3ã€‚ 
2. å°†28å’Œé¡µ3ä¸­çš„é”®å€¼ç›¸æ¯”è¾ƒï¼Œ28åœ¨26å’Œ30ä¹‹é—´ï¼Œæˆ‘ä»¬æ ¹æ®é¡µ3ä¸­çš„æŒ‡é’ˆp2æ‰¾åˆ°é¡µ8ã€‚ 
3. å°†28å’Œé¡µ8ä¸­çš„é”®å€¼ç›¸æ¯”è¾ƒï¼Œå‘ç°æœ‰åŒ¹é…çš„é”®å€¼28ï¼Œé”®å€¼28å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ä¸º(28,bv)ã€‚

## B+æ ‘

B+æ ‘æ˜¯å¯¹Bæ ‘çš„è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹B+æ ‘çš„ç»“æ„å›¾ï¼š

![](../images/deiGoh6JiePh.webp)

æ ¹æ®ä¸Šå›¾æˆ‘ä»¬æ¥çœ‹ä¸‹B+æ ‘å’ŒBæ ‘æœ‰ä»€ä¹ˆä¸åŒã€‚ 

1. B+æ ‘éå¶å­èŠ‚ç‚¹ä¸Šæ˜¯ä¸å­˜å‚¨æ•°æ®çš„ï¼Œä»…å­˜å‚¨é”®å€¼ï¼Œè€ŒBæ ‘èŠ‚ç‚¹ä¸­ä¸ä»…å­˜å‚¨é”®å€¼ï¼Œä¹Ÿä¼šå­˜å‚¨æ•°æ®ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆåšæ˜¯å› ä¸ºåœ¨æ•°æ®åº“ä¸­é¡µçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œinnodbä¸­é¡µçš„é»˜è®¤å¤§å°æ˜¯16KBã€‚å¦‚æœä¸å­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šå­˜å‚¨æ›´å¤šçš„é”®å€¼ï¼Œç›¸åº”çš„æ ‘çš„é˜¶æ•°ï¼ˆèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ ‘ï¼‰å°±ä¼šæ›´å¤§ï¼Œæ ‘å°±ä¼šæ›´çŸ®æ›´èƒ–ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬æŸ¥æ‰¾æ•°æ®è¿›è¡Œç£ç›˜çš„IOæ¬¡æ•°æœ‰ä¼šå†æ¬¡å‡å°‘ï¼Œæ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ä¹Ÿä¼šæ›´å¿«ã€‚å¦å¤–ï¼ŒB+æ ‘çš„é˜¶æ•°æ˜¯ç­‰äºé”®å€¼çš„æ•°é‡çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„B+æ ‘ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨1000ä¸ªé”®å€¼ï¼Œé‚£ä¹ˆ3å±‚B+æ ‘å¯ä»¥å­˜å‚¨1000Ã—1000Ã—1000=10äº¿ä¸ªæ•°æ®ã€‚ä¸€èˆ¬æ ¹èŠ‚ç‚¹æ˜¯å¸¸é©»å†…å­˜çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬æŸ¥æ‰¾10äº¿æ•°æ®ï¼Œåªéœ€è¦2æ¬¡ç£ç›˜IOã€‚ 
2. å› ä¸ºB+æ ‘ç´¢å¼•çš„æ‰€æœ‰æ•°æ®å‡å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€Œä¸”æ•°æ®æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„ã€‚é‚£ä¹ˆB+æ ‘ä½¿å¾—èŒƒå›´æŸ¥æ‰¾ï¼Œæ’åºæŸ¥æ‰¾ï¼Œåˆ†ç»„æŸ¥æ‰¾ä»¥åŠå»é‡æŸ¥æ‰¾å˜å¾—å¼‚å¸¸ç®€å•ã€‚è€ŒBæ ‘å› ä¸ºæ•°æ®åˆ†æ•£åœ¨å„ä¸ªèŠ‚ç‚¹ï¼Œè¦å®ç°è¿™ä¸€ç‚¹æ˜¯å¾ˆä¸å®¹æ˜“çš„ã€‚  

æœ‰å¿ƒçš„è¯»è€…å¯èƒ½è¿˜å‘ç°ä¸Šå›¾B+æ ‘ä¸­å„ä¸ªé¡µä¹‹é—´æ˜¯é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥çš„ï¼Œå¶å­èŠ‚ç‚¹ä¸­çš„æ•°æ®æ˜¯é€šè¿‡å•å‘é“¾è¡¨è¿æ¥çš„ã€‚
å…¶å®ä¸Šé¢çš„Bæ ‘æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å„ä¸ªèŠ‚ç‚¹åŠ ä¸Šé“¾è¡¨ã€‚å…¶å®è¿™äº›ä¸æ˜¯å®ƒä»¬ä¹‹å‰çš„åŒºåˆ«ï¼Œæ˜¯å› ä¸ºåœ¨mysqlçš„innodbå­˜å‚¨å¼•æ“ä¸­ï¼Œç´¢å¼•å°±æ˜¯è¿™æ ·å­˜å‚¨çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šå›¾ä¸­çš„B+æ ‘ç´¢å¼•å°±æ˜¯innodbä¸­B+æ ‘ç´¢å¼•çœŸæ­£çš„å®ç°æ–¹å¼ï¼Œå‡†ç¡®çš„è¯´åº”è¯¥æ˜¯èšé›†ç´¢å¼•ï¼ˆèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•ä¸‹é¢ä¼šè®²åˆ°ï¼‰ã€‚
é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œåœ¨innodbä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ•°æ®é¡µä¹‹é—´é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥ä»¥åŠå¶å­èŠ‚ç‚¹ä¸­æ•°æ®ä¹‹é—´é€šè¿‡å•å‘é“¾è¡¨è¿æ¥çš„æ–¹å¼å¯ä»¥æ‰¾åˆ°è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®ã€‚
MyISAMä¸­çš„B+æ ‘ç´¢å¼•å®ç°ä¸innodbä¸­çš„ç•¥æœ‰ä¸åŒã€‚åœ¨MyISAMä¸­ï¼ŒB+æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯å­˜å‚¨æ•°æ®çš„æ–‡ä»¶åœ°å€ã€‚

## èšé›†ç´¢å¼• VS éèšé›†ç´¢å¼•

åœ¨ä¸ŠèŠ‚ä»‹ç»B+æ ‘ç´¢å¼•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°äº†å›¾ä¸­çš„ç´¢å¼•å…¶å®æ˜¯èšé›†ç´¢å¼•çš„å®ç°æ–¹å¼ã€‚é‚£ä»€ä¹ˆæ˜¯èšé›†ç´¢å¼•å‘¢ï¼Ÿ
åœ¨MySQLä¸­ï¼ŒB+æ ‘ç´¢å¼•æŒ‰ç…§å­˜å‚¨æ–¹å¼çš„ä¸åŒåˆ†ä¸ºèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•ã€‚
è¿™é‡Œæˆ‘ä»¬ç€é‡ä»‹ç»innodbä¸­çš„èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•ã€‚

1. èšé›†ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰ï¼šä»¥innodbä½œä¸ºå­˜å‚¨å¼•æ“çš„è¡¨ï¼Œè¡¨ä¸­çš„æ•°æ®éƒ½ä¼šæœ‰ä¸€ä¸ªä¸»é”®ï¼Œå³ä½¿ä½ ä¸åˆ›å»ºä¸»é”®ï¼Œç³»ç»Ÿä¹Ÿä¼šå¸®ä½ åˆ›å»ºä¸€ä¸ªéšå¼çš„ä¸»é”®ã€‚è¿™æ˜¯å› ä¸ºinnodbæ˜¯æŠŠæ•°æ®å­˜æ”¾åœ¨B+æ ‘ä¸­çš„ï¼Œè€ŒB+æ ‘çš„é”®å€¼å°±æ˜¯ä¸»é”®ï¼Œåœ¨B+æ ‘çš„å¶å­èŠ‚ç‚¹ä¸­ï¼Œå­˜å‚¨äº†è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®ã€‚è¿™ç§ä»¥ä¸»é”®ä½œä¸ºB+æ ‘ç´¢å¼•çš„é”®å€¼è€Œæ„å»ºçš„B+æ ‘ç´¢å¼•ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºèšé›†ç´¢å¼•ã€‚ 
2. éèšé›†ç´¢å¼•ï¼ˆéèšç°‡ç´¢å¼•ï¼‰ï¼šä»¥ä¸»é”®ä»¥å¤–çš„åˆ—å€¼ä½œä¸ºé”®å€¼æ„å»ºçš„B+æ ‘ç´¢å¼•ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºéèšé›†ç´¢å¼•ã€‚éèšé›†ç´¢å¼•ä¸èšé›†ç´¢å¼•çš„åŒºåˆ«åœ¨äºéèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸å­˜å‚¨è¡¨ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯å­˜å‚¨è¯¥åˆ—å¯¹åº”çš„ä¸»é”®ï¼Œæƒ³è¦æŸ¥æ‰¾æ•°æ®æˆ‘ä»¬è¿˜éœ€è¦æ ¹æ®ä¸»é”®å†å»èšé›†ç´¢å¼•ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œè¿™ä¸ªå†æ ¹æ®èšé›†ç´¢å¼•æŸ¥æ‰¾æ•°æ®çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¸ºå›è¡¨ã€‚  

æ˜ç™½äº†èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„å®šä¹‰ï¼Œæˆ‘ä»¬åº”è¯¥æ˜ç™½è¿™æ ·ä¸€å¥è¯ï¼šæ•°æ®å³ç´¢å¼•ï¼Œç´¢å¼•å³æ•°æ®ã€‚

### åˆ©ç”¨èšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•æŸ¥æ‰¾æ•°æ®

å‰é¢æˆ‘ä»¬è®²è§£B+æ ‘ç´¢å¼•çš„æ—¶å€™å¹¶æ²¡æœ‰å»è¯´æ€ä¹ˆåœ¨B+æ ‘ä¸­è¿›è¡Œæ•°æ®çš„æŸ¥æ‰¾ï¼Œä¸»è¦å°±æ˜¯å› ä¸ºè¿˜æ²¡æœ‰å¼•å‡ºèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„æ¦‚å¿µã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡è®²è§£å¦‚ä½•é€šè¿‡èšé›†ç´¢å¼•ä»¥åŠéèšé›†ç´¢å¼•æŸ¥æ‰¾æ•°æ®è¡¨ä¸­æ•°æ®çš„æ–¹å¼ä»‹ç»ä¸€ä¸‹B+æ ‘ç´¢å¼•æŸ¥æ‰¾æ•°æ®æ–¹æ³•ã€‚
åˆ©ç”¨èšé›†ç´¢å¼•æŸ¥æ‰¾æ•°æ®

![](../images/zaTh5uayeeT1.webp)

è¿˜æ˜¯è¿™å¼ B+æ ‘ç´¢å¼•å›¾ï¼Œç°åœ¨æˆ‘ä»¬åº”è¯¥çŸ¥é“è¿™å°±æ˜¯èšé›†ç´¢å¼•ï¼Œè¡¨ä¸­çš„æ•°æ®å­˜å‚¨åœ¨å…¶ä¸­ã€‚ç°åœ¨å‡è®¾æˆ‘ä»¬è¦æŸ¥æ‰¾id>=18å¹¶ä¸”id<40çš„ç”¨æˆ·æ•°æ®ã€‚å¯¹åº”çš„sqlè¯­å¥ä¸ºselect * from user where id>=18 and id <40ï¼Œå…¶ä¸­idä¸ºä¸»é”®ã€‚å…·ä½“çš„æŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. ä¸€èˆ¬æ ¹èŠ‚ç‚¹éƒ½æ˜¯å¸¸é©»å†…å­˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µ1å·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œæ­¤æ—¶ä¸éœ€è¦åˆ°ç£ç›˜ä¸­è¯»å–æ•°æ®ï¼Œç›´æ¥ä»å†…å­˜ä¸­è¯»å–å³å¯ã€‚
    ä»å†…å­˜ä¸­è¯»å–åˆ°é¡µ1ï¼Œè¦æŸ¥æ‰¾è¿™ä¸ªid>=18 and id <40æˆ–è€…èŒƒå›´å€¼ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ‰¾åˆ°id=18çš„é”®å€¼ã€‚
    ä»é¡µ1ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°é”®å€¼18ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ ¹æ®æŒ‡é’ˆp2ï¼Œå®šä½åˆ°é¡µ3ã€‚

2. è¦ä»é¡µ3ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‹¿ç€p2æŒ‡é’ˆå»ç£ç›˜ä¸­è¿›è¡Œè¯»å–é¡µ3ã€‚
    ä»ç£ç›˜ä¸­è¯»å–é¡µ3åå°†é¡µ3æ”¾å…¥å†…å­˜ä¸­ï¼Œç„¶åè¿›è¡ŒæŸ¥æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°é”®å€¼18ï¼Œç„¶åå†æ‹¿åˆ°é¡µ3ä¸­çš„æŒ‡é’ˆp1ï¼Œå®šä½åˆ°é¡µ8ã€‚

3. åŒæ ·çš„é¡µ8é¡µä¸åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å†å»ç£ç›˜ä¸­å°†é¡µ8è¯»å–åˆ°å†…å­˜ä¸­ã€‚
    å°†é¡µ8è¯»å–åˆ°å†…å­˜ä¸­åã€‚å› ä¸ºé¡µä¸­çš„æ•°æ®æ˜¯é“¾è¡¨è¿›è¡Œè¿æ¥çš„ï¼Œè€Œä¸”é”®å€¼æ˜¯æŒ‰ç…§é¡ºåºå­˜æ”¾çš„ï¼Œæ­¤æ—¶å¯ä»¥æ ¹æ®äºŒåˆ†æŸ¥æ‰¾æ³•å®šä½åˆ°é”®å€¼18ã€‚
    æ­¤æ—¶å› ä¸ºå·²ç»åˆ°æ•°æ®é¡µäº†ï¼Œæ­¤æ—¶æˆ‘ä»¬å·²ç»æ‰¾åˆ°ä¸€æ¡æ»¡è¶³æ¡ä»¶çš„æ•°æ®äº†ï¼Œå°±æ˜¯é”®å€¼18å¯¹åº”çš„æ•°æ®ã€‚
    å› ä¸ºæ˜¯èŒƒå›´æŸ¥æ‰¾ï¼Œè€Œä¸”æ­¤æ—¶æ‰€æœ‰çš„æ•°æ®åˆéƒ½å­˜åœ¨å¶å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹é¡µ8ä¸­çš„é”®å€¼ä¾æ¬¡è¿›è¡Œéå†æŸ¥æ‰¾å¹¶åŒ¹é…æ»¡è¶³æ¡ä»¶çš„æ•°æ®ã€‚
    æˆ‘ä»¬å¯ä»¥ä¸€ç›´æ‰¾åˆ°é”®å€¼ä¸º22çš„æ•°æ®ï¼Œç„¶åé¡µ8ä¸­å°±æ²¡æœ‰æ•°æ®äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ‹¿ç€é¡µ8ä¸­çš„pæŒ‡é’ˆå»è¯»å–é¡µ9ä¸­çš„æ•°æ®ã€‚

4. å› ä¸ºé¡µ9ä¸åœ¨å†…å­˜ä¸­ï¼Œå°±åˆä¼šåŠ è½½é¡µ9åˆ°å†…å­˜ä¸­ï¼Œå¹¶é€šè¿‡å’Œé¡µ8ä¸­ä¸€æ ·çš„æ–¹å¼è¿›è¡Œæ•°æ®çš„æŸ¥æ‰¾ï¼Œç›´åˆ°å°†é¡µ12åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå‘ç°41å¤§äº40ï¼Œæ­¤æ—¶ä¸æ»¡è¶³æ¡ä»¶ã€‚é‚£ä¹ˆæŸ¥æ‰¾åˆ°æ­¤ç»ˆæ­¢ã€‚
    æœ€ç»ˆæˆ‘ä»¬æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰æ•°æ®ä¸ºï¼š`(18,kl),(19,kl),(22,hj),(24,io),(25,vg),(29,jk),(31,jk),(33,rt),(34,ty),(35,yu),(37,rt),(39,rt)` æ€»å…±12æ¡è®°å½•ã€‚


ä¸‹é¢çœ‹ä¸‹å…·ä½“çš„æŸ¥æ‰¾æµç¨‹å›¾ï¼š

![](../images/ieHie2ur2ooh.webp)

åˆ©ç”¨éèšé›†ç´¢å¼•æŸ¥æ‰¾æ•°æ®

![](../images/FiaChoSij8ej.webp)

è¯»è€…çœ‹åˆ°è¿™å¼ å›¾çš„æ—¶å€™å¯èƒ½ä¼šè’™ï¼Œè¿™æ˜¯å•¥ä¸œè¥¿å•Šï¼Ÿæ€ä¹ˆéƒ½æ˜¯æ•°å­—ã€‚
å¦‚æœæœ‰è¿™ç§æ„Ÿè§‰ï¼Œè¯·ä»”ç»†çœ‹ä¸‹å›¾ä¸­çº¢å­—çš„è§£é‡Šã€‚ä»€ä¹ˆï¼Ÿè¿˜çœ‹ä¸æ‡‚ï¼Ÿé‚£æˆ‘å†æ¥è§£é‡Šä¸‹å§ã€‚é¦–å…ˆï¼Œè¿™ä¸ªéèšé›†ç´¢å¼•è¡¨ç¤ºçš„æ˜¯ç”¨æˆ·å¹¸è¿æ•°å­—çš„ç´¢å¼•ï¼ˆä¸ºä»€ä¹ˆæ˜¯å¹¸è¿æ•°å­—ï¼Ÿä¸€æ—¶å…´èµ·æƒ³èµ·æ¥çš„:-)ï¼‰ï¼Œæ­¤æ—¶è¡¨ç»“æ„æ˜¯è¿™æ ·çš„ã€‚

|id	|name|	luckyNum|
|----|----|----|
1|	zs|	23
2|	ls|	7

åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼Œä¸åœ¨å­˜å‚¨æ‰€æœ‰çš„æ•°æ®äº†ï¼Œå­˜å‚¨çš„æ˜¯é”®å€¼å’Œä¸»é”®ã€‚

å¯¹äºå¶å­èŠ‚ç‚¹ä¸­çš„x-yï¼Œæ¯”å¦‚1-1ã€‚å·¦è¾¹çš„1è¡¨ç¤ºçš„æ˜¯ç´¢å¼•çš„é”®å€¼ï¼Œå³è¾¹çš„1è¡¨ç¤ºçš„æ˜¯ä¸»é”®å€¼ã€‚å¦‚æœæˆ‘ä»¬è¦æ‰¾åˆ°å¹¸è¿æ•°å­—ä¸º33çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¯¹åº”çš„sqlè¯­å¥ä¸ºselect * from user where luckNum=33ã€‚

æŸ¥æ‰¾çš„æµç¨‹è·Ÿèšé›†ç´¢å¼•ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚æˆ‘ä»¬æœ€ç»ˆä¼šæ‰¾åˆ°ä¸»é”®å€¼47ï¼Œæ‰¾åˆ°ä¸»é”®åæˆ‘ä»¬éœ€è¦å†åˆ°èšé›†ç´¢å¼•ä¸­æŸ¥æ‰¾å…·ä½“å¯¹åº”çš„æ•°æ®ä¿¡æ¯ï¼Œæ­¤æ—¶åˆå›åˆ°äº†èšé›†ç´¢å¼•çš„æŸ¥æ‰¾æµç¨‹ã€‚  

ä¸‹é¢çœ‹ä¸‹å…·ä½“çš„æŸ¥æ‰¾æµç¨‹å›¾ï¼š

![](../images/giethaD1Eice.webp)

åœ¨MyISAMä¸­ï¼Œèšé›†ç´¢å¼•å’Œéèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨æ•°æ®çš„æ–‡ä»¶åœ°å€ã€‚

## æ€»ç»“

æœ¬ç¯‡æ–‡ä»äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œè¯¦ç»†è¯´æ˜äº†ä¸ºä»€ä¹ˆmysqlç”¨B+æ ‘ä½œä¸ºæ•°æ®çš„ç´¢å¼•ï¼Œä»¥åŠåœ¨innodbä¸­æ•°æ®åº“å¦‚ä½•é€šè¿‡B+æ ‘ç´¢å¼•æ¥å­˜å‚¨æ•°æ®ä»¥åŠæŸ¥æ‰¾æ•°æ®ã€‚æˆ‘ä»¬ä¸€å®šè¦è®°ä½è¿™å¥è¯ï¼šæ•°æ®å³ç´¢å¼•ï¼Œç´¢å¼•å³æ•°æ®ã€‚

> åŸæ–‡ï¼š [å†æœ‰äººé—®ä½ ä¸ºä»€ä¹ˆMySQLç”¨B+æ ‘åšç´¢å¼•ï¼Œå°±æŠŠè¿™ç¯‡æ–‡ç« å‘ç»™å¥¹](https://mp.weixin.qq.com/s?__biz=MzIwOTE2MzU4NA==&mid=2247484085&idx=1&sn=92639430ac7ef3e412b550a09bde0115&chksm=9779469aa00ecf8c157e899fe0d5c5b060b282a4e5f2f2f63c187eb3c04d04ef6fad7a1e09e3&token=472896045&lang=zh_CN#rd)
















# MySQLæ•°æ®åº“ç»å…¸é¢è¯•é¢˜è§£æ

## 1. MySQL ç´¢å¼•ä½¿ç”¨æœ‰å“ªäº›æ³¨æ„äº‹é¡¹å‘¢ï¼Ÿ

å¯ä»¥ä»ä¸‰ä¸ªç»´åº¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼šç´¢å¼•å“ªäº›æƒ…å†µä¼šå¤±æ•ˆï¼Œç´¢å¼•ä¸é€‚åˆå“ªäº›åœºæ™¯ï¼Œç´¢å¼•è§„åˆ™

### ç´¢å¼•å“ªäº›æƒ…å†µä¼šå¤±æ•ˆ

- æŸ¥è¯¢æ¡ä»¶åŒ…å«orï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
- å¦‚ä½•å­—æ®µç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œwhereæ—¶ä¸€å®šç”¨å¼•å·æ‹¬èµ·æ¥ï¼Œå¦åˆ™ç´¢å¼•å¤±æ•ˆ
- likeé€šé…ç¬¦å¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- è”åˆç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶çš„æ¡ä»¶åˆ—ä¸æ˜¯è”åˆç´¢å¼•ä¸­çš„ç¬¬ä¸€ä¸ªåˆ—ï¼Œç´¢å¼•å¤±æ•ˆã€‚
- åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨mysqlçš„å†…ç½®å‡½æ•°ï¼Œç´¢å¼•å¤±æ•ˆã€‚
- å¯¹ç´¢å¼•åˆ—è¿ç®—ï¼ˆå¦‚ï¼Œ+ã€-ã€*ã€/ï¼‰ï¼Œç´¢å¼•å¤±æ•ˆã€‚
- ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨ï¼ˆï¼= æˆ–è€… < >ï¼Œnot inï¼‰æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨is nullï¼Œ is not nullï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- å·¦è¿æ¥æŸ¥è¯¢æˆ–è€…å³è¿æ¥æŸ¥è¯¢æŸ¥è¯¢å…³è”çš„å­—æ®µç¼–ç æ ¼å¼ä¸ä¸€æ ·ï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- mysqlä¼°è®¡ä½¿ç”¨å…¨è¡¨æ‰«æè¦æ¯”ä½¿ç”¨ç´¢å¼•å¿«,åˆ™ä¸ä½¿ç”¨ç´¢å¼•ã€‚

### ç´¢å¼•ä¸é€‚åˆå“ªäº›åœºæ™¯

- æ•°æ®é‡å°‘çš„ä¸é€‚åˆåŠ ç´¢å¼•
- æ›´æ–°æ¯”è¾ƒé¢‘ç¹çš„ä¹Ÿä¸é€‚åˆåŠ ç´¢å¼•
- åŒºåˆ†åº¦ä½çš„å­—æ®µä¸é€‚åˆåŠ ç´¢å¼•ï¼ˆå¦‚æ€§åˆ«ï¼‰

### ç´¢å¼•çš„ä¸€äº›æ½œè§„åˆ™

- è¦†ç›–ç´¢å¼•
- å›è¡¨
- ç´¢å¼•æ•°æ®ç»“æ„ï¼ˆB+æ ‘ï¼‰
- æœ€å·¦å‰ç¼€åŸåˆ™
- ç´¢å¼•ä¸‹æ¨

## 2. MySQL é‡åˆ°è¿‡æ­»é”é—®é¢˜å—ï¼Œä½ æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ

æˆ‘æ’æŸ¥æ­»é”çš„ä¸€èˆ¬æ­¥éª¤æ˜¯é…±ç´«çš„ï¼š

- æŸ¥çœ‹æ­»é”æ—¥å¿—show engine innodb status;
- æ‰¾å‡ºæ­»é”Sql
- åˆ†æsqlåŠ é”æƒ…å†µ
- æ¨¡æ‹Ÿæ­»é”æ¡ˆå‘
- åˆ†ææ­»é”æ—¥å¿—
- åˆ†ææ­»é”ç»“æœ

## 3. æ—¥å¸¸å·¥ä½œä¸­ä½ æ˜¯æ€ä¹ˆä¼˜åŒ–SQLçš„ï¼Ÿ

å¯ä»¥ä»è¿™å‡ ä¸ªç»´åº¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼š

- åŠ ç´¢å¼•
- é¿å…è¿”å›ä¸å¿…è¦çš„æ•°æ®
- é€‚å½“åˆ†æ‰¹é‡è¿›è¡Œ
- ä¼˜åŒ–sqlç»“æ„
- åˆ†åº“åˆ†è¡¨
- è¯»å†™åˆ†ç¦»

## 4. è¯´è¯´åˆ†åº“ä¸åˆ†è¡¨çš„è®¾è®¡

åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆï¼Œåˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼Œåˆ†åº“åˆ†è¡¨å¯èƒ½é‡åˆ°çš„é—®é¢˜

### åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ:

- æ°´å¹³åˆ†åº“ï¼šä»¥å­—æ®µä¸ºä¾æ®ï¼ŒæŒ‰ç…§ä¸€å®šç­–ç•¥ï¼ˆhashã€rangeç­‰ï¼‰ï¼Œå°†ä¸€ä¸ªåº“ä¸­çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªåº“ä¸­ã€‚
- æ°´å¹³åˆ†è¡¨ï¼šä»¥å­—æ®µä¸ºä¾æ®ï¼ŒæŒ‰ç…§ä¸€å®šç­–ç•¥ï¼ˆhashã€rangeç­‰ï¼‰ï¼Œå°†ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®æ‹†åˆ†åˆ°å¤šä¸ªè¡¨ä¸­ã€‚
- å‚ç›´åˆ†åº“ï¼šä»¥è¡¨ä¸ºä¾æ®ï¼ŒæŒ‰ç…§ä¸šåŠ¡å½’å±ä¸åŒï¼Œå°†ä¸åŒçš„è¡¨æ‹†åˆ†åˆ°ä¸åŒçš„åº“ä¸­ã€‚
- å‚ç›´åˆ†è¡¨ï¼šä»¥å­—æ®µä¸ºä¾æ®ï¼ŒæŒ‰ç…§å­—æ®µçš„æ´»è·ƒæ€§ï¼Œå°†è¡¨ä¸­å­—æ®µæ‹†åˆ°ä¸åŒçš„è¡¨ï¼ˆä¸»è¡¨å’Œæ‰©å±•è¡¨ï¼‰ä¸­ã€‚

### å¸¸ç”¨çš„åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼š

- sharding-jdbcï¼ˆå½“å½“ï¼‰
- Mycat
- TDDLï¼ˆæ·˜å®ï¼‰
- Oceanus(58åŒåŸæ•°æ®åº“ä¸­é—´ä»¶)
- vitessï¼ˆè°·æ­Œå¼€å‘çš„æ•°æ®åº“ä¸­é—´ä»¶ï¼‰
- Atlas(Qihoo 360)

### åˆ†åº“åˆ†è¡¨å¯èƒ½é‡åˆ°çš„é—®é¢˜

- äº‹åŠ¡é—®é¢˜ï¼šéœ€è¦ç”¨åˆ†å¸ƒå¼äº‹åŠ¡å•¦
- è·¨èŠ‚ç‚¹Joinçš„é—®é¢˜ï¼šè§£å†³è¿™ä¸€é—®é¢˜å¯ä»¥åˆ†ä¸¤æ¬¡æŸ¥è¯¢å®ç°
- è·¨èŠ‚ç‚¹çš„count,order by,group byä»¥åŠèšåˆå‡½æ•°é—®é¢˜ï¼šåˆ†åˆ«åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šå¾—åˆ°ç»“æœååœ¨åº”ç”¨ç¨‹åºç«¯è¿›è¡Œåˆå¹¶ã€‚
- æ•°æ®è¿ç§»ï¼Œå®¹é‡è§„åˆ’ï¼Œæ‰©å®¹ç­‰é—®é¢˜
- IDé—®é¢˜ï¼šæ•°æ®åº“è¢«åˆ‡åˆ†åï¼Œä¸èƒ½å†ä¾èµ–æ•°æ®åº“è‡ªèº«çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶å•¦ï¼Œæœ€ç®€å•å¯ä»¥è€ƒè™‘UUID
- è·¨åˆ†ç‰‡çš„æ’åºåˆ†é¡µé—®é¢˜ï¼ˆåå°åŠ å¤§pagesizeå¤„ç†ï¼Ÿï¼‰

## 5. InnoDBä¸MyISAMçš„åŒºåˆ«

- InnoDBæ”¯æŒäº‹åŠ¡ï¼ŒMyISAMä¸æ”¯æŒäº‹åŠ¡
- InnoDBæ”¯æŒå¤–é”®ï¼ŒMyISAMä¸æ”¯æŒå¤–é”®
- InnoDB æ”¯æŒ MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)ï¼ŒMyISAM ä¸æ”¯æŒ
- `select count(*) from table`æ—¶ï¼ŒMyISAMæ›´å¿«ï¼Œå› ä¸ºå®ƒæœ‰ä¸€ä¸ªå˜é‡ä¿å­˜äº†æ•´ä¸ªè¡¨çš„æ€»è¡Œæ•°ï¼Œå¯ä»¥ç›´æ¥è¯»å–ï¼ŒInnoDBå°±éœ€è¦å…¨è¡¨æ‰«æã€‚
- Innodbä¸æ”¯æŒå…¨æ–‡ç´¢å¼•ï¼Œè€ŒMyISAMæ”¯æŒå…¨æ–‡ç´¢å¼•ï¼ˆ5.7ä»¥åçš„InnoDBä¹Ÿæ”¯æŒå…¨æ–‡ç´¢å¼•ï¼‰
- InnoDBæ”¯æŒè¡¨ã€è¡Œçº§é”ï¼Œè€ŒMyISAMæ”¯æŒè¡¨çº§é”ã€‚
- InnoDBè¡¨å¿…é¡»æœ‰ä¸»é”®ï¼Œè€ŒMyISAMå¯ä»¥æ²¡æœ‰ä¸»é”®
- Innodbè¡¨éœ€è¦æ›´å¤šçš„å†…å­˜å’Œå­˜å‚¨ï¼Œè€ŒMyISAMå¯è¢«å‹ç¼©ï¼Œå­˜å‚¨ç©ºé—´è¾ƒå°ï¼Œã€‚
- InnodbæŒ‰ä¸»é”®å¤§å°æœ‰åºæ’å…¥ï¼ŒMyISAMè®°å½•æ’å…¥é¡ºåºæ˜¯ï¼ŒæŒ‰è®°å½•æ’å…¥é¡ºåºä¿å­˜ã€‚
- InnoDB å­˜å‚¨å¼•æ“æä¾›äº†å…·æœ‰æäº¤ã€å›æ»šã€å´©æºƒæ¢å¤èƒ½åŠ›çš„äº‹åŠ¡å®‰å…¨ï¼Œä¸ MyISAM æ¯” InnoDB å†™çš„æ•ˆç‡å·®ä¸€äº›ï¼Œå¹¶ä¸”ä¼šå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ä»¥ä¿ç•™æ•°æ®å’Œç´¢å¼•
- InnoDB å±äºç´¢å¼•ç»„ç»‡è¡¨ï¼Œä½¿ç”¨å…±äº«è¡¨ç©ºé—´å’Œå¤šè¡¨ç©ºé—´å‚¨å­˜æ•°æ®ã€‚MyISAMç”¨`.frm`ã€`.MYD`ã€`.MTI`æ¥å‚¨å­˜è¡¨å®šä¹‰ï¼Œæ•°æ®å’Œç´¢å¼•ã€‚

## 6. æ•°æ®åº“ç´¢å¼•çš„åŸç†ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ B+æ ‘ï¼Œä¸ºä»€ä¹ˆä¸ç”¨äºŒå‰æ ‘ï¼Ÿ

å¯ä»¥ä»å‡ ä¸ªç»´åº¦å»çœ‹è¿™ä¸ªé—®é¢˜ï¼ŒæŸ¥è¯¢æ˜¯å¦å¤Ÿå¿«ï¼Œæ•ˆç‡æ˜¯å¦ç¨³å®šï¼Œå­˜å‚¨æ•°æ®å¤šå°‘ï¼Œä»¥åŠæŸ¥æ‰¾ç£ç›˜æ¬¡æ•°ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯äºŒå‰æ ‘ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯Bæ ‘ï¼Œè€Œååæ˜¯B+æ ‘å‘¢ï¼Ÿ

### ä¸ºä»€ä¹ˆä¸æ˜¯ä¸€èˆ¬äºŒå‰æ ‘ï¼Ÿ

å¦‚æœäºŒå‰æ ‘ç‰¹æ®ŠåŒ–ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œç›¸å½“äºå…¨è¡¨æ‰«æã€‚å¹³è¡¡äºŒå‰æ ‘ç›¸æ¯”äºäºŒå‰æŸ¥æ‰¾æ ‘æ¥è¯´ï¼ŒæŸ¥æ‰¾æ•ˆç‡æ›´ç¨³å®šï¼Œæ€»ä½“çš„æŸ¥æ‰¾é€Ÿåº¦ä¹Ÿæ›´å¿«ã€‚

### ä¸ºä»€ä¹ˆä¸æ˜¯å¹³è¡¡äºŒå‰æ ‘å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å†…å­˜æ¯”åœ¨ç£ç›˜çš„æ•°æ®ï¼ŒæŸ¥è¯¢æ•ˆç‡å¿«å¾—å¤šã€‚å¦‚æœæ ‘è¿™ç§æ•°æ®ç»“æ„ä½œä¸ºç´¢å¼•ï¼Œé‚£æˆ‘ä»¬æ¯æŸ¥æ‰¾ä¸€æ¬¡æ•°æ®å°±éœ€è¦ä»ç£ç›˜ä¸­è¯»å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ä¸€ä¸ªç£ç›˜å—ï¼Œä½†æ˜¯å¹³è¡¡äºŒå‰æ ‘å¯æ˜¯æ¯ä¸ªèŠ‚ç‚¹åªå­˜å‚¨ä¸€ä¸ªé”®å€¼å’Œæ•°æ®çš„ï¼Œå¦‚æœæ˜¯Bæ ‘ï¼Œå¯ä»¥å­˜å‚¨æ›´å¤šçš„èŠ‚ç‚¹æ•°æ®ï¼Œæ ‘çš„é«˜åº¦ä¹Ÿä¼šé™ä½ï¼Œå› æ­¤è¯»å–ç£ç›˜çš„æ¬¡æ•°å°±é™ä¸‹æ¥å•¦ï¼ŒæŸ¥è¯¢æ•ˆç‡å°±å¿«å•¦ã€‚

### é‚£ä¸ºä»€ä¹ˆä¸æ˜¯Bæ ‘è€Œæ˜¯B+æ ‘å‘¢ï¼Ÿ

- 1ï¼‰B+æ ‘éå¶å­èŠ‚ç‚¹ä¸Šæ˜¯ä¸å­˜å‚¨æ•°æ®çš„ï¼Œä»…å­˜å‚¨é”®å€¼ï¼Œè€ŒBæ ‘èŠ‚ç‚¹ä¸­ä¸ä»…å­˜å‚¨é”®å€¼ï¼Œä¹Ÿä¼šå­˜å‚¨æ•°æ®ã€‚innodbä¸­é¡µçš„é»˜è®¤å¤§å°æ˜¯16KBï¼Œå¦‚æœä¸å­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šå­˜å‚¨æ›´å¤šçš„é”®å€¼ï¼Œç›¸åº”çš„æ ‘çš„é˜¶æ•°ï¼ˆèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ ‘ï¼‰å°±ä¼šæ›´å¤§ï¼Œæ ‘å°±ä¼šæ›´çŸ®æ›´èƒ–ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬æŸ¥æ‰¾æ•°æ®è¿›è¡Œç£ç›˜çš„IOæ¬¡æ•°æœ‰ä¼šå†æ¬¡å‡å°‘ï¼Œæ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ä¹Ÿä¼šæ›´å¿«ã€‚
- 2ï¼‰B+æ ‘ç´¢å¼•çš„æ‰€æœ‰æ•°æ®å‡å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€Œä¸”æ•°æ®æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„ï¼Œé“¾è¡¨è¿ç€çš„ã€‚é‚£ä¹ˆB+æ ‘ä½¿å¾—èŒƒå›´æŸ¥æ‰¾ï¼Œæ’åºæŸ¥æ‰¾ï¼Œåˆ†ç»„æŸ¥æ‰¾ä»¥åŠå»é‡æŸ¥æ‰¾å˜å¾—å¼‚å¸¸ç®€å•ã€‚


## 7. èšé›†ç´¢å¼•ä¸éèšé›†ç´¢å¼•çš„åŒºåˆ«

- ä¸€ä¸ªè¡¨ä¸­åªèƒ½æ‹¥æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œè€Œéèšé›†ç´¢å¼•ä¸€ä¸ªè¡¨å¯ä»¥å­˜åœ¨å¤šä¸ªã€‚
- èšé›†ç´¢å¼•ï¼Œç´¢å¼•ä¸­é”®å€¼çš„é€»è¾‘é¡ºåºå†³å®šäº†è¡¨ä¸­ç›¸åº”è¡Œçš„ç‰©ç†é¡ºåºï¼›éèšé›†ç´¢å¼•ï¼Œç´¢å¼•ä¸­ç´¢å¼•çš„é€»è¾‘é¡ºåºä¸ç£ç›˜ä¸Šè¡Œçš„ç‰©ç†å­˜å‚¨é¡ºåºä¸åŒã€‚
- ç´¢å¼•æ˜¯é€šè¿‡äºŒå‰æ ‘çš„æ•°æ®ç»“æ„æ¥æè¿°çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£èšç°‡ç´¢å¼•ï¼šç´¢å¼•çš„å¶èŠ‚ç‚¹å°±æ˜¯æ•°æ®èŠ‚ç‚¹ã€‚è€Œéèšç°‡ç´¢å¼•çš„å¶èŠ‚ç‚¹ä»ç„¶æ˜¯ç´¢å¼•èŠ‚ç‚¹ï¼Œåªä¸è¿‡æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„æ•°æ®å—ã€‚
- èšé›†ç´¢å¼•ï¼šç‰©ç†å­˜å‚¨æŒ‰ç…§ç´¢å¼•æ’åºï¼›éèšé›†ç´¢å¼•ï¼šç‰©ç†å­˜å‚¨ä¸æŒ‰ç…§ç´¢å¼•æ’åºï¼›

ä½•æ—¶ä½¿ç”¨èšé›†ç´¢å¼•æˆ–éèšé›†ç´¢å¼•ï¼Ÿ

![](../images/172346f5e5f0ffab.jpg)


## 8. limit 1000000 åŠ è½½å¾ˆæ…¢çš„è¯ï¼Œä½ æ˜¯æ€ä¹ˆè§£å†³çš„å‘¢ï¼Ÿ

æ–¹æ¡ˆä¸€ï¼šå¦‚æœidæ˜¯è¿ç»­çš„ï¼Œå¯ä»¥è¿™æ ·ï¼Œè¿”å›ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§è®°å½•(åç§»é‡)ï¼Œå†å¾€ä¸‹limit

```sql
select idï¼Œname from employee where id>1000000 limit 10.
```

æ–¹æ¡ˆäºŒï¼šåœ¨ä¸šåŠ¡å…è®¸çš„æƒ…å†µä¸‹é™åˆ¶é¡µæ•°ï¼š

å»ºè®®è·Ÿä¸šåŠ¡è®¨è®ºï¼Œæœ‰æ²¡æœ‰å¿…è¦æŸ¥è¿™ä¹ˆåçš„åˆ†é¡µå•¦ã€‚å› ä¸ºç»å¤§å¤šæ•°ç”¨æˆ·éƒ½ä¸ä¼šå¾€åç¿»å¤ªå¤šé¡µã€‚

æ–¹æ¡ˆä¸‰ï¼šorder by + ç´¢å¼•ï¼ˆidä¸ºç´¢å¼•ï¼‰

```sql
select idï¼Œname from employee order by id  limit 1000000ï¼Œ10
```

```sql
SELECT a.* FROM employee a, (select id from employee where æ¡ä»¶ LIMIT 1000000,10 ) b where a.id=b.id
```

æ–¹æ¡ˆå››ï¼šåˆ©ç”¨å»¶è¿Ÿå…³è”æˆ–è€…å­æŸ¥è¯¢ä¼˜åŒ–è¶…å¤šåˆ†é¡µåœºæ™¯ã€‚ï¼ˆå…ˆå¿«é€Ÿå®šä½éœ€è¦è·å–çš„idæ®µï¼Œç„¶åå†å…³è”ï¼‰

## 9. å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ†å¸ƒå¼ä¸»é”®æ–¹æ¡ˆå‘¢ï¼Ÿ

- æ•°æ®åº“è‡ªå¢é•¿åºåˆ—æˆ–å­—æ®µã€‚
- UUIDã€‚
- Redisç”ŸæˆID
- Twitterçš„snowflakeç®—æ³•
- åˆ©ç”¨zookeeperç”Ÿæˆå”¯ä¸€ID
- MongoDBçš„ObjectId

## 10. äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼ŸMySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- è¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰
- è¯»å·²æäº¤ï¼ˆRead Committedï¼‰
- å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰
- ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰

Mysqlé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»(Repeatable Read)

## 11. ä»€ä¹ˆæ˜¯å¹»è¯»ï¼Œè„è¯»ï¼Œä¸å¯é‡å¤è¯»å‘¢ï¼Ÿ

- äº‹åŠ¡Aã€Bäº¤æ›¿æ‰§è¡Œï¼Œäº‹åŠ¡Aè¢«äº‹åŠ¡Bå¹²æ‰°åˆ°äº†ï¼Œå› ä¸ºäº‹åŠ¡Aè¯»å–åˆ°äº‹åŠ¡Bæœªæäº¤çš„æ•°æ®,è¿™å°±æ˜¯è„è¯»
- åœ¨ä¸€ä¸ªäº‹åŠ¡èŒƒå›´å†…ï¼Œä¸¤ä¸ªç›¸åŒçš„æŸ¥è¯¢ï¼Œè¯»å–åŒä¸€æ¡è®°å½•ï¼Œå´è¿”å›äº†ä¸åŒçš„æ•°æ®ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»ã€‚
- äº‹åŠ¡AæŸ¥è¯¢ä¸€ä¸ªèŒƒå›´çš„ç»“æœé›†ï¼Œå¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡Bå¾€è¿™ä¸ªèŒƒå›´ä¸­æ’å…¥/åˆ é™¤äº†æ•°æ®ï¼Œå¹¶é™æ‚„æ‚„åœ°æäº¤ï¼Œç„¶åäº‹åŠ¡Aå†æ¬¡æŸ¥è¯¢ç›¸åŒçš„èŒƒå›´ï¼Œä¸¤æ¬¡è¯»å–å¾—åˆ°çš„ç»“æœé›†ä¸ä¸€æ ·äº†ï¼Œè¿™å°±æ˜¯å¹»è¯»ã€‚

## 12. åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå¦‚ä½•åšåˆ°å®‰å…¨çš„ä¿®æ”¹åŒä¸€è¡Œæ•°æ®ï¼Ÿ

è¦å®‰å…¨çš„ä¿®æ”¹åŒä¸€è¡Œæ•°æ®ï¼Œå°±è¦ä¿è¯ä¸€ä¸ªçº¿ç¨‹åœ¨ä¿®æ”¹æ—¶å…¶å®ƒçº¿ç¨‹æ— æ³•æ›´æ–°è¿™è¡Œè®°å½•ã€‚ä¸€èˆ¬æœ‰æ‚²è§‚é”å’Œä¹è§‚é”ä¸¤ç§æ–¹æ¡ˆ~

### ä½¿ç”¨æ‚²è§‚é”

æ‚²è§‚é”æ€æƒ³å°±æ˜¯ï¼Œå½“å‰çº¿ç¨‹è¦è¿›æ¥ä¿®æ”¹æ•°æ®æ—¶ï¼Œåˆ«çš„çº¿ç¨‹éƒ½å¾—æ‹’ä¹‹é—¨å¤–~
æ¯”å¦‚ï¼Œå¯ä»¥ä½¿ç”¨selectâ€¦for update ~

```sql
select * from User where name=â€˜jayâ€™ for update
```

ä»¥ä¸Šè¿™æ¡sqlè¯­å¥ä¼šé”å®šäº†Userè¡¨ä¸­æ‰€æœ‰ç¬¦åˆæ£€ç´¢æ¡ä»¶ï¼ˆname=â€˜jayâ€™ï¼‰çš„è®°å½•ã€‚æœ¬æ¬¡äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œåˆ«çš„çº¿ç¨‹éƒ½æ— æ³•ä¿®æ”¹è¿™äº›è®°å½•ã€‚

### ä½¿ç”¨ä¹è§‚é”

ä¹è§‚é”æ€æƒ³å°±æ˜¯ï¼Œæœ‰çº¿ç¨‹è¿‡æ¥ï¼Œå…ˆæ”¾è¿‡å»ä¿®æ”¹ï¼Œå¦‚æœçœ‹åˆ°åˆ«çš„çº¿ç¨‹æ²¡ä¿®æ”¹è¿‡ï¼Œå°±å¯ä»¥ä¿®æ”¹æˆåŠŸï¼Œå¦‚æœåˆ«çš„çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œå°±ä¿®æ”¹å¤±è´¥æˆ–è€…é‡è¯•ã€‚å®ç°æ–¹å¼ï¼šä¹è§‚é”ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ–CASç®—æ³•å®ç°ã€‚

## 13. æ•°æ®åº“çš„ä¹è§‚é”å’Œæ‚²è§‚é”ã€‚

### æ‚²è§‚é”ï¼š

æ‚²è§‚é”å¥¹ä¸“ä¸€ä¸”ç¼ºä¹å®‰å…¨æ„Ÿäº†ï¼Œå¥¹çš„å¿ƒåªå±äºå½“å‰äº‹åŠ¡ï¼Œæ¯æ—¶æ¯åˆ»éƒ½æ‹…å¿ƒç€å®ƒå¿ƒçˆ±çš„æ•°æ®å¯èƒ½è¢«åˆ«çš„äº‹åŠ¡ä¿®æ”¹ï¼Œæ‰€ä»¥ä¸€ä¸ªäº‹åŠ¡æ‹¥æœ‰ï¼ˆè·å¾—ï¼‰æ‚²è§‚é”åï¼Œå…¶ä»–ä»»ä½•äº‹åŠ¡éƒ½ä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹å•¦ï¼Œåªèƒ½ç­‰å¾…é”è¢«é‡Šæ”¾æ‰å¯ä»¥æ‰§è¡Œã€‚

![](../images/1723d313056fce6a.jpg)

### ä¹è§‚é”ï¼š

ä¹è§‚é”çš„â€œä¹è§‚æƒ…ç»ªâ€ä½“ç°åœ¨ï¼Œå®ƒè®¤ä¸ºæ•°æ®çš„å˜åŠ¨ä¸ä¼šå¤ªé¢‘ç¹ã€‚å› æ­¤ï¼Œå®ƒå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶å¯¹æ•°æ®è¿›è¡Œå˜åŠ¨ã€‚å®ç°æ–¹å¼ï¼šä¹è§‚é”ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ–CASç®—æ³•å®ç°ã€‚

![](../images/1723e7d3872c9406.jpg)

## 14. SQLä¼˜åŒ–çš„ä¸€èˆ¬æ­¥éª¤æ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆçœ‹æ‰§è¡Œè®¡åˆ’ï¼ˆexplainï¼‰ï¼Œå¦‚ä½•ç†è§£å…¶ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰ã€‚

- `show status` å‘½ä»¤äº†è§£å„ç§ sql çš„æ‰§è¡Œé¢‘ç‡
- é€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—å®šä½é‚£äº›æ‰§è¡Œæ•ˆç‡è¾ƒä½çš„ sql è¯­å¥
- `explain` åˆ†æä½æ•ˆ sql çš„æ‰§è¡Œè®¡åˆ’ï¼ˆè¿™ç‚¹éå¸¸é‡è¦ï¼Œæ—¥å¸¸å¼€å‘ä¸­ç”¨å®ƒåˆ†æSqlï¼Œä¼šå¤§å¤§é™ä½Sqlå¯¼è‡´çš„çº¿ä¸Šäº‹æ•…ï¼‰

## 15. select for updateæœ‰ä»€ä¹ˆå«ä¹‰ï¼Œä¼šé”è¡¨è¿˜æ˜¯é”è¡Œè¿˜æ˜¯å…¶ä»–ã€‚

### select for update å«ä¹‰

selectæŸ¥è¯¢è¯­å¥æ˜¯ä¸ä¼šåŠ é”çš„ï¼Œä½†æ˜¯select for updateé™¤äº†æœ‰æŸ¥è¯¢çš„ä½œç”¨å¤–ï¼Œè¿˜ä¼šåŠ é”å‘¢ï¼Œè€Œä¸”å®ƒæ˜¯æ‚²è§‚é”å“¦ã€‚è‡³äºåŠ äº†æ˜¯è¡Œé”è¿˜æ˜¯è¡¨é”ï¼Œè¿™å°±è¦çœ‹æ˜¯ä¸æ˜¯ç”¨äº†ç´¢å¼•/ä¸»é”®å•¦ã€‚
æ²¡ç”¨ç´¢å¼•/ä¸»é”®çš„è¯å°±æ˜¯è¡¨é”ï¼Œå¦åˆ™å°±æ˜¯æ˜¯è¡Œé”ã€‚

## 16. MySQLäº‹åŠ¡å¾—å››å¤§ç‰¹æ€§ä»¥åŠå®ç°åŸç†

![](../images/17237f45a661cbb7.jpg)

- åŸå­æ€§ï¼š äº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚
- ä¸€è‡´æ€§ï¼š æŒ‡åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®ä¸ä¼šè¢«ç ´åï¼Œå‡å¦‚Aè´¦æˆ·ç»™Bè´¦æˆ·è½¬10å—é’±ï¼Œä¸ç®¡æˆåŠŸä¸å¦ï¼ŒAå’ŒBçš„æ€»é‡‘é¢æ˜¯ä¸å˜çš„ã€‚
- éš”ç¦»æ€§ï¼š å¤šä¸ªäº‹åŠ¡å¹¶å‘è®¿é—®æ—¶ï¼Œäº‹åŠ¡ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå³ä¸€ä¸ªäº‹åŠ¡ä¸å½±å“å…¶å®ƒäº‹åŠ¡è¿è¡Œæ•ˆæœã€‚ç®€è¨€ä¹‹ï¼Œå°±æ˜¯äº‹åŠ¡ä¹‹é—´æ˜¯è¿›æ°´ä¸çŠ¯æ²³æ°´çš„ã€‚
- æŒä¹…æ€§ï¼š è¡¨ç¤ºäº‹åŠ¡å®Œæˆä»¥åï¼Œè¯¥äº‹åŠ¡å¯¹æ•°æ®åº“æ‰€ä½œçš„æ“ä½œæ›´æ”¹ï¼Œå°†æŒä¹…åœ°ä¿å­˜åœ¨æ•°æ®åº“ä¹‹ä¸­ã€‚

### äº‹åŠ¡ACIDç‰¹æ€§çš„å®ç°æ€æƒ³

- åŸå­æ€§ï¼šæ˜¯ä½¿ç”¨ undo logæ¥å®ç°çš„ï¼Œå¦‚æœäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™æˆ–è€…ç”¨æˆ·æ‰§è¡Œäº†rollbackï¼Œç³»ç»Ÿé€šè¿‡undo logæ—¥å¿—è¿”å›äº‹åŠ¡å¼€å§‹çš„çŠ¶æ€ã€‚
- æŒä¹…æ€§ï¼šä½¿ç”¨ redo logæ¥å®ç°ï¼Œåªè¦redo logæ—¥å¿—æŒä¹…åŒ–äº†ï¼Œå½“ç³»ç»Ÿå´©æºƒï¼Œå³å¯é€šè¿‡redo logæŠŠæ•°æ®æ¢å¤ã€‚
- éš”ç¦»æ€§ï¼šé€šè¿‡é”ä»¥åŠMVCC,ä½¿äº‹åŠ¡ç›¸äº’éš”ç¦»å¼€ã€‚
- ä¸€è‡´æ€§ï¼šé€šè¿‡å›æ»šã€æ¢å¤ï¼Œä»¥åŠå¹¶å‘æƒ…å†µä¸‹çš„éš”ç¦»æ€§ï¼Œä»è€Œå®ç°ä¸€è‡´æ€§ã€‚

## 17. å¦‚æœæŸä¸ªè¡¨æœ‰è¿‘åƒä¸‡æ•°æ®ï¼ŒCRUDæ¯”è¾ƒæ…¢ï¼Œå¦‚ä½•ä¼˜åŒ–ã€‚

### åˆ†åº“åˆ†è¡¨

æŸä¸ªè¡¨æœ‰è¿‘åƒä¸‡æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘ä¼˜åŒ–è¡¨ç»“æ„ï¼Œåˆ†è¡¨ï¼ˆæ°´å¹³åˆ†è¡¨ï¼Œå‚ç›´åˆ†è¡¨ï¼‰ï¼Œå½“ç„¶ï¼Œä½ è¿™æ ·å›ç­”ï¼Œéœ€è¦å‡†å¤‡å¥½é¢è¯•å®˜é—®ä½ çš„åˆ†åº“åˆ†è¡¨ç›¸å…³é—®é¢˜å‘€ï¼Œå¦‚

- åˆ†è¡¨æ–¹æ¡ˆï¼ˆæ°´å¹³åˆ†è¡¨ï¼Œå‚ç›´åˆ†è¡¨ï¼Œåˆ‡åˆ†è§„åˆ™hashç­‰ï¼‰
- åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼ˆMycatï¼Œsharding-jdbcç­‰ï¼‰
- åˆ†åº“åˆ†è¡¨ä¸€äº›é—®é¢˜ï¼ˆäº‹åŠ¡é—®é¢˜ï¼Ÿè·¨èŠ‚ç‚¹Joinçš„é—®é¢˜ï¼‰
- è§£å†³æ–¹æ¡ˆï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ç­‰ï¼‰

### ç´¢å¼•ä¼˜åŒ–

é™¤äº†åˆ†åº“åˆ†è¡¨ï¼Œä¼˜åŒ–è¡¨ç»“æ„ï¼Œå½“ç„¶è¿˜æœ‰æ‰€ä»¥ç´¢å¼•ä¼˜åŒ–ç­‰æ–¹æ¡ˆ~

## 18. å¦‚ä½•å†™sqlèƒ½å¤Ÿæœ‰æ•ˆçš„ä½¿ç”¨åˆ°å¤åˆç´¢å¼•ã€‚

å¤åˆç´¢å¼•ï¼Œä¹Ÿå«ç»„åˆç´¢å¼•ï¼Œç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç´¢å¼•,è¿™ç§ç´¢å¼•å«åšå¤åˆç´¢å¼•ã€‚

å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå¦‚(k1,k2,k3)ï¼Œç›¸å½“äºåˆ›å»ºäº†ï¼ˆk1ï¼‰ã€(k1,k2)å’Œ(k1,k2,k3)ä¸‰ä¸ªç´¢å¼•ï¼Œè¿™å°±æ˜¯æœ€å·¦åŒ¹é…åŸåˆ™ã€‚

```sql
select * from table where k1=A AND k2=B AND k3=D 
```

æœ‰å…³äºå¤åˆç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨æŸ¥è¯¢Sqlæ¡ä»¶çš„é¡ºåºï¼Œç¡®ä¿æœ€å·¦åŒ¹é…åŸåˆ™æœ‰æ•ˆï¼ŒåŒæ—¶å¯ä»¥åˆ é™¤ä¸å¿…è¦çš„å†—ä½™ç´¢å¼•ã€‚


## 19. mysqlä¸­in å’Œexistsçš„åŒºåˆ«ã€‚

è¿™ä¸ªï¼Œè·Ÿä¸€ä¸‹demoæ¥çœ‹æ›´åˆºæ¿€å§ï¼Œå•Šå“ˆå“ˆ

å‡è®¾è¡¨Aè¡¨ç¤ºæŸä¼ä¸šçš„å‘˜å·¥è¡¨ï¼Œè¡¨Bè¡¨ç¤ºéƒ¨é—¨è¡¨ï¼ŒæŸ¥è¯¢æ‰€æœ‰éƒ¨é—¨çš„æ‰€æœ‰å‘˜å·¥ï¼Œå¾ˆå®¹æ˜“æœ‰ä»¥ä¸‹SQL:

```sql
select * from A where deptId in (select deptId from B);
```

è¿™æ ·å†™ç­‰ä»·äºï¼š

>å…ˆæŸ¥è¯¢éƒ¨é—¨è¡¨B
>select deptId from B
>å†ç”±éƒ¨é—¨deptIdï¼ŒæŸ¥è¯¢Açš„å‘˜å·¥
> select * from A where A.deptId = B.deptId

å¯ä»¥æŠ½è±¡æˆè¿™æ ·çš„ä¸€ä¸ªå¾ªç¯ï¼š

```sql
   List<> resultSet ;
    for(int i=0;i<B.length;i++) {
          for(int j=0;j<A.length;j++) {
          if(A[i].id==B[j].id) {
             resultSet.add(A[i]);
             break;
          }
       }
    }
```

æ˜¾ç„¶ï¼Œé™¤äº†ä½¿ç”¨inï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨existså®ç°ä¸€æ ·çš„æŸ¥è¯¢åŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š

```sql
select * from A where exists (select 1 from B where A.deptId = B.deptId); 
```

å› ä¸ºexistsæŸ¥è¯¢çš„ç†è§£å°±æ˜¯ï¼Œå…ˆæ‰§è¡Œä¸»æŸ¥è¯¢ï¼Œè·å¾—æ•°æ®åï¼Œå†æ”¾åˆ°å­æŸ¥è¯¢ä¸­åšæ¡ä»¶éªŒè¯ï¼Œæ ¹æ®éªŒè¯ç»“æœï¼ˆtrueæˆ–è€…falseï¼‰ï¼Œæ¥å†³å®šä¸»æŸ¥è¯¢çš„æ•°æ®ç»“æœæ˜¯å¦å¾—æ„ä¿ç•™ã€‚

é‚£ä¹ˆï¼Œè¿™æ ·å†™å°±ç­‰ä»·äºï¼š

> select * from A,å…ˆä»Aè¡¨åšå¾ªç¯
> select * from B where A.deptId = B.deptId,å†ä»Bè¡¨åšå¾ªç¯.

åŒç†ï¼Œå¯ä»¥æŠ½è±¡æˆè¿™æ ·ä¸€ä¸ªå¾ªç¯ï¼š

```java 
 List<> resultSet ;
    for(int i=0;i<A.length;i++) {
          for(int j=0;j<B.length;j++) {
          if(A[i].deptId==B[j].deptId) {
             resultSet.add(A[i]);
             break;
          }
       }
    }
```

æ•°æ®åº“æœ€è´¹åŠ²çš„å°±æ˜¯è·Ÿç¨‹åºé“¾æ¥é‡Šæ”¾ã€‚å‡è®¾é“¾æ¥äº†ä¸¤æ¬¡ï¼Œæ¯æ¬¡åšä¸Šç™¾ä¸‡æ¬¡çš„æ•°æ®é›†æŸ¥è¯¢ï¼ŒæŸ¥å®Œå°±èµ°ï¼Œè¿™æ ·å°±åªåšäº†ä¸¤æ¬¡ï¼›ç›¸åå»ºç«‹äº†ä¸Šç™¾ä¸‡æ¬¡é“¾æ¥ï¼Œç”³è¯·é“¾æ¥é‡Šæ”¾åå¤é‡å¤ï¼Œè¿™æ ·ç³»ç»Ÿå°±å—ä¸äº†äº†ã€‚å³mysqlä¼˜åŒ–åŸåˆ™ï¼Œå°±æ˜¯å°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œå°çš„æ•°æ®é›†é©±åŠ¨å¤§çš„æ•°æ®é›†ï¼Œä»è€Œè®©æ€§èƒ½æ›´ä¼˜ã€‚
å› æ­¤ï¼Œæˆ‘ä»¬è¦é€‰æ‹©æœ€å¤–å±‚å¾ªç¯å°çš„ï¼Œä¹Ÿå°±æ˜¯ï¼Œå¦‚æœBçš„æ•°æ®é‡å°äºAï¼Œé€‚åˆä½¿ç”¨inï¼Œå¦‚æœBçš„æ•°æ®é‡å¤§äºAï¼Œå³é€‚åˆé€‰æ‹©existsï¼Œè¿™å°±æ˜¯inå’Œexistsçš„åŒºåˆ«ã€‚

## 20. æ•°æ®åº“è‡ªå¢ä¸»é”®å¯èƒ½é‡åˆ°ä»€ä¹ˆé—®é¢˜ã€‚

ä½¿ç”¨è‡ªå¢ä¸»é”®å¯¹æ•°æ®åº“åšåˆ†åº“åˆ†è¡¨ï¼Œå¯èƒ½å‡ºç°è¯¸å¦‚ä¸»é”®é‡å¤ç­‰çš„é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆçš„è¯ï¼Œç®€å•ç‚¹çš„è¯å¯ä»¥è€ƒè™‘ä½¿ç”¨UUIDå“ˆ
è‡ªå¢ä¸»é”®ä¼šäº§ç”Ÿè¡¨é”ï¼Œä»è€Œå¼•å‘é—®é¢˜
è‡ªå¢ä¸»é”®å¯èƒ½ç”¨å®Œé—®é¢˜ã€‚

## 21. MVCCç†Ÿæ‚‰å—ï¼Œå®ƒçš„åº•å±‚åŸç†ï¼Ÿ

MVCC,å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶,å®ƒæ˜¯é€šè¿‡è¯»å–å†å²ç‰ˆæœ¬çš„æ•°æ®ï¼Œæ¥é™ä½å¹¶å‘äº‹åŠ¡å†²çªï¼Œä»è€Œæé«˜å¹¶å‘æ€§èƒ½çš„ä¸€ç§æœºåˆ¶ã€‚

### MVCCéœ€è¦å…³æ³¨è¿™å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š

- äº‹åŠ¡ç‰ˆæœ¬å·
- è¡¨çš„éšè—åˆ—
- undo log
- read view

## 22. æ•°æ®åº“ä¸­é—´ä»¶äº†è§£è¿‡å—ï¼Œsharding jdbcï¼Œmycatï¼Ÿ

sharding-jdbcç›®å‰æ˜¯åŸºäºjdbcé©±åŠ¨ï¼Œæ— éœ€é¢å¤–çš„proxyï¼Œå› æ­¤ä¹Ÿæ— éœ€å…³æ³¨proxyæœ¬èº«çš„é«˜å¯ç”¨ã€‚
Mycat æ˜¯åŸºäº Proxyï¼Œå®ƒå¤å†™äº† MySQL åè®®ï¼Œå°† Mycat Server ä¼ªè£…æˆä¸€ä¸ª MySQL æ•°æ®åº“ï¼Œè€Œ Sharding-JDBC æ˜¯åŸºäº JDBC æ¥å£çš„æ‰©å±•ï¼Œæ˜¯ä»¥ jar åŒ…çš„å½¢å¼æä¾›è½»é‡çº§æœåŠ¡çš„ã€‚

## 23. MYSQLçš„ä¸»ä»å»¶è¿Ÿï¼Œä½ æ€ä¹ˆè§£å†³ï¼Ÿ

å˜»å˜»ï¼Œå…ˆå¤ä¹ ä¸€ä¸‹ä¸»ä»å¤åˆ¶åŸç†å§ï¼Œå¦‚å›¾ï¼š

![](../images/1723fa894b85ed73.jpg)

ä¸»ä»å¤åˆ¶åˆ†äº†äº”ä¸ªæ­¥éª¤è¿›è¡Œï¼š

- æ­¥éª¤ä¸€ï¼šä¸»åº“çš„æ›´æ–°äº‹ä»¶(updateã€insertã€delete)è¢«å†™åˆ°binlog
- æ­¥éª¤äºŒï¼šä»åº“å‘èµ·è¿æ¥ï¼Œè¿æ¥åˆ°ä¸»åº“ã€‚
- æ­¥éª¤ä¸‰ï¼šæ­¤æ—¶ä¸»åº“åˆ›å»ºä¸€ä¸ªbinlog dump threadï¼ŒæŠŠbinlogçš„å†…å®¹å‘é€åˆ°ä»åº“ã€‚
- æ­¥éª¤å››ï¼šä»åº“å¯åŠ¨ä¹‹åï¼Œåˆ›å»ºä¸€ä¸ªI/Oçº¿ç¨‹ï¼Œè¯»å–ä¸»åº“ä¼ è¿‡æ¥çš„binlogå†…å®¹å¹¶å†™å…¥åˆ°relay log
- æ­¥éª¤äº”ï¼šè¿˜ä¼šåˆ›å»ºä¸€ä¸ªSQLçº¿ç¨‹ï¼Œä»relay logé‡Œé¢è¯»å–å†…å®¹ï¼Œä»Exec_Master_Log_Posä½ç½®å¼€å§‹æ‰§è¡Œè¯»å–åˆ°çš„æ›´æ–°äº‹ä»¶ï¼Œå°†æ›´æ–°å†…å®¹å†™å…¥åˆ°slaveçš„db

### ä¸»ä»åŒæ­¥å»¶è¿Ÿçš„åŸå› 

ä¸€ä¸ªæœåŠ¡å™¨å¼€æ”¾ï¼®ä¸ªé“¾æ¥ç»™å®¢æˆ·ç«¯æ¥è¿æ¥çš„ï¼Œè¿™æ ·æœ‰ä¼šæœ‰å¤§å¹¶å‘çš„æ›´æ–°æ“ä½œ, ä½†æ˜¯ä»æœåŠ¡å™¨çš„é‡Œé¢è¯»å–binlogçš„çº¿ç¨‹ä»…æœ‰ä¸€ä¸ªï¼Œå½“æŸä¸ªSQLåœ¨ä»æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„æ—¶é—´ç¨é•¿ æˆ–è€…ç”±äºæŸä¸ªSQLè¦è¿›è¡Œé”è¡¨å°±ä¼šå¯¼è‡´ï¼Œä¸»æœåŠ¡å™¨çš„SQLå¤§é‡ç§¯å‹ï¼Œæœªè¢«åŒæ­¥åˆ°ä»æœåŠ¡å™¨é‡Œã€‚è¿™å°±å¯¼è‡´äº†ä¸»ä»ä¸ä¸€è‡´ï¼Œ ä¹Ÿå°±æ˜¯ä¸»ä»å»¶è¿Ÿã€‚

### ä¸»ä»åŒæ­¥å»¶è¿Ÿçš„è§£å†³åŠæ³•

- ä¸»æœåŠ¡å™¨è¦è´Ÿè´£æ›´æ–°æ“ä½œï¼Œå¯¹å®‰å…¨æ€§çš„è¦æ±‚æ¯”ä»æœåŠ¡å™¨è¦é«˜ï¼Œæ‰€ä»¥æœ‰äº›è®¾ç½®å‚æ•°å¯ä»¥ä¿®æ”¹ï¼Œæ¯”å¦‚sync_binlog=1ï¼Œinnodb_flush_log_at_trx_commit = 1 ä¹‹ç±»çš„è®¾ç½®ç­‰ã€‚
- é€‰æ‹©æ›´å¥½çš„ç¡¬ä»¶è®¾å¤‡ä½œä¸ºslaveã€‚
- æŠŠä¸€å°ä»æœåŠ¡å™¨å½“åº¦ä½œä¸ºå¤‡ä»½ä½¿ç”¨ï¼Œ è€Œä¸æä¾›æŸ¥è¯¢ï¼Œ é‚£è¾¹ä»–çš„è´Ÿè½½ä¸‹æ¥äº†ï¼Œ æ‰§è¡Œrelay log é‡Œé¢çš„SQLæ•ˆç‡è‡ªç„¶å°±é«˜äº†ã€‚
- å¢åŠ ä»æœåŠ¡å™¨å–½ï¼Œè¿™ä¸ªç›®çš„è¿˜æ˜¯åˆ†æ•£è¯»çš„å‹åŠ›ï¼Œä»è€Œé™ä½æœåŠ¡å™¨è´Ÿè½½ã€‚

## 24. è¯´ä¸€ä¸‹å¤§è¡¨æŸ¥è¯¢çš„ä¼˜åŒ–æ–¹æ¡ˆ

- ä¼˜åŒ–shemaã€sqlè¯­å¥+ç´¢å¼•ï¼›
- å¯ä»¥è€ƒè™‘åŠ ç¼“å­˜ï¼Œmemcached, redisï¼Œæˆ–è€…JVMæœ¬åœ°ç¼“å­˜ï¼›
- ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»ï¼›
- åˆ†åº“åˆ†è¡¨ï¼›

## 25. ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿æ¥æ± ?ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è¿æ¥æ± å‘¢?

### è¿æ¥æ± åŸºæœ¬åŸç†ï¼š

æ•°æ®åº“è¿æ¥æ± åŸç†ï¼šåœ¨å†…éƒ¨å¯¹è±¡æ± ä¸­ï¼Œç»´æŠ¤ä¸€å®šæ•°é‡çš„æ•°æ®åº“è¿æ¥ï¼Œå¹¶å¯¹å¤–æš´éœ²æ•°æ®åº“è¿æ¥çš„è·å–å’Œè¿”å›æ–¹æ³•ã€‚

### åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼š

- é€šè¿‡TCPåè®®çš„ä¸‰æ¬¡æ¡æ‰‹å’Œæ•°æ®åº“æœåŠ¡å™¨å»ºç«‹è¿æ¥
- å‘é€æ•°æ®åº“ç”¨æˆ·è´¦å·å¯†ç ï¼Œç­‰å¾…æ•°æ®åº“éªŒè¯ç”¨æˆ·èº«ä»½
- å®Œæˆèº«ä»½éªŒè¯åï¼Œç³»ç»Ÿå¯ä»¥æäº¤SQLè¯­å¥åˆ°æ•°æ®åº“æ‰§è¡Œ
- æŠŠè¿æ¥å…³é—­ï¼ŒTCPå››æ¬¡æŒ¥æ‰‹å‘Šåˆ«ã€‚

### æ•°æ®åº“è¿æ¥æ± å¥½å¤„ï¼š

- èµ„æºé‡ç”¨ (è¿æ¥å¤ç”¨)
- æ›´å¿«çš„ç³»ç»Ÿå“åº”é€Ÿåº¦
- æ–°çš„èµ„æºåˆ†é…æ‰‹æ®µ
 ç»Ÿä¸€çš„è¿æ¥ç®¡ç†ï¼Œé¿å…æ•°æ®åº“è¿æ¥æ³„æ¼

## 26. ä¸€æ¡SQLè¯­å¥åœ¨MySQLä¸­å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ

å…ˆçœ‹ä¸€ä¸‹Mysqlçš„é€»è¾‘æ¶æ„å›¾å§~

![](../images/1724037179201fe9.jpg)

### æŸ¥è¯¢è¯­å¥ï¼š

- å…ˆæ£€æŸ¥è¯¥è¯­å¥æ˜¯å¦æœ‰æƒé™
- å¦‚æœæ²¡æœ‰æƒé™ï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯
- å¦‚æœæœ‰æƒé™ï¼Œåœ¨ MySQL8.0 ç‰ˆæœ¬ä»¥å‰ï¼Œä¼šå…ˆæŸ¥è¯¢ç¼“å­˜ã€‚
- å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ†æå™¨è¿›è¡Œè¯æ³•åˆ†æï¼Œæå– sql è¯­å¥selectç­‰çš„å…³é”®å…ƒç´ ã€‚ç„¶ååˆ¤æ–­sql è¯­å¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼Œæ¯”å¦‚å…³é”®è¯æ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚
- ä¼˜åŒ–å™¨è¿›è¡Œç¡®å®šæ‰§è¡Œæ–¹æ¡ˆ
- è¿›è¡Œæƒé™æ ¡éªŒï¼Œå¦‚æœæ²¡æœ‰æƒé™å°±ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæœ‰æƒé™å°±ä¼šè°ƒç”¨æ•°æ®åº“å¼•æ“æ¥å£ï¼Œè¿”å›æ‰§è¡Œç»“æœã€‚

## 27. InnoDBå¼•æ“ä¸­çš„ç´¢å¼•ç­–ç•¥ï¼Œäº†è§£è¿‡å—ï¼Ÿ

- è¦†ç›–ç´¢å¼•
- æœ€å·¦å‰ç¼€åŸåˆ™
- ç´¢å¼•ä¸‹æ¨
- ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–æ˜¯ MySQL 5.6 å¼•å…¥çš„ï¼Œ å¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚

## 28. æ•°æ®åº“å­˜å‚¨æ—¥æœŸæ ¼å¼æ—¶ï¼Œå¦‚ä½•è€ƒè™‘æ—¶åŒºè½¬æ¢é—®é¢˜ï¼Ÿ

- datetimeç±»å‹é€‚åˆç”¨æ¥è®°å½•æ•°æ®çš„åŸå§‹çš„åˆ›å»ºæ—¶é—´ï¼Œä¿®æ”¹è®°å½•ä¸­å…¶ä»–å­—æ®µçš„å€¼ï¼Œdatetimeå­—æ®µçš„å€¼ä¸ä¼šæ”¹å˜ï¼Œé™¤éæ‰‹åŠ¨ä¿®æ”¹å®ƒã€‚
- timestampç±»å‹é€‚åˆç”¨æ¥è®°å½•æ•°æ®çš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œåªè¦ä¿®æ”¹äº†è®°å½•ä¸­å…¶ä»–å­—æ®µçš„å€¼ï¼Œtimestampå­—æ®µçš„å€¼éƒ½ä¼šè¢«è‡ªåŠ¨æ›´æ–°ã€‚

## 29. ä¸€æ¡sqlæ‰§è¡Œè¿‡é•¿çš„æ—¶é—´ï¼Œä½ å¦‚ä½•ä¼˜åŒ–ï¼Œä»å“ªäº›æ–¹é¢å…¥æ‰‹ï¼Ÿ

- æŸ¥çœ‹æ˜¯å¦æ¶‰åŠå¤šè¡¨å’Œå­æŸ¥è¯¢ï¼Œä¼˜åŒ–Sqlç»“æ„ï¼Œå¦‚å»é™¤å†—ä½™å­—æ®µï¼Œæ˜¯å¦å¯æ‹†è¡¨ç­‰
- ä¼˜åŒ–ç´¢å¼•ç»“æ„ï¼Œçœ‹æ˜¯å¦å¯ä»¥é€‚å½“æ·»åŠ ç´¢å¼•
- æ•°é‡å¤§çš„è¡¨ï¼Œå¯ä»¥è€ƒè™‘è¿›è¡Œåˆ†ç¦»/åˆ†è¡¨ï¼ˆå¦‚äº¤æ˜“æµæ°´è¡¨ï¼‰
- æ•°æ®åº“ä¸»ä»åˆ†ç¦»ï¼Œè¯»å†™åˆ†ç¦»
- explainåˆ†æsqlè¯­å¥ï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œä¼˜åŒ–sql
- æŸ¥çœ‹mysqlæ‰§è¡Œæ—¥å¿—ï¼Œåˆ†ææ˜¯å¦æœ‰å…¶ä»–æ–¹é¢çš„é—®é¢˜

## 30. MYSQLæ•°æ®åº“æœåŠ¡å™¨æ€§èƒ½åˆ†æçš„æ–¹æ³•å‘½ä»¤æœ‰å“ªäº›?

- Show status, ä¸€äº›å€¼å¾—ç›‘æ§çš„å˜é‡å€¼ï¼š

> Bytes_receivedå’ŒBytes_sent å’ŒæœåŠ¡å™¨ä¹‹é—´æ¥å¾€çš„æµé‡ã€‚
>  Com_*æœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œçš„å‘½ä»¤ã€‚
>  Created_*åœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé™é—´åˆ›å»ºçš„ä¸´æ—¶è¡¨å’Œæ–‡ä»¶ã€‚
>  Handler_*å­˜å‚¨å¼•æ“æ“ä½œã€‚
>  Select_*ä¸åŒç±»å‹çš„è”æ¥æ‰§è¡Œè®¡åˆ’ã€‚
>  Sort_*å‡ ç§æ’åºä¿¡æ¯ã€‚
  
- Show profiles æ˜¯MySqlç”¨æ¥åˆ†æå½“å‰ä¼šè¯SQLè¯­å¥æ‰§è¡Œçš„èµ„æºæ¶ˆè€—æƒ…å†µ

## 31. Blobå’Œtextæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- Blobç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼Œè€ŒTextç”¨äºå­˜å‚¨å¤§å­—ç¬¦ä¸²ã€‚
- Blobå€¼è¢«è§†ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆå­—èŠ‚å­—ç¬¦ä¸²ï¼‰,å®ƒä»¬æ²¡æœ‰å­—ç¬¦é›†ï¼Œå¹¶ä¸”æ’åºå’Œæ¯”è¾ƒåŸºäºåˆ—å€¼ä¸­çš„å­—èŠ‚çš„æ•°å€¼ã€‚
- textå€¼è¢«è§†ä¸ºéäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆå­—ç¬¦å­—ç¬¦ä¸²ï¼‰ã€‚å®ƒä»¬æœ‰ä¸€ä¸ªå­—ç¬¦é›†ï¼Œå¹¶æ ¹æ®å­—ç¬¦é›†çš„æ’åºè§„åˆ™å¯¹å€¼è¿›è¡Œæ’åºå’Œæ¯”è¾ƒã€‚

## 32.  mysqlé‡Œè®°å½•è´§å¸ç”¨ä»€ä¹ˆå­—æ®µç±»å‹æ¯”è¾ƒå¥½ï¼Ÿ

- è´§å¸åœ¨æ•°æ®åº“ä¸­MySQLå¸¸ç”¨Decimalå’ŒNumricç±»å‹è¡¨ç¤ºï¼Œè¿™ä¸¤ç§ç±»å‹è¢«MySQLå®ç°ä¸ºåŒæ ·çš„ç±»å‹ã€‚ä»–ä»¬è¢«ç”¨äºä¿å­˜ä¸é‡‘é’±æœ‰å…³çš„æ•°æ®ã€‚
- salary DECIMAL(9,2)ï¼Œ9(precision)ä»£è¡¨å°†è¢«ç”¨äºå­˜å‚¨å€¼çš„æ€»çš„å°æ•°ä½æ•°ï¼Œè€Œ2(scale)ä»£è¡¨å°†è¢«ç”¨äºå­˜å‚¨å°æ•°ç‚¹åçš„ä½æ•°ã€‚å­˜å‚¨åœ¨salaryåˆ—ä¸­çš„å€¼çš„èŒƒå›´æ˜¯ä»-9999999.99åˆ°9999999.99ã€‚
- DECIMALå’ŒNUMERICå€¼ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨ï¼Œè€Œä¸æ˜¯ä½œä¸ºäºŒè¿›åˆ¶æµ®ç‚¹æ•°ï¼Œä»¥ä¾¿ä¿å­˜é‚£äº›å€¼çš„å°æ•°ç²¾åº¦ã€‚

## 33.  Mysqlä¸­æœ‰å“ªå‡ ç§é”ï¼Œåˆ—ä¸¾ä¸€ä¸‹ï¼Ÿ

![](../images/17240a13fa147bea.jpg)

å¦‚æœæŒ‰é”ç²’åº¦åˆ’åˆ†ï¼Œæœ‰ä»¥ä¸‹3ç§ï¼š

- è¡¨é”ï¼š å¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›é”å®šåŠ›åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡é«˜ï¼Œå¹¶å‘åº¦æœ€ä½;ä¸ä¼šå‡ºç°æ­»é”ã€‚
- è¡Œé”ï¼š å¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡ä½ï¼Œå¹¶å‘åº¦é«˜ã€‚
- é¡µé”ï¼š å¼€é”€å’ŒåŠ é”é€Ÿåº¦ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬

## 34.  Hashç´¢å¼•å’ŒB+æ ‘åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä½ åœ¨è®¾è®¡ç´¢å¼•æ˜¯æ€ä¹ˆæŠ‰æ‹©çš„ï¼Ÿ

- B+æ ‘å¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼ŒHashç´¢å¼•ä¸èƒ½ã€‚
- B+æ ‘æ”¯æŒè”åˆç´¢å¼•çš„æœ€å·¦ä¾§åŸåˆ™ï¼ŒHashç´¢å¼•ä¸æ”¯æŒã€‚
- B+æ ‘æ”¯æŒorder byæ’åºï¼ŒHashç´¢å¼•ä¸æ”¯æŒã€‚
- Hashç´¢å¼•åœ¨ç­‰å€¼æŸ¥è¯¢ä¸Šæ¯”B+æ ‘æ•ˆç‡æ›´é«˜ã€‚
- B+æ ‘ä½¿ç”¨like è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢çš„æ—¶å€™ï¼Œlikeåé¢ï¼ˆæ¯”å¦‚%å¼€å¤´ï¼‰çš„è¯å¯ä»¥èµ·åˆ°ä¼˜åŒ–çš„ä½œç”¨ï¼ŒHashç´¢å¼•æ ¹æœ¬æ— æ³•è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ã€‚

## 35.  mysql çš„å†…è¿æ¥ã€å·¦è¿æ¥ã€å³è¿æ¥æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- Inner join å†…è¿æ¥ï¼Œåœ¨ä¸¤å¼ è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢æ—¶ï¼Œåªä¿ç•™ä¸¤å¼ è¡¨ä¸­å®Œå…¨åŒ¹é…çš„ç»“æœé›†
- left join åœ¨ä¸¤å¼ è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢æ—¶ï¼Œä¼šè¿”å›å·¦è¡¨æ‰€æœ‰çš„è¡Œï¼Œå³ä½¿åœ¨å³è¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è®°å½•ã€‚
- right join åœ¨ä¸¤å¼ è¡¨è¿›è¡Œè¿æ¥æŸ¥è¯¢æ—¶ï¼Œä¼šè¿”å›å³è¡¨æ‰€æœ‰çš„è¡Œï¼Œå³ä½¿åœ¨å·¦è¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è®°å½•ã€‚

## 36.  è¯´è¯´MySQL çš„åŸºç¡€æ¶æ„å›¾

![](../images/17240afafdc289e5.jpg)

Mysqlé€»è¾‘æ¶æ„å›¾ä¸»è¦åˆ†ä¸‰å±‚ï¼š

- ç¬¬ä¸€å±‚è´Ÿè´£è¿æ¥å¤„ç†ï¼Œæˆæƒè®¤è¯ï¼Œå®‰å…¨ç­‰ç­‰
- ç¬¬äºŒå±‚è´Ÿè´£ç¼–è¯‘å¹¶ä¼˜åŒ–SQL
- ç¬¬ä¸‰å±‚æ˜¯å­˜å‚¨å¼•æ“ã€‚

## 37.  ä»€ä¹ˆæ˜¯å†…è¿æ¥ã€å¤–è¿æ¥ã€äº¤å‰è¿æ¥ã€ç¬›å¡å°”ç§¯å‘¢ï¼Ÿ

- å†…è¿æ¥ï¼ˆinner joinï¼‰ï¼šå–å¾—ä¸¤å¼ è¡¨ä¸­æ»¡è¶³å­˜åœ¨è¿æ¥åŒ¹é…å…³ç³»çš„è®°å½•ã€‚
- å¤–è¿æ¥ï¼ˆouter joinï¼‰ï¼šå–å¾—ä¸¤å¼ è¡¨ä¸­æ»¡è¶³å­˜åœ¨è¿æ¥åŒ¹é…å…³ç³»çš„è®°å½•ï¼Œä»¥åŠæŸå¼ è¡¨ï¼ˆæˆ–ä¸¤å¼ è¡¨ï¼‰ä¸­ä¸æ»¡è¶³åŒ¹é…å…³ç³»çš„è®°å½•ã€‚
- äº¤å‰è¿æ¥ï¼ˆcross joinï¼‰ï¼šæ˜¾ç¤ºä¸¤å¼ è¡¨æ‰€æœ‰è®°å½•ä¸€ä¸€å¯¹åº”ï¼Œæ²¡æœ‰åŒ¹é…å…³ç³»è¿›è¡Œç­›é€‰ï¼Œä¹Ÿè¢«ç§°ä¸ºï¼šç¬›å¡å°”ç§¯ã€‚

## 38.  è¯´ä¸€ä¸‹æ•°æ®åº“çš„ä¸‰å¤§èŒƒå¼

- ç¬¬ä¸€èŒƒå¼ï¼šæ•°æ®è¡¨ä¸­çš„æ¯ä¸€åˆ—ï¼ˆæ¯ä¸ªå­—æ®µï¼‰éƒ½ä¸å¯ä»¥å†æ‹†åˆ†ã€‚
- ç¬¬äºŒèŒƒå¼ï¼šåœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œåˆ†ä¸»é”®åˆ—å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œè€Œä¸èƒ½æ˜¯ä¾èµ–äºä¸»é”®çš„ä¸€éƒ¨åˆ†ã€‚
- ç¬¬ä¸‰èŒƒå¼ï¼šåœ¨æ»¡è¶³ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¡¨ä¸­çš„éä¸»é”®åªä¾èµ–äºä¸»é”®ï¼Œè€Œä¸ä¾èµ–äºå…¶ä»–éä¸»é”®ã€‚

## 39.  mysqlæœ‰å…³æƒé™çš„è¡¨æœ‰å“ªå‡ ä¸ªå‘¢ï¼Ÿ

MySQLæœåŠ¡å™¨é€šè¿‡æƒé™è¡¨æ¥æ§åˆ¶ç”¨æˆ·å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œæƒé™è¡¨å­˜æ”¾åœ¨mysqlæ•°æ®åº“é‡Œï¼Œç”±mysql_install_dbè„šæœ¬åˆå§‹åŒ–ã€‚è¿™äº›æƒé™è¡¨åˆ†åˆ«userï¼Œdbï¼Œtable_privï¼Œcolumns_privå’Œhostã€‚

- useræƒé™è¡¨ï¼šè®°å½•å…è®¸è¿æ¥åˆ°æœåŠ¡å™¨çš„ç”¨æˆ·å¸å·ä¿¡æ¯ï¼Œé‡Œé¢çš„æƒé™æ˜¯å…¨å±€çº§çš„ã€‚
- dbæƒé™è¡¨ï¼šè®°å½•å„ä¸ªå¸å·åœ¨å„ä¸ªæ•°æ®åº“ä¸Šçš„æ“ä½œæƒé™ã€‚
- table_privæƒé™è¡¨ï¼šè®°å½•æ•°æ®è¡¨çº§çš„æ“ä½œæƒé™ã€‚
- columns_privæƒé™è¡¨ï¼šè®°å½•æ•°æ®åˆ—çº§çš„æ“ä½œæƒé™ã€‚
- hostæƒé™è¡¨ï¼šé…åˆdbæƒé™è¡¨å¯¹ç»™å®šä¸»æœºä¸Šæ•°æ®åº“çº§æ“ä½œæƒé™ä½œæ›´ç»†è‡´çš„æ§åˆ¶ã€‚è¿™ä¸ªæƒé™è¡¨ä¸å—GRANTå’ŒREVOKEè¯­å¥çš„å½±å“ã€‚

## 40.  Mysqlçš„binlogæœ‰å‡ ç§å½•å…¥æ ¼å¼ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

æœ‰ä¸‰ç§æ ¼å¼å“ˆï¼Œstatementï¼Œrowå’Œmixedã€‚

- statementï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqléƒ½ä¼šè®°å½•åœ¨binlogä¸­ã€‚ä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº†IOï¼Œæé«˜æ€§èƒ½ã€‚ç”±äºsqlçš„æ‰§è¡Œæ˜¯æœ‰ä¸Šä¸‹æ–‡çš„ï¼Œå› æ­¤åœ¨ä¿å­˜çš„æ—¶å€™éœ€è¦ä¿å­˜ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€äº›ä½¿ç”¨äº†å‡½æ•°ä¹‹ç±»çš„è¯­å¥æ— æ³•è¢«è®°å½•å¤åˆ¶ã€‚
- rowï¼Œä¸è®°å½•sqlè¯­å¥ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ï¼Œä»…ä¿å­˜å“ªæ¡è®°å½•è¢«ä¿®æ”¹ã€‚è®°å½•å•å…ƒä¸ºæ¯ä¸€è¡Œçš„æ”¹åŠ¨ï¼ŒåŸºæœ¬æ˜¯å¯ä»¥å…¨éƒ¨è®°ä¸‹æ¥ä½†æ˜¯ç”±äºå¾ˆå¤šæ“ä½œï¼Œä¼šå¯¼è‡´å¤§é‡è¡Œçš„æ”¹åŠ¨(æ¯”å¦‚alter table)ï¼Œå› æ­¤è¿™ç§æ¨¡å¼çš„æ–‡ä»¶ä¿å­˜çš„ä¿¡æ¯å¤ªå¤šï¼Œæ—¥å¿—é‡å¤ªå¤§ã€‚
- mixedï¼Œä¸€ç§æŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œæ™®é€šæ“ä½œä½¿ç”¨statementè®°å½•ï¼Œå½“æ— æ³•ä½¿ç”¨statementçš„æ—¶å€™ä½¿ç”¨rowã€‚


## 41.  InnoDBå¼•æ“çš„4å¤§ç‰¹æ€§ï¼Œäº†è§£è¿‡å—

- æ’å…¥ç¼“å†²ï¼ˆinsert buffer)
- äºŒæ¬¡å†™(double write)
- è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•(ahi)
- é¢„è¯»(read ahead)

## 42.  ç´¢å¼•æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ

**ä¼˜ç‚¹ï¼š**

- å”¯ä¸€ç´¢å¼•å¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œçš„æ•°æ®çš„å”¯ä¸€æ€§
- ç´¢å¼•å¯ä»¥åŠ å¿«æ•°æ®æŸ¥è¯¢é€Ÿåº¦ï¼Œå‡å°‘æŸ¥è¯¢æ—¶é—´

**ç¼ºç‚¹ï¼š**

- åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦è€—è´¹æ—¶é—´
- ç´¢å¼•éœ€è¦å ç‰©ç†ç©ºé—´ï¼Œé™¤äº†æ•°æ®è¡¨å ç”¨æ•°æ®ç©ºé—´ä¹‹å¤–ï¼Œæ¯ä¸€ä¸ªç´¢å¼•è¿˜è¦å ç”¨ä¸€å®šçš„ç‰©ç†ç©ºé—´
- ä»¥è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢ã€åˆ ã€æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•ä¹Ÿè¦åŠ¨æ€çš„ç»´æŠ¤ã€‚

## 43.  ç´¢å¼•æœ‰å“ªå‡ ç§ç±»å‹ï¼Ÿ

- ä¸»é”®ç´¢å¼•: æ•°æ®åˆ—ä¸å…è®¸é‡å¤ï¼Œä¸å…è®¸ä¸ºNULLï¼Œä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ã€‚
- å”¯ä¸€ç´¢å¼•: æ•°æ®åˆ—ä¸å…è®¸é‡å¤ï¼Œå…è®¸ä¸ºNULLå€¼ï¼Œä¸€ä¸ªè¡¨å…è®¸å¤šä¸ªåˆ—åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚
- æ™®é€šç´¢å¼•: åŸºæœ¬çš„ç´¢å¼•ç±»å‹ï¼Œæ²¡æœ‰å”¯ä¸€æ€§çš„é™åˆ¶ï¼Œå…è®¸ä¸ºNULLå€¼ã€‚
- å…¨æ–‡ç´¢å¼•ï¼šæ˜¯ç›®å‰æœç´¢å¼•æ“ä½¿ç”¨çš„ä¸€ç§å…³é”®æŠ€æœ¯ï¼Œå¯¹æ–‡æœ¬çš„å†…å®¹è¿›è¡Œåˆ†è¯ã€æœç´¢ã€‚
- è¦†ç›–ç´¢å¼•ï¼šæŸ¥è¯¢åˆ—è¦è¢«æ‰€å»ºçš„ç´¢å¼•è¦†ç›–ï¼Œä¸å¿…è¯»å–æ•°æ®è¡Œ
- ç»„åˆç´¢å¼•ï¼šå¤šåˆ—å€¼ç»„æˆä¸€ä¸ªç´¢å¼•ï¼Œç”¨äºç»„åˆæœç´¢ï¼Œæ•ˆç‡å¤§äºç´¢å¼•åˆå¹¶

## 44.  åˆ›å»ºç´¢å¼•æœ‰ä»€ä¹ˆåŸåˆ™å‘¢ï¼Ÿ

- æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™
- é¢‘ç¹ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µæ‰å»åˆ›å»ºç´¢å¼•
- é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼•
- ç´¢å¼•åˆ—ä¸èƒ½å‚ä¸è®¡ç®—ï¼Œä¸èƒ½æœ‰å‡½æ•°æ“ä½œ
- ä¼˜å…ˆè€ƒè™‘æ‰©å±•ç´¢å¼•ï¼Œè€Œä¸æ˜¯æ–°å»ºç´¢å¼•ï¼Œé¿å…ä¸å¿…è¦çš„ç´¢å¼•
- åœ¨order byæˆ–è€…group byå­å¥ä¸­ï¼Œåˆ›å»ºç´¢å¼•éœ€è¦æ³¨æ„é¡ºåº
- åŒºåˆ†åº¦ä½çš„æ•°æ®åˆ—ä¸é€‚åˆåšç´¢å¼•åˆ—(å¦‚æ€§åˆ«ï¼‰
- å®šä¹‰æœ‰å¤–é”®çš„æ•°æ®åˆ—ä¸€å®šè¦å»ºç«‹ç´¢å¼•ã€‚
- å¯¹äºå®šä¹‰ä¸ºtextã€imageæ•°æ®ç±»å‹çš„åˆ—ä¸è¦å»ºç«‹ç´¢å¼•ã€‚
- åˆ é™¤ä¸å†ä½¿ç”¨æˆ–è€…å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•

## 45.  åˆ›å»ºç´¢å¼•çš„ä¸‰ç§æ–¹å¼

åœ¨æ‰§è¡ŒCREATE TABLEæ—¶åˆ›å»ºç´¢å¼•

```sql
CREATE TABLE `employee` (
  `id` int(11) NOT NULL,
  `name` varchar(255) DEFAULT NULL,
  `age` int(11) DEFAULT NULL,
  `date` datetime DEFAULT NULL,
  `sex` int(1) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

ä½¿ç”¨ALTER TABLEå‘½ä»¤æ·»åŠ ç´¢å¼•

```sql
ALTER TABLE table_name ADD INDEX index_name (column);
```

ä½¿ç”¨CREATE INDEXå‘½ä»¤åˆ›å»º

```sql
CREATE INDEX index_name ON table_name (column);
```

## 46. ç™¾ä¸‡çº§åˆ«æˆ–ä»¥ä¸Šçš„æ•°æ®ï¼Œä½ æ˜¯å¦‚ä½•åˆ é™¤çš„ï¼Ÿ

- æˆ‘ä»¬æƒ³è¦åˆ é™¤ç™¾ä¸‡æ•°æ®çš„æ—¶å€™å¯ä»¥å…ˆåˆ é™¤ç´¢å¼•
- ç„¶åæ‰¹é‡åˆ é™¤å…¶ä¸­æ— ç”¨æ•°æ®
- åˆ é™¤å®Œæˆåé‡æ–°åˆ›å»ºç´¢å¼•ã€‚

## 47. ä»€ä¹ˆæ˜¯æœ€å·¦å‰ç¼€åŸåˆ™ï¼Ÿä»€ä¹ˆæ˜¯æœ€å·¦åŒ¹é…åŸåˆ™ï¼Ÿ

- æœ€å·¦å‰ç¼€åŸåˆ™ï¼Œå°±æ˜¯æœ€å·¦ä¼˜å…ˆï¼Œåœ¨åˆ›å»ºå¤šåˆ—ç´¢å¼•æ—¶ï¼Œè¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œwhereå­å¥ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ä¸€åˆ—æ”¾åœ¨æœ€å·¦è¾¹ã€‚
- å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå¦‚(k1,k2,k3)ï¼Œç›¸å½“äºåˆ›å»ºäº†ï¼ˆk1ï¼‰ã€(k1,k2)å’Œ(k1,k2,k3)ä¸‰ä¸ªç´¢å¼•ï¼Œè¿™å°±æ˜¯æœ€å·¦åŒ¹é…åŸåˆ™ã€‚ã€‚

## 48.  Bæ ‘å’ŒB+æ ‘çš„åŒºåˆ«ï¼Œæ•°æ®åº“ä¸ºä»€ä¹ˆä½¿ç”¨B+æ ‘è€Œä¸æ˜¯Bæ ‘ï¼Ÿ

- åœ¨Bæ ‘ä¸­ï¼Œé”®å’Œå€¼å³å­˜æ”¾åœ¨å†…éƒ¨èŠ‚ç‚¹åˆå­˜æ”¾åœ¨å¶å­èŠ‚ç‚¹ï¼›åœ¨B+æ ‘ä¸­ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜é”®ï¼Œå¶å­èŠ‚ç‚¹åˆ™åŒæ—¶å­˜æ”¾é”®å’Œå€¼ã€‚
- B+æ ‘çš„å¶å­èŠ‚ç‚¹æœ‰ä¸€æ¡é“¾ç›¸è¿ï¼Œè€ŒBæ ‘çš„å¶å­èŠ‚ç‚¹å„è‡ªç‹¬ç«‹çš„ã€‚

- B+æ ‘ç´¢å¼•çš„æ‰€æœ‰æ•°æ®å‡å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œè€Œä¸”æ•°æ®æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„ï¼Œé“¾è¡¨è¿ç€çš„ã€‚é‚£ä¹ˆB+æ ‘ä½¿å¾—èŒƒå›´æŸ¥æ‰¾ï¼Œæ’åºæŸ¥æ‰¾ï¼Œåˆ†ç»„æŸ¥æ‰¾ä»¥åŠå»é‡æŸ¥æ‰¾å˜å¾—å¼‚å¸¸ç®€å•ã€‚.
- B+æ ‘éå¶å­èŠ‚ç‚¹ä¸Šæ˜¯ä¸å­˜å‚¨æ•°æ®çš„ï¼Œä»…å­˜å‚¨é”®å€¼ï¼Œè€ŒBæ ‘èŠ‚ç‚¹ä¸­ä¸ä»…å­˜å‚¨é”®å€¼ï¼Œä¹Ÿä¼šå­˜å‚¨æ•°æ®ã€‚innodbä¸­é¡µçš„é»˜è®¤å¤§å°æ˜¯16KBï¼Œå¦‚æœä¸å­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šå­˜å‚¨æ›´å¤šçš„é”®å€¼ï¼Œç›¸åº”çš„æ ‘çš„é˜¶æ•°ï¼ˆèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ ‘ï¼‰å°±ä¼šæ›´å¤§ï¼Œæ ‘å°±ä¼šæ›´çŸ®æ›´èƒ–ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬æŸ¥æ‰¾æ•°æ®è¿›è¡Œç£ç›˜çš„IOæ¬¡æ•°æœ‰ä¼šå†æ¬¡å‡å°‘ï¼Œæ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ä¹Ÿä¼šæ›´å¿«.


## 49.  è¦†ç›–ç´¢å¼•ã€å›è¡¨ç­‰è¿™äº›ï¼Œäº†è§£è¿‡å—ï¼Ÿ

- è¦†ç›–ç´¢å¼•ï¼š æŸ¥è¯¢åˆ—è¦è¢«æ‰€å»ºçš„ç´¢å¼•è¦†ç›–ï¼Œä¸å¿…ä»æ•°æ®è¡¨ä¸­è¯»å–ï¼Œæ¢å¥è¯è¯´æŸ¥è¯¢åˆ—è¦è¢«æ‰€ä½¿ç”¨çš„ç´¢å¼•è¦†ç›–ã€‚
- å›è¡¨ï¼šäºŒçº§ç´¢å¼•æ— æ³•ç›´æ¥æŸ¥è¯¢æ‰€æœ‰åˆ—çš„æ•°æ®ï¼Œæ‰€ä»¥é€šè¿‡äºŒçº§ç´¢å¼•æŸ¥è¯¢åˆ°èšç°‡ç´¢å¼•åï¼Œå†æŸ¥è¯¢åˆ°æƒ³è¦çš„æ•°æ®ï¼Œè¿™ç§é€šè¿‡äºŒçº§ç´¢å¼•æŸ¥è¯¢å‡ºæ¥çš„è¿‡ç¨‹ï¼Œå°±å«åšå›è¡¨ã€‚

## 50.  B+æ ‘åœ¨æ»¡è¶³èšç°‡ç´¢å¼•å’Œè¦†ç›–ç´¢å¼•çš„æ—¶å€™ä¸éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®ï¼Ÿ

- åœ¨B+æ ‘çš„ç´¢å¼•ä¸­ï¼Œå¶å­èŠ‚ç‚¹å¯èƒ½å­˜å‚¨äº†å½“å‰çš„keyå€¼ï¼Œä¹Ÿå¯èƒ½å­˜å‚¨äº†å½“å‰çš„keyå€¼ä»¥åŠæ•´è¡Œçš„æ•°æ®ï¼Œè¿™å°±æ˜¯èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ã€‚ åœ¨InnoDBä¸­ï¼Œåªæœ‰ä¸»é”®ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œåˆ™æŒ‘é€‰ä¸€ä¸ªå”¯ä¸€é”®å»ºç«‹èšç°‡ç´¢å¼•ã€‚å¦‚æœæ²¡æœ‰å”¯ä¸€é”®ï¼Œåˆ™éšå¼çš„ç”Ÿæˆä¸€ä¸ªé”®æ¥å»ºç«‹èšç°‡ç´¢å¼•ã€‚
- å½“æŸ¥è¯¢ä½¿ç”¨èšç°‡ç´¢å¼•æ—¶ï¼Œåœ¨å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œå¯ä»¥è·å–åˆ°æ•´è¡Œæ•°æ®ï¼Œå› æ­¤ä¸ç”¨å†æ¬¡è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚

## 51. ä½•æ—¶ä½¿ç”¨èšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼•

| åŠ¨ä½œæè¿° | ä½¿ç”¨èšé›†ç´¢å¼• | ä½¿ç”¨éèšé›†ç´¢å¼• |
| ------ | ------ |------ |
|åˆ—ç»å¸¸è¢«åˆ†ç»„æ’åº| åº” | åº”|
|è¿”å›æŸèŒƒå›´å†…çš„æ•°æ®| åº” |ä¸åº”|
|ä¸€ä¸ªæˆ–æå°‘ä¸åŒå€¼ | ä¸åº” | ä¸åº” | 
|å°æ•°ç›®çš„ä¸åŒå€¼|åº”|ä¸åº”
|å¤§æ•°ç›®çš„ä¸åŒå€¼|ä¸åº”|åº”
|é¢‘ç¹æ›´æ–°çš„åˆ—|ä¸åº”|åº”
|å¤–é”®åˆ—|åº”|åº”|
|ä¸»é”®åˆ—|åº”|åº”|
|é¢‘ç¹ä¿®æ”¹ç´¢å¼•åˆ—|ä¸åº”|åº”|

## 52.  éèšç°‡ç´¢å¼•ä¸€å®šä¼šå›è¡¨æŸ¥è¯¢å—ï¼Ÿ

ä¸ä¸€å®šï¼Œå¦‚æœæŸ¥è¯¢è¯­å¥çš„å­—æ®µå…¨éƒ¨å‘½ä¸­äº†ç´¢å¼•ï¼Œé‚£ä¹ˆå°±ä¸å¿…å†è¿›è¡Œå›è¡¨æŸ¥è¯¢ï¼ˆå“ˆå“ˆï¼Œè¦†ç›–ç´¢å¼•å°±æ˜¯è¿™ä¹ˆå›äº‹ï¼‰ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬åœ¨å­¦ç”Ÿè¡¨çš„ä¸Šå»ºç«‹äº†ç´¢å¼•ï¼Œé‚£ä¹ˆå½“è¿›è¡Œ`select age from student where age < 20`çš„æŸ¥è¯¢æ—¶ï¼Œåœ¨ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šï¼Œå·²ç»åŒ…å«äº†ageä¿¡æ¯ï¼Œä¸ä¼šå†æ¬¡è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚

## 53. ç»„åˆç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦æ³¨æ„ç»„åˆç´¢å¼•ä¸­çš„é¡ºåºï¼Ÿ

ç»„åˆç´¢å¼•ï¼Œç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç´¢å¼•,è¿™ç§ç´¢å¼•å«åšç»„åˆç´¢å¼•ã€‚
å› ä¸ºInnoDBå¼•æ“ä¸­çš„ç´¢å¼•ç­–ç•¥çš„æœ€å·¦åŸåˆ™ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„ç»„åˆç´¢å¼•ä¸­çš„é¡ºåºã€‚

## 54.  ä»€ä¹ˆæ˜¯æ•°æ®åº“äº‹åŠ¡ï¼Ÿ

æ•°æ®åº“äº‹åŠ¡ï¼ˆç®€ç§°ï¼šäº‹åŠ¡ï¼‰ï¼Œæ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ä¸ªæœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚

## 55.  éš”ç¦»çº§åˆ«ä¸é”çš„å…³ç³»

å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å…ˆé˜è¿°å››ç§éš”ç¦»çº§åˆ«ï¼Œå†é˜è¿°å®ƒä»¬çš„å®ç°åŸç†ã€‚éš”ç¦»çº§åˆ«å°±æ˜¯ä¾èµ–é”å’ŒMVCCå®ç°çš„ã€‚

## 56. æŒ‰ç…§é”çš„ç²’åº¦åˆ†ï¼Œæ•°æ®åº“é”æœ‰å“ªäº›å‘¢ï¼Ÿé”æœºåˆ¶ä¸InnoDBé”ç®—æ³•

![](../images/1724129062f57007.jpg)

- æŒ‰é”ç²’åº¦åˆ†æœ‰ï¼šè¡¨é”ï¼Œé¡µé”ï¼Œè¡Œé”
- æŒ‰é”æœºåˆ¶åˆ†æœ‰ï¼šä¹è§‚é”ï¼Œæ‚²è§‚é”

## 57.  ä»é”çš„ç±»åˆ«è§’åº¦è®²ï¼ŒMySQLéƒ½æœ‰å“ªäº›é”å‘¢ï¼Ÿ

ä»é”çš„ç±»åˆ«ä¸Šæ¥è®²ï¼Œæœ‰å…±äº«é”å’Œæ’ä»–é”ã€‚

- å…±äº«é”: åˆå«åšè¯»é”ã€‚å½“ç”¨æˆ·è¦è¿›è¡Œæ•°æ®çš„è¯»å–æ—¶ï¼Œå¯¹æ•°æ®åŠ ä¸Šå…±äº«é”ã€‚å…±äº«é”å¯ä»¥åŒæ—¶åŠ ä¸Šå¤šä¸ªã€‚
- æ’ä»–é”: åˆå«åšå†™é”ã€‚å½“ç”¨æˆ·è¦è¿›è¡Œæ•°æ®çš„å†™å…¥æ—¶ï¼Œå¯¹æ•°æ®åŠ ä¸Šæ’ä»–é”ã€‚æ’ä»–é”åªå¯ä»¥åŠ ä¸€ä¸ªï¼Œä»–å’Œå…¶ä»–çš„æ’ä»–é”ï¼Œå…±äº«é”éƒ½ç›¸æ–¥ã€‚

é”å…¼å®¹æ€§å¦‚ä¸‹ï¼š

![](../images/172412db1d202759.jpg)

## 58. MySQLä¸­InnoDBå¼•æ“çš„è¡Œé”æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

åŸºäºç´¢å¼•æ¥å®Œæˆè¡Œé”çš„ã€‚

```sql
select * from t where id = 666 for update;
```

for update å¯ä»¥æ ¹æ®æ¡ä»¶æ¥å®Œæˆè¡Œé”é”å®šï¼Œå¹¶ä¸” id æ˜¯æœ‰ç´¢å¼•é”®çš„åˆ—ï¼Œå¦‚æœ id ä¸æ˜¯ç´¢å¼•é”®é‚£ä¹ˆInnoDBå°†å®è¡Œè¡¨é”ã€‚

## 59.  ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ

æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€èµ„æºä¸Šç›¸äº’å ç”¨ï¼Œå¹¶è¯·æ±‚é”å®šå¯¹æ–¹çš„èµ„æºï¼Œä»è€Œå¯¼è‡´æ¶æ€§å¾ªç¯çš„ç°è±¡ã€‚çœ‹å›¾å½¢è±¡ä¸€ç‚¹ï¼Œå¦‚ä¸‹ï¼š

![](../images/17241317342078b9.jpg)

æ­»é”æœ‰å››ä¸ªå¿…è¦æ¡ä»¶ï¼šäº’æ–¥æ¡ä»¶ï¼Œè¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼Œç¯è·¯ç­‰å¾…æ¡ä»¶ï¼Œä¸å‰¥å¤ºæ¡ä»¶ã€‚
è§£å†³æ­»é”æ€è·¯ï¼Œä¸€èˆ¬å°±æ˜¯åˆ‡æ–­ç¯è·¯ï¼Œå°½é‡é¿å…å¹¶å‘å½¢æˆç¯è·¯ã€‚

- å¦‚æœä¸åŒç¨‹åºä¼šå¹¶å‘å­˜å–å¤šä¸ªè¡¨ï¼Œå°½é‡çº¦å®šä»¥ç›¸åŒçš„é¡ºåºè®¿é—®è¡¨ï¼Œå¯ä»¥å¤§å¤§é™ä½æ­»é”æœºä¼šã€‚
- åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå°½å¯èƒ½åšåˆ°ä¸€æ¬¡é”å®šæ‰€éœ€è¦çš„æ‰€æœ‰èµ„æºï¼Œå‡å°‘æ­»é”äº§ç”Ÿæ¦‚ç‡ï¼›
- å¯¹äºéå¸¸å®¹æ˜“äº§ç”Ÿæ­»é”çš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å‡çº§é”å®šé¢—ç²’åº¦ï¼Œé€šè¿‡è¡¨çº§é”å®šæ¥å‡å°‘æ­»é”äº§ç”Ÿçš„æ¦‚ç‡ï¼›
- å¦‚æœä¸šåŠ¡å¤„ç†ä¸å¥½å¯ä»¥ç”¨åˆ†å¸ƒå¼äº‹åŠ¡é”æˆ–è€…ä½¿ç”¨ä¹è§‚é”
- æ­»é”ä¸ç´¢å¼•å¯†ä¸å¯åˆ†ï¼Œè§£å†³ç´¢å¼•é—®é¢˜ï¼Œéœ€è¦åˆç†ä¼˜åŒ–ä½ çš„ç´¢å¼•ï¼Œ

## 60.  ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è§†å›¾ï¼Ÿä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è§†å›¾ï¼Ÿ

ä¸ºäº†æé«˜å¤æ‚SQLè¯­å¥çš„å¤ç”¨æ€§å’Œè¡¨æ“ä½œçš„å®‰å…¨æ€§ï¼ŒMySQLæ•°æ®åº“ç®¡ç†ç³»ç»Ÿæä¾›äº†è§†å›¾ç‰¹æ€§ã€‚

### ä»€ä¹ˆæ˜¯è§†å›¾ï¼Ÿ

è§†å›¾æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è¡¨ï¼Œæ˜¯ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ç»è¿‡æŸç§ç­›é€‰åçš„æ˜¾ç¤ºæ–¹å¼ï¼Œè§†å›¾ç”±ä¸€ä¸ªé¢„å®šä¹‰çš„æŸ¥è¯¢selectè¯­å¥ç»„æˆã€‚

## 61.  è§†å›¾æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿå“ªäº›ä½¿ç”¨åœºæ™¯ï¼Ÿ

### è§†å›¾ç‰¹ç‚¹ï¼š

- è§†å›¾çš„åˆ—å¯ä»¥æ¥è‡ªä¸åŒçš„è¡¨ï¼Œæ˜¯è¡¨çš„æŠ½è±¡å’Œåœ¨é€»è¾‘æ„ä¹‰ä¸Šå»ºç«‹çš„æ–°å…³ç³»ã€‚
- è§†å›¾æ˜¯ç”±åŸºæœ¬è¡¨(å®è¡¨)äº§ç”Ÿçš„è¡¨(è™šè¡¨)ã€‚
- è§†å›¾çš„å»ºç«‹å’Œåˆ é™¤ä¸å½±å“åŸºæœ¬è¡¨ã€‚
- å¯¹è§†å›¾å†…å®¹çš„æ›´æ–°(æ·»åŠ ï¼Œåˆ é™¤å’Œä¿®æ”¹)ç›´æ¥å½±å“åŸºæœ¬è¡¨ã€‚
- å½“è§†å›¾æ¥è‡ªå¤šä¸ªåŸºæœ¬è¡¨æ—¶ï¼Œä¸å…è®¸æ·»åŠ å’Œåˆ é™¤æ•°æ®ã€‚

**è§†å›¾ç”¨é€”ï¼š** ç®€åŒ–sqlæŸ¥è¯¢ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼Œå…¼å®¹è€çš„è¡¨ç»“æ„ã€‚

### è§†å›¾çš„å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š

- é‡ç”¨SQLè¯­å¥ï¼›
- ç®€åŒ–å¤æ‚çš„SQLæ“ä½œã€‚
- ä½¿ç”¨è¡¨çš„ç»„æˆéƒ¨åˆ†è€Œä¸æ˜¯æ•´ä¸ªè¡¨ï¼›
- ä¿æŠ¤æ•°æ®
- æ›´æ”¹æ•°æ®æ ¼å¼å’Œè¡¨ç¤ºã€‚è§†å›¾å¯è¿”å›ä¸åº•å±‚è¡¨çš„è¡¨ç¤ºå’Œæ ¼å¼ä¸åŒçš„æ•°æ®ã€‚

## 62.  è§†å›¾çš„ä¼˜ç‚¹ï¼Œç¼ºç‚¹ï¼Œè®²ä¸€ä¸‹ï¼Ÿ

- æŸ¥è¯¢ç®€å•åŒ–ã€‚è§†å›¾èƒ½ç®€åŒ–ç”¨æˆ·çš„æ“ä½œ
- æ•°æ®å®‰å…¨æ€§ã€‚è§†å›¾ä½¿ç”¨æˆ·èƒ½ä»¥å¤šç§è§’åº¦çœ‹å¾…åŒä¸€æ•°æ®ï¼Œèƒ½å¤Ÿå¯¹æœºå¯†æ•°æ®æä¾›å®‰å…¨ä¿æŠ¤
- é€»è¾‘æ•°æ®ç‹¬ç«‹æ€§ã€‚è§†å›¾å¯¹é‡æ„æ•°æ®åº“æä¾›äº†ä¸€å®šç¨‹åº¦çš„é€»è¾‘ç‹¬ç«‹æ€§

## 63.  count(1)ã€count(*) ä¸ count(åˆ—å) çš„åŒºåˆ«ï¼Ÿ

- count(*)åŒ…æ‹¬äº†æ‰€æœ‰çš„åˆ—ï¼Œç›¸å½“äºè¡Œæ•°ï¼Œåœ¨ç»Ÿè®¡ç»“æœçš„æ—¶å€™ï¼Œä¸ä¼šå¿½ç•¥åˆ—å€¼ä¸ºNULL
- count(1)åŒ…æ‹¬äº†å¿½ç•¥æ‰€æœ‰åˆ—ï¼Œç”¨1ä»£è¡¨ä»£ç è¡Œï¼Œåœ¨ç»Ÿè®¡ç»“æœçš„æ—¶å€™ï¼Œä¸ä¼šå¿½ç•¥åˆ—å€¼ä¸ºNULL
- count(åˆ—å)åªåŒ…æ‹¬åˆ—åé‚£ä¸€åˆ—ï¼Œåœ¨ç»Ÿè®¡ç»“æœçš„æ—¶å€™ï¼Œä¼šå¿½ç•¥åˆ—å€¼ä¸ºç©ºï¼ˆè¿™é‡Œçš„ç©ºä¸æ˜¯åªç©ºå­—ç¬¦ä¸²æˆ–è€…0ï¼Œè€Œæ˜¯è¡¨ç¤ºnullï¼‰çš„è®¡æ•°ï¼Œå³æŸä¸ªå­—æ®µå€¼ä¸ºNULLæ—¶ï¼Œä¸ç»Ÿè®¡ã€‚

## 64.  ä»€ä¹ˆæ˜¯æ¸¸æ ‡ï¼Ÿ

æ¸¸æ ‡æä¾›äº†ä¸€ç§å¯¹ä»è¡¨ä¸­æ£€ç´¢å‡ºçš„æ•°æ®è¿›è¡Œæ“ä½œçš„çµæ´»æ‰‹æ®µï¼Œå°±æœ¬è´¨è€Œè¨€ï¼Œæ¸¸æ ‡å®é™…ä¸Šæ˜¯ä¸€ç§èƒ½ä»åŒ…æ‹¬å¤šæ¡æ•°æ®è®°å½•çš„ç»“æœé›†ä¸­æ¯æ¬¡æå–ä¸€æ¡è®°å½•çš„æœºåˆ¶ã€‚

## 65.  ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹ï¼Ÿæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ

å­˜å‚¨è¿‡ç¨‹ï¼Œå°±æ˜¯ä¸€äº›ç¼–è¯‘å¥½äº†çš„SQLè¯­å¥ï¼Œè¿™äº›SQLè¯­å¥ä»£ç åƒä¸€ä¸ªæ–¹æ³•ä¸€æ ·å®ç°ä¸€äº›åŠŸèƒ½ï¼ˆå¯¹å•è¡¨æˆ–å¤šè¡¨çš„å¢åˆ æ”¹æŸ¥ï¼‰ï¼Œç„¶åç»™è¿™äº›ä»£ç å—å–ä¸€ä¸ªåå­—ï¼Œåœ¨ç”¨åˆ°è¿™ä¸ªåŠŸèƒ½çš„æ—¶å€™è°ƒç”¨å³å¯ã€‚

**ä¼˜ç‚¹ï¼š**

- å­˜å‚¨è¿‡ç¨‹æ˜¯ä¸€ä¸ªé¢„ç¼–è¯‘çš„ä»£ç å—ï¼Œæ‰§è¡Œæ•ˆç‡æ¯”è¾ƒé«˜
- å­˜å‚¨è¿‡ç¨‹åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œï¼Œå‡å°‘å®¢æˆ·ç«¯çš„å‹åŠ›
- å…è®¸æ¨¡å—åŒ–ç¨‹åºè®¾è®¡ï¼Œåªéœ€è¦åˆ›å»ºä¸€æ¬¡è¿‡ç¨‹ï¼Œä»¥ååœ¨ç¨‹åºä¸­å°±å¯ä»¥è°ƒç”¨è¯¥è¿‡ç¨‹ä»»æ„æ¬¡ï¼Œç±»ä¼¼æ–¹æ³•çš„å¤ç”¨
-ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹æ›¿ä»£å¤§é‡T_SQLè¯­å¥ ï¼Œå¯ä»¥é™ä½ç½‘ç»œé€šä¿¡é‡ï¼Œæé«˜é€šä¿¡é€Ÿç‡
- å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¡®ä¿æ•°æ®å®‰å…¨

**ç¼ºç‚¹ï¼š**

- è°ƒè¯•éº»çƒ¦
- å¯ç§»æ¤æ€§ä¸çµæ´»
- é‡æ–°ç¼–è¯‘é—®é¢˜

## 66.  ä»€ä¹ˆæ˜¯è§¦å‘å™¨ï¼Ÿè§¦å‘å™¨çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ

è§¦å‘å™¨ï¼ŒæŒ‡ä¸€æ®µä»£ç ï¼Œå½“è§¦å‘æŸä¸ªäº‹ä»¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œè¿™äº›ä»£ç ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**

- å¯ä»¥é€šè¿‡æ•°æ®åº“ä¸­çš„ç›¸å…³è¡¨å®ç°çº§è”æ›´æ”¹ã€‚
- å®æ—¶ç›‘æ§æŸå¼ è¡¨ä¸­çš„æŸä¸ªå­—æ®µçš„æ›´æ”¹è€Œéœ€è¦åšå‡ºç›¸åº”çš„å¤„ç†ã€‚
- ä¾‹å¦‚å¯ä»¥ç”ŸæˆæŸäº›ä¸šåŠ¡çš„ç¼–å·ã€‚
- æ³¨æ„ä¸è¦æ»¥ç”¨ï¼Œå¦åˆ™ä¼šé€ æˆæ•°æ®åº“åŠåº”ç”¨ç¨‹åºçš„ç»´æŠ¤å›°éš¾ã€‚

## 67.   MySQLä¸­éƒ½æœ‰å“ªäº›è§¦å‘å™¨ï¼Ÿ

MySQL æ•°æ®åº“ä¸­æœ‰å…­ç§è§¦å‘å™¨ï¼š

- Before Insert
- After Insert
- Before Update
- After Update
- Before Delete
- After Delete

## 68.   è¶…é”®ã€å€™é€‰é”®ã€ä¸»é”®ã€å¤–é”®åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- è¶…é”®ï¼šåœ¨å…³ç³»æ¨¡å¼ä¸­ï¼Œèƒ½å”¯ä¸€çŸ¥æ ‡è¯†å…ƒç»„çš„å±æ€§é›†ç§°ä¸ºè¶…é”®ã€‚
- å€™é€‰é”®ï¼šæ˜¯æœ€å°è¶…é”®ï¼Œå³æ²¡æœ‰å†—ä½™å…ƒç´ çš„è¶…é”®ã€‚
- ä¸»é”®ï¼šæ•°æ®åº“è¡¨ä¸­å¯¹å‚¨å­˜æ•°æ®å¯¹è±¡äºˆä»¥å”¯ä¸€å’Œå®Œæ•´æ ‡è¯†çš„æ•°æ®åˆ—æˆ–å±æ€§çš„ç»„åˆã€‚ä¸€ä¸ªæ•°æ®åˆ—åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸”ä¸»é”®çš„å–å€¼ä¸èƒ½ç¼ºå¤±ï¼Œå³ä¸èƒ½ä¸ºç©ºå€¼ï¼ˆNullï¼‰ã€‚
- å¤–é”®ï¼šåœ¨ä¸€ä¸ªè¡¨ä¸­å­˜åœ¨çš„å¦ä¸€ä¸ªè¡¨çš„ä¸»é”®ç§°æ­¤è¡¨çš„å¤–é”®ã€‚ã€‚

## 69.   SQL çº¦æŸæœ‰å“ªå‡ ç§å‘¢ï¼Ÿ

- NOT NULL: çº¦æŸå­—æ®µçš„å†…å®¹ä¸€å®šä¸èƒ½ä¸ºNULLã€‚
- UNIQUE: çº¦æŸå­—æ®µå”¯ä¸€æ€§ï¼Œä¸€ä¸ªè¡¨å…è®¸æœ‰å¤šä¸ª Unique çº¦æŸã€‚
- PRIMARY KEY: çº¦æŸå­—æ®µå”¯ä¸€ï¼Œä¸å¯é‡å¤ï¼Œä¸€ä¸ªè¡¨åªå…è®¸å­˜åœ¨ä¸€ä¸ªã€‚
- FOREIGN KEY: ç”¨äºé¢„é˜²ç ´åè¡¨ä¹‹é—´è¿æ¥çš„åŠ¨ä½œï¼Œä¹Ÿèƒ½é˜²æ­¢éæ³•æ•°æ®æ’å…¥å¤–é”®ã€‚
- CHECK: ç”¨äºæ§åˆ¶å­—æ®µçš„å€¼èŒƒå›´ã€‚

## 70.   è°ˆè°ˆå…­ç§å…³è”æŸ¥è¯¢ï¼Œä½¿ç”¨åœºæ™¯ã€‚

- äº¤å‰è¿æ¥
- å†…è¿æ¥
- å¤–è¿æ¥
- è”åˆæŸ¥è¯¢
- å…¨è¿æ¥
- äº¤å‰è¿æ¥

## 71.  varchar(50)ä¸­50çš„æ¶µä¹‰

å­—æ®µæœ€å¤šå­˜æ”¾ 50 ä¸ªå­—ç¬¦
å¦‚ varchar(50) å’Œ varchar(200) å­˜å‚¨ "jay" å­—ç¬¦ä¸²æ‰€å ç©ºé—´æ˜¯ä¸€æ ·çš„ï¼Œåè€…åœ¨æ’åºæ—¶ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜

## 72.   mysqlä¸­int(20)å’Œchar(20)ä»¥åŠvarchar(20)çš„åŒºåˆ«

- int(20) è¡¨ç¤ºå­—æ®µæ˜¯intç±»å‹ï¼Œæ˜¾ç¤ºé•¿åº¦æ˜¯ 20
- char(20)è¡¨ç¤ºå­—æ®µæ˜¯å›ºå®šé•¿åº¦å­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸º 20
- varchar(20) è¡¨ç¤ºå­—æ®µæ˜¯å¯å˜é•¿åº¦å­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸º 20

## 73.   dropã€deleteä¸truncateçš„åŒºåˆ«

| | 	delete |	truncate	| drop |
| ----- | ----- | ----- | ----- |
|ç±»å‹	| DML |	DDL	| DDL|
|å›æ»š	|å¯å›æ»š	|ä¸å¯å›æ»š|	ä¸å¯å›æ»š|
|åˆ é™¤å†…å®¹	|è¡¨ç»“æ„è¿˜åœ¨ï¼Œåˆ é™¤è¡¨çš„å…¨éƒ¨æˆ–è€…ä¸€éƒ¨åˆ†æ•°æ®è¡Œ	|è¡¨ç»“æ„è¿˜åœ¨ï¼Œåˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®|	ä»æ•°æ®åº“ä¸­åˆ é™¤è¡¨ï¼Œæ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç´¢å¼•å’Œæƒé™ä¹Ÿä¼šè¢«åˆ é™¤|
|åˆ é™¤é€Ÿåº¦	|åˆ é™¤é€Ÿåº¦æ…¢ï¼Œé€è¡Œåˆ é™¤	|åˆ é™¤é€Ÿåº¦å¿«|	åˆ é™¤é€Ÿåº¦æœ€å¿«|

## 74.   UNIONä¸UNION ALLçš„åŒºåˆ«ï¼Ÿ

- Unionï¼šå¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œï¼Œä¸åŒ…æ‹¬é‡å¤è¡Œï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™çš„æ’åºï¼›
- Union Allï¼šå¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œï¼ŒåŒ…æ‹¬é‡å¤è¡Œï¼Œä¸è¿›è¡Œæ’åºï¼›
- UNIONçš„æ•ˆç‡é«˜äº UNION ALL

## 75.  SQLçš„ç”Ÿå‘½å‘¨æœŸï¼Ÿ

- æœåŠ¡å™¨ä¸æ•°æ®åº“å»ºç«‹è¿æ¥
- æ•°æ®åº“è¿›ç¨‹æ‹¿åˆ°è¯·æ±‚sql
- è§£æå¹¶ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ‰§è¡Œ
- è¯»å–æ•°æ®åˆ°å†…å­˜ï¼Œå¹¶è¿›è¡Œé€»è¾‘å¤„ç†
- é€šè¿‡æ­¥éª¤ä¸€çš„è¿æ¥ï¼Œå‘é€ç»“æœåˆ°å®¢æˆ·ç«¯
- å…³æ‰è¿æ¥ï¼Œé‡Šæ”¾èµ„æº

## 76.  ä¸€æ¡Sqlçš„æ‰§è¡Œé¡ºåºï¼Ÿ

![](../images/17243f19b75d3514.jpg)

## 77.  åˆ—å€¼ä¸ºNULLæ—¶ï¼ŒæŸ¥è¯¢æ˜¯å¦ä¼šç”¨åˆ°ç´¢å¼•ï¼Ÿ

åˆ—å€¼ä¸ºNULLä¹Ÿæ˜¯å¯ä»¥èµ°ç´¢å¼•çš„
è®¡åˆ’å¯¹åˆ—è¿›è¡Œç´¢å¼•ï¼Œåº”å°½é‡é¿å…æŠŠå®ƒè®¾ç½®ä¸ºå¯ç©ºï¼Œå› ä¸ºè¿™ä¼šè®© MySQL éš¾ä»¥ä¼˜åŒ–å¼•ç”¨äº†å¯ç©ºåˆ—çš„æŸ¥è¯¢ï¼ŒåŒæ—¶å¢åŠ äº†å¼•æ“çš„å¤æ‚åº¦

## 78.   å…³å¿ƒè¿‡ä¸šåŠ¡ç³»ç»Ÿé‡Œé¢çš„sqlè€—æ—¶å—ï¼Ÿç»Ÿè®¡è¿‡æ…¢æŸ¥è¯¢å—ï¼Ÿå¯¹æ…¢æŸ¥è¯¢éƒ½æ€ä¹ˆä¼˜åŒ–è¿‡ï¼Ÿ

- æˆ‘ä»¬å¹³æ—¶å†™Sqlæ—¶ï¼Œéƒ½è¦å…»æˆç”¨explainåˆ†æçš„ä¹ æƒ¯ã€‚
- æ…¢æŸ¥è¯¢çš„ç»Ÿè®¡ï¼Œè¿ç»´ä¼šå®šæœŸç»Ÿè®¡ç»™æˆ‘ä»¬

**ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼š**

- åˆ†æè¯­å¥ï¼Œæ˜¯å¦åŠ è½½äº†ä¸å¿…è¦çš„å­—æ®µ/æ•°æ®ã€‚
- åˆ†æSQlæ‰§è¡Œå¥è¯ï¼Œæ˜¯å¦å‘½ä¸­ç´¢å¼•ç­‰ã€‚
- å¦‚æœSQLå¾ˆå¤æ‚ï¼Œä¼˜åŒ–SQLç»“æ„
- å¦‚æœè¡¨æ•°æ®é‡å¤ªå¤§ï¼Œè€ƒè™‘åˆ†è¡¨

## 79.  ä¸»é”®ä½¿ç”¨è‡ªå¢IDè¿˜æ˜¯UUIDï¼Œä¸ºä»€ä¹ˆï¼Ÿ

å¦‚æœæ˜¯å•æœºçš„è¯ï¼Œé€‰æ‹©è‡ªå¢IDï¼›å¦‚æœæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¼˜å…ˆè€ƒè™‘UUIDå§ï¼Œä½†è¿˜æ˜¯æœ€å¥½è‡ªå·±å…¬å¸æœ‰ä¸€å¥—åˆ†å¸ƒå¼å”¯ä¸€IDç”Ÿäº§æ–¹æ¡ˆå§ã€‚

- è‡ªå¢IDï¼šæ•°æ®å­˜å‚¨ç©ºé—´å°ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜ã€‚ä½†æ˜¯å¦‚æœæ•°æ®é‡è¿‡å¤§,ä¼šè¶…å‡ºè‡ªå¢é•¿çš„å€¼èŒƒå›´ï¼Œå¤šåº“åˆå¹¶ï¼Œä¹Ÿæœ‰å¯èƒ½æœ‰é—®é¢˜ã€‚
- uuidï¼šé€‚åˆå¤§é‡æ•°æ®çš„æ’å…¥å’Œæ›´æ–°æ“ä½œï¼Œä½†æ˜¯å®ƒæ— åºçš„ï¼Œæ’å…¥æ•°æ®æ•ˆç‡æ…¢ï¼Œå ç”¨ç©ºé—´å¤§ã€‚

## 80. mysqlè‡ªå¢ä¸»é”®ç”¨å®Œäº†æ€ä¹ˆåŠï¼Ÿ

è‡ªå¢ä¸»é”®ä¸€èˆ¬ç”¨intç±»å‹ï¼Œä¸€èˆ¬è¾¾ä¸åˆ°æœ€å¤§å€¼ï¼Œå¯ä»¥è€ƒè™‘æå‰åˆ†åº“åˆ†è¡¨çš„ã€‚

è‡ªå¢IDç”¨å®Œå ä¸€ç›´éƒ½æ˜¯æœ€å¤§å€¼ å¦‚æœæ ‡è¯†äº†ä¸»é”® åˆ™ä¸»é”®å†²çª

## 81. å­—æ®µä¸ºä»€ä¹ˆè¦æ±‚å®šä¹‰ä¸ºnot nullï¼Ÿ

nullå€¼ä¼šå ç”¨æ›´å¤šçš„å­—èŠ‚ï¼Œå¹¶ä¸”nullæœ‰å¾ˆå¤šå‘çš„ã€‚

## 82.  å¦‚æœè¦å­˜å‚¨ç”¨æˆ·çš„å¯†ç æ•£åˆ—ï¼Œåº”è¯¥ä½¿ç”¨ä»€ä¹ˆå­—æ®µè¿›è¡Œå­˜å‚¨ï¼Ÿ

å¯†ç æ•£åˆ—ï¼Œç›ï¼Œç”¨æˆ·èº«ä»½è¯å·ç­‰å›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œåº”è¯¥ä½¿ç”¨charè€Œä¸æ˜¯varcharæ¥å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç©ºé—´ä¸”æé«˜æ£€ç´¢æ•ˆç‡ã€‚

## 83. Mysqlé©±åŠ¨ç¨‹åºæ˜¯ä»€ä¹ˆï¼Ÿ

è¿™ä¸ªjaråŒ…ï¼š mysql-connector-java-5.1.18.jar
Mysqlé©±åŠ¨ç¨‹åºä¸»è¦å¸®åŠ©ç¼–ç¨‹è¯­è¨€ä¸ MySQLæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ï¼Œå¦‚è¿æ¥ã€ä¼ è¾“æ•°æ®ã€å…³é—­ç­‰ã€‚

## 84.   å¦‚ä½•ä¼˜åŒ–é•¿éš¾çš„æŸ¥è¯¢è¯­å¥ï¼Ÿæœ‰å®æˆ˜è¿‡å—ï¼Ÿ

- å°†ä¸€ä¸ªå¤§çš„æŸ¥è¯¢åˆ†ä¸ºå¤šä¸ªå°çš„ç›¸åŒçš„æŸ¥è¯¢
- å‡å°‘å†—ä½™è®°å½•çš„æŸ¥è¯¢ã€‚
- ä¸€ä¸ªå¤æ‚æŸ¥è¯¢å¯ä»¥è€ƒè™‘æ‹†æˆå¤šä¸ªç®€å•æŸ¥è¯¢
- åˆ†è§£å…³è”æŸ¥è¯¢ï¼Œè®©ç¼“å­˜çš„æ•ˆç‡æ›´é«˜ã€‚

## 85.  ä¼˜åŒ–ç‰¹å®šç±»å‹çš„æŸ¥è¯¢è¯­å¥

å¹³æ—¶ç§¯ç´¯å§ï¼š

- æ¯”å¦‚ä½¿ç”¨select å…·ä½“å­—æ®µä»£æ›¿ select *
- ä½¿ç”¨count(*) è€Œä¸æ˜¯count(åˆ—å)
- åœ¨ä¸å½±å“ä¸šåŠ¡çš„æƒ…å†µï¼Œä½¿ç”¨ç¼“å­˜
- explain åˆ†æä½ çš„SQL


## 86. MySQLæ•°æ®åº“cpué£™å‡çš„è¯ï¼Œè¦æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ

**æ’æŸ¥è¿‡ç¨‹ï¼š**

- ä½¿ç”¨top å‘½ä»¤è§‚å¯Ÿï¼Œç¡®å®šæ˜¯mysqldå¯¼è‡´è¿˜æ˜¯å…¶ä»–åŸå› ã€‚
- å¦‚æœæ˜¯mysqldå¯¼è‡´çš„ï¼Œshow processlistï¼ŒæŸ¥çœ‹sessionæƒ…å†µï¼Œç¡®å®šæ˜¯ä¸æ˜¯æœ‰æ¶ˆè€—èµ„æºçš„sqlåœ¨è¿è¡Œã€‚
- æ‰¾å‡ºæ¶ˆè€—é«˜çš„ sqlï¼Œçœ‹çœ‹æ‰§è¡Œè®¡åˆ’æ˜¯å¦å‡†ç¡®ï¼Œ ç´¢å¼•æ˜¯å¦ç¼ºå¤±ï¼Œæ•°æ®é‡æ˜¯å¦å¤ªå¤§ã€‚

**å¤„ç†ï¼š**

- kill æ‰è¿™äº›çº¿ç¨‹(åŒæ—¶è§‚å¯Ÿ cpu ä½¿ç”¨ç‡æ˜¯å¦ä¸‹é™)ï¼Œ
- è¿›è¡Œç›¸åº”çš„è°ƒæ•´(æ¯”å¦‚è¯´åŠ ç´¢å¼•ã€æ”¹ sqlã€æ”¹å†…å­˜å‚æ•°)
- é‡æ–°è·‘è¿™äº› SQLã€‚

**å…¶ä»–æƒ…å†µï¼š**

ä¹Ÿæœ‰å¯èƒ½æ˜¯æ¯ä¸ª sql æ¶ˆè€—èµ„æºå¹¶ä¸å¤šï¼Œä½†æ˜¯çªç„¶ä¹‹é—´ï¼Œæœ‰å¤§é‡çš„ session è¿è¿›æ¥å¯¼è‡´ cpu é£™å‡ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦è·Ÿåº”ç”¨ä¸€èµ·æ¥åˆ†æä¸ºä½•è¿æ¥æ•°ä¼šæ¿€å¢ï¼Œå†åšå‡ºç›¸åº”çš„è°ƒæ•´ï¼Œæ¯”å¦‚è¯´é™åˆ¶è¿æ¥æ•°ç­‰

## 87.   è¯»å†™åˆ†ç¦»å¸¸è§æ–¹æ¡ˆï¼Ÿ

- åº”ç”¨ç¨‹åºæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥åˆ¤æ–­ï¼Œå¢åˆ æ”¹ç­‰å†™æ“ä½œå‘½ä»¤å‘ç»™ä¸»åº“ï¼ŒæŸ¥è¯¢å‘½ä»¤å‘ç»™å¤‡åº“ã€‚
- åˆ©ç”¨ä¸­é—´ä»¶æ¥åšä»£ç†ï¼Œè´Ÿè´£å¯¹æ•°æ®åº“çš„è¯·æ±‚è¯†åˆ«å‡ºè¯»è¿˜æ˜¯å†™ï¼Œå¹¶åˆ†å‘åˆ°ä¸åŒçš„æ•°æ®åº“ä¸­ã€‚ï¼ˆå¦‚ï¼šamoebaï¼Œmysql-proxyï¼‰

## 88. MySQLçš„å¤åˆ¶åŸç†ä»¥åŠæµç¨‹

ä¸»ä»å¤åˆ¶åŸç†ï¼Œç®€è¨€ä¹‹ï¼Œå°±ä¸‰æ­¥æ›²ï¼Œå¦‚ä¸‹ï¼š

- ä¸»æ•°æ®åº“æœ‰ä¸ªbin-logäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œçºªå½•äº†æ‰€æœ‰å¢åˆ æ”¹Sqlè¯­å¥ã€‚ï¼ˆbinlogçº¿ç¨‹ï¼‰
- ä»æ•°æ®åº“æŠŠä¸»æ•°æ®åº“çš„bin-logæ–‡ä»¶çš„sqlè¯­å¥å¤åˆ¶è¿‡æ¥ã€‚ï¼ˆioçº¿ç¨‹ï¼‰
- ä»æ•°æ®åº“çš„relay-logé‡åšæ—¥å¿—æ–‡ä»¶ä¸­å†æ‰§è¡Œä¸€æ¬¡è¿™äº›sqlè¯­å¥ã€‚ï¼ˆSqlæ‰§è¡Œçº¿ç¨‹ï¼‰

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](../images/16c4d9dd1b8235c3.jpg)

ä¸Šå›¾ä¸»ä»å¤åˆ¶åˆ†äº†äº”ä¸ªæ­¥éª¤è¿›è¡Œï¼š

- æ­¥éª¤ä¸€ï¼šä¸»åº“çš„æ›´æ–°äº‹ä»¶(updateã€insertã€delete)è¢«å†™åˆ°binlog
- æ­¥éª¤äºŒï¼šä»åº“å‘èµ·è¿æ¥ï¼Œè¿æ¥åˆ°ä¸»åº“ã€‚
- æ­¥éª¤ä¸‰ï¼šæ­¤æ—¶ä¸»åº“åˆ›å»ºä¸€ä¸ªbinlog dump threadï¼ŒæŠŠbinlogçš„å†…å®¹å‘é€åˆ°ä»åº“ã€‚
- æ­¥éª¤å››ï¼šä»åº“å¯åŠ¨ä¹‹åï¼Œåˆ›å»ºä¸€ä¸ªI/Oçº¿ç¨‹ï¼Œè¯»å–ä¸»åº“ä¼ è¿‡æ¥çš„binlogå†…å®¹å¹¶å†™å…¥åˆ°relay log
- æ­¥éª¤äº”ï¼šè¿˜ä¼šåˆ›å»ºä¸€ä¸ªSQLçº¿ç¨‹ï¼Œä»relay logé‡Œé¢è¯»å–å†…å®¹ï¼Œä»Exec_Master_Log_Posä½ç½®å¼€å§‹æ‰§è¡Œè¯»å–åˆ°çš„æ›´æ–°äº‹ä»¶ï¼Œå°†æ›´æ–°å†…å®¹å†™å…¥åˆ°slaveçš„db

## 89.  MySQLä¸­DATETIMEå’ŒTIMESTAMPçš„åŒºåˆ«

å­˜å‚¨ç²¾åº¦éƒ½ä¸ºç§’

**åŒºåˆ«ï¼š**

- DATETIME çš„æ—¥æœŸèŒƒå›´æ˜¯ 1001â€”â€”9999 å¹´ï¼›TIMESTAMP çš„æ—¶é—´èŒƒå›´æ˜¯ 1970â€”â€”2038 å¹´
- DATETIME å­˜å‚¨æ—¶é—´ä¸æ—¶åŒºæ— å…³ï¼›TIMESTAMP å­˜å‚¨æ—¶é—´ä¸æ—¶åŒºæœ‰å…³ï¼Œæ˜¾ç¤ºçš„å€¼ä¹Ÿä¾èµ–äºæ—¶åŒº
- DATETIME çš„å­˜å‚¨ç©ºé—´ä¸º 8 å­—èŠ‚ï¼›TIMESTAMP çš„å­˜å‚¨ç©ºé—´ä¸º 4 å­—èŠ‚
- DATETIME çš„é»˜è®¤å€¼ä¸º nullï¼›TIMESTAMP çš„å­—æ®µé»˜è®¤ä¸ä¸ºç©º(not null)ï¼Œé»˜è®¤å€¼ä¸ºå½“å‰æ—¶é—´(CURRENT_TIMESTAMP)

## 90.   Innodbçš„äº‹åŠ¡å®ç°åŸç†ï¼Ÿ

- åŸå­æ€§ï¼šæ˜¯ä½¿ç”¨ undo logæ¥å®ç°çš„ï¼Œå¦‚æœäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™æˆ–è€…ç”¨æˆ·æ‰§è¡Œäº†rollbackï¼Œç³»ç»Ÿé€šè¿‡undo logæ—¥å¿—è¿”å›äº‹åŠ¡å¼€å§‹çš„çŠ¶æ€ã€‚
- æŒä¹…æ€§ï¼šä½¿ç”¨ redo logæ¥å®ç°ï¼Œåªè¦redo logæ—¥å¿—æŒä¹…åŒ–äº†ï¼Œå½“ç³»ç»Ÿå´©æºƒï¼Œå³å¯é€šè¿‡redo logæŠŠæ•°æ®æ¢å¤ã€‚
- éš”ç¦»æ€§ï¼šé€šè¿‡é”ä»¥åŠMVCC,ä½¿äº‹åŠ¡ç›¸äº’éš”ç¦»å¼€ã€‚
- ä¸€è‡´æ€§ï¼šé€šè¿‡å›æ»šã€æ¢å¤ï¼Œä»¥åŠå¹¶å‘æƒ…å†µä¸‹çš„éš”ç¦»æ€§ï¼Œä»è€Œå®ç°ä¸€è‡´æ€§ã€‚

## 91. è°ˆè°ˆMySQLçš„Explain

Explain æ‰§è¡Œè®¡åˆ’åŒ…å«å­—æ®µä¿¡æ¯å¦‚ä¸‹ï¼šåˆ†åˆ«æ˜¯ idã€select_typeã€tableã€partitionsã€typeã€possible_keysã€keyã€key_lenã€refã€rowsã€filteredã€Extra ç­‰12ä¸ªå­—æ®µã€‚
æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯typeï¼Œå®ƒçš„å±æ€§æ’åºå¦‚ä¸‹ï¼š

```sql
system  > const > eq_ref > ref  > ref_or_null >
index_merge > unique_subquery > index_subquery > 
range > index > ALL
```

## 92. Innodbçš„äº‹åŠ¡ä¸æ—¥å¿—çš„å®ç°æ–¹å¼


### æœ‰å¤šå°‘ç§æ—¥å¿—

- innodbä¸¤ç§æ—¥å¿—redoå’Œundoã€‚

### æ—¥å¿—çš„å­˜æ”¾å½¢å¼

- redoï¼šåœ¨é¡µä¿®æ”¹çš„æ—¶å€™ï¼Œå…ˆå†™åˆ° redo log buffer é‡Œé¢ï¼Œ ç„¶åå†™åˆ° redo log çš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜é‡Œé¢(fwrite)ï¼Œç„¶åå†åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ï¼ˆ fsyncï¼‰ã€‚
- Undoï¼šåœ¨ MySQL5.5 ä¹‹å‰ï¼Œ undo åªèƒ½å­˜æ”¾åœ¨ ibdataæ–‡ä»¶é‡Œé¢ï¼Œ 5.6 ä¹‹åï¼Œå¯ä»¥é€šè¿‡è®¾ç½® innodb_undo_tablespaces å‚æ•°æŠŠ undo log å­˜æ”¾åœ¨ ibdataä¹‹å¤–ã€‚

### äº‹åŠ¡æ˜¯å¦‚ä½•é€šè¿‡æ—¥å¿—æ¥å®ç°çš„

- å› ä¸ºäº‹åŠ¡åœ¨ä¿®æ”¹é¡µæ—¶ï¼Œè¦å…ˆè®° undoï¼Œåœ¨è®° undo ä¹‹å‰è¦è®° undo çš„ redoï¼Œ ç„¶åä¿®æ”¹æ•°æ®é¡µï¼Œå†è®°æ•°æ®é¡µä¿®æ”¹çš„ redoã€‚ Redoï¼ˆé‡Œé¢åŒ…æ‹¬ undo çš„ä¿®æ”¹ï¼‰ ä¸€å®šè¦æ¯”æ•°æ®é¡µå…ˆæŒä¹…åŒ–åˆ°ç£ç›˜ã€‚
- å½“äº‹åŠ¡éœ€è¦å›æ»šæ—¶ï¼Œå› ä¸ºæœ‰ undoï¼Œå¯ä»¥æŠŠæ•°æ®é¡µå›æ»šåˆ°å‰é•œåƒçš„ çŠ¶æ€ï¼Œå´©æºƒæ¢å¤æ—¶ï¼Œå¦‚æœ redo log ä¸­äº‹åŠ¡æ²¡æœ‰å¯¹åº”çš„ commit è®°å½•ï¼Œé‚£ä¹ˆéœ€è¦ç”¨ undoæŠŠè¯¥äº‹åŠ¡çš„ä¿®æ”¹å›æ»šåˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰ã€‚
- å¦‚æœæœ‰ commit è®°å½•ï¼Œå°±ç”¨ redo å‰æ»šåˆ°è¯¥äº‹åŠ¡å®Œæˆæ—¶å¹¶æäº¤æ‰ã€‚

## 93.  MySQLä¸­TEXTæ•°æ®ç±»å‹çš„æœ€å¤§é•¿åº¦

- TINYTEXTï¼š256 bytes
- TEXTï¼š65,535 bytes(64kb)
- MEDIUMTEXTï¼š16,777,215 bytes(16MB)
- LONGTEXTï¼š4,294,967,295 bytes(4GB)

## 94.  500å°dbï¼Œåœ¨æœ€å¿«æ—¶é—´ä¹‹å†…é‡å¯ã€‚

- å¯ä»¥ä½¿ç”¨æ‰¹é‡ ssh å·¥å…· pssh æ¥å¯¹éœ€è¦é‡å¯çš„æœºå™¨æ‰§è¡Œé‡å¯å‘½ä»¤ã€‚
- ä¹Ÿå¯ä»¥ä½¿ç”¨ saltï¼ˆå‰ææ˜¯å®¢æˆ·ç«¯æœ‰å®‰è£… saltï¼‰æˆ–è€… ansibleï¼ˆ ansible åªéœ€è¦ ssh å…ç™»é€šäº†å°±è¡Œï¼‰ç­‰å¤šçº¿ç¨‹å·¥å…·åŒæ—¶æ“ä½œå¤šå°æœåŠ¡

## 95. ä½ æ˜¯å¦‚ä½•ç›‘æ§ä½ ä»¬çš„æ•°æ®åº“çš„ï¼Ÿä½ ä»¬çš„æ…¢æ—¥å¿—éƒ½æ˜¯æ€ä¹ˆæŸ¥è¯¢çš„ï¼Ÿ

ç›‘æ§çš„å·¥å…·æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚zabbixï¼Œlepusï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯lepus

## 96. ä½ æ˜¯å¦åšè¿‡ä¸»ä»ä¸€è‡´æ€§æ ¡éªŒï¼Œå¦‚æœæœ‰ï¼Œæ€ä¹ˆåšçš„ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä½ æ‰“ç®—æ€ä¹ˆåšï¼Ÿ

ä¸»ä»ä¸€è‡´æ€§æ ¡éªŒæœ‰å¤šç§å·¥å…· ä¾‹å¦‚checksumã€mysqldiffã€pt-table-checksumç­‰

## 97. ä½ ä»¬æ•°æ®åº“æ˜¯å¦æ”¯æŒemojiè¡¨æƒ…å­˜å‚¨ï¼Œå¦‚æœä¸æ”¯æŒï¼Œå¦‚ä½•æ“ä½œï¼Ÿ

æ›´æ¢å­—ç¬¦é›†utf8-->utf8mb4

## 98.  MySQLå¦‚ä½•è·å–å½“å‰æ—¥æœŸï¼Ÿ

SELECT CURRENT_DATE();

## 99. ä¸€ä¸ª6äº¿çš„è¡¨aï¼Œä¸€ä¸ª3äº¿çš„è¡¨bï¼Œé€šè¿‡å¤–é—´tidå…³è”ï¼Œä½ å¦‚ä½•æœ€å¿«çš„æŸ¥è¯¢å‡ºæ»¡è¶³æ¡ä»¶çš„ç¬¬50000åˆ°ç¬¬50200ä¸­çš„è¿™200æ¡æ•°æ®è®°å½•ã€‚

1ã€å¦‚æœAè¡¨TIDæ˜¯è‡ªå¢é•¿,å¹¶ä¸”æ˜¯è¿ç»­çš„,Bè¡¨çš„IDä¸ºç´¢å¼•

```sql
select * from a,b where a.tid = b.id and a.tid>500000 limit 200;
```

2ã€å¦‚æœAè¡¨çš„TIDä¸æ˜¯è¿ç»­çš„,é‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨è¦†ç›–ç´¢å¼•.TIDè¦ä¹ˆæ˜¯ä¸»é”®,è¦ä¹ˆæ˜¯è¾…åŠ©ç´¢å¼•,Bè¡¨IDä¹Ÿéœ€è¦æœ‰ç´¢å¼•ã€‚

```sql
select * from b , (select tid from a limit 50000,200) a where b.id = a .tid;
```

## 100. Mysqlä¸€æ¡SQLåŠ é”åˆ†æ

ä¸€æ¡SQLåŠ é”ï¼Œå¯ä»¥åˆ†9ç§æƒ…å†µè¿›è¡Œï¼š

- ç»„åˆä¸€ï¼šidåˆ—æ˜¯ä¸»é”®ï¼ŒRCéš”ç¦»çº§åˆ«
- ç»„åˆäºŒï¼šidåˆ—æ˜¯äºŒçº§å”¯ä¸€ç´¢å¼•ï¼ŒRCéš”ç¦»çº§åˆ«
- ç»„åˆä¸‰ï¼šidåˆ—æ˜¯äºŒçº§éå”¯ä¸€ç´¢å¼•ï¼ŒRCéš”ç¦»çº§åˆ«
- ç»„åˆå››ï¼šidåˆ—ä¸Šæ²¡æœ‰ç´¢å¼•ï¼ŒRCéš”ç¦»çº§åˆ«
- ç»„åˆäº”ï¼šidåˆ—æ˜¯ä¸»é”®ï¼ŒRRéš”ç¦»çº§åˆ«
- ç»„åˆå…­ï¼šidåˆ—æ˜¯äºŒçº§å”¯ä¸€ç´¢å¼•ï¼ŒRRéš”ç¦»çº§åˆ«
- ç»„åˆä¸ƒï¼šidåˆ—æ˜¯äºŒçº§éå”¯ä¸€ç´¢å¼•ï¼ŒRRéš”ç¦»çº§åˆ«
- ç»„åˆå…«ï¼šidåˆ—ä¸Šæ²¡æœ‰ç´¢å¼•ï¼ŒRRéš”ç¦»çº§åˆ«
- ç»„åˆä¹ï¼šSerializableéš”ç¦»çº§åˆ«

>ä½œè€…ï¼šJay_huaxiao
>é“¾æ¥ï¼šhttps://juejin.im/post/5ec15ab9f265da7bc60e1910
>æ¥æºï¼šæ˜é‡‘
>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚


# MySQL InnoDB MVCC æœºåˆ¶çš„åŸç†åŠå®ç°


## MVCC æ˜¯ä»€ä¹ˆï¼Ÿ

### æ•°æ®åº“å¹¶å‘æ§åˆ¶â€”â€”é”

Multiversion (version) concurrency control (MCC or MVCC) å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ ï¼Œå®ƒæ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸€ç§å¸¸è§çš„å¹¶å‘æ§åˆ¶ã€‚
æˆ‘ä»¬çŸ¥é“å¹¶å‘æ§åˆ¶å¸¸ç”¨çš„æ˜¯é”ï¼Œå½“çº¿ç¨‹è¦å¯¹ä¸€ä¸ªå…±äº«èµ„æºè¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼ŒåŠ é”æ˜¯ä¸€ç§éå¸¸ç®€å•ç²—æš´çš„æ–¹æ³•(äº‹åŠ¡å¼€å§‹æ—¶ç»™ DQL åŠ è¯»é”ï¼Œç»™ DML åŠ å†™é”)ï¼Œè¿™ç§é”æ˜¯ä¸€ç§ æ‚²è§‚ çš„å®ç°æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¼šç»™å…¶ä»–äº‹åŠ¡é€ æˆå µå¡ï¼Œä»è€Œå½±å“æ•°æ®åº“æ€§èƒ½ã€‚
æˆ‘æ¥è§£é‡Šä¸€ä¸‹ ä¹è§‚é” å’Œ æ‚²è§‚é” çš„æ¦‚å¿µã€‚æˆ‘è§‰å¾—å®ƒä¿©ä¸»è¦æ˜¯æ¦‚å¿µçš„ç†è§£ã€‚

- æ‚²è§‚é”ï¼š å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦å¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆå¯¹å…±äº«èµ„æºè¿›è¡ŒåŠ é”ï¼Œå½“è¯¥çº¿ç¨‹æŒæœ‰è¯¥èµ„æºçš„é”çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¯¥èµ„æºè¿›è¡Œæ“ä½œçš„æ—¶å€™ä¼šè¢« é˜»å¡ã€‚æ¯”å¦‚ Java ä¸­çš„ Synchronized å…³é”®å­—ã€‚
- ä¹è§‚é”ï¼šå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦å¯¹ä¸€ä¸ªå…±äº«èµ„æºè¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œä¸å¯¹å®ƒè¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯åœ¨æ“ä½œå®Œæˆä¹‹åè¿›è¡Œåˆ¤æ–­ã€‚(æ¯”å¦‚ä¹è§‚é”ä¼šé€šè¿‡ä¸€ä¸ªç‰ˆæœ¬å·æ§åˆ¶ï¼Œå¦‚æœæ“ä½œå®Œæˆåé€šè¿‡ç‰ˆæœ¬å·è¿›è¡Œåˆ¤æ–­åœ¨è¯¥çº¿ç¨‹æ“ä½œè¿‡ç¨‹ä¸­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹å·²ç»å¯¹è¯¥å…±äº«èµ„æºè¿›è¡Œæ“ä½œäº†ï¼Œå¦‚æœæœ‰åˆ™é€šçŸ¥æ“ä½œå¤±è´¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ“ä½œæˆåŠŸ)ï¼Œå½“ç„¶é™¤äº† ç‰ˆæœ¬å· è¿˜æœ‰ CASï¼Œå¦‚æœä¸äº†è§£çš„å¯ä»¥å»å­¦ä¹ ä¸€ä¸‹ï¼Œè¿™é‡Œä¸åšè¿‡å¤šæ¶‰åŠã€‚

### æ•°æ®åº“å¹¶å‘æ§åˆ¶â€”â€”MVCC

å¾ˆå¤šäººè®¤ä¸º MVCC å°±æ˜¯ä¸€ç§ ä¹è§‚é” çš„å®ç°å½¢å¼ï¼Œè€Œæˆ‘è®¤ä¸º MVCC åªæ˜¯ä¸€ç§ ä¹è§‚ çš„å®ç°å½¢å¼ï¼Œå®ƒæ˜¯é€šè¿‡ ä¸€ç§ å¯è§æ€§ç®—æ³• æ¥å®ç°æ•°æ®åº“å¹¶å‘æ§åˆ¶ã€‚

### MVCC çš„ä¸¤ç§è¯»å½¢å¼

åœ¨è®² MVCC çš„å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘è§‰å¾ˆæœ‰å¿…è¦å…ˆå»äº†è§£ä¸€ä¸‹ MVCC çš„ä¸¤ç§è¯»å½¢å¼ã€‚

- å¿«ç…§è¯»ï¼šè¯»å–çš„åªæ˜¯å½“å‰äº‹åŠ¡çš„å¯è§ç‰ˆæœ¬ï¼Œä¸ç”¨åŠ é”ã€‚è€Œä½ åªè¦è®°ä½ ç®€å•çš„ select æ“ä½œå°±æ˜¯å¿«ç…§è¯»(select * from table where id = xxx)ã€‚
- å½“å‰è¯»ï¼šè¯»å–çš„æ˜¯å½“å‰ç‰ˆæœ¬ï¼Œæ¯”å¦‚ ç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ›´æ–°/æ’å…¥/åˆ é™¤æ“ä½œ

æ¯”å¦‚ï¼š

```sql
 select * from table where xxx lock in share modeï¼Œ
 select * from table where xxx for updateï¼Œ
 update table set....
 insert into table (xxx,xxx) values (xxx,xxx)
 delete from table where id = xxx
```

## MVCC çš„å®ç°åŸç†

MVCC ä½¿ç”¨äº†â€œä¸‰ä¸ªéšè—å­—æ®µâ€æ¥å®ç°ç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œæˆ‘æŸ¥äº†å¾ˆå¤šèµ„æ–™ï¼Œçœ‹åˆ°æœ‰å¾ˆå¤šåšå®¢ä¸Šå†™çš„æ˜¯é€šè¿‡ ä¸€ä¸ªåˆ›å»ºäº‹åŠ¡idå­—æ®µå’Œä¸€ä¸ªåˆ é™¤äº‹åŠ¡idå­—æ®µ æ¥æ§åˆ¶å®ç°çš„ã€‚ä½†åæ¥å‘ç°å¹¶ä¸æ˜¯å¾ˆæ­£ç¡®ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€çœ‹ MySQL åœ¨å»ºè¡¨çš„æ—¶å€™ innoDB åˆ›å»ºçš„çœŸæ­£çš„ä¸‰ä¸ªéšè—åˆ—å§ã€‚

|RowID	|DB_TRX_ID	|DB_ROLL_PTR|	id|	name	|password|
| ---- | ---- | ---- | ---- | ---- | ----|
|è‡ªåŠ¨åˆ›å»ºçš„id	|äº‹åŠ¡id	|å›æ»šæŒ‡é’ˆ|	id|	name|	password|

- RowIDï¼šéšè—çš„è‡ªå¢IDï¼Œå½“å»ºè¡¨æ²¡æœ‰æŒ‡å®šä¸»é”®ï¼ŒInnoDBä¼šä½¿ç”¨è¯¥RowIDåˆ›å»ºä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚
- DB_TRX_IDï¼šæœ€è¿‘ä¿®æ”¹ï¼ˆæ›´æ–°/åˆ é™¤/æ’å…¥ï¼‰è¯¥è®°å½•çš„äº‹åŠ¡IDã€‚
- DB_ROLL_PTRï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¿™æ¡è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚

> å…¶å®è¿˜æœ‰ä¸€ä¸ªåˆ é™¤çš„flagå­—æ®µï¼Œç”¨æ¥åˆ¤æ–­è¯¥è¡Œè®°å½•æ˜¯å¦å·²ç»è¢«åˆ é™¤ã€‚

è€Œ MVCC ä½¿ç”¨çš„æ˜¯å…¶ä¸­çš„ äº‹åŠ¡å­—æ®µï¼Œå›æ»šæŒ‡é’ˆå­—æ®µï¼Œæ˜¯å¦åˆ é™¤å­—æ®µã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç°åœ¨çš„è¡¨æ ¼(isDeleteæ˜¯æˆ‘è‡ªå·±å–çš„ï¼ŒæŒ‰ç…§å®˜æ–¹è¯´æ³•æ˜¯åœ¨ä¸€è¡Œå¼€å¤´çš„contenté‡Œé¢ï¼Œè¿™é‡Œå…¶å®ä½ç½®æ— æ‰€è°“ï¼Œä½ åªè¦çŸ¥é“æœ‰å°±è¡Œäº†)ã€‚


|isDelete	|DB_TRX_ID	|DB_ROLL_PTR|	id	|name	|password|
| ---- | ---- | ---- | ---- | ---- |---- |
|true/false|	äº‹åŠ¡id	|å›æ»šæŒ‡é’ˆ	|id|	name	|password|

é‚£ä¹ˆå¦‚ä½•é€šè¿‡è¿™ä¸‰ä¸ªå­—æ®µæ¥å®ç° MVCC çš„ å¯è§æ€§ç®—æ³• å‘¢ï¼Ÿ
è¿˜å·®ç‚¹ä¸œè¥¿ï¼ undoLog(å›æ»šæ—¥å¿—) å’Œ read-view(è¯»è§†å›¾)ã€‚


- undoLog: äº‹åŠ¡çš„å›æ»šæ—¥å¿—ï¼Œæ˜¯ å¯è§æ€§ç®—æ³• çš„éå¸¸é‡è¦çš„éƒ¨åˆ†ï¼Œåˆ†ä¸ºä¸¤ç±»ã€‚
    - insert undo logï¼šäº‹åŠ¡åœ¨æ’å…¥æ–°è®°å½•äº§ç”Ÿçš„undo logï¼Œå½“äº‹åŠ¡æäº¤ä¹‹åå¯ä»¥ç›´æ¥ä¸¢å¼ƒ
    - update undo logï¼šäº‹åŠ¡åœ¨è¿›è¡Œ update æˆ–è€… delete çš„æ—¶å€™äº§ç”Ÿçš„ undo logï¼Œåœ¨å¿«ç…§è¯»çš„æ—¶å€™è¿˜æ˜¯éœ€è¦çš„ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åˆ é™¤ï¼Œåªæœ‰å½“ç³»ç»Ÿæ²¡æœ‰æ¯”è¿™ä¸ªlogæ›´æ—©çš„read-viewäº†çš„æ—¶å€™æ‰èƒ½åˆ é™¤ã€‚psï¼šæ‰€ä»¥é•¿äº‹åŠ¡ä¼šäº§ç”Ÿå¾ˆå¤šè€çš„è§†å›¾å¯¼è‡´undo logæ— æ³•åˆ é™¤ å¤§é‡å ç”¨å­˜å‚¨ç©ºé—´ã€‚
- read-view: è¯»è§†å›¾ï¼Œæ˜¯MySQLç§’çº§åˆ›å»ºè§†å›¾çš„å¿…è¦æ¡ä»¶ï¼Œæ¯”å¦‚ä¸€ä¸ªäº‹åŠ¡åœ¨è¿›è¡Œ select æ“ä½œ(å¿«ç…§è¯»)çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ª read-view ï¼Œè¿™ä¸ªread-view å…¶å®åªæ˜¯ä¸‰ä¸ªå­—æ®µã€‚
    - alive_trx_list(æˆ‘è‡ªå·±å–çš„)ï¼šread-viewç”Ÿæˆæ—¶åˆ»ç³»ç»Ÿä¸­æ­£åœ¨æ´»è·ƒçš„äº‹åŠ¡idã€‚
    - up_limit_idï¼šè®°å½•ä¸Šé¢çš„ alive_trx_list ä¸­çš„æœ€å°äº‹åŠ¡idã€‚
    - low_limit_idï¼šread-viewç”Ÿæˆæ—¶åˆ»ï¼Œç›®å‰å·²å‡ºç°çš„äº‹åŠ¡IDçš„æœ€å¤§å€¼ + 1ã€‚



è¿™æ—¶å€™ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£äº†ã€‚ä¸‹é¢æˆ‘æ¥ä»‹ç»ä¸€ä¸‹ï¼Œæœ€é‡è¦çš„ å¯è§æ€§ç®—æ³•ã€‚
å…¶å®ä¸»è¦æ€è·¯å°±æ˜¯ï¼šå½“ç”Ÿæˆread-viewçš„æ—¶å€™å¦‚ä½•å»æ‹¿è·å–çš„ DB_TRX_ID å»å’Œ read-view ä¸­çš„ä¸‰ä¸ªå±æ€§(ä¸Šé¢è®²äº†)å»ä½œæ¯”è¾ƒã€‚æˆ‘æ¥è¯´ä¸€ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼Œå¦‚æœä¸æ˜¯å¾ˆç†è§£å¯ä»¥å‚è€ƒç€æˆ‘åé¢çš„å®è·µç»“åˆç€å»ç†è§£ã€‚

- é¦–å…ˆæ¯”è¾ƒè¿™æ¡è®°å½•çš„ DB_TRX_ID æ˜¯å¦æ˜¯ å°äº up_limit_id æˆ–è€… ç­‰äºå½“å‰äº‹åŠ¡idã€‚å¦‚æœæ»¡è¶³ï¼Œé‚£ä¹ˆè¯´æ˜å½“å‰äº‹åŠ¡èƒ½çœ‹åˆ°è¿™æ¡è®°å½•ã€‚å¦‚æœå¤§äºåˆ™è¿›å…¥ä¸‹ä¸€è½®åˆ¤æ–­
- ç„¶ååˆ¤æ–­è¿™æ¡è®°å½•çš„ DB_TRX_ID æ˜¯å¦ å¤§äºç­‰äº low-limit-idã€‚å¦‚æœå¤§äºç­‰äºåˆ™è¯´æ˜æ­¤äº‹åŠ¡æ— æ³•çœ‹è§è¯¥æ¡è®°å½•ï¼Œä¸ç„¶å°±è¿›å…¥ä¸‹ä¸€è½®åˆ¤æ–­ã€‚
- åˆ¤æ–­è¯¥æ¡è®°å½•çš„ DB_TRX_ID æ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡çš„æ•°ç»„ä¸­ï¼Œå¦‚æœåœ¨åˆ™è¯´æ˜è¿™æ¡è®°å½•è¿˜æœªæäº¤å¯¹äºå½“å‰æ“ä½œçš„äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œå¦‚æœä¸åœ¨åˆ™è¯´æ˜å·²ç»æäº¤ï¼Œé‚£ä¹ˆå°±æ˜¯å¯è§çš„ã€‚

> å¦‚æœæ­¤æ¡è®°å½•å¯¹äºè¯¥äº‹åŠ¡ä¸å¯è§ä¸” ROLL_PTR ä¸ä¸ºç©ºé‚£ä¹ˆå°±ä¼šæŒ‡å‘å›æ»šæŒ‡é’ˆçš„åœ°å€ï¼Œé€šè¿‡undologæ¥æŸ¥æ‰¾å¯è§çš„è®°å½•ç‰ˆæœ¬ã€‚

ä¸‹é¢æˆ‘ç”»äº†ä¸€ä¸ªå¯è§æ€§çš„ç®—æ³•çš„æµç¨‹å›¾

![](../images/16dddb3da13ee747.jpg)

## å®è·µ

### å‡†å¤‡æ•°æ®

é¦–å…ˆæˆ‘åˆ›å»ºäº†ä¸€ä¸ªéå¸¸ç®€å•çš„è¡¨ï¼Œåªæœ‰idå’Œnameçš„å­¦ç”Ÿè¡¨ã€‚

|id	|name|
|----|----|
|å­¦ç”Ÿid|	å­¦ç”Ÿå§“å|

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°†æˆ‘ä»¬éœ€è¦çš„éšè—åˆ—ä¹Ÿæ ‡è¯†å‡ºæ¥ï¼Œå°±å˜æˆäº†è¿™æ ·

|isDelete	|id|	|name	|DB_TRX_ID	|DB_ROLL_PTR|
|----|----|----|----|----|----|
|æ˜¯å¦è¢«åˆ é™¤	|å­¦ç”Ÿid	|å­¦ç”Ÿå§“å|	åˆ›å»ºåˆ é™¤æ›´æ–°è¯¥è®°å½•çš„äº‹åŠ¡id	|å›æ»šæŒ‡é’ˆ|

è¿™ä¸ªæ—¶å€™æ’å…¥ä¸‰è¡Œæ•°æ®ï¼Œå°†è¡¨çš„æ•°æ®å˜æˆä¸‹é¢è¿™ä¸ªæ ·å­ã€‚

|isDelete	|id|	name|	DB_TRX_ID|	DB_ROLL_PTR|
|----|----|----|----|----|
|false	|1	|å°æ˜	|1	|null
false	|2	|å°æ–¹	|1|	null
false	|3|	å°å¼ 	|1|	null

### ç¤ºä¾‹ä¸€

![](../images/16dddce6e7f823b4.jpg)

ä½¿ç”¨è¿‡ MySQL çš„éƒ½çŸ¥é“ï¼Œå› ä¸ºéš”ç¦»æ€§ï¼Œäº‹åŠ¡ B æ­¤æ—¶è·å–åˆ°çš„æ•°æ®è‚¯å®šæ˜¯è¿™æ ·çš„ã€‚

|id|	name|
|----|----|
1	|å°æ˜
2	|å°æ–¹
3	|å°å¼ 

ä¸ºä»€ä¹ˆäº‹åŠ¡Aæœªæäº¤çš„ä¿®æ”¹å¯¹äºäº‹åŠ¡Bæ˜¯ä¸å¯è§çš„ï¼ŒMVCC æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿæˆ‘ä»¬ç”¨åˆšåˆšçš„å¯è§æ€§ç®—æ³•æ¥å®éªŒä¸€ä¸‹ã€‚
é¦–å…ˆäº‹åŠ¡Aå¼€å¯äº†äº‹åŠ¡(å½“ç„¶è¿™ä¸ç®—å¼€å¯ï¼Œåœ¨RRæ¨¡å¼ä¸‹ çœŸæ­£è·å–read-viewçš„æ˜¯åœ¨è¿›è¡Œç¬¬ä¸€æ¬¡è¿›è¡Œå¿«ç…§è¯»çš„æ—¶å€™)ã€‚æˆ‘ä»¬å‡è®¾äº‹åŠ¡Açš„äº‹åŠ¡idä¸º2ï¼Œäº‹åŠ¡Bçš„idä¸º3ã€‚
ç„¶åäº‹åŠ¡Aè¿›è¡Œäº†æ›´æ–°æ“ä½œï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œæ›´æ–°æ“ä½œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬å¹¶ä¸”æ–°ç‰ˆæœ¬çš„å›æ»šæŒ‡é’ˆæŒ‡å‘äº†æ—§çš„ç‰ˆæœ¬(æ³¨æ„ undo logå…¶å®å­˜æ”¾çš„æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æˆ‘ç›´æ¥å†™æˆç‰©ç†æ—¥å¿—)ã€‚

![](../images/16ddddda50800f63.jpg)


æœ€å äº‹åŠ¡B è¿›è¡Œäº†å¿«ç…§è¯»ï¼Œæ³¨æ„ï¼Œè¿™æ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ã€‚

é¦–å…ˆï¼Œåœ¨è¿›è¡Œå¿«ç…§è¯»çš„æ—¶å€™æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª read-view (å¿˜è®°å›å»çœ‹ä¸€ä¸‹é‚£ä¸‰ä¸ªå­—æ®µ) è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„ read-view æ˜¯:
```bash
  up-limit-id = 2
  alive-trx-list = [2,3]
  low-limit-id = 4
```

ç„¶åæˆ‘ä»¬è·å–é‚£ä¸¤ä¸ªæ²¡æœ‰è¢«ä¿®æ”¹çš„è®°å½•(æ²¡æœ‰é¡ºåºï¼Œè¿™é‡Œä¸ºäº†ä¸€èµ·è§£é‡Šæ–¹ä¾¿), æˆ‘ä»¬è·å–åˆ°(2,å°æ–¹)å’Œ(3,å°å¼ )è¿™ä¸¤æ¡è®°å½•ï¼Œå‘ç°ä»–ä»¬ä¸¤çš„ `DB_TRX_ID = 1`,  æˆ‘ä»¬å…ˆåˆ¤æ–­ DB_TRX_ID æ˜¯å¦å°äº `up-limit-id` æˆ–è€…ç­‰äºå½“å‰äº‹åŠ¡id ,  å‘ç° 1<2 å°äº up-limit-id ï¼Œåˆ™å¯è§ ç›´æ¥è¿”å›è§†å›¾ã€‚
  
ç„¶åæˆ‘ä»¬è·å–æ›´æ”¹äº†çš„æ•°æ®è¡Œ:

![](../images/16ddddda50800f63.jpg)

å…¶å®ä½ ä¹Ÿå‘ç°äº†è¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ­¤æ—¶é“¾è¡¨å¤´çš„ DB_TRX_ID ä¸º 2,æˆ‘ä»¬è¿›è¡Œåˆ¤æ–­ 2 < 2 ä¸ç¬¦åˆï¼Œè¿›å…¥ä¸‹ä¸€æ­¥åˆ¤æ–­, åˆ¤æ–­ DB_TRX_ID >= low_limit_id å‘ç°æ­¤æ—¶æ˜¯ 2 >= 4 ä¸ç¬¦åˆ æ•…å†è¿›å…¥ä¸‹ä¸€æ­¥,æ­¤æ—¶åˆ¤æ–­ Db_TRX_ID æ˜¯å¦åœ¨ alive_trx_list æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­ï¼Œå‘ç°è¿™ä¸ª DB_TRX_ID åœ¨æ´»è·ƒåˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥åªèƒ½è¯´æ˜è¯¥è¡Œè®°å½•è¿˜æœªæäº¤ï¼Œä¸å¯è§ã€‚æœ€ç»ˆåˆ¤æ–­ä¸å¯è§ä¹‹åé€šè¿‡å›æ»šæŒ‡é’ˆæŸ¥çœ‹æ—§ç‰ˆæœ¬ï¼Œå‘ç°æ­¤æ—¶ DB_TRX_ID ä¸º1,æ•…å†æ¬¡è¿›è¡Œåˆ¤æ–­ DB_TRX_ID < up-limit-id ,æ­¤æ—¶ 1 < 2 ç¬¦åˆ ï¼Œæ‰€ä»¥å¯è§å¹¶è¿”å›, æ‰€ä»¥æœ€ç»ˆè¿”å›çš„æ˜¯

|id	|name|
|----|----|
1	|å°æ˜
2	|å°æ–¹
3	|å°å¼ 

æˆ‘ä»¬å†æ¥éªŒè¯ä¸€ä¸‹ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°†äº‹åŠ¡Aæäº¤ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªäº‹åŠ¡Cå¹¶selectã€‚

æˆ‘ä»¬é¢„æœŸçš„ç»“æœåº”è¯¥æ˜¯è¿™æ ·çš„

|id	|name|
|----|----|
1	|å°å¼º
2	|å°æ–¹
3	|å°å¼ 

è¿™ä¸ªæ“ä½œçš„æµç¨‹å›¾å¦‚ä¸‹

![](../images/16dde266675798b5.jpg)

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¥åˆ†æä¸€ä¸‹ äº‹åŠ¡cäº§ç”Ÿçš„ read-viewã€‚

è¿™ä¸ªæ—¶å€™äº‹åŠ¡Aå·²ç»æäº¤ï¼Œæ‰€ä»¥äº‹åŠ¡Aä¸åœ¨æ´»è·ƒäº‹åŠ¡æ•°ç»„ä¸­ï¼Œæ­¤æ—¶ read-view çš„ä¸‰ä¸ªå±æ€§åº”è¯¥æ˜¯

```bash
 up-limit-id = 3
 alive-trx-list = [3,4]
 low-limit-id = 5
```

- è·Ÿä¸Šé¢ä¸€æ ·ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–(2,å°æ–¹)å’Œ(3,å°å¼ )è¿™ä¸¤æ¡è®°å½•ï¼Œå‘ç°ä»–ä»¬ä¸¤çš„ DB_TRX_ID = 1ï¼Œæ­¤æ—¶ 1 < up-limit-id = 3ï¼Œæ•…ç¬¦åˆå¯è§æ€§ï¼Œåˆ™è¿”å›ã€‚
- ç„¶åæˆ‘ä»¬è·å–åˆšåˆšè¢«ä¿®æ”¹çš„idä¸º1çš„è®°å½•è¡Œï¼Œå‘ç°é“¾è¡¨å¤´éƒ¨çš„ DB_TRX_ID ä¸º 2, æ­¤æ—¶ 2 < up-limit-id = 3 æ•…ä¹Ÿç¬¦åˆå¯è§æ€§ï¼Œåˆ™è¿”å›ã€‚

æ‰€ä»¥æœ€ç»ˆè¿”å›çš„å°±æ˜¯

|id	|name|
|----|----|
1	|å°å¼º
2	|å°æ–¹
3	|å°å¼ 

### ç¤ºä¾‹äºŒ

ä¸ºäº†åŠ æ·±ç†è§£ï¼Œæˆ‘ä»¬å†ä½¿ç”¨ä¸€ä¸ªç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¤æ‚çš„ç¤ºä¾‹æ¥éªŒè¯ å¯è§æ€§ç®—æ³• ã€‚

![](../images/16dde33e7e6444f3.jpg)

é¦–å…ˆæˆ‘ä»¬åœ¨äº‹åŠ¡Aä¸­åˆ é™¤ä¸€æ¡è®°å½•ï¼Œè¿™ä¸ªæ—¶å€™å°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ã€‚

![](../images/16dde36171697ce0.jpg)

ç„¶åäº‹åŠ¡Bè¿›è¡Œäº†æ’å…¥ï¼Œè¿™æ ·å°±å˜æˆäº†ä¸‹é¢è¿™æ ·ã€‚

![](../images/16dde38e3d6c258f.jpg)

ç„¶åäº‹åŠ¡Bè¿›è¡Œäº† select æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° è¿™ä¸ªæ—¶å€™æ•´å¼ è¡¨å…¶å®ä¼šå˜æˆè¿™æ ·è®©è¿™ä¸ª select æ“ä½œè¿›è¡Œé€‰å–ã€‚

![](../images/16dde41e63808dc7.jpg)

æ­¤æ—¶çš„ read-view ä¸º

```bash
 up-limit-id = 2
 alive-trx-list = [2,3,4]
 low-limit-id = 5
```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿›è¡Œ å¿«ç…§è¯»ï¼Œé¦–å…ˆå¯¹äºå‰é¢ä¸¤æ¡å°æ˜å’Œå°æ–¹çš„è®°å½•æ˜¯ä¸€æ ·çš„ï¼Œæ­¤æ—¶ DB_TX_ID ä¸º 1ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­æ­¤æ—¶ DB_TX_ID = 1 < up-limit-id = 2 æˆç«‹æ•…è¿”å›ã€‚ç„¶ååˆ¤æ–­å°å¼ è¿™æ¡è®°å½•ï¼Œé¦–å…ˆä¹Ÿæ˜¯ DB_TX_ID = 2 < up-limit-id = 2 ä¸æˆç«‹æ•…è¿›å…¥ä¸‹ä¸€è½®ï¼ŒDB_TX_ID = 2 >= low-limit-id ä¸æˆç«‹å†è¿›å…¥æœ€åä¸€è½®åˆ¤æ–­æ˜¯å¦åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­ï¼Œå‘ç° DB_TX_ID = 2 åœ¨ alive-trx-list = [2,3,4] ä¸­æ•…ä¸å¯è§(å¦‚æœå¯è§åˆ™ä¼šçŸ¥é“å‰é¢çš„åˆ é™¤æ ‡å¿—æ˜¯å·²ç»åˆ é™¤ï¼Œåˆ™è¿”å›çš„æ˜¯ç©º)ï¼Œåˆ™æ ¹æ®å›æ»šæŒ‡é’ˆæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬è®°å½•ï¼Œæ­¤æ—¶ DB_TX_ID = 1 å’Œä¸Šé¢ä¸€æ ·å¯è§åˆ™è¿”å›è¯¥è¡Œã€‚
æœ€åä¸€ä¸ªåˆ¤æ–­å°äº®è¿™æ¡è®°å½•ï¼Œå› ä¸º DB_TX_ID = current_tx_id(å½“å‰äº‹åŠ¡id) æ‰€ä»¥å¯è§å¹¶è¿”å›ã€‚
è¿™ä¸ªæ—¶å€™è¿”å›çš„è¡¨åˆ™æ˜¯è¿™æ ·çš„


|id	|name|
|----|----|
1	|å°æ˜
2	|å°æ–¹
3	|å°å¼ 
4	|å°äº®

ç„¶åæ˜¯äº‹åŠ¡Aè¿›è¡Œäº†selectçš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ç°åœ¨çš„ read-view ä¸º

```bash
 up-limit-id = 2
 alive-trx-list = [2,3,4]
 low-limit-id = 5
```

ç„¶åæ­¤æ—¶æ‰€è§å’Œä¸Šé¢ä¹Ÿæ˜¯ä¸€æ ·çš„

![](../images/16dde41e63808dc7.jpg)

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿›è¡Œ å¿«ç…§è¯»ï¼Œé¦–å…ˆå¯¹äºå‰é¢ä¸¤æ¡å°æ˜å’Œå°æ–¹çš„è®°å½•æ˜¯ä¸€æ ·çš„ï¼Œæ­¤æ—¶ DB_TX_ID ä¸º 1ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­æ­¤æ—¶ DB_TX_ID = 1 < up-limit-id = 2 æˆç«‹æ•…è¿”å›ã€‚ç„¶ååˆ¤æ–­å°å¼ è¿™æ¡è®°å½•ï¼Œé¦–å…ˆ DB_TX_ID = 2 = current_tx_id = 2 æˆç«‹æ•…è¿”å›å‘ç°å‰é¢çš„ isDelete æ ‡å¿—ä¸ºtrue åˆ™è¯´æ˜å·²è¢«åˆ é™¤åˆ™è¿”å›ç©ºï¼Œå¯¹äºç¬¬å››æ¡å°äº®çš„ä¹Ÿæ˜¯ä¸€æ ·åˆ¤æ–­ DB_TX_ID = 4 < up-limit-id = 2 ä¸æˆç«‹è¿›å…¥ä¸‹ä¸€æ­¥åˆ¤æ–­ DB_TX_ID = 4 >= low-limit-id = 5 ä¸æˆç«‹è¿›å…¥æœ€åä¸€æ­¥å‘ç°åœ¨æ´»è·ƒäº‹åŠ¡æ•°ç»„ä¸­æ•…ä¸å¯è§ä¸”æ­¤æ¡è®°å½•å›æ»šæŒ‡é’ˆä¸ºnullæ‰€ä»¥è¿”å›ç©ºã€‚
é‚£ä¹ˆæ­¤æ—¶è¿”å›çš„åˆ—è¡¨åº”è¯¥å°±æ˜¯è¿™æ ·äº†

|id|	name|
|----|----|
1	|å°æ˜
2	|å°æ–¹

> è™½ç„¶è¦åˆ†æå¾ˆå¤šï¼Œä½†å¤šå¤šç›Šå–„å˜›ï¼Œå¤šç†Ÿæ‚‰ç†Ÿæ‚‰å°±èƒ½æ›´æ·±åˆ»ç†è§£è¿™ä¸ªç®—æ³•äº†ã€‚

ä¹‹åæ˜¯äº‹åŠ¡Cè¿›è¡Œ å¿«ç…§è¯» æ“ä½œã€‚é¦–å…ˆæ­¤æ—¶è§†å›¾è¿˜æ˜¯è¿™ä¸ªæ ·å­

![](../images/16dde41e63808dc7.jpg)

ç„¶åå¯¹äºäº‹åŠ¡Cçš„ read-view ä¸º

```bash
 up-limit-id = 2
 alive-trx-list = [2,3,4]
 low-limit-id = 5
```

å°æ˜å’Œå°æ–¹çš„ä¸¤æ¡è®°å½•å’Œä¸Šé¢ä¸€æ ·æ˜¯å¯è§çš„è¿™é‡Œæˆ‘å°±ä¸é‡å¤åˆ†æäº†ï¼Œç„¶åå¯¹äºå°å¼ è¿™æ¡è®°å½• DB_TX_ID = 2 < up-limit-id = 2 || DB_TX_ID == curent_tx_id = 4 ä¸æˆç«‹æ•…è¿›å…¥ä¸‹ä¸€è½®å‘ç° DB_TX_ID >= low-limit-id = 5 æ›´ä¸æˆç«‹æ•…è¿›å…¥æœ€åä¸€è½®å‘ç° DB_TX_ID = 2 åœ¨æ´»è·ƒäº‹åŠ¡æ•°ç»„ä¸­æ•…ä¸å¯è§ï¼Œç„¶åé€šè¿‡å›æ»šæŒ‡é’ˆåˆ¤æ–­ DB_TX_ID = 1 çš„å°å¼ è®°å½•å‘ç°å¯è§å¹¶è¿”å›ã€‚æœ€åçš„å°äº®ä¹Ÿæ˜¯å¦‚æ­¤ æœ€åä¼šå‘ç° DB_TX_ID = 3 ä¹Ÿåœ¨æ´»è·ƒäº‹åŠ¡æ•°ç»„ä¸­æ•…ä¸å¯è§ã€‚
æ‰€ä»¥äº‹åŠ¡C select çš„ç»“æœä¸º

|id|	name|
|----|----|
1	|å°æ˜
2	|å°æ–¹
3	|å°å¼ 

åé¢äº‹åŠ¡Aå’Œäº‹åŠ¡Béƒ½è¿›è¡Œäº†æäº¤çš„åŠ¨ä½œï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªäº‹åŠ¡Dè¿›è¡Œäº†å¿«ç…§è¯»ï¼Œæ­¤æ—¶è§†å›¾è¿˜æ˜¯å¦‚æ­¤

![](../images/16dde41e63808dc7.jpg)

ä½†æ­¤æ—¶çš„ read-viewå‘ç”Ÿäº†å˜åŒ–

```bash
 up-limit-id = 4
 alive-trx-list = [4,5]
 low-limit-id = 6
```

æˆ‘ä»¬é¦–å…ˆåˆ¤æ–­å°æ˜å’Œå°æ–¹çš„è®°å½•â€”â€”å¯è§(ä¸è§£é‡Šäº†)ï¼Œå°å¼ çš„è®°å½• DB_TX_ID = 2 < up-limit-id = 4 æˆç«‹æ•…å¯è§ï¼Œå› ä¸ºå‰é¢ isDelete ä¸º true åˆ™è¯´æ˜åˆ é™¤äº†è¿”å›ç©ºï¼Œç„¶åå°äº®çš„è®°å½• DB_TX_ID = 3 < up-limit-id = 4 æˆç«‹æ•…å¯è§åˆ™è¿”å›ã€‚æ‰€ä»¥è¿™æ¬¡çš„ select ç»“æœåº”è¯¥æ˜¯è¿™æ ·çš„

|id	|name|
|----|----|
1	|å°æ˜
2	|å°æ–¹
4	|å°äº®

æœ€å(çœŸçš„æœ€åäº†ï¼Œä¸å®¹æ˜“å§ï¼)ï¼Œäº‹åŠ¡Cæœ‰ä¸€æ¬¡è¿›è¡Œäº† select æ“ä½œã€‚å› ä¸ºåœ¨ RR æ¨¡å¼ä¸‹ read-view æ˜¯åœ¨ç¬¬ä¸€æ¬¡å¿«ç…§è¯»çš„æ—¶å€™ç¡®å®šçš„ï¼Œæ‰€ä»¥æ­¤æ—¶ read-viewæ˜¯ä¸ä¼šæ›´æ”¹çš„ï¼Œç„¶åå‰é¢è§†å›¾ä¹Ÿæ²¡æœ‰è¿›è¡Œæ›´æ”¹ï¼Œæ‰€ä»¥æ­¤æ—¶å³ä½¿å‰é¢äº‹åŠ¡A äº‹åŠ¡Bå·²ç»è¿›è¡Œäº†æäº¤ï¼Œå¯¹äºè¿™ä¸ªæ—¶å€™çš„äº‹åŠ¡Cçš„selectç»“æœæ˜¯æ²¡æœ‰å½±å“çš„ã€‚æ•…ç»“æœåº”è¯¥ä¸º



|id|name|
|----|----|
1|å°æ˜
2|å°æ–¹
3|å°å¼ 

æ€»ç»“
æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å§ã€‚

å…¶å® MVCC æ˜¯é€šè¿‡ "ä¸‰ä¸ª" éšè—å­—æ®µ (äº‹åŠ¡id,å›æ»šæŒ‡é’ˆ,åˆ é™¤æ ‡å¿—) åŠ ä¸Šundo logå’Œå¯è§æ€§ç®—æ³•æ¥å®ç°çš„ç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚

ä¸ºäº†ä½ å†æ¬¡æ·±å…¥ç†è§£è¿™ä¸ªç®—æ³•ï¼Œæˆ‘å†æŠŠè¿™å¼ å›¾æŒ‚ä¸Šæ¥

![](../images/16dddb3da13ee747.jpg)


>ä½œè€…ï¼šFrancisQ
>é“¾æ¥ï¼šhttps://juejin.im/post/5da8493ae51d4524b25add55
>æ¥æºï¼šæ˜é‡‘
>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚## MySQL
### 1.äº‹åŠ¡

æ•°æ®åº“äº‹åŠ¡(Database Transaction) ï¼Œæ˜¯æŒ‡ä½œä¸ºå•ä¸ªé€»è¾‘å·¥ä½œå•å…ƒæ‰§è¡Œçš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå®Œå…¨åœ°æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨åœ°ä¸æ‰§è¡Œã€‚
å½»åº•ç†è§£æ•°æ®åº“äº‹åŠ¡: http://www.hollischuang.com/archives/898

### 2.æ•°æ®åº“ç´¢å¼•

[MySQLç´¢å¼•èƒŒåçš„æ•°æ®ç»“æ„åŠç®—æ³•åŸç†](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)

[é¢è¯•ä¸­å¸¸è¢«æåˆ°çš„æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™](https://www.cnblogs.com/ljl150/p/12934071.html)

èšé›†ç´¢å¼•,éèšé›†ç´¢å¼•,B-Tree,B+Tree,æœ€å·¦å‰ç¼€åŸç†

### 3.ä¹è§‚é”å’Œæ‚²è§‚é”

æ‚²è§‚é”ï¼šå‡å®šä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œå±è”½ä¸€åˆ‡å¯èƒ½è¿åæ•°æ®å®Œæ•´æ€§çš„æ“ä½œ

ä¹è§‚é”ï¼šå‡è®¾ä¸ä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œåªåœ¨æäº¤æ“ä½œæ—¶æ£€æŸ¥æ˜¯å¦è¿åæ•°æ®å®Œæ•´æ€§ã€‚

ä¹è§‚é”ä¸æ‚²è§‚é”çš„å…·ä½“åŒºåˆ«: https://juejin.cn/post/6844903639207641096#heading-1

### 4.MVCC

> â€‹	å…¨ç§°æ˜¯Multi-Version Concurrent Controlï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œåœ¨MVCCåè®®ä¸‹ï¼Œæ¯ä¸ªè¯»æ“ä½œä¼šçœ‹åˆ°ä¸€ä¸ªä¸€è‡´æ€§çš„snapshotï¼Œå¹¶ä¸”å¯ä»¥å®ç°éé˜»å¡çš„è¯»ã€‚MVCCå…è®¸æ•°æ®å…·æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬å¯ä»¥æ˜¯æ—¶é—´æˆ³æˆ–è€…æ˜¯å…¨å±€é€’å¢çš„äº‹åŠ¡IDï¼Œåœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œä¸åŒçš„äº‹åŠ¡çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸åŒçš„ã€‚

### [MySQL](http://lib.csdn.net/base/mysql)çš„innodbå¼•æ“æ˜¯å¦‚ä½•å®ç°MVCCçš„

innodbä¼šä¸ºæ¯ä¸€è¡Œæ·»åŠ ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«è¡¨ç¤ºè¯¥è¡Œ**åˆ›å»ºçš„ç‰ˆæœ¬**å’Œ**åˆ é™¤çš„ç‰ˆæœ¬**ï¼Œå¡«å…¥çš„æ˜¯äº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œè¿™ä¸ªç‰ˆæœ¬å·éšç€äº‹åŠ¡çš„åˆ›å»ºä¸æ–­é€’å¢ã€‚åœ¨repeated readçš„éš”ç¦»çº§åˆ«ï¼ˆ[äº‹åŠ¡çš„éš”ç¦»çº§åˆ«è¯·çœ‹è¿™ç¯‡æ–‡ç« ](http://blog.csdn.net/chosen0ne/article/details/10036775)ï¼‰ä¸‹ï¼Œå…·ä½“å„ç§æ•°æ®åº“æ“ä½œçš„å®ç°ï¼š

- selectï¼šæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶innodbä¼šè¿”å›è¯¥è¡Œæ•°æ®ï¼š
  - è¯¥è¡Œçš„åˆ›å»ºç‰ˆæœ¬å·å°äºç­‰äºå½“å‰ç‰ˆæœ¬å·ï¼Œç”¨äºä¿è¯åœ¨selectæ“ä½œä¹‹å‰æ‰€æœ‰çš„æ“ä½œå·²ç»æ‰§è¡Œè½åœ°ã€‚
  - è¯¥è¡Œçš„åˆ é™¤ç‰ˆæœ¬å·å¤§äºå½“å‰ç‰ˆæœ¬æˆ–è€…ä¸ºç©ºã€‚åˆ é™¤ç‰ˆæœ¬å·å¤§äºå½“å‰ç‰ˆæœ¬æ„å‘³ç€æœ‰ä¸€ä¸ªå¹¶å‘äº‹åŠ¡å°†è¯¥è¡Œåˆ é™¤äº†ã€‚
- insertï¼šå°†æ–°æ’å…¥çš„è¡Œçš„åˆ›å»ºç‰ˆæœ¬å·è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿçš„ç‰ˆæœ¬å·ã€‚
- deleteï¼šå°†è¦åˆ é™¤çš„è¡Œçš„åˆ é™¤ç‰ˆæœ¬å·è®¾ç½®ä¸ºå½“å‰ç³»ç»Ÿçš„ç‰ˆæœ¬å·ã€‚
- updateï¼šä¸æ‰§è¡ŒåŸåœ°updateï¼Œè€Œæ˜¯è½¬æ¢æˆinsert + deleteã€‚å°†æ—§è¡Œçš„åˆ é™¤ç‰ˆæœ¬å·è®¾ç½®ä¸ºå½“å‰ç‰ˆæœ¬å·ï¼Œå¹¶å°†æ–°è¡ŒinsertåŒæ—¶è®¾ç½®åˆ›å»ºç‰ˆæœ¬å·ä¸ºå½“å‰ç‰ˆæœ¬å·ã€‚

å…¶ä¸­ï¼Œå†™æ“ä½œï¼ˆinsertã€deleteå’Œupdateï¼‰æ‰§è¡Œæ—¶ï¼Œéœ€è¦å°†ç³»ç»Ÿç‰ˆæœ¬å·é€’å¢ã€‚

â€‹ç”±äºæ—§æ•°æ®å¹¶ä¸çœŸæ­£çš„åˆ é™¤ï¼Œæ‰€ä»¥å¿…é¡»å¯¹è¿™äº›æ•°æ®è¿›è¡Œæ¸…ç†ï¼Œinnodbä¼šå¼€å¯ä¸€ä¸ªåå°çº¿ç¨‹æ‰§è¡Œæ¸…ç†å·¥ä½œï¼Œå…·ä½“çš„è§„åˆ™æ˜¯å°†åˆ é™¤ç‰ˆæœ¬å·å°äºå½“å‰ç³»ç»Ÿç‰ˆæœ¬çš„è¡Œåˆ é™¤ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšpurgeã€‚

é€šè¿‡MVCCå¾ˆå¥½çš„å®ç°äº†äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œå¯ä»¥è¾¾åˆ°repeated readçº§åˆ«ï¼Œè¦å®ç°serializableè¿˜å¿…é¡»åŠ é”ã€‚

å‚è€ƒï¼š[MVCCæµ…æ](http://blog.csdn.net/chosen0ne/article/details/18093187)

### 5.MyISAMå’ŒInnoDB

MyISAM é€‚åˆäºä¸€äº›éœ€è¦å¤§é‡æŸ¥è¯¢çš„åº”ç”¨ï¼Œä½†å…¶å¯¹äºæœ‰å¤§é‡å†™æ“ä½œå¹¶ä¸æ˜¯å¾ˆå¥½ã€‚ç”šè‡³ä½ åªæ˜¯éœ€è¦updateä¸€ä¸ªå­—æ®µï¼Œæ•´ä¸ªè¡¨éƒ½ä¼šè¢«é”èµ·æ¥ï¼Œè€Œåˆ«çš„è¿›ç¨‹ï¼Œå°±ç®—æ˜¯è¯»è¿›ç¨‹éƒ½æ— æ³•æ“ä½œç›´åˆ°è¯»æ“ä½œå®Œæˆã€‚å¦å¤–ï¼ŒMyISAM å¯¹äº SELECT COUNT(*) è¿™ç±»çš„è®¡ç®—æ˜¯è¶…å¿«æ— æ¯”çš„ã€‚

InnoDB çš„è¶‹åŠ¿ä¼šæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„å­˜å‚¨å¼•æ“ï¼Œå¯¹äºä¸€äº›å°çš„åº”ç”¨ï¼Œå®ƒä¼šæ¯” MyISAM è¿˜æ…¢ã€‚ä»–æ˜¯å®ƒæ”¯æŒâ€œè¡Œé”â€ ï¼Œäºæ˜¯åœ¨å†™æ“ä½œæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œä¼šæ›´ä¼˜ç§€ã€‚å¹¶ä¸”ï¼Œä»–è¿˜æ”¯æŒæ›´å¤šçš„é«˜çº§åº”ç”¨ï¼Œæ¯”å¦‚ï¼šäº‹åŠ¡ã€‚

mysql æ•°æ®åº“å¼•æ“: http://www.cnblogs.com/0201zcr/p/5296843.html
MySQLå­˜å‚¨å¼•æ“ï¼ï¼MyISAMä¸InnoDBåŒºåˆ«: https://segmentfault.com/a/1190000008227211

### 6.ä¸»é”® è¶…é”® å€™é€‰é”® å¤–é”®

ä¸»é”®ï¼šæ•°æ®åº“è¡¨ä¸­å¯¹å­˜å‚¨æ•°æ®å¯¹è±¡äºˆä»¥å”¯ä¸€å’Œå®Œæ•´æ ‡è¯†çš„æ•°æ®åˆ—æˆ–å±æ€§çš„ç»„åˆã€‚ä¸€ä¸ªæ•°æ®åˆ—åªèƒ½æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸”ä¸»é”®çš„å–å€¼ä¸èƒ½ç¼ºå¤±ï¼Œå³ä¸èƒ½ä¸ºç©ºå€¼(Null).

è¶…é”®ï¼šåœ¨å…³ç³»ä¸­èƒ½å”¯ä¸€æ ‡è¯†å…ƒç»„çš„å±æ€§é›†ç§°ä¸ºå…³ç³»æ¨¡å¼çš„è¶…é”®ã€‚ä¸€ä¸ªå±æ€§å¯ä»¥ä½œä¸ºä¸€ä¸ªè¶…é”®ï¼Œå¤šä¸ªå±æ€§ç»„åˆåœ¨ä¸€èµ·ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªè¶…é”®ã€‚è¶…é”®åŒ…å«å€™é€‰é”®å’Œä¸»é”®ã€‚

å€™é€‰é”®ï¼šæ˜¯æœ€å°è¶…é”®ï¼Œå³æ²¡æœ‰å†—ä½™å…ƒç´ çš„è¶…é”®ã€‚

å¤–é”®ï¼šåœ¨ä¸€ä¸ªè¡¨ä¸­å­˜åœ¨çš„å¦ä¸€ä¸ªè¡¨çš„ä¸»é”®ç§°æ­¤è¡¨çš„å¤–é”®ã€‚

### 7.è§†å›¾çš„ä½œç”¨ï¼Œè§†å›¾å¯ä»¥æ›´æ”¹ä¹ˆï¼Ÿ

è§†å›¾æ˜¯è™šæ‹Ÿçš„è¡¨ï¼Œä¸åŒ…å«æ•°æ®çš„è¡¨ä¸ä¸€æ ·ï¼Œè§†å›¾åªåŒ…å«ä½¿ç”¨æ—¶åŠ¨æ€æ£€ç´¢æ•°æ®çš„æŸ¥è¯¢;ä¸åŒ…å«ä»»ä½•åˆ—æˆ–æ•°æ®ã€‚ä½¿ç”¨è§†å›¾å¯ä»¥ç®€åŒ–å¤æ‚çš„sqlæ“ä½œï¼Œéšè—å…·ä½“çš„ç»†èŠ‚ï¼Œä¿æŠ¤æ•°æ®;è§†å›¾åˆ›å»ºåï¼Œå¯ä»¥ä½¿ç”¨ä¸è¡¨ç›¸åŒçš„æ–¹å¼åˆ©ç”¨å®ƒä»¬ã€‚

è§†å›¾ä¸èƒ½è¢«ç´¢å¼•ï¼Œä¹Ÿä¸èƒ½æœ‰å…³è”çš„è§¦å‘å™¨æˆ–é»˜è®¤å€¼ï¼Œå¦‚æœè§†å›¾æœ¬èº«å†…æœ‰order byåˆ™å¯¹è§†å›¾å†æ¬¡order byå°†è¢«è¦†ç›–ã€‚

åˆ›å»ºè§†å›¾ï¼š create view xxx as xxxxxx

å¯¹äºæŸäº›è§†å›¾æ¯”å¦‚æœªä½¿ç”¨è”ç»“å­æŸ¥è¯¢åˆ†ç»„èšé›†å‡½æ•°Distinct Unionç­‰ï¼Œæ˜¯å¯ä»¥å¯¹å…¶æ›´æ–°çš„ï¼Œå¯¹è§†å›¾çš„æ›´æ–°å°†å¯¹åŸºè¡¨è¿›è¡Œæ›´æ–°;ä½†æ˜¯è§†å›¾ä¸»è¦ç”¨äºç®€åŒ–æ£€ç´¢ï¼Œä¿æŠ¤æ•°æ®ï¼Œå¹¶ä¸ç”¨äºæ›´æ–°ï¼Œè€Œä¸”å¤§éƒ¨åˆ†è§†å›¾éƒ½ä¸å¯ä»¥æ›´æ–°ã€‚

### 8.drop,deleteä¸truncateçš„åŒºåˆ«

dropç›´æ¥åˆ æ‰è¡¨ï¼Œtruncateåˆ é™¤è¡¨ä¸­æ•°æ®ï¼Œå†æ’å…¥æ—¶è‡ªå¢é•¿idåˆä»1å¼€å§‹ï¼Œdeleteåˆ é™¤è¡¨ä¸­æ•°æ®ï¼Œå¯ä»¥åŠ whereå­—å¥ã€‚

1.delete è¯­å¥æ‰§è¡Œåˆ é™¤çš„è¿‡ç¨‹æ˜¯æ¯æ¬¡ä»è¡¨ä¸­åˆ é™¤ä¸€è¡Œï¼Œå¹¶ä¸”åŒæ—¶å°†è¯¥è¡Œçš„åˆ é™¤æ“ä½œä½œä¸ºäº‹åŠ¡è®°å½•åœ¨æ—¥å¿—ä¸­ä¿å­˜ä»¥ä¾¿è¿›è¡Œå›æ»šæ“ä½œã€‚truncate tableåˆ™ä¸€æ¬¡æ€§åœ°ä»è¡¨ä¸­åˆ é™¤æ‰€æœ‰çš„æ•°æ®å¹¶ä¸æŠŠå•ç‹¬çš„åˆ é™¤æ“ä½œè®°å½•è®°å…¥æ—¥å¿—ä¿å­˜ï¼Œåˆ é™¤è¡Œæ˜¯ä¸èƒ½æ¢å¤çš„ã€‚å¹¶ä¸”åœ¨åˆ é™¤çš„è¿‡ç¨‹ä¸­ä¸ä¼šæ¿€æ´»ä¸è¡¨æœ‰å…³çš„åˆ é™¤è§¦å‘å™¨ï¼Œæ‰§è¡Œé€Ÿåº¦å¿«ã€‚

2.è¡¨å’Œç´¢å¼•æ‰€å ç©ºé—´ã€‚å½“è¡¨è¢«truncateåï¼Œè¿™ä¸ªè¡¨å’Œç´¢å¼•æ‰€å ç”¨çš„ç©ºé—´ä¼šæ¢å¤åˆ°åˆå§‹å¤§å°ï¼Œè€Œdeleteæ“ä½œä¸ä¼šå‡å°‘è¡¨æˆ–ç´¢å¼•æ‰€å ç”¨çš„ç©ºé—´ã€‚dropè¯­å¥å°†è¡¨æ‰€å ç”¨çš„ç©ºé—´å…¨é‡Šæ”¾æ‰ã€‚

3.ä¸€èˆ¬è€Œè¨€ï¼Œdrop>truncate>delete

4.åº”ç”¨èŒƒå›´ã€‚truncateåªèƒ½å¯¹tableï¼Œdeleteå¯ä»¥æ˜¯tableå’Œview

5.truncateå’Œdeleteåªåˆ é™¤æ•°æ®ï¼Œè€Œdropåˆ™åˆ é™¤æ•´ä¸ªè¡¨ï¼ˆç»“æ„å’Œæ•°æ®)

6.truncateä¸ä¸å¸¦whereçš„delete:åªåˆ é™¤æ•°æ®ï¼Œè€Œä¸åˆ é™¤è¡¨çš„ç»“æ„ï¼ˆå®šä¹‰ï¼‰dropè¯­å¥å°†åˆ é™¤è¡¨çš„ç»“æ„è¢«ä¾èµ–çš„çº¦æŸ(constrain),è§¦å‘å™¨ï¼ˆtrigger)ç´¢å¼•(index);ä¾èµ–äºè¯¥è¡¨çš„å­˜å‚¨è¿‡ç¨‹/å‡½æ•°å°†è¢«ä¿ç•™ï¼Œä½†å…¶çŠ¶æ€ä¼šå˜ä¸º:invalid.

### 9.ç´¢å¼•çš„å·¥ä½œåŸç†åŠå…¶ç§ç±»

æ•°æ®åº“ç´¢å¼•ï¼Œæ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ä¸€ä¸ªæ’åºçš„æ•°æ®ç»“æ„ï¼Œä»¥ååŠ©å¿«é€ŸæŸ¥è¯¢ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ä¸­æ•°æ®ã€‚ç´¢å¼•çš„å®ç°é€šå¸¸ä½¿ç”¨Bæ ‘ä»¥å…¶å˜ç§B+æ ‘ã€‚

åœ¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼å¼•ç”¨ï¼ˆæŒ‡å‘ï¼‰æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ã€‚è¿™ç§æ•°æ®ç»“æ„ï¼Œå°±æ˜¯ç´¢å¼•ã€‚

ä¸ºè¡¨è®¾ç½®ç´¢å¼•è¦ä»˜å‡ºä»£ä»·çš„ï¼šä¸€æ˜¯å¢åŠ äº†æ•°æ®åº“çš„å­˜å‚¨ç©ºé—´ï¼ŒäºŒæ˜¯åœ¨æ’å…¥å’Œä¿®æ”¹æ•°æ®æ—¶è¦èŠ±è´¹è¾ƒå¤šçš„æ—¶é—´ï¼ˆå› ä¸ºç´¢å¼•ä¹Ÿè¦éšä¹‹å˜åŠ¨ï¼‰


### å¸¸ç”¨ç´¢å¼•æ•°æ®ç»“æ„ï¼Œä»¥åŠMySQL B æ ‘ B+ æ ‘åŒºåˆ«ã€‚

https://mp.weixin.qq.com/s/d7Zfat2fP6IX5DMKKtEIjQ


### å¦‚ä½•å¯¹ MySQL è¿›è¡ŒæœåŠ¡å™¨æ‰©å®¹ã€‚

https://mp.weixin.qq.com/s/r6usm2DkSC4Qx3FRSoMCNA


### åˆ†åº“åˆ†è¡¨ç›¸å…³

https://mp.weixin.qq.com/s/dGECnPailOkMX476KoTQfg

### éš”ç¦»çº§åˆ«ã€MVCC

https://mp.weixin.qq.com/s/XOBhxc_AiuUxvwBsB_JprQ

### MySQL çš„é”æœºåˆ¶

https://mp.weixin.qq.com/s/ezBZhZaUqQtASPeT5TKslw
https://mp.weixin.qq.com/s/ZNdBk22Un-7wIYz2fM7-xA
## äº¤æ›¿æ‰“å°æ•°å­—å’Œå­—æ¯

**é—®é¢˜æè¿°**

ä½¿ç”¨ä¸¤ä¸ª `goroutine` äº¤æ›¿æ‰“å°åºåˆ—ï¼Œä¸€ä¸ª `goroutine` æ‰“å°æ•°å­—ï¼Œ å¦å¤–ä¸€ä¸ª `goroutine` æ‰“å°å­—æ¯ï¼Œ æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

```bash
12AB34CD56EF78GH910IJ1112KL1314MN1516OP1718QR1920ST2122UV2324WX2526YZ2728
```

**è§£é¢˜æ€è·¯**

é—®é¢˜å¾ˆç®€å•ï¼Œä½¿ç”¨ channel æ¥æ§åˆ¶æ‰“å°çš„è¿›åº¦ã€‚ä½¿ç”¨ä¸¤ä¸ª channel ï¼Œæ¥åˆ†åˆ«æ§åˆ¶æ•°å­—å’Œå­—æ¯çš„æ‰“å°åºåˆ—ï¼Œ æ•°å­—æ‰“å°å®Œæˆåé€šè¿‡ channel é€šçŸ¥å­—æ¯æ‰“å°, å­—æ¯æ‰“å°å®Œæˆåé€šçŸ¥æ•°å­—æ‰“å°ï¼Œç„¶åå‘¨è€Œå¤å§‹çš„å·¥ä½œã€‚

**æºç å‚è€ƒ**

```
	letter,number := make(chan bool),make(chan bool)
	wait := sync.WaitGroup{}

	go func() {
		i := 1
		for {
			select {
			case <-number:
				fmt.Print(i)
				i++
				fmt.Print(i)
				i++
				letter <- true
			}
		}
	}()
	wait.Add(1)
	go func(wait *sync.WaitGroup) {
		i := 'A'
		for{
			select {
			case <-letter:
				if i >= 'Z' {
					wait.Done()
					return
				}

				fmt.Print(string(i))
				i++
				fmt.Print(string(i))
				i++
				number <- true
			}

		}
	}(&wait)
	number<-true
	wait.Wait()
```

**æºç è§£æ**

è¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ª`channel`è´Ÿè´£é€šçŸ¥ï¼Œletterè´Ÿè´£é€šçŸ¥æ‰“å°å­—æ¯çš„goroutineæ¥æ‰“å°å­—æ¯ï¼Œnumberç”¨æ¥é€šçŸ¥æ‰“å°æ•°å­—çš„goroutineæ‰“å°æ•°å­—ã€‚

waitç”¨æ¥ç­‰å¾…å­—æ¯æ‰“å°å®Œæˆåé€€å‡ºå¾ªç¯ã€‚
<!-- TOC -->

- [Pythonç²¾é€‰](#Pythonç²¾é€‰)
    - [å¿…å¤‡çŸ¥è¯†](å¿…å¤‡çŸ¥è¯†)
        - [1.Pythonçš„å‡½æ•°å‚æ•°ä¼ é€’](#1python%e7%9a%84%e5%87%bd%e6%95%b0%e5%8f%82%e6%95%b0%e4%bc%a0%e9%80%92)
        - [2.Pythonä¸­çš„å…ƒç±»(metaclass)](#2python%e4%b8%ad%e7%9a%84%e5%85%83%e7%b1%bbmetaclass)
        - [3.@staticmethodå’Œ@classmethod](#3@staticmethodå’Œ@classmethod)
        - [4.ç±»å˜é‡å’Œå®ä¾‹å˜é‡](#4ç±»å˜é‡å’Œå®ä¾‹å˜é‡)
        - [5.Pythonè‡ªçœ](#5python%e8%87%aa%e7%9c%81)
        - [6.å­—å…¸æ¨å¯¼å¼](#6å­—å…¸æ¨å¯¼å¼)
        - [7.Pythonä¸­å•ä¸‹åˆ’çº¿å’ŒåŒä¸‹åˆ’çº¿](#7python%e4%b8%ad%e5%8d%95%e4%b8%8b%e5%88%92%e7%ba%bf%e5%92%8c%e5%8f%8c%e4%b8%8b%e5%88%92%e7%ba%bf)
        - [8.å­—ç¬¦ä¸²æ ¼å¼åŒ–:%å’Œ.format](#8%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%92%8cformat)
        - [9.è¿­ä»£å™¨å’Œç”Ÿæˆå™¨](#9%e8%bf%ad%e4%bb%a3%e5%99%a8%e5%92%8c%e7%94%9f%e6%88%90%e5%99%a8)
        - [10.`*args` å’Œ `**kwargs`](#10args-%e5%92%8c-kwargs)
        - [11.é¢å‘åˆ‡é¢ç¼–ç¨‹AOPå’Œè£…é¥°å™¨](#11%e9%9d%a2%e5%90%91%e5%88%87%e9%9d%a2%e7%bc%96%e7%a8%8baop%e5%92%8c%e8%a3%85%e9%a5%b0%e5%99%a8)
        - [12.é¸­å­ç±»å‹](#12%e9%b8%ad%e5%ad%90%e7%b1%bb%e5%9e%8b)
        - [13.Pythonä¸­é‡è½½](#13python%e4%b8%ad%e9%87%8d%e8%bd%bd)
        - [14.æ–°å¼ç±»å’Œæ—§å¼ç±»](#14%e6%96%b0%e5%bc%8f%e7%b1%bb%e5%92%8c%e6%97%a7%e5%bc%8f%e7%b1%bb)
        - [15.`__new__`å’Œ`__init__`çš„åŒºåˆ«](#15new%e5%92%8cinit%e7%9a%84%e5%8c%ba%e5%88%ab)
        - [16.å•ä¾‹æ¨¡å¼](#16%e5%8d%95%e4%be%8b%e6%a8%a1%e5%bc%8f)
        - [17.Pythonä¸­çš„ä½œç”¨åŸŸ](#17python%e4%b8%ad%e7%9a%84%e4%bd%9c%e7%94%a8%e5%9f%9f)
        - [18.GILçº¿ç¨‹å…¨å±€é”](#18gil%e7%ba%bf%e7%a8%8b%e5%85%a8%e5%b1%80%e9%94%81)
        - [19.åç¨‹](#19%e5%8d%8f%e7%a8%8b)
        - [20.é—­åŒ…](#20%e9%97%ad%e5%8c%85)
        - [21.lambdaå‡½æ•°](#21lambda%e5%87%bd%e6%95%b0)
        - [22.Pythonå‡½æ•°å¼ç¼–ç¨‹](#22python%e5%87%bd%e6%95%b0%e5%bc%8f%e7%bc%96%e7%a8%8b)
        - [23.Pythoné‡Œçš„æ‹·è´](#23python%e9%87%8c%e7%9a%84%e6%8b%b7%e8%b4%9d)
        - [24.Pythonåƒåœ¾å›æ”¶æœºåˆ¶](#24python%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e6%9c%ba%e5%88%b6)
        - [25.Pythonçš„List](#25python%e7%9a%84list)
        - [26.Pythonçš„is](#26python%e7%9a%84is)
        - [27.read,readlineå’Œreadlines](#27readreadline%e5%92%8creadlines)
        - [28.Python2å’Œ3çš„åŒºåˆ«](#28python2%e5%92%8c3%e7%9a%84%e5%8c%ba%e5%88%ab)
        - [29.super init](#29super-init)
        - [30.range and xrange](#30range-and-xrange)
- [PythonåŸºç¡€](#pythonåŸºç¡€)
    - [æ–‡ä»¶æ“ä½œ](#æ–‡ä»¶æ“ä½œ)
        - [31.Python å¤„ç†æ–‡ä»¶](#31python-%e5%a4%84%e7%90%86%e6%96%87%e4%bb%b6)
        - [32.éå†æ–‡ä»¶å¤¹](#32%e9%81%8d%e5%8e%86%e6%96%87%e4%bb%b6%e5%a4%b9)
    - [æ¨¡å—ä¸åŒ…](#æ¨¡å—ä¸åŒ…)
        - [33.è¾“å…¥æ—¥æœŸï¼Œåˆ¤æ–­è¿™ä¸€å¤©æ˜¯è¿™ä¸€å¹´çš„ç¬¬å‡ å¤©ï¼Ÿ](#33%e8%be%93%e5%85%a5%e6%97%a5%e6%9c%9f%e5%88%a4%e6%96%ad%e8%bf%99%e4%b8%80%e5%a4%a9%e6%98%af%e8%bf%99%e4%b8%80%e5%b9%b4%e7%9a%84%e7%ac%ac%e5%87%a0%e5%a4%a9)
        - [34.æ‰“ä¹±ä¸€ä¸ªæ’å¥½åºçš„listå¯¹è±¡](#34%e6%89%93%e4%b9%b1%e4%b8%80%e4%b8%aa%e6%8e%92%e5%a5%bd%e5%ba%8f%e7%9a%84list%e5%af%b9%e8%b1%a1)
    - [æ•°æ®ç±»å‹](#æ•°æ®ç±»å‹)
        - [35.å°†å­—å…¸æŒ‰valueå€¼è¿›è¡Œæ’åº](#35%e5%b0%86%e5%ad%97%e5%85%b8%e6%8c%89value%e5%80%bc%e8%bf%9b%e8%a1%8c%e6%8e%92%e5%ba%8f)
        - [36.è¯·åè½¬å­—ç¬¦ä¸² "aStr"](#36%e8%af%b7%e5%8f%8d%e8%bd%ac%e5%ad%97%e7%ac%a6%e4%b8%b2-%22astr%22)
        - [37.å°†å­—ç¬¦ä¸² "k:1|k1:2|k2:3|k3:4" å¤„ç†æˆå­—å…¸ {k:1,k1:2,...}](#37%e5%b0%86%e5%ad%97%e7%ac%a6%e4%b8%b2-%22k1k12k23k34%22-%e5%a4%84%e7%90%86%e6%88%90%e5%ad%97%e5%85%b8-k1k12)
        - [38.åˆ—è¡¨åˆ‡ç‰‡](#38%e5%88%97%e8%a1%a8%e5%88%87%e7%89%87)
        - [39.å†™ä¸€ä¸ªåˆ—è¡¨ç”Ÿæˆå¼ï¼Œäº§ç”Ÿä¸€ä¸ªå…¬å·®ä¸º11çš„ç­‰å·®æ•°åˆ—](#39%e5%86%99%e4%b8%80%e4%b8%aa%e5%88%97%e8%a1%a8%e7%94%9f%e6%88%90%e5%bc%8f%e4%ba%a7%e7%94%9f%e4%b8%80%e4%b8%aa%e5%85%ac%e5%b7%ae%e4%b8%ba11%e7%9a%84%e7%ad%89%e5%b7%ae%e6%95%b0%e5%88%97)
        - [40.ç»™å®šä¸¤ä¸ªåˆ—è¡¨ï¼Œæ‰¾å‡ºä»–ä»¬ç›¸åŒçš„å…ƒç´ å’Œä¸åŒçš„å…ƒç´ ](#40%e7%bb%99%e5%ae%9a%e4%b8%a4%e4%b8%aa%e5%88%97%e8%a1%a8%e6%89%be%e5%87%ba%e4%bb%96%e4%bb%ac%e7%9b%b8%e5%90%8c%e7%9a%84%e5%85%83%e7%b4%a0%e5%92%8c%e4%b8%8d%e5%90%8c%e7%9a%84%e5%85%83%e7%b4%a0)
        
    - [ä¼ä¸šé¢è¯•é¢˜](#ä¼ä¸šé¢è¯•é¢˜)
        - [41.pythonä¸­å†…ç½®çš„æ•°æ®ç»“æ„æœ‰å‡ ç§](#41python%e4%b8%ad%e5%86%85%e7%bd%ae%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e6%9c%89%e5%87%a0%e7%a7%8d)
        - [42.åè½¬ä¸€ä¸ªæ•´æ•°ï¼Œä¾‹å¦‚-123 --> -321](#42%e5%8f%8d%e8%bd%ac%e4%b8%80%e4%b8%aa%e6%95%b4%e6%95%b0%e4%be%8b%e5%a6%82-123-----321)
        - [43.å®ç°éå†ç›®å½•ä¸å­ç›®å½•ï¼ŒæŠ“å–.pycæ–‡ä»¶](#43%e5%ae%9e%e7%8e%b0%e9%81%8d%e5%8e%86%e7%9b%ae%e5%bd%95%e4%b8%8e%e5%ad%90%e7%9b%ae%e5%bd%95%e6%8a%93%e5%8f%96pyc%e6%96%87%e4%bb%b6)
        - [44.Pythonéå†åˆ—è¡¨æ—¶åˆ é™¤å…ƒç´ çš„æ­£ç¡®åšæ³•](#44python%e9%81%8d%e5%8e%86%e5%88%97%e8%a1%a8%e6%97%b6%e5%88%a0%e9%99%a4%e5%85%83%e7%b4%a0%e7%9a%84%e6%ad%a3%e7%a1%ae%e5%81%9a%e6%b3%95)
        - [45.å­—ç¬¦ä¸² `"123"` è½¬æ¢æˆ `123`ï¼Œä¸ä½¿ç”¨å†…ç½®apiï¼Œä¾‹å¦‚ `int()`](#45%e5%ad%97%e7%ac%a6%e4%b8%b2-%22123%22-%e8%bd%ac%e6%8d%a2%e6%88%90-123%e4%b8%8d%e4%bd%bf%e7%94%a8%e5%86%85%e7%bd%aeapi%e4%be%8b%e5%a6%82-int)
        - [46.ç»Ÿè®¡ä¸€ä¸ªæ–‡æœ¬ä¸­å•è¯é¢‘æ¬¡æœ€é«˜çš„10ä¸ªå•è¯](#46%e7%bb%9f%e8%ae%a1%e4%b8%80%e4%b8%aa%e6%96%87%e6%9c%ac%e4%b8%ad%e5%8d%95%e8%af%8d%e9%a2%91%e6%ac%a1%e6%9c%80%e9%ab%98%e7%9a%8410%e4%b8%aa%e5%8d%95%e8%af%8d)
        - [47.é˜…è¯»ä¸€ä¸‹ä»£ç ä»–ä»¬çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ](#47%e9%98%85%e8%af%bb%e4%b8%80%e4%b8%8b%e4%bb%a3%e7%a0%81%e4%bb%96%e4%bb%ac%e7%9a%84%e8%be%93%e5%87%ba%e7%bb%93%e6%9e%9c%e6%98%af%e4%bb%80%e4%b9%88)

- [Pythoné«˜çº§](#pythoné«˜çº§)
    - [å…ƒç±»](#å…ƒç±»)
        - [48.ä»‹ç»Cythonï¼ŒPypy Cpython Numbaå„æœ‰ä»€ä¹ˆç¼ºç‚¹](#48%e4%bb%8b%e7%bb%8dcythonpypy-cpython-numba%e5%90%84%e6%9c%89%e4%bb%80%e4%b9%88%e7%bc%ba%e7%82%b9)
        - [49.è¯·æè¿°æŠ½è±¡ç±»å’Œæ¥å£ç±»çš„åŒºåˆ«å’Œè”ç³»](#49%e8%af%b7%e6%8f%8f%e8%bf%b0%e6%8a%bd%e8%b1%a1%e7%b1%bb%e5%92%8c%e6%8e%a5%e5%8f%a3%e7%b1%bb%e7%9a%84%e5%8c%ba%e5%88%ab%e5%92%8c%e8%81%94%e7%b3%bb)
        - [50.Pythonä¸­å¦‚ä½•åŠ¨æ€è·å–å’Œè®¾ç½®å¯¹è±¡çš„å±æ€§](#50python%e4%b8%ad%e5%a6%82%e4%bd%95%e5%8a%a8%e6%80%81%e8%8e%b7%e5%8f%96%e5%92%8c%e8%ae%be%e7%bd%ae%e5%af%b9%e8%b1%a1%e7%9a%84%e5%b1%9e%e6%80%a7)
    
    - [å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶æœºåˆ¶](#å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶æœºåˆ¶)
        - [51.å“ªäº›æ“ä½œä¼šå¯¼è‡´Pythonå†…å­˜æº¢å‡ºï¼Œæ€ä¹ˆå¤„ç†](#51%e5%93%aa%e4%ba%9b%e6%93%8d%e4%bd%9c%e4%bc%9a%e5%af%bc%e8%87%b4python%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e6%80%8e%e4%b9%88%e5%a4%84%e7%90%86)
        - [52.å†…å­˜æ³„éœ²æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ](#52å†…å­˜æ³„éœ²æ˜¯ä»€ä¹ˆå¦‚ä½•é¿å…)
    
    - [å‡½æ•°](#å‡½æ•°)
        - [53.æ‰‹å†™ä¸€ä¸ªåˆ¤æ–­æ—¶é—´çš„è£…é¥°å™¨](#53%e6%89%8b%e5%86%99%e4%b8%80%e4%b8%aa%e5%88%a4%e6%96%ad%e6%97%b6%e9%97%b4%e7%9a%84%e8%a3%85%e9%a5%b0%e5%99%a8)
        - [54.å¸¦å‚æ•°çš„è£…é¥°å™¨](#54%e5%b8%a6%e5%8f%82%e6%95%b0%e7%9a%84%e8%a3%85%e9%a5%b0%e5%99%a8)
        - [55.çº¿ç¨‹å®‰å…¨çš„è£…é¥°å™¨](#55%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e8%a3%85%e9%a5%b0%e5%99%a8)
        - [56.äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼](#56%e4%ba%a4%e6%8d%a2%e4%b8%a4%e4%b8%aa%e5%8f%98%e9%87%8f%e7%9a%84%e5%80%bc)
        - [57.hasattr() getattr() setattr() å‡½æ•°ä½¿ç”¨è¯¦è§£](#57hasattr-getattr-setattr-%e5%87%bd%e6%95%b0%e4%bd%bf%e7%94%a8%e8%af%a6%e8%a7%a3)
        
    - [è®¾è®¡æ¨¡å¼](#è®¾è®¡æ¨¡å¼)
        - [58.å¯¹è£…é¥°å™¨çš„ç†è§£ï¼Œå¹¶å†™å‡ºä¸€ä¸ªè®¡æ—¶å™¨è®°å½•æ–¹æ³•æ‰§è¡Œæ€§èƒ½çš„è£…é¥°å™¨](#58%e5%af%b9%e8%a3%85%e9%a5%b0%e5%99%a8%e7%9a%84%e7%90%86%e8%a7%a3%e5%b9%b6%e5%86%99%e5%87%ba%e4%b8%80%e4%b8%aa%e8%ae%a1%e6%97%b6%e5%99%a8%e8%ae%b0%e5%bd%95%e6%96%b9%e6%b3%95%e6%89%a7%e8%a1%8c%e6%80%a7%e8%83%bd%e7%9a%84%e8%a3%85%e9%a5%b0%e5%99%a8)
        - [59.Pythonä¸­yieldçš„ç”¨æ³•](#59pythonä¸­yieldçš„ç”¨æ³•)
    
    - [é¢å‘å¯¹è±¡](#é¢å‘å¯¹è±¡)
        - [60.Pythonçš„é­”æ³•æ–¹æ³•](#60python%e7%9a%84%e9%ad%94%e6%b3%95%e6%96%b9%e6%b3%95)
        - [61.é¢å‘å¯¹è±¡ä¸­æ€ä¹ˆå®ç°åªè¯»å±æ€§](#61%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1%e4%b8%ad%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e5%8f%aa%e8%af%bb%e5%b1%9e%e6%80%a7)
        - [62.è°ˆè°ˆä½ å¯¹é¢å‘å¯¹è±¡çš„ç†è§£](#62%e8%b0%88%e8%b0%88%e4%bd%a0%e5%af%b9%e9%9d%a2%e5%90%91%e5%af%b9%e8%b1%a1%e7%9a%84%e7%90%86%e8%a7%a3)

    - [æ­£åˆ™è¡¨è¾¾å¼](#æ­£åˆ™è¡¨è¾¾å¼)
        - [63.è¯·å†™å‡ºä¸€æ®µä»£ç ç”¨æ­£åˆ™åŒ¹é…å‡ºip](#63%e8%af%b7%e5%86%99%e5%87%ba%e4%b8%80%e6%ae%b5%e4%bb%a3%e7%a0%81%e7%94%a8%e6%ad%a3%e5%88%99%e5%8c%b9%e9%85%8d%e5%87%baip)
        - [64.Pythonå­—ç¬¦ä¸²æŸ¥æ‰¾å’Œæ›¿æ¢ï¼Ÿ](#64pythonå­—ç¬¦ä¸²æŸ¥æ‰¾å’Œæ›¿æ¢)
        - [65.æ­£åˆ™è¡¨è¾¾å¼è´ªå©ªä¸éè´ªå©ªæ¨¡å¼çš„åŒºåˆ«ï¼Ÿ](#65æ­£åˆ™è¡¨è¾¾å¼è´ªå©ªä¸éè´ªå©ªæ¨¡å¼çš„åŒºåˆ«)
        - [66.å†™å‡ºå¼€å¤´åŒ¹é…å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œæœ«å°¾æ˜¯æ•°å­—çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ](#66å†™å‡ºå¼€å¤´åŒ¹é…å­—æ¯å’Œä¸‹åˆ’çº¿æœ«å°¾æ˜¯æ•°å­—çš„æ­£åˆ™è¡¨è¾¾å¼)
        - [67.æ€ä¹ˆè¿‡æ»¤è¯„è®ºä¸­çš„è¡¨æƒ…ï¼Ÿ](#67æ€ä¹ˆè¿‡æ»¤è¯„è®ºä¸­çš„è¡¨æƒ…)
        - [68.Pythoné‡Œmatchä¸searchçš„åŒºåˆ«ï¼Ÿ](#68pythoné‡Œmatchä¸searchçš„åŒºåˆ«)

- [Web](#web)
    - [Flask](#flask)
        - [140.å¯¹Flaskè“å›¾(Blueprint)çš„ç†è§£ï¼Ÿ](#140å¯¹flaskè“å›¾blueprintçš„ç†è§£)
        - [141.Flask å’Œ Django è·¯ç”±æ˜ å°„çš„åŒºåˆ«ï¼Ÿ](#141flask-å’Œ-django-è·¯ç”±æ˜ å°„çš„åŒºåˆ«)
    - [Django](#django)
        - [142.ä»€ä¹ˆæ˜¯wsgi,uwsgi,uWSGI?](#142ä»€ä¹ˆæ˜¯wsgiuwsgiuwsgi)
        - [143.Djangoã€Flaskã€Tornadoçš„å¯¹æ¯”ï¼Ÿ](#143djangoflasktornadoçš„å¯¹æ¯”)
        - [144.CORS å’Œ CSRFçš„åŒºåˆ«ï¼Ÿ](#144cors-å’Œ-csrfçš„åŒºåˆ«)
        - [145.Session,Cookie,JWTçš„ç†è§£](#145sessioncookiejwtçš„ç†è§£)
        - [146.ç®€è¿°Djangoè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ](#146ç®€è¿°djangoè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ)
        - [147.ç”¨çš„restframeworkå®Œæˆapiå‘é€æ—¶é—´æ—¶åŒº](#147ç”¨çš„restframeworkå®Œæˆapiå‘é€æ—¶é—´æ—¶åŒº)
        - [148.nginx,tomcat,apachåˆ°éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ](#148nginxtomcatapachåˆ°éƒ½æ˜¯ä»€ä¹ˆ)
        - [149.è¯·ç»™å‡ºä½ ç†Ÿæ‚‰å…³ç³»æ•°æ®åº“èŒƒå¼æœ‰å“ªäº›ï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ](#149è¯·ç»™å‡ºä½ ç†Ÿæ‚‰å…³ç³»æ•°æ®åº“èŒƒå¼æœ‰å“ªäº›æœ‰ä»€ä¹ˆä½œç”¨)
        - [150.ç®€è¿°QQç™»é™†è¿‡ç¨‹](#150ç®€è¿°qqç™»é™†è¿‡ç¨‹)
        - [151.post å’Œ getçš„åŒºåˆ«?](#151post-å’Œ-getçš„åŒºåˆ«)
        - [152.é¡¹ç›®ä¸­æ—¥å¿—çš„ä½œç”¨](#152é¡¹ç›®ä¸­æ—¥å¿—çš„ä½œç”¨)
        - [153.djangoä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Ÿ](#153djangoä¸­é—´ä»¶çš„ä½¿ç”¨)
        - [154.è°ˆä¸€ä¸‹ä½ å¯¹uWSGIå’Œnginxçš„ç†è§£ï¼Ÿ](#154è°ˆä¸€ä¸‹ä½ å¯¹uwsgiå’Œnginxçš„ç†è§£)
        - [155.Djangoä¸­å“ªé‡Œç”¨åˆ°äº†çº¿ç¨‹ï¼Ÿå“ªé‡Œç”¨åˆ°äº†åç¨‹ï¼Ÿå“ªé‡Œç”¨åˆ°äº†è¿›ç¨‹ï¼Ÿ](#155djangoä¸­å“ªé‡Œç”¨åˆ°äº†çº¿ç¨‹å“ªé‡Œç”¨åˆ°äº†åç¨‹å“ªé‡Œç”¨åˆ°äº†è¿›ç¨‹)
        - [156.æœ‰ç”¨è¿‡Django REST frameworkå—ï¼Ÿ](#156æœ‰ç”¨è¿‡django-rest-frameworkå—)
    - [çˆ¬è™«](#çˆ¬è™«)
        - [159.è¯•åˆ—å‡ºè‡³å°‘ä¸‰ç§ç›®å‰æµè¡Œçš„å¤§å‹æ•°æ®åº“](#159è¯•åˆ—å‡ºè‡³å°‘ä¸‰ç§ç›®å‰æµè¡Œçš„å¤§å‹æ•°æ®åº“)
        - [160.åˆ—ä¸¾æ‚¨ä½¿ç”¨è¿‡çš„Pythonç½‘ç»œçˆ¬è™«æ‰€ç”¨åˆ°çš„ç½‘ç»œæ•°æ®åŒ…?](#160åˆ—ä¸¾æ‚¨ä½¿ç”¨è¿‡çš„pythonç½‘ç»œçˆ¬è™«æ‰€ç”¨åˆ°çš„ç½‘ç»œæ•°æ®åŒ…)
        - [161.çˆ¬å–æ•°æ®åä½¿ç”¨å“ªä¸ªæ•°æ®åº“å­˜å‚¨æ•°æ®çš„ï¼Œä¸ºä»€ä¹ˆï¼Ÿ](#161çˆ¬å–æ•°æ®åä½¿ç”¨å“ªä¸ªæ•°æ®åº“å­˜å‚¨æ•°æ®çš„ä¸ºä»€ä¹ˆ)
        - [162.ä½ ç”¨è¿‡çš„çˆ¬è™«æ¡†æ¶æˆ–è€…æ¨¡å—æœ‰å“ªäº›ï¼Ÿä¼˜ç¼ºç‚¹ï¼Ÿ](#162ä½ ç”¨è¿‡çš„çˆ¬è™«æ¡†æ¶æˆ–è€…æ¨¡å—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹)
        - [163.å†™çˆ¬è™«æ˜¯ç”¨å¤šè¿›ç¨‹å¥½ï¼Ÿè¿˜æ˜¯å¤šçº¿ç¨‹å¥½ï¼Ÿ](#163å†™çˆ¬è™«æ˜¯ç”¨å¤šè¿›ç¨‹å¥½è¿˜æ˜¯å¤šçº¿ç¨‹å¥½)
        - [164.å¸¸è§çš„åçˆ¬è™«å’Œåº”å¯¹æ–¹æ³•ï¼Ÿ](#164å¸¸è§çš„åçˆ¬è™«å’Œåº”å¯¹æ–¹æ³•)
        - [165.è§£æç½‘é¡µçš„è§£æå™¨ä½¿ç”¨æœ€å¤šçš„æ˜¯å“ªå‡ ä¸ª?](#165è§£æç½‘é¡µçš„è§£æå™¨ä½¿ç”¨æœ€å¤šçš„æ˜¯å“ªå‡ ä¸ª)
        - [166.éœ€è¦ç™»å½•çš„ç½‘é¡µï¼Œå¦‚ä½•è§£å†³åŒæ—¶é™åˆ¶ipï¼Œcookie,session](#166éœ€è¦ç™»å½•çš„ç½‘é¡µå¦‚ä½•è§£å†³åŒæ—¶é™åˆ¶ipcookiesession)
        - [167.éªŒè¯ç çš„è§£å†³?](#167éªŒè¯ç çš„è§£å†³)
        - [168.ä½¿ç”¨æœ€å¤šçš„æ•°æ®åº“ï¼Œå¯¹ä»–ä»¬çš„ç†è§£ï¼Ÿ](#168ä½¿ç”¨æœ€å¤šçš„æ•°æ®åº“å¯¹ä»–ä»¬çš„ç†è§£)
        - [169.ç¼–å†™è¿‡å“ªäº›çˆ¬è™«ä¸­é—´ä»¶ï¼Ÿ](#169ç¼–å†™è¿‡å“ªäº›çˆ¬è™«ä¸­é—´ä»¶)
        - [170.â€œæéªŒâ€æ»‘åŠ¨éªŒè¯ç å¦‚ä½•ç ´è§£ï¼Ÿ](#170æéªŒæ»‘åŠ¨éªŒè¯ç å¦‚ä½•ç ´è§£)
        - [171.çˆ¬è™«å¤šä¹…çˆ¬ä¸€æ¬¡ï¼Œçˆ¬ä¸‹æ¥çš„æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨ï¼Ÿ](#171çˆ¬è™«å¤šä¹…çˆ¬ä¸€æ¬¡çˆ¬ä¸‹æ¥çš„æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨)
        - [172.cookieè¿‡æœŸçš„å¤„ç†é—®é¢˜ï¼Ÿ](#172cookieè¿‡æœŸçš„å¤„ç†é—®é¢˜)
        - [173.åŠ¨æ€åŠ è½½åˆå¯¹åŠæ—¶æ€§è¦æ±‚å¾ˆé«˜æ€ä¹ˆå¤„ç†ï¼Ÿ](#173åŠ¨æ€åŠ è½½åˆå¯¹åŠæ—¶æ€§è¦æ±‚å¾ˆé«˜æ€ä¹ˆå¤„ç†)
        - [174.HTTPSæœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ](#174httpsæœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹)
        - [175.HTTPSæ˜¯å¦‚ä½•å®ç°å®‰å…¨ä¼ è¾“æ•°æ®çš„ï¼Ÿ](#175httpsæ˜¯å¦‚ä½•å®ç°å®‰å…¨ä¼ è¾“æ•°æ®çš„)
        - [176.TTLï¼ŒMSLï¼ŒRTTå„æ˜¯ä»€ä¹ˆï¼Ÿ](#176ttlmslrttå„æ˜¯ä»€ä¹ˆ)
        - [177.è°ˆä¸€è°ˆä½ å¯¹Seleniumå’ŒPhantomJSäº†è§£](#177è°ˆä¸€è°ˆä½ å¯¹seleniumå’Œphantomjsäº†è§£)
        - [178.å¹³å¸¸æ€ä¹ˆä½¿ç”¨ä»£ç†çš„ ï¼Ÿ](#178å¹³å¸¸æ€ä¹ˆä½¿ç”¨ä»£ç†çš„-)
        - [179.å­˜æ”¾åœ¨æ•°æ®åº“(redisã€mysqlç­‰)ã€‚](#179å­˜æ”¾åœ¨æ•°æ®åº“redismysqlç­‰)
        - [180.æ€ä¹ˆç›‘æ§çˆ¬è™«çš„çŠ¶æ€?](#180æ€ä¹ˆç›‘æ§çˆ¬è™«çš„çŠ¶æ€)
        - [181.æè¿°ä¸‹scrapyæ¡†æ¶è¿è¡Œçš„æœºåˆ¶ï¼Ÿ](#181æè¿°ä¸‹scrapyæ¡†æ¶è¿è¡Œçš„æœºåˆ¶)
        - [182.è°ˆè°ˆä½ å¯¹Scrapyçš„ç†è§£ï¼Ÿ](#182è°ˆè°ˆä½ å¯¹scrapyçš„ç†è§£)
        - [183.æ€ä¹ˆæ ·è®© scrapy æ¡†æ¶å‘é€ä¸€ä¸ª post è¯·æ±‚ï¼ˆå…·ä½“å†™å‡ºæ¥ï¼‰](#183æ€ä¹ˆæ ·è®©-scrapy-æ¡†æ¶å‘é€ä¸€ä¸ª-post-è¯·æ±‚å…·ä½“å†™å‡ºæ¥)
        - [184.æ€ä¹ˆç›‘æ§çˆ¬è™«çš„çŠ¶æ€ ï¼Ÿ](#184æ€ä¹ˆç›‘æ§çˆ¬è™«çš„çŠ¶æ€-)
        - [185.æ€ä¹ˆåˆ¤æ–­ç½‘ç«™æ˜¯å¦æ›´æ–°ï¼Ÿ](#185æ€ä¹ˆåˆ¤æ–­ç½‘ç«™æ˜¯å¦æ›´æ–°)
        - [186.å›¾ç‰‡ã€è§†é¢‘çˆ¬å–æ€ä¹ˆç»•è¿‡é˜²ç›—è¿æ¥](#186å›¾ç‰‡è§†é¢‘çˆ¬å–æ€ä¹ˆç»•è¿‡é˜²ç›—è¿æ¥)
        - [187.ä½ çˆ¬å‡ºæ¥çš„æ•°æ®é‡å¤§æ¦‚æœ‰å¤šå¤§ï¼Ÿå¤§æ¦‚å¤šé•¿æ—¶é—´çˆ¬ä¸€æ¬¡ï¼Ÿ](#187ä½ çˆ¬å‡ºæ¥çš„æ•°æ®é‡å¤§æ¦‚æœ‰å¤šå¤§å¤§æ¦‚å¤šé•¿æ—¶é—´çˆ¬ä¸€æ¬¡)
        - [188.ç”¨ä»€ä¹ˆæ•°æ®åº“å­˜çˆ¬ä¸‹æ¥çš„æ•°æ®ï¼Ÿéƒ¨ç½²æ˜¯ä½ åšçš„å—ï¼Ÿæ€ä¹ˆéƒ¨ç½²ï¼Ÿ](#188ç”¨ä»€ä¹ˆæ•°æ®åº“å­˜çˆ¬ä¸‹æ¥çš„æ•°æ®éƒ¨ç½²æ˜¯ä½ åšçš„å—æ€ä¹ˆéƒ¨ç½²)
        - [189.å¢é‡çˆ¬å–](#189å¢é‡çˆ¬å–)
        - [190.çˆ¬å–ä¸‹æ¥çš„æ•°æ®å¦‚ä½•å»é‡ï¼Œè¯´ä¸€ä¸‹scrapyçš„å…·ä½“çš„ç®—æ³•ä¾æ®ã€‚](#190çˆ¬å–ä¸‹æ¥çš„æ•°æ®å¦‚ä½•å»é‡è¯´ä¸€ä¸‹scrapyçš„å…·ä½“çš„ç®—æ³•ä¾æ®)
        - [191.Scrapyçš„ä¼˜ç¼ºç‚¹?](#191scrapyçš„ä¼˜ç¼ºç‚¹)
        - [192.æ€ä¹ˆè®¾ç½®çˆ¬å–æ·±åº¦ï¼Ÿ](#192æ€ä¹ˆè®¾ç½®çˆ¬å–æ·±åº¦)
        - [193.scrapyå’Œscrapy-redisæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆé€‰æ‹©redisæ•°æ®åº“ï¼Ÿ](#193scrapyå’Œscrapy-redisæœ‰ä»€ä¹ˆåŒºåˆ«ä¸ºä»€ä¹ˆé€‰æ‹©redisæ•°æ®åº“)
        - [194.åˆ†å¸ƒå¼çˆ¬è™«ä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ](#194åˆ†å¸ƒå¼çˆ¬è™«ä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜)
        - [195.ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼å­˜å‚¨ï¼Ÿ](#195ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼å­˜å‚¨)
        - [196.ä½ æ‰€çŸ¥é“çš„åˆ†å¸ƒå¼çˆ¬è™«æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ](#196ä½ æ‰€çŸ¥é“çš„åˆ†å¸ƒå¼çˆ¬è™«æ–¹æ¡ˆæœ‰å“ªäº›)
        - [197.scrapy-redisï¼Œæœ‰åšè¿‡å…¶ä»–çš„åˆ†å¸ƒå¼çˆ¬è™«å—ï¼Ÿ](#197scrapy-redisæœ‰åšè¿‡å…¶ä»–çš„åˆ†å¸ƒå¼çˆ¬è™«å—)
    
    - [æµ‹è¯•](#æµ‹è¯•)
        - [213.ç¼–å†™æµ‹è¯•è®¡åˆ’çš„ç›®çš„æ˜¯](#213ç¼–å†™æµ‹è¯•è®¡åˆ’çš„ç›®çš„æ˜¯)
        - [214.å¯¹å…³é”®è¯è§¦å‘æ¨¡å—è¿›è¡Œæµ‹è¯•](#214å¯¹å…³é”®è¯è§¦å‘æ¨¡å—è¿›è¡Œæµ‹è¯•)
        - [215.å…¶ä»–å¸¸ç”¨ç¬”è¯•é¢˜ç›®ç½‘å€æ±‡æ€»](#215å…¶ä»–å¸¸ç”¨ç¬”è¯•é¢˜ç›®ç½‘å€æ±‡æ€»)
        - [216.æµ‹è¯•äººå‘˜åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯ä»€ä¹ˆ](#216æµ‹è¯•äººå‘˜åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯ä»€ä¹ˆ)
        - [217.ä¸€æ¡è½¯ä»¶Bugè®°å½•éƒ½åŒ…å«äº†å“ªäº›å†…å®¹ï¼Ÿ](#217ä¸€æ¡è½¯ä»¶bugè®°å½•éƒ½åŒ…å«äº†å“ªäº›å†…å®¹)
        - [218.ç®€è¿°é»‘ç›’æµ‹è¯•å’Œç™½ç›’æµ‹è¯•çš„ä¼˜ç¼ºç‚¹](#218ç®€è¿°é»‘ç›’æµ‹è¯•å’Œç™½ç›’æµ‹è¯•çš„ä¼˜ç¼ºç‚¹)
        - [219.è¯·åˆ—å‡ºä½ æ‰€çŸ¥é“çš„è½¯ä»¶æµ‹è¯•ç§ç±»ï¼Œè‡³å°‘5é¡¹](#219è¯·åˆ—å‡ºä½ æ‰€çŸ¥é“çš„è½¯ä»¶æµ‹è¯•ç§ç±»è‡³å°‘5é¡¹)
        - [220.Alphaæµ‹è¯•ä¸Betaæµ‹è¯•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ](#220alphaæµ‹è¯•ä¸betaæµ‹è¯•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ)
        - [221.ä¸¾ä¾‹è¯´æ˜ä»€ä¹ˆæ˜¯Bugï¼Ÿä¸€ä¸ªbug reportåº”åŒ…å«ä»€ä¹ˆå…³é”®å­—ï¼Ÿ](#221ä¸¾ä¾‹è¯´æ˜ä»€ä¹ˆæ˜¯bugä¸€ä¸ªbug-reportåº”åŒ…å«ä»€ä¹ˆå…³é”®å­—)
    
    - [å¤§æ•°æ®](#å¤§æ•°æ®)
        - [242.æ‰¾å‡º1Gçš„æ–‡ä»¶ä¸­é«˜é¢‘è¯](#242æ‰¾å‡º1gçš„æ–‡ä»¶ä¸­é«˜é¢‘è¯)
        - [243.ä¸€ä¸ªå¤§çº¦æœ‰ä¸€ä¸‡è¡Œçš„æ–‡æœ¬æ–‡ä»¶ç»Ÿè®¡é«˜é¢‘è¯](#243ä¸€ä¸ªå¤§çº¦æœ‰ä¸€ä¸‡è¡Œçš„æ–‡æœ¬æ–‡ä»¶ç»Ÿè®¡é«˜é¢‘è¯)
        - [244.æ€ä¹ˆåœ¨æµ·é‡æ•°æ®ä¸­æ‰¾å‡ºé‡å¤æ¬¡æ•°æœ€å¤šçš„ä¸€ä¸ªï¼Ÿ](#244æ€ä¹ˆåœ¨æµ·é‡æ•°æ®ä¸­æ‰¾å‡ºé‡å¤æ¬¡æ•°æœ€å¤šçš„ä¸€ä¸ª)
        - [245.åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨å¤§é‡æ•°æ®ä¸­](#245åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨å¤§é‡æ•°æ®ä¸­)

<!-- /TOC -->
# Pythonç²¾é€‰
## å¿…å¤‡çŸ¥è¯†
### 1.Pythonçš„å‡½æ•°å‚æ•°ä¼ é€’

çœ‹ä¸¤ä¸ªä¾‹å­:

```python
a = 1
def fun(a):
    a = 2
fun(a)
print a  # 1
```

```python
a = []
def fun(a):
    a.append(1)
fun(a)
print a  # [1]
```

æ‰€æœ‰çš„å˜é‡éƒ½å¯ä»¥ç†è§£æ˜¯å†…å­˜ä¸­ä¸€ä¸ªå¯¹è±¡çš„â€œå¼•ç”¨â€ï¼Œæˆ–è€…ï¼Œä¹Ÿå¯ä»¥çœ‹ä¼¼ C ä¸­ `void*` çš„æ„Ÿè§‰ã€‚

é€šè¿‡`id`æ¥çœ‹å¼•ç”¨`a`çš„å†…å­˜åœ°å€å¯ä»¥æ¯”è¾ƒç†è§£ï¼š

```python
a = 1
def fun(a):
    print "func_in",id(a)   # func_in 41322472
    a = 2
    print "re-point",id(a), id(2)   # re-point 41322448 41322448
print "func_out",id(a), id(1)  # func_out 41322472 41322472
fun(a)
print a  # 1
```

æ³¨ï¼šå…·ä½“çš„å€¼åœ¨ä¸åŒç”µè„‘ä¸Šè¿è¡Œæ—¶å¯èƒ½ä¸åŒã€‚

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œå®Œ`a = 2`ä¹‹åï¼Œ`a`å¼•ç”¨ä¸­ä¿å­˜çš„å€¼ï¼Œå³å†…å­˜åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œç”±åŸæ¥`1`å¯¹è±¡çš„æ‰€åœ¨åœ°å€å˜æˆäº†`2`è¿™ä¸ªå®ä½“å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚

è€Œç¬¬2ä¸ªä¾‹å­`a`å¼•ç”¨ä¿å­˜çš„å†…å­˜å€¼å°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼š

```python
a = []
def fun(a):
    print "func_in",id(a)  # func_in 53629256
    a.append(1)
print "func_out",id(a)     # func_out 53629256
fun(a)
print a  # [1]
```

è¿™é‡Œè®°ä½çš„æ˜¯ç±»å‹æ˜¯å±äºå¯¹è±¡çš„ï¼Œè€Œä¸æ˜¯å˜é‡ã€‚è€Œå¯¹è±¡æœ‰ä¸¤ç§,â€œå¯æ›´æ”¹â€ï¼ˆmutableï¼‰ä¸â€œä¸å¯æ›´æ”¹â€ï¼ˆimmutableï¼‰å¯¹è±¡ã€‚åœ¨pythonä¸­ï¼Œstrings, tuples, å’Œnumbersæ˜¯ä¸å¯æ›´æ”¹çš„å¯¹è±¡ï¼Œè€Œ list, dict, set ç­‰åˆ™æ˜¯å¯ä»¥ä¿®æ”¹çš„å¯¹è±¡ã€‚(è¿™å°±æ˜¯è¿™ä¸ªé—®é¢˜çš„é‡ç‚¹)

å½“ä¸€ä¸ªå¼•ç”¨ä¼ é€’ç»™å‡½æ•°çš„æ—¶å€™,å‡½æ•°è‡ªåŠ¨å¤åˆ¶ä¸€ä»½å¼•ç”¨,è¿™ä¸ªå‡½æ•°é‡Œçš„å¼•ç”¨å’Œå¤–è¾¹çš„å¼•ç”¨æ²¡æœ‰åŠæ¯›å…³ç³»äº†.æ‰€ä»¥ç¬¬ä¸€ä¸ªä¾‹å­é‡Œå‡½æ•°æŠŠå¼•ç”¨æŒ‡å‘äº†ä¸€ä¸ªä¸å¯å˜å¯¹è±¡,å½“å‡½æ•°è¿”å›çš„æ—¶å€™,å¤–é¢çš„å¼•ç”¨æ²¡åŠæ¯›æ„Ÿè§‰.è€Œç¬¬äºŒä¸ªä¾‹å­å°±ä¸ä¸€æ ·äº†,å‡½æ•°å†…çš„å¼•ç”¨æŒ‡å‘çš„æ˜¯å¯å˜å¯¹è±¡,å¯¹å®ƒçš„æ“ä½œå°±å’Œå®šä½äº†æŒ‡é’ˆåœ°å€ä¸€æ ·,åœ¨å†…å­˜é‡Œè¿›è¡Œä¿®æ”¹.

å¦‚æœè¿˜ä¸æ˜ç™½çš„è¯,è¿™é‡Œæœ‰æ›´å¥½çš„è§£é‡Š: http://stackoverflow.com/questions/986006/how-do-i-pass-a-variable-by-reference

### 2.Pythonä¸­çš„å…ƒç±»(metaclass)

è¿™ä¸ªéå¸¸çš„ä¸å¸¸ç”¨,ä½†æ˜¯åƒORMè¿™ç§å¤æ‚çš„ç»“æ„è¿˜æ˜¯ä¼šéœ€è¦çš„ã€‚

æ‰©å±•é˜…è¯»ï¼š

1. https://www.liaoxuefeng.com/wiki/1016959663602400/1017592449371072
2. [æ·±å…¥ç†è§£Pythonä¸­çš„å…ƒç±»(metaclass)](https://www.cnblogs.com/JetpropelledSnake/p/9094103.html)

### 3.@staticmethodå’Œ@classmethod

Pythonå…¶å®æœ‰3ä¸ªæ–¹æ³•,å³é™æ€æ–¹æ³•(staticmethod),ç±»æ–¹æ³•(classmethod)å’Œå®ä¾‹æ–¹æ³•,å¦‚ä¸‹:

```python
def foo(x):
    print "executing foo(%s)"%(x)

class A(object):
    def foo(self,x):
        print "executing foo(%s,%s)"%(self,x)

    @classmethod
    def class_foo(cls,x):
        print "executing class_foo(%s,%s)"%(cls,x)

    @staticmethod
    def static_foo(x):
        print "executing static_foo(%s)"%x

a=A()
```

è¿™é‡Œå…ˆç†è§£ä¸‹å‡½æ•°å‚æ•°é‡Œé¢çš„selfå’Œclsã€‚è¿™ä¸ªselfå’Œclsæ˜¯å¯¹ç±»æˆ–è€…å®ä¾‹çš„ç»‘å®šï¼Œå¯¹äºä¸€èˆ¬çš„å‡½æ•°æ¥è¯´æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆè°ƒç”¨`foo(x)`ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æœ€å¸¸ç”¨çš„ï¼Œå®ƒçš„å·¥ä½œè·Ÿä»»ä½•ä¸œè¥¿(ç±»,å®ä¾‹)æ— å…³ã€‚å¯¹äºå®ä¾‹æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ç±»é‡Œæ¯æ¬¡å®šä¹‰æ–¹æ³•çš„æ—¶å€™éƒ½éœ€è¦ç»‘å®šè¿™ä¸ªå®ä¾‹ï¼Œå°±æ˜¯`foo(self, x)`ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºå®ä¾‹æ–¹æ³•çš„è°ƒç”¨ç¦»ä¸å¼€å®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ä¾‹è‡ªå·±ä¼ ç»™å‡½æ•°ï¼Œè°ƒç”¨çš„æ—¶å€™æ˜¯è¿™æ ·çš„`a.foo(x)`(å…¶å®æ˜¯`foo(a, x)`)ã€‚ç±»æ–¹æ³•ä¸€æ ·,åªä¸è¿‡å®ƒä¼ é€’çš„æ˜¯ç±»è€Œä¸æ˜¯å®ä¾‹ï¼Œ`A.class_foo(x)`ã€‚æ³¨æ„è¿™é‡Œçš„selfå’Œclså¯ä»¥æ›¿æ¢åˆ«çš„å‚æ•°ï¼Œä½†æ˜¯pythonçš„çº¦å®šæ˜¯è¿™ä¿©ï¼Œè¿˜æ˜¯ä¸è¦æ”¹çš„å¥½ã€‚

å¯¹äºé™æ€æ–¹æ³•å…¶å®å’Œæ™®é€šçš„æ–¹æ³•ä¸€æ ·ï¼Œä¸éœ€è¦å¯¹è°è¿›è¡Œç»‘å®šï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯è°ƒç”¨çš„æ—¶å€™éœ€è¦ä½¿ç”¨ `a.static_foo(x)` æˆ–è€… `A.static_foo(x)` æ¥è°ƒç”¨ã€‚

| \\      | å®ä¾‹æ–¹æ³• | ç±»æ–¹æ³•         | é™æ€æ–¹æ³•        |
| :------ | :------- | :------------- | :-------------- |
| a = A() | a.foo(x) | a.class_foo(x) | a.static_foo(x) |
| A       | ä¸å¯ç”¨   | A.class_foo(x) | A.static_foo(x) |

æ›´å¤šå…³äºè¿™ä¸ªé—®é¢˜:

1. http://stackoverflow.com/questions/136097/what-is-the-difference-between-staticmethod-and-classmethod-in-python
2. https://realpython.com/blog/python/instance-class-and-static-methods-demystified/

### 4.ç±»å˜é‡å’Œå®ä¾‹å˜é‡

**ç±»å˜é‡ï¼š**

æ˜¯å¯åœ¨ç±»çš„æ‰€æœ‰å®ä¾‹ä¹‹é—´å…±äº«çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬ä¸æ˜¯å•ç‹¬åˆ†é…ç»™æ¯ä¸ªå®ä¾‹çš„ï¼‰ã€‚ä¾‹å¦‚ä¸‹ä¾‹ä¸­ï¼Œnum_of_instance å°±æ˜¯ç±»å˜é‡ï¼Œç”¨äºè·Ÿè¸ªå­˜åœ¨ç€å¤šå°‘ä¸ª Test çš„å®ä¾‹ã€‚

**å®ä¾‹å˜é‡ï¼š**

å®ä¾‹åŒ–ä¹‹åï¼Œæ¯ä¸ªå®ä¾‹å•ç‹¬æ‹¥æœ‰çš„å˜é‡ã€‚

```python
class Test(object):  
    num_of_instance = 0  
    def __init__(self, name):  
        self.name = name  
        Test.num_of_instance += 1  
  
if __name__ == '__main__':  
    print Test.num_of_instance   # 0
    t1 = Test('jack')  
    print Test.num_of_instance   # 1
    t2 = Test('lucy')  
    print t1.name , t1.num_of_instance  # jack 2
    print t2.name , t2.num_of_instance  # lucy 2
```

è¡¥å……çš„ä¾‹å­ï¼š

```python
class Person:
    name="aaa"

p1=Person()
p2=Person()
p1.name="bbb"
print p1.name  # bbb
print p2.name  # aaa
print Person.name  # aaa
```

è¿™é‡Œ`p1.name="bbb"`æ˜¯å®ä¾‹è°ƒç”¨äº†ç±»å˜é‡ï¼Œè¿™å…¶å®å’Œä¸Šé¢ç¬¬ä¸€ä¸ªé—®é¢˜ä¸€æ ·ï¼Œå°±æ˜¯å‡½æ•°ä¼ å‚çš„é—®é¢˜ï¼Œ`p1.name` ä¸€å¼€å§‹æ˜¯æŒ‡å‘çš„ç±»å˜é‡`name="aaa"`ï¼Œä½†æ˜¯åœ¨å®ä¾‹çš„ä½œç”¨åŸŸé‡ŒæŠŠç±»å˜é‡çš„å¼•ç”¨æ”¹å˜äº†ï¼Œå°±å˜æˆäº†ä¸€ä¸ªå®ä¾‹å˜é‡ï¼Œ`self.name` ä¸å†å¼•ç”¨Personçš„ç±»å˜é‡nameäº†ã€‚

å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­:

```python
class Person:
    name=[]

p1=Person()
p2=Person()
p1.name.append(1)
print p1.name  # [1]
print p2.name  # [1]
print Person.name  # [1]
```

å‚è€ƒ:http://stackoverflow.com/questions/6470428/catch-multiple-exceptions-in-one-line-except-block

### 5.Pythonè‡ªçœ

è¿™ä¸ªä¹Ÿæ˜¯pythonå½ªæ‚çš„ç‰¹æ€§ã€‚

è‡ªçœå°±æ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€æ‰€å†™çš„ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œæ‰€èƒ½çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼Œç®€å•ä¸€å¥å°±æ˜¯è¿è¡Œæ—¶èƒ½å¤Ÿè·å¾—å¯¹è±¡çš„ç±»å‹ã€‚æ¯”å¦‚type()ï¼Œdir()ï¼Œgetattr()ï¼Œhasattr()ï¼Œisinstance()ã€‚

```python
a = [1,2,3]
b = {'a':1,'b':2,'c':3}
c = True
print type(a),type(b),type(c) # <type 'list'> <type 'dict'> <type 'bool'>
print isinstance(a,list)  # True
```

### 6.å­—å…¸æ¨å¯¼å¼

å¯èƒ½ä½ è§è¿‡åˆ—è¡¨æ¨å¯¼å¼ï¼Œå´æ²¡æœ‰è§è¿‡å­—å…¸æ¨å¯¼å¼ï¼Œåœ¨2.7ä¸­æ‰åŠ å…¥çš„ï¼š

```python
d = {key: value for (key, value) in iterable}
```

### 7.Pythonä¸­å•ä¸‹åˆ’çº¿å’ŒåŒä¸‹åˆ’çº¿

```python
>>> class MyClass():
...     def __init__(self):
...             self.__superprivate = "Hello"
...             self._semiprivate = ", world!"
...
>>> mc = MyClass()
>>> print mc.__superprivate
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
AttributeError: myClass instance has no attribute '__superprivate'
>>> print mc._semiprivate
, world!
>>> print mc.__dict__
{'_MyClass__superprivate': 'Hello', '_semiprivate': ', world!'}
```

`__foo__`ï¼šä¸€ç§çº¦å®šï¼ŒPythonå†…éƒ¨çš„åå­—ï¼Œç”¨æ¥åŒºåˆ«å…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰çš„å‘½åï¼Œä»¥é˜²å†²çªï¼Œå°±æ˜¯ä¾‹å¦‚ï¼š`__init__()`ï¼Œ`__del__()`ï¼Œ`__call__()` è¿™äº›ç‰¹æ®Šæ–¹æ³•ï¼›

`_foo`ï¼šä¸€ç§çº¦å®šï¼Œç”¨æ¥æŒ‡å®šå˜é‡ç§æœ‰ï¼Œç¨‹åºå‘˜ç”¨æ¥æŒ‡å®šç§æœ‰å˜é‡çš„ä¸€ç§æ–¹å¼ã€‚ä¸èƒ½ç”¨ `from module import *` å¯¼å…¥ï¼Œå…¶ä»–æ–¹é¢å’Œå…¬æœ‰ä¸€æ ·è®¿é—®ï¼›

`__foo`ï¼šè¿™ä¸ªæœ‰çœŸæ­£çš„æ„ä¹‰ï¼šè§£æå™¨ç”¨ `_classname__foo` æ¥ä»£æ›¿è¿™ä¸ªåå­—ï¼Œä»¥åŒºåˆ«å’Œå…¶ä»–ç±»ç›¸åŒçš„å‘½åï¼Œå®ƒæ— æ³•ç›´æ¥åƒå…¬æœ‰æˆå‘˜ä¸€æ ·éšä¾¿è®¿é—®ï¼Œé€šè¿‡ `å¯¹è±¡å._ç±»å__xxx` è¿™æ ·çš„æ–¹å¼å¯ä»¥è®¿é—®ã€‚

è¯¦æƒ…è§:http://stackoverflow.com/questions/1301346/the-meaning-of-a-single-and-a-double-underscore-before-an-object-name-in-python

æˆ–è€…: http://www.zhihu.com/question/19754941

### 8.å­—ç¬¦ä¸²æ ¼å¼åŒ–:%å’Œ.format

`.format` åœ¨è®¸å¤šæ–¹é¢çœ‹èµ·æ¥æ›´ä¾¿åˆ©ã€‚å¯¹äº `%` æœ€çƒ¦äººçš„æ˜¯å®ƒæ— æ³•åŒæ—¶ä¼ é€’ä¸€ä¸ªå˜é‡å’Œå…ƒç»„ã€‚ä½ å¯èƒ½ä¼šæƒ³ä¸‹é¢çš„ä»£ç ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜:

```python
"hi there %s" % name
```

ä½†æ˜¯ï¼Œå¦‚æœnameæ°å¥½æ˜¯(1,2,3)ï¼Œå®ƒå°†ä¼šæŠ›å‡ºä¸€ä¸ª TypeError å¼‚å¸¸ã€‚ä¸ºäº†ä¿è¯å®ƒæ€»æ˜¯æ­£ç¡®çš„ï¼Œä½ å¿…é¡»è¿™æ ·åšï¼š

```python
"hi there %s" % (name,)   # æä¾›ä¸€ä¸ªå•å…ƒç´ çš„æ•°ç»„è€Œä¸æ˜¯ä¸€ä¸ªå‚æ•°
```

`.format` å°±æ²¡æœ‰è¿™äº›é—®é¢˜ã€‚

ä¸ºäº†å’ŒPython2.5å…¼å®¹(è­¬å¦‚loggingåº“å»ºè®®ä½¿ç”¨`%`([issue #4](https://github.com/taizilongxu/interview_python/issues/4)))

http://stackoverflow.com/questions/5082452/python-string-formatting-vs-format

### 9.è¿­ä»£å™¨å’Œç”Ÿæˆå™¨

è¿™é‡Œæœ‰ä¸ªå…³äºç”Ÿæˆå™¨çš„åˆ›å»ºé—®é¢˜é¢è¯•å®˜æœ‰è€ƒï¼š
é—®ï¼šå°†åˆ—è¡¨ç”Ÿæˆå¼ä¸­ `[]` æ”¹æˆ `()` ä¹‹åæ•°æ®ç»“æ„æ˜¯å¦æ”¹å˜ï¼Ÿ 
ç­”æ¡ˆï¼šæ˜¯ï¼Œä»åˆ—è¡¨å˜ä¸ºç”Ÿæˆå™¨ã€‚

```python
>>> L = [x*x for x in range(10)]
>>> L
[0, 1, 4, 9, 16, 25, 36, 49, 64, 81]
>>> g = (x*x for x in range(10))
>>> g
<generator object <genexpr> at 0x0000028F8B774200>
```

é€šè¿‡åˆ—è¡¨ç”Ÿæˆå¼ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªåˆ—è¡¨ã€‚ä½†æ˜¯ï¼Œå—åˆ°å†…å­˜é™åˆ¶ï¼Œåˆ—è¡¨å®¹é‡è‚¯å®šæ˜¯æœ‰é™çš„ã€‚è€Œä¸”ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«ç™¾ä¸‡å…ƒç´ çš„åˆ—è¡¨ï¼Œä¸ä»…æ˜¯å ç”¨å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œå¦‚ï¼šæˆ‘ä»¬åªéœ€è¦è®¿é—®å‰é¢çš„å‡ ä¸ªå…ƒç´ ï¼Œåé¢å¤§éƒ¨åˆ†å…ƒç´ æ‰€å çš„ç©ºé—´éƒ½æ˜¯æµªè´¹çš„ã€‚å› æ­¤ï¼Œæ²¡æœ‰å¿…è¦åˆ›å»ºå®Œæ•´çš„åˆ—è¡¨ï¼ˆèŠ‚çœå¤§é‡å†…å­˜ç©ºé—´ï¼‰ã€‚åœ¨Pythonä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç”Ÿæˆå™¨ï¼šè¾¹å¾ªç¯ï¼Œè¾¹è®¡ç®—çš„æœºåˆ¶â€”>generator

è¿­ä»£å™¨æ˜¯éµå¾ªè¿­ä»£åè®®çš„å¯¹è±¡ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨ iter() ä»¥ä»ä»»ä½•åºåˆ—å¾—åˆ°è¿­ä»£å™¨ï¼ˆå¦‚ list, tuple, dictionary, set ç­‰ï¼‰ã€‚å¦ä¸€ä¸ªæ–¹æ³•åˆ™æ˜¯åˆ›å»ºä¸€ä¸ªå¦ä¸€ç§å½¢å¼çš„è¿­ä»£å™¨ â€”â€” generator ã€‚è¦è·å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™ä½¿ç”¨æˆå‘˜å‡½æ•° next()ï¼ˆPython 2ï¼‰æˆ–å‡½æ•° next() function ï¼ˆPython 3ï¼‰ ã€‚å½“æ²¡æœ‰å…ƒç´ æ—¶ï¼Œåˆ™å¼•å‘ StopIteration æ­¤ä¾‹å¤–ã€‚è‹¥è¦å®ç°è‡ªå·±çš„è¿­ä»£å™¨ï¼Œåˆ™åªè¦å®ç° next()ï¼ˆPython 2ï¼‰æˆ– `__next__`()ï¼ˆ Python 3ï¼‰

ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰ï¼Œåªæ˜¯åœ¨éœ€è¦è¿”å›æ•°æ®çš„æ—¶å€™ä½¿ç”¨yieldè¯­å¥ã€‚æ¯æ¬¡next()è¢«è°ƒç”¨æ—¶ï¼Œç”Ÿæˆå™¨ä¼šè¿”å›å®ƒè„±ç¦»çš„ä½ç½®ï¼ˆå®ƒè®°å¿†è¯­å¥æœ€åä¸€æ¬¡æ‰§è¡Œçš„ä½ç½®å’Œæ‰€æœ‰çš„æ•°æ®å€¼ï¼‰

åŒºåˆ«ï¼š ç”Ÿæˆå™¨èƒ½åšåˆ°è¿­ä»£å™¨èƒ½åšçš„æ‰€æœ‰äº‹ï¼Œè€Œä¸”å› ä¸ºè‡ªåŠ¨åˆ›å»ºiter()å’Œnext()æ–¹æ³•ï¼Œç”Ÿæˆå™¨æ˜¾å¾—ç‰¹åˆ«ç®€æ´ï¼Œè€Œä¸”ç”Ÿæˆå™¨ä¹Ÿæ˜¯é«˜æ•ˆçš„ï¼Œä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼å–ä»£åˆ—è¡¨è§£æå¯ä»¥åŒæ—¶èŠ‚çœå†…å­˜ã€‚é™¤äº†åˆ›å»ºå’Œä¿å­˜ç¨‹åºçŠ¶æ€çš„è‡ªåŠ¨æ–¹æ³•ï¼Œå½“å‘ç”Ÿå™¨ç»ˆç»“æ—¶ï¼Œè¿˜ä¼šè‡ªåŠ¨æŠ›å‡ºStopIterationå¼‚å¸¸ã€‚

å®˜æ–¹ä»‹ç»ï¼šhttps://docs.python.org/3/tutorial/classes.html#iterators

### 10.`*args` å’Œ `**kwargs`

ç”¨`*args`å’Œ`**kwargs`åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¹¶æ²¡æœ‰å¼ºåˆ¶ä½¿ç”¨å®ƒä»¬.

å½“ä½ ä¸ç¡®å®šä½ çš„å‡½æ•°é‡Œå°†è¦ä¼ é€’å¤šå°‘å‚æ•°æ—¶ä½ å¯ä»¥ç”¨`*args`.ä¾‹å¦‚,å®ƒå¯ä»¥ä¼ é€’ä»»æ„æ•°é‡çš„å‚æ•°:

```python
>>> def print_everything(*args):
        for count, thing in enumerate(args):
...         print '{0}. {1}'.format(count, thing)
...
>>> print_everything('apple', 'banana', 'cabbage')
1. apple
2. banana
3. cabbage
```

ç›¸ä¼¼çš„,`**kwargs`å…è®¸ä½ ä½¿ç”¨æ²¡æœ‰äº‹å…ˆå®šä¹‰çš„å‚æ•°å:

```python
>>> def table_things(**kwargs):
...     for name, value in kwargs.items():
...         print '{0} = {1}'.format(name, value)
...
>>> table_things(apple = 'fruit', cabbage = 'vegetable')
cabbage = vegetable
apple = fruit
```

ä½ ä¹Ÿå¯ä»¥æ··ç€ç”¨.å‘½åå‚æ•°é¦–å…ˆè·å¾—å‚æ•°å€¼ç„¶åæ‰€æœ‰çš„å…¶ä»–å‚æ•°éƒ½ä¼ é€’ç»™`*args`å’Œ`**kwargs`.å‘½åå‚æ•°åœ¨åˆ—è¡¨çš„æœ€å‰ç«¯.ä¾‹å¦‚:

```python
def table_things(titlestring, **kwargs)
```

`*args`å’Œ`**kwargs`å¯ä»¥åŒæ—¶åœ¨å‡½æ•°çš„å®šä¹‰ä¸­,ä½†æ˜¯`*args`å¿…é¡»åœ¨`**kwargs`å‰é¢.

å½“è°ƒç”¨å‡½æ•°æ—¶ä½ ä¹Ÿå¯ä»¥ç”¨`*`å’Œ`**`è¯­æ³•.ä¾‹å¦‚:

```python
>>> def print_three_things(a, b, c):
...     print 'a = {0}, b = {1}, c = {2}'.format(a,b,c)
...
>>> mylist = ['aardvark', 'baboon', 'cat']
>>> print_three_things(*mylist)

a = aardvark, b = baboon, c = cat
```

å°±åƒä½ çœ‹åˆ°çš„ä¸€æ ·,å®ƒå¯ä»¥ä¼ é€’åˆ—è¡¨(æˆ–è€…å…ƒç»„)çš„æ¯ä¸€é¡¹å¹¶æŠŠå®ƒä»¬è§£åŒ….æ³¨æ„å¿…é¡»ä¸å®ƒä»¬åœ¨å‡½æ•°é‡Œçš„å‚æ•°ç›¸å»åˆ.å½“ç„¶,ä½ ä¹Ÿå¯ä»¥åœ¨å‡½æ•°å®šä¹‰æˆ–è€…å‡½æ•°è°ƒç”¨æ—¶ç”¨ `*`.

http://stackoverflow.com/questions/3394835/args-and-kwargs

### 11.é¢å‘åˆ‡é¢ç¼–ç¨‹AOPå’Œè£…é¥°å™¨

è¿™ä¸ªAOPä¸€å¬èµ·æ¥æœ‰ç‚¹æ‡µ,åŒå­¦é¢é˜¿é‡Œçš„æ—¶å€™å°±è¢«é—®æ‡µäº†...

è£…é¥°å™¨æ˜¯ä¸€ä¸ªå¾ˆè‘—åçš„è®¾è®¡æ¨¡å¼ï¼Œç»å¸¸è¢«ç”¨äºæœ‰åˆ‡é¢éœ€æ±‚çš„åœºæ™¯ï¼Œè¾ƒä¸ºç»å…¸çš„æœ‰æ’å…¥æ—¥å¿—ã€æ€§èƒ½æµ‹è¯•ã€äº‹åŠ¡å¤„ç†ç­‰ã€‚è£…é¥°å™¨æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„ç»ä½³è®¾è®¡ï¼Œæœ‰äº†è£…é¥°å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠ½ç¦»å‡ºå¤§é‡å‡½æ•°ä¸­ä¸å‡½æ•°åŠŸèƒ½æœ¬èº«æ— å…³çš„é›·åŒä»£ç å¹¶ç»§ç»­é‡ç”¨ã€‚

æ¦‚æ‹¬çš„è®²ï¼Œ**è£…é¥°å™¨çš„ä½œç”¨å°±æ˜¯ä¸ºå·²ç»å­˜åœ¨çš„å¯¹è±¡æ·»åŠ é¢å¤–çš„åŠŸèƒ½ã€‚**

æ¨èï¼š[Python é¢å‘åˆ‡é¢ç¼–ç¨‹ AOP å’Œè£…é¥°å™¨](https://mp.weixin.qq.com/s?src=11&timestamp=1619481363&ver=3033&signature=qVv9*2qGxuNtx6Ux5I7veLnQ5NS*CFBHXVzQGduiKVX8hodBvoasdAknUqzWoYBOuYQxnXKAWBOEwLEtq6SYtRPFbxh*QBQmtv6TvjpXwAbdC4X3xHN0FVydhEoQkbv8&new=1)

### 12.é¸­å­ç±»å‹

â€œå½“çœ‹åˆ°ä¸€åªé¸Ÿèµ°èµ·æ¥åƒé¸­å­ã€æ¸¸æ³³èµ·æ¥åƒé¸­å­ã€å«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£ä¹ˆè¿™åªé¸Ÿå°±å¯ä»¥è¢«ç§°ä¸ºé¸­å­ã€‚â€

æˆ‘ä»¬å¹¶ä¸å…³å¿ƒå¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Œåˆ°åº•æ˜¯ä¸æ˜¯é¸­å­ï¼Œåªå…³å¿ƒè¡Œä¸ºã€‚

æ¯”å¦‚åœ¨pythonä¸­ï¼Œæœ‰å¾ˆå¤šfile-likeçš„ä¸œè¥¿ï¼Œæ¯”å¦‚StringIO,GzipFile,socketã€‚å®ƒä»¬æœ‰å¾ˆå¤šç›¸åŒçš„æ–¹æ³•ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬å½“ä½œæ–‡ä»¶ä½¿ç”¨ã€‚

åˆæ¯”å¦‚list.extend()æ–¹æ³•ä¸­,æˆ‘ä»¬å¹¶ä¸å…³å¿ƒå®ƒçš„å‚æ•°æ˜¯ä¸æ˜¯list,åªè¦å®ƒæ˜¯å¯è¿­ä»£çš„,æ‰€ä»¥å®ƒçš„å‚æ•°å¯ä»¥æ˜¯list/tuple/dict/å­—ç¬¦ä¸²/ç”Ÿæˆå™¨ç­‰.

é¸­å­ç±»å‹åœ¨åŠ¨æ€è¯­è¨€ä¸­ç»å¸¸ä½¿ç”¨ï¼Œéå¸¸çµæ´»ï¼Œä½¿å¾—pythonä¸æƒ³javaé‚£æ ·ä¸“é—¨å»å¼„ä¸€å¤§å †çš„è®¾è®¡æ¨¡å¼ã€‚

æ¨èï¼šhttps://cloud.tencent.com/developer/article/1484390

### 13.Pythonä¸­é‡è½½

å¼•è‡ªçŸ¥ä¹:http://www.zhihu.com/question/20053359

å‡½æ•°é‡è½½ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸¤ä¸ªé—®é¢˜ã€‚

1. å¯å˜å‚æ•°ç±»å‹ã€‚
2. å¯å˜å‚æ•°ä¸ªæ•°ã€‚

å¦å¤–ï¼Œä¸€ä¸ªåŸºæœ¬çš„è®¾è®¡åŸåˆ™æ˜¯ï¼Œä»…ä»…å½“ä¸¤ä¸ªå‡½æ•°é™¤äº†å‚æ•°ç±»å‹å’Œå‚æ•°ä¸ªæ•°ä¸åŒä»¥å¤–ï¼Œå…¶åŠŸèƒ½æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œæ­¤æ—¶æ‰ä½¿ç”¨å‡½æ•°é‡è½½ï¼Œå¦‚æœä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½å…¶å®ä¸åŒï¼Œé‚£ä¹ˆä¸åº”å½“ä½¿ç”¨é‡è½½ï¼Œè€Œåº”å½“ä½¿ç”¨ä¸€ä¸ªåå­—ä¸åŒçš„å‡½æ•°ã€‚

å¥½å§ï¼Œé‚£ä¹ˆå¯¹äºæƒ…å†µ 1ï¼Œå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œä½†æ˜¯å‚æ•°ç±»å‹ä¸åŒï¼Œpython å¦‚ä½•å¤„ç†ï¼Ÿç­”æ¡ˆæ˜¯æ ¹æœ¬ä¸éœ€è¦å¤„ç†ï¼Œå› ä¸º python å¯ä»¥æ¥å—ä»»ä½•ç±»å‹çš„å‚æ•°ï¼Œå¦‚æœå‡½æ•°çš„åŠŸèƒ½ç›¸åŒï¼Œé‚£ä¹ˆä¸åŒçš„å‚æ•°ç±»å‹åœ¨ python ä¸­å¾ˆå¯èƒ½æ˜¯ç›¸åŒçš„ä»£ç ï¼Œæ²¡æœ‰å¿…è¦åšæˆä¸¤ä¸ªä¸åŒå‡½æ•°ã€‚

é‚£ä¹ˆå¯¹äºæƒ…å†µ 2ï¼Œå‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œä½†å‚æ•°ä¸ªæ•°ä¸åŒï¼Œpython å¦‚ä½•å¤„ç†ï¼Ÿå¤§å®¶çŸ¥é“ï¼Œç­”æ¡ˆå°±æ˜¯ç¼ºçœå‚æ•°ã€‚å¯¹é‚£äº›ç¼ºå°‘çš„å‚æ•°è®¾å®šä¸ºç¼ºçœå‚æ•°å³å¯è§£å†³é—®é¢˜ã€‚å› ä¸ºä½ å‡è®¾å‡½æ•°åŠŸèƒ½ç›¸åŒï¼Œé‚£ä¹ˆé‚£äº›ç¼ºå°‘çš„å‚æ•°ç»ˆå½’æ˜¯éœ€è¦ç”¨çš„ã€‚

å¥½äº†ï¼Œé‰´äºæƒ…å†µ 1 è·Ÿæƒ…å†µ 2 éƒ½æœ‰äº†è§£å†³æ–¹æ¡ˆï¼Œpython è‡ªç„¶å°±ä¸éœ€è¦å‡½æ•°é‡è½½äº†ã€‚

### 14.æ–°å¼ç±»å’Œæ—§å¼ç±»

è¿™ä¸ªé¢è¯•å®˜é—®äº†ï¼Œæˆ‘è¯´äº†è€åŠå¤©ï¼Œä¸çŸ¥é“ä»–é—®çš„çœŸæ­£æ„å›¾æ˜¯ä»€ä¹ˆã€‚

[stackoverflow](http://stackoverflow.com/questions/54867/what-is-the-difference-between-old-style-and-new-style-classes-in-python)

è¿™ç¯‡æ–‡ç« å¾ˆå¥½çš„ä»‹ç»äº†æ–°å¼ç±»çš„ç‰¹æ€§: http://www.cnblogs.com/btchenguang/archive/2012/09/17/2689146.html

æ–°å¼ç±»å¾ˆæ—©åœ¨2.2å°±å‡ºç°äº†ï¼Œæ‰€ä»¥æ—§å¼ç±»å®Œå…¨æ˜¯å…¼å®¹çš„é—®é¢˜ï¼ŒPython3 é‡Œçš„ç±»å…¨éƒ¨éƒ½æ˜¯æ–°å¼ç±»ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª MRO é—®é¢˜å¯ä»¥äº†è§£ä¸‹(æ–°å¼ç±»ç»§æ‰¿æ˜¯æ ¹æ®C3ç®—æ³•ï¼Œæ—§å¼ç±»æ˜¯æ·±åº¦ä¼˜å…ˆ)ï¼Œ<Pythonæ ¸å¿ƒç¼–ç¨‹>é‡Œè®²çš„ä¹Ÿå¾ˆå¤šã€‚

> ä¸€ä¸ªæ—§å¼ç±»çš„æ·±åº¦ä¼˜å…ˆçš„ä¾‹å­

```python
class A():
    def foo1(self):
        print "A"
class B(A):
    def foo2(self):
        pass
class C(A):
    def foo1(self):
        print "C"
class D(B, C):
    pass

d = D()
d.foo1()

# A
```

**æŒ‰ç…§ç»å…¸ç±»çš„æŸ¥æ‰¾é¡ºåº`ä»å·¦åˆ°å³æ·±åº¦ä¼˜å…ˆ`çš„è§„åˆ™ï¼Œåœ¨è®¿é—®`d.foo1()`çš„æ—¶å€™,Dè¿™ä¸ªç±»æ˜¯æ²¡æœ‰çš„..é‚£ä¹ˆå¾€ä¸ŠæŸ¥æ‰¾,å…ˆæ‰¾åˆ°B,é‡Œé¢æ²¡æœ‰,æ·±åº¦ä¼˜å…ˆ,è®¿é—®A,æ‰¾åˆ°äº†foo1(),æ‰€ä»¥è¿™æ—¶å€™è°ƒç”¨çš„æ˜¯Açš„foo1()ï¼Œä»è€Œå¯¼è‡´Cé‡å†™çš„foo1()è¢«ç»•è¿‡**

### 15.`__new__`å’Œ`__init__`çš„åŒºåˆ«

è¿™ä¸ª`__new__`ç¡®å®å¾ˆå°‘è§åˆ°,å…ˆåšäº†è§£å§.

1. `__new__`æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•,è€Œ`__init__`æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•.
2. `__new__`æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªåˆ›å»ºçš„å®ä¾‹,è€Œ`__init__`ä»€ä¹ˆéƒ½ä¸è¿”å›.
3. åªæœ‰åœ¨`__new__`è¿”å›ä¸€ä¸ªclsçš„å®ä¾‹æ—¶åé¢çš„`__init__`æ‰èƒ½è¢«è°ƒç”¨.
4. å½“åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹æ—¶è°ƒç”¨`__new__`,åˆå§‹åŒ–ä¸€ä¸ªå®ä¾‹æ—¶ç”¨`__init__`.

[stackoverflow](http://stackoverflow.com/questions/674304/pythons-use-of-new-and-init)

ps: `__metaclass__`æ˜¯åˆ›å»ºç±»æ—¶èµ·ä½œç”¨.æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ä½¿ç”¨`__metaclass__`,`__new__`å’Œ`__init__`æ¥åˆ†åˆ«åœ¨ç±»åˆ›å»º,å®ä¾‹åˆ›å»ºå’Œå®ä¾‹åˆå§‹åŒ–çš„æ—¶å€™åšä¸€äº›å°æ‰‹è„š.

### 16.å•ä¾‹æ¨¡å¼

> â€‹	å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§å¸¸ç”¨çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚åœ¨å®ƒçš„æ ¸å¿ƒç»“æ„ä¸­åªåŒ…å«ä¸€ä¸ªè¢«ç§°ä¸ºå•ä¾‹ç±»çš„ç‰¹æ®Šç±»ã€‚é€šè¿‡å•ä¾‹æ¨¡å¼å¯ä»¥ä¿è¯ç³»ç»Ÿä¸­ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹è€Œä¸”è¯¥å®ä¾‹æ˜“äºå¤–ç•Œè®¿é—®ï¼Œä»è€Œæ–¹ä¾¿å¯¹å®ä¾‹ä¸ªæ•°çš„æ§åˆ¶å¹¶èŠ‚çº¦ç³»ç»Ÿèµ„æºã€‚å¦‚æœå¸Œæœ›åœ¨ç³»ç»Ÿä¸­æŸä¸ªç±»çš„å¯¹è±¡åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œå•ä¾‹æ¨¡å¼æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚
>
> `__new__()`åœ¨`__init__()`ä¹‹å‰è¢«è°ƒç”¨ï¼Œç”¨äºç”Ÿæˆå®ä¾‹å¯¹è±¡ã€‚åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å’Œç±»çš„å±æ€§çš„ç‰¹ç‚¹å¯ä»¥å®ç°è®¾è®¡æ¨¡å¼çš„å•ä¾‹æ¨¡å¼ã€‚å•ä¾‹æ¨¡å¼æ˜¯æŒ‡åˆ›å»ºå”¯ä¸€å¯¹è±¡ï¼Œå•ä¾‹æ¨¡å¼è®¾è®¡çš„ç±»åªèƒ½å®ä¾‹
> **è¿™ä¸ªç»å¯¹å¸¸è€ƒå•Š.ç»å¯¹è¦è®°ä½1~2ä¸ªæ–¹æ³•,å½“æ—¶é¢è¯•å®˜æ˜¯è®©æ‰‹å†™çš„.**

#### 1 ä½¿ç”¨`__new__`æ–¹æ³•

```python
class Singleton(object):
    def __new__(cls, *args, **kw):
        if not hasattr(cls, '_instance'):
            orig = super(Singleton, cls)
            cls._instance = orig.__new__(cls, *args, **kw)
        return cls._instance

class MyClass(Singleton):
    a = 1
```

#### 2 å…±äº«å±æ€§

åˆ›å»ºå®ä¾‹æ—¶æŠŠæ‰€æœ‰å®ä¾‹çš„`__dict__`æŒ‡å‘åŒä¸€ä¸ªå­—å…¸,è¿™æ ·å®ƒä»¬å…·æœ‰ç›¸åŒçš„å±æ€§å’Œæ–¹æ³•.

```python
class Borg(object):
    _state = {}
    def __new__(cls, *args, **kw):
        ob = super(Borg, cls).__new__(cls, *args, **kw)
        ob.__dict__ = cls._state
        return ob

class MyClass2(Borg):
    a = 1
```

#### 3 è£…é¥°å™¨ç‰ˆæœ¬

```python
def singleton(cls):
    instances = {}
    def getinstance(*args, **kw):
        if cls not in instances:
            instances[cls] = cls(*args, **kw)
        return instances[cls]
    return getinstance

@singleton
class MyClass:
  ...
```

#### 4 importæ–¹æ³•

ä½œä¸ºpythonçš„æ¨¡å—æ˜¯å¤©ç„¶çš„å•ä¾‹æ¨¡å¼

```python
class My_Singleton(object):
    def foo(self):
        pass

my_singleton = My_Singleton()

# to use
from mysingleton import my_singleton

my_singleton.foo()
```

æ¨èï¼š[å•ä¾‹æ¨¡å¼è¯¦ç»†è§£é‡Š](https://www.cnblogs.com/huchong/p/8244279.html)

### 17.Pythonä¸­çš„ä½œç”¨åŸŸ

å‡½æ•°ä½œç”¨åŸŸçš„ LEGB é¡ºåºï¼š

Lï¼šlocal å‡½æ•°å†…éƒ¨ä½œç”¨åŸŸ

Eï¼šenclosing å‡½æ•°å†…éƒ¨ä¸å†…åµŒå‡½æ•°ä¹‹é—´

Gï¼šglobal å…¨å±€ä½œç”¨åŸŸ

Bï¼šbuild-in å†…ç½®ä½œç”¨åŸŸ

Python ä¸­ï¼Œä¸€ä¸ªå˜é‡çš„ä½œç”¨åŸŸæ€»æ˜¯ç”±åœ¨ä»£ç ä¸­è¢«èµ‹å€¼çš„åœ°æ–¹æ‰€å†³å®šçš„ã€‚

å½“ Python é‡åˆ°ä¸€ä¸ªå˜é‡çš„è¯ä»–ä¼šæŒ‰ç…§è¿™æ ·çš„é¡ºåºè¿›è¡Œæœç´¢ï¼š

æœ¬åœ°ä½œç”¨åŸŸï¼ˆLocalï¼‰â†’å½“å‰ä½œç”¨åŸŸè¢«åµŒå…¥çš„æœ¬åœ°ä½œç”¨åŸŸï¼ˆEnclosing localsï¼‰â†’å…¨å±€/æ¨¡å—ä½œç”¨åŸŸï¼ˆGlobalï¼‰â†’å†…ç½®ä½œç”¨åŸŸï¼ˆBuilt-inï¼‰

### 18.GILçº¿ç¨‹å…¨å±€é”

çº¿ç¨‹å…¨å±€é”(Global Interpreter Lock),å³Pythonä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨è€Œé‡‡å–çš„ç‹¬ç«‹çº¿ç¨‹è¿è¡Œçš„é™åˆ¶,è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªæ ¸åªèƒ½åœ¨åŒä¸€æ—¶é—´è¿è¡Œä¸€ä¸ªçº¿ç¨‹.**å¯¹äºioå¯†é›†å‹ä»»åŠ¡ï¼Œpythonçš„å¤šçº¿ç¨‹èµ·åˆ°ä½œç”¨ï¼Œä½†å¯¹äºcpuå¯†é›†å‹ä»»åŠ¡ï¼Œpythonçš„å¤šçº¿ç¨‹å‡ ä¹å ä¸åˆ°ä»»ä½•ä¼˜åŠ¿ï¼Œè¿˜æœ‰å¯èƒ½å› ä¸ºäº‰å¤ºèµ„æºè€Œå˜æ…¢ã€‚**

è§[Python æœ€éš¾çš„é—®é¢˜](http://www.oschina.net/translate/pythons-hardest-problem)
æ¨èï¼šhttps://zhuanlan.zhihu.com/p/75780308

è§£å†³åŠæ³•å°±æ˜¯å¤šè¿›ç¨‹å’Œä¸‹é¢çš„åç¨‹(åç¨‹ä¹Ÿåªæ˜¯å•CPU,ä½†æ˜¯èƒ½å‡å°åˆ‡æ¢ä»£ä»·æå‡æ€§èƒ½).

### 19.åç¨‹

çŸ¥ä¹è¢«é—®åˆ°äº†,å‘µå‘µå“’,è·ªäº†

ç®€å•ç‚¹è¯´åç¨‹æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹çš„å‡çº§ç‰ˆ,è¿›ç¨‹å’Œçº¿ç¨‹éƒ½é¢ä¸´ç€å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢é—®é¢˜è€Œè€—è´¹è®¸å¤šåˆ‡æ¢æ—¶é—´,è€Œåç¨‹å°±æ˜¯ç”¨æˆ·è‡ªå·±æ§åˆ¶åˆ‡æ¢çš„æ—¶æœº,ä¸å†éœ€è¦é™·å…¥ç³»ç»Ÿçš„å†…æ ¸æ€.

Pythoné‡Œæœ€å¸¸è§çš„yieldå°±æ˜¯åç¨‹çš„æ€æƒ³!å¯ä»¥æŸ¥çœ‹ç¬¬ä¹ä¸ªé—®é¢˜.

æ¨èï¼šhttps://www.liaoxuefeng.com/wiki/897692888725344/923057403198272

### 20.é—­åŒ…

é—­åŒ…(closure)æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„é‡è¦çš„è¯­æ³•ç»“æ„ã€‚é—­åŒ…ä¹Ÿæ˜¯ä¸€ç§ç»„ç»‡ä»£ç çš„ç»“æ„ï¼Œå®ƒåŒæ ·æé«˜äº†ä»£ç çš„å¯é‡å¤ä½¿ç”¨æ€§ã€‚

å½“ä¸€ä¸ªå†…åµŒå‡½æ•°å¼•ç”¨å…¶å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡,æˆ‘ä»¬å°±ä¼šå¾—åˆ°ä¸€ä¸ªé—­åŒ…. æ€»ç»“ä¸€ä¸‹,åˆ›å»ºä¸€ä¸ªé—­åŒ…å¿…é¡»æ»¡è¶³ä»¥ä¸‹å‡ ç‚¹:

1. å¿…é¡»æœ‰ä¸€ä¸ªå†…åµŒå‡½æ•°
2. å†…åµŒå‡½æ•°å¿…é¡»å¼•ç”¨å¤–éƒ¨å‡½æ•°ä¸­çš„å˜é‡
3. å¤–éƒ¨å‡½æ•°çš„è¿”å›å€¼å¿…é¡»æ˜¯å†…åµŒå‡½æ•°

æ„Ÿè§‰é—­åŒ…è¿˜æ˜¯æœ‰éš¾åº¦çš„,å‡ å¥è¯æ˜¯è¯´ä¸æ˜ç™½çš„,è¿˜æ˜¯æŸ¥æŸ¥ç›¸å…³èµ„æ–™.

é‡ç‚¹æ˜¯å‡½æ•°è¿è¡Œåå¹¶ä¸ä¼šè¢«æ’¤é”€,å°±åƒ16é¢˜çš„instanceå­—å…¸ä¸€æ ·,å½“å‡½æ•°è¿è¡Œå®Œå,instanceå¹¶ä¸è¢«é”€æ¯,è€Œæ˜¯ç»§ç»­ç•™åœ¨å†…å­˜ç©ºé—´é‡Œ.è¿™ä¸ªåŠŸèƒ½ç±»ä¼¼ç±»é‡Œçš„ç±»å˜é‡,åªä¸è¿‡è¿ç§»åˆ°äº†å‡½æ•°ä¸Š.

é—­åŒ…å°±åƒä¸ªç©ºå¿ƒçƒä¸€æ ·,ä½ çŸ¥é“å¤–é¢å’Œé‡Œé¢,ä½†ä½ ä¸çŸ¥é“ä¸­é—´æ˜¯ä»€ä¹ˆæ ·.

### 21.lambdaå‡½æ•°

å…¶å®å°±æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°,ä¸ºä»€ä¹ˆå«lambda?å› ä¸ºå’Œåé¢çš„å‡½æ•°å¼ç¼–ç¨‹æœ‰å…³.

æ¨è: [çŸ¥ä¹](http://www.zhihu.com/question/20125256)

### 22.Pythonå‡½æ•°å¼ç¼–ç¨‹

è¿™ä¸ªéœ€è¦é€‚å½“çš„äº†è§£ä¸€ä¸‹å§,æ¯•ç«Ÿå‡½æ•°å¼ç¼–ç¨‹åœ¨Pythonä¸­ä¹Ÿåšäº†å¼•ç”¨.

æ¨è: [é…·å£³](http://coolshell.cn/articles/10822.html)

pythonä¸­å‡½æ•°å¼ç¼–ç¨‹æ”¯æŒ:

filter å‡½æ•°çš„åŠŸèƒ½ç›¸å½“äºè¿‡æ»¤å™¨ã€‚è°ƒç”¨ä¸€ä¸ªå¸ƒå°”å‡½æ•°`bool_func`æ¥è¿­ä»£éå†æ¯ä¸ªseqä¸­çš„å…ƒç´ ï¼›è¿”å›ä¸€ä¸ªä½¿`bool_seq`è¿”å›å€¼ä¸ºtrueçš„å…ƒç´ çš„åºåˆ—ã€‚

```python
>>>a = [1,2,3,4,5,6,7]
>>>b = filter(lambda x: x > 5, a)
>>>print b
>>>[6,7]
```

mapå‡½æ•°æ˜¯å¯¹ä¸€ä¸ªåºåˆ—çš„æ¯ä¸ªé¡¹ä¾æ¬¡æ‰§è¡Œå‡½æ•°ï¼Œä¸‹é¢æ˜¯å¯¹ä¸€ä¸ªåºåˆ—æ¯ä¸ªé¡¹éƒ½ä¹˜ä»¥2ï¼š

```python
>>> a = map(lambda x:x*2,[1,2,3])
>>> list(a)
[2, 4, 6]
```

reduceå‡½æ•°æ˜¯å¯¹ä¸€ä¸ªåºåˆ—çš„æ¯ä¸ªé¡¹è¿­ä»£è°ƒç”¨å‡½æ•°ï¼Œä¸‹é¢æ˜¯æ±‚3çš„é˜¶ä¹˜ï¼š

```python
>>> reduce(lambda x,y:x*y,range(1,4))
6
```

### 23.Pythoné‡Œçš„æ‹·è´

å¼•ç”¨å’Œcopy(),deepcopy()çš„åŒºåˆ«

```python
import copy
a = [1, 2, 3, 4, ['a', 'b']]  #åŸå§‹å¯¹è±¡

b = a  #èµ‹å€¼ï¼Œä¼ å¯¹è±¡çš„å¼•ç”¨
c = copy.copy(a)  #å¯¹è±¡æ‹·è´ï¼Œæµ…æ‹·è´
d = copy.deepcopy(a)  #å¯¹è±¡æ‹·è´ï¼Œæ·±æ‹·è´

a.append(5)  #ä¿®æ”¹å¯¹è±¡a
a[4].append('c')  #ä¿®æ”¹å¯¹è±¡aä¸­çš„['a', 'b']æ•°ç»„å¯¹è±¡

print 'a = ', a
print 'b = ', b
print 'c = ', c
print 'd = ', d

è¾“å‡ºç»“æœï¼š
a =  [1, 2, 3, 4, ['a', 'b', 'c'], 5]
b =  [1, 2, 3, 4, ['a', 'b', 'c'], 5]
c =  [1, 2, 3, 4, ['a', 'b', 'c']]
d =  [1, 2, 3, 4, ['a', 'b']]
```

### 24.Pythonåƒåœ¾å›æ”¶æœºåˆ¶

Python GC ä¸»è¦ä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼ˆreference countingï¼‰æ¥è·Ÿè¸ªå’Œå›æ”¶åƒåœ¾ã€‚åœ¨å¼•ç”¨è®¡æ•°çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡â€œæ ‡è®°-æ¸…é™¤â€ï¼ˆmark and sweepï¼‰è§£å†³å®¹å™¨å¯¹è±¡å¯èƒ½äº§ç”Ÿçš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œé€šè¿‡â€œåˆ†ä»£å›æ”¶â€ï¼ˆgeneration collectionï¼‰ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•æé«˜åƒåœ¾å›æ”¶æ•ˆç‡ã€‚

#### 1 å¼•ç”¨è®¡æ•°

PyObjectæ˜¯æ¯ä¸ªå¯¹è±¡å¿…æœ‰çš„å†…å®¹ï¼Œå…¶ä¸­`ob_refcnt`å°±æ˜¯åšä¸ºå¼•ç”¨è®¡æ•°ã€‚å½“ä¸€ä¸ªå¯¹è±¡æœ‰æ–°çš„å¼•ç”¨æ—¶ï¼Œå®ƒçš„`ob_refcnt`å°±ä¼šå¢åŠ ï¼Œå½“å¼•ç”¨å®ƒçš„å¯¹è±¡è¢«åˆ é™¤ï¼Œå®ƒçš„`ob_refcnt`å°±ä¼šå‡å°‘.å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œè¯¥å¯¹è±¡ç”Ÿå‘½å°±ç»“æŸäº†ã€‚

ä¼˜ç‚¹:

1. ç®€å•
2. å®æ—¶æ€§

ç¼ºç‚¹:

1. ç»´æŠ¤å¼•ç”¨è®¡æ•°æ¶ˆè€—èµ„æº
2. å¾ªç¯å¼•ç”¨

#### 2 æ ‡è®°-æ¸…é™¤æœºåˆ¶

åŸºæœ¬æ€è·¯æ˜¯å…ˆæŒ‰éœ€åˆ†é…ï¼Œç­‰åˆ°æ²¡æœ‰ç©ºé—²å†…å­˜çš„æ—¶å€™ä»å¯„å­˜å™¨å’Œç¨‹åºæ ˆä¸Šçš„å¼•ç”¨å‡ºå‘ï¼Œéå†ä»¥å¯¹è±¡ä¸ºèŠ‚ç‚¹ã€ä»¥å¼•ç”¨ä¸ºè¾¹æ„æˆçš„å›¾ï¼ŒæŠŠæ‰€æœ‰å¯ä»¥è®¿é—®åˆ°çš„å¯¹è±¡æ‰“ä¸Šæ ‡è®°ï¼Œç„¶åæ¸…æ‰«ä¸€éå†…å­˜ç©ºé—´ï¼ŒæŠŠæ‰€æœ‰æ²¡æ ‡è®°çš„å¯¹è±¡é‡Šæ”¾ã€‚

#### 3 åˆ†ä»£æŠ€æœ¯

åˆ†ä»£å›æ”¶çš„æ•´ä½“æ€æƒ³æ˜¯ï¼šå°†ç³»ç»Ÿä¸­çš„æ‰€æœ‰å†…å­˜å—æ ¹æ®å…¶å­˜æ´»æ—¶é—´åˆ’åˆ†ä¸ºä¸åŒçš„é›†åˆï¼Œæ¯ä¸ªé›†åˆå°±æˆä¸ºä¸€ä¸ªâ€œä»£â€ï¼Œåƒåœ¾æ”¶é›†é¢‘ç‡éšç€â€œä»£â€çš„å­˜æ´»æ—¶é—´çš„å¢å¤§è€Œå‡å°ï¼Œå­˜æ´»æ—¶é—´é€šå¸¸åˆ©ç”¨ç»è¿‡å‡ æ¬¡åƒåœ¾å›æ”¶æ¥åº¦é‡ã€‚

Pythoné»˜è®¤å®šä¹‰äº†ä¸‰ä»£å¯¹è±¡é›†åˆï¼Œç´¢å¼•æ•°è¶Šå¤§ï¼Œå¯¹è±¡å­˜æ´»æ—¶é—´è¶Šé•¿ã€‚

ä¸¾ä¾‹ï¼š
å½“æŸäº›å†…å­˜å—Mç»è¿‡äº†3æ¬¡åƒåœ¾æ”¶é›†çš„æ¸…æ´—ä¹‹åè¿˜å­˜æ´»æ—¶ï¼Œæˆ‘ä»¬å°±å°†å†…å­˜å—Måˆ’åˆ°ä¸€ä¸ªé›†åˆAä¸­å»ï¼Œè€Œæ–°åˆ†é…çš„å†…å­˜éƒ½åˆ’åˆ†åˆ°é›†åˆBä¸­å»ã€‚å½“åƒåœ¾æ”¶é›†å¼€å§‹å·¥ä½œæ—¶ï¼Œå¤§å¤šæ•°æƒ…å†µéƒ½åªå¯¹é›†åˆBè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè€Œå¯¹é›†åˆAè¿›è¡Œåƒåœ¾å›æ”¶è¦éš”ç›¸å½“é•¿ä¸€æ®µæ—¶é—´åæ‰è¿›è¡Œï¼Œè¿™å°±ä½¿å¾—åƒåœ¾æ”¶é›†æœºåˆ¶éœ€è¦å¤„ç†çš„å†…å­˜å°‘äº†ï¼Œæ•ˆç‡è‡ªç„¶å°±æé«˜äº†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œé›†åˆBä¸­çš„æŸäº›å†…å­˜å—ç”±äºå­˜æ´»æ—¶é—´é•¿è€Œä¼šè¢«è½¬ç§»åˆ°é›†åˆAä¸­ï¼Œå½“ç„¶ï¼Œé›†åˆAä¸­å®é™…ä¸Šä¹Ÿå­˜åœ¨ä¸€äº›åƒåœ¾ï¼Œè¿™äº›åƒåœ¾çš„å›æ”¶ä¼šå› ä¸ºè¿™ç§åˆ†ä»£çš„æœºåˆ¶è€Œè¢«å»¶è¿Ÿã€‚

æ¨èï¼šhttps://zhuanlan.zhihu.com/p/83251959

### 25.Pythonçš„List

æ¨è: http://www.jianshu.com/p/J4U6rR

### 26.Pythonçš„is

isæ˜¯å¯¹æ¯”åœ°å€,==æ˜¯å¯¹æ¯”å€¼

### 27.read,readlineå’Œreadlines

- read        è¯»å–æ•´ä¸ªæ–‡ä»¶
- readline    è¯»å–ä¸‹ä¸€è¡Œ,ä½¿ç”¨ç”Ÿæˆå™¨æ–¹æ³•
- readlines   è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°ä¸€ä¸ªè¿­ä»£å™¨ä»¥ä¾›æˆ‘ä»¬éå†

### 28.Python2å’Œ3çš„åŒºåˆ«

æ¨èï¼š[Python 2.7.x ä¸ Python 3.x çš„ä¸»è¦å·®å¼‚](http://chenqx.github.io/2014/11/10/Key-differences-between-Python-2-7-x-and-Python-3-x/)

### 29.super init

super() lets you avoid referring to the base class explicitly, which can be nice. But the main advantage comes with multiple inheritance, where all sorts of fun stuff can happen. See the standard docs on super if you haven't already.

Note that the syntax changed in Python 3.0: you can just say super().`__init__`() instead of super(ChildB, self).`__init__`() which IMO is quite a bit nicer.

http://stackoverflow.com/questions/576169/understanding-python-super-with-init-methods

[Python2.7ä¸­çš„superæ–¹æ³•æµ…è§](http://blog.csdn.net/mrlevo520/article/details/51712440)

https://python3-cookbook.readthedocs.io/zh_CN/latest/c08/p07_calling_method_on_parent_class.html

### 30.range and xrange

éƒ½åœ¨å¾ªç¯æ—¶ä½¿ç”¨ï¼Œxrangeå†…å­˜æ€§èƒ½æ›´å¥½ã€‚
for i in range(0, 20):
for i in xrange(0, 20):
What is the difference between range and xrange functions in Python 2.X?
 range creates a list, so if you do range(1, 10000000) it creates a list in memory with 9999999 elements.
 xrange is a sequence object that evaluates lazily.

http://stackoverflow.com/questions/94935/what-is-the-difference-between-range-and-xrange-functions-in-python-2-x


### 31 python å­—å…¸çš„å†…éƒ¨å®ç°åŸç†ä»‹ç»

https://cloud.tencent.com/developer/article/1664241

# PythonåŸºç¡€

## æ–‡ä»¶æ“ä½œ

### 31.Python å¤„ç†æ–‡ä»¶

æœ‰ä¸€ä¸ª jsonline æ ¼å¼çš„æ–‡ä»¶ file.txt å¤§å°çº¦ä¸º 10Kï¼Œå¾ˆç®€å•ï¼Œç›´æ¥è¯»å–å¤„ç†å°±å¯ä»¥äº†ã€‚

```python
def get_lines():
    with open('file.txt','rb') as f:
        return f.readlines()

if __name__ == '__main__':
    for e in get_lines():
        process(e) # å¤„ç†æ¯ä¸€è¡Œæ•°æ®
```

ç°åœ¨è¦å¤„ç†ä¸€ä¸ªå¤§å°ä¸º10Gçš„æ–‡ä»¶ï¼Œä½†æ˜¯å†…å­˜åªæœ‰4Gï¼Œå¦‚æœåœ¨åªä¿®æ”¹ `get_lines` å‡½æ•°è€Œå…¶ä»–ä»£ç ä¿æŒä¸å˜çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥å¦‚ä½•å®ç°ï¼Ÿéœ€è¦è€ƒè™‘çš„é—®é¢˜éƒ½æœ‰é‚£äº›ï¼Ÿ

ç”Ÿæˆå™¨æ–¹å¼ï¼š

```python
def get_lines():
    with open('file.txt','rb') as f:
        for i in f:
            yield i
```

åˆ†å—è¯»å–æ–¹å¼ï¼š

```python
from mmap import mmap

def get_lines(fp):
    with open(fp,"r+") as f:
        m = mmap(f.fileno(), 0)
        tmp = 0
        for i, char in enumerate(m):
            if char==b"\n":
                yield m[tmp:i+1].decode()
                tmp = i+1

if __name__=="__main__":
    for i in get_lines("fp_some_huge_file"):
        print(i)
```

è¦è€ƒè™‘çš„é—®é¢˜æœ‰ï¼šå†…å­˜åªæœ‰4Gæ— æ³•ä¸€æ¬¡æ€§è¯»å…¥10Gæ–‡ä»¶ï¼Œéœ€è¦åˆ†æ‰¹è¯»å…¥ï¼Œåˆ†æ‰¹è¯»å…¥æ•°æ®è¦è®°å½•æ¯æ¬¡è¯»å…¥æ•°æ®çš„ä½ç½®ã€‚åˆ†æ‰¹æ¯æ¬¡è¯»å–æ•°æ®çš„å¤§å°ï¼Œå¤ªå°ä¼šåœ¨è¯»å–æ“ä½œèŠ±è´¹è¿‡å¤šæ—¶é—´ã€‚
https://stackoverflow.com/questions/30294146/python-fastest-way-to-process-large-file

### 32.éå†æ–‡ä»¶å¤¹

```python
import os

def print_directory_contents(sPath):
    """
    è¿™ä¸ªå‡½æ•°æ¥æ”¶æ–‡ä»¶å¤¹çš„åç§°ä½œä¸ºè¾“å…¥å‚æ•°
    è¿”å›è¯¥æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„è·¯å¾„
    ä»¥åŠå…¶åŒ…å«æ–‡ä»¶å¤¹ä¸­æ–‡ä»¶çš„è·¯å¾„
    """
    for s_child in os.listdir(s_path):
        s_child_path = os.path.join(s_path, s_child)
        if os.path.isdir(s_child_path):
            print_directory_contents(s_child_path)
        else:
            print(s_child_path)
```

## æ¨¡å—ä¸åŒ…

### 33.è¾“å…¥æ—¥æœŸï¼Œåˆ¤æ–­è¿™ä¸€å¤©æ˜¯è¿™ä¸€å¹´çš„ç¬¬å‡ å¤©ï¼Ÿ

```python
import datetime

def dayofyear():
    year = input("è¯·è¾“å…¥å¹´ä»½: ")
    month = input("è¯·è¾“å…¥æœˆä»½: ")
    day = input("è¯·è¾“å…¥å¤©: ")
    date1 = datetime.date(year=int(year),month=int(month),day=int(day))
    date2 = datetime.date(year=int(year),month=1,day=1)
    return (date1-date2).days+1
```

### 34.æ‰“ä¹±ä¸€ä¸ªæ’å¥½åºçš„listå¯¹è±¡

```python
import random

alist = [1,2,3,4,5]
random.shuffle(alist)
print(alist)
```

## æ•°æ®ç±»å‹

### 35.å°†å­—å…¸æŒ‰valueå€¼è¿›è¡Œæ’åº

```python
sorted(d.items(), key=lambda x:x[1])
```

### 36.è¯·åè½¬å­—ç¬¦ä¸² "aStr"

```python
print("aStr"[::-1])
```

### 37.å°†å­—ç¬¦ä¸² "k:1|k1:2|k2:3|k3:4" å¤„ç†æˆå­—å…¸ {k:1,k1:2,...}

```python
str1 = "k:1|k1:2|k2:3|k3:4"

def str2dict(str1):
    dict1 = {}
    for iterms in str1.split('|'):
        key, value = iterms.split(':')
        dict1[key] = value
    return dict1
```

æˆ–è€…ç›´æ¥ç”¨å­—å…¸æ¨å¯¼å¼ï¼š

```python
d = {k:int(v) for t in str1.split("|") for k, v in (t.split(":"), )}
```

### 38.åˆ—è¡¨åˆ‡ç‰‡

```python
list = ['a','b','c','d','e']
print(list[10:])
```

ä»£ç å°†è¾“å‡º `[]`ï¼Œä¸ä¼šäº§ç”ŸIndexErroré”™è¯¯ï¼Œå°±åƒæ‰€æœŸæœ›çš„é‚£æ ·ï¼Œå°è¯•ç”¨è¶…å‡ºæˆå‘˜çš„ä¸ªæ•°çš„indexæ¥è·å–æŸä¸ªåˆ—è¡¨çš„æˆå‘˜ã€‚ä¾‹å¦‚ï¼Œå°è¯•è·å–list[10]å’Œä¹‹åçš„æˆå‘˜ï¼Œä¼šå¯¼è‡´IndexErrorã€‚

ç„¶è€Œï¼Œå°è¯•è·å–åˆ—è¡¨çš„åˆ‡ç‰‡ï¼Œå¼€å§‹çš„indexè¶…è¿‡äº†æˆå‘˜ä¸ªæ•°ä¸ä¼šäº§ç”ŸIndexErrorï¼Œè€Œæ˜¯ä»…ä»…è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚è¿™æˆä¸ºç‰¹åˆ«è®©äººæ¶å¿ƒçš„ç–‘éš¾æ‚ç—‡ï¼Œå› ä¸ºè¿è¡Œçš„æ—¶å€™æ²¡æœ‰é”™è¯¯äº§ç”Ÿï¼Œå¯¼è‡´Bugå¾ˆéš¾è¢«è¿½è¸ªåˆ°ã€‚

### 39.å†™ä¸€ä¸ªåˆ—è¡¨ç”Ÿæˆå¼ï¼Œäº§ç”Ÿä¸€ä¸ªå…¬å·®ä¸º11çš„ç­‰å·®æ•°åˆ—

```python
print([x*11 for x in range(10)])
```

### 40.ç»™å®šä¸¤ä¸ªåˆ—è¡¨ï¼Œæ‰¾å‡ºä»–ä»¬ç›¸åŒçš„å…ƒç´ å’Œä¸åŒçš„å…ƒç´ 

```python
list1 = [1,2,3]
list2 = [3,4,5]

set1 = set(list1)
set2 = set(list2)

print(set1 & set2)
print(set1 ^ set2)
```

## ä¼ä¸šé¢è¯•é¢˜

### 41.pythonä¸­å†…ç½®çš„æ•°æ®ç»“æ„æœ‰å‡ ç§
a. æ•´å‹ intã€ é•¿æ•´å‹ longã€æµ®ç‚¹å‹ floatã€ å¤æ•° complex

b. å­—ç¬¦ä¸² strã€ åˆ—è¡¨ listã€ å…ƒç»„ tuple

c. å­—å…¸ dict ã€ é›†åˆ set

d. Python3 ä¸­æ²¡æœ‰ longï¼Œåªæœ‰æ— é™ç²¾åº¦çš„ int

### 42.åè½¬ä¸€ä¸ªæ•´æ•°ï¼Œä¾‹å¦‚-123 --> -321

```python
class Solution(object):
    def reverse(self,x):
        if -10<x<10:
            return x

        str_x = str(x)
        if str_x[0] !="-":
            str_x = str_x[::-1]
            x = int(str_x)
        else:
            str_x = str_x[1:][::-1]
            x = int(str_x)
            x = -x

        return x if -2147483648<x<2147483647 else 0

if __name__ == '__main__':
    s = Solution()
    reverse_int = s.reverse(-120)
    print(reverse_int)
```

### 43.å®ç°éå†ç›®å½•ä¸å­ç›®å½•ï¼ŒæŠ“å–.pycæ–‡ä»¶

ç¬¬ä¸€ç§æ–¹æ³•ï¼š

```python
import os

def get_files(dir,suffix):
    res = []
    for root,dirs,files in os.walk(dir):
        for filename in files:
            name,suf = os.path.splitext(filename)
            if suf == suffix:
                res.append(os.path.join(root,filename))
    print(res)

get_files("./",'.pyc')
```

ç¬¬äºŒç§æ–¹æ³•ï¼š

```python
import os

def pick(obj):
    if ob.endswith(".pyc"):
        print(obj)
    
def scan_path(ph):
    file_list = os.listdir(ph)
    for obj in file_list:
        if os.path.isfile(obj):
            pick(obj)
        elif os.path.isdir(obj):
            scan_path(obj)
    
if __name__=='__main__':
    path = input('è¾“å…¥ç›®å½•')
    scan_path(path)
```

ç¬¬ä¸‰ç§æ–¹æ³•ï¼š

```python
from glob import iglob

def func(fp, postfix):
    for i in iglob(f"{fp}/**/*{postfix}", recursive=True):
        print(i)

if __name__ == "__main__":
    postfix = ".pyc"
    func("K:\Python_script", postfix)
```

### 44.Pythonéå†åˆ—è¡¨æ—¶åˆ é™¤å…ƒç´ çš„æ­£ç¡®åšæ³•

a.éå†æ—¶åœ¨æ–°åˆ—è¡¨æ“ä½œï¼Œåˆ é™¤æ—¶åœ¨åŸæ¥çš„åˆ—è¡¨æ“ä½œï¼š

```python
a = [1,2,3,4,5,6,7,8]
print(id(a))
print(id(a[:]))
for i in a[:]:
    if i>5:
        pass
    else:
        a.remove(i)
    print(a)
print(id(a))
```

b.ä½¿ç”¨filterï¼š

```python
a=[1,2,3,4,5,6,7,8]
b = filter(lambda x: x>5,a)
print(list(b))
```

c.åˆ—è¡¨ç”Ÿæˆå¼ï¼š

```python
a=[1,2,3,4,5,6,7,8]
b = [i for i in a if i>5]
print(b)
```

d.å€’åºåˆ é™¤ï¼š

å› ä¸ºåˆ—è¡¨æ€»æ˜¯â€˜å‘å‰ç§»â€™ï¼Œæ‰€ä»¥å¯ä»¥å€’åºéå†ï¼Œå³ä½¿åé¢çš„å…ƒç´ è¢«ä¿®æ”¹äº†ï¼Œè¿˜æ²¡æœ‰è¢«éå†çš„å…ƒç´ å’Œå…¶åæ ‡è¿˜æ˜¯ä¿æŒä¸å˜çš„ã€‚

```python
a=[1,2,3,4,5,6,7,8]
print(id(a))
for i in range(len(a)-1,-1,-1):
    if a[i]>5:
        pass
    else:
        a.remove(a[i])
print(id(a))
print(a)
```

### 45.å­—ç¬¦ä¸² `"123"` è½¬æ¢æˆ `123`ï¼Œä¸ä½¿ç”¨å†…ç½®apiï¼Œä¾‹å¦‚ `int()`

æ–¹æ³•ä¸€ï¼š åˆ©ç”¨ `str` å‡½æ•°

```python
def atoi(s):
    num = 0
    for v in s:
        for j in range(10):
            if v == str(j):
                num = num * 10 + j
    return num
```

æ–¹æ³•äºŒï¼š åˆ©ç”¨ `ord` å‡½æ•°

```python
def atoi(s):
    num = 0
    for v in s:
        num = num * 10 + ord(v) - ord('0')
    return num
```

æ–¹æ³•ä¸‰: åˆ©ç”¨ `eval` å‡½æ•°

```python
def atoi(s):
    num = 0
    for v in s:
        t = "%s * 1" % v
        n = eval(t)
        num = num * 10 + n
    return num
```

æ–¹æ³•å››: ç»“åˆæ–¹æ³•äºŒï¼Œä½¿ç”¨ `reduce`ï¼Œä¸€è¡Œè§£å†³

```python
from functools import reduce

def atoi(s):
    return reduce(lambda num, v: num * 10 + ord(v) - ord('0'), s, 0)
```
  
### 46.ç»Ÿè®¡ä¸€ä¸ªæ–‡æœ¬ä¸­å•è¯é¢‘æ¬¡æœ€é«˜çš„10ä¸ªå•è¯

```python
# æ–¹æ³•ä¸€
import re

def test(filepath):
    distone = {}

    with open(filepath) as f:
        for line in f:
            line = re.sub("\W+", " ", line)
            lineone = line.split()
            for keyone in lineone:
                if not distone.get(keyone):
                    distone[keyone] = 1
                else:
                    distone[keyone] += 1

    num_ten = sorted(distone.items(), key=lambda x:x[1], reverse=True)[:10]
    num_ten =[x[0] for x in num_ten]
    return num_ten
 
# æ–¹æ³•äºŒ 
# ä½¿ç”¨ built-in çš„ Counter é‡Œé¢çš„ most_common
import re
from collections import Counter

def test2(filepath):
    with open(filepath) as f:
        return list(map(lambda c: c[0], Counter(re.sub("\W+", " ", f.read()).split()).most_common(10)))
```

### 47.é˜…è¯»ä¸€ä¸‹ä»£ç ä»–ä»¬çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

```python
def multi():
    return [lambda x : i*x for i in range(4)]
print([m(3) for m in multi()])
```

æ­£ç¡®ç­”æ¡ˆæ˜¯[9,9,9,9]ï¼Œè€Œä¸æ˜¯[0,3,6,9]äº§ç”Ÿçš„åŸå› æ˜¯Pythonçš„é—­åŒ…çš„åæœŸç»‘å®šå¯¼è‡´çš„ï¼Œè¿™æ„å‘³ç€åœ¨é—­åŒ…ä¸­çš„å˜é‡æ˜¯åœ¨å†…éƒ¨å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™è¢«æŸ¥æ‰¾çš„ï¼Œå› ä¸ºï¼Œæœ€åå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œforå¾ªç¯å·²ç»å®Œæˆ, i çš„å€¼æœ€åæ˜¯3,å› æ­¤æ¯ä¸€ä¸ªè¿”å›å€¼çš„iéƒ½æ˜¯3,æ‰€ä»¥æœ€åçš„ç»“æœæ˜¯[9,9,9,9]

ä½ å¦‚ä½•ä¿®æ”¹ä¸Šé¢çš„multipliersçš„å®šä¹‰äº§ç”Ÿæƒ³è¦çš„ç»“æœï¼Ÿ

ä¸Šè¿°é—®é¢˜äº§ç”Ÿçš„åŸå› æ˜¯pythoné—­åŒ…çš„å»¶è¿Ÿç»‘å®šã€‚è¿™æ„å‘³ç€å†…éƒ¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå‚æ•°çš„å€¼åœ¨é—­åŒ…å†…è¿›è¡ŒæŸ¥æ‰¾ã€‚å› æ­¤ï¼Œå½“ä»»ä½•ç”±multipliers()è¿”å›çš„å‡½æ•°è¢«è°ƒç”¨æ—¶,içš„å€¼å°†åœ¨é™„è¿‘çš„èŒƒå›´è¿›è¡ŒæŸ¥æ‰¾ã€‚é‚£æ—¶ï¼Œä¸ç®¡è¿”å›çš„å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨ï¼Œforå¾ªç¯å·²ç»å®Œæˆï¼Œiè¢«èµ‹äºˆäº†æœ€ç»ˆçš„å€¼3.

```python
def multipliers():
    for i in range(4):
        yield lambda x: i *x
```

```python
def multipliers():
    return [lambda x,i = i: i*x for i in range(4)]
```

# Pythoné«˜çº§

## å…ƒç±»

### 48.ä»‹ç»Cythonï¼ŒPypy Cpython Numbaå„æœ‰ä»€ä¹ˆç¼ºç‚¹
### 49.è¯·æè¿°æŠ½è±¡ç±»å’Œæ¥å£ç±»çš„åŒºåˆ«å’Œè”ç³»
### 50.Pythonä¸­å¦‚ä½•åŠ¨æ€è·å–å’Œè®¾ç½®å¯¹è±¡çš„å±æ€§

## å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶æœºåˆ¶

### 51.å“ªäº›æ“ä½œä¼šå¯¼è‡´Pythonå†…å­˜æº¢å‡ºï¼Œæ€ä¹ˆå¤„ç†

### 52.å†…å­˜æ³„éœ²æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ

**å†…å­˜æ³„æ¼**æŒ‡ç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚

æœ‰`__del__()`å‡½æ•°çš„å¯¹è±¡é—´çš„å¾ªç¯å¼•ç”¨æ˜¯å¯¼è‡´å†…å­˜æ³„éœ²çš„ä¸»å‡¶ã€‚ä¸ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ—¶ä½¿ç”¨: del object æ¥åˆ é™¤ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±å¯ä»¥æœ‰æ•ˆé˜²æ­¢å†…å­˜æ³„éœ²é—®é¢˜ã€‚

é€šè¿‡ Python æ‰©å±•æ¨¡å— gc æ¥æŸ¥çœ‹ä¸èƒ½å›æ”¶çš„å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚

å¯ä»¥é€šè¿‡ sys.getrefcount(obj) æ¥è·å–å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå¹¶æ ¹æ®è¿”å›å€¼æ˜¯å¦ä¸º0æ¥åˆ¤æ–­æ˜¯å¦å†…å­˜æ³„éœ²ã€‚

## å‡½æ•°

### 53.æ‰‹å†™ä¸€ä¸ªåˆ¤æ–­æ—¶é—´çš„è£…é¥°å™¨

```python
import datetime


class TimeException(Exception):
    def __init__(self, exception_info):
        super().__init__()
        self.info = exception_info

    def __str__(self):
        return self.info


def timecheck(func):
    def wrapper(*args, **kwargs):
        if datetime.datetime.now().year == 2019:
            func(*args, **kwargs)
        else:
            raise TimeException("å‡½æ•°å·²è¿‡æ—¶")

    return wrapper


@timecheck
def test(name):
    print("Hello {}, 2019 Happy".format(name))


if __name__ == "__main__":
    test("backbp")
```

### 54.å¸¦å‚æ•°çš„è£…é¥°å™¨

a.å¸¦å®šé•¿å‚æ•°çš„è£…é¥°å™¨ï¼š

```python
def new_func(func):
    def wrappedfun(username, passwd):
        if username == 'root' and passwd == '123456789':
            print('é€šè¿‡è®¤è¯')
            print('å¼€å§‹æ‰§è¡Œé™„åŠ åŠŸèƒ½')
            return func()
       	else:
            print('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
            return
    return wrappedfun

@new_func
def origin():
    print('å¼€å§‹æ‰§è¡Œå‡½æ•°')
origin('root','123456789')
```

b.å¸¦ä¸å®šé•¿å‚æ•°çš„è£…é¥°å™¨ï¼š

```python
def new_func(func):
    def wrappedfun(*parts):
        if parts:
            counts = len(parts)
            print('æœ¬ç³»ç»ŸåŒ…å« ', end='')
            for part in parts:
                print(part, ' ',end='')
            print('ç­‰', counts, 'éƒ¨åˆ†')
            return func()
        else:
            print('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
            return func()
   return wrappedfun
```

### 55.çº¿ç¨‹å®‰å…¨çš„è£…é¥°å™¨

### 56.äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼

```python
a, b = b, a
```

### 57.hasattr() getattr() setattr() å‡½æ•°ä½¿ç”¨è¯¦è§£

hasattr(object,name)å‡½æ•°:

åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡é‡Œé¢æ˜¯å¦æœ‰nameå±æ€§æˆ–è€…nameæ–¹æ³•ï¼Œè¿”å›boolå€¼ï¼Œæœ‰nameå±æ€§ï¼ˆæ–¹æ³•ï¼‰è¿”å›Trueï¼Œå¦åˆ™è¿”å›Falseã€‚

```python
class function_demo(object):
    name = 'demo'
    def run(self):
        return "hello function"
functiondemo = function_demo()
res = hasattr(functiondemo, "name") # åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰nameå±æ€§ï¼ŒTrue
res = hasattr(functiondemo, "run") # åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰runæ–¹æ³•ï¼ŒTrue
res = hasattr(functiondemo, "age") # åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰ageå±æ€§ï¼ŒFalse
print(res)
```

getattr(object, name[,default])å‡½æ•°ï¼š

è·å–å¯¹è±¡objectçš„å±æ€§æˆ–è€…æ–¹æ³•ï¼Œå¦‚æœå­˜åœ¨åˆ™æ‰“å°å‡ºæ¥ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæ‰“å°é»˜è®¤å€¼ï¼Œé»˜è®¤å€¼å¯é€‰ã€‚æ³¨æ„ï¼šå¦‚æœè¿”å›çš„æ˜¯å¯¹è±¡çš„æ–¹æ³•ï¼Œåˆ™æ‰“å°ç»“æœæ˜¯ï¼šæ–¹æ³•çš„å†…å­˜åœ°å€ï¼Œå¦‚æœéœ€è¦è¿è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åœ¨åé¢æ·»åŠ æ‹¬å·().

```python
functiondemo = function_demo()
getattr(functiondemo, "name")# è·å–nameå±æ€§ï¼Œå­˜åœ¨å°±æ‰“å°å‡ºæ¥ --- demo
getattr(functiondemo, "run") # è·å–run æ–¹æ³•ï¼Œå­˜åœ¨æ‰“å°å‡ºæ–¹æ³•çš„å†…å­˜åœ°å€
getattr(functiondemo, "age") # è·å–ä¸å­˜åœ¨çš„å±æ€§ï¼ŒæŠ¥é”™
getattr(functiondemo, "age", 18)# è·å–ä¸å­˜åœ¨çš„å±æ€§ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤å€¼
```

setattr(object, name, values)å‡½æ•°ï¼š

ç»™å¯¹è±¡çš„å±æ€§èµ‹å€¼ï¼Œè‹¥å±æ€§ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºå†èµ‹å€¼

```python
class function_demo(object):
    name = "demo"
    def run(self):
        return "hello function"
functiondemo = function_demo()
res = hasattr(functiondemo, "age") # åˆ¤æ–­ageå±æ€§æ˜¯å¦å­˜åœ¨ï¼ŒFalse
print(res)
setattr(functiondemo, "age", 18) # å¯¹ageå±æ€§è¿›è¡Œèµ‹å€¼ï¼Œæ— è¿”å›å€¼
res1 = hasattr(functiondemo, "age") # å†æ¬¡åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨ï¼ŒTrue
```

ç»¼åˆä½¿ç”¨

```python
class function_demo(object):
    name = "demo"
    def run(self):
        return "hello function"

functiondemo = function_demo()
res = hasattr(functiondemo, "addr") # å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨
if res:
    addr = getattr(functiondemo, "addr")
    print(addr)
else:
    addr = getattr(functiondemo, "addr", setattr(functiondemo, "addr", "åŒ—äº¬é¦–éƒ½"))
    print(addr)
```

##  è®¾è®¡æ¨¡å¼

### 58.å¯¹è£…é¥°å™¨çš„ç†è§£ï¼Œå¹¶å†™å‡ºä¸€ä¸ªè®¡æ—¶å™¨è®°å½•æ–¹æ³•æ‰§è¡Œæ€§èƒ½çš„è£…é¥°å™¨
è£…é¥°å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªcallable objectï¼Œå®ƒå¯ä»¥è®©å…¶ä»–å‡½æ•°åœ¨ä¸éœ€è¦åšä»»ä½•ä»£ç å˜åŠ¨çš„å‰æä¸‹å¢åŠ é¢å¤–åŠŸèƒ½ï¼Œè£…é¥°å™¨çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ã€‚

```python
import time
from functools import wraps

def timeit(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.clock()
        ret = func(*args, **kwargs)
        end = time.clock()
        print('used:',end-start)
        return ret
    
    return wrapper

@timeit
def foo():
    print('in foo()'foo())
```

### 59.Pythonä¸­yieldçš„ç”¨æ³•

yieldå°±æ˜¯ä¿å­˜å½“å‰ç¨‹åºæ‰§è¡ŒçŠ¶æ€ã€‚ä½ ç”¨forå¾ªç¯çš„æ—¶å€™ï¼Œæ¯æ¬¡å–ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™å°±ä¼šè®¡ç®—ä¸€æ¬¡ã€‚ç”¨yieldçš„å‡½æ•°å«generator,å’Œiteratorä¸€æ ·ï¼Œå®ƒçš„å¥½å¤„æ˜¯ä¸ç”¨ä¸€æ¬¡è®¡ç®—æ‰€æœ‰å…ƒç´ ï¼Œè€Œæ˜¯ç”¨ä¸€æ¬¡ç®—ä¸€æ¬¡ï¼Œå¯ä»¥èŠ‚çœå¾ˆå¤šç©ºé—´ï¼Œgeneratoræ¯æ¬¡è®¡ç®—éœ€è¦ä¸Šä¸€æ¬¡è®¡ç®—ç»“æœï¼Œæ‰€ä»¥ç”¨yield,å¦åˆ™ä¸€returnï¼Œä¸Šæ¬¡è®¡ç®—ç»“æœå°±æ²¡äº†

## é¢å‘å¯¹è±¡

### 60.Pythonçš„é­”æ³•æ–¹æ³•

é­”æ³•æ–¹æ³•å°±æ˜¯å¯ä»¥ç»™ä½ çš„ç±»å¢åŠ é­”åŠ›çš„ç‰¹æ®Šæ–¹æ³•ï¼Œå¦‚æœä½ çš„å¯¹è±¡å®ç°ï¼ˆé‡è½½ï¼‰äº†è¿™äº›æ–¹æ³•ä¸­çš„æŸä¸€ä¸ªï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±ä¼šåœ¨ç‰¹æ®Šçš„æƒ…å†µä¸‹è¢«Pythonæ‰€è°ƒç”¨ï¼Œä½ å¯ä»¥å®šä¹‰è‡ªå·±æƒ³è¦çš„è¡Œä¸ºï¼Œè€Œè¿™ä¸€åˆ‡éƒ½æ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ï¼Œå®ƒä»¬ç»å¸¸æ˜¯ä¸¤ä¸ªä¸‹åˆ’çº¿åŒ…å›´æ¥å‘½åçš„ï¼ˆæ¯”å¦‚`__init___`,`__len__`),Pythonçš„é­”æ³•æ–¹æ³•æ˜¯éå¸¸å¼ºå¤§çš„æ‰€ä»¥äº†è§£å…¶ä½¿ç”¨æ–¹æ³•ä¹Ÿå˜å¾—å°¤ä¸ºé‡è¦!

`__init__`æ„é€ å™¨ï¼Œå½“ä¸€ä¸ªå®ä¾‹è¢«åˆ›å»ºçš„æ—¶å€™åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯å®ä¾‹åŒ–è°ƒç”¨çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ã€‚

`__new__`æ‰æ˜¯å®ä¾‹åŒ–å¯¹è±¡è°ƒç”¨çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒåªå–ä¸‹clså‚æ•°ï¼Œå¹¶æŠŠå…¶ä»–å‚æ•°ä¼ ç»™`__init___`.

`___new__`å¾ˆå°‘ä½¿ç”¨ï¼Œä½†æ˜¯ä¹Ÿæœ‰å®ƒé€‚åˆçš„åœºæ™¯ï¼Œå°¤å…¶æ˜¯å½“ç±»ç»§æ‰¿è‡ªä¸€ä¸ªåƒå…ƒç¥–æˆ–è€…å­—ç¬¦ä¸²è¿™æ ·ä¸ç»å¸¸æ”¹å˜çš„ç±»å‹çš„æ—¶å€™ã€‚

`__call__`è®©ä¸€ä¸ªç±»çš„å®ä¾‹åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨

`__getitem__`å®šä¹‰è·å–å®¹å™¨ä¸­æŒ‡å®šå…ƒç´ çš„è¡Œä¸ºï¼Œç›¸å½“äºself[key]

`__getattr__`å®šä¹‰å½“ç”¨æˆ·è¯•å›¾è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨å±æ€§çš„æ—¶å€™çš„è¡Œä¸ºã€‚

`__setattr__`å®šä¹‰å½“ä¸€ä¸ªå±æ€§è¢«è®¾ç½®çš„æ—¶å€™çš„è¡Œä¸º

`__getattribute___`å®šä¹‰å½“ä¸€ä¸ªå±æ€§è¢«è®¿é—®çš„æ—¶å€™çš„è¡Œä¸º

### 61.é¢å‘å¯¹è±¡ä¸­æ€ä¹ˆå®ç°åªè¯»å±æ€§

å°†å¯¹è±¡ç§æœ‰åŒ–ï¼Œé€šè¿‡å…±æœ‰æ–¹æ³•æä¾›ä¸€ä¸ªè¯»å–æ•°æ®çš„æ¥å£

```python
class person:
    def __init__(self, x):
        self.__age = 10
    def age(self):
        return self.__age
t = person(22)
# t.__age =100
print(t.age())
```

æœ€å¥½çš„æ–¹æ³•

```python
class MyCls(object):
    __weight = 50
    
    @property
    def weight(self):
        return self.__weight
```

### 62.è°ˆè°ˆä½ å¯¹é¢å‘å¯¹è±¡çš„ç†è§£

é¢å‘å¯¹è±¡æ˜¯ç›¸å½“äºé¢å‘è¿‡ç¨‹è€Œè¨€çš„ï¼Œé¢å‘è¿‡ç¨‹è¯­è¨€æ˜¯ä¸€ç§åŸºäºåŠŸèƒ½åˆ†æçš„ï¼Œä»¥ç®—æ³•ä¸ºä¸­å¿ƒçš„ç¨‹åºè®¾è®¡æ–¹æ³•ï¼Œè€Œé¢å‘å¯¹è±¡æ˜¯ä¸€ç§åŸºäºç»“æ„åˆ†æçš„ï¼Œä»¥æ•°æ®ä¸ºä¸­å¿ƒçš„ç¨‹åºè®¾è®¡æ€æƒ³ã€‚åœ¨é¢å‘å¯¹è±¡è¯­è¨€ä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿ï¼Œå«åšç±»ã€‚é¢å‘å¯¹è±¡æœ‰ä¸‰å¤§ç‰¹æ€§ï¼šå°è£…ã€ç»§æ‰¿ã€å¤šæ€ã€‚

## æ­£åˆ™è¡¨è¾¾å¼

### 63.è¯·å†™å‡ºä¸€æ®µä»£ç ç”¨æ­£åˆ™åŒ¹é…å‡ºip

```python
def ip_match(ip_str):
    partterns = re.compile(r"(2(5[0-5]{1}|[0-4]\d{1})|[0-1]?\d{1,2})(\.(2(5[0-5]{1}|[0-4]\d{1})|[0-1]?\d{1,2})){3}")
    print(partterns.search(ip_str).group(0))
```

### 64.Pythonå­—ç¬¦ä¸²æŸ¥æ‰¾å’Œæ›¿æ¢ï¼Ÿ
### 65.æ­£åˆ™è¡¨è¾¾å¼è´ªå©ªä¸éè´ªå©ªæ¨¡å¼çš„åŒºåˆ«ï¼Ÿ
### 66.å†™å‡ºå¼€å¤´åŒ¹é…å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œæœ«å°¾æ˜¯æ•°å­—çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ
### 67.æ€ä¹ˆè¿‡æ»¤è¯„è®ºä¸­çš„è¡¨æƒ…ï¼Ÿ
### 68.Pythoné‡Œmatchä¸searchçš„åŒºåˆ«ï¼Ÿ

match æ–¹æ³•ç”¨äºæŸ¥æ‰¾å­—ç¬¦ä¸²çš„å¤´éƒ¨ï¼ˆä¹Ÿå¯ä»¥æŒ‡å®šèµ·å§‹ä½ç½®ï¼‰ï¼Œå®ƒæ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æœå°±è¿”å›ï¼Œè€Œä¸æ˜¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç»“æœã€‚å®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š

match(string[, pos[, endpos]])
å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚å› æ­¤ï¼Œ**å½“ä½ ä¸æŒ‡å®š pos å’Œ endpos æ—¶ï¼Œmatch æ–¹æ³•é»˜è®¤åŒ¹é…å­—ç¬¦ä¸²çš„å¤´éƒ¨**ã€‚

å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ª Match å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™è¿”å› Noneã€‚

```python
>>> import re
>>> pattern = re.compile(r'\d+')                    # ç”¨äºåŒ¹é…è‡³å°‘ä¸€ä¸ªæ•°å­—
>>> m = pattern.match('one12twothree34four')        # æŸ¥æ‰¾å¤´éƒ¨ï¼Œæ²¡æœ‰åŒ¹é…
>>> print m
None
>>> m = pattern.match('one12twothree34four', 2, 10) # ä»'e'çš„ä½ç½®å¼€å§‹åŒ¹é…ï¼Œæ²¡æœ‰åŒ¹é…
>>> print m
None
>>> m = pattern.match('one12twothree34four', 3, 10) # ä»'1'çš„ä½ç½®å¼€å§‹åŒ¹é…ï¼Œæ­£å¥½åŒ¹é…
>>> print m                                         # è¿”å›ä¸€ä¸ª Match å¯¹è±¡
<_sre.SRE_Match object at 0x10a42aac0>
>>> m.group(0)   # å¯çœç•¥ 0
'12'
>>> m.start(0)   # å¯çœç•¥ 0
3
>>> m.end(0)     # å¯çœç•¥ 0
5
>>> m.span(0)    # å¯çœç•¥ 0
(3, 5)
```

search æ–¹æ³•ç”¨äºæŸ¥æ‰¾å­—ç¬¦ä¸²çš„ä»»ä½•ä½ç½®ï¼Œå®ƒä¹Ÿæ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æœå°±è¿”å›ï¼Œè€Œä¸æ˜¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç»“æœï¼Œå®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š

search(string[, pos[, endpos]])
å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚

å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ª Match å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™è¿”å› Noneã€‚

```python
>>> import re
>>> pattern = re.compile('\d+')
>>> m = pattern.search('one12twothree34four')  # è¿™é‡Œå¦‚æœä½¿ç”¨ match æ–¹æ³•åˆ™ä¸åŒ¹é…
>>> m
<_sre.SRE_Match object at 0x10cc03ac0>
>>> m.group()
'12'
>>> m = pattern.search('one12twothree34four', 10, 30)  # æŒ‡å®šå­—ç¬¦ä¸²åŒºé—´
>>> m
<_sre.SRE_Match object at 0x10cc03b28>
>>> m.group()
'34'
>>> m.span()
(13, 15)
```

# Web
## Flask
### 140.å¯¹Flaskè“å›¾(Blueprint)çš„ç†è§£ï¼Ÿ

è“å›¾çš„å®šä¹‰ï¼š

è“å›¾ Blueprint æ˜¯Flaskåº”ç”¨ç¨‹åºç»„ä»¶åŒ–çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªåº”ç”¨å†…æˆ–è·¨è¶Šå¤šä¸ªé¡¹ç›®å…±ç”¨è“å›¾ã€‚ä½¿ç”¨è“å›¾å¯ä»¥æå¤§ç®€åŒ–å¤§å‹åº”ç”¨çš„å¼€å‘éš¾åº¦ï¼Œä¹Ÿä¸ºFlaskæ‰©å±•æä¾›äº†ä¸€ç§åœ¨åº”ç”¨ä¸­æ³¨å†ŒæœåŠ¡çš„é›†ä¸­å¼æœºåˆ¶ã€‚

è“å›¾çš„åº”ç”¨åœºæ™¯ï¼š

æŠŠä¸€ä¸ªåº”ç”¨åˆ†è§£ä¸ºä¸€ä¸ªè“å›¾çš„é›†åˆã€‚è¿™å¯¹å¤§å‹åº”ç”¨æ˜¯ç†æƒ³çš„ã€‚ä¸€ä¸ªé¡¹ç›®å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªåº”ç”¨å¯¹è±¡ï¼Œåˆå§‹åŒ–å‡ ä¸ªæ‰©å±•ï¼Œå¹¶æ³¨å†Œä¸€é›†åˆçš„è“å›¾ã€‚

ä»¥URLå‰ç¼€å’Œ/æˆ–å­åŸŸåï¼Œåœ¨åº”ç”¨ä¸Šæ³¨å†Œä¸€ä¸ªè“å›¾ã€‚URLå‰ç¼€/å­åŸŸåä¸­çš„å‚æ•°å³æˆä¸ºè¿™ä¸ªè“å›¾ä¸‹çš„æ‰€æœ‰è§†å›¾å‡½æ•°çš„å…±åŒçš„è§†å›¾å‚æ•°ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰
åœ¨ä¸€ä¸ªåº”ç”¨ä¸­ç”¨ä¸åŒçš„URLè§„åˆ™å¤šæ¬¡æ³¨å†Œä¸€ä¸ªè“å›¾ã€‚

é€šè¿‡è“å›¾æä¾›æ¨¡æ¿è¿‡æ»¤å™¨ã€é™æ€æ–‡ä»¶ã€æ¨¡æ¿å’Œå…¶ä»–åŠŸèƒ½ã€‚ä¸€ä¸ªè“å›¾ä¸ä¸€å®šè¦å®ç°åº”ç”¨æˆ–è§†å›¾å‡½æ•°ã€‚

åˆå§‹åŒ–ä¸€ä¸ªFlaskæ‰©å±•æ—¶ï¼Œåœ¨è¿™äº›æƒ…å†µä¸­æ³¨å†Œä¸€ä¸ªè“å›¾ã€‚

è“å›¾çš„ç¼ºç‚¹ï¼š

ä¸èƒ½åœ¨åº”ç”¨åˆ›å»ºåæ’¤é”€æ³¨å†Œä¸€ä¸ªè“å›¾è€Œä¸é”€æ¯æ•´ä¸ªåº”ç”¨å¯¹è±¡ã€‚

ä½¿ç”¨è“å›¾çš„ä¸‰ä¸ªæ­¥éª¤ï¼š

1.åˆ›å»ºä¸€ä¸ªè“å›¾å¯¹è±¡

```python
blue = Blueprint("blue",__name__)
```

2.åœ¨è¿™ä¸ªè“å›¾å¯¹è±¡ä¸Šè¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚æ³¨å†Œè·¯ç”±ã€æŒ‡å®šé™æ€æ–‡ä»¶å¤¹ã€æ³¨å†Œæ¨¡æ¿è¿‡æ»¤å™¨...

```python
@blue.route('/')
def blue_index():
    return "Welcome to my blueprint"
```

3.åœ¨åº”ç”¨å¯¹è±¡ä¸Šæ³¨å†Œè¿™ä¸ªè“å›¾å¯¹è±¡

```python
app.register_blueprint(blue,url_prefix="/blue")
```

### 141.Flask å’Œ Django è·¯ç”±æ˜ å°„çš„åŒºåˆ«ï¼Ÿ

åœ¨djangoä¸­ï¼Œè·¯ç”±æ˜¯æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨æ—¶ï¼Œå…ˆè®¿é—®çš„é¡¹ç›®ä¸­çš„urlï¼Œå†ç”±é¡¹ç›®ä¸­çš„urlæ‰¾åˆ°åº”ç”¨ä¸­urlï¼Œè¿™äº›urlæ˜¯æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œéµä»ä»å‰å¾€ååŒ¹é…çš„è§„åˆ™ã€‚åœ¨flaskä¸­ï¼Œè·¯ç”±æ˜¯é€šè¿‡è£…é¥°å™¨ç»™æ¯ä¸ªè§†å›¾å‡½æ•°æä¾›çš„ï¼Œè€Œä¸”æ ¹æ®è¯·æ±‚æ–¹å¼çš„ä¸åŒå¯ä»¥ä¸€ä¸ªurlç”¨äºä¸åŒçš„ä½œç”¨ã€‚

## Django
### 142.ä»€ä¹ˆæ˜¯wsgi,uwsgi,uWSGI?

WSGI:

webæœåŠ¡å™¨ç½‘å…³æ¥å£ï¼Œæ˜¯ä¸€å¥—åè®®ã€‚ç”¨äºæ¥æ”¶ç”¨æˆ·è¯·æ±‚å¹¶å°†è¯·æ±‚è¿›è¡Œåˆæ¬¡å°è£…ï¼Œç„¶åå°†è¯·æ±‚äº¤ç»™webæ¡†æ¶ã€‚

å®ç°wsgiåè®®çš„æ¨¡å—ï¼šwsgirefï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç¼–å†™ä¸€socketæœåŠ¡ç«¯ï¼Œç”¨äºæ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼ˆdjango)

werkzeug,æœ¬è´¨ä¸Šå°±æ˜¯ç¼–å†™ä¸€ä¸ªsocketæœåŠ¡ç«¯ï¼Œç”¨äºæ¥æ”¶ç”¨æˆ·è¯·æ±‚(flask)

uwsgiï¼šä¸WSGIä¸€æ ·æ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒæ˜¯uWSGIæœåŠ¡å™¨çš„ç‹¬å åè®®ï¼Œç”¨äºå®šä¹‰ä¼ è¾“ä¿¡æ¯çš„ç±»å‹ã€‚

uWSGIï¼šæ˜¯ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œå®ç°äº†WSGIçš„åè®®ï¼ŒuWSGIåè®®ï¼Œhttpåè®®ã€‚

### 143.Djangoã€Flaskã€Tornadoçš„å¯¹æ¯”ï¼Ÿ

1ã€Djangoèµ°çš„å¤§è€Œå…¨çš„æ–¹å‘ï¼Œå¼€å‘æ•ˆç‡é«˜ã€‚å®ƒçš„MTVæ¡†æ¶ï¼Œè‡ªå¸¦çš„ORMï¼Œadminåå°ç®¡ç†ï¼Œè‡ªå¸¦çš„sqliteæ•°æ®åº“å’Œå¼€å‘æµ‹è¯•ç”¨çš„æœåŠ¡å™¨ï¼Œç»™å¼€å‘è€…æé«˜äº†è¶…é«˜çš„å¼€å‘æ•ˆç‡ã€‚

é‡é‡çº§webæ¡†æ¶ï¼ŒåŠŸèƒ½é½å…¨ï¼Œæä¾›ä¸€ç«™å¼è§£å†³çš„æ€è·¯ï¼Œèƒ½è®©å¼€å‘è€…ä¸ç”¨åœ¨é€‰æ‹©ä¸ŠèŠ±è´¹å¤§é‡æ—¶é—´ã€‚

è‡ªå¸¦ORMå’Œæ¨¡æ¿å¼•æ“ï¼Œæ”¯æŒjinjaç­‰éå®˜æ–¹æ¨¡æ¿å¼•æ“ã€‚

è‡ªå¸¦ORMä½¿Djangoå’Œå…³ç³»å‹æ•°æ®åº“è€¦åˆåº¦é«˜ï¼Œå¦‚æœè¦ä½¿ç”¨éå…³ç³»å‹æ•°æ®åº“ï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ã€‚

è‡ªå¸¦æ•°æ®åº“ç®¡ç†app

æˆç†Ÿï¼Œç¨³å®šï¼Œå¼€å‘æ•ˆç‡é«˜ï¼Œç›¸å¯¹äºFlaskï¼ŒDjangoçš„æ•´ä½“å°é—­æ€§æ¯”è¾ƒå¥½ï¼Œé€‚åˆåšä¼ä¸šçº§ç½‘ç«™çš„å¼€å‘ã€‚python webæ¡†æ¶çš„å…ˆé©±ï¼Œç¬¬ä¸‰æ–¹åº“ä¸°å¯Œã€‚

2ã€Flask æ˜¯è½»é‡çº§çš„æ¡†æ¶ï¼Œè‡ªç”±ï¼Œçµæ´»ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œæ ¸å¿ƒåŸºäºWerkzeug WSGIå·¥å…· å’Œjinja2 æ¨¡æ¿å¼•æ“

é€‚ç”¨äºåšå°ç½‘ç«™ä»¥åŠwebæœåŠ¡çš„API,å¼€å‘å¤§å‹ç½‘ç«™æ— å‹åŠ›ï¼Œä½†æ¶æ„éœ€è¦è‡ªå·±è®¾è®¡

ä¸å…³ç³»å‹æ•°æ®åº“çš„ç»“åˆä¸å¼±äºDjangoï¼Œè€Œä¸éå…³ç³»å‹æ•°æ®åº“çš„ç»“åˆè¿œè¿œä¼˜äºDjango

3ã€Tornadoèµ°çš„æ˜¯å°‘è€Œç²¾çš„æ–¹å‘ï¼Œæ€§èƒ½ä¼˜è¶Šï¼Œå®ƒæœ€å‡ºåçš„å¼‚æ­¥éé˜»å¡çš„è®¾è®¡æ–¹å¼

Tornadoçš„ä¸¤å¤§æ ¸å¿ƒæ¨¡å—ï¼š

iostraemï¼šå¯¹éé˜»å¡çš„socketè¿›è¡Œç®€å•çš„å°è£…

ioloopï¼šå¯¹I/O å¤šè·¯å¤ç”¨çš„å°è£…,å®ƒå®ç°ä¸€ä¸ªå•ä¾‹

### 144.CORS å’Œ CSRFçš„åŒºåˆ«ï¼Ÿ

ä»€ä¹ˆæ˜¯CORSï¼Ÿ

CORSæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå…¨ç§°æ˜¯â€œè·¨åŸŸèµ„æºå…±äº«"(Cross-origin resoure sharing)ã€‚
å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡ºXMLHttpRequestè¯·æ±‚ï¼Œä»è€Œå®¢æœäº†AJAXåªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ã€‚

ä»€ä¹ˆæ˜¯CSRFï¼Ÿ

CSRFä¸»æµé˜²å¾¡æ–¹å¼æ˜¯åœ¨åç«¯ç”Ÿæˆè¡¨å•çš„æ—¶å€™ç”Ÿæˆä¸€ä¸²éšæœºtokenï¼Œå†…ç½®åˆ°è¡¨å•é‡Œæˆä¸ºä¸€ä¸ªå­—æ®µï¼ŒåŒæ—¶ï¼Œå°†æ­¤ä¸²tokenç½®å…¥sessionä¸­ã€‚æ¯æ¬¡è¡¨å•æäº¤åˆ°åç«¯æ—¶éƒ½ä¼šæ£€æŸ¥è¿™ä¸¤ä¸ªå€¼æ˜¯å¦ä¸€è‡´ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æ­¤æ¬¡è¡¨å•æäº¤æ˜¯å¦æ˜¯å¯ä¿¡çš„ï¼Œæäº¤è¿‡ä¸€æ¬¡ä¹‹åï¼Œå¦‚æœè¿™ä¸ªé¡µé¢æ²¡æœ‰ç”ŸæˆCSRF token,é‚£ä¹ˆtokenå°†ä¼šè¢«æ¸…ç©º,å¦‚æœæœ‰æ–°çš„éœ€æ±‚ï¼Œé‚£ä¹ˆtokenä¼šè¢«æ›´æ–°ã€‚

æ”»å‡»è€…å¯ä»¥ä¼ªé€ POSTè¡¨å•æäº¤ï¼Œä½†æ˜¯ä»–æ²¡æœ‰åç«¯ç”Ÿæˆçš„å†…ç½®äºè¡¨å•çš„tokenï¼Œsessionä¸­æ²¡æœ‰tokenéƒ½æ— æµäºäº‹ã€‚

### 145.Session,Cookie,JWTçš„ç†è§£

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¼šè¯ç®¡ç†

ä¼—æ‰€å‘¨çŸ¥ï¼ŒHTTPåè®®æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¯·æ±‚ï¼Œè¯·æ±‚ä¸è¯·æ±‚ä¹‹é—´å¹¶æ— å…³ç³»ã€‚ä½†åœ¨å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œè¿™ç§æ–¹å¼å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ä¸¾ä¸ªå¤§å®¶éƒ½å–œæ¬¢ç”¨çš„ä¾‹å­ï¼ŒæŠŠå•†å“åŠ å…¥è´­ç‰©è½¦ï¼Œå•ç‹¬è€ƒè™‘è¿™ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯å¹¶ä¸çŸ¥é“è¿™ä¸ªå•†å“æ˜¯è°çš„ï¼Œåº”è¯¥åŠ å…¥è°çš„è´­ç‰©è½¦ï¼Ÿå› æ­¤è¿™ä¸ªè¯·æ±‚çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå®é™…ä¸Šåº”è¯¥åŒ…å«ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œåœ¨æ¯æ¬¡ç”¨æˆ·å‘å‡ºè¯·æ±‚æ—¶æŠŠè¿™ä¸€å°éƒ¨åˆ†é¢å¤–ä¿¡æ¯ï¼Œä¹Ÿåšä¸ºè¯·æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·æœåŠ¡ç«¯å°±å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡ä¸­çš„ä¿¡æ¯ï¼Œé’ˆå¯¹å…·ä½“çš„ç”¨æˆ·è¿›è¡Œæ“ä½œã€‚æ‰€ä»¥è¿™å‡ ç§æŠ€æœ¯çš„å‡ºç°éƒ½æ˜¯å¯¹HTTPåè®®çš„ä¸€ä¸ªè¡¥å……ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨HTTPåè®®+çŠ¶æ€ç®¡ç†æ„å»ºä¸€ä¸ªçš„é¢å‘ç”¨æˆ·çš„WEBåº”ç”¨ã€‚

Session å’Œ Cookie çš„åŒºåˆ«ï¼š

è¿™é‡Œæˆ‘æƒ³å…ˆè°ˆè°ˆsessionä¸cookies,å› ä¸ºè¿™ä¸¤ä¸ªæŠ€æœ¯æ˜¯åšä¸ºå¼€å‘æœ€ä¸ºå¸¸è§çš„ã€‚é‚£ä¹ˆsessionä¸cookiesçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ªäººè®¤ä¸ºsessionä¸cookiesæœ€æ ¸å¿ƒåŒºåˆ«åœ¨äºé¢å¤–ä¿¡æ¯ç”±è°æ¥ç»´æŠ¤ã€‚åˆ©ç”¨cookiesæ¥å®ç°ä¼šè¯ç®¡ç†æ—¶ï¼Œç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯æˆ–è€…å…¶ä»–æˆ‘ä»¬æƒ³è¦ä¿æŒåœ¨æ¯ä¸ªè¯·æ±‚ä¸­çš„ä¿¡æ¯ï¼Œéƒ½æ˜¯æ”¾åœ¨cookiesä¸­,è€Œcookiesæ˜¯ç”±å®¢æˆ·ç«¯æ¥ä¿å­˜ï¼Œæ¯å½“å®¢æˆ·ç«¯å‘å‡ºæ–°è¯·æ±‚æ—¶ï¼Œå°±ä¼šç¨å¸¦ä¸Šcookies,æœåŠ¡ç«¯ä¼šæ ¹æ®å…¶ä¸­çš„ä¿¡æ¯è¿›è¡Œæ“ä½œã€‚

å½“åˆ©ç”¨sessionæ¥è¿›è¡Œä¼šè¯ç®¡ç†æ—¶ï¼Œå®¢æˆ·ç«¯å®é™…ä¸Šåªå­˜äº†ä¸€ä¸ªç”±æœåŠ¡ç«¯å‘é€çš„session_id,è€Œç”±è¿™ä¸ªsession_id,å¯ä»¥åœ¨æœåŠ¡ç«¯è¿˜åŸå‡ºæ‰€éœ€è¦çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºè¿™éƒ¨åˆ†ä¿¡æ¯æ˜¯ç”±æœåŠ¡ç«¯æ¥ç»´æŠ¤çš„ã€‚

é™¤æ­¤ä»¥å¤–ï¼Œsessionä¸cookieséƒ½æœ‰ä¸€äº›è‡ªå·±çš„ç¼ºç‚¹ï¼š
    
cookiesçš„å®‰å…¨æ€§ä¸å¥½ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è·å–æœ¬åœ°cookiesè¿›è¡Œæ¬ºéª—æˆ–è€…åˆ©ç”¨cookiesè¿›è¡ŒCSRFæ”»å‡»ã€‚ä½¿ç”¨cookiesæ—¶,åœ¨å¤šä¸ªåŸŸåä¸‹ï¼Œä¼šå­˜åœ¨è·¨åŸŸé—®é¢˜ã€‚

session åœ¨ä¸€å®šçš„æ—¶é—´é‡Œï¼Œéœ€è¦å­˜æ”¾åœ¨æœåŠ¡ç«¯ï¼Œå› æ­¤å½“æ‹¥æœ‰å¤§é‡ç”¨æˆ·æ—¶ï¼Œä¹Ÿä¼šå¤§å¹…åº¦é™ä½æœåŠ¡ç«¯çš„æ€§èƒ½ï¼Œå½“æœ‰å¤šå°æœºå™¨æ—¶ï¼Œå¦‚ä½•å…±äº«sessionä¹Ÿä¼šæ˜¯ä¸€ä¸ªé—®é¢˜.(redisé›†ç¾¤)ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·ç¬¬ä¸€ä¸ªè®¿é—®çš„æ—¶å€™æ˜¯æœåŠ¡å™¨Aï¼Œè€Œç¬¬äºŒä¸ªè¯·æ±‚è¢«è½¬å‘ç»™äº†æœåŠ¡å™¨Bï¼Œé‚£æœåŠ¡å™¨Bå¦‚ä½•å¾—çŸ¥å…¶çŠ¶æ€ã€‚å®é™…ä¸Šï¼Œsessionä¸cookiesæ˜¯æœ‰è”ç³»çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŠŠsession_idå­˜æ”¾åœ¨cookiesä¸­çš„ã€‚

JWTæ˜¯å¦‚ä½•å·¥ä½œçš„

é¦–å…ˆç”¨æˆ·å‘å‡ºç™»å½•è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ ¹æ®ç”¨æˆ·çš„ç™»å½•è¯·æ±‚è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œå°†ç›¸å…³çš„ä¿¡æ¯æ”¾å…¥payloadä¸­ï¼Œåˆ©ç”¨ç®—æ³•ï¼ŒåŠ ä¸ŠæœåŠ¡ç«¯çš„å¯†é’¥ç”Ÿæˆtokenï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯secret_keyå¾ˆé‡è¦ï¼Œå¦‚æœè¿™ä¸ªæ³„éœ²çš„è¯ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥éšæœºç¯¡æ”¹å‘é€çš„é¢å¤–ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¿¡æ¯å®Œæ•´æ€§çš„ä¿è¯ã€‚ç”ŸæˆtokenåæœåŠ¡ç«¯å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œå°†tokenä¸€èµ·äº¤ç»™æœåŠ¡ç«¯ï¼Œä¸€èˆ¬æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¾åœ¨Authorizationé¦–éƒ¨ä¸­ï¼Œè¿™æ ·ä¹Ÿå°±å¯ä»¥é¿å…è·¨åŸŸé—®é¢˜ã€‚

### 146.ç®€è¿°Djangoè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

ä¸€èˆ¬æ˜¯ç”¨æˆ·é€šè¿‡æµè§ˆå™¨å‘æˆ‘ä»¬çš„æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªè¯·æ±‚(request),è¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®è§†å›¾å‡½æ•°ï¼Œå¦‚æœä¸æ¶‰åŠåˆ°æ•°æ®è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™è§†å›¾å‡½æ•°è¿”å›ä¸€ä¸ªæ¨¡æ¿ä¹Ÿå°±æ˜¯ä¸€ä¸ªç½‘é¡µç»™ç”¨æˆ·ï¼‰

è§†å›¾å‡½æ•°è°ƒç”¨æ¨¡å‹å»æ•°æ®åº“æŸ¥æ‰¾æ•°æ®ï¼Œç„¶åé€çº§è¿”å›ï¼Œè§†å›¾å‡½æ•°æŠŠè¿”å›çš„æ•°æ®å¡«å……åˆ°æ¨¡æ¿ä¸­ç©ºæ ¼ä¸­ï¼Œæœ€åè¿”å›ç½‘é¡µç»™ç”¨æˆ·ã€‚

1.wsgi ,è¯·æ±‚å°è£…åäº¤ç»™webæ¡†æ¶ï¼ˆFlaskï¼ŒDjango)

2.ä¸­é—´ä»¶ï¼Œå¯¹è¯·æ±‚è¿›è¡Œæ ¡éªŒæˆ–åœ¨è¯·æ±‚å¯¹è±¡ä¸­æ·»åŠ å…¶ä»–ç›¸å…³æ•°æ®ï¼Œä¾‹å¦‚ï¼šcsrf,request.session

3.è·¯ç”±åŒ¹é… æ ¹æ®æµè§ˆå™¨å‘é€çš„ä¸åŒurlå»åŒ¹é…ä¸åŒçš„è§†å›¾å‡½æ•°

4.è§†å›¾å‡½æ•°ï¼Œåœ¨è§†å›¾å‡½æ•°ä¸­è¿›è¡Œä¸šåŠ¡é€»è¾‘çš„å¤„ç†ï¼Œå¯èƒ½æ¶‰åŠåˆ°ï¼šormï¼Œtemplates 

5.ä¸­é—´ä»¶ï¼Œå¯¹å“åº”çš„æ•°æ®è¿›è¡Œå¤„ç†

6.wsgiï¼Œå°†å“åº”çš„å†…å®¹å‘é€ç»™æµè§ˆå™¨

### 147.ç”¨çš„restframeworkå®Œæˆapiå‘é€æ—¶é—´æ—¶åŒº

å½“å‰çš„é—®é¢˜æ˜¯ç”¨djangoçš„rest frameworkæ¨¡å—åšä¸€ä¸ªgetè¯·æ±‚çš„å‘é€æ—¶é—´ä»¥åŠæ—¶åŒºä¿¡æ¯çš„api

```python
class getCurrenttime(APIView):
    def get(self,request):
        local_time = time.localtime()
        time_zone =settings.TIME_ZONE
        temp = {'localtime':local_time,'timezone':time_zone}
        return Response(temp)
```

### 148.nginx,tomcat,apache éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

Nginxï¼ˆengine x)æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ ä¸€ä¸ªIMAP/POP3/SMTPæœåŠ¡å™¨ï¼Œå·¥ä½œåœ¨OSIä¸ƒå±‚ï¼Œè´Ÿè½½çš„å®ç°æ–¹å¼ï¼šè½®è¯¢ï¼ŒIP_HASH,fair,session_stickyã€‚

Apache HTTP Serveræ˜¯ä¸€ä¸ªæ¨¡å—åŒ–çš„æœåŠ¡å™¨ï¼ŒæºäºNCSAhttpdæœåŠ¡å™¨ã€‚

Tomcat æœåŠ¡å™¨æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æ”¾æºä»£ç çš„Webåº”ç”¨æœåŠ¡å™¨ï¼Œå±äºè½»é‡çº§åº”ç”¨æœåŠ¡å™¨ï¼Œæ˜¯å¼€å‘å’Œè°ƒè¯•JSPç¨‹åºçš„é¦–é€‰ã€‚

### 149.è¯·ç»™å‡ºä½ ç†Ÿæ‚‰å…³ç³»æ•°æ®åº“èŒƒå¼æœ‰å“ªäº›ï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

åœ¨è¿›è¡Œæ•°æ®åº“çš„è®¾è®¡æ—¶ï¼Œæ‰€éµå¾ªçš„ä¸€äº›è§„èŒƒï¼Œåªè¦æŒ‰ç…§è®¾è®¡è§„èŒƒè¿›è¡Œè®¾è®¡ï¼Œå°±èƒ½è®¾è®¡å‡ºæ²¡æœ‰æ•°æ®å†—ä½™å’Œæ•°æ®ç»´æŠ¤å¼‚å¸¸çš„æ•°æ®åº“ç»“æ„ã€‚

æ•°æ®åº“çš„è®¾è®¡çš„è§„èŒƒæœ‰å¾ˆå¤šï¼Œé€šå¸¸æ¥è¯´æˆ‘ä»¬åœ¨è®¾è®¡æ•°æ®åº“æ—¶åªè¦è¾¾åˆ°å…¶ä¸­ä¸€äº›è§„èŒƒå°±å¯ä»¥äº†ï¼Œè¿™äº›è§„èŒƒåˆç§°ä¹‹ä¸ºæ•°æ®åº“çš„ä¸‰èŒƒå¼ï¼Œä¸€å…±æœ‰ä¸‰æ¡ï¼Œä¹Ÿå­˜åœ¨ç€å…¶ä»–èŒƒå¼ï¼Œæˆ‘ä»¬åªè¦åšåˆ°æ»¡è¶³å‰ä¸‰ä¸ªèŒƒå¼çš„è¦æ±‚ï¼Œå°±èƒ½è®¾è®¡å‡ºç¬¦åˆæˆ‘ä»¬çš„æ•°æ®åº“äº†ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½å…¨éƒ¨æ¥æŒ‰ç…§èŒƒå¼çš„è¦æ±‚æ¥åšï¼Œè¿˜è¦è€ƒè™‘å®é™…çš„ä¸šåŠ¡ä½¿ç”¨æƒ…å†µï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿéœ€è¦åšä¸€äº›è¿åèŒƒå¼çš„è¦æ±‚ã€‚

1.æ•°æ®åº“è®¾è®¡çš„ç¬¬ä¸€èŒƒå¼(æœ€åŸºæœ¬)ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰æ•°æ®åº“çš„èŒƒå¼éƒ½æ˜¯ç¬¦åˆç¬¬ä¸€èŒƒå¼çš„ï¼Œç¬¦åˆç¬¬ä¸€èŒƒå¼çš„è¡¨å…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š

æ•°æ®åº“è¡¨ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½åªå…·æœ‰å•ä¸€å±æ€§ï¼Œå•ä¸€å±æ€§çš„åˆ—æ˜¯ç”±åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼ˆæ•´å‹ï¼Œæµ®ç‚¹å‹ï¼Œå­—ç¬¦å‹ç­‰ï¼‰æ‰€æ„æˆçš„è®¾è®¡å‡ºæ¥çš„è¡¨éƒ½æ˜¯ç®€å•çš„äºŒæ¯”è¡¨

2.æ•°æ®åº“è®¾è®¡çš„ç¬¬äºŒèŒƒå¼(æ˜¯åœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šè®¾è®¡çš„)ï¼Œè¦æ±‚ä¸€ä¸ªè¡¨ä¸­åªå…·æœ‰ä¸€ä¸ªä¸šåŠ¡ä¸»é”®ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¦åˆç¬¬äºŒèŒƒå¼çš„è¡¨ä¸­ä¸èƒ½å­˜åœ¨éä¸»é”®åˆ—å¯¹åªå¯¹éƒ¨åˆ†ä¸»é”®çš„ä¾èµ–å…³ç³»

3.æ•°æ®åº“è®¾è®¡çš„ç¬¬ä¸‰èŒƒå¼ï¼ŒæŒ‡æ¯ä¸€ä¸ªéä¸»å±æ€§æ—¢ä¸éƒ¨åˆ†ä¾èµ–ä¸ä¹Ÿä¸ä¼ é€’ä¾èµ–äºä¸šåŠ¡ä¸»é”®ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šæ¶ˆé™¤äº†éä¸»å±æ€§å¯¹ä¸»é”®çš„ä¼ é€’ä¾èµ–

### 150.ç®€è¿°QQç™»é™†è¿‡ç¨‹

qqç™»å½•ï¼Œåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­åˆ†ä¸ºäº†ä¸‰ä¸ªæ¥å£ï¼Œ

ç¬¬ä¸€ä¸ªæ¥å£æ˜¯è¯·æ±‚qqæœåŠ¡å™¨è¿”å›ä¸€ä¸ªqqç™»å½•çš„ç•Œé¢;

ç¬¬äºŒä¸ªæ¥å£æ˜¯é€šè¿‡æ‰«ç æˆ–è´¦å·ç™»é™†è¿›è¡ŒéªŒè¯ï¼ŒqqæœåŠ¡å™¨è¿”å›ç»™æµè§ˆå™¨ä¸€ä¸ªcodeå’Œstate,åˆ©ç”¨è¿™ä¸ªcodeé€šè¿‡æœ¬åœ°æœåŠ¡å™¨å»å‘qqæœåŠ¡å™¨è·å–access_tokenè¦†è¿”å›ç»™æœ¬åœ°æœåŠ¡å™¨ï¼Œå‡­å€Ÿaccess_tokenå†å‘qqæœåŠ¡å™¨è·å–ç”¨æˆ·çš„openid(openidç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†)

ç¬¬ä¸‰ä¸ªæ¥å£æ˜¯åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡qqç™»å½•ï¼Œå¦‚æœä¸æ˜¯çš„è¯ç›´æ¥ç™»å½•è¿”å›çš„jwt-tokenç»™ç”¨æˆ·ï¼Œå¯¹æ²¡æœ‰ç»‘å®šè¿‡æœ¬ç½‘ç«™çš„ç”¨æˆ·ï¼Œå¯¹openidè¿›è¡ŒåŠ å¯†ç”Ÿæˆtokenè¿›è¡Œç»‘å®š

### 151.post å’Œ getçš„åŒºåˆ«?

1.GETæ˜¯ä»æœåŠ¡å™¨ä¸Šè·å–æ•°æ®ï¼ŒPOSTæ˜¯å‘æœåŠ¡å™¨ä¼ é€æ•°æ®

2.åœ¨å®¢æˆ·ç«¯ï¼ŒGETæ–¹å¼åœ¨é€šè¿‡URLæäº¤æ•°æ®ï¼Œæ•°æ®åœ¨URLä¸­å¯ä»¥çœ‹åˆ°ï¼ŒPOSTæ–¹å¼ï¼Œæ•°æ®æ”¾ç½®åœ¨HTMLâ€”â€”HEADERå†…æäº¤

3.å¯¹äºGETæ–¹å¼ï¼ŒæœåŠ¡å™¨ç«¯ç”¨Request.QueryStringè·å–å˜é‡çš„å€¼ï¼Œå¯¹äºPOSTæ–¹å¼ï¼ŒæœåŠ¡å™¨ç«¯ç”¨Request.Formè·å–æäº¤çš„æ•°æ®

### 152.é¡¹ç›®ä¸­æ—¥å¿—çš„ä½œç”¨

ä¸€ã€æ—¥å¿—ç›¸å…³æ¦‚å¿µ

1.æ—¥å¿—æ˜¯ä¸€ç§å¯ä»¥è¿½è¸ªæŸäº›è½¯ä»¶è¿è¡Œæ—¶æ‰€å‘ç”Ÿäº‹ä»¶çš„æ–¹æ³•

2.è½¯ä»¶å¼€å‘äººå‘˜å¯ä»¥å‘ä»–ä»¬çš„ä»£ç ä¸­è°ƒç”¨æ—¥å¿—è®°å½•ç›¸å…³çš„æ–¹æ³•æ¥è¡¨æ˜å‘ç”Ÿäº†æŸäº›äº‹æƒ…

3.ä¸€ä¸ªäº‹ä»¶å¯ä»¥ç”¨ä¸€ä¸ªåŒ…å«å¯é€‰å˜é‡æ•°æ®çš„æ¶ˆæ¯æ¥æè¿°

4.æ­¤å¤–ï¼Œäº‹ä»¶ä¹Ÿæœ‰é‡è¦æ€§çš„æ¦‚å¿µï¼Œè¿™ä¸ªé‡è¦æ€§ä¹Ÿå¯ä»¥è¢«æˆä¸ºä¸¥é‡æ€§çº§åˆ«(level)

äºŒã€æ—¥å¿—çš„ä½œç”¨

1.é€šè¿‡logçš„åˆ†æï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·äº†è§£ç³»ç»Ÿæˆ–è½¯ä»¶ã€åº”ç”¨çš„è¿è¡Œæƒ…å†µ;

2.å¦‚æœä½ çš„åº”ç”¨logè¶³å¤Ÿä¸°å¯Œï¼Œå¯ä»¥åˆ†æä»¥å¾€ç”¨æˆ·çš„æ“ä½œè¡Œä¸ºã€ç±»å‹å–œå¥½ï¼Œåœ°åŸŸåˆ†å¸ƒæˆ–å…¶ä»–æ›´å¤šä¿¡æ¯;

3.å¦‚æœä¸€ä¸ªåº”ç”¨çš„logåŒæ—¶ä¹Ÿåˆ†äº†å¤šä¸ªçº§åˆ«ï¼Œé‚£ä¹ˆå¯ä»¥å¾ˆè½»æ˜“åœ°åˆ†æå¾—åˆ°è¯¥åº”ç”¨çš„å¥åº·çŠ¶å†µï¼ŒåŠæ—¶å‘ç°é—®é¢˜å¹¶å¿«é€Ÿå®šä½ã€è§£å†³é—®é¢˜ï¼Œè¡¥æ•‘æŸå¤±ã€‚

4.ç®€å•æ¥è®²å°±æ˜¯æˆ‘ä»¬é€šè¿‡è®°å½•å’Œåˆ†ææ—¥å¿—å¯ä»¥äº†è§£ä¸€ä¸ªç³»ç»Ÿæˆ–è½¯ä»¶ç¨‹åºè¿è¡Œæƒ…å†µæ˜¯å¦æ­£å¸¸ï¼Œä¹Ÿå¯ä»¥åœ¨åº”ç”¨ç¨‹åºå‡ºç°æ•…éšœæ—¶å¿«é€Ÿå®šä½é—®é¢˜ã€‚ä¸ä»…åœ¨å¼€å‘ä¸­ï¼Œåœ¨è¿ç»´ä¸­æ—¥å¿—ä¹Ÿå¾ˆé‡è¦ï¼Œæ—¥å¿—çš„ä½œç”¨ä¹Ÿå¯ä»¥ç®€å•ã€‚æ€»ç»“ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š

1.ç¨‹åºè°ƒè¯•

2.äº†è§£è½¯ä»¶ç¨‹åºè¿è¡Œæƒ…å†µï¼Œæ˜¯å¦æ­£å¸¸

3,è½¯ä»¶ç¨‹åºè¿è¡Œæ•…éšœåˆ†æä¸é—®é¢˜å®šä½

4,å¦‚æœåº”ç”¨çš„æ—¥å¿—ä¿¡æ¯è¶³å¤Ÿè¯¦ç»†å’Œä¸°å¯Œï¼Œè¿˜å¯ä»¥ç”¨æ¥åšç”¨æˆ·è¡Œä¸ºåˆ†æ

### 153.djangoä¸­é—´ä»¶çš„ä½¿ç”¨ï¼Ÿ

Djangoåœ¨ä¸­é—´ä»¶ä¸­é¢„ç½®äº†å…­ä¸ªæ–¹æ³•ï¼Œè¿™å…­ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äºä¸åŒçš„é˜¶æ®µæ‰§è¡Œï¼Œå¯¹è¾“å…¥æˆ–è¾“å‡ºè¿›è¡Œå¹²é¢„ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

1.åˆå§‹åŒ–ï¼šæ— éœ€ä»»ä½•å‚æ•°ï¼ŒæœåŠ¡å™¨å“åº”ç¬¬ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™è°ƒç”¨ä¸€æ¬¡ï¼Œç”¨äºç¡®å®šæ˜¯å¦å¯ç”¨å½“å‰ä¸­é—´ä»¶

```python
def __init__():
    pass
```

2.å¤„ç†è¯·æ±‚å‰ï¼šåœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨ï¼Œè¿”å›Noneæˆ–HttpResponseå¯¹è±¡ã€‚

```python
def process_request(request):
    pass
```

3.å¤„ç†è§†å›¾å‰:åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨ï¼Œè¿”å›Noneæˆ–HttpResponseå¯¹è±¡ã€‚

```python
def process_view(request,view_func,view_args,view_kwargs):
    pass
```

4.å¤„ç†æ¨¡æ¿å“åº”å‰ï¼šåœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨ï¼Œè¿”å›å®ç°äº†renderæ–¹æ³•çš„å“åº”å¯¹è±¡ã€‚

```python
def process_template_response(request,response):
    pass
```

5.å¤„ç†å“åº”åï¼šæ‰€æœ‰å“åº”è¿”å›æµè§ˆå™¨ä¹‹å‰è¢«è°ƒç”¨ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨ï¼Œè¿”å›HttpResponseå¯¹è±¡ã€‚

```python
def process_response(request,response):
    pass
```

6.å¼‚å¸¸å¤„ç†ï¼šå½“è§†å›¾æŠ›å‡ºå¼‚å¸¸æ—¶è°ƒç”¨ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚ä¸Šè°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªHttpResponseå¯¹è±¡ã€‚

```python
def process_exception(request,exception):
    pass
```

### 154.è°ˆä¸€ä¸‹ä½ å¯¹uWSGIå’Œnginxçš„ç†è§£ï¼Ÿ

1.uWSGIæ˜¯ä¸€ä¸ªWebæœåŠ¡å™¨ï¼Œå®ƒå®ç°äº†WSGIåè®®ã€uwsgiã€httpç­‰åè®®ã€‚Nginxä¸­HttpUwsgiModuleçš„ä½œç”¨æ˜¯ä¸uWSGIæœåŠ¡å™¨è¿›è¡Œäº¤æ¢ã€‚WSGIæ˜¯ä¸€ç§WebæœåŠ¡å™¨ç½‘å…³æ¥å£ã€‚å®ƒæ˜¯ä¸€ä¸ªWebæœåŠ¡å™¨ï¼ˆå¦‚nginxï¼ŒuWSGIç­‰æœåŠ¡å™¨ï¼‰ä¸webåº”ç”¨ï¼ˆå¦‚ç”¨Flaskæ¡†æ¶å†™çš„ç¨‹åºï¼‰é€šä¿¡çš„ä¸€ç§è§„èŒƒã€‚

è¦æ³¨æ„WSGI/uwsgi/uWSGIè¿™ä¸‰ä¸ªæ¦‚å¿µçš„åŒºåˆ†ã€‚

WSGIæ˜¯ä¸€ç§é€šä¿¡åè®®ã€‚

uwsgiæ˜¯ä¸€ç§çº¿è·¯åè®®è€Œä¸æ˜¯é€šä¿¡åè®®ï¼Œåœ¨æ­¤å¸¸ç”¨äºåœ¨uWSGIæœåŠ¡å™¨ä¸å…¶ä»–ç½‘ç»œæœåŠ¡å™¨çš„æ•°æ®é€šä¿¡ã€‚

uWSGIæ˜¯å®ç°äº†uwsgiå’ŒWSGIä¸¤ç§åè®®çš„WebæœåŠ¡å™¨ã€‚

nginx æ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½çš„HTTPæœåŠ¡å™¨å’Œåå‘ä»£ç†ï¼š

1.ä½œä¸ºwebæœåŠ¡å™¨ï¼Œå®ƒå¤„ç†é™æ€æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶æ•ˆæœéå¸¸é«˜

2.å®ƒçš„è®¾è®¡éå¸¸æ³¨é‡æ•ˆç‡ï¼Œæœ€å¤§æ”¯æŒ5ä¸‡ä¸ªå¹¶å‘è¿æ¥ï¼Œä½†åªå ç”¨å¾ˆå°‘çš„å†…å­˜ç©ºé—´

3.ç¨³å®šæ€§é«˜ï¼Œé…ç½®ç®€æ´ã€‚

4.å¼ºå¤§çš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå¹³è¡¡é›†ç¾¤ä¸­å„ä¸ªæœåŠ¡å™¨çš„è´Ÿè½½å‹åŠ›åº”ç”¨

### 155.Djangoä¸­å“ªé‡Œç”¨åˆ°äº†çº¿ç¨‹ï¼Ÿå“ªé‡Œç”¨åˆ°äº†åç¨‹ï¼Ÿå“ªé‡Œç”¨åˆ°äº†è¿›ç¨‹ï¼Ÿ

1.Djangoä¸­è€—æ—¶çš„ä»»åŠ¡ç”¨ä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹æ¥æ‰§è¡Œï¼Œæ¯”å¦‚å‘é‚®ä»¶ï¼Œä½¿ç”¨celery.

2.éƒ¨ç½²djangoé¡¹ç›®æ˜¯æ—¶å€™ï¼Œé…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†è¿›ç¨‹å’Œåç¨‹çš„ç›¸å…³é…ç½®ã€‚

### 156.æœ‰ç”¨è¿‡Django REST frameworkå—ï¼Ÿ

Django REST frameworkæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„Web APIå·¥å…·ã€‚ä½¿ç”¨RESTframeworkçš„ç†ç”±æœ‰ï¼š

Web browsable APIå¯¹å¼€å‘è€…æœ‰æå¤§çš„å¥½å¤„

åŒ…æ‹¬OAuth1aå’ŒOAuth2çš„è®¤è¯ç­–ç•¥

æ”¯æŒORMå’ŒéORMæ•°æ®èµ„æºçš„åºåˆ—åŒ–

å…¨ç¨‹è‡ªå®šä¹‰å¼€å‘--å¦‚æœä¸æƒ³ä½¿ç”¨æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»…ä»…ä½¿ç”¨å¸¸è§„çš„function-based viewsé¢å¤–çš„æ–‡æ¡£å’Œå¼ºå¤§çš„ç¤¾åŒºæ”¯æŒ


## çˆ¬è™«
### 159.è¯•åˆ—å‡ºè‡³å°‘ä¸‰ç§ç›®å‰æµè¡Œçš„å¤§å‹æ•°æ®åº“
### 160.åˆ—ä¸¾æ‚¨ä½¿ç”¨è¿‡çš„Pythonç½‘ç»œçˆ¬è™«æ‰€ç”¨åˆ°çš„ç½‘ç»œæ•°æ®åŒ…?
### 161.çˆ¬å–æ•°æ®åä½¿ç”¨å“ªä¸ªæ•°æ®åº“å­˜å‚¨æ•°æ®çš„ï¼Œä¸ºä»€ä¹ˆï¼Ÿ
### 162.ä½ ç”¨è¿‡çš„çˆ¬è™«æ¡†æ¶æˆ–è€…æ¨¡å—æœ‰å“ªäº›ï¼Ÿä¼˜ç¼ºç‚¹ï¼Ÿ
### 163.å†™çˆ¬è™«æ˜¯ç”¨å¤šè¿›ç¨‹å¥½ï¼Ÿè¿˜æ˜¯å¤šçº¿ç¨‹å¥½ï¼Ÿ
### 164.å¸¸è§çš„åçˆ¬è™«å’Œåº”å¯¹æ–¹æ³•ï¼Ÿ
### 165.è§£æç½‘é¡µçš„è§£æå™¨ä½¿ç”¨æœ€å¤šçš„æ˜¯å“ªå‡ ä¸ª?
### 166.éœ€è¦ç™»å½•çš„ç½‘é¡µï¼Œå¦‚ä½•è§£å†³åŒæ—¶é™åˆ¶ipï¼Œcookie,session
### 167.éªŒè¯ç çš„è§£å†³?
### 168.ä½¿ç”¨æœ€å¤šçš„æ•°æ®åº“ï¼Œå¯¹ä»–ä»¬çš„ç†è§£ï¼Ÿ
### 169.ç¼–å†™è¿‡å“ªäº›çˆ¬è™«ä¸­é—´ä»¶ï¼Ÿ
### 170.â€œæéªŒâ€æ»‘åŠ¨éªŒè¯ç å¦‚ä½•ç ´è§£ï¼Ÿ
### 171.çˆ¬è™«å¤šä¹…çˆ¬ä¸€æ¬¡ï¼Œçˆ¬ä¸‹æ¥çš„æ•°æ®æ˜¯æ€ä¹ˆå­˜å‚¨ï¼Ÿ
### 172.cookieè¿‡æœŸçš„å¤„ç†é—®é¢˜ï¼Ÿ
### 173.åŠ¨æ€åŠ è½½åˆå¯¹åŠæ—¶æ€§è¦æ±‚å¾ˆé«˜æ€ä¹ˆå¤„ç†ï¼Ÿ
### 174.HTTPSæœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ
### 175.HTTPSæ˜¯å¦‚ä½•å®ç°å®‰å…¨ä¼ è¾“æ•°æ®çš„ï¼Ÿ
### 176.TTLï¼ŒMSLï¼ŒRTTå„æ˜¯ä»€ä¹ˆï¼Ÿ
### 177.è°ˆä¸€è°ˆä½ å¯¹Seleniumå’ŒPhantomJSäº†è§£
### 178.å¹³å¸¸æ€ä¹ˆä½¿ç”¨ä»£ç†çš„ ï¼Ÿ
### 179.å­˜æ”¾åœ¨æ•°æ®åº“(redisã€mysqlç­‰)ã€‚
### 180.æ€ä¹ˆç›‘æ§çˆ¬è™«çš„çŠ¶æ€?
### 181.æè¿°ä¸‹scrapyæ¡†æ¶è¿è¡Œçš„æœºåˆ¶ï¼Ÿ
### 182.è°ˆè°ˆä½ å¯¹Scrapyçš„ç†è§£ï¼Ÿ
### 183.æ€ä¹ˆæ ·è®© scrapy æ¡†æ¶å‘é€ä¸€ä¸ª post è¯·æ±‚ï¼ˆå…·ä½“å†™å‡ºæ¥ï¼‰
### 184.æ€ä¹ˆç›‘æ§çˆ¬è™«çš„çŠ¶æ€ ï¼Ÿ
### 185.æ€ä¹ˆåˆ¤æ–­ç½‘ç«™æ˜¯å¦æ›´æ–°ï¼Ÿ
### 186.å›¾ç‰‡ã€è§†é¢‘çˆ¬å–æ€ä¹ˆç»•è¿‡é˜²ç›—è¿æ¥
### 187.ä½ çˆ¬å‡ºæ¥çš„æ•°æ®é‡å¤§æ¦‚æœ‰å¤šå¤§ï¼Ÿå¤§æ¦‚å¤šé•¿æ—¶é—´çˆ¬ä¸€æ¬¡ï¼Ÿ
### 188.ç”¨ä»€ä¹ˆæ•°æ®åº“å­˜çˆ¬ä¸‹æ¥çš„æ•°æ®ï¼Ÿéƒ¨ç½²æ˜¯ä½ åšçš„å—ï¼Ÿæ€ä¹ˆéƒ¨ç½²ï¼Ÿ
### 189.å¢é‡çˆ¬å–
### 190.çˆ¬å–ä¸‹æ¥çš„æ•°æ®å¦‚ä½•å»é‡ï¼Œè¯´ä¸€ä¸‹scrapyçš„å…·ä½“çš„ç®—æ³•ä¾æ®ã€‚
### 191.Scrapyçš„ä¼˜ç¼ºç‚¹?
### 192.æ€ä¹ˆè®¾ç½®çˆ¬å–æ·±åº¦ï¼Ÿ
### 193.scrapyå’Œscrapy-redisæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆé€‰æ‹©redisæ•°æ®åº“ï¼Ÿ
### 194.åˆ†å¸ƒå¼çˆ¬è™«ä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
### 195.ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼å­˜å‚¨ï¼Ÿ
### 196.ä½ æ‰€çŸ¥é“çš„åˆ†å¸ƒå¼çˆ¬è™«æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ
### 197.scrapy-redisï¼Œæœ‰åšè¿‡å…¶ä»–çš„åˆ†å¸ƒå¼çˆ¬è™«å—ï¼Ÿ

## æµ‹è¯•
### 213.ç¼–å†™æµ‹è¯•è®¡åˆ’çš„ç›®çš„æ˜¯
### 214.å¯¹å…³é”®è¯è§¦å‘æ¨¡å—è¿›è¡Œæµ‹è¯•
### 215.å…¶ä»–å¸¸ç”¨ç¬”è¯•é¢˜ç›®ç½‘å€æ±‡æ€»
### 216.æµ‹è¯•äººå‘˜åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„ä»»åŠ¡æ˜¯ä»€ä¹ˆ
### 217.ä¸€æ¡è½¯ä»¶Bugè®°å½•éƒ½åŒ…å«äº†å“ªäº›å†…å®¹ï¼Ÿ
### 218.ç®€è¿°é»‘ç›’æµ‹è¯•å’Œç™½ç›’æµ‹è¯•çš„ä¼˜ç¼ºç‚¹
### 219.è¯·åˆ—å‡ºä½ æ‰€çŸ¥é“çš„è½¯ä»¶æµ‹è¯•ç§ç±»ï¼Œè‡³å°‘5é¡¹
### 220.Alphaæµ‹è¯•ä¸Betaæµ‹è¯•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
### 221.ä¸¾ä¾‹è¯´æ˜ä»€ä¹ˆæ˜¯Bugï¼Ÿä¸€ä¸ªbug reportåº”åŒ…å«ä»€ä¹ˆå…³é”®å­—ï¼Ÿ

## å¤§æ•°æ®
### 242.æ‰¾å‡º1Gçš„æ–‡ä»¶ä¸­é«˜é¢‘è¯
### 243.ä¸€ä¸ªå¤§çº¦æœ‰ä¸€ä¸‡è¡Œçš„æ–‡æœ¬æ–‡ä»¶ç»Ÿè®¡é«˜é¢‘è¯
### 244.æ€ä¹ˆåœ¨æµ·é‡æ•°æ®ä¸­æ‰¾å‡ºé‡å¤æ¬¡æ•°æœ€å¤šçš„ä¸€ä¸ªï¼Ÿ
### 245.åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨å¤§é‡æ•°æ®ä¸­

## æ¶æ„

### [Pythonåç«¯æ¶æ„æ¼”è¿›](<https://zhu327.github.io/2018/07/19/python%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/>)

è¿™ç¯‡æ–‡ç« å‡ ä¹æ¶µç›–äº†pythonä¼šç”¨çš„æ¶æ„ï¼Œåœ¨é¢è¯•å¯ä»¥æ‰‹ç”»æ¶æ„å›¾ï¼Œæ ¹æ®è‡ªå·±çš„é¡¹ç›®è°ˆä¸‹æŠ€æœ¯é€‰å‹å’Œä¼˜åŠ£ï¼Œé‡åˆ°çš„å‘ç­‰ã€‚ç»å¯¹åŠ åˆ†å¹¿è€Œå‘Šä¹‹ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å· AlwaysBetaï¼Œé‡Œé¢æœ‰å„ç§åç«¯å¼€å‘å¹²è´§ï¼Œé¢è¯•çœŸé¢˜ï¼ŒåŠ©ä½ è½»è½»æ¾æ¾è¿›å¤§å‚ã€‚

![](http://ww1.sinaimg.cn/large/0061a0TTgy1gaqr087j9xj3076076wex.jpg)

æƒ³å­¦ä¹  Go çš„åŒå­¦å¯ä»¥åˆ°è¿™é‡Œçœ‹çœ‹ï¼šhttps://github.com/yongxinz/gopher

Go å­¦ä¹ è·¯çº¿å›¾ï¼ŒåŒ…æ‹¬åŸºç¡€ä¸“æ ï¼Œè¿›é˜¶ä¸“æ ï¼Œæºç é˜…è¯»ï¼Œå®æˆ˜å¼€å‘ï¼Œé¢è¯•åˆ·é¢˜ï¼Œå¿…è¯»ä¹¦å•ç­‰ä¸€ç³»åˆ—èµ„æºã€‚

### 

# åç«¯é¢è¯•é¢˜æ±‡æ€»

åŒ…æ‹¬ Pythonã€Goã€Redisã€MySQLã€PostgreSQLã€Kafkaã€æ•°æ®ç»“æ„ã€ç®—æ³•ã€ç¼–ç¨‹ã€ç½‘ç»œç­‰ç›¸å…³å†…å®¹ï¼Œæ¬¢è¿å…³æ³¨ã€‚

## Python

- [Python å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/Python)

## Go
- [äº¤æ›¿æ‰“å°æ•°å­—å’Œå­—æ¯](Go/q001.md)
- [åˆ¤æ–­å­—ç¬¦ä¸²ä¸­å­—ç¬¦æ˜¯å¦å…¨éƒ½ä¸åŒ](Go/q002.md)
- [ç¿»è½¬å­—ç¬¦ä¸²](Go/q003.md)
- [åˆ¤æ–­ä¸¤ä¸ªç»™å®šçš„å­—ç¬¦ä¸²æ’åºåæ˜¯å¦ä¸€è‡´](Go/q004.md)
- [å­—ç¬¦ä¸²æ›¿æ¢é—®é¢˜](Go/q005.md)
- [æœºå™¨äººåæ ‡è®¡ç®—](Go/q006.md)
- [è¯­æ³•é¢˜ç›®ä¸€](Go/q007.md)
- [è¯­æ³•é¢˜ç›®äºŒ](Go/q008.md)
- [goroutineå’Œchannelä½¿ç”¨ä¸€](Go/q009.md)
- [å®ç°é˜»å¡è¯»çš„å¹¶å‘å®‰å…¨Map](Go/q010.md)
- [é«˜å¹¶å‘ä¸‹çš„é”ä¸mapè¯»å†™é—®é¢˜](Go/q011.md)
- [å®šæ—¶ä¸ panic æ¢å¤](Go/q012.md)
- [ä¸º sync.WaitGroup ä¸­Waitå‡½æ•°æ”¯æŒ WaitTimeout åŠŸèƒ½.](Go/q013.md)
- [ä¸ƒé“è¯­æ³•æ‰¾é”™é¢˜ç›®](Go/q014.md)
- [golang å¹¶å‘é¢˜ç›®æµ‹è¯•](Go/q015.md)
- [è®°ä¸€é“å­—èŠ‚è·³åŠ¨çš„ç®—æ³•é¢è¯•é¢˜](Go/q016.md)
- [å¤šåç¨‹æŸ¥è¯¢åˆ‡ç‰‡é—®é¢˜](Go/q017.md)
- [å¯¹å·²ç»å…³é—­çš„çš„chanè¿›è¡Œè¯»å†™ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ](Go/q018.md)
- [ç®€å•èŠèŠå†…å­˜é€ƒé€¸ï¼Ÿ](Go/q019.md)
- [å­—ç¬¦ä¸²è½¬æˆbyteæ•°ç»„ï¼Œä¼šå‘ç”Ÿå†…å­˜æ‹·è´å—ï¼Ÿ](Go/q020.md)
- [httpåŒ…çš„å†…å­˜æ³„æ¼](Go/q021.md)
- [sync.Map çš„ç”¨æ³•](Go/q022.md)
- [Goè¯­è¨€çš„GPMè°ƒåº¦å™¨æ˜¯ä»€ä¹ˆï¼Ÿ](Go/go-gpm.md)
- [Goroutineè°ƒåº¦ç­–ç•¥](Go/go-scheduler.md)
- [goroutineè°ƒåº¦å™¨æ¦‚è¿°](Go/go-scheduler-base.md)

## æ•°æ®åº“
### MySQL

- [MySQL å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/MySQL)
- [MySQLæ•°æ®åº“ç»å…¸é¢è¯•é¢˜è§£æ](MySQL/mysql-interview.md)
- [MySQL InnoDB MVCC æœºåˆ¶çš„åŸç†åŠå®ç°](MySQL/mysql-mvcc.md)
- [ä¸ºä»€ä¹ˆMySQLä½¿ç”¨B+æ ‘åšç´¢å¼•ï¼Ÿ](MySQL/mysql-index-b-plus.md)
- [20 é“ MySQL é¢è¯•é¢˜](https://mp.weixin.qq.com/s/KVnMi45dvuLaRjoxcmpbNw)
- [çœ‹ä¸€éå°±ç†è§£ï¼šorder by è¯¦è§£](https://mp.weixin.qq.com/s/h9jWeoyiBGnQLvDrtXqVWw)

### Redis

- [Redis å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/Redis)
- [Redis åŸºç¡€æ•°æ®ç»“æ„](Redis/redis.md)
- [Redisä¸­çš„åº•å±‚æ•°æ®ç»“æ„](Redis/redis-data-structure.md)
- [RedisæŒä¹…åŒ–çš„åŸç†åŠä¼˜åŒ–](Redis/redis-rdb.md)
- [Redisä¸­å†…å­˜æ·˜æ±°ç®—æ³•å®ç°](Redis/redis-policy.md)
- [Redisä¸»ä»å¤åˆ¶åŸç†](Redis/redis-master-slave.md)
- [Redis å¤ºå‘½è¿ç¯ 20 é—®](https://mp.weixin.qq.com/s/PUSpuyh6dOi2zWM6J0-EJA)
- [Redisçš„äº‹åŠ¡æ»¡è¶³åŸå­æ€§å—ï¼Ÿ](https://mp.weixin.qq.com/s/KAdivX9aYK2NgUJsDeKCpA)
- [ç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§é—®é¢˜](https://mp.weixin.qq.com/s/4W7vmICGx6a_WX701zxgPQ)

### MongoDB

- [MongoDB å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/MongoDB)

## ä¸­é—´ä»¶

- [ä¸­é—´ä»¶å¸¸è€ƒé¢˜](ä¸­é—´ä»¶/README.md)

## é¡¹ç›®ä¸æ¶æ„

- [é¡¹ç›®ä¸æ¶æ„å¸¸è€ƒé¢˜](é¡¹ç›®ä¸æ¶æ„/README.md)

## æ•°æ®ç»“æ„ä¸ç®—æ³•

- [æ•°æ®ç»“æ„ä¸ç®—æ³•å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95)

## ç³»ç»Ÿç¼–ç¨‹

- [ç³»ç»Ÿç¼–ç¨‹å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B)

## ç½‘ç»œ

- [ç½‘ç»œå¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/%E7%BD%91%E7%BB%9C)

## ç¼–ç¨‹é¢˜

- [ç¼–ç¨‹é¢˜å¸¸è€ƒé¢˜](https://github.com/yongxinz/backend-interview/tree/master/%E7%BC%96%E7%A8%8B%E9%A2%98)

### 1ã€Redis æ˜¯ä»€ä¹ˆï¼Ÿ

1. æ˜¯ä¸€ä¸ªå®Œå…¨å¼€æºå…è´¹çš„ key-value å†…å­˜æ•°æ®åº“ 
2. é€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„æœåŠ¡å™¨ï¼Œä¸»è¦æ˜¯å› ä¸ºå…¶æœ‰ç€ä¸°å¯Œçš„æ•°æ®ç»“æ„ stringsã€hashã€listã€setsã€sorted sets

é€šå¸¸å±€é™ç‚¹æ¥è¯´ï¼ŒRedisä¹Ÿä»¥æ¶ˆæ¯é˜Ÿåˆ—çš„å½¢å¼å­˜åœ¨ï¼Œä½œä¸ºå†…åµŒçš„Listå­˜åœ¨ï¼Œæ»¡è¶³å®æ—¶çš„é«˜å¹¶å‘éœ€æ±‚ã€‚åœ¨ä½¿ç”¨ç¼“å­˜çš„æ—¶å€™ï¼Œredisæ¯”memcachedå…·æœ‰æ›´å¤šçš„ä¼˜åŠ¿ï¼Œå¹¶ä¸”æ”¯æŒæ›´å¤šçš„æ•°æ®ç±»å‹ï¼ŒæŠŠrediså½“ä½œä¸€ä¸ªä¸­é—´å­˜å‚¨ç³»ç»Ÿï¼Œç”¨æ¥å¤„ç†é«˜å¹¶å‘çš„æ•°æ®åº“æ“ä½œã€‚

- é€Ÿåº¦å¿«ï¼šä½¿ç”¨æ ‡å‡†Cå†™ï¼Œæ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­å®Œæˆï¼Œè¯»å†™é€Ÿåº¦åˆ†åˆ«è¾¾åˆ°10ä¸‡/20ä¸‡ 
- æŒä¹…åŒ–ï¼šå¯¹æ•°æ®çš„æ›´æ–°é‡‡ç”¨Copy-on-writeæŠ€æœ¯ï¼Œå¯ä»¥å¼‚æ­¥åœ°ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œä¸»è¦æœ‰ä¸¤ç§ç­–ç•¥ï¼Œä¸€æ˜¯æ ¹æ®æ—¶é—´ï¼Œæ›´æ–°æ¬¡æ•°çš„å¿«ç…§ï¼ˆsave 300 10 ï¼‰äºŒæ˜¯åŸºäºè¯­å¥è¿½åŠ æ–¹å¼(Append-only fileï¼Œaof) 
- è‡ªåŠ¨æ“ä½œï¼šå¯¹ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œéƒ½æ˜¯è‡ªåŠ¨çš„ï¼Œå¾ˆå®‰å…¨ 
- å¿«é€Ÿçš„ä¸»--ä»å¤åˆ¶ï¼Œå®˜æ–¹æä¾›äº†ä¸€ä¸ªæ•°æ®ï¼ŒSlaveåœ¨21ç§’å³å®Œæˆäº†å¯¹Amazonç½‘ç«™10G key setçš„å¤åˆ¶ã€‚ 
- ShardingæŠ€æœ¯ï¼šå¾ˆå®¹æ˜“å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªRediså®ä¾‹ä¸­ï¼Œæ•°æ®åº“çš„æ‰©å±•æ˜¯ä¸ªæ°¸æ’çš„è¯é¢˜ï¼Œåœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œä¸»è¦æ˜¯ä»¥æ·»åŠ ç¡¬ä»¶ã€ä»¥åˆ†åŒºä¸ºä¸»è¦æŠ€æœ¯å½¢å¼çš„çºµå‘æ‰©å±•è§£å†³äº†å¾ˆå¤šçš„åº”ç”¨åœºæ™¯ï¼Œä½†éšç€web2.0ã€ç§»åŠ¨äº’è”ç½‘ã€äº‘è®¡ç®—ç­‰åº”ç”¨çš„å…´èµ·ï¼Œè¿™ç§æ‰©å±•æ¨¡å¼å·²ç»ä¸å¤ªé€‚åˆäº†ï¼Œæ‰€ä»¥è¿‘å¹´æ¥ï¼Œåƒé‡‡ç”¨ä¸»ä»é…ç½®ã€æ•°æ®åº“å¤åˆ¶å½¢å¼çš„ï¼ŒShardingè¿™ç§æŠ€æœ¯æŠŠè´Ÿè½½åˆ†å¸ƒåˆ°å¤šä¸ªç‰¹å®šèŠ‚ç‚¹ä¸Šå»çš„æ¨ªå‘æ‰©å±•æ–¹å¼ç”¨å¤„è¶Šæ¥è¶Šå¤šã€‚

### 2ã€Redis ç¼ºç‚¹

- æ˜¯æ•°æ®åº“å®¹é‡å—åˆ°ç‰©ç†å†…å­˜çš„é™åˆ¶,ä¸èƒ½ç”¨ä½œæµ·é‡æ•°æ®çš„é«˜æ€§èƒ½è¯»å†™,å› æ­¤Redisé€‚åˆçš„åœºæ™¯ä¸»è¦å±€é™åœ¨è¾ƒå°æ•°æ®é‡çš„é«˜æ€§èƒ½æ“ä½œå’Œè¿ç®—ä¸Šã€‚
- Redisè¾ƒéš¾æ”¯æŒåœ¨çº¿æ‰©å®¹ï¼Œåœ¨é›†ç¾¤å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶åœ¨çº¿æ‰©å®¹ä¼šå˜å¾—å¾ˆå¤æ‚ã€‚ä¸ºé¿å…è¿™ä¸€é—®é¢˜ï¼Œè¿ç»´äººå‘˜åœ¨ç³»ç»Ÿä¸Šçº¿æ—¶å¿…é¡»ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œè¿™å¯¹èµ„æºé€ æˆäº†å¾ˆå¤§çš„æµªè´¹ã€‚
  
### 3ã€Rediså®•æœºæ€ä¹ˆè§£å†³ï¼Ÿ

å®•æœº:æœåŠ¡å™¨åœæ­¢æœåŠ¡

å¦‚æœåªæœ‰ä¸€å°redisï¼Œè‚¯å®šä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Œæ— æ³•æŒ½æ•‘

å¤šå°redisæˆ–è€…æ˜¯redisé›†ç¾¤ï¼Œå®•æœºåˆ™éœ€è¦åˆ†ä¸ºåœ¨ä¸»ä»æ¨¡å¼ä¸‹åŒºåˆ†æ¥çœ‹ï¼š

slaveä»rediså®•æœºï¼Œé…ç½®ä¸»ä»å¤åˆ¶çš„æ—¶å€™æ‰é…ç½®ä»çš„redisï¼Œä»çš„ä¼šä»ä¸»çš„redisä¸­è¯»å–ä¸»çš„redisçš„æ“ä½œæ—¥å¿—ï¼Œåœ¨redisä¸­ä»åº“é‡æ–°å¯åŠ¨åä¼šè‡ªåŠ¨åŠ å…¥åˆ°ä¸»ä»æ¶æ„ä¸­ï¼Œè‡ªåŠ¨å®ŒæˆåŒæ­¥æ•°æ®;

å¦‚æœä»æ•°æ®åº“å®ç°äº†æŒä¹…åŒ–ï¼Œæ­¤æ—¶åƒä¸‡ä¸è¦ç«‹é©¬é‡å¯æœåŠ¡ï¼Œå¦åˆ™å¯èƒ½ä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼Œæ­£ç¡®çš„æ“ä½œå¦‚ä¸‹ï¼šåœ¨slaveæ•°æ®ä¸Šæ‰§è¡ŒSLAVEOF ON ONE,æ¥æ–­å¼€ä¸»ä»å…³ç³»å¹¶æŠŠslaveå‡çº§ä¸ºä¸»åº“ï¼Œæ­¤æ—¶é‡æ–°å¯åŠ¨ä¸»æ•°æ®åº“ï¼Œæ‰§è¡ŒSLAVEOFï¼ŒæŠŠå®ƒè®¾ç½®ä¸ºä»åº“ï¼Œè¿æ¥åˆ°ä¸»çš„redisä¸Šé¢åšä¸»ä»å¤åˆ¶ï¼Œè‡ªåŠ¨å¤‡ä»½æ•°æ®ã€‚

ä»¥ä¸Šè¿‡ç¨‹å¾ˆå®¹æ˜“é…ç½®é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨redisæä¾›çš„å“¨å…µæœºåˆ¶æ¥ç®€åŒ–ä¸Šé¢çš„æ“ä½œã€‚ç®€å•çš„æ–¹æ³•:redisçš„å“¨å…µ(sentinel)çš„åŠŸèƒ½

### 4ã€rediså’Œmecachedçš„åŒºåˆ«ï¼Œä»¥åŠä½¿ç”¨åœºæ™¯

åŒºåˆ«

1ã€rediså’ŒMemcacheéƒ½æ˜¯å°†æ•°æ®å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œéƒ½æ˜¯å†…å­˜æ•°æ®åº“ã€‚ä¸è¿‡memcacheè¿˜å¯ä»¥ç”¨äºç¼“å­˜å…¶ä»–ä¸œè¥¿ï¼Œä¾‹å¦‚å›¾ç‰‡ï¼Œè§†é¢‘ç­‰ç­‰

2ã€Redisä¸ä»…ä»…æ”¯æŒç®€å•çš„k/vç±»å‹çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜æä¾›list,set,hashç­‰æ•°æ®ç»“æ„çš„å­˜å‚¨

3ã€è™šæ‹Ÿå†…å­˜-rediså½“ç‰©ç†å†…å­˜ç”¨å®Œæ—¶ï¼Œå¯ä»¥å°†ä¸€äº›å¾ˆä¹…æ²¡ç”¨çš„valueäº¤æ¢åˆ°ç£ç›˜

4ã€è¿‡æœŸç­–ç•¥-memcacheåœ¨setæ—¶å°±æŒ‡å®šï¼Œä¾‹å¦‚set key1 0 0 8ï¼Œå³æ°¸ä¸è¿‡æœŸã€‚Rediså¯ä»¥é€šè¿‡ä¾‹å¦‚expireè®¾å®šï¼Œä¾‹å¦‚expire name 10

5ã€åˆ†å¸ƒå¼-è®¾å®šmemcacheé›†ç¾¤ï¼Œåˆ©ç”¨magentåšä¸€ä¸»å¤šä»ï¼Œrediså¯ä»¥åšä¸€ä¸»å¤šä»ã€‚éƒ½å¯ä»¥ä¸€ä¸»ä¸€ä¸›

6ã€å­˜å‚¨æ•°æ®å®‰å…¨-memcacheæŒ‚æ‰åï¼Œæ•°æ®æ²¡äº†ï¼Œrediså¯ä»¥å®šæœŸä¿å­˜åˆ°ç£ç›˜(æŒä¹…åŒ–)

7ã€ç¾éš¾æ¢å¤-memcacheæŒ‚æ‰åï¼Œæ•°æ®ä¸å¯æ¢å¤ï¼Œredisæ•°æ®ä¸¢å¤±åå¯ä»¥é€šè¿‡aofæ¢å¤

8ã€Redisæ”¯æŒæ•°æ®çš„å¤‡ä»½ï¼Œå³master-slaveæ¨¡å¼çš„æ•°æ®å¤‡ä»½

9ã€åº”ç”¨åœºæ™¯ä¸ä¸€æ ·ï¼Œredisé™¤äº†ä½œä¸ºNoSQLæ•°æ®åº“ä½¿ç”¨å¤–ï¼Œè¿˜èƒ½ç”¨åšæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ•°æ®å †æ ˆå’Œæ•°æ®ç¼“å­˜ç­‰;Memcacheé€‚åˆäºç¼“å­˜SQLè¯­å¥ï¼Œæ•°æ®é›†ï¼Œç”¨æˆ·ä¸´æ—¶æ€§æ•°æ®ï¼Œå»¶è¿ŸæŸ¥è¯¢æ•°æ®å’Œsessionç­‰

ä½¿ç”¨åœºæ™¯

1ã€å¦‚æœæœ‰æŒä¹…æ–¹é¢çš„éœ€æ±‚æˆ–å¯¹æ•°æ®ç±»å‹å’Œå¤„ç†æœ‰è¦æ±‚çš„åº”è¯¥é€‰æ‹©redis

2ã€å¦‚æœç®€å•çš„key/valueå­˜å‚¨åº”è¯¥é€‰æ‹©memcached.

### 5ã€Redisé›†ç¾¤æ–¹æ¡ˆè¯¥æ€ä¹ˆåš?éƒ½æœ‰å“ªäº›æ–¹æ¡ˆ?

1ã€redis ç›®å‰ç”¨çš„æœ€å¤šçš„é›†ç¾¤æ–¹æ¡ˆï¼ŒåŸºæœ¬å’Œtwemproxyä¸€è‡´çš„æ•ˆæœï¼Œä½†å®ƒæ”¯æŒåœ¨èŠ‚ç‚¹æ•°é‡æ”¹å˜æƒ…å†µä¸‹ï¼Œæ—§èŠ‚ç‚¹æ•°æ®å®¢æ¢å¤åˆ°æ–°hashèŠ‚ç‚¹

2ã€redis cluster3.0è‡ªå¸¦çš„é›†ç¾¤ï¼Œç‰¹ç‚¹åœ¨äºä»–çš„åˆ†å¸ƒå¼ç®—æ³•ä¸æ˜¯ä¸€è‡´æ€§hashï¼Œè€Œæ˜¯hashæ§½çš„æ¦‚å¿µï¼Œä»¥åŠè‡ªèº«æ”¯æŒèŠ‚ç‚¹è®¾ç½®ä»èŠ‚ç‚¹ã€‚å…·ä½“çœ‹å®˜æ–¹ä»‹ç»

3ã€åœ¨ä¸šåŠ¡ä»£ç å±‚å®ç°ï¼Œèµ·å‡ ä¸ªæ¯«æ— å…³è”çš„rediså®ä¾‹ï¼Œåœ¨ä»£ç å±‚ï¼Œå¯¹keyè¿›è¡Œhashè®¡ç®—ï¼Œç„¶åå»å¯¹åº”çš„rediså®ä¾‹æ“ä½œæ•°æ®ã€‚è¿™ç§æ–¹å¼å¯¹hashå±‚ä»£ç è¦æ±‚æ¯”è¾ƒé«˜ï¼Œè€ƒè™‘éƒ¨åˆ†åŒ…æ‹¬ï¼ŒèŠ‚ç‚¹å¤±æ•ˆåçš„æ›¿ä»£ç®—æ³•æ–¹æ¡ˆï¼Œæ•°æ®éœ‡è¡åçš„å­—å…¸è„šæœ¬æ¢å¤ï¼Œå®ä¾‹çš„ç›‘æ§ï¼Œç­‰ç­‰

### 6ã€Rediså›æ”¶è¿›ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„

ä¸€ä¸ªå®¢æˆ·ç«¯è¿è¡Œäº†æ–°çš„å‘½ä»¤ï¼Œæ·»åŠ äº†æ–°çš„æ•°æ®ã€‚

redisæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœå¤§äºmaxmemoryçš„é™åˆ¶ï¼Œåˆ™æ ¹æ®è®¾å®šå¥½çš„ç­–ç•¥è¿›è¡Œå›æ”¶ã€‚

ä¸€ä¸ªæ–°çš„å‘½ä»¤è¢«æ‰§è¡Œç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æ–­åœ°ç©¿è¶Šå†…å­˜é™åˆ¶çš„è¾¹ç•Œï¼Œé€šè¿‡ä¸æ–­è¾¾åˆ°è¾¹ç•Œç„¶åä¸æ–­å›æ”¶å›åˆ°è¾¹ç•Œä»¥ä¸‹ã€‚

å¦‚æœä¸€ä¸ªå‘½ä»¤çš„ç»“æœå¯¼è‡´å¤§é‡å†…å­˜è¢«ä½¿ç”¨(ä¾‹å¦‚å¾ˆå¤§çš„é›†åˆçš„äº¤é›†ä¿å­˜åˆ°ä¸€ä¸ªæ–°çš„é”®)ï¼Œä¸ç”¨å¤šä¹…å†…å­˜é™åˆ¶å°±ä¼šè¢«è¿™ä¸ªå†…å­˜ä½¿ç”¨é‡è¶…è¶Šã€‚

### 7ã€Redis è·Ÿ MySQL ç¼“å­˜ä¸€è‡´æ€§

https://zhuanlan.zhihu.com/p/59167071

### 8ã€Redis çš„å‡ ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œåº•å±‚å®ç°

https://zhuanlan.zhihu.com/p/344918922

### 9ã€Redis ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«

- https://zhuanlan.zhihu.com/p/160157573
- https://xie.infoq.cn/article/b3816e9fe3ac77684b4f29348

### 10ã€Redis ä¸­å¸¸è§é›†ç¾¤éƒ¨ç½²æƒ…å†µï¼Œå‡ºç°æ€§èƒ½é—®é¢˜å¦‚ä½•æ’æŸ¥ã€‚

https://mp.weixin.qq.com/s/q79ji-cgfUMo7H0p254QRg

### 11ã€Redis ä¸­çš„äº‹åŠ¡ã€‚

https://mp.weixin.qq.com/s/Hevg_4YJT_PzVd1Z_yE1TQ

### 12ã€ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€

https://mp.weixin.qq.com/s/_StOUX9Nu-Bo8UpX7ThZmg

### 13ã€Redis çš„æŒä¹…åŒ–

https://mp.weixin.qq.com/s/yP2HH8840OMY4e7tKMymiA

### 14ã€Redisä¸æ˜¯å·ç§°å•çº¿ç¨‹ä¹Ÿæœ‰å¾ˆé«˜çš„æ€§èƒ½ä¹ˆï¼Ÿä¸ºå•¥è¿˜éœ€è¦å¤šçº¿ç¨‹ï¼Ÿ

https://mp.weixin.qq.com/s/SYUYvKCxsyMbdBsRrJOZqA

### 15ã€Redis è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶

https://segmentfault.com/a/1190000023060522

### 16ã€Redis åˆ†å¸ƒå¼é”æ€ä¹ˆç”¨ï¼Ÿæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

https://mp.weixin.qq.com/s/IoDPieqgY995cyyWAQrQew

### 17ã€Redisä¸ºä»€ä¹ˆå˜æ…¢äº†ï¼Ÿä¸€æ–‡è®²é€å¦‚ä½•æ’æŸ¥Redisæ€§èƒ½é—®é¢˜

https://mp.weixin.qq.com/s/Qc4t_-_pL4w8VlSoJhRDcg
# Redisä¸­çš„æ•°æ®ç»“æ„

åŸæ–‡åœ°å€  [Redisä¸­çš„æ•°æ®ç»“æ„](https://www.cnblogs.com/neooelric/p/9621736.html)

## 1. åº•å±‚æ•°æ®ç»“æ„, ä¸Redis Value Typeä¹‹é—´çš„å…³ç³»

å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´, Redisä½œä¸ºKey-Valueå‹çš„å†…å­˜æ•°æ®åº“, å…¶Valueæœ‰å¤šç§ç±»å‹.

- String
- Hash
- List
- Set
- ZSet

è¿™äº›Valueçš„ç±»å‹, åªæ˜¯"Redisçš„ç”¨æˆ·è®¤ä¸ºçš„, Valueå­˜å‚¨æ•°æ®çš„æ–¹å¼". è€Œåœ¨å…·ä½“å®ç°ä¸Š, å„ä¸ªTypeçš„Valueåˆ°åº•å¦‚ä½•å­˜å‚¨, è¿™å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´æ˜¯ä¸å…¬å¼€çš„.

ä¸¾ä¸ªç²Ÿå­: ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªKey-Value

```bash
SET "Hello" "World"
```

å¯¹äºRedisçš„ä½¿ç”¨è€…æ¥è¯´, `Hello`è¿™ä¸ªKey, å¯¹åº”çš„Valueæ˜¯Stringç±»å‹, å…¶å€¼ä¸ºäº”ä¸ªASCIIå­—ç¬¦ç»„æˆçš„äºŒè¿›åˆ¶æ•°æ®. ä½†å…·ä½“åœ¨åº•å±‚å®ç°ä¸Š, è¿™äº”ä¸ªå­—èŠ‚æ˜¯å¦‚ä½•å­˜å‚¨çš„, æ˜¯ä¸å¯¹ç”¨æˆ·å…¬å¼€çš„. å³, Valueçš„Type, åªæ˜¯è¡¨è±¡, å…·ä½“æ•°æ®åœ¨å†…å­˜ä¸­ä»¥ä½•ç§æ•°æ®ç»“æ„å­˜æ”¾, è¿™å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯ä¸å¿…è¦äº†è§£çš„.

Rediså¯¹ä½¿ç”¨è€…æš´éœ²äº†äº”ç§`Value Type`, å…¶åº•å±‚å®ç°çš„æ•°æ®ç»“æ„æœ‰8ç§, åˆ†åˆ«æ˜¯:

- SDS - simple synamic string - æ”¯æŒè‡ªåŠ¨åŠ¨æ€æ‰©å®¹çš„å­—èŠ‚æ•°ç»„
- list - å¹³å¹³æ— å¥‡çš„é“¾è¡¨
- dict - ä½¿ç”¨åŒå“ˆå¸Œè¡¨å®ç°çš„, æ”¯æŒå¹³æ»‘æ‰©å®¹çš„å­—å…¸
- zskiplist - é™„åŠ äº†åå‘æŒ‡é’ˆçš„è·³è·ƒè¡¨
- intset - ç”¨äºå­˜å‚¨æ•´æ•°æ•°å€¼é›†åˆçš„è‡ªæœ‰ç»“æ„
- ziplist - ä¸€ç§å®ç°ä¸Šç±»ä¼¼äºTLV, ä½†æ¯”TLVå¤æ‚çš„, ç”¨äºå­˜å‚¨ä»»æ„æ•°æ®çš„æœ‰åºåºåˆ—çš„æ•°æ®ç»“æ„
- quicklist - ä¸€ç§ä»¥ziplistä½œä¸ºç»“ç‚¹çš„åŒé“¾è¡¨ç»“æ„, å®ç°çš„éå¸¸è‹Ÿ
- zipmap - ä¸€ç§ç”¨äºåœ¨å°è§„æ¨¡åœºåˆä½¿ç”¨çš„è½»é‡çº§å­—å…¸ç»“æ„

è€Œè¡”æ¥"åº•å±‚æ•°æ®ç»“æ„"ä¸"Value Type"çš„æ¡¥æ¢çš„, åˆ™æ˜¯Rediså®ç°çš„å¦å¤–ä¸€ç§æ•°æ®ç»“æ„: `redisObject`. Redisä¸­çš„Keyä¸Valueåœ¨è¡¨å±‚éƒ½æ˜¯ä¸€ä¸ª`redisObject`å®ä¾‹, æ•…è¯¥ç»“æ„æœ‰æ‰€è°“çš„"ç±»å‹", å³æ˜¯`ValueType`. å¯¹äºæ¯ä¸€ç§`Value Type`ç±»å‹çš„`redisObject`, å…¶åº•å±‚è‡³å°‘æ”¯æŒä¸¤ç§ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„æ¥å®ç°. ä»¥åº”å¯¹åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸­, Redisçš„è¿è¡Œæ•ˆç‡, æˆ–å†…å­˜å ç”¨.


## 2. åº•å±‚æ•°æ®ç»“æ„

### 2.1 SDS - simple dynamic string

è¿™æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„ä¸€ç§ç»“æ„, å…·æœ‰åŠ¨æ€æ‰©å®¹çš„ç‰¹ç‚¹. å…¶å®ç°ä½äºsrc/sds.hä¸src/sds.cä¸­, å…¶å…³é”®å®šä¹‰å¦‚ä¸‹:

```cgo
typedef char *sds;

/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
```

SDSçš„æ€»ä½“æ¦‚è§ˆå¦‚ä¸‹å›¾:

![](../images/668722-20180910183925685-224282854.png)

å…¶ä¸­sdshdræ˜¯å¤´éƒ¨, bufæ˜¯çœŸå®å­˜å‚¨ç”¨æˆ·æ•°æ®çš„åœ°æ–¹. å¦å¤–æ³¨æ„, ä»å‘½åä¸Šèƒ½çœ‹å‡ºæ¥, è¿™ä¸ªæ•°æ®ç»“æ„é™¤äº†èƒ½å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®, æ˜¾ç„¶æ˜¯ç”¨äºè®¾è®¡ä½œä¸ºå­—ç¬¦ä¸²ä½¿ç”¨çš„, æ‰€ä»¥åœ¨bufä¸­, ç”¨æˆ·æ•°æ®åæ€»è·Ÿç€ä¸€ä¸ª\0. å³å›¾ä¸­ "æ•°æ®" + "\0" æ˜¯ä¸ºæ‰€è°“çš„buf

SDSæœ‰äº”ç§ä¸åŒçš„å¤´éƒ¨. å…¶ä¸­sdshdr5å®é™…å¹¶æœªä½¿ç”¨åˆ°. æ‰€ä»¥å®é™…ä¸Šæœ‰å››ç§ä¸åŒçš„å¤´éƒ¨, åˆ†åˆ«å¦‚ä¸‹:

![](../images/668722-20180910183940043-66166526.png)


- lenåˆ†åˆ«ä»¥uint8, uint16, uint32, uint64è¡¨ç¤ºç”¨æˆ·æ•°æ®çš„é•¿åº¦(ä¸åŒ…æ‹¬æœ«å°¾çš„\0)
- allocåˆ†åˆ«ä»¥uint8, uint16, uint32, uint64è¡¨ç¤ºæ•´ä¸ªSDS, é™¤è¿‡å¤´éƒ¨ä¸æœ«å°¾çš„\0, å‰©ä½™çš„å­—èŠ‚æ•°.
- flagå§‹ç»ˆä¸ºä¸€å­—èŠ‚, ä»¥ä½ä¸‰ä½æ ‡ç¤ºç€å¤´éƒ¨çš„ç±»å‹, é«˜5ä½æœªä½¿ç”¨.

å½“åœ¨ç¨‹åºä¸­æŒæœ‰ä¸€ä¸ªSDSå®ä¾‹æ—¶, ç›´æ¥æŒæœ‰çš„æ˜¯æ•°æ®åŒºçš„å¤´æŒ‡é’ˆ, è¿™æ ·åšçš„ç”¨æ„æ˜¯: é€šè¿‡è¿™ä¸ªæŒ‡é’ˆ, å‘å‰åä¸€ä¸ªå­—èŠ‚, å°±èƒ½å–åˆ°flag, é€šè¿‡åˆ¤æ–­flagä½ä¸‰ä½çš„å€¼, èƒ½è¿…é€Ÿåˆ¤æ–­: å¤´éƒ¨çš„ç±»å‹, å·²ç”¨å­—èŠ‚æ•°, æ€»å­—èŠ‚æ•°, å‰©ä½™å­—èŠ‚æ•°. è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆsdsç±»å‹å³æ˜¯char *æŒ‡é’ˆç±»å‹åˆ«åçš„åŸå› .

åˆ›å»ºä¸€ä¸ªSDSå®ä¾‹æœ‰ä¸‰ä¸ªæ¥å£, åˆ†åˆ«æ˜¯:

```cgo
// åˆ›å»ºä¸€ä¸ªä¸å«æ•°æ®çš„sds: 
//  å¤´éƒ¨    3å­—èŠ‚ sdshdr8
//  æ•°æ®åŒº  0å­—èŠ‚
//  æœ«å°¾    \0 å ä¸€å­—èŠ‚
sds sdsempty(void);
// å¸¦æ•°æ®åˆ›å»ºä¸€ä¸ªsds:
//  å¤´éƒ¨    æŒ‰initlençš„å€¼, é€‰æ‹©æœ€å°çš„å¤´éƒ¨ç±»å‹
//  æ•°æ®åŒº  ä»å…¥å‚æŒ‡é’ˆinitå¤„å¼€å§‹, æ‹·è´initlenä¸ªå­—èŠ‚
//  æœ«å°¾    \0 å ä¸€å­—èŠ‚
sds sdsnewlen(const void *init, size_t initlen);
// å¸¦æ•°æ®åˆ›å»ºä¸€ä¸ªsds:
//  å¤´éƒ¨    æŒ‰strlen(init)çš„å€¼, é€‰æ‹©æœ€å°çš„å¤´éƒ¨ç±»å‹
//  æ•°æ®åŒº  å…¥å‚æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­—ç¬¦, ä¸åŒ…æ‹¬æœ«å°¾ \0
//  æœ«å°¾    \0 å ä¸€å­—èŠ‚
sds sdsnew(const char *init);
```

- æ‰€æœ‰åˆ›å»ºsdså®ä¾‹çš„æ¥å£, éƒ½ä¸ä¼šé¢å¤–åˆ†é…é¢„ç•™å†…å­˜ç©ºé—´
- `sdsnewlen`ç”¨äºå¸¦äºŒè¿›åˆ¶æ•°æ®åˆ›å»ºsdså®ä¾‹, sdsnewç”¨äºå¸¦å­—ç¬¦ä¸²åˆ›å»ºsdså®ä¾‹. æ¥å£è¿”å›çš„sdså¯ä»¥ç›´æ¥ä¼ å…¥libcä¸­çš„å­—ç¬¦ä¸²è¾“å‡ºå‡½æ•°ä¸­è¿›è¡Œæ“ä½œ, ç”±äºæ— è®ºå…¶ä¸­å­˜å‚¨çš„æ˜¯ç”¨æˆ·çš„äºŒè¿›åˆ¶æ•°æ®, è¿˜æ˜¯å­—ç¬¦ä¸², å…¶æœ«å°¾éƒ½å¸¦ä¸€ä¸ª\0, æ‰€ä»¥è‡³å°‘è°ƒç”¨libcä¸­çš„å­—ç¬¦ä¸²è¾“å‡ºå‡½æ•°æ˜¯å®‰å…¨çš„.

åœ¨å¯¹SDSä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶, è‹¥å‰©ä½™ç©ºé—´ä¸è¶³, ä¼šè°ƒç”¨sdsMakeRoomForå‡½æ•°ç”¨äºæ‰©å®¹ç©ºé—´, è¿™æ˜¯ä¸€ä¸ªå¾ˆä½çº§çš„API, é€šå¸¸æƒ…å†µä¸‹ä¸åº”å½“ç”±SDSçš„ä½¿ç”¨è€…ç›´æ¥è°ƒç”¨. å…¶å®ç°ä¸­æ ¸å¿ƒçš„å‡ è¡Œå¦‚ä¸‹:

```cgo
sds sdsMakeRoomFor(sds s, size_t addlen) {
    ...
    /* Return ASAP if there is enough space left. */
    if (avail >= addlen) return s;

    len = sdslen(s);
    sh = (char*)s-sdsHdrSize(oldtype);
    newlen = (len+addlen);
    if (newlen < SDS_MAX_PREALLOC)
        newlen *= 2;
    else
        newlen += SDS_MAX_PREALLOC;
    ...
}
```

å¯ä»¥çœ‹åˆ°, åœ¨æ‰©å……ç©ºé—´æ—¶

- å…ˆä¿è¯è‡³å°‘æœ‰addlenå¯ç”¨
- ç„¶åå†è¿›ä¸€æ­¥æ‰©å……, åœ¨æ€»ä½“å ç”¨ç©ºé—´ä¸è¶…è¿‡é˜ˆå€¼`SDS_MAC_PREALLOC`æ—¶, ç”³è¯·ç©ºé—´å†ç¿»ä¸€å€. è‹¥æ€»ä½“ç©ºé—´å·²ç»è¶…è¿‡äº†é˜ˆå€¼, åˆ™æ­¥è¿›å¢é•¿`SDS_MAC_PREALLOC`. è¿™ä¸ªé˜ˆå€¼çš„é»˜è®¤å€¼ä¸º `1024 * 1024`

SDSä¹Ÿæä¾›äº†æ¥å£ç”¨äºç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å†…å­˜ç©ºé—´. `sdsRemoveFreeSpace`, è¯¥æ¥å£æ²¡æœ‰é—´æ¥çš„è¢«ä»»ä½•SDSå…¶å®ƒæ¥å£è°ƒç”¨, å³é»˜è®¤æƒ…å†µä¸‹, SDSä¸ä¼šè‡ªåŠ¨å›æ”¶é¢„ç•™ç©ºé—´. åœ¨SDSçš„ä½¿ç”¨è€…éœ€è¦èŠ‚çœå†…å­˜æ—¶, ç”±ä½¿ç”¨è€…è‡ªè¡Œè°ƒç”¨:

```cgo
sds sdsRemoveFreeSpace(sds s);
```

æ€»ç»“:

- SDSé™¤äº†æ˜¯æŸäº›Value Typeçš„åº•å±‚å®ç°, ä¹Ÿè¢«å¤§é‡ä½¿ç”¨åœ¨Rediså†…éƒ¨, ç”¨äºæ›¿ä»£C-Styleå­—ç¬¦ä¸². æ‰€ä»¥é»˜è®¤çš„åˆ›å»ºSDSå®ä¾‹æ¥å£, ä¸åˆ†é…é¢å¤–çš„é¢„ç•™ç©ºé—´. å› ä¸ºå¤šæ•°å­—ç¬¦ä¸²åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ˜¯ä¸å˜çš„. è€Œå¯¹äºå˜æ›´æ•°æ®åŒºçš„API, å…¶å†…éƒ¨åˆ™æ˜¯è°ƒç”¨äº† sdsMakeRoomFor, æ¯ä¸€æ¬¡æ‰©å……ç©ºé—´, éƒ½ä¼šé¢„ç•™å¤§é‡çš„ç©ºé—´. è¿™æ ·åšçš„è€ƒé‡æ˜¯: å¦‚æœä¸€ä¸ªSDSå®ä¾‹ä¸­çš„æ•°æ®è¢«å˜æ›´äº†, é‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¼šåœ¨åç»­å‘ç”Ÿå¤šæ¬¡å˜æ›´.
- SDSçš„APIå†…éƒ¨ä¸è´Ÿè´£æ¸…é™¤æœªä½¿ç”¨çš„é—²ç½®å†…å­˜ç©ºé—´, å› ä¸ºå†…éƒ¨APIæ— æ³•åˆ¤æ–­è¿™æ ·åšçš„åˆé€‚æ—¶æœº. å³ä¾¿æ˜¯åœ¨æ“ä½œæ•°æ®åŒºçš„æ—¶å€™å¯¼è‡´æ•°æ®åŒºå ç”¨å†…å­˜å‡å°‘æ—¶, å†…éƒ¨APIä¹Ÿä¸ä¼šæ¸…é™¤é—²ç½®å†…åœ¨ç©ºé—´. æ¸…é™¤é—²ç½®å†…å­˜ç©ºé—´è´£ä»»åº”å½“ç”±SDSçš„ä½¿ç”¨è€…è‡ªè¡Œæ‹…å½“.
- ç”¨SDSæ›¿ä»£C-Styleå­—ç¬¦ä¸²æ—¶, ç”±äºå…¶å¤´éƒ¨é¢å¤–å­˜å‚¨äº†æ•°æ®åŒºçš„é•¿åº¦ä¿¡æ¯, æ‰€ä»¥å­—ç¬¦ä¸²çš„æ±‚é•¿æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)


### 2.2 list

è¿™æ˜¯æ™®é€šçš„é“¾è¡¨å®ç°, é“¾è¡¨ç»“ç‚¹ä¸ç›´æ¥æŒæœ‰æ•°æ®, è€Œæ˜¯é€šè¿‡void *æŒ‡é’ˆæ¥é—´æ¥çš„æŒ‡å‘æ•°æ®. å…¶å®ç°ä½äº src/adlist.hä¸src/adlist.cä¸­, å…³é”®å®šä¹‰å¦‚ä¸‹:

```cgo
typedef struct listNode {
    struct listNode *prev;
    struct listNode *next;
    void *value;
} listNode;

typedef struct listIter {
    listNode *next;
    int direction;
} listIter;

typedef struct list {
    listNode *head;
    listNode *tail;
    void *(*dup)(void *ptr);
    void (*free)(void *ptr);
    int (*match)(void *ptr, void *key);
    unsigned long len;
} list;
```

å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º:

![](../images/668722-20180910184001095-98860783.png)

è¿™æ˜¯ä¸€ä¸ªå¹³å¹³æ— å¥‡çš„é“¾è¡¨çš„å®ç°. liståœ¨Redisé™¤äº†ä½œä¸ºä¸€äº›Value Typeçš„åº•å±‚å®ç°å¤–, è¿˜å¹¿æ³›ç”¨äºRedisçš„å…¶å®ƒåŠŸèƒ½å®ç°ä¸­, ä½œä¸ºä¸€ç§æ•°æ®ç»“æ„å·¥å…·ä½¿ç”¨. åœ¨listçš„å®ç°ä¸­, é™¤äº†åŸºæœ¬çš„é“¾è¡¨å®šä¹‰å¤–, è¿˜é¢å¤–å¢åŠ äº†:

- è¿­ä»£å™¨`listIter`çš„å®šä¹‰, ä¸ç›¸å…³æ¥å£çš„å®ç°.
- ç”±äºlistä¸­çš„é“¾è¡¨ç»“ç‚¹æœ¬èº«å¹¶ä¸ç›´æ¥æŒæœ‰æ•°æ®, è€Œæ˜¯é€šè¿‡valueå­—æ®µ, ä»¥void *æŒ‡é’ˆçš„å½¢å¼é—´æ¥æŒæœ‰, æ‰€ä»¥æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸå¹¶ä¸å®Œå…¨ä¸é“¾è¡¨åŠå…¶ç»“ç‚¹ä¸€è‡´. è¿™ç»™äº†listçš„ä½¿ç”¨è€…ç›¸å½“å¤§çš„çµæ´»æ€§. æ¯”å¦‚å¯ä»¥å¤šä¸ªç»“ç‚¹æŒæœ‰åŒä¸€ä»½æ•°æ®çš„åœ°å€. ä½†ä¸æ­¤åŒæ—¶, åœ¨å¯¹é“¾è¡¨è¿›è¡Œé”€æ¯, ç»“ç‚¹å¤åˆ¶ä»¥åŠæŸ¥æ‰¾åŒ¹é…æ—¶, å°±éœ€è¦listçš„ä½¿ç”¨è€…å°†ç›¸å…³çš„å‡½æ•°æŒ‡é’ˆèµ‹å€¼äºlist.dup, list.free, list.matchå­—æ®µ.

### 2.3 dict

dictæ˜¯Redisåº•å±‚æ•°æ®ç»“æ„ä¸­å®ç°æœ€ä¸ºå¤æ‚çš„ä¸€ä¸ªæ•°æ®ç»“æ„, å…¶åŠŸèƒ½ç±»ä¼¼äºC++æ ‡å‡†åº“ä¸­çš„std::unordered_map, å…¶å®ç°ä½äº src/dict.h ä¸ src/dict.cä¸­, å…¶å…³é”®å®šä¹‰å¦‚ä¸‹:

```cgo
typedef struct dictEntry {
    void *key;
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    } v;
    struct dictEntry *next;
} dictEntry;

typedef struct dictType {
    uint64_t (*hashFunction)(const void *key);
    void *(*keyDup)(void *privdata, const void *key);
    void *(*valDup)(void *privdata, const void *obj);
    int (*keyCompare)(void *privdata, const void *key1, const void *key2);
    void (*keyDestructor)(void *privdata, void *key);
    void (*valDestructor)(void *privdata, void *obj);
} dictType;

/* This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. */
typedef struct dictht {
    dictEntry **table;
    unsigned long size;
    unsigned long sizemask;
    unsigned long used;
} dictht;

typedef struct dict {
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx; /* rehashing not in progress if rehashidx == -1 */
    unsigned long iterators; /* number of iterators currently running */
} dict;

/* If safe is set to 1 this is a safe iterator, that means, you can call
 * dictAdd, dictFind, and other functions against the dictionary even while
 * iterating. Otherwise it is a non safe iterator, and only dictNext()
 * should be called while iterating. */
typedef struct dictIterator {
    dict *d;
    long index;
    int table, safe;
    dictEntry *entry, *nextEntry;
    /* unsafe iterator fingerprint for misuse detection. */
    long long fingerprint;
} dictIterator;
```

å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:

![](../images/668722-20180910184019522-1324296109.png)

- dictä¸­å­˜å‚¨çš„é”®å€¼å¯¹, æ˜¯é€šè¿‡dictEntryè¿™ä¸ªç»“æ„é—´æ¥æŒæœ‰çš„, ké€šè¿‡æŒ‡é’ˆé—´æ¥æŒæœ‰é”®, vé€šè¿‡æŒ‡é’ˆé—´æ¥æŒæœ‰å€¼. æ³¨æ„, è‹¥å€¼æ˜¯æ•´æ•°å€¼çš„è¯, æ˜¯ç›´æ¥å­˜å‚¨åœ¨vå­—æ®µä¸­çš„, è€Œä¸æ˜¯é—´æ¥æŒæœ‰. åŒæ—¶nextæŒ‡é’ˆç”¨äºæŒ‡å‘, åœ¨bucketç´¢å¼•å€¼å†²çªæ—¶, ä»¥é“¾å¼æ–¹å¼è§£å†³å†²çª, æŒ‡å‘åŒç´¢å¼•çš„ä¸‹ä¸€ä¸ªdictEntryç»“æ„.
- ä¼ ç»Ÿçš„å“ˆå¸Œè¡¨å®ç°, æ˜¯ä¸€å—è¿ç»­ç©ºé—´çš„é¡ºåºè¡¨, è¡¨ä¸­å…ƒç´ å³æ˜¯ç»“ç‚¹. åœ¨dictht.tableä¸­, ç»“ç‚¹æœ¬èº«æ˜¯æ•£å¸ƒåœ¨å†…å­˜ä¸­çš„, é¡ºåºè¡¨ä¸­å­˜å‚¨çš„æ˜¯dictEntryçš„æŒ‡é’ˆ
- å“ˆå¸Œè¡¨å³æ˜¯dicthtç»“æ„, å…¶é€šè¿‡tableå­—æ®µé—´æ¥çš„æŒæœ‰é¡ºåºè¡¨å½¢å¼çš„bucket, bucketçš„å®¹é‡å­˜å‚¨åœ¨sizeå­—æ®µä¸­, ä¸ºäº†åŠ é€Ÿå°†æ•£åˆ—å€¼è½¬åŒ–ä¸ºbucketä¸­çš„æ•°ç»„ç´¢å¼•, å¼•å…¥äº†sizemaskå­—æ®µ, è®¡ç®—æŒ‡å®šé”®åœ¨å“ˆå¸Œè¡¨ä¸­çš„ç´¢å¼•æ—¶, æ‰§è¡Œçš„æ“ä½œç±»ä¼¼äºdict->type->hashFunction(é”®) & dict->ht[x].sizemask. ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥, bucketçš„å®¹é‡é€‚å®œäºä¸º2çš„å¹‚æ¬¡, è¿™æ ·è®¡ç®—å‡ºçš„ç´¢å¼•å€¼èƒ½è¦†ç›–åˆ°æ‰€æœ‰bucketç´¢å¼•ä½.
- dictå³ä¸ºå­—å…¸. å…¶ä¸­typeå­—æ®µä¸­å­˜å‚¨çš„æ˜¯æœ¬å­—å…¸ä½¿ç”¨åˆ°çš„å„ç§å‡½æ•°æŒ‡é’ˆ, åŒ…æ‹¬æ•£åˆ—å‡½æ•°, é”®ä¸å€¼çš„å¤åˆ¶å‡½æ•°, é‡Šæ”¾å‡½æ•°, ä»¥åŠé”®çš„æ¯”è¾ƒå‡½æ•°. privdataæ˜¯ç”¨äºå­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®. è¿™æ ·, å­—å…¸çš„ä½¿ç”¨è€…å¯ä»¥æœ€å¤§åŒ–çš„è‡ªå®šä¹‰å­—å…¸çš„å®ç°, é€šè¿‡è‡ªå®šä¹‰å„ç§å‡½æ•°å®ç°, ä»¥åŠå¯ä»¥é™„å¸¦ç§æœ‰æ•°æ®, ä¿è¯äº†å­—å…¸æœ‰å¾ˆå¤§çš„è°ƒä¼˜ç©ºé—´.
- å­—å…¸ä¸ºäº†æ”¯æŒå¹³æ»‘æ‰©å®¹, å®šä¹‰äº†ht[2]è¿™ä¸ªæ•°ç»„å­—æ®µ. å…¶ç”¨æ„æ˜¯è¿™æ ·çš„:
    1. ä¸€èˆ¬æƒ…å†µä¸‹, å­—å…¸dictä»…æŒæœ‰ä¸€ä¸ªå“ˆå¸Œè¡¨dicthtçš„å®ä¾‹, å³æ•´ä¸ªå­—å…¸ç”±ä¸€ä¸ªbucketå®ç°.
    2. éšç€æ’å…¥æ“ä½œ, bucketä¸­å‡ºç°å†²çªçš„æ¦‚ç‡ä¼šè¶Šæ¥è¶Šå¤§, å½“å­—å…¸ä¸­å­˜å‚¨çš„ç»“ç‚¹æ•°ç›®, ä¸bucketæ•°ç»„é•¿åº¦çš„æ¯”å€¼è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼(1:1)æ—¶, å­—å…¸ä¸ºäº†ç¼“è§£æ€§èƒ½ä¸‹é™, å°±éœ€è¦æ‰©å®¹
    3. æ‰©å®¹çš„æ“ä½œæ˜¯å¹³æ»‘çš„, å³åœ¨æ‰©å®¹æ—¶, å­—å…¸ä¼šæŒæœ‰ä¸¤ä¸ªdicthtçš„å®ä¾‹, ht[0]æŒ‡å‘æ—§å“ˆå¸Œè¡¨, ht[1]æŒ‡å‘æ‰©å®¹åçš„æ–°å“ˆå¸Œè¡¨. å¹³æ»‘æ‰©å®¹çš„é‡ç‚¹åœ¨äºä¸¤ä¸ªç­–ç•¥:
    4. åç»­æ¯ä¸€æ¬¡çš„æ’å…¥, æ›¿æ¢, æŸ¥æ‰¾æ“ä½œ, éƒ½æ’å…¥åˆ°ht[1]æŒ‡å‘çš„å“ˆå¸Œè¡¨ä¸­
    5. æ¯ä¸€æ¬¡æ’å…¥, æ›¿æ¢, æŸ¥æ‰¾æ“ä½œæ‰§è¡Œæ—¶, ä¼šå°†æ—§è¡¨ht[0]ä¸­çš„ä¸€ä¸ªbucketç´¢å¼•ä½æŒæœ‰çš„ç»“ç‚¹é“¾è¡¨, è¿ç§»åˆ°ht[1]ä¸­å». è¿ç§»çš„è¿›åº¦ä¿å­˜åœ¨rehashidxè¿™ä¸ªå­—æ®µä¸­.åœ¨æ—§è¡¨ä¸­ç”±äºå†²çªè€Œè¢«é“¾æ¥åœ¨åŒä¸€ç´¢å¼•ä½ä¸Šçš„ç»“ç‚¹, è¿ç§»åˆ°æ–°è¡¨å, å¯èƒ½ä¼šæ•£å¸ƒåœ¨å¤šä¸ªæ–°è¡¨ç´¢å¼•ä¸­å».
    6. å½“è¿ç§»å®Œæˆå, ht[0]æŒ‡å‘çš„æ—§è¡¨ä¼šè¢«é‡Šæ”¾, ä¹‹åä¼šå°†æ–°è¡¨çš„æŒæœ‰æƒè½¬äº¤ç»™ht[0], å†é‡ç½®ht[1]æŒ‡å‘NULL
- è¿™ç§å¹³æ»‘æ‰©å®¹çš„ä¼˜ç‚¹æœ‰ä¸¤ä¸ª:

    1. å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, æ‰€æœ‰ç»“ç‚¹çš„å®é™…æ•°æ®, å³dict->ht[0]->table[rehashindex]->kä¸dict->ht[0]->table[rehashindex]->våˆ†åˆ«æŒ‡å‘çš„å®é™…æ•°æ®, å†…å­˜åœ°å€éƒ½ä¸ä¼šå˜åŒ–. æ²¡æœ‰å‘ç”Ÿé”®æ•°æ®ä¸å€¼æ•°æ®çš„æ‹·è´æˆ–ç§»åŠ¨, æ‰©å®¹æ•´ä¸ªè¿‡ç¨‹ä»…æ˜¯å„ç§æŒ‡é’ˆçš„æ“ä½œ. é€Ÿåº¦éå¸¸å¿«
    2. æ‰©å®¹æ“ä½œæ˜¯æ­¥è¿›å¼çš„, è¿™ä¿è¯ä»»ä½•ä¸€æ¬¡æ’å…¥æ“ä½œéƒ½æ˜¯é¡ºç•…çš„, dictçš„ä½¿ç”¨è€…æ˜¯æ— æ„ŸçŸ¥çš„. è‹¥æ‰©å®¹æ˜¯ä¸€æ¬¡æ€§çš„, å½“æ–°æ—§bucketå®¹é‡ç‰¹åˆ«å¤§æ—¶, è¿ç§»æ‰€æœ‰ç»“ç‚¹å¿…ç„¶ä¼šå¯¼è‡´è€—æ—¶é™¡å¢.

é™¤äº†å­—å…¸æœ¬èº«çš„å®ç°å¤–, å…¶ä¸­è¿˜é¡ºå¸¦å®ç°äº†ä¸€ä¸ªè¿­ä»£å™¨, è¿™ä¸ªè¿­ä»£å™¨ä¸­æœ‰å­—æ®µsafeä»¥æ ‡ç¤ºè¯¥è¿­ä»£å™¨æ˜¯"å®‰å…¨è¿­ä»£å™¨"è¿˜æ˜¯"éå®‰å…¨è¿­ä»£å™¨", æ‰€è°“çš„å®‰å…¨ä¸å¦, æŒ‡æ˜¯çš„è¿™ç§åœºæ™¯:
è®¾æƒ³åœ¨è¿è¡Œè¿­ä»£å™¨çš„è¿‡ç¨‹ä¸­, å­—å…¸æ­£å¤„äºå¹³æ»‘æ‰©å®¹çš„è¿‡ç¨‹ä¸­. åœ¨å¹³æ»‘æ‰©å®¹çš„è¿‡ç¨‹ä¸­æ—¶, æ—§è¡¨ä¸€ä¸ªç´¢å¼•ä½ä¸Šçš„, ç”±å†²çªè€Œé“¾èµ·æ¥çš„å¤šä¸ªç»“ç‚¹, è¿ç§»åˆ°æ–°è¡¨å, å¯èƒ½ä¼šæ•£å¸ƒåˆ°æ–°è¡¨çš„å¤šä¸ªç´¢å¼•ä½ä¸Š. ä¸”æ–°çš„ç´¢å¼•ä½çš„å€¼å¯èƒ½æ¯”æ—§çš„ç´¢å¼•ä½è¦ä½.

éå†æ“ä½œçš„é‡ç‚¹æ˜¯, ä¿è¯åœ¨è¿­ä»£å™¨éå†æ“ä½œå¼€å§‹æ—¶, å­—å…¸ä¸­æŒæœ‰çš„æ‰€æœ‰ç»“ç‚¹, éƒ½ä¼šè¢«éå†åˆ°. è€Œè‹¥åœ¨éå†è¿‡ç¨‹ä¸­, ä¸€ä¸ªæœªéå†çš„ç»“ç‚¹, ä»æ—§è¡¨è¿ç§»åˆ°æ–°è¡¨å, ç´¢å¼•å€¼å‡å°äº†, é‚£ä¹ˆå°±å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªç»“ç‚¹åœ¨éå†è¿‡ç¨‹ä¸­è¢«é—æ¼.

æ‰€ä»¥, æ‰€è°“çš„"å®‰å…¨"è¿­ä»£å™¨, å…¶åœ¨å†…éƒ¨å®ç°æ—¶: åœ¨è¿­ä»£è¿‡ç¨‹ä¸­, è‹¥å­—å…¸æ­£å¤„äºå¹³æ»‘æ‰©å®¹è¿‡ç¨‹, åˆ™æš‚åœç»“ç‚¹è¿ç§», ç›´è‡³è¿­ä»£å™¨è¿è¡Œç»“æŸ. è¿™æ ·è™½ç„¶ä¸èƒ½ä¿è¯åœ¨è¿­ä»£è¿‡ç¨‹ä¸­æ’å…¥çš„ç»“ç‚¹ä¼šè¢«éå†åˆ°, ä½†è‡³å°‘ä¿è¯åœ¨è¿­ä»£èµ·å§‹æ—¶, å­—å…¸ä¸­æŒæœ‰çš„æ‰€æœ‰ç»“ç‚¹éƒ½ä¼šè¢«éå†åˆ°.

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆdictç»“æ„ä¸­æœ‰ä¸€ä¸ªiteratorså­—æ®µçš„åŸå› : è¯¥å­—æ®µè®°å½•äº†è¿è¡Œäºè¯¥å­—å…¸ä¸Šçš„å®‰å…¨è¿­ä»£å™¨çš„æ•°ç›®. è‹¥è¯¥æ•°ç›®ä¸ä¸º0, å­—å…¸æ˜¯ä¸ä¼šç»§ç»­è¿›è¡Œç»“ç‚¹è¿ç§»å¹³æ»‘æ‰©å®¹çš„.

ä¸‹é¢æ˜¯å­—å…¸çš„æ‰©å®¹æ“ä½œä¸­çš„æ ¸å¿ƒä»£ç , æˆ‘ä»¬ä»¥æ’å…¥æ“ä½œå¼•èµ·çš„æ‰©å®¹ä¸ºä¾‹:

**å…ˆæ˜¯æ’å…¥æ“ä½œçš„å¤–éƒ¨é€»è¾‘:**

1. å¦‚æœæ’å…¥æ—¶, å­—å…¸æ­£å¤„äºå¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, é‚£ä¹ˆæ— è®ºæœ¬æ¬¡æ’å…¥æ˜¯å¦æˆåŠŸ, å…ˆè¿ç§»ä¸€ä¸ªbucketç´¢å¼•ä¸­çš„ç»“ç‚¹è‡³æ–°è¡¨
2. åœ¨è®¡ç®—æ–°æ’å…¥ç»“ç‚¹é”®çš„bucketç´¢å¼•å€¼æ—¶, å†…éƒ¨ä¼šæ¢æµ‹å“ˆå¸Œè¡¨æ˜¯å¦éœ€è¦æ‰©å®¹(è‹¥å½“å‰ä¸åœ¨å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­)

```cgo
int dictAdd(dict *d, void *key, void *val)
{
    dictEntry *entry = dictAddRaw(d,key,NULL);          // è°ƒç”¨dictAddRaw

    if (!entry) return DICT_ERR;
    dictSetVal(d, entry, val);
    return DICT_OK;
}

dictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing)
{
    long index;
    dictEntry *entry;
    dictht *ht;

    if (dictIsRehashing(d)) _dictRehashStep(d); // è‹¥åœ¨å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, å…ˆæ­¥è¿›è¿ç§»ä¸€ä¸ªbucketç´¢å¼•

    /* Get the index of the new element, or -1 if
     * the element already exists. */

    // åœ¨è®¡ç®—é”®åœ¨bucketä¸­çš„ç´¢å¼•å€¼æ—¶, å†…éƒ¨ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹
    if ((index = _dictKeyIndex(d, key, dictHashKey(d,key), existing)) == -1)
        return NULL;

    /* Allocate the memory and store the new entry.
     * Insert the element in top, with the assumption that in a database
     * system it is more likely that recently added entries are accessed
     * more frequently. */
    ht = dictIsRehashing(d) ? &d->ht[1] : &d->ht[0];
    entry = zmalloc(sizeof(*entry));
    entry->next = ht->table[index];
    ht->table[index] = entry;
    ht->used++;

    /* Set the hash entry fields. */
    dictSetKey(d, entry, key);
    return entry;
}

```

ä¸‹é¢æ˜¯è®¡ç®—bucketç´¢å¼•å€¼çš„å‡½æ•°, å†…éƒ¨ä¼šæ¢æµ‹è¯¥å“ˆå¸Œè¡¨æ˜¯å¦éœ€è¦æ‰©å®¹, å¦‚æœéœ€è¦æ‰©å®¹(ç»“ç‚¹æ•°ç›®ä¸bucketæ•°ç»„é•¿åº¦æ¯”ä¾‹è¾¾åˆ°1:1), å°±ä½¿å­—å…¸è¿›å…¥å¹³æ»‘æ‰©å®¹è¿‡ç¨‹:

```cgo
static long _dictKeyIndex(dict *d, const void *key, uint64_t hash, dictEntry **existing)
{
    unsigned long idx, table;
    dictEntry *he;
    if (existing) *existing = NULL;

    /* Expand the hash table if needed */
    if (_dictExpandIfNeeded(d) == DICT_ERR) // æ¢æµ‹æ˜¯å¦éœ€è¦æ‰©å®¹, å¦‚æœéœ€è¦, åˆ™å¼€å§‹æ‰©å®¹
        return -1;
    for (table = 0; table <= 1; table++) {
        idx = hash & d->ht[table].sizemask;
        /* Search if this slot does not already contain the given key */
        he = d->ht[table].table[idx];
        while(he) {
            if (key==he->key || dictCompareKeys(d, key, he->key)) {
                if (existing) *existing = he;
                return -1;
            }
            he = he->next;
        }
        if (!dictIsRehashing(d)) break;
    }
    return idx;
}

/* Expand the hash table if needed */
static int _dictExpandIfNeeded(dict *d)
{
    /* Incremental rehashing already in progress. Return. */
    if (dictIsRehashing(d)) return DICT_OK; // å¦‚æœæ­£åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­, åˆ™ä»€ä¹ˆä¹Ÿä¸åš

    /* If the hash table is empty expand it to the initial size. */
    // è‹¥å­—å…¸ä¸­æœ¬æ— å…ƒç´ , åˆ™åˆå§‹åŒ–å­—å…¸, åˆå§‹åŒ–æ—¶çš„bucketæ•°ç»„é•¿åº¦ä¸º4
    if (d->ht[0].size == 0) return dictExpand(d, DICT_HT_INITIAL_SIZE);

    /* If we reached the 1:1 ratio, and we are allowed to resize the hash
     * table (global setting) or we should avoid it but the ratio between
     * elements/buckets is over the "safe" threshold, we resize doubling
     * the number of buckets. */
    // è‹¥å­—å…¸ä¸­å…ƒç´ çš„ä¸ªæ•°ä¸bucketæ•°ç»„é•¿åº¦æ¯”å€¼å¤§äº1:1æ—¶, åˆ™è°ƒç”¨dictExpandè¿›å…¥å¹³æ»‘æ‰©å®¹çŠ¶æ€
    if (d->ht[0].used >= d->ht[0].size &&
        (dict_can_resize ||
         d->ht[0].used/d->ht[0].size > dict_force_resize_ratio))
    {
        return dictExpand(d, d->ht[0].used*2);
    }
    return DICT_OK;
}

int dictExpand(dict *d, unsigned long size)
{
    dictht n; /* the new hash table */  // æ–°å»ºä¸€ä¸ªdicthtç»“æ„
    unsigned long realsize = _dictNextPower(size);  

    /* the size is invalid if it is smaller than the number of
     * elements already inside the hash table */
    if (dictIsRehashing(d) || d->ht[0].used > size)
        return DICT_ERR;

    /* Rehashing to the same table size is not useful. */
    if (realsize == d->ht[0].size) return DICT_ERR;

    /* Allocate the new hash table and initialize all pointers to NULL */
    n.size = realsize;
    n.sizemask = realsize-1;
    n.table = zcalloc(realsize*sizeof(dictEntry*));// åˆå§‹åŒ–dicthtä¸‹çš„table, å³bucketæ•°ç»„
    n.used = 0;

    /* Is this the first initialization? If so it's not really a rehashing
     * we just set the first hash table so that it can accept keys. */
    // è‹¥æ˜¯æ–°å­—å…¸åˆå§‹åŒ–, ç›´æ¥æŠŠdicthtç»“æ„æŒ‚åœ¨ht[0]ä¸­
    if (d->ht[0].table == NULL) {
        d->ht[0] = n;
        return DICT_OK;
    }

    // å¦åˆ™, æŠŠæ–°dicthtç»“æ„æŒ‚åœ¨ht[1]ä¸­, å¹¶å¼€å¯å¹³æ»‘æ‰©å®¹(ç½®rehashidxä¸º0, å­—å…¸å¤„äºéæ‰©å®¹çŠ¶æ€æ—¶, è¯¥å­—æ®µå€¼ä¸º-1)
    /* Prepare a second hash table for incremental rehashing */
    d->ht[1] = n;
    d->rehashidx = 0;
    return DICT_OK;
}
```

ä¸‹é¢æ˜¯å¹³æ»‘æ‰©å®¹çš„å®ç°:

```cgo
static void _dictRehashStep(dict *d) {
    // è‹¥å­—å…¸ä¸Šè¿˜è¿è¡Œç€å®‰å…¨è¿­ä»£å™¨, åˆ™ä¸è¿ç§»ç»“ç‚¹
    // å¦åˆ™æ¯æ¬¡è¿ç§»ä¸€ä¸ªæ—§bucketç´¢å¼•ä¸Šçš„æ‰€æœ‰ç»“ç‚¹
    if (d->iterators == 0) dictRehash(d,1); 
}

int dictRehash(dict *d, int n) {
    int empty_visits = n*10; /* Max number of empty buckets to visit. */
    if (!dictIsRehashing(d)) return 0;

    while(n-- && d->ht[0].used != 0) {
        dictEntry *de, *nextde;

        /* Note that rehashidx can't overflow as we are sure there are more
         * elements because ht[0].used != 0 */
        assert(d->ht[0].size > (unsigned long)d->rehashidx);
        // åœ¨æ—§bucketä¸­, æ‰¾åˆ°ä¸‹ä¸€ä¸ªéç©ºçš„ç´¢å¼•ä½
        while(d->ht[0].table[d->rehashidx] == NULL) {
            d->rehashidx++;
            if (--empty_visits == 0) return 1;
        }
        // å–å‡ºè¯¥ç´¢å¼•ä½ä¸Šçš„ç»“ç‚¹é“¾è¡¨
        de = d->ht[0].table[d->rehashidx];
        /* Move all the keys in this bucket from the old to the new hash HT */
        // æŠŠæ‰€æœ‰ç»“ç‚¹è¿ç§»åˆ°æ–°bucketä¸­å»
        while(de) {
            uint64_t h;

            nextde = de->next;
            /* Get the index in the new hash table */
            h = dictHashKey(d, de->key) & d->ht[1].sizemask;
            de->next = d->ht[1].table[h];
            d->ht[1].table[h] = de;
            d->ht[0].used--;
            d->ht[1].used++;
            de = nextde;
        }
        d->ht[0].table[d->rehashidx] = NULL;
        d->rehashidx++;
    }

    /* Check if we already rehashed the whole table... */
    // æ£€æŸ¥æ˜¯å¦æ—§è¡¨ä¸­çš„æ‰€æœ‰ç»“ç‚¹éƒ½è¢«è¿ç§»åˆ°äº†æ–°è¡¨
    // å¦‚æœæ˜¯, åˆ™ç½®å…ˆé‡Šæ”¾åŸæ—§bucketæ•°ç»„, å†ç½®ht[1]ä¸ºht[0]
    // æœ€åå†ç½®rehashidx=-1, ä»¥ç¤ºå­—å…¸ä¸å¤„äºå¹³æ»‘æ‰©å®¹çŠ¶æ€
    if (d->ht[0].used == 0) {
        zfree(d->ht[0].table);
        d->ht[0] = d->ht[1];
        _dictReset(&d->ht[1]);
        d->rehashidx = -1;
        return 0;
    }

    /* More to rehash... */
    return 1;
}
```

**æ€»ç»“:**

å­—å…¸çš„å®ç°å¾ˆå¤æ‚, ä¸»è¦æ˜¯å®ç°äº†å¹³æ»‘æ‰©å®¹é€»è¾‘
ç”¨æˆ·æ•°æ®å‡æ˜¯ä»¥æŒ‡é’ˆå½¢å¼é—´æ¥ç”±dictEntryç»“æ„æŒæœ‰, æ•…åœ¨å¹³æ»‘æ‰©å®¹è¿‡ç¨‹ä¸­, ä¸æ¶‰åŠç”¨æˆ·æ•°æ®çš„æ‹·è´
æœ‰å®‰å…¨è¿­ä»£å™¨å¯ç”¨, å®‰å…¨è¿­ä»£å™¨ä¿è¯, åœ¨è¿­ä»£èµ·å§‹æ—¶, å­—å…¸ä¸­çš„æ‰€æœ‰ç»“ç‚¹, éƒ½ä¼šè¢«è¿­ä»£åˆ°, å³ä½¿åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å­—å…¸æœ‰æ’å…¥æ“ä½œ
å­—å…¸å†…éƒ¨ä½¿ç”¨çš„é»˜è®¤æ•£åˆ—å‡½æ•°å…¶å®ä¹Ÿéå¸¸æœ‰è®²ç©¶, ä¸è¿‡é™äºç¯‡å¹…, è¿™é‡Œä¸å±•å¼€è®². å¹¶ä¸”å­—å…¸çš„å®ç°ç»™äº†ä½¿ç”¨è€…éå¸¸å¤§çš„çµæ´»æ€§(dictTypeç»“æ„ä¸dict.privdataå­—æ®µ), å¯¹äºä¸€äº›ç‰¹å®šåœºåˆä½¿ç”¨çš„é”®æ•°æ®, ç”¨æˆ·å¯ä»¥è‡ªè¡Œé€‰æ‹©æ›´é«˜æ•ˆæ›´ç‰¹å®šåŒ–çš„æ•£åˆ—å‡½æ•°

### 2.4 zskiplist

zskiplistæ˜¯Rediså®ç°çš„ä¸€ç§ç‰¹æ®Šçš„è·³è·ƒè¡¨. è·³è·ƒè¡¨æ˜¯ä¸€ç§åŸºäºçº¿æ€§è¡¨å®ç°ç®€å•çš„æœç´¢ç»“æ„, å…¶æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯: å®ç°ç®€å•, æ€§èƒ½èƒ½é€¼è¿‘å„ç§æœç´¢æ ‘ç»“æ„. è¡€ç»Ÿçº¯æ­£çš„è·³è·ƒè¡¨çš„ä»‹ç»åœ¨ç»´åŸºç™¾ç§‘ä¸­å³å¯æŸ¥é˜…. åœ¨Redisä¸­, åœ¨åŸç‰ˆè·³è·ƒè¡¨çš„åŸºç¡€ä¸Š, è¿›è¡Œäº†ä¸€äº›å°æ”¹åŠ¨, å³æ˜¯ç°åœ¨è¦ä»‹ç»çš„zskiplistç»“æ„.

å…¶å®šä¹‰åœ¨src/server.hä¸­, å¦‚ä¸‹:

```cgo
/* ZSETs use a specialized version of Skiplists */
typedef struct zskiplistNode {
    sds ele;
    double score;
    struct zskiplistNode *backward;
    struct zskiplistLevel {
        struct zskiplistNode *forward;
        unsigned int span;
    } level[];
} zskiplistNode;

typedef struct zskiplist {
    struct zskiplistNode *header, *tail;
    unsigned long length;
    int level;
} zskiplist;
```

å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾:

![](../images/668722-20180910184047816-693646977.png)

zskiplistçš„æ ¸å¿ƒè®¾è®¡è¦ç‚¹ä¸º:

1. å¤´ç»“ç‚¹ä¸æŒæœ‰ä»»ä½•æ•°æ®, ä¸”å…¶level[]çš„é•¿åº¦ä¸º32
2. æ¯ä¸ªç»“ç‚¹, é™¤äº†æŒæœ‰æ•°æ®çš„eleå­—æ®µ, è¿˜æœ‰ä¸€ä¸ªå­—æ®µscore, å…¶æ ‡ç¤ºç€ç»“ç‚¹çš„å¾—åˆ†, ç»“ç‚¹ä¹‹é—´å‡­å€Ÿå¾—åˆ†æ¥åˆ¤æ–­å…ˆåé¡ºåº, è·³è·ƒè¡¨ä¸­çš„ç»“ç‚¹æŒ‰ç»“ç‚¹çš„å¾—åˆ†å‡åºæ’åˆ—.
3. æ¯ä¸ªç»“ç‚¹æŒæœ‰ä¸€ä¸ªbackwardæŒ‡é’ˆ, è¿™æ˜¯åŸç‰ˆè·³è·ƒè¡¨ä¸­æ‰€æ²¡æœ‰çš„. è¯¥æŒ‡é’ˆæŒ‡å‘ç»“ç‚¹çš„å‰ä¸€ä¸ªç´§é‚»ç»“ç‚¹.
4. æ¯ä¸ªç»“ç‚¹ä¸­æœ€å¤šæŒæœ‰32ä¸ªzskiplistLevelç»“æ„. å®é™…æ•°é‡åœ¨ç»“ç‚¹åˆ›å»ºæ—¶, æŒ‰å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆ(ä¸è¶…è¿‡32). æ¯ä¸ªzskiplistLevelä¸­æœ‰ä¸¤ä¸ªå­—æ®µ.
5. forwardå­—æ®µæŒ‡å‘æ¯”è‡ªå·±å¾—åˆ†é«˜çš„æŸä¸ªç»“ç‚¹(ä¸ä¸€å®šæ˜¯ç´§é‚»çš„), å¹¶ä¸”, è‹¥å½“å‰zskiplistLevelå®ä¾‹åœ¨level[]ä¸­çš„ç´¢å¼•ä¸ºX, åˆ™å…¶forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, å…¶level[]å­—æ®µçš„å®¹é‡è‡³å°‘æ˜¯X+1. è¿™ä¹Ÿæ˜¯ä¸Šå›¾ä¸­, ä¸ºä»€ä¹ˆforwardæŒ‡é’ˆæ€»æ˜¯ç”»çš„æ°´å¹³çš„åŸå› .
6. spanå­—æ®µä»£è¡¨forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, è·ç¦»å½“å‰ç»“ç‚¹çš„è·ç¦». ç´§é‚»çš„ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´çš„è·ç¦»å®šä¹‰ä¸º1.
7. zskiplistä¸­æŒæœ‰å­—æ®µlevel, ç”¨ä»¥è®°å½•æ‰€æœ‰ç»“ç‚¹(é™¤è¿‡å¤´ç»“ç‚¹å¤–), level[]æ•°ç»„æœ€é•¿çš„é•¿åº¦.

è·³è·ƒè¡¨ä¸»è¦ç”¨äº, åœ¨ç»™å®šä¸€ä¸ªåˆ†å€¼çš„æƒ…å†µä¸‹, æŸ¥æ‰¾ä¸è¯¥åˆ†å€¼æœ€æ¥è¿‘çš„ç»“ç‚¹. æœç´¢æ—¶, ä¼ªä»£ç å¦‚ä¸‹:

```cgo
int level = zskiplist->level - 1;
zskiplistNode p = zskiplist->head;

while(1 && p)
{
    zskiplistNode q = (p->level)[level]->forward:
    if(q->score > åˆ†å€¼)
    {
        if(level > 0)
        {
            level--;
        }
        else
        {
            return :
                qä¸ºæ•´ä¸ªè·³è·ƒè¡¨ä¸­, åˆ†å€¼å¤§äºæŒ‡å®šåˆ†å€¼çš„ç¬¬ä¸€ä¸ªç»“ç‚¹
                q->backwardä¸ºæ•´ä¸ªè·³è·ƒè¡¨ä¸­, åˆ†å€¼å°äºæˆ–ç­‰äºæŒ‡å®šåˆ†å€¼çš„æœ€åä¸€ä¸ªç»“ç‚¹
        }
    }
    else
    {
        p = q;
    }
}
```

è·³è·ƒè¡¨çš„å®ç°æ¯”è¾ƒç®€å•, æœ€å¤æ‚çš„æ“ä½œå³æ˜¯æ’å…¥ä¸åˆ é™¤ç»“ç‚¹, éœ€è¦ä»”ç»†å¤„ç†é‚»è¿‘ç»“ç‚¹çš„æ‰€æœ‰level[]ä¸­çš„æ‰€æœ‰zskiplistLevelç»“ç‚¹ä¸­çš„forwardä¸spançš„å€¼çš„å˜æ›´.

å¦å¤–, å…³äºæ–°åˆ›å»ºçš„ç»“ç‚¹, å…¶`level[]`æ•°ç»„é•¿åº¦çš„éšæœºç®—æ³•, åœ¨æ¥å£zslInsertçš„å®ç°ä¸­, æ ¸å¿ƒä»£ç ç‰‡æ–­å¦‚ä¸‹:


```cgo
zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) {
    //...

    level = zslRandomLevel();   // éšæœºç”Ÿæˆæ–°ç»“ç‚¹çš„, level[]æ•°ç»„çš„é•¿åº¦
        if (level > zsl->level) {   
        // è‹¥ç”Ÿæˆçš„æ–°ç»“ç‚¹çš„level[]æ•°ç»„çš„é•¿åº¦æ¯”å½“å‰è¡¨ä¸­æ‰€æœ‰ç»“ç‚¹çš„level[]çš„é•¿åº¦éƒ½å¤§
        // é‚£ä¹ˆå¤´ç»“ç‚¹ä¸­éœ€è¦æ–°å¢å‡ ä¸ªæŒ‡å‘è¯¥ç»“ç‚¹çš„æŒ‡é’ˆ
        // å¹¶åˆ·æ–°ziplistä¸­çš„levelå­—æ®µ
        for (i = zsl->level; i < level; i++) {
            rank[i] = 0;
            update[i] = zsl->header;
            update[i]->level[i].span = zsl->length;
        }
        zsl->level = level;
    }
    x = zslCreateNode(level,score,ele); // åˆ›å»ºæ–°ç»“ç‚¹
    //... æ‰§è¡Œæ’å…¥æ“ä½œ
}

// æŒ‰å¹‚æ¬¡å®šå¾‹ç”Ÿæˆå°äº32çš„éšæœºæ•°çš„å‡½æ•°
// å® ZSKIPLIST_MAXLEVEL çš„å®šä¹‰ä¸º32, å® ZSKIPLIST_P è¢«è®¾å®šä¸º 0.25
// å³ 
//      level == 1çš„æ¦‚ç‡ä¸º 75%
//      level == 2çš„æ¦‚ç‡ä¸º 75% * 25%
//      level == 3çš„æ¦‚ç‡ä¸º 75% * 25% * 25%
//      ...
//      level == 31çš„æ¦‚ç‡ä¸º 0.75 * 0.25^30
//      è€Œ
//      level == 32çš„æ¦‚ç‡ä¸º 0.75 * sum(i = 31 ~ +INF){ 0.25^i }
int zslRandomLevel(void) {
    int level = 1;
    while ((random()&0xFFFF) < (ZSKIPLIST_P * 0xFFFF))
        level += 1;
    return (level<ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
}
```

### 2.5 intset

è¿™æ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨åœ¨åºçš„æ•´æ•°çš„æ•°æ®ç»“æ„, ä¹Ÿåº•å±‚æ•°æ®ç»“æ„ä¸­æœ€ç®€å•çš„ä¸€ä¸ª, å…¶å®šä¹‰ä¸å®ç°åœ¨src/intest.hä¸src/intset.cä¸­, å…³é”®å®šä¹‰å¦‚ä¸‹:

```cgo
typedef struct intset {
    uint32_t encoding;
    uint32_t length;
    int8_t contents[];
} intset;

#define INTSET_ENC_INT16 (sizeof(int16_t))
#define INTSET_ENC_INT32 (sizeof(int32_t))
#define INTSET_ENC_INT64 (sizeof(int64_t))
```

insetç»“æ„ä¸­çš„encodingçš„å–å€¼æœ‰ä¸‰ä¸ª, åˆ†åˆ«æ˜¯å®INTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64. lengthä»£è¡¨å…¶ä¸­å­˜å‚¨çš„æ•´æ•°çš„ä¸ªæ•°, contentsæŒ‡å‘å®é™…å­˜å‚¨æ•°å€¼çš„è¿ç»­å†…å­˜åŒºåŸŸ. å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º:

![](../images/668722-20180910184108826-1909275147.png)


- intsetä¸­å„å­—æ®µ, åŒ…æ‹¬contentsä¸­å­˜å‚¨çš„æ•°å€¼, éƒ½æ˜¯ä»¥ä¸»æœºåº(å°ç«¯å­—èŠ‚åº)å­˜å‚¨çš„. è¿™æ„å‘³ç€Redisè‹¥è¿è¡Œåœ¨PPCè¿™æ ·çš„å¤§ç«¯å­—èŠ‚åºçš„æœºå™¨ä¸Šæ—¶, å­˜å–æ•°æ®éƒ½ä¼šæœ‰é¢å¤–çš„å­—èŠ‚åºè½¬æ¢å¼€é”€
- å½“encoding == INTSET_ENC_INT16æ—¶, contentsä¸­ä»¥int16_tçš„å½¢å¼å­˜å‚¨ç€æ•°å€¼. ç±»ä¼¼çš„, å½“encoding == INTSET_ENC_INT32æ—¶, contentsä¸­ä»¥int32_tçš„å½¢å¼å­˜å‚¨ç€æ•°å€¼.
- ä½†å‡¡æœ‰ä¸€ä¸ªæ•°å€¼å…ƒç´ çš„å€¼è¶…è¿‡äº†int32_tçš„å–å€¼èŒƒå›´, æ•´ä¸ªintsetéƒ½è¦è¿›è¡Œå‡çº§, å³æ‰€æœ‰çš„æ•°å€¼éƒ½éœ€è¦ä»¥int64_tçš„å½¢å¼å­˜å‚¨. æ˜¾ç„¶å‡çº§çš„å¼€é”€æ˜¯å¾ˆå¤§çš„.
- intsetä¸­çš„æ•°å€¼æ˜¯ä»¥å‡åºæ’åˆ—å­˜å‚¨çš„, æ’å…¥ä¸åˆ é™¤çš„å¤æ‚åº¦å‡ä¸ºO(n). æŸ¥æ‰¾ä½¿ç”¨äºŒåˆ†æ³•, å¤æ‚åº¦ä¸ºO(log_2(n))
- intsetçš„ä»£ç å®ç°ä¸­, ä¸é¢„ç•™ç©ºé—´, å³æ¯ä¸€æ¬¡æ’å…¥æ“ä½œéƒ½ä¼šè°ƒç”¨zreallocæ¥å£é‡æ–°åˆ†é…å†…å­˜. æ¯ä¸€æ¬¡åˆ é™¤ä¹Ÿä¼šè°ƒç”¨zreallocæ¥å£ç¼©å‡å ç”¨çš„å†…å­˜. çœæ˜¯çœäº†, ä½†å†…å­˜æ“ä½œçš„æ—¶é—´å¼€é”€ä¸Šå‡äº†.
- intsetçš„ç¼–ç æ–¹å¼ä¸€ç»å‡çº§, ä¸ä¼šå†é™çº§.

æ€»ä¹‹, intseté€‚åˆäºå¦‚ä¸‹æ•°æ®çš„å­˜å‚¨:

- æ‰€æœ‰æ•°æ®éƒ½ä½äºä¸€ä¸ªç¨³å®šçš„å–å€¼èŒƒå›´ä¸­. æ¯”å¦‚å‡ä½äºint16_tæˆ–int32_tçš„å–å€¼èŒƒå›´ä¸­
- æ•°æ®ç¨³å®š, æ’å…¥åˆ é™¤æ“ä½œä¸é¢‘ç¹. èƒ½æ¥å—O(lgn)çº§åˆ«çš„æŸ¥æ‰¾å¼€é”€

### 2.6 ziplist

ziplistæ˜¯Redisåº•å±‚æ•°æ®ç»“æ„ä¸­, æœ€è‹Ÿçš„ä¸€ä¸ªç»“æ„. å®ƒçš„è®¾è®¡å®—æ—¨å°±æ˜¯: çœå†…å­˜, ä»ç‰™ç¼é‡Œçœå†…å­˜. è®¾è®¡æ€è·¯å’ŒTLVä¸€è‡´, ä½†ä¸ºäº†ä»ç‰™ç¼é‡ŒèŠ‚çœå†…å­˜, åšäº†å¾ˆå¤šé¢å¤–å·¥ä½œ.

ziplistçš„å†…å­˜å¸ƒå±€ä¸intsetä¸€æ ·: å°±æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´. ä½†åŒºåŸŸåˆ’åˆ†æ¯”è¾ƒå¤æ‚, æ¦‚è§ˆå¦‚ä¸‹å›¾:


![](../images/668722-20180910184121575-550443104.png)

- å’Œintsetä¸€æ ·, ziplistä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯ä»¥å°ç«¯åºå­˜å‚¨çš„
- zlbyteså­—æ®µçš„ç±»å‹æ˜¯uint32_t, è¿™ä¸ªå­—æ®µä¸­å­˜å‚¨çš„æ˜¯æ•´ä¸ªziplistæ‰€å ç”¨çš„å†…å­˜çš„å­—èŠ‚æ•°
- zltailå­—æ®µçš„ç±»å‹æ˜¯uint32_t, å®ƒæŒ‡çš„æ˜¯ziplistä¸­æœ€åä¸€ä¸ªentryçš„åç§»é‡. ç”¨äºå¿«é€Ÿå®šä½æœ€åä¸€ä¸ªentry, ä»¥å¿«é€Ÿå®Œæˆpopç­‰æ“ä½œ
- zllenå­—æ®µçš„ç±»å‹æ˜¯uint16_t, å®ƒæŒ‡çš„æ˜¯æ•´ä¸ªziplitä¸­entryçš„æ•°é‡. è¿™ä¸ªå€¼åªå 16ä½, æ‰€ä»¥è›‹ç–¼çš„åœ°æ–¹å°±æ¥äº†: å¦‚æœziplistä¸­entryçš„æ•°ç›®å°äº65535, é‚£ä¹ˆè¯¥å­—æ®µä¸­å­˜å‚¨çš„å°±æ˜¯å®é™…entryçš„å€¼. è‹¥ç­‰äºæˆ–è¶…è¿‡65535, é‚£ä¹ˆè¯¥å­—æ®µçš„å€¼å›ºå®šä¸º65535, ä½†å®é™…æ•°é‡éœ€è¦ä¸€ä¸ªä¸ªentryçš„å»éå†æ‰€æœ‰entryæ‰èƒ½å¾—åˆ°.
- zlendæ˜¯ä¸€ä¸ªç»ˆæ­¢å­—èŠ‚, å…¶å€¼ä¸ºå…¨F, å³0xff. ziplistä¿è¯ä»»ä½•æƒ…å†µä¸‹, ä¸€ä¸ªentryçš„é¦–å­—èŠ‚éƒ½ä¸ä¼šæ˜¯255

åœ¨ç”»å›¾å±•ç¤ºentryçš„å†…å­˜å¸ƒå±€ä¹‹å‰, å…ˆè®²ä¸€ä¸‹entryä¸­éƒ½å­˜å‚¨äº†å“ªäº›ä¿¡æ¯:

- æ¯ä¸ªentryä¸­å­˜å‚¨äº†å®ƒå‰ä¸€ä¸ªentryæ‰€å ç”¨çš„å­—èŠ‚æ•°. è¿™æ ·æ”¯æŒzipliståå‘éå†.
- æ¯ä¸ªentryç”¨å•ç‹¬çš„ä¸€å—åŒºåŸŸ, å­˜å‚¨ç€å½“å‰ç»“ç‚¹çš„ç±»å‹: æ‰€è°“çš„ç±»å‹, åŒ…æ‹¬å½“å‰ç»“ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯ä»€ä¹ˆ(äºŒè¿›åˆ¶, è¿˜æ˜¯æ•°å€¼), å¦‚ä½•ç¼–ç (å¦‚æœæ˜¯æ•°å€¼, æ•°å€¼å¦‚ä½•å­˜å‚¨, å¦‚æœæ˜¯äºŒè¿›åˆ¶æ•°æ®, äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦)
- æœ€åå°±æ˜¯çœŸå®çš„æ•°æ®äº†

entryçš„å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:

![](../images/668722-20180910184134043-2011419560.png)

`prevlen`å³æ˜¯"å‰ä¸€ä¸ªentryæ‰€å ç”¨çš„å­—èŠ‚æ•°", å®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå˜é•¿å­—æ®µ, è§„çº¦å¦‚ä¸‹:

- è‹¥å‰ä¸€ä¸ªentryå ç”¨çš„å­—èŠ‚æ•°å°äº 254, åˆ™prevlenå­—æ®µå ä¸€å­—èŠ‚
- è‹¥å‰ä¸€ä¸ªentryå ç”¨çš„å­—èŠ‚æ•°ç­‰äºæˆ–å¤§äº 254, åˆ™prevlenå­—æ®µå äº”å­—èŠ‚: ç¬¬ä¸€ä¸ªå­—èŠ‚å€¼ä¸º 254, å³0xfe, å¦å¤–å››ä¸ªå­—èŠ‚, ä»¥uint32_tå­˜å‚¨ç€å€¼.

`encoding`å­—æ®µçš„è§„çº¦å°±å¤æ‚äº†è®¸å¤š

- è‹¥æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®, ä¸”äºŒè¿›åˆ¶æ•°æ®é•¿åº¦å°äº64å­—èŠ‚(ä¸åŒ…æ‹¬64), é‚£ä¹ˆencodingå ä¸€å­—èŠ‚. åœ¨è¿™ä¸€å­—èŠ‚ä¸­, é«˜ä¸¤ä½å€¼å›ºå®šä¸º0, ä½å…­ä½å€¼ä»¥æ— ç¬¦å·æ•´æ•°çš„å½¢å¼å­˜å‚¨ç€äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦. å³ 00xxxxxx, å…¶ä¸­ä½å…­ä½bitxxxxxxæ˜¯ç”¨äºŒè¿›åˆ¶ä¿å­˜çš„æ•°æ®é•¿åº¦.
- è‹¥æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®, ä¸”äºŒè¿›åˆ¶æ•°æ®é•¿åº¦å¤§äºæˆ–ç­‰äº64å­—èŠ‚, ä½†å°äº16384(ä¸åŒ…æ‹¬16384)å­—èŠ‚, é‚£ä¹ˆencodingå ç”¨ä¸¤ä¸ªå­—èŠ‚. åœ¨è¿™ä¸¤ä¸ªå­—èŠ‚16ä½ä¸­, ç¬¬ä¸€ä¸ªå­—èŠ‚çš„é«˜ä¸¤ä½å›ºå®šä¸º01, å‰©ä½™çš„14ä¸ªä½, ä»¥å°ç«¯åºæ— ç¬¦å·æ•´æ•°çš„å½¢å¼å­˜å‚¨ç€äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦, å³ 01xxxxxx, yyyyyyyy, å…¶ä¸­yyyyyyyyæ˜¯é«˜å…«ä½, xxxxxxæ˜¯ä½å…­ä½.
- è‹¥æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®, ä¸”äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦å¤§äºæˆ–ç­‰äº16384å­—èŠ‚, ä½†å°äº2^32-1å­—èŠ‚, åˆ™encodingå ç”¨äº”ä¸ªå­—èŠ‚. ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å›ºå®šå€¼10000000, å‰©ä½™å››ä¸ªå­—èŠ‚, æŒ‰å°ç«¯åºuint32_tçš„å½¢å¼å­˜å‚¨ç€äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦. è¿™ä¹Ÿæ˜¯ziplistèƒ½å­˜å‚¨çš„äºŒè¿›åˆ¶æ•°æ®çš„æœ€å¤§é•¿åº¦, è¶…è¿‡2^32-1å­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®, ziplistæ— æ³•å­˜å‚¨.
- è‹¥æ•°æ®æ˜¯æ•´æ•°å€¼, åˆ™encodingå’Œdataçš„è§„çº¦å¦‚ä¸‹:
    1. é¦–å…ˆ, æ‰€æœ‰å­˜å‚¨æ•°å€¼çš„entry, å…¶encodingéƒ½ä»…å ç”¨ä¸€ä¸ªå­—èŠ‚. å¹¶ä¸”æœ€é«˜ä¸¤ä½å‡æ˜¯11
    2. è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[0, 12]ä¸­, åˆ™encodingå’ŒdataæŒ¤åœ¨åŒä¸€ä¸ªå­—èŠ‚ä¸­. å³ä¸º1111 0001~1111 1101, é«˜å››ä½æ˜¯å›ºå®šå€¼, ä½å››ä½çš„å€¼ä»0001è‡³1101, åˆ†åˆ«ä»£è¡¨ 0 ~ 12è¿™åäº”ä¸ªæ•°å€¼
    3. è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-128, -1] [13, 127]ä¸­, åˆ™encoding == 0b 1111 1110. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„ä¸‹ä¸€ä¸ªå­—èŠ‚, ä»¥int8_tå½¢å¼ç¼–ç 
    4. è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-32768, -129] [128, 32767]ä¸­, åˆ™encoding == 0b 1100 0000. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åä¸¤ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºint16_tå½¢å¼ç¼–ç 
    5. è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-8388608, -32769] [32768, 8388607]ä¸­, åˆ™encoding == 0b 1111 0000. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åä¸‰ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºå­˜å‚¨, å ç”¨ä¸‰ä¸ªå­—èŠ‚.
    6. è‹¥æ•°å€¼å–å€¼èŒƒå›´ä½äº[-2^31, -8388609] [8388608, 2^31 - 1]ä¸­, åˆ™encoding == 0b 1101 0000. æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åå››ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºint32_tå½¢å¼ç¼–ç 
    7. è‹¥æ•°å€¼å–å€¼å‡ä¸åœ¨ä¸Šè¿°èŒƒå›´, ä½†ä½äºint64_tæ‰€èƒ½è¡¨è¾¾çš„èŒƒå›´å†…, åˆ™encoding == 0b 1110 0000, æ•°å€¼å­˜å‚¨åœ¨ç´§é‚»çš„åå…«ä¸ªå­—èŠ‚ä¸­, ä»¥å°ç«¯åºint64_tå½¢å¼ç¼–ç 

åœ¨å¤§è§„æ¨¡æ•°å€¼å­˜å‚¨ä¸­, ziplistå‡ ä¹ä¸æµªè´¹å†…å­˜ç©ºé—´, å…¶è‹Ÿçš„ç¨‹åºåˆ°è¾¾äº†å­—èŠ‚çº§åˆ«, ç”šè‡³å¯¹äº[0, 12]åŒºé—´çš„æ•°å€¼, è¿dataé‡Œçš„é‚£ä¸€ä¸ªå­—èŠ‚ä¹Ÿè¦çœä¸‹æ¥. æ˜¾ç„¶, ziplistæ˜¯ä¸€ç§ç‰¹åˆ«èŠ‚çœå†…å­˜çš„æ•°æ®ç»“æ„, ä½†å®ƒçš„ç¼ºç‚¹ä¹Ÿååˆ†æ˜æ˜¾:

- å’Œintsetä¸€æ ·, ziplistä¹Ÿä¸é¢„ç•™å†…å­˜ç©ºé—´, å¹¶ä¸”åœ¨ç§»é™¤ç»“ç‚¹å, ä¹Ÿæ˜¯ç«‹å³ç¼©å®¹, è¿™ä»£è¡¨æ¯æ¬¡å†™æ“ä½œéƒ½ä¼šè¿›è¡Œå†…å­˜åˆ†é…æ“ä½œ.
- ziplistæœ€è›‹ç–¼çš„ä¸€ä¸ªé—®é¢˜æ˜¯: ç»“ç‚¹å¦‚æœæ‰©å®¹, å¯¼è‡´ç»“ç‚¹å ç”¨çš„å†…å­˜å¢é•¿, å¹¶ä¸”è¶…è¿‡254å­—èŠ‚çš„è¯, å¯èƒ½ä¼šå¯¼è‡´é“¾å¼ååº”: å…¶åä¸€ä¸ªç»“ç‚¹çš„entry.prevlenéœ€è¦ä»ä¸€å­—èŠ‚æ‰©å®¹è‡³äº”å­—èŠ‚. æœ€åæƒ…å†µä¸‹, ç¬¬ä¸€ä¸ªç»“ç‚¹çš„æ‰©å®¹, ä¼šå¯¼è‡´æ•´ä¸ªziplistè¡¨ä¸­çš„åç»­æ‰€æœ‰ç»“ç‚¹çš„entry.prevlenå­—æ®µæ‰©å®¹. è™½ç„¶è¿™ä¸ªå†…å­˜é‡åˆ†é…çš„æ“ä½œä¾ç„¶åªä¼šå‘ç”Ÿä¸€æ¬¡, ä½†ä»£ç ä¸­çš„æ—¶é—´å¤æ‚åº¦æ˜¯o(N)çº§åˆ«, å› ä¸ºé“¾å¼æ‰©å®¹åªèƒ½ä¸€æ­¥ä¸€æ­¥çš„è®¡ç®—. ä½†è¿™ç§æƒ…å†µçš„æ¦‚ç‡ååˆ†çš„å°, ä¸€èˆ¬æƒ…å†µä¸‹é“¾å¼æ‰©å®¹èƒ½è¿é”åæ˜ äº”å…­æ¬¡å°±å¾ˆä¸å¹¸äº†. ä¹‹æ‰€ä»¥è¯´è¿™æ˜¯ä¸€ä¸ªè›‹ç–¼é—®é¢˜, æ˜¯å› ä¸º, è¿™æ ·çš„ååœºæ™¯ä¸‹, å…¶å®æ—¶é—´å¤æ‚åº¦å¹¶ä¸é«˜: ä¾æ¬¡è®¡ç®—æ¯ä¸ªentryæ–°çš„ç©ºé—´å ç”¨, ä¹Ÿå°±æ˜¯o(N), æ€»ä½“å ç”¨è®¡ç®—å‡ºæ¥å, åªæ‰§è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…, ä¸å¯¹åº”çš„memmoveæ“ä½œ, å°±å¯ä»¥äº†. è›‹ç–¼è¯´çš„æ˜¯: ä»£ç ç‰¹åˆ«éš¾å†™, éš¾è¯». ä¸‹é¢æ”¾ä¸€æ®µå¤„ç†æ’å…¥ç»“ç‚¹æ—¶å¤„ç†é“¾å¼ååº”çš„ä»£ç ç‰‡æ–­, å¤§å®¶è‡ªè¡Œæ„Ÿå—ä¸€ä¸‹:

```cgo
unsigned char *__ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) {
    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), reqlen;
    unsigned int prevlensize, prevlen = 0;
    size_t offset;
    int nextdiff = 0;
    unsigned char encoding = 0;
    long long value = 123456789; /* initialized to avoid warning. Using a value
                                    that is easy to see if for some reason
                                    we use it uninitialized. */
    zlentry tail;

    /* Find out prevlen for the entry that is inserted. */
    if (p[0] != ZIP_END) {
        ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);
    } else {
        unsigned char *ptail = ZIPLIST_ENTRY_TAIL(zl);
        if (ptail[0] != ZIP_END) {
            prevlen = zipRawEntryLength(ptail);
        }
    }

    /* See if the entry can be encoded */
    if (zipTryEncoding(s,slen,&value,&encoding)) {
        /* 'encoding' is set to the appropriate integer encoding */
        reqlen = zipIntSize(encoding);
    } else {
        /* 'encoding' is untouched, however zipStoreEntryEncoding will use the
         * string length to figure out how to encode it. */
        reqlen = slen;
    }
    /* We need space for both the length of the previous entry and
     * the length of the payload. */
    reqlen += zipStorePrevEntryLength(NULL,prevlen);
    reqlen += zipStoreEntryEncoding(NULL,encoding,slen);

    /* When the insert position is not equal to the tail, we need to
     * make sure that the next entry can hold this entry's length in
     * its prevlen field. */
    int forcelarge = 0;
    nextdiff = (p[0] != ZIP_END) ? zipPrevLenByteDiff(p,reqlen) : 0;
    if (nextdiff == -4 && reqlen < 4) {
        nextdiff = 0;
        forcelarge = 1;
    }

    /* Store offset because a realloc may change the address of zl. */
    offset = p-zl;
    zl = ziplistResize(zl,curlen+reqlen+nextdiff);
    p = zl+offset;

    /* Apply memory move when necessary and update tail offset. */
    if (p[0] != ZIP_END) {
        /* Subtract one because of the ZIP_END bytes */
        memmove(p+reqlen,p-nextdiff,curlen-offset-1+nextdiff);

        /* Encode this entry's raw length in the next entry. */
        if (forcelarge)
            zipStorePrevEntryLengthLarge(p+reqlen,reqlen);
        else
            zipStorePrevEntryLength(p+reqlen,reqlen);

        /* Update offset for tail */
        ZIPLIST_TAIL_OFFSET(zl) =
            intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+reqlen);

        /* When the tail contains more than one entry, we need to take
         * "nextdiff" in account as well. Otherwise, a change in the
         * size of prevlen doesn't have an effect on the *tail* offset. */
        zipEntry(p+reqlen, &tail);
        if (p[reqlen+tail.headersize+tail.len] != ZIP_END) {
            ZIPLIST_TAIL_OFFSET(zl) =
                intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff);
        }
    } else {
        /* This element will be the new tail. */
        ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(p-zl);
    }

    /* When nextdiff != 0, the raw length of the next entry has changed, so
     * we need to cascade the update throughout the ziplist */
    if (nextdiff != 0) {
        offset = p-zl;
        zl = __ziplistCascadeUpdate(zl,p+reqlen);
        p = zl+offset;
    }

    /* Write the entry */
    p += zipStorePrevEntryLength(p,prevlen);
    p += zipStoreEntryEncoding(p,encoding,slen);
    if (ZIP_IS_STR(encoding)) {
        memcpy(p,s,slen);
    } else {
        zipSaveInteger(p,value,encoding);
    }
    ZIPLIST_INCR_LENGTH(zl,1);
    return zl;
}

unsigned char *__ziplistCascadeUpdate(unsigned char *zl, unsigned char *p) {
    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;
    size_t offset, noffset, extra;
    unsigned char *np;
    zlentry cur, next;

    while (p[0] != ZIP_END) {
        zipEntry(p, &cur);
        rawlen = cur.headersize + cur.len;
        rawlensize = zipStorePrevEntryLength(NULL,rawlen);

        /* Abort if there is no next entry. */
        if (p[rawlen] == ZIP_END) break;
        zipEntry(p+rawlen, &next);

        /* Abort when "prevlen" has not changed. */
        if (next.prevrawlen == rawlen) break;

        if (next.prevrawlensize < rawlensize) {
            /* The "prevlen" field of "next" needs more bytes to hold
             * the raw length of "cur". */
            offset = p-zl;
            extra = rawlensize-next.prevrawlensize;
            zl = ziplistResize(zl,curlen+extra);
            p = zl+offset;

            /* Current pointer and offset for next element. */
            np = p+rawlen;
            noffset = np-zl;

            /* Update tail offset when next element is not the tail element. */
            if ((zl+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) {
                ZIPLIST_TAIL_OFFSET(zl) =
                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra);
            }

            /* Move the tail to the back. */
            memmove(np+rawlensize,
                np+next.prevrawlensize,
                curlen-noffset-next.prevrawlensize-1);
            zipStorePrevEntryLength(np,rawlen);

            /* Advance the cursor */
            p += rawlen;
            curlen += extra;
        } else {
            if (next.prevrawlensize > rawlensize) {
                /* This would result in shrinking, which we want to avoid.
                 * So, set "rawlen" in the available bytes. */
                zipStorePrevEntryLengthLarge(p+rawlen,rawlen);
            } else {
                zipStorePrevEntryLength(p+rawlen,rawlen);
            }

            /* Stop here, as the raw length of "next" has not changed. */
            break;
        }
    }
    return zl;
}
```

è¿™ç§ä»£ç çš„ç‰¹ç‚¹å°±æ˜¯: æœ€å¥½ç”±ä½œè€…å»ç»´æŠ¤, æœ€å¥½ä¸€æ¬¡æ€§å†™å¯¹. å› ä¸ºè¯»èµ·æ¥çœŸçš„è´¹åŠ², æ”¹èµ·æ¥ä¹Ÿå¾ˆè´¹åŠ².

### 2.7 quicklist

å¦‚æœè¯´ziplistæ˜¯æ•´ä¸ªRedisä¸­ä¸ºäº†èŠ‚çœå†…å­˜, è€Œå†™çš„æœ€è‹Ÿçš„æ•°æ®ç»“æ„, é‚£ä¹ˆç§°quicklistå°±æ˜¯åœ¨æœ€è‹Ÿçš„åŸºç¡€ä¸Š, å†è‹Ÿäº†ä¸€å±‚. è¿™ä¸ªç»“æ„æ˜¯Redisåœ¨3.2ç‰ˆæœ¬åæ–°åŠ çš„, åœ¨3.2ç‰ˆæœ¬ä¹‹å‰, æˆ‘ä»¬å¯ä»¥è®², dictæ˜¯æœ€å¤æ‚çš„åº•å±‚æ•°æ®ç»“æ„, ziplistæ˜¯æœ€è‹Ÿçš„åº•å±‚æ•°æ®ç»“æ„. åœ¨3.2ç‰ˆæœ¬ä¹‹å, è¿™ä¸¤ä¸ªè®°å½•è¢«åŒåŒåˆ·æ–°äº†.

è¿™æ˜¯ä¸€ç§, ä»¥ziplistä¸ºç»“ç‚¹çš„, åŒç«¯é“¾è¡¨ç»“æ„. å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, å¾®è§‚ä¸Š, é“¾è¡¨ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplist.

å®ƒçš„å®šä¹‰ä¸å®ç°åˆ†åˆ«åœ¨src/quicklist.hä¸src/quicklist.cä¸­, å…¶ä¸­å…³é”®å®šä¹‰å¦‚ä¸‹:

```cgo
/* Node, quicklist, and Iterator are the only data structures used currently. */

/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist.
 * We use bit fields keep the quicklistNode at 32 bytes.
 * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually < 32k).
 * encoding: 2 bits, RAW=1, LZF=2.
 * container: 2 bits, NONE=1, ZIPLIST=2.
 * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.
 * attempted_compress: 1 bit, boolean, used for verifying during testing.
 * extra: 12 bits, free for future use; pads out the remainder of 32 bits */
typedef struct quicklistNode {
    struct quicklistNode *prev;
    struct quicklistNode *next;
    unsigned char *zl;
    unsigned int sz;             /* ziplist size in bytes */
    unsigned int count : 16;     /* count of items in ziplist */
    unsigned int encoding : 2;   /* RAW==1 or LZF==2 */
    unsigned int container : 2;  /* NONE==1 or ZIPLIST==2 */
    unsigned int recompress : 1; /* was this node previous compressed? */
    unsigned int attempted_compress : 1; /* node can't compress; too small */
    unsigned int extra : 10; /* more bits to steal for future usage */
} quicklistNode;

/* quicklistLZF is a 4+N byte struct holding 'sz' followed by 'compressed'.
 * 'sz' is byte length of 'compressed' field.
 * 'compressed' is LZF data with total (compressed) length 'sz'
 * NOTE: uncompressed length is stored in quicklistNode->sz.
 * When quicklistNode->zl is compressed, node->zl points to a quicklistLZF */
typedef struct quicklistLZF {
    unsigned int sz; /* LZF size in bytes*/
    char compressed[];
} quicklistLZF;

/* quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.
 * 'count' is the number of total entries.
 * 'len' is the number of quicklist nodes.
 * 'compress' is: -1 if compression disabled, otherwise it's the number
 *                of quicklistNodes to leave uncompressed at ends of quicklist.
 * 'fill' is the user-requested (or default) fill factor. */
typedef struct quicklist {
    quicklistNode *head;
    quicklistNode *tail;
    unsigned long count;        /* total count of all entries in all ziplists */
    unsigned long len;          /* number of quicklistNodes */
    int fill : 16;              /* fill factor for individual nodes */
    unsigned int compress : 16; /* depth of end nodes not to compress;0=off */
} quicklist;

typedef struct quicklistIter {
    const quicklist *quicklist;
    quicklistNode *current;
    unsigned char *zi;
    long offset; /* offset in current ziplist */
    int direction;
} quicklistIter;

typedef struct quicklistEntry {
    const quicklist *quicklist;
    quicklistNode *node;
    unsigned char *zi;
    unsigned char *value;
    long long longval;
    unsigned int sz;
    int offset;
} quicklistEntry;
```

è¿™é‡Œå®šä¹‰äº†äº”ä¸ªç»“æ„ä½“:

- quicklistNode, å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, è¿™ä¸ªç»“æ„æè¿°çš„å°±æ˜¯é“¾è¡¨ä¸­çš„ç»“ç‚¹. å®ƒé€šè¿‡zlå­—æ®µæŒæœ‰åº•å±‚çš„ziplist. ç®€å•æ¥è®², å®ƒæè¿°äº†ä¸€ä¸ªziplistå®ä¾‹
- quicklistLZF, ziplistæ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜, ç”¨LZ4ç®—æ³•å‹ç¼©å, å°±å¯ä»¥åŒ…è£…æˆä¸€ä¸ªquicklistLZFç»“æ„. æ˜¯å¦å‹ç¼©quicklistä¸­çš„æ¯ä¸ªziplistå®ä¾‹æ˜¯ä¸€ä¸ªå¯é…ç½®é¡¹. è‹¥è¿™ä¸ªé…ç½®é¡¹æ˜¯å¼€å¯çš„, é‚£ä¹ˆquicklistNode.zlå­—æ®µæŒ‡å‘çš„å°±ä¸æ˜¯ä¸€ä¸ªziplistå®ä¾‹, è€Œæ˜¯ä¸€ä¸ªå‹ç¼©åçš„quicklistLZFå®ä¾‹
- quicklist. è¿™å°±æ˜¯ä¸€ä¸ªåŒé“¾è¡¨çš„å®šä¹‰. head, tailåˆ†åˆ«æŒ‡å‘å¤´å°¾æŒ‡é’ˆ. lenä»£è¡¨é“¾è¡¨ä¸­çš„ç»“ç‚¹. countæŒ‡çš„æ˜¯æ•´ä¸ªquicklistä¸­çš„æ‰€æœ‰ziplistä¸­çš„entryçš„æ•°ç›®. fillå­—æ®µå½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­ziplistçš„æœ€å¤§å ç”¨ç©ºé—´, compresså½±å“ç€æ˜¯å¦è¦å¯¹æ¯ä¸ªziplistä»¥LZ4ç®—æ³•è¿›è¡Œè¿›ä¸€æ­¥å‹ç¼©ä»¥æ›´èŠ‚çœå†…å­˜ç©ºé—´.
- quicklistIteræ˜¯ä¸€ä¸ªè¿­ä»£å™¨
- quicklistEntryæ˜¯å¯¹ziplistä¸­çš„entryæ¦‚å¿µçš„å°è£…. quicklistä½œä¸ºä¸€ä¸ªå°è£…è‰¯å¥½çš„æ•°æ®ç»“æ„, ä¸å¸Œæœ›ä½¿ç”¨è€…æ„ŸçŸ¥åˆ°å…¶å†…éƒ¨çš„å®ç°, æ‰€ä»¥éœ€è¦æŠŠziplist.entryçš„æ¦‚å¿µé‡æ–°åŒ…è£…ä¸€ä¸‹.

quicklistçš„å†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹æ‰€ç¤º:

![](../images/668722-20180910184206679-1690711957.png)

ä¸‹é¢æ˜¯æœ‰å…³quicklistçš„æ›´å¤šé¢å¤–ä¿¡æ¯:

quicklist.fillçš„å€¼å½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­, ziplistçš„é•¿åº¦.

1. å½“æ•°å€¼ä¸ºè´Ÿæ•°æ—¶, ä»£è¡¨ä»¥å­—èŠ‚æ•°é™åˆ¶å•ä¸ªziplistçš„æœ€å¤§é•¿åº¦. å…·ä½“ä¸º:
    1. -1 ä¸è¶…è¿‡4kb
    2. -2 ä¸è¶…è¿‡ 8kb
    3. -3 ä¸è¶…è¿‡ 16kb
    4. -4 ä¸è¶…è¿‡ 32kb
    5. -5 ä¸è¶…è¿‡ 64kb
    6. å½“æ•°å€¼ä¸ºæ­£æ•°æ—¶, ä»£è¡¨ä»¥entryæ•°ç›®é™åˆ¶å•ä¸ªziplistçš„é•¿åº¦. å€¼å³ä¸ºæ•°ç›®. ç”±äºè¯¥å­—æ®µä»…å 16ä½, æ‰€ä»¥ä»¥entryæ•°ç›®é™åˆ¶ziplistçš„å®¹é‡æ—¶, æœ€å¤§å€¼ä¸º2^15ä¸ª
2. quicklist.compressçš„å€¼å½±å“ç€quicklistNode.zlå­—æ®µæŒ‡å‘çš„æ˜¯åŸç”Ÿçš„ziplist, è¿˜æ˜¯ç»è¿‡å‹ç¼©åŒ…è£…åçš„quicklistLZF
    1. 0 è¡¨ç¤ºä¸å‹ç¼©, zlå­—æ®µç›´æ¥æŒ‡å‘ziplist
    2. 1 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´å°¾ç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF
    3. 2 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´ä¸¤ä¸ª, ä¸æœ«ä¸¤ä¸ªç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF
    4. ä»¥æ­¤ç±»æ¨, æœ€å¤§å€¼ä¸º2^16
3. quicklistNode.encodingå­—æ®µ, ä»¥æŒ‡ç¤ºæœ¬é“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†å‹ç¼©. 1ä»£è¡¨æœªå‹ç¼©, æŒæœ‰çš„æ˜¯åŸç”Ÿçš„ziplist, 2ä»£è¡¨å‹ç¼©è¿‡
4. quicklistNode.containerå­—æ®µæŒ‡ç¤ºçš„æ˜¯æ¯ä¸ªé“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ. é»˜è®¤çš„å®ç°æ˜¯ziplist, å¯¹åº”çš„è¯¥å­—æ®µçš„å€¼æ˜¯2, ç›®å‰Redisæ²¡æœ‰æä¾›å…¶å®ƒå®ç°. æ‰€ä»¥å®é™…ä¸Š, è¯¥å­—æ®µçš„å€¼æ’ä¸º2
5. quicklistNode.recompresså­—æ®µæŒ‡ç¤ºçš„æ˜¯å½“å‰ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†è§£å‹. å¦‚æœè¯¥å­—æ®µä¸º1å³ä»£è¡¨ä¹‹å‰è¢«è§£å‹è¿‡, ä¸”éœ€è¦åœ¨ä¸‹ä¸€æ¬¡æ“ä½œæ—¶é‡æ–°å‹ç¼©.

`quicklist`çš„å…·ä½“å®ç°ä»£ç ç¯‡å¹…å¾ˆé•¿, è¿™é‡Œå°±ä¸è´´ä»£ç ç‰‡æ–­äº†, ä»å†…å­˜å¸ƒå±€ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥, ç”±äºæ¯ä¸ªç»“ç‚¹æŒæœ‰çš„ziplistæ˜¯æœ‰ä¸Šé™é•¿åº¦çš„, æ‰€ä»¥åœ¨ä¸æ“ä½œæ—¶è¦è€ƒè™‘çš„åˆ†æ”¯æƒ…å†µæ¯”è¾ƒå¤š. æƒ³æƒ³éƒ½è›‹ç–¼.

quicklistæœ‰è‡ªå·±çš„ä¼˜ç‚¹, ä¹Ÿæœ‰ç¼ºç‚¹, å¯¹äºä½¿ç”¨è€…æ¥è¯´, å…¶ä½¿ç”¨ä½“éªŒç±»ä¼¼äºçº¿æ€§æ•°æ®ç»“æ„, listä½œä¸ºæœ€ä¼ ç»Ÿçš„åŒé“¾è¡¨, ç»“ç‚¹é€šè¿‡æŒ‡é’ˆæŒæœ‰æ•°æ®, æŒ‡é’ˆå­—æ®µä¼šè€—è´¹å¤§é‡å†…å­˜. ziplistè§£å†³äº†è€—è´¹å†…å­˜è¿™ä¸ªé—®é¢˜. ä½†å¼•å…¥äº†æ–°çš„é—®é¢˜: æ¯æ¬¡å†™æ“ä½œæ•´ä¸ªziplistçš„å†…å­˜éƒ½éœ€è¦é‡åˆ†é…. quickliståœ¨ä¸¤è€…ä¹‹é—´åšäº†ä¸€ä¸ªå¹³è¡¡. å¹¶ä¸”ä½¿ç”¨è€…å¯ä»¥é€šè¿‡è‡ªå®šä¹‰quicklist.fill, æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µ, ç»éªŒä¸»ä¹‰è°ƒå‚.

### 2.8 zipmap

dictä½œä¸ºå­—å…¸ç»“æ„, ä¼˜ç‚¹å¾ˆå¤š, æ‰©å±•æ€§å¼ºæ‚, æ”¯æŒå¹³æ»‘æ‰©å®¹ç­‰ç­‰, ä½†å¯¹äºå­—å…¸ä¸­çš„é”®å€¼å‡ä¸ºäºŒè¿›åˆ¶æ•°æ®, ä¸”é•¿åº¦éƒ½å¾ˆå°æ—¶, dictçš„ä¸­çš„ä¸€å¨æŒ‡é’ˆä¼šæµªè´¹ä¸å°‘å†…å­˜, å› æ­¤Redisåˆå®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„å­—å…¸, å³ä¸ºzipmap.

zipmapé€‚åˆä½¿ç”¨çš„åœºåˆæ˜¯:

- é”®å€¼å¯¹é‡ä¸å¤§, å•ä¸ªé”®, å•ä¸ªå€¼é•¿åº¦å°
- é”®å€¼å‡æ˜¯äºŒè¿›åˆ¶æ•°æ®, è€Œä¸æ˜¯å¤åˆç»“æ„æˆ–å¤æ‚ç»“æ„. dictæ”¯æŒå„ç§åµŒå¥—, å­—å…¸æœ¬èº«å¹¶ä¸æŒæœ‰æ•°æ®, è€Œä»…æŒæœ‰æ•°æ®çš„æŒ‡é’ˆ. ä½†zipmapæ˜¯ç›´æ¥æŒæœ‰æ•°æ®çš„.

zipmapçš„å®šä¹‰ä¸å®ç°åœ¨src/zipmap.hä¸src/zipmap.cä¸¤ä¸ªæ–‡ä»¶ä¸­, å…¶å®šä¹‰ä¸å®ç°å‡æœªå®šä¹‰ä»»ä½•structç»“æ„ä½“, å› ä¸ºzipmapçš„å†…å­˜å¸ƒå±€å°±æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´. å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤º:

![](../images/668722-20180910184223910-1797391394.png)


- zipmapèµ·å§‹çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å­˜å‚¨çš„æ˜¯zipmapä¸­é”®å€¼å¯¹çš„ä¸ªæ•°. å¦‚æœé”®å€¼å¯¹çš„ä¸ªæ•°å¤§äº254çš„è¯, é‚£ä¹ˆè¿™ä¸ªå­—èŠ‚çš„å€¼å°±æ˜¯å›ºå®šå€¼254, çœŸå®çš„é”®å€¼å¯¹ä¸ªæ•°éœ€è¦éå†æ‰èƒ½è·å¾—.
- zipmapçš„æœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å›ºå®šå€¼0xFF
- zipmapä¸­çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹, ç§°ä¸ºä¸€ä¸ªentry, å…¶å†…å­˜å ç”¨å¦‚ä¸Šå›¾, åˆ†åˆ«å…­éƒ¨åˆ†:
    1. len_of_key, ä¸€å­—èŠ‚æˆ–äº”å­—èŠ‚. å­˜å‚¨çš„æ˜¯é”®çš„äºŒè¿›åˆ¶é•¿åº¦. å¦‚æœé•¿åº¦å°äº254, åˆ™ç”¨1å­—èŠ‚å­˜å‚¨, å¦åˆ™ç”¨äº”ä¸ªå­—èŠ‚å­˜å‚¨, ç¬¬ä¸€ä¸ªå­—èŠ‚çš„å€¼å›ºå®šä¸º0xFE, åå››ä¸ªå­—èŠ‚ä»¥å°ç«¯åºuint32_tç±»å‹å­˜å‚¨ç€é”®çš„äºŒè¿›åˆ¶é•¿åº¦.
    2. key_dataä¸ºé”®çš„æ•°æ®
    3. len_of_val, ä¸€å­—èŠ‚æˆ–äº”å­—èŠ‚, å­˜å‚¨çš„æ˜¯å€¼çš„äºŒè¿›åˆ¶é•¿åº¦. ç¼–ç æ–¹å¼åŒlen_of_key
    4. len_of_free, å›ºå®šå€¼1å­—èŠ‚, å­˜å‚¨çš„æ˜¯entryä¸­æœªä½¿ç”¨çš„ç©ºé—´çš„å­—èŠ‚æ•°. æœªä½¿ç”¨çš„ç©ºé—´å³ä¸ºå›¾ä¸­çš„free, å®ƒä¸€èˆ¬æ˜¯ç”±äºé”®å€¼å¯¹ä¸­çš„å€¼è¢«æ›¿æ¢å‘ç”Ÿçš„. æ¯”å¦‚, é”®å€¼å¯¹hello <-> wordè¢«ä¿®æ”¹ä¸ºhello <-> wå, å°±ç©ºäº†å››ä¸ªå­—èŠ‚çš„é—²ç½®ç©ºé—´
    5. val_data, ä¸ºå€¼çš„æ•°æ®
    6. free, ä¸ºé—²ç½®ç©ºé—´. ç”±äºlen_of_freeçš„å€¼æœ€å¤§åªèƒ½æ˜¯254, æ‰€ä»¥å¦‚æœå€¼çš„å˜æ›´å¯¼è‡´é—²ç½®ç©ºé—´å¤§äº254çš„è¯, zipmapå°±ä¼šå›æ”¶å†…å­˜ç©ºé—´.




# Redisä¸»ä»å¤åˆ¶åŸç†

ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´éƒ½å·²ç»é…ç½®è¿‡ä¸»ä»å¤åˆ¶ï¼Œä½†æ˜¯å¯¹äºredisä¸»ä»å¤åˆ¶çš„å·¥ä½œæµç¨‹å’Œå¸¸è§é—®é¢˜å¾ˆå¤šéƒ½æ²¡æœ‰æ·±å…¥çš„äº†è§£ã€‚å’”å’”è¿™æ¬¡ç”¨æ—¶ä¿©å¤©æ—¶é—´ç»™å¤§å®¶æ•´ç†ä¸€ä»½redisä¸»ä»å¤åˆ¶çš„å…¨éƒ¨çŸ¥è¯†ç‚¹ã€‚æœ¬æ–‡å®ç°æ‰€éœ€ç¯å¢ƒ centos7.0 redis4.0

## ä¸€ã€ä»€ä¹ˆæ˜¯Redisä¸»ä»å¤åˆ¶ï¼Ÿ

ä¸»ä»å¤åˆ¶å°±æ˜¯ç°åœ¨æœ‰ä¿©å°redisæœåŠ¡å™¨ï¼ŒæŠŠä¸€å°redisçš„æ•°æ®åŒæ­¥åˆ°å¦ä¸€å°redisæ•°æ®åº“ä¸Šã€‚å‰è€…ç§°ä¹‹ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ï¼Œåè€…ä¸ºä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ã€‚æ•°æ®æ˜¯åªèƒ½masterå¾€slaveåŒæ­¥å•å‘ã€‚

ä½†æ˜¯åœ¨å®é™…è¿‡ç¨‹ä¸­æ˜¯ä¸å¯èƒ½åªæœ‰ä¿©å°redisæœåŠ¡å™¨æ¥åšä¸»ä»å¤åˆ¶çš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³è¿™æ¯å°redisæœåŠ¡å™¨éƒ½æœ‰å¯èƒ½ä¼šç§°ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰

ä¸‹å›¾æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„slave3æ—¢æ˜¯masterçš„ä»èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯slaveçš„ä¸»èŠ‚ç‚¹ã€‚

å…ˆçŸ¥é“è¿™ä¹ˆä¸ªæ¦‚å¿µï¼Œæ›´å¤šè¯¦è§£ç»§ç»­æŸ¥çœ‹ä¸‹æ–‡ã€‚

![](../images/af2760bc01cc4da6808cd34087b7176a.jpeg)

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦Redisä¸»ä»å¤åˆ¶ï¼Ÿ

å‡è®¾æˆ‘ä»¬ç°åœ¨å°±ä¸€å°redisæœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯å•æœºçŠ¶æ€ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šå‡ºç°çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æœåŠ¡å™¨å®•æœºï¼Œç›´æ¥å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚å¦‚æœé¡¹ç›®æ˜¯è·Ÿï¿¥å å…³ç³»çš„ï¼Œé‚£é€ æˆçš„åæœå°±å¯æƒ³è€ŒçŸ¥ã€‚

ç¬¬äºŒä¸ªæƒ…å†µå°±æ˜¯å†…å­˜é—®é¢˜äº†ï¼Œå½“åªæœ‰ä¸€å°æœåŠ¡å™¨æ—¶å†…å­˜è‚¯å®šä¼šåˆ°è¾¾å³°å€¼çš„ï¼Œä¸å¯èƒ½å¯¹ä¸€å°æœåŠ¡å™¨è¿›è¡Œæ— é™å‡çº§çš„ã€‚

![](../images/b781d9b31ebd4b718de3083cf036fa4b.jpeg)

æ‰€ä»¥é’ˆå¯¹ä»¥ä¸Šä¿©ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¤šå‡†å¤‡å‡ å°æœåŠ¡å™¨ï¼Œé…ç½®ä¸»ä»å¤åˆ¶ã€‚å°†æ•°æ®ä¿å­˜åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šã€‚å¹¶ä¸”ä¿è¯æ¯ä¸ªæœåŠ¡å™¨çš„æ•°æ®æ˜¯åŒæ­¥çš„ã€‚å³ä½¿æœ‰ä¸€ä¸ªæœåŠ¡å™¨å®•æœºäº†ï¼Œä¹Ÿä¸ä¼šå½±å“ç”¨æˆ·çš„ä½¿ç”¨ã€‚rediså¯ä»¥ç»§ç»­å®ç°é«˜å¯ç”¨ã€åŒæ—¶å®ç°æ•°æ®çš„å†—ä½™å¤‡ä»½ã€‚

è¿™ä¼šåº”è¯¥ä¼šæœ‰å¾ˆå¤šç–‘é—®ï¼Œmasterè·Ÿslaveæ€ä¹ˆè¿æ¥å‘¢ï¼Ÿ å¦‚ä½•åŒæ­¥æ•°æ®å‘¢ï¼Ÿ å‡å¦‚masteræœåŠ¡å™¨å®•æœºäº†å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œä¸€ç‚¹ä¸€ç‚¹è§£å†³ä½ çš„é—®é¢˜ã€‚

![](../images/6289b6c04279481789a6459dc8da2cb1.jpeg)

## ä¸‰ã€Redisä¸»ä»å¤åˆ¶çš„ä½œç”¨

åœ¨ä¸Šè¾¹æˆ‘ä»¬è¯´äº†ä¸ºä»€ä¹ˆä½¿ç”¨redisçš„ä¸»ä»å¤åˆ¶ï¼Œé‚£ä¹ˆä¸»ä»å¤åˆ¶çš„ä½œç”¨å°±æ˜¯é’ˆå¯¹ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒæ¥è®²äº†ã€‚

æˆ‘ä»¬ç»§ç»­ä½¿ç”¨è¿™ä¸ªå›¾æ¥è°ˆè®º

- ç¬¬ä¸€ç‚¹æ˜¯æ•°æ®å†—ä½™äº†ï¼Œå®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„å¦ä¸€ç§æ–¹å¼ã€‚
- ç¬¬äºŒç‚¹æ˜¯é’ˆå¯¹å•æœºæ•…éšœé—®é¢˜ã€‚å½“ä¸»èŠ‚ç‚¹ä¹Ÿå°±æ˜¯masterå‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æ¥æä¾›æœåŠ¡ä¹Ÿå°±æ˜¯slaveï¼Œå®ç°äº†å¿«é€Ÿæ¢å¤æ•…éšœï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å†—ä½™ã€‚
- ç¬¬ä¸‰ç‚¹æ˜¯è¯»å†™åˆ†ç¦»ï¼ŒmasteræœåŠ¡å™¨ä¸»è¦æ˜¯å†™ï¼Œslaveä¸»è¦ç”¨æ¥è¯»æ•°æ®ï¼Œå¯ä»¥æé«˜æœåŠ¡å™¨çš„è´Ÿè½½èƒ½åŠ›ã€‚åŒæ—¶å¯ä»¥æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ·»åŠ ä»èŠ‚ç‚¹çš„æ•°é‡ã€‚
- ç¬¬å››ç‚¹æ˜¯è´Ÿè½½å‡è¡¡ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œæœ‰ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼Œå°¤å…¶åœ¨å†™å°‘è¯»å¤šçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜redisæœåŠ¡å™¨çš„å¹¶å‘é‡å’Œè´Ÿè½½ã€‚
- ç¬¬äº”ç‚¹æ˜¯é«˜å¯ç”¨çš„åŸºçŸ³ï¼Œä¸»ä»å¤åˆ¶æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¯´ä¸»ä»å¤åˆ¶æ˜¯é«˜å¯ç”¨çš„åŸºçŸ³ã€‚

![](../images/11b30c167de447ffad6d1ab741f921f6.jpeg)

## å››ã€é…ç½®Redisä¸»ä»å¤åˆ¶
è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å…ˆç®€å•çš„é…ç½®ä¸€ä¸ªä¸»ä»å¤åˆ¶æ¡ˆä¾‹ï¼Œç„¶ååœ¨è°ˆå®ç°çš„åŸç†ã€‚

rediså­˜å‚¨è·¯å¾„ä¸ºï¼šusr/local/redis

æ—¥å¿—è·Ÿé…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ï¼šusr/local/redis/data

é¦–å…ˆæˆ‘ä»¬å…ˆé…ç½®ä¿©ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºredis6379.conf å’Œ redis6380.conf

![](../images/9823874fa8364612b5a4bdf90b705c4c.jpeg)

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä¸»è¦å°±æ˜¯ä¿®æ”¹ç«¯å£ã€‚ä¸ºäº†æŸ¥çœ‹æ–¹ä¾¿åœ¨æŠŠæ—¥å¿—æ–‡ä»¶å’ŒæŒä¹…åŒ–æ–‡ä»¶çš„åå­—éƒ½ç”¨å„è‡ªçš„ç«¯å£æ¥åšæ ‡è¯†ã€‚

![](../images/94dee06ef9b64c118916593c0a47f40e.jpeg)

ç„¶ååˆ†åˆ«å¼€å¯ä¿©ä¸ªredisæœåŠ¡ï¼Œä¸€ä¸ªç«¯å£ä¸º6379ï¼Œä¸€ä¸ªç«¯å£ä¸º6380ã€‚æ‰§è¡Œå‘½ä»¤redis-server redis6380.conf,ç„¶åä½¿ç”¨redis-cli -p 6380è¿æ¥ï¼Œå› ä¸ºredisçš„é»˜è®¤ç«¯å£å°±æ˜¯6379æ‰€ä»¥æˆ‘ä»¬å¯åŠ¨å¦å¤–ä¸€å°redisæœåŠ¡å™¨ç›´æ¥ä½¿ç”¨redis-server redis6379.conf ç„¶åç›´æ¥ä½¿ç”¨redis-cliç›´æ¥è¿æ¥å°±å¯ä»¥ã€‚

![](../images/cc285906b45845efa6a5193ec1747ce0.jpeg)

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±æˆåŠŸçš„é…ç½®äº†ä¿©ä¸ªredisæœåŠ¡ï¼Œä¸€å°ä¸º6380ï¼Œä¸€å°ä¸º6379ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºã€‚å®é™…å·¥ä½œä¸­æ˜¯éœ€è¦é…ç½®åœ¨ä¿©å°ä¸åŒçš„æœåŠ¡å™¨çš„ã€‚

![](../images/745a5d13ff6a4dbc89e287f3188ca111.jpeg)

### 1. ä½¿ç”¨å®¢æˆ·ç«¯å‘½ä»¤è¡Œå¯åŠ¨

æˆ‘ä»¬å…ˆå¾—æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œå°±æ˜¯åœ¨é…ç½®ä¸»ä»å¤åˆ¶æ—¶ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ä»èŠ‚ç‚¹æ¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯slaveã€‚

é‚£ä¹ˆæˆ‘ä»¬åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ä¸º slaveof 127.0.0.1 6379ï¼Œæ‰§è¡Œå®Œå°±ä»£è¡¨æˆ‘ä»¬è¿æ¥ä¸Šäº†ã€‚

![](../images/789513781c64485b9130dc239706fbbf.jpeg)

æˆ‘ä»¬å…ˆæµ‹è¯•ä¸€ä¸‹çœ‹æ˜¯å¦å®ç°ä¸»ä»å¤åˆ¶ã€‚åœ¨masterè¿™å°æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¿©ä¸ªset kaka 123 å’Œ set master 127.0.0.1ï¼Œç„¶ååœ¨slave6380ç«¯å£æ˜¯å¯ä»¥æˆåŠŸè·å–åˆ°çš„ï¼Œä¹Ÿå°±è¯´æ˜æˆ‘ä»¬çš„ä¸»ä»å¤åˆ¶å°±å·²ç»é…ç½®å®Œæˆäº†ã€‚ä½†æ˜¯åœ¨å®ç°ç”Ÿäº§ç¯å¢ƒå¯ä¸æ˜¯å°±è¿™æ ·å®Œäº‹äº†ï¼Œåè¾¹ä¼šåœ¨è¿›ä¸€æ­¥å¯¹ä¸»ä»å¤åˆ¶è¿›è¡Œä¼˜åŒ–ï¼Œç›´åˆ°å®ç°é«˜å¯ç”¨ã€‚

![](../images/a4d3cb957f3f4b35b280118bb129fe58.jpeg)

### 2. ä½¿ç”¨é…ç½®æ–‡ä»¶å¯ç”¨

åœ¨ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ä¸»ä»å¤åˆ¶ä¹‹å‰å‘¢ï¼å…ˆéœ€è¦æŠŠä¹‹å‰ä½¿ç”¨å®¢æˆ·ç«¯å‘½ä»¤è¡Œè¿æ¥çš„æ–­å¼€ï¼Œåœ¨ä»ä¸»æœºæ‰§è¡Œslaveof no oneå³å¯æ–­å¼€ä¸»ä»å¤åˆ¶ã€‚

![](../images/fd9f917bf17e43d5b7d01ed513e05635.jpeg)

åœ¨å“ªå¯ä»¥æŸ¥çœ‹ä»èŠ‚ç‚¹å·²ç»æ–­å¼€äº†ä¸»èŠ‚ç‚¹å‘¢ï¼åœ¨ä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯è¾“å…¥å‘½ä»¤è¡ŒinfoæŸ¥çœ‹

è¿™å¼ å›¾æ˜¯ä½¿ç”¨ä»èŠ‚ç‚¹ä½¿ç”¨å®¢æˆ·ç«¯å‘½ä»¤è¡Œè¿æ¥ä¸»èŠ‚ç‚¹åï¼Œåœ¨ä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯è¾“å…¥infoæ‰“å°çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªslave0çš„ä¸€ä¸ªä¿¡æ¯ã€‚

![](../images/a2e38eaa9f0541769c7569abffe6da48.jpeg)

è¿™ä¸ªå›¾æ˜¯åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œå®Œslaveof no one åï¼Œåœ¨ä¸»èŠ‚ç‚¹æ‰“å°çš„infoï¼Œè¯´æ˜ä»èŠ‚ç‚¹å·²ç»è·Ÿä¸»èŠ‚ç‚¹æ–­å¼€è¿æ¥äº†ã€‚

![](../images/dab19075906049dfa6156de45a8bdc1e.jpeg)

åœ¨æ ¹æ®é…ç½®æ–‡ä»¶å¯åŠ¨redisæœåŠ¡ï¼Œredis-server redis6380.conf

å½“åœ¨ä»èŠ‚ç‚¹é‡æ–°å¯åŠ¨åå°±å¯ä»¥åœ¨ä¸»èŠ‚ç‚¹ç›´æ¥æŸ¥çœ‹åˆ°ä»èŠ‚ç‚¹çš„è¿æ¥ä¿¡æ¯ã€‚

![](../images/d33af09c79c04875b884f51b0c752eeb.jpeg)

æµ‹è¯•æ•°æ®ï¼Œä¸»èŠ‚ç‚¹å†™çš„ä¸œè¥¿ï¼Œä»èŠ‚ç‚¹è¿˜æ˜¯ä¼šè‡ªåŠ¨åŒæ­¥çš„ã€‚

![](../images/5a043effdcc54f7bb67e3fa13fcbb2cc.jpeg)

### 3. å¯åŠ¨redisæœåŠ¡å™¨æ—¶å¯åŠ¨

è¿™ç§æ–¹å¼é…ç½®ä¹Ÿæ˜¯å¾ˆç®€å•ï¼Œåœ¨å¯åŠ¨redisæœåŠ¡å™¨æ—¶ç›´æ¥å°±å¯åŠ¨ä¸»ä»å¤åˆ¶ï¼Œæ‰§è¡Œå‘½ä»¤ï¼šredis-server --slaveof host port å³å¯ã€‚

### 4. ä¸»ä»å¤åˆ¶å¯åŠ¨åçš„æ—¥å¿—ä¿¡æ¯æŸ¥çœ‹

è¿™ä¸ªæ˜¯ä¸»èŠ‚ç‚¹çš„æ—¥å¿—ä¿¡æ¯

![](../images/b68dbf0d64844cf8ab83fca534b04e4a.jpeg)

è¿™ä¸ªæ˜¯ä»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰è¿æ¥ä¸»èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿˜æœ‰RDBå¿«ç…§ä¿å­˜ã€‚

![](../images/1d905286e19f4a3b960d596b184fa8d5.jpeg)

## äº”ã€ä¸»ä»å¤åˆ¶å·¥ä½œåŸç†

### 1. ä¸»ä»å¤åˆ¶çš„ä¸‰ä¸ªé˜¶æ®µ

ä¸»ä»å¤åˆ¶å®Œæ•´çš„å·¥ä½œæµç¨‹åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µã€‚æ¯ä¸€æ®µéƒ½æœ‰è‡ªå·±çš„å†…éƒ¨å·¥ä½œæµç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šå¯¹è¿™ä¸‰ä¸ªè¿‡ç¨‹è¿›è¡Œè°ˆè®ºã€‚

- å»ºç«‹è¿æ¥è¿‡ç¨‹ï¼šè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯slaveè·Ÿmasterè¿æ¥çš„è¿‡ç¨‹
- æ•°æ®åŒæ­¥è¿‡ç¨‹ï¼šæ˜¯masterç»™slaveåŒæ­¥æ•°æ®çš„è¿‡ç¨‹
- å‘½ä»¤ä¼ æ’­è¿‡ç¨‹ï¼šæ˜¯åå¤åŒæ­¥æ•°æ®

![](../images/1727327958931dbc.jpg)

### 2. ç¬¬ä¸€é˜¶æ®µï¼šå»ºç«‹è¿æ¥è¿‡ç¨‹

![](../images/17188139b47a27ca.jpg)

ä¸Šå›¾æ˜¯ä¸€ä¸ªå®Œæ•´ä¸»ä»å¤åˆ¶å»ºç«‹è¿æ¥å·¥ä½œæµç¨‹ã€‚ç„¶åä½¿ç”¨ç®€çŸ­çš„è¯è¯­æ¥æè¿°ä¸Šè¾¹çš„å·¥ä½œæµç¨‹ã€‚

1. è®¾ç½®masterçš„åœ°å€å’Œç«¯å£ï¼Œä¿å­˜masterçš„ä¿¡æ¯
2. å»ºç«‹socketè¿æ¥ï¼ˆè¿™ä¸ªè¿æ¥åšçš„äº‹æƒ…ä¸‹æ–‡ä¼šè¯´ï¼‰
3. æŒç»­å‘é€pingå‘½ä»¤
4. èº«ä»½éªŒè¯
5. å‘é€slaveç«¯å£ä¿¡æ¯

åœ¨å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œä»èŠ‚ç‚¹ä¼šä¿å­˜masterçš„åœ°å€å’Œç«¯å£ã€ä¸»èŠ‚ç‚¹masterä¿å­˜ä»èŠ‚ç‚¹slaveçš„ç«¯å£ã€‚

### 3. ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åŒæ­¥é˜¶æ®µè¿‡ç¨‹

![](../images/17273279684debb7.jpg)

è¿™å¼ å›¾æ˜¯è¯¦ç»†æè¿°ç¬¬ä¸€æ¬¡ä»èŠ‚ç‚¹è¿æ¥ä¸»èŠ‚ç‚¹æ—¶çš„æ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚
å½“ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥ä¸»èŠ‚ç‚¹æ—¶ï¼Œå…ˆä¼šæ‰§è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶è¿™æ¬¡çš„å…¨é‡å¤åˆ¶æ˜¯æ— æ³•é¿å…çš„ã€‚
å…¨é‡å¤åˆ¶æ‰§è¡Œå®Œæˆåï¼Œä¸»èŠ‚ç‚¹å°±ä¼šå‘é€å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„æ•°æ®ï¼Œç„¶åä»èŠ‚ç‚¹å°±ä¼šæ‰§è¡Œbgrewriteaofæ¢å¤æ•°æ®ï¼Œè¿™ä¹Ÿå°±æ˜¯éƒ¨åˆ†å¤åˆ¶ã€‚
åœ¨è¿™ä¸ªé˜¶æ®µæåˆ°äº†ä¸‰ä¸ªæ–°ç‚¹ï¼Œå…¨é‡å¤åˆ¶ã€éƒ¨åˆ†å¤åˆ¶ã€å¤åˆ¶ç¼“å†²ç§¯å‹åŒºã€‚ä¼šåœ¨ä¸‹æ–‡çš„å¸¸è§é—®é¢˜é‡Œè¯¦ç»†è¯´æ˜è¿™å‡ ä¸ªç‚¹ã€‚

### 4. ç¬¬ä¸‰é˜¶æ®µï¼šå‘½ä»¤ä¼ æ’­é˜¶æ®µ

å½“masteræ•°æ®åº“è¢«ä¿®æ”¹åï¼Œä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸ä¸€è‡´åï¼Œæ­¤æ—¶å°±ä¼šè®©ä¸»ä»æ•°æ®åŒæ­¥åˆ°ä¸€è‡´ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºå‘½ä»¤ä¼ æ’­ã€‚
masterä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å˜æ›´å‘½ä»¤å‘é€ç»™slaveï¼Œslaveæ¥æ”¶å‘½ä»¤åæ‰§è¡Œå‘½ä»¤ï¼Œè®©ä¸»ä»æ•°æ®è¾¾åˆ°ä¸€è‡´ã€‚
å‘½ä»¤ä¼ æ’­é˜¶æ®µçš„éƒ¨åˆ†å¤åˆ¶


- åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µå‡ºç°æ–­ç½‘çš„æƒ…å†µï¼Œæˆ–è€…ç½‘ç»œæŠ–åŠ¨æ—¶ä¼šå¯¼è‡´è¿æ¥æ–­å¼€ï¼ˆconnection  lostï¼‰
- è¿™ä¸ªæ—¶å€™ä¸»èŠ‚ç‚¹masterè¿˜æ˜¯ä¼šç»§ç»­å¾€replbackbufferï¼ˆå¤åˆ¶ç¼“å†²ç§¯å‹åŒºï¼‰å†™æ•°æ®
- ä»èŠ‚ç‚¹ä¼šç»§ç»­å°è¯•è¿æ¥ä¸»æœºï¼ˆconnect to masterï¼‰
- å½“ä»èŠ‚ç‚¹æŠŠè‡ªå·±çš„runidå’Œå¤åˆ¶åç§»é‡å‘é€ç»™ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ‰§è¡Œpysncå‘½ä»¤åŒæ­¥
- å¦‚æœmasteråˆ¤æ–­åç§»é‡æ˜¯åœ¨å¤åˆ¶ç¼“å†²åŒºèŒƒå›´å†…ï¼Œå°±ä¼šè¿”å›continueå‘½ä»¤ã€‚å¹¶ä¸”å‘é€å¤åˆ¶ç¼“å†²åŒºçš„æ•°æ®ç»™ä»èŠ‚ç‚¹ã€‚
- ä»èŠ‚ç‚¹æ¥æ”¶æ•°æ®æ‰§è¡Œbgrewriteaofï¼Œæ¢å¤æ•°æ®


## å…­. è¯¦ç»†ä»‹ç»ä¸»ä»å¤åˆ¶åŸç†ï¼ˆå…¨é‡å¤åˆ¶+éƒ¨åˆ†å¤åˆ¶ï¼‰

![](../images/1727327968bf0895.jpg)

è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸»ä»å¤åˆ¶æœ€é½å…¨çš„æµç¨‹è®²è§£ã€‚é‚£ä¹ˆä¸‹æ¥æˆ‘ä»¬å¯¹æ¯ä¸€æ­¥è¿›ç¨‹ç®€å•çš„ä»‹ç»

1. ä»èŠ‚ç‚¹å‘é€æŒ‡ä»¤psync ? 1 psync runid offset   æ‰¾å¯¹åº”çš„runidç´¢å–æ•°æ®ã€‚ä½†æ˜¯è¿™é‡Œå¯ä»¥è€ƒè™‘ä¸€ä¸‹ï¼Œå½“ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥çš„æ—¶å€™æ ¹æœ¬å°±ä¸çŸ¥é“ä¸»èŠ‚ç‚¹çš„runid å’Œ offset  ã€‚æ‰€ä»¥ç¬¬ä¸€æ¬¡å‘é€çš„æŒ‡ä»¤æ˜¯psync ï¼Ÿ 1æ„æ€å°±æ˜¯ä¸»èŠ‚ç‚¹çš„æ•°æ®æˆ‘å…¨è¦ã€‚
2. ä¸»èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œbgsaveç”ŸæˆRDBæ–‡ä»¶ï¼Œè®°å½•å½“å‰çš„å¤åˆ¶åç§»é‡offset
3. ä¸»èŠ‚ç‚¹è¿™ä¸ªæ—¶å€™ä¼šæŠŠè‡ªå·±çš„runid  å’Œ  offset  é€šè¿‡ +FULLRESYNC  runid  offset   æŒ‡ä»¤  é€šè¿‡socketå‘é€RDBæ–‡ä»¶ç»™ä»èŠ‚ç‚¹ã€‚
4. ä»èŠ‚ç‚¹æ¥æ”¶åˆ°+FULLRESYNC  ä¿å­˜ä¸»èŠ‚ç‚¹çš„runidå’Œoffset    ç„¶åæ¸…ç©ºå½“å‰æ‰€æœ‰æ•°æ®ï¼Œé€šè¿‡socketæ¥æ”¶RDBæ–‡ä»¶ï¼Œå¼€å§‹æ¢å¤RDBæ•°æ®ã€‚
5. åœ¨å…¨é‡å¤åˆ¶åï¼Œä»èŠ‚ç‚¹å·²ç»è·å–åˆ°äº†ä¸»èŠ‚ç‚¹çš„runidå’Œoffsetï¼Œå¼€å§‹å‘é€æŒ‡ä»¤ psync runid offset
6. ä¸»èŠ‚ç‚¹æ¥æ”¶æŒ‡ä»¤ï¼Œåˆ¤æ–­runidæ˜¯å¦åŒ¹é…ï¼Œåˆ¤æ–­offsetæ˜¯å¦åœ¨å¤åˆ¶ç¼“å†²åŒºä¸­ã€‚
7. ä¸»èŠ‚ç‚¹åˆ¤æ–­runidå’Œoffsetæœ‰ä¸€ä¸ªä¸æ»¡è¶³ï¼Œå°±ä¼šåœ¨è¿”å›åˆ°æ­¥éª¤2ç»§ç»­æ‰§è¡Œå…¨é‡å¤åˆ¶ã€‚è¿™é‡Œçš„runidä¸åŒ¹é…åªæœ‰çš„å¯èƒ½æ˜¯ä»èŠ‚ç‚¹é‡å¯äº†è¿™ä¸ªé—®é¢˜åè¾¹ä¼šè§£å†³ï¼Œoffsetï¼ˆåç§»é‡ï¼‰ä¸åŒ¹é…å°±æ˜¯å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæº¢å‡ºäº†ã€‚ å¦‚æœrunidæˆ–offsetæ ¡éªŒé€šè¿‡ï¼Œä»èŠ‚ç‚¹çš„offsetå’Œä¸»èŠ‚ç‚¹çš„offsetç›¸åŒæ—¶åˆ™å¿½ç•¥ã€‚ å¦‚æœrunidæˆ–offsetæ£€éªŒé€šè¿‡ï¼Œä»èŠ‚ç‚¹çš„offsetä¸offsetä¸ç›¸åŒï¼Œåˆ™ä¼šå‘é€ +CONTINUE  offset(è¿™ä¸ªoffsetä¸ºä¸»èŠ‚ç‚¹çš„)ï¼Œé€šè¿‡socketå‘é€å¤åˆ¶ç¼“å†²åŒºä¸­ä»èŠ‚ç‚¹offsetåˆ°ä¸»èŠ‚ç‚¹offsetçš„æ•°æ®ã€‚
8. ä»èŠ‚ç‚¹æ”¶åˆ°+CONTINUE ä¿å­˜masterçš„offset  é€šè¿‡socketæ¥æ”¶åˆ°ä¿¡æ¯åï¼Œæ‰§è¡Œbgrewriteaofï¼Œæ¢å¤æ•°æ®ã€‚

**1-4æ˜¯å…¨é‡å¤åˆ¶    5-8æ˜¯éƒ¨åˆ†å¤åˆ¶**

åœ¨ä¸»èŠ‚ç‚¹çš„ç¬¬3æ­¥ä¸‹é¢  ä¸»èŠ‚ç‚¹åœ¨ä¸»ä»å¤åˆ¶çš„æœŸé—´æ˜¯ä¸€ç›´åœ¨æ¥æ”¶å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œä¸»èŠ‚ç‚¹çš„offsetæ˜¯ä¸€ç›´å˜åŒ–çš„ã€‚åªæœ‰æœ‰å˜åŒ–å°±ä¼šç»™æ¯ä¸ªslaveè¿›è¡Œå‘é€ï¼Œè¿™ä¸ªå‘é€çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºå¿ƒè·³æœºåˆ¶

## ä¸ƒ. å¿ƒè·³æœºåˆ¶

åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µæ˜¯ï¼Œä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹ä¹‹é—´ä¸€ç›´éƒ½éœ€è¦è¿›è¡Œä¿¡æ¯äº’æ¢ï¼Œä½¿ç”¨å¿ƒè·³æœºåˆ¶è¿›è¡Œç»´æŠ¤ï¼Œå®ç°ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹è¿æ¥ä¿æŒåœ¨çº¿ã€‚


- masterå¿ƒè·³
    - æŒ‡ä»¤ï¼šping
    - é»˜è®¤10ç§’è¿›è¡Œä¸€æ¬¡ï¼Œæ˜¯ç”±å‚æ•°repl-ping-slave-periodå†³å®šçš„
    - ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯åˆ¤æ–­ä»èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿
    - å¯ä»¥ä½¿ç”¨info replication  æ¥æŸ¥çœ‹ä»èŠ‚ç‚¹ç§Ÿåä¸€æ¬¡è¿æ¥æ—¶é—´çš„é—´éš”ï¼Œlagä¸º0æˆ–è€…ä¸º1å°±æ˜¯æ­£å¸¸çŠ¶æ€ã€‚
- slaveå¿ƒè·³ä»»åŠ¡
    - æŒ‡ä»¤ï¼šreplconf ack {offset}
    - æ¯ç§’æ‰§è¡Œä¸€æ¬¡
    - ä¸»è¦åšçš„äº‹æƒ…æ˜¯ç»™ä¸»èŠ‚ç‚¹å‘é€è‡ªå·±çš„å¤åˆ¶åç§»é‡ï¼Œä»ä¸»èŠ‚ç‚¹è·å–åˆ°æœ€æ–°çš„æ•°æ®å˜æ›´å‘½ä»¤ï¼Œè¿˜åšä¸€ä»¶äº‹æƒ…å°±æ˜¯åˆ¤æ–­ä¸»èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ã€‚

**å¿ƒè·³é˜¶æ®µçš„æ³¨æ„äº‹é¡¹** ä¸»èŠ‚ç‚¹ä¸ºä¿éšœæ•°æ®ç¨³å®šæ€§ï¼Œå½“ä»èŠ‚ç‚¹æŒ‚æ‰çš„æ•°é‡æˆ–è€…å»¶è¿Ÿè¿‡é«˜æ—¶ã€‚å°†ä¼šæ‹’ç»æ‰€æœ‰ä¿¡æ¯åŒæ­¥ã€‚

è¿™é‡Œæœ‰ä¿©ä¸ªå‚æ•°å¯ä»¥è¿›è¡Œé…ç½®è°ƒæ•´ï¼š

```bash
min-slaves-to-write   2
min-slaves-max-lag 8
```

è¿™ä¿©ä¸ªå‚æ•°è¡¨ç¤ºä»èŠ‚ç‚¹çš„æ•°é‡å°±å‰©ä½™2ä¸ªï¼Œæˆ–è€…ä»èŠ‚ç‚¹çš„å»¶è¿Ÿå¤§äº8ç§’æ—¶ï¼Œä¸»èŠ‚ç‚¹å°±ä¼šå¼ºåˆ¶å…³é—­masteåŠŸèƒ½ï¼Œåœæ­¢æ•°æ®åŒæ­¥ã€‚

é‚£ä¹ˆä¸»èŠ‚ç‚¹æ˜¯å¦‚ä½•çŸ¥é“ä»èŠ‚ç‚¹æŒ‚æ‰çš„æ•°é‡å’Œå»¶è¿Ÿæ—¶é—´å‘¢ï¼  åœ¨å¿ƒè·³æœºåˆ¶é‡Œè¾¹slave ä¼šæ¯éš”ä¸€ç§’å‘é€perlconf  ack  è¿™ä¸ªæŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤å¯æºå¸¦åç§»é‡ï¼Œä¹Ÿå¯ä»¥æºå¸¦ä»èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´å’Œä»èŠ‚ç‚¹çš„æ•°é‡ã€‚

## å…«ã€éƒ¨åˆ†å¤åˆ¶çš„ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ 

### 1. æœåŠ¡å™¨çš„è¿è¡Œid ï¼ˆrun idï¼‰

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªrun idæ˜¯ä»€ä¹ˆï¼Œæ‰§è¡Œinfoå‘½ä»¤å³å¯çœ‹åˆ°ã€‚åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¿¡æ¯ä¹Ÿå¯ä»¥çœ‹åˆ°ã€‚

![](../images/172732797248305f.jpg)

redisåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºçš„idï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ¯æ¬¡å¯åŠ¨çš„idéƒ½ä¼šä¸ä¸€æ ·ï¼‰ï¼Œæ˜¯ç”±40ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ç»„æˆï¼Œç”¨æ¥å”¯ä¸€è¯†åˆ«ä¸€ä¸ªredisèŠ‚ç‚¹ã€‚
åœ¨ä¸»ä»å¤åˆ¶åˆæ¬¡å¯åŠ¨æ—¶ï¼Œmasterä¼šæŠŠè‡ªå·±çš„runidå‘é€ç»™slaveï¼Œslaveä¼šä¿å­˜masterçš„è¿™ä¸ªidï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨infoå‘½ä»¤æŸ¥çœ‹

![](../images/17273279bd947317.jpg)

å½“æ–­çº¿é‡è¿æ—¶ï¼ŒslaveæŠŠè¿™ä¸ªidå‘é€ç»™masterï¼Œå¦‚æœslaveä¿å­˜çš„runidä¸masterç°åœ¨çš„runidç›¸åŒï¼Œmasterä¼šå°è¯•ä½¿ç”¨éƒ¨åˆ†å¤åˆ¶ï¼ˆè¿™å—èƒ½å¦å¤åˆ¶æˆåŠŸè¿˜æœ‰ä¸€ä¸ªå› ç´ å°±æ˜¯åç§»é‡ï¼‰ã€‚å¦‚æœslaveä¿å­˜çš„runidä¸masterç°åœ¨çš„runidä¸åŒï¼Œåˆ™ä¼šç›´æ¥è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚

### 2. å¤åˆ¶ç§¯å‹ç¼“å†²åŒº

å¤åˆ¶ç¼“å†²ç§¯å‹åŒºæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æˆ·å­˜å‚¨masteræ”¶é›†æ•°æ®çš„å‘½ä»¤è®°å½•ã€‚å¤åˆ¶ç¼“å†²åŒºçš„é»˜è®¤å­˜å‚¨ç©ºé—´æ˜¯1Mã€‚
å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹repl-backlog-size 1mbæ¥æ§åˆ¶ç¼“å†²åŒºå¤§å°ï¼Œè¿™ä¸ªæ¯”ä¾‹å¯ä»¥æ ¹æ®è‡ªå·±çš„æœåŠ¡å™¨å†…å­˜æ¥ä¿®æ”¹ï¼Œå’”å’”è¿™è¾¹æ˜¯é¢„ç•™å‡ºäº†30%å·¦å³ã€‚

**å¤åˆ¶ç¼“å†²åŒºåˆ°åº•å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ**

å½“æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ä¸ºset name kakaæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æŒä¹…åŒ–æ–‡ä»¶æŸ¥çœ‹

![](../images/172732798545411e.jpg)

é‚£ä¹ˆå¤åˆ¶ç§¯å‹ç¼“å†²åŒºå°±æ˜¯å­˜å‚¨çš„aofæŒä¹…åŒ–çš„æ•°æ®ï¼Œå¹¶ä¸”ä»¥å­—èŠ‚åˆ†å¼€ï¼Œå¹¶ä¸”æ¯ä¸ªå­—èŠ‚éƒ½æœ‰è‡ªå·±çš„åç§»é‡ã€‚è¿™ä¸ªåç§»é‡ä¹Ÿå°±æ˜¯å¤åˆ¶åç§»é‡ï¼ˆoffsetï¼‰

![](../images/172732798af59f73.jpg)

é‚£ä¸ºä»€ä¹ˆä¼šè¯´å¤åˆ¶ç¼“å†²ç§¯å‹åŒºæœ‰å¯èƒ½ä¼šå¯¼è‡´å…¨é‡å¤åˆ¶å‘¢
åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹ä¼šæŠŠæ”¶é›†çš„æ•°æ®å­˜å‚¨åˆ°å¤åˆ¶ç¼“å†²åŒºä¸­ï¼Œç„¶ååœ¨å‘é€ç»™ä»èŠ‚ç‚¹ã€‚å°±æ˜¯è¿™é‡Œå‡ºç°äº†é—®é¢˜ï¼Œå½“ä¸»èŠ‚ç‚¹æ•°æ®é‡åœ¨ä¸€ç¬é—´ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œè¶…å‡ºäº†å¤åˆ¶ç¼“å†²åŒºçš„å†…å­˜ï¼Œå°±ä¼šæœ‰ä¸€éƒ¨åˆ†æ•°æ®ä¼šè¢«æŒ¤å‡ºå»ï¼Œä»è€Œå¯¼è‡´ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ã€‚ä»è€Œè¿›è¡Œå…¨é‡å¤åˆ¶ã€‚å¦‚æœè¿™ä¸ªç¼“å†²åŒºå¤§å°è®¾ç½®ä¸åˆç†é‚£ä¹ˆå¾ˆå¤§å¯èƒ½ä¼šé€ æˆæ­»å¾ªç¯ï¼Œä»èŠ‚ç‚¹å°±ä¼šä¸€ç›´å…¨é‡å¤åˆ¶ï¼Œæ¸…ç©ºæ•°æ®ï¼Œå…¨é‡å¤åˆ¶ã€‚

### 3. å¤åˆ¶åç§»é‡ï¼ˆoffsetï¼‰

![](../images/17273279906f511c.jpg)

ä¸»èŠ‚ç‚¹å¤åˆ¶åç§»é‡æ˜¯ç»™ä»èŠ‚ç‚¹å‘é€ä¸€æ¬¡è®°å½•ä¸€æ¬¡ï¼Œä»èŠ‚ç‚¹æ˜¯æ¥æ”¶ä¸€æ¬¡è®°å½•ä¸€æ¬¡ã€‚
ç”¨äºåŒæ­¥ä¿¡æ¯ï¼Œå¯¹æ¯”ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹çš„å·®å¼‚ï¼Œå½“slaveæ–­è”æ—¶æ¢å¤æ•°æ®ä½¿ç”¨ã€‚
è¿™ä¸ªå€¼ä¹Ÿå°±æ˜¯æ¥è‡ªå·±äºå¤åˆ¶ç¼“å†²ç§¯å‹åŒºé‡Œè¾¹çš„é‚£ä¸ªåç§»é‡ã€‚

## ä¹. ä¸»ä»å¤åˆ¶å¸¸è§çš„é—®é¢˜

### 1. ä¸»èŠ‚ç‚¹é‡å¯é—®é¢˜ï¼ˆå†…éƒ¨ä¼˜åŒ–ï¼‰

å½“ä¸»èŠ‚ç‚¹é‡å¯åï¼Œrunidçš„å€¼å°†å‘ç”Ÿå˜åŒ–ï¼Œä¼šå¯¼è‡´æ‰€æœ‰çš„ä»èŠ‚ç‚¹è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚

è¿™ä¸ªé—®é¢˜æˆ‘ä»¬æ— éœ€è€ƒè™‘ï¼ŒçŸ¥é“ç³»ç»Ÿæ˜¯æ€ä¹ˆä¼˜åŒ–çš„å³å¯ã€‚

åœ¨å»ºç«‹å®Œä¸»ä»å¤åˆ¶åä¸»èŠ‚ç‚¹ä¼šåˆ›å»ºmaster-replidå˜é‡ï¼Œè¿™ä¸ªç”Ÿæˆçš„ç­–ç•¥è·Ÿrunidä¸€æ ·ï¼Œé•¿åº¦æ˜¯41ä½ï¼Œrunidé•¿åº¦æ˜¯40ä½ï¼Œç„¶åå‘é€ç»™ä»èŠ‚ç‚¹ã€‚

åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œshutdown  saveå‘½ä»¤æ—¶ï¼Œè¿›è¡Œäº†ä¸€æ¬¡RDBæŒä¹…åŒ–ä¼šæŠŠrunid å’Œ offsetä¿å­˜åˆ°RDBæ–‡ä»¶ä¸­ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤redis-check-rdbæŸ¥çœ‹è¯¥ä¿¡æ¯ã€‚

![](../images/17273279a6e90503.jpg)

ä¸»èŠ‚ç‚¹é‡å¯ååŠ è½½RDBæ–‡ä»¶ï¼Œå°†æ–‡ä»¶ä¸­çš„repl-id  å’Œrepl-offsetåŠ è½½åˆ°å†…å­˜ä¸­ã€‚çºµä½¿è®©æ‰€æœ‰ä»èŠ‚ç‚¹è®¤ä¸ºè¿˜æ˜¯ä¹‹å‰çš„ä¸»èŠ‚ç‚¹ã€‚

### 2. ä»èŠ‚ç‚¹ç½‘ç»œä¸­æ–­åç§»é‡è¶Šç•Œå¯¼è‡´å…¨é‡å¤åˆ¶

ç”±äºç½‘ç»œç¯å¢ƒä¸ä½³ï¼Œä»èŠ‚ç‚¹ç½‘ç»œä¸­æ–­ã€‚å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå†…å­˜è¿‡å°å¯¼è‡´æ•°æ®æº¢å‡ºï¼Œä¼´éšç€ä»èŠ‚ç‚¹åç§»é‡è¶Šç•Œï¼Œå¯¼è‡´å…¨é‡å¤åˆ¶ã€‚æœ‰å¯èƒ½ä¼šå¯¼è‡´åå¤çš„å…¨é‡å¤åˆ¶ã€‚
è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°ï¼šrepl-backlog-size
è®¾ç½®å»ºè®®ï¼šæµ‹è¯•ä¸»èŠ‚ç‚¹è¿æ¥ä»èŠ‚ç‚¹çš„æ—¶é—´ï¼Œè·å–ä¸»èŠ‚ç‚¹æ¯ç§’å¹³å‡äº§ç”Ÿçš„å‘½ä»¤æ€»é‡write_size_per_second
å¤åˆ¶ç¼“å†²åŒºç©ºé—´è®¾ç½®  =   2  *  ä¸»ä»è¿æ¥æ—¶é—´   *   ä¸»èŠ‚ç‚¹æ¯ç§’äº§ç”Ÿçš„æ•°æ®æ€»é‡

### 3. é¢‘ç¹çš„ç½‘è·¯ä¸­æ–­

ç”±äºä¸»èŠ‚ç‚¹çš„cpuå ç”¨è¿‡é«˜ï¼Œæˆ–è€…ä»èŠ‚ç‚¹é¢‘ç¹è¿æ¥ã€‚å‡ºç°è¿™ç§æƒ…å†µé€ æˆçš„ç»“æœå°±æ˜¯ä¸»èŠ‚ç‚¹å„ç§èµ„æºè¢«ä¸¥é‡å ç”¨ï¼Œå…¶ä¸­åŒ…æ‹¬ä½†ä¸é™äºç¼“å†²åŒºï¼Œå®½å¸¦ï¼Œè¿æ¥ç­‰ã€‚
ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸»èŠ‚ç‚¹èµ„æºè¢«ä¸¥é‡å ç”¨ï¼Ÿ
åœ¨å¿ƒè·³æœºåˆ¶ä¸­ï¼Œä»èŠ‚ç‚¹æ¯ç§’ä¼šå‘é€ä¸€ä¸ªæŒ‡ä»¤replconf  ackæŒ‡ä»¤åˆ°ä¸»èŠ‚ç‚¹ã€‚
ä»èŠ‚ç‚¹æ‰§è¡Œäº†æ…¢æŸ¥è¯¢ï¼Œå ç”¨å¤§é‡çš„cpu
ä¸»èŠ‚ç‚¹æ¯ç§’è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•°replicationCronï¼Œç„¶åä»èŠ‚ç‚¹é•¿æ—¶é—´æ²¡æœ‰ç›¸åº”ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

- è®¾ç½®ä»èŠ‚ç‚¹è¶…æ—¶é‡Šæ”¾
- è®¾ç½®å‚æ•°ï¼šrepl-timeout
- è¿™ä¸ªå‚æ•°é»˜è®¤ä¸º60ç§’ã€‚è¶…è¿‡60ç§’ï¼Œé‡Šæ”¾slaveã€‚

### 4. æ•°æ®ä¸ä¸€è‡´é—®é¢˜

ç”±äºç½‘ç»œå› ç´ ï¼Œå¤šä¸ªä»èŠ‚ç‚¹çš„æ•°æ®ä¼šä¸ä¸€è‡´ã€‚è¿™ä¸ªå› ç´ æ˜¯æ²¡æœ‰åŠæ³•é¿å…çš„ã€‚

**å…³äºè¿™ä¸ªé—®é¢˜ç»™å‡ºä¿©ä¸ªè§£å†³æ–¹æ¡ˆï¼š**

- ç¬¬ä¸€ä¸ªæ•°æ®éœ€è¦é«˜åº¦ä¸€è‡´é…ç½®ä¸€å°redisæœåŠ¡å™¨ï¼Œè¯»å†™éƒ½ç”¨ä¸€å°æœåŠ¡å™¨ï¼Œè¿™ç§æ–¹å¼ä»…é™äºå°‘é‡æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®éœ€é«˜åº¦ä¸€ç›´ã€‚
- ç¬¬äºŒä¸ªç›‘æ§ä¸»ä»èŠ‚ç‚¹çš„åç§»é‡ï¼Œå¦‚æœä»èŠ‚ç‚¹çš„å»¶è¿Ÿè¿‡å¤§ï¼Œæš‚æ—¶å±è”½å®¢æˆ·ç«¯å¯¹è¯¥ä»èŠ‚ç‚¹çš„è®¿é—®ã€‚è®¾ç½®å‚æ•°ä¸ºslave-serve-stale-data  yes|noã€‚  è¿™ä¸ªå‚æ•°ä¸€ä½†è®¾ç½®å°±åªèƒ½å“åº”info  slaveofç­‰å°‘æ•°å‘½ä»¤ã€‚

**5. ä»èŠ‚ç‚¹æ•…éšœ**

è¿™ä¸ªé—®é¢˜ç›´æ¥åœ¨å®¢æˆ·ç«¯ç»´æŠ¤ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ï¼Œå½“ä»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œåˆ‡æ¢åˆ°å…¶ä»–èŠ‚ç‚¹è¿›è¡Œå·¥ä½œï¼Œè¿™ä¸ªé—®é¢˜åœ¨åè¾¹é›†ç¾¤ä¼šè¯´åˆ°ã€‚

## å. æ€»ç»“

æœ¬æ–‡ä¸»è¦è®²è§£äº†ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶ã€ä¸»ä»å¤åˆ¶å·¥ä½œçš„ä¸‰å¤§é˜¶æ®µä»¥åŠå·¥ä½œæµç¨‹ã€éƒ¨åˆ†å¤åˆ¶çš„ä¸‰å¤§æ ¸å¿ƒã€‚å‘½ä»¤ä¼ æ’­é˜¶æ®µçš„å¿ƒè·³æœºåˆ¶ã€‚æœ€åè¯´æ˜äº†ä¸»ä»å¤åˆ¶å¸¸è§é—®é¢˜ã€‚


>ä½œè€…ï¼šåŸæ¥æ˜¯å’”å’”
>é“¾æ¥ï¼šhttps://juejin.im/post/5ed5ccb66fb9a047df7ca9a4
>æ¥æºï¼šæ˜é‡‘
>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚




















# Redisä¸­å†…å­˜æ·˜æ±°ç®—æ³•å®ç°

Redisçš„`maxmemory`æ”¯æŒçš„å†…å­˜æ·˜æ±°æœºåˆ¶ä½¿å¾—å…¶æˆä¸ºä¸€ç§æœ‰æ•ˆçš„ç¼“å­˜æ–¹æ¡ˆï¼Œæˆä¸ºmemcachedçš„æœ‰æ•ˆæ›¿ä»£æ–¹æ¡ˆã€‚

å½“å†…å­˜è¾¾åˆ°`maxmemory`åï¼ŒRedisä¼šæŒ‰ç…§`maxmemory-policy`å¯åŠ¨æ·˜æ±°ç­–ç•¥ã€‚

Redis 3.0ä¸­å·²æœ‰æ·˜æ±°æœºåˆ¶ï¼š

- noeviction
- allkeys-lru
- volatile-lru
- allkeys-random
- volatile-random
- volatile-ttl

| maxmemory-policy	| å«ä¹‰	|ç‰¹æ€§ |
| ----- | ----- | ----- |
noeviction	|ä¸æ·˜æ±°	|å†…å­˜è¶…é™åå†™å‘½ä»¤ä¼šè¿”å›é”™è¯¯(å¦‚OOM, delå‘½ä»¤é™¤å¤–)	
allkeys-lru	|æ‰€æœ‰keyçš„LRUæœºåˆ¶	åœ¨|æ‰€æœ‰keyä¸­æŒ‰ç…§æœ€è¿‘æœ€å°‘ä½¿ç”¨LRUåŸåˆ™å‰”é™¤keyï¼Œé‡Šæ”¾ç©ºé—´	
volatile-lru	|æ˜“å¤±keyçš„LRU	|ä»…ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´keyèŒƒå›´å†…çš„LRU(å¦‚å‡ä¸ºè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåˆ™ä¸ä¼šæ·˜æ±°)	
allkeys-random	|æ‰€æœ‰keyéšæœºæ·˜æ±°|	ä¸€è§†åŒä»ï¼Œéšæœº	
volatile-random	|æ˜“å¤±Keyçš„éšæœº	|ä»…è®¾ç½®è¿‡æœŸæ—¶é—´keyèŒƒå›´å†…çš„éšæœº	
volatile-ttl	|æ˜“å¤±keyçš„TTLæ·˜æ±°|	æŒ‰æœ€å°TTLçš„keyä¼˜å…ˆæ·˜æ±°

å…¶ä¸­LRU(less recently used)ç»å…¸æ·˜æ±°ç®—æ³•åœ¨Rediså®ç°ä¸­æœ‰ä¸€å®šä¼˜åŒ–è®¾è®¡ï¼Œæ¥ä¿è¯å†…å­˜å ç”¨ä¸å®é™…æ•ˆæœçš„å¹³è¡¡ï¼Œè¿™ä¹Ÿä½“ç°äº†å·¥ç¨‹åº”ç”¨æ˜¯ç©ºé—´ä¸æ—¶é—´çš„å¹³è¡¡æ€§ã€‚

> PSï¼šå€¼å¾—æ³¨æ„çš„ï¼Œåœ¨ä¸»ä»å¤åˆ¶æ¨¡å¼Replicationä¸‹ï¼Œä»èŠ‚ç‚¹è¾¾åˆ°maxmemoryæ—¶ä¸ä¼šæœ‰ä»»ä½•å¼‚å¸¸æ—¥å¿—ä¿¡æ¯ï¼Œä½†ç°è±¡ä¸ºå¢é‡æ•°æ®æ— æ³•åŒæ­¥è‡³ä»èŠ‚ç‚¹ã€‚

## Redis 3.0ä¸­è¿‘ä¼¼LRUç®—æ³•

Redisä¸­LRUæ˜¯è¿‘ä¼¼LRUå®ç°ï¼Œå¹¶ä¸èƒ½å–å‡ºç†æƒ³LRUç†è®ºä¸­æœ€ä½³æ·˜æ±°Keyï¼Œè€Œæ˜¯é€šè¿‡ä»å°éƒ¨åˆ†é‡‡æ ·åçš„æ ·æœ¬ä¸­æ·˜æ±°å±€éƒ¨LRUé”®ã€‚

Redis 3.0ä¸­è¿‘ä¼¼LRUç®—æ³•é€šè¿‡å¢åŠ å¾…æ·˜æ±°å…ƒç´ æ± çš„æ–¹å¼è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæœ€ç»ˆå®ç°ä¸ç²¾ç¡®LRUéå¸¸æ¥è¿‘çš„è¡¨ç°ã€‚

> ç²¾ç¡®LRUä¼šå ç”¨è¾ƒå¤§å†…å­˜è®°å½•å†å²çŠ¶æ€ï¼Œè€Œè¿‘ä¼¼LRUåˆ™ç”¨è¾ƒå°å†…å­˜æ”¯å‡ºå®ç°è¿‘ä¼¼æ•ˆæœã€‚

ä»¥ä¸‹æ˜¯ç†è®ºLRUå’Œè¿‘ä¼¼LRUçš„æ•ˆæœå¯¹æ¯”ï¼š

![](../images/lru_comparison.png)

- æŒ‰æ—¶é—´é¡ºåºæ¥å…¥ä¸åŒé”®ï¼Œæ­¤æ—¶æœ€æ—©å†™å…¥ä¹Ÿå°±æ˜¯æœ€ä½³æ·˜æ±°é”®
- æµ…ç°è‰²åŒºåŸŸï¼šè¢«æ·˜æ±°çš„é”®
- ç°è‰²åŒºåŸŸï¼šæœªè¢«æ·˜æ±°çš„é”®
- ç»¿è‰²åŒºåŸŸï¼šæ–°å¢å†™å…¥çš„é”®

æ€»ç»“å›¾ä¸­å±•ç¤ºè§„å¾‹ï¼Œ

- å›¾1Theoretical LRUç¬¦åˆé¢„æœŸï¼šæœ€æ—©å†™å…¥é”®é€æ­¥è¢«æ·˜æ±°
- å›¾2Approx LRU Redis 3.0 10 samplesï¼šRedis 3.0ä¸­è¿‘ä¼¼LRUç®—æ³•(é‡‡æ ·å€¼ä¸º10)
- å›¾3Approx LRU Redis 2.8 5 samplesï¼šRedis 2.8ä¸­è¿‘ä¼¼LRUç®—æ³•(é‡‡æ ·å€¼ä¸º5)
- å›¾4Approx LRU Redis 3.0 5 samplesï¼šRedis 3.0ä¸­è¿‘ä¼¼LRUç®—æ³•(é‡‡æ ·å€¼ä¸º5)

ç»“è®ºï¼š

- é€šè¿‡å›¾4å’Œå›¾3å¯¹æ¯”ï¼šå¾—å‡ºç›¸åŒé‡‡æ ·å€¼ä¸‹ï¼Œ3.0æ¯”2.8çš„LRUæ·˜æ±°æœºåˆ¶æ›´æ¥è¿‘ç†è®ºLRU
- é€šè¿‡å›¾4å’Œå›¾2å¯¹æ¯”ï¼šå¾—å‡ºå¢åŠ é‡‡æ ·å€¼ï¼Œåœ¨3.0ä¸­å°†è¿›ä¸€æ­¥æ”¹å–„LRUæ·˜æ±°æ•ˆæœé€¼è¿‘ç†è®ºLRU
- å¯¹æ¯”å›¾2å’Œå›¾1ï¼šåœ¨3.0ä¸­é‡‡æ ·å€¼ä¸º10æ—¶ï¼Œæ•ˆæœéå¸¸æ¥è¿‘ç†è®ºLRU

é‡‡æ ·å€¼è®¾ç½®é€šè¿‡maxmemory-samplesæŒ‡å®šï¼Œå¯é€šè¿‡CONFIG SET maxmemory-samples <count>åŠ¨æ€è®¾ç½®ï¼Œä¹Ÿå¯å¯åŠ¨é…ç½®ä¸­æŒ‡å®šmaxmemory-samples <count>

æºç è§£æ

```cgo
int freeMemoryIfNeeded(void){
    while (mem_freed < mem_tofree) {
        if (server.maxmemory_policy == REDIS_MAXMEMORY_NO_EVICTION)
        return REDIS_ERR; /* We need to free memory, but policy forbids. */

        if (server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_LRU ||
                server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_RANDOM)
            {......}
        /* volatile-random and allkeys-random policy */
        if (server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_RANDOM ||
                server.maxmemory_policy == REDIS_MAXMEMORY_VOLATILE_RANDOM)
            {......}
        /* volatile-lru and allkeys-lru policy */
        else if (server.maxmemory_policy == REDIS_MAXMEMORY_ALLKEYS_LRU ||
            server.maxmemory_policy == REDIS_MAXMEMORY_VOLATILE_LRU)
        {
            // æ·˜æ±°æ± å‡½æ•°
            evictionPoolPopulate(dict, db->dict, db->eviction_pool);
            while(bestkey == NULL) {
                evictionPoolPopulate(dict, db->dict, db->eviction_pool);
                // ä»åå‘å‰é€ä¸€æ·˜æ±°
                for (k = REDIS_EVICTION_POOL_SIZE-1; k >= 0; k--) {
                    if (pool[k].key == NULL) continue;
                    de = dictFind(dict,pool[k].key); // å®šä½ç›®æ ‡

                    /* Remove the entry from the pool. */
                    sdsfree(pool[k].key);
                    /* Shift all elements on its right to left. */
                    memmove(pool+k,pool+k+1,
                        sizeof(pool[0])*(REDIS_EVICTION_POOL_SIZE-k-1));
                    /* Clear the element on the right which is empty
                     * since we shifted one position to the left.  */
                    pool[REDIS_EVICTION_POOL_SIZE-1].key = NULL;
                    pool[REDIS_EVICTION_POOL_SIZE-1].idle = 0;

                    /* If the key exists, is our pick. Otherwise it is
                     * a ghost and we need to try the next element. */
                    if (de) {
                        bestkey = dictGetKey(de); // ç¡®å®šåˆ é™¤é”®
                        break;
                    } else {
                        /* Ghost... */
                        continue;
                    }
                }
            }
        }
        /* volatile-ttl */
        else if (server.maxmemory_policy == EDIS_MAXMEMORY_VOLATILE_TTL) {......}

        // æœ€ç»ˆé€‰å®šå¾…åˆ é™¤é”®bestkey
        if (bestkey) {
            long long delta;
            robj *keyobj = createStringObject(bestkey,sdslenbestkey)); // ç›®æ ‡å¯¹è±¡
            propagateExpire(db,keyobj);
            latencyStartMonitor(eviction_latency); // å»¶è¿Ÿç›‘æ§å¼€å§‹
            dbDelete(db,keyobj); // ä»dbåˆ é™¤å¯¹è±¡
            latencyEndMonitor(eviction_latency);// å»¶è¿Ÿç›‘æ§ç»“æŸ
            latencyAddSampleIfNeeded("eviction-del",iction_latency); // å»¶è¿Ÿé‡‡æ ·
            latencyRemoveNestedEvent(latency,eviction_latency);
            delta -= (long long) zmalloc_used_memory();
            mem_freed += delta; // é‡Šæ”¾å†…å­˜è®¡æ•°
            server.stat_evictedkeys++; // æ·˜æ±°keyè®¡æ•°ï¼Œinfoä¸­å¯è§
            notifyKeyspaceEvent(REDIS_NOTIFY_EVICTED, "evicted", keyobj, db->id); // äº‹ä»¶é€šçŸ¥
            decrRefCount(keyobj); // å¼•ç”¨è®¡æ•°æ›´æ–°
            keys_freed++;
            // é¿å…åˆ é™¤è¾ƒå¤šé”®å¯¼è‡´çš„ä¸»ä»å»¶è¿Ÿï¼Œåœ¨å¾ªç¯å†…åŒæ­¥
            if (slaves) flushSlavesOutputBuffers();
        }
    }
}
```


## Redis 4.0ä¸­æ–°çš„LFUç®—æ³•

ä»Redis4.0å¼€å§‹ï¼Œæ–°å¢LFUæ·˜æ±°æœºåˆ¶ï¼Œæä¾›æ›´å¥½ç¼“å­˜å‘½ä¸­ç‡ã€‚LFU(Least Frequently Used)é€šè¿‡è®°å½•é”®ä½¿ç”¨é¢‘ç‡æ¥å®šä½æœ€å¯èƒ½æ·˜æ±°çš„é”®ã€‚

å¯¹æ¯”LRUä¸LFUçš„å·®åˆ«ï¼š

- åœ¨LRUä¸­ï¼ŒæŸä¸ªé”®å¾ˆå°‘è¢«è®¿é—®ï¼Œä½†åœ¨åˆšåˆšè¢«è®¿é—®åå…¶è¢«æ·˜æ±°æ¦‚ç‡å¾ˆä½ï¼Œä»è€Œå‡ºç°è¿™ç±»å¼‚å¸¸æŒç»­å­˜åœ¨çš„ç¼“å­˜ï¼›ç›¸å¯¹çš„ï¼Œå…¶ä»–å¯èƒ½è¢«è®¿é—®çš„é”®ä¼šè¢«æ·˜æ±°
- è€ŒLFUä¸­ï¼ŒæŒ‰è®¿é—®é¢‘æ¬¡æ·˜æ±°æœ€å°‘è¢«è®¿é—®çš„é”®

Redis 4.0ä¸­æ–°å¢ä¸¤ç§LFUæ·˜æ±°æœºåˆ¶ï¼š

- volatile-lfuï¼šè®¾ç½®è¿‡æœŸæ—¶é—´çš„é”®æŒ‰LFUæ·˜æ±°
- allkeys-lfuï¼šæ‰€æœ‰é”®æŒ‰LFUæ·˜æ±°

LFUä½¿ç”¨Morris countersè®¡æ•°å™¨å ç”¨å°‘é‡ä½æ•°æ¥è¯„ä¼°æ¯ä¸ªå¯¹è±¡çš„è®¿é—®é¢‘ç‡ï¼Œå¹¶éšæ—¶é—´æ›´æ–°è®¡æ•°å™¨ã€‚æ­¤æœºåˆ¶å®ç°ä¸è¿‘ä¼¼LRUä¸­é‡‡æ ·ç±»ä¼¼ã€‚ä½†ä¸LRUä¸åŒï¼ŒLFUæä¾›æ˜ç¡®å‚æ•°æ¥æŒ‡å®šè®¡æ•°æ›´æ–°é¢‘ç‡ã€‚

- lfu-log-factorï¼š0-255ä¹‹é—´ï¼Œé¥±å’Œå› å­ï¼Œå€¼è¶Šå°ä»£è¡¨é¥±å’Œé€Ÿåº¦è¶Šå¿«
- lfu-decay-timeï¼šè¡°å‡å‘¨æœŸï¼Œå•ä½åˆ†é’Ÿï¼Œè®¡æ•°å™¨è¡°å‡çš„åˆ†é’Ÿæ•°

è¿™ä¸¤ä¸ªå› å­å½¢æˆä¸€ç§å¹³è¡¡ï¼Œé€šè¿‡å°‘é‡è®¿é—® VS å¤šæ¬¡è®¿é—® çš„è¯„ä»·æ ‡å‡†æœ€ç»ˆå½¢æˆå¯¹é”®é‡è¦æ€§çš„è¯„åˆ¤ã€‚

> åŸæ–‡ï¼š <http://fivezh.github.io/2019/01/10/Redis-LRU-algorithm/>










# RedisæŒä¹…åŒ–çš„åŸç†åŠä¼˜åŒ–

Redisä¸ºæŒä¹…åŒ–æä¾›äº†ä¸¤ç§æ–¹å¼ï¼š

- RDBï¼šåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”èƒ½å¯¹ä½ çš„æ•°æ®è¿›è¡Œå¿«ç…§å­˜å‚¨ã€‚
- AOFï¼šè®°å½•æ¯æ¬¡å¯¹æœåŠ¡å™¨å†™çš„æ“ä½œ,å½“æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ä¼šé‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤åŸå§‹çš„æ•°æ®ã€‚

æœ¬æ–‡å°†é€šè¿‡ä¸‹é¢å†…å®¹çš„ä»‹ç»ï¼Œå¸Œæœ›èƒ½å¤Ÿè®©å¤§å®¶æ›´å…¨é¢ã€æ¸…æ™°çš„è®¤è¯†è¿™ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼ŒåŒæ—¶ç†è§£è¿™ç§ä¿å­˜æ•°æ®çš„æ€è·¯ï¼Œåº”ç”¨äºè‡ªå·±çš„ç³»ç»Ÿè®¾è®¡ä¸­ã€‚

- æŒä¹…åŒ–çš„é…ç½®
- RDBä¸AOFæŒä¹…åŒ–çš„å·¥ä½œåŸç†
- å¦‚ä½•ä»æŒä¹…åŒ–ä¸­æ¢å¤æ•°æ®
- å…³äºæ€§èƒ½ä¸å®è·µå»ºè®®

## æŒä¹…åŒ–çš„é…ç½®

ä¸ºäº†ä½¿ç”¨æŒä¹…åŒ–çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“è¯¥å¦‚ä½•å¼€å¯æŒä¹…åŒ–çš„åŠŸèƒ½ã€‚

### RDBçš„æŒä¹…åŒ–é…ç½®

```bash
# æ—¶é—´ç­–ç•¥
save 900 1
save 300 10
save 60 10000

# æ–‡ä»¶åç§°
dbfilename dump.rdb

# æ–‡ä»¶ä¿å­˜è·¯å¾„
dir /home/work/app/redis/data/

# å¦‚æœæŒä¹…åŒ–å‡ºé”™ï¼Œä¸»è¿›ç¨‹æ˜¯å¦åœæ­¢å†™å…¥
stop-writes-on-bgsave-error yes

# æ˜¯å¦å‹ç¼©
rdbcompression yes

# å¯¼å…¥æ—¶æ˜¯å¦æ£€æŸ¥
rdbchecksum yes
```

é…ç½®å…¶å®éå¸¸ç®€å•ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹æŒä¹…åŒ–çš„æ—¶é—´ç­–ç•¥å…·ä½“æ˜¯ä»€ä¹ˆæ„æ€ã€‚

- save 900 1 è¡¨ç¤º900så†…å¦‚æœæœ‰1æ¡æ˜¯å†™å…¥å‘½ä»¤ï¼Œå°±è§¦å‘äº§ç”Ÿä¸€æ¬¡å¿«ç…§ï¼Œå¯ä»¥ç†è§£ä¸ºå°±è¿›è¡Œä¸€æ¬¡å¤‡ä»½
- save 300 10 è¡¨ç¤º300så†…æœ‰10æ¡å†™å…¥ï¼Œå°±äº§ç”Ÿå¿«ç…§

ä¸‹é¢çš„ç±»ä¼¼ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦é…ç½®è¿™ä¹ˆå¤šæ¡è§„åˆ™å‘¢ï¼Ÿå› ä¸ºRedisæ¯ä¸ªæ—¶æ®µçš„è¯»å†™è¯·æ±‚è‚¯å®šä¸æ˜¯å‡è¡¡çš„ï¼Œä¸ºäº†å¹³è¡¡æ€§èƒ½ä¸æ•°æ®å®‰å…¨ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±å®šåˆ¶ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘å¤‡ä»½ã€‚æ‰€ä»¥è¿™é‡Œå°±æ˜¯æ ¹æ®è‡ªèº«Rediså†™å…¥æƒ…å†µæ¥è¿›è¡Œåˆç†é…ç½®ã€‚

`stop-writes-on-bgsave-error yes` è¿™ä¸ªé…ç½®ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ä¸€é¡¹é…ç½®ï¼Œè¿™æ˜¯å½“å¤‡ä»½è¿›ç¨‹å‡ºé”™æ—¶ï¼Œä¸»è¿›ç¨‹å°±åœæ­¢æ¥å—æ–°çš„å†™å…¥æ“ä½œï¼Œæ˜¯ä¸ºäº†ä¿æŠ¤æŒä¹…åŒ–çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚å¦‚æœè‡ªå·±çš„ä¸šåŠ¡æœ‰å®Œå–„çš„ç›‘æ§ç³»ç»Ÿï¼Œå¯ä»¥ç¦æ­¢æ­¤é¡¹é…ç½®ï¼Œ å¦åˆ™è¯·å¼€å¯ã€‚

å…³äºå‹ç¼©çš„é…ç½® `rdbcompression yes` ï¼Œå»ºè®®æ²¡æœ‰å¿…è¦å¼€å¯ï¼Œæ¯•ç«ŸRedisæœ¬èº«å°±å±äºCPUå¯†é›†å‹æœåŠ¡å™¨ï¼Œå†å¼€å¯å‹ç¼©ä¼šå¸¦æ¥æ›´å¤šçš„CPUæ¶ˆè€—ï¼Œç›¸æ¯”ç¡¬ç›˜æˆæœ¬ï¼ŒCPUæ›´å€¼é’±ã€‚

å½“ç„¶å¦‚æœä½ æƒ³è¦ç¦ç”¨RDBé…ç½®ï¼Œä¹Ÿæ˜¯éå¸¸å®¹æ˜“çš„ï¼Œåªéœ€è¦åœ¨saveçš„æœ€åä¸€è¡Œå†™ä¸Šï¼š`save ""`

### AOFçš„é…ç½®

```bash

# æ˜¯å¦å¼€å¯aof
appendonly yes

# æ–‡ä»¶åç§°
appendfilename "appendonly.aof"

# åŒæ­¥æ–¹å¼
appendfsync everysec

# aofé‡å†™æœŸé—´æ˜¯å¦åŒæ­¥
no-appendfsync-on-rewrite no

# é‡å†™è§¦å‘é…ç½®
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# åŠ è½½aofæ—¶å¦‚æœæœ‰é”™å¦‚ä½•å¤„ç†
aof-load-truncated yes

# æ–‡ä»¶é‡å†™ç­–ç•¥
aof-rewrite-incremental-fsync yes
```

å¤åˆ¶ä»£ç è¿˜æ˜¯é‡ç‚¹è§£é‡Šä¸€äº›å…³é”®çš„é…ç½®ï¼š

`appendfsync everysec` å®ƒå…¶å®æœ‰ä¸‰ç§æ¨¡å¼:

- alwaysï¼šæŠŠæ¯ä¸ªå†™å‘½ä»¤éƒ½ç«‹å³åŒæ­¥åˆ°aofï¼Œå¾ˆæ…¢ï¼Œä½†æ˜¯å¾ˆå®‰å…¨
- everysecï¼šæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œæ˜¯æŠ˜ä¸­æ–¹æ¡ˆ
- noï¼šredisä¸å¤„ç†äº¤ç»™OSæ¥å¤„ç†ï¼Œéå¸¸å¿«ï¼Œä½†æ˜¯ä¹Ÿæœ€ä¸å®‰å…¨

ä¸€èˆ¬æƒ…å†µä¸‹éƒ½é‡‡ç”¨ `everysec` é…ç½®ï¼Œè¿™æ ·å¯ä»¥å…¼é¡¾é€Ÿåº¦ä¸å®‰å…¨ï¼Œæœ€å¤šæŸå¤±1sçš„æ•°æ®ã€‚

`aof-load-truncated yes` å¦‚æœè¯¥é…ç½®å¯ç”¨ï¼Œåœ¨åŠ è½½æ—¶å‘ç°aofå°¾éƒ¨ä¸æ­£ç¡®æ˜¯ï¼Œä¼šå‘å®¢æˆ·ç«¯å†™å…¥ä¸€ä¸ªlogï¼Œä½†æ˜¯ä¼šç»§ç»­æ‰§è¡Œï¼Œå¦‚æœè®¾ç½®ä¸º `no` ï¼Œå‘ç°é”™è¯¯å°±ä¼šåœæ­¢ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½é‡æ–°åŠ è½½ã€‚

## å·¥ä½œåŸç†

å…³äºåŸç†éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸»è¦æ¥çœ‹RDBä¸AOFæ˜¯å¦‚ä½•å®ŒæˆæŒä¹…åŒ–çš„ï¼Œä»–ä»¬çš„è¿‡ç¨‹æ˜¯å¦‚ä½•ã€‚

åœ¨ä»‹ç»åŸç†ä¹‹å‰å…ˆè¯´ä¸‹Rediså†…éƒ¨çš„å®šæ—¶ä»»åŠ¡æœºåˆ¶ï¼Œå®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„é¢‘ç‡å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é€šè¿‡ hz 10 æ¥è®¾ç½®ï¼ˆè¿™ä¸ªé…ç½®è¡¨ç¤º1så†…æ‰§è¡Œ10æ¬¡ï¼Œä¹Ÿå°±æ˜¯æ¯100msè§¦å‘ä¸€æ¬¡å®šæ—¶ä»»åŠ¡ï¼‰ã€‚è¯¥å€¼æœ€å¤§èƒ½å¤Ÿè®¾ç½®ä¸ºï¼š500ï¼Œä½†æ˜¯ä¸å»ºè®®è¶…è¿‡ï¼š100ï¼Œå› ä¸ºå€¼è¶Šå¤§è¯´æ˜æ‰§è¡Œé¢‘ç‡è¶Šé¢‘ç¹è¶Šé«˜ï¼Œè¿™ä¼šå¸¦æ¥CPUçš„æ›´å¤šæ¶ˆè€—ï¼Œä»è€Œå½±å“ä¸»è¿›ç¨‹è¯»å†™æ€§èƒ½ã€‚

å®šæ—¶ä»»åŠ¡ä½¿ç”¨çš„æ˜¯Redisè‡ªå·±å®ç°çš„ TimeEventï¼Œå®ƒä¼šå®šæ—¶å»è°ƒç”¨ä¸€äº›å‘½ä»¤å®Œæˆå®šæ—¶ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½ä¼šé˜»å¡ä¸»è¿›ç¨‹å¯¼è‡´Redisæ€§èƒ½ä¸‹é™ã€‚å› æ­¤æˆ‘ä»¬åœ¨é…ç½®Redisæ—¶ï¼Œä¸€å®šè¦æ•´ä½“è€ƒè™‘ä¸€äº›ä¼šè§¦å‘å®šæ—¶ä»»åŠ¡çš„é…ç½®ï¼Œæ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚

### RDBçš„åŸç†

åœ¨Redisä¸­RDBæŒä¹…åŒ–çš„è§¦å‘åˆ†ä¸ºä¸¤ç§ï¼šè‡ªå·±æ‰‹åŠ¨è§¦å‘ä¸Rediså®šæ—¶è§¦å‘ã€‚

**é’ˆå¯¹RDBæ–¹å¼çš„æŒä¹…åŒ–ï¼Œæ‰‹åŠ¨è§¦å‘å¯ä»¥ä½¿ç”¨ï¼š**

- saveï¼šä¼šé˜»å¡å½“å‰RedisæœåŠ¡å™¨ï¼Œç›´åˆ°æŒä¹…åŒ–å®Œæˆï¼Œçº¿ä¸Šåº”è¯¥ç¦æ­¢ä½¿ç”¨ã€‚
- bgsaveï¼šè¯¥è§¦å‘æ–¹å¼ä¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”±å­è¿›ç¨‹è´Ÿè´£æŒä¹…åŒ–è¿‡ç¨‹ï¼Œå› æ­¤é˜»å¡åªä¼šå‘ç”Ÿåœ¨forkå­è¿›ç¨‹çš„æ—¶å€™ã€‚

**è€Œè‡ªåŠ¨è§¦å‘çš„åœºæ™¯ä¸»è¦æ˜¯æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š**

- æ ¹æ®æˆ‘ä»¬çš„ `save m n` é…ç½®è§„åˆ™è‡ªåŠ¨è§¦å‘ï¼›
- ä»èŠ‚ç‚¹å…¨é‡å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹å‘é€`rdb`æ–‡ä»¶ç»™ä»èŠ‚ç‚¹å®Œæˆå¤åˆ¶æ“ä½œï¼Œä¸»èŠ‚ç‚¹ä¼šè§¦å‘ `bgsave`ï¼›
- æ‰§è¡Œ debug reload æ—¶ï¼›
- æ‰§è¡Œ  shutdownæ—¶ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯aofï¼Œä¹Ÿä¼šè§¦å‘ã€‚

ç”±äº save åŸºæœ¬ä¸ä¼šè¢«ä½¿ç”¨åˆ°ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ bgsave è¿™ä¸ªå‘½ä»¤æ˜¯å¦‚ä½•å®ŒæˆRDBçš„æŒä¹…åŒ–çš„ã€‚

![](../images/16530eac18882d66.jpg)

è¿™é‡Œæ³¨æ„çš„æ˜¯ fork æ“ä½œä¼šé˜»å¡ï¼Œå¯¼è‡´Redisè¯»å†™æ€§èƒ½ä¸‹é™ã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶å•ä¸ªRediså®ä¾‹çš„æœ€å¤§å†…å­˜ï¼Œæ¥å°½å¯èƒ½é™ä½Redisåœ¨forkæ—¶çš„äº‹ä»¶æ¶ˆè€—ã€‚ä»¥åŠä¸Šé¢æåˆ°çš„è‡ªåŠ¨è§¦å‘çš„é¢‘ç‡å‡å°‘forkæ¬¡æ•°ï¼Œæˆ–è€…ä½¿ç”¨æ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®è‡ªå·±çš„æœºåˆ¶æ¥å®ŒæˆæŒä¹…åŒ–ã€‚

### AOFçš„åŸç†

AOFçš„æ•´ä¸ªæµç¨‹å¤§ä½“æ¥çœ‹å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼Œä¸€æ­¥æ˜¯å‘½ä»¤çš„å®æ—¶å†™å…¥ï¼ˆå¦‚æœæ˜¯ `appendfsync everysec` é…ç½®ï¼Œä¼šæœ‰`1s`æŸè€—ï¼‰ï¼Œç¬¬äºŒæ­¥æ˜¯å¯¹aofæ–‡ä»¶çš„é‡å†™ã€‚
å¯¹äºå¢é‡è¿½åŠ åˆ°æ–‡ä»¶è¿™ä¸€æ­¥ä¸»è¦çš„æµç¨‹æ˜¯ï¼š`å‘½ä»¤å†™å…¥=>è¿½åŠ åˆ°aof_buf =>åŒæ­¥åˆ°aofç£ç›˜`ã€‚é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦å…ˆå†™å…¥bufåœ¨åŒæ­¥åˆ°ç£ç›˜å‘¢ï¼Ÿå¦‚æœå®æ—¶å†™å…¥ç£ç›˜ä¼šå¸¦æ¥éå¸¸é«˜çš„ç£ç›˜IOï¼Œå½±å“æ•´ä½“æ€§èƒ½ã€‚
aofé‡å†™æ˜¯ä¸ºäº†å‡å°‘aofæ–‡ä»¶çš„å¤§å°ï¼Œå¯ä»¥æ‰‹åŠ¨æˆ–è€…è‡ªåŠ¨è§¦å‘ï¼Œå…³äºè‡ªåŠ¨è§¦å‘çš„è§„åˆ™è¯·çœ‹ä¸Šé¢é…ç½®éƒ¨åˆ†ã€‚forkçš„æ“ä½œä¹Ÿæ˜¯å‘ç”Ÿåœ¨é‡å†™è¿™ä¸€æ­¥ï¼Œä¹Ÿæ˜¯è¿™é‡Œä¼šå¯¹ä¸»è¿›ç¨‹äº§ç”Ÿé˜»å¡ã€‚
æ‰‹åŠ¨è§¦å‘ï¼š `bgrewriteaof`ï¼Œè‡ªåŠ¨è§¦å‘ å°±æ˜¯æ ¹æ®é…ç½®è§„åˆ™æ¥è§¦å‘ï¼Œå½“ç„¶è‡ªåŠ¨è§¦å‘çš„æ•´ä½“æ—¶é—´è¿˜è·ŸRedisçš„å®šæ—¶ä»»åŠ¡é¢‘ç‡æœ‰å…³ç³»ã€‚

ä¸‹é¢æ¥çœ‹çœ‹é‡å†™çš„ä¸€ä¸ªæµç¨‹å›¾ï¼š

![](../images/16530eac181d94c8.jpg)

å¯¹äºä¸Šå›¾æœ‰å››ä¸ªå…³é”®ç‚¹è¡¥å……ä¸€ä¸‹ï¼š

åœ¨é‡å†™æœŸé—´ï¼Œç”±äºä¸»è¿›ç¨‹ä¾ç„¶åœ¨å“åº”å‘½ä»¤ï¼Œä¸ºäº†ä¿è¯æœ€ç»ˆå¤‡ä»½çš„å®Œæ•´æ€§ï¼›å› æ­¤å®ƒä¾ç„¶ä¼šå†™å…¥æ—§çš„AOF fileä¸­ï¼Œå¦‚æœé‡å†™å¤±è´¥ï¼Œèƒ½å¤Ÿä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚
ä¸ºäº†æŠŠé‡å†™æœŸé—´å“åº”çš„å†™å…¥ä¿¡æ¯ä¹Ÿå†™å…¥åˆ°æ–°çš„æ–‡ä»¶ä¸­ï¼Œå› æ­¤ä¹Ÿä¼šä¸ºå­è¿›ç¨‹ä¿ç•™ä¸€ä¸ªbufï¼Œé˜²æ­¢æ–°å†™çš„fileä¸¢å¤±æ•°æ®ã€‚
é‡å†™æ˜¯ç›´æ¥æŠŠå½“å‰å†…å­˜çš„æ•°æ®ç”Ÿæˆå¯¹åº”å‘½ä»¤ï¼Œå¹¶ä¸éœ€è¦è¯»å–è€çš„AOFæ–‡ä»¶è¿›è¡Œåˆ†æã€å‘½ä»¤åˆå¹¶ã€‚
AOFæ–‡ä»¶ç›´æ¥é‡‡ç”¨çš„æ–‡æœ¬åè®®ï¼Œä¸»è¦æ˜¯å…¼å®¹æ€§å¥½ã€è¿½åŠ æ–¹ä¾¿ã€å¯è¯»æ€§é«˜å¯è®¤ä¸ºä¿®æ”¹ä¿®å¤ã€‚


> ä¸èƒ½æ˜¯RDBè¿˜æ˜¯AOFéƒ½æ˜¯å…ˆå†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ rename å®Œæˆæ–‡ä»¶çš„æ›¿æ¢å·¥ä½œã€‚

## ä»æŒä¹…åŒ–ä¸­æ¢å¤æ•°æ®

æ•°æ®çš„å¤‡ä»½ã€æŒä¹…åŒ–åšå®Œäº†ï¼Œæˆ‘ä»¬å¦‚ä½•ä»è¿™äº›æŒä¹…åŒ–æ–‡ä»¶ä¸­æ¢å¤æ•°æ®å‘¢ï¼Ÿå¦‚æœä¸€å°æœåŠ¡å™¨ä¸Šæœ‰æ—¢æœ‰RDBæ–‡ä»¶ï¼Œåˆæœ‰AOFæ–‡ä»¶ï¼Œè¯¥åŠ è½½è°å‘¢ï¼Ÿ
å…¶å®æƒ³è¦ä»è¿™äº›æ–‡ä»¶ä¸­æ¢å¤æ•°æ®ï¼Œåªéœ€è¦é‡æ–°å¯åŠ¨Rediså³å¯ã€‚æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡å›¾æ¥äº†è§£è¿™ä¸ªæµç¨‹ï¼š

![](../images/16530eac182b1b66.jpg)


å¯åŠ¨æ—¶ä¼šå…ˆæ£€æŸ¥AOFæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±å°è¯•åŠ è½½RDBã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šä¼˜å…ˆåŠ è½½AOFå‘¢ï¼Ÿå› ä¸ºAOFä¿å­˜çš„æ•°æ®æ›´å®Œæ•´ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬çŸ¥é“AOFåŸºæœ¬ä¸Šæœ€å¤šæŸå¤±1sçš„æ•°æ®ã€‚

## æ€§èƒ½ä¸å®è·µ

é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬éƒ½çŸ¥é“RDBçš„å¿«ç…§ã€AOFçš„é‡å†™éƒ½éœ€è¦forkï¼Œè¿™æ˜¯ä¸€ä¸ªé‡é‡çº§æ“ä½œï¼Œä¼šå¯¹Redisé€ æˆé˜»å¡ã€‚å› æ­¤ä¸ºäº†ä¸å½±å“Redisä¸»è¿›ç¨‹å“åº”ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½é™ä½é˜»å¡ã€‚

- é™ä½forkçš„é¢‘ç‡ï¼Œæ¯”å¦‚å¯ä»¥æ‰‹åŠ¨æ¥è§¦å‘RDBç”Ÿæˆå¿«ç…§ã€ä¸AOFé‡å†™ï¼›
- æ§åˆ¶Redisæœ€å¤§ä½¿ç”¨å†…å­˜ï¼Œé˜²æ­¢forkè€—æ—¶è¿‡é•¿ï¼›
- ä½¿ç”¨æ›´ç‰›é€¼çš„ç¡¬ä»¶ï¼›
- åˆç†é…ç½®Linuxçš„å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé¿å…å› ä¸ºç‰©ç†å†…å­˜ä¸è¶³å¯¼è‡´forkå¤±è´¥ã€‚

åœ¨çº¿ä¸Šæˆ‘ä»¬åˆ°åº•è¯¥æ€ä¹ˆåšï¼Ÿæˆ‘æä¾›ä¸€äº›è‡ªå·±çš„å®è·µç»éªŒã€‚

- å¦‚æœRedisä¸­çš„æ•°æ®å¹¶ä¸æ˜¯ç‰¹åˆ«æ•æ„Ÿæˆ–è€…å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼é‡å†™ç”Ÿæˆæ•°æ®ï¼Œå¯ä»¥å…³é—­æŒä¹…åŒ–ï¼Œå¦‚æœä¸¢å¤±æ•°æ®å¯ä»¥é€šè¿‡å…¶å®ƒé€”å¾„è¡¥å›ï¼›
- è‡ªå·±åˆ¶å®šç­–ç•¥å®šæœŸæ£€æŸ¥Redisçš„æƒ…å†µï¼Œç„¶åå¯ä»¥æ‰‹åŠ¨è§¦å‘å¤‡ä»½ã€é‡å†™æ•°æ®ï¼›
- å•æœºå¦‚æœéƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œè¦é˜²æ­¢å¤šä¸ªæœºå™¨åŒæ—¶è¿è¡ŒæŒä¹…åŒ–ã€é‡å†™æ“ä½œï¼Œé˜²æ­¢å‡ºç°å†…å­˜ã€CPUã€IOèµ„æºç«äº‰ï¼Œè®©æŒä¹…åŒ–å˜ä¸ºä¸²è¡Œï¼›
- å¯ä»¥åŠ å…¥ä¸»ä»æœºå™¨ï¼Œåˆ©ç”¨ä¸€å°ä»æœºå™¨è¿›è¡Œå¤‡ä»½å¤„ç†ï¼Œå…¶å®ƒæœºå™¨æ­£å¸¸å“åº”å®¢æˆ·ç«¯çš„å‘½ä»¤ï¼›
- RDBæŒä¹…åŒ–ä¸AOFæŒä¹…åŒ–å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œé…åˆä½¿ç”¨ã€‚


> ä½œè€…ï¼šå¤§æ„šTalk
> é“¾æ¥ï¼šhttps://juejin.im/post/5b70dfcf518825610f1f5c16
> æ¥æºï¼šæ˜é‡‘
> è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚# Redis åŸºç¡€

## Rediså¸¸è§çš„æ•°æ®ç»“æ„ï¼Ÿ

Stringã€Hashã€Listã€Setã€SortedSetã€‚

### 1.String å­—ç¬¦ä¸²ç±»å‹

æ˜¯redisä¸­æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œä¸€ä¸ªkeyå¯¹åº”ä¸€ä¸ªvalueã€‚
    
Stringç±»å‹æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œæ„æ€æ˜¯ redis çš„ string å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ã€‚å¦‚æ•°å­—ï¼Œå­—ç¬¦ä¸²ï¼Œjpgå›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡ã€‚

**å®æˆ˜åœºæ™¯ï¼š**

1. ç¼“å­˜ï¼š ç»å…¸ä½¿ç”¨åœºæ™¯ï¼ŒæŠŠå¸¸ç”¨ä¿¡æ¯ï¼Œå­—ç¬¦ä¸²ï¼Œå›¾ç‰‡æˆ–è€…è§†é¢‘ç­‰ä¿¡æ¯æ”¾åˆ°redisä¸­ï¼Œredisä½œä¸ºç¼“å­˜å±‚ï¼ŒmysqlåšæŒä¹…åŒ–å±‚ï¼Œé™ä½mysqlçš„è¯»å†™å‹åŠ›ã€‚
2. è®¡æ•°å™¨ï¼šredisæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªï¼ŒåŒæ—¶æ•°æ®å¯ä»¥ä¸€æ­¥è½åœ°åˆ°å…¶ä»–çš„æ•°æ®æºã€‚
3. sessionï¼šå¸¸è§æ–¹æ¡ˆspring session + rediså®ç°sessionå…±äº«

### 2.Hash ï¼ˆå“ˆå¸Œï¼‰

æ˜¯ä¸€ä¸ªMapmapï¼ŒæŒ‡å€¼æœ¬èº«åˆæ˜¯ä¸€ç§é”®å€¼å¯¹ç»“æ„ï¼Œå¦‚ `value={{field1,value1},......fieldN,valueN}}`

![](../images/1289934-20190621232209365-1000366002.png)

**å®æˆ˜åœºæ™¯ï¼š**

1.ç¼“å­˜ï¼š èƒ½ç›´è§‚ï¼Œç›¸æ¯”stringæ›´èŠ‚çœç©ºé—´ï¼Œçš„ç»´æŠ¤ç¼“å­˜ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯ï¼Œè§†é¢‘ä¿¡æ¯ç­‰ã€‚

###  3.é“¾è¡¨
 
List è¯´ç™½äº†å°±æ˜¯é“¾è¡¨ï¼ˆredis ä½¿ç”¨åŒç«¯é“¾è¡¨å®ç°çš„ Listï¼‰ï¼Œæ˜¯æœ‰åºçš„ï¼Œvalueå¯ä»¥é‡å¤ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡å–å‡ºå¯¹åº”çš„valueå€¼ï¼Œå·¦å³ä¸¤è¾¹éƒ½èƒ½è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ•°æ®ã€‚

![](../images/1289934-20190621233618769-504231907.png)

ä½¿ç”¨åˆ—è¡¨çš„æŠ€å·§

- lpush+lpop=Stack(æ ˆ)
- lpush+rpop=Queueï¼ˆé˜Ÿåˆ—ï¼‰
- lpush+ltrim=Capped Collectionï¼ˆæœ‰é™é›†åˆï¼‰
- lpush+brpop=Message Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

**å®æˆ˜åœºæ™¯ï¼š**

1.timelineï¼šä¾‹å¦‚å¾®åšçš„æ—¶é—´è½´ï¼Œæœ‰äººå‘å¸ƒå¾®åšï¼Œç”¨lpushåŠ å…¥æ—¶é—´è½´ï¼Œå±•ç¤ºæ–°çš„åˆ—è¡¨ä¿¡æ¯ã€‚

### 4.Set   é›†åˆ

é›†åˆç±»å‹ä¹Ÿæ˜¯ç”¨æ¥ä¿å­˜å¤šä¸ªå­—ç¬¦ä¸²çš„å…ƒç´ ï¼Œä½†å’Œåˆ—è¡¨ä¸åŒçš„æ˜¯é›†åˆä¸­  1. ä¸å…è®¸æœ‰é‡å¤çš„å…ƒç´ ï¼Œ2.é›†åˆä¸­çš„å…ƒç´ æ˜¯æ— åºçš„ï¼Œä¸èƒ½é€šè¿‡ç´¢å¼•ä¸‹æ ‡è·å–å…ƒç´ ï¼Œ3.æ”¯æŒé›†åˆé—´çš„æ“ä½œï¼Œå¯ä»¥å–å¤šä¸ªé›†åˆå–äº¤é›†ã€å¹¶é›†ã€å·®é›†ã€‚


![](../images/1289934-20190622001013515-677922001.png)

**å®æˆ˜åœºæ™¯;**

1. æ ‡ç­¾ï¼ˆtagï¼‰,ç»™ç”¨æˆ·æ·»åŠ æ ‡ç­¾ï¼Œæˆ–è€…ç”¨æˆ·ç»™æ¶ˆæ¯æ·»åŠ æ ‡ç­¾ï¼Œè¿™æ ·æœ‰åŒä¸€æ ‡ç­¾æˆ–è€…ç±»ä¼¼æ ‡ç­¾çš„å¯ä»¥ç»™æ¨èå…³æ³¨çš„äº‹æˆ–è€…å…³æ³¨çš„äººã€‚
2. ç‚¹èµï¼Œæˆ–ç‚¹è¸©ï¼Œæ”¶è—ç­‰ï¼Œå¯ä»¥æ”¾åˆ°setä¸­å®ç°

### 5.zset  æœ‰åºé›†åˆ

æœ‰åºé›†åˆå’Œé›†åˆæœ‰ç€å¿…ç„¶çš„è”ç³»ï¼Œä¿ç•™äº†é›†åˆä¸èƒ½æœ‰é‡å¤æˆå‘˜çš„ç‰¹æ€§ï¼ŒåŒºåˆ«æ˜¯ï¼Œæœ‰åºé›†åˆä¸­çš„å…ƒç´ æ˜¯å¯ä»¥æ’åºçš„ï¼Œå®ƒç»™æ¯ä¸ªå…ƒç´ è®¾ç½®ä¸€ä¸ªåˆ†æ•°ï¼Œä½œä¸ºæ’åºçš„ä¾æ®ã€‚

ï¼ˆæœ‰åºé›†åˆä¸­çš„å…ƒç´ ä¸å¯ä»¥é‡å¤ï¼Œä½†æ˜¯score åˆ†æ•° å¯ä»¥é‡å¤ï¼Œå°±å’Œä¸€ä¸ªç­é‡Œçš„åŒå­¦å­¦å·ä¸èƒ½é‡å¤ï¼Œä½†è€ƒè¯•æˆç»©å¯ä»¥ç›¸åŒï¼‰ã€‚


![](../images/1289934-20190622000959260-539243592.png)

**å®æˆ˜åœºæ™¯ï¼š**

1. æ’è¡Œæ¦œï¼šæœ‰åºé›†åˆç»å…¸ä½¿ç”¨åœºæ™¯ã€‚ä¾‹å¦‚å°è¯´è§†é¢‘ç­‰ç½‘ç«™éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„å°è¯´è§†é¢‘åšæ’è¡Œæ¦œï¼Œæ¦œå•å¯ä»¥æŒ‰ç…§ç”¨æˆ·å…³æ³¨æ•°ï¼Œæ›´æ–°æ—¶é—´ï¼Œå­—æ•°ç­‰æ‰“åˆ†ï¼Œåšæ’è¡Œã€‚



















### Kafka

1ã€Kafka ä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«ï¼Ÿ

https://mp.weixin.qq.com/s/gmzIcvYvig2cDIcHJAnDRg

2ã€Kafka é‡å¹³è¡¡æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

https://mp.weixin.qq.com/s/4DFup_NziFJ1xdc4bZnVcg

3ã€Kafka æ¶æ„ä½“ç³»

https://mp.weixin.qq.com/s/QF9b9vpncLS24xMzFkanTQ


### RabbitMQ

1ã€RabbitMQ é«˜é¢‘è€ƒé¢˜

https://mp.weixin.qq.com/s/XEMuc1QJX8TAe7_fqcmJBA

2ã€RabbitMQ è·Ÿ Kafka å¯¹æ¯”ä¸‹ï¼Œè¯´ä¸‹å¯¹ MQ 

https://mp.weixin.qq.com/s/XtMKQr7TaOjZkXgXZWh6lg<!-- TOC -->

- [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„)
    - [222.æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—-Pythonç‰ˆ](#222æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—-pythonç‰ˆ)
    - [223.æ±‚100ä»¥å†…çš„è´¨æ•°](#223æ±‚100ä»¥å†…çš„è´¨æ•°)
    - [224.æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²-Pythonå®ç°](#224æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²-pythonå®ç°)
    - [225.é€šè¿‡2ä¸ª5/6å‡å¾—æ°´å£¶ä»æ± å¡˜å¾—åˆ°3å‡æ°´](#225é€šè¿‡2ä¸ª56å‡å¾—æ°´å£¶ä»æ± å¡˜å¾—åˆ°3å‡æ°´)
    - [226.ä»€ä¹ˆæ˜¯MD5åŠ å¯†ï¼Œæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ](#226ä»€ä¹ˆæ˜¯md5åŠ å¯†æœ‰ä»€ä¹ˆç‰¹ç‚¹)
    - [227.ä»€ä¹ˆæ˜¯å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†](#227ä»€ä¹ˆæ˜¯å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†)
    - [228.å†’æ³¡æ’åºçš„æ€æƒ³ï¼Ÿ](#228å†’æ³¡æ’åºçš„æ€æƒ³)
    - [229.å¿«é€Ÿæ’åºçš„æ€æƒ³ï¼Ÿ](#229å¿«é€Ÿæ’åºçš„æ€æƒ³)
    - [230.å¦‚ä½•åˆ¤æ–­å•å‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰ç¯ï¼Ÿ](#230å¦‚ä½•åˆ¤æ–­å•å‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰ç¯)
    - [231.ä½ çŸ¥é“å“ªäº›æ’åºç®—æ³•ï¼ˆä¸€èˆ¬æ˜¯é€šè¿‡é—®é¢˜è€ƒç®—æ³•ï¼‰](#231ä½ çŸ¥é“å“ªäº›æ’åºç®—æ³•ä¸€èˆ¬æ˜¯é€šè¿‡é—®é¢˜è€ƒç®—æ³•)
    - [232.æ–æ³¢é‚£å¥‘æ•°åˆ—](#232æ–æ³¢é‚£å¥‘æ•°åˆ—)
    - [233.å¦‚ä½•ç¿»è½¬ä¸€ä¸ªå•é“¾è¡¨ï¼Ÿ](#233å¦‚ä½•ç¿»è½¬ä¸€ä¸ªå•é“¾è¡¨)
    - [234.é’è›™è·³å°é˜¶é—®é¢˜](#234é’è›™è·³å°é˜¶é—®é¢˜)
    - [235.ä¸¤æ•°ä¹‹å’Œ Two Sum](#235ä¸¤æ•°ä¹‹å’Œ-two-sum)
    - [236.æœç´¢æ—‹è½¬æ’åºæ•°ç»„ Search in Rotated Sorted Array](#236æœç´¢æ—‹è½¬æ’åºæ•°ç»„-search-in-rotated-sorted-array)
    - [237.Pythonå®ç°ä¸€ä¸ªStackçš„æ•°æ®ç»“æ„](#237pythonå®ç°ä¸€ä¸ªstackçš„æ•°æ®ç»“æ„)
    - [238.å†™ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾](#238å†™ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾)
    - [239.set ç”¨ in æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Œä¸ºä»€ä¹ˆï¼Ÿ](#239set-ç”¨-in-æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ä¸ºä»€ä¹ˆ)
    - [240.åˆ—è¡¨ä¸­æœ‰nä¸ªæ­£æ•´æ•°èŒƒå›´åœ¨[0ï¼Œ1000]ï¼Œè¿›è¡Œæ’åºï¼›](#240åˆ—è¡¨ä¸­æœ‰nä¸ªæ­£æ•´æ•°èŒƒå›´åœ¨01000è¿›è¡Œæ’åº)
    - [241.é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­æœ‰ç»„åˆå’Œç»§æ‰¿çš„æ–¹æ³•å®ç°æ–°çš„ç±»](#241é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­æœ‰ç»„åˆå’Œç»§æ‰¿çš„æ–¹æ³•å®ç°æ–°çš„ç±»)

<!-- /TOC -->

## æ•°æ®ç»“æ„
### 222.æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—-Pythonç‰ˆ

#### æ–¹æ³•ä¸€

```python
def majority_element(nums):
    nums.sort()
    return nums[len(nums) // 2]
```

#### æ–¹æ³•äºŒ

```python
from functools import reduce


def majority_element(nums):
    return reduce(lambda n, x: (n[0], n[1] + 1) if n[0] == x else ((x, 1) if n[1] - 1 < 0 else (n[0], n[1] - 1)), nums, (None, -1))[0]
```

#### æ–¹æ³•ä¸‰

```python
from collections import Counter


def majority_element(nums):
    return Counter(nums).most_common(1)[0][0]
```

#### æ–¹æ³•å››

```python
from random import choice


def majority_element(nums):
    length = len(nums) // 2
    while True:
        n = choice(nums)
        if nums.count(n) > length:
            return n
```

### 223.æ±‚100ä»¥å†…çš„è´¨æ•°
### 224.æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²-Pythonå®ç°
### 225.é€šè¿‡2ä¸ª5/6å‡å¾—æ°´å£¶ä»æ± å¡˜å¾—åˆ°3å‡æ°´
### 226.ä»€ä¹ˆæ˜¯MD5åŠ å¯†ï¼Œæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ
### 227.ä»€ä¹ˆæ˜¯å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†
### 228.å†’æ³¡æ’åºçš„æ€æƒ³ï¼Ÿ
### 229.å¿«é€Ÿæ’åºçš„æ€æƒ³ï¼Ÿ
### 230.å¦‚ä½•åˆ¤æ–­å•å‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰ç¯ï¼Ÿ
### 231.ä½ çŸ¥é“å“ªäº›æ’åºç®—æ³•ï¼ˆä¸€èˆ¬æ˜¯é€šè¿‡é—®é¢˜è€ƒç®—æ³•ï¼‰
### 232.æ–æ³¢é‚£å¥‘æ•°åˆ—

**æ•°åˆ—å®šä¹‰: **

f 0 = f 1 = 1
f n = f (n-1) + f (n-2)

#### æ ¹æ®å®šä¹‰

é€Ÿåº¦å¾ˆæ…¢ï¼Œå¦å¤–(æš´æ ˆæ³¨æ„ï¼âš ï¸ï¸ï¼‰ `O(fibonacci n)`

```python
def fibonacci(n):
    if n == 0 or n == 1:
        return 1
    return fibonacci(n - 1) + fibonacci(n - 2)
```

#### çº¿æ€§æ—¶é—´çš„

**çŠ¶æ€/å¾ªç¯**

```python
def fibonacci(n):
   a, b = 1, 1
   for _ in range(n):
       a, b = b, a + b
   return a
```

**é€’å½’**

```python
def fibonacci(n):
    def fib(n_, s):
        if n_ == 0:
            return s[0]
        a, b = s
        return fib(n_ - 1, (b, a + b))
    return fib(n, (1, 1))
```

**map(zipwith)**

```python
def fibs():
    yield 1
    fibs_ = fibs()
    yield next(fibs_)
    fibs__ = fibs()
    for fib in map(lambad a, b: a + b, fibs_, fibs__):
        yield fib
        
        
def fibonacci(n):
    fibs = fibs()
    for _ in range(n):
        next(fibs)
    return next(fibs)
```

#### Logarithmic

**çŸ©é˜µ**

```
import numpy as np
def fibonacci(n):
    return (np.matrix([[0, 1], [1, 1]]) ** n)[1, 1]
```

**ä¸æ˜¯çŸ©é˜µ**

```python
def fibonacci(n):
    def fib(n):
        if n == 0:
            return (1, 1)
        elif n == 1:
            return (1, 2)
        a, b = fib(n // 2 - 1)
        c = a + b
        if n % 2 == 0:
            return (a * a + b * b, c * c - a * a)
        return (c * c - a * a, b * b + c * c)
    return fib(n)[0]
```

### 233.å¦‚ä½•ç¿»è½¬ä¸€ä¸ªå•é“¾è¡¨ï¼Ÿ

```python
class Node:
    def __init__(self,data=None,next=None):
        self.data = data
        self.next = next
        
def rev(link):
    pre = link
    cur = link.next
    pre.next = None
    while cur:
        temp  = cur.next
        cur.next = pre
        pre = cur
        cur = tmp
    return pre

if __name__ == '__main__':
    link = Node(1,Node(2,Node(3,Node(4,Node(5,Node(6,Node7,Node(8.Node(9))))))))
    root = rev(link)
    while root:
        print(roo.data)
        root = root.next
```



### 234.é’è›™è·³å°é˜¶é—®é¢˜

ä¸€åªé’è›™è¦è·³ä¸Šnå±‚é«˜çš„å°é˜¶ï¼Œä¸€æ¬¡èƒ½è·³ä¸€çº§ï¼Œä¹Ÿå¯ä»¥è·³ä¸¤çº§ï¼Œè¯·é—®è¿™åªé’è›™æœ‰å¤šå°‘ç§è·³ä¸Šè¿™ä¸ªnå±‚å°é˜¶çš„æ–¹æ³•ï¼Ÿ

æ–¹æ³•1ï¼šé€’å½’

è®¾é’è›™è·³ä¸Šnçº§å°é˜¶æœ‰f(n)ç§æ–¹æ³•ï¼ŒæŠŠè¿™nç§æ–¹æ³•åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œç¬¬ä¸€ç§æœ€åä¸€æ¬¡è·³äº†ä¸€çº§å°é˜¶ï¼Œè¿™ç±»å…±æœ‰f(n-1)ç§ï¼Œç¬¬äºŒç§æœ€åä¸€æ¬¡è·³äº†ä¸¤çº§å°é˜¶ï¼Œè¿™ç§æ–¹æ³•å…±æœ‰f(n-2)ç§ï¼Œåˆ™å¾—å‡ºé€’æ¨å…¬å¼f(n)=f(n-1) + f(n-2),æ˜¾ç„¶f(1)=1,f(2)=2ï¼Œè¿™ç§æ–¹æ³•è™½ç„¶ä»£ç ç®€å•ï¼Œä½†æ•ˆç‡ä½ï¼Œä¼šè¶…å‡ºæ—¶é—´ä¸Šé™

```python
class Solution:
    def climbStairs(self,n):
        if n ==1:
            return 1
        elif n==2:
            return 2
        else:
            return self.climbStairs(n-1) + self.climbStairs(n-2)
```

æ–¹æ³•2ï¼šç”¨å¾ªç¯æ¥ä»£æ›¿é€’å½’

```python
class Solution:
    def climbStairs(self,n):
        if n==1 or n==2:
            return n
        a,b,c = 1,2,3
        for i in range(3,n+1):
            c = a+b
            a = b
            b = c
        return c
```

### 235.ä¸¤æ•°ä¹‹å’Œ Two Sum



### 236.æœç´¢æ—‹è½¬æ’åºæ•°ç»„ Search in Rotated Sorted Array
### 237.Pythonå®ç°ä¸€ä¸ªStackçš„æ•°æ®ç»“æ„
### 238.å†™ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾
### 239.set ç”¨ in æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Œä¸ºä»€ä¹ˆï¼Ÿ
### 240.åˆ—è¡¨ä¸­æœ‰nä¸ªæ­£æ•´æ•°èŒƒå›´åœ¨[0ï¼Œ1000]ï¼Œè¿›è¡Œæ’åºï¼›
### 241.é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­æœ‰ç»„åˆå’Œç»§æ‰¿çš„æ–¹æ³•å®ç°æ–°çš„ç±»
## åˆ¤æ–­å­—ç¬¦ä¸²ä¸­å­—ç¬¦æ˜¯å¦å…¨éƒ½ä¸åŒ

**é—®é¢˜æè¿°**

è¯·å®ç°ä¸€ä¸ªç®—æ³•ï¼Œç¡®å®šä¸€ä¸ªå­—ç¬¦ä¸²çš„æ‰€æœ‰å­—ç¬¦ã€æ˜¯å¦å…¨éƒ½ä¸åŒã€‘ã€‚è¿™é‡Œæˆ‘ä»¬è¦æ±‚ã€ä¸å…è®¸ä½¿ç”¨é¢å¤–çš„å­˜å‚¨ç»“æ„ã€‘ã€‚
ç»™å®šä¸€ä¸ªstringï¼Œè¯·è¿”å›ä¸€ä¸ªboolå€¼,trueä»£è¡¨æ‰€æœ‰å­—ç¬¦å…¨éƒ½ä¸åŒï¼Œfalseä»£è¡¨å­˜åœ¨ç›¸åŒçš„å­—ç¬¦ã€‚
ä¿è¯å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ä¸ºã€ASCIIå­—ç¬¦ã€‘ã€‚å­—ç¬¦ä¸²çš„é•¿åº¦å°äºç­‰äºã€3000ã€‘ã€‚


**è§£é¢˜æ€è·¯**

è¿™é‡Œæœ‰å‡ ä¸ªé‡ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯`ASCIIå­—ç¬¦`ï¼Œ`ASCIIå­—ç¬¦`å­—ç¬¦ä¸€å…±æœ‰256ä¸ªï¼Œå…¶ä¸­128ä¸ªæ˜¯å¸¸ç”¨å­—ç¬¦ï¼Œå¯ä»¥åœ¨é”®ç›˜ä¸Šè¾“å…¥ã€‚128ä¹‹åçš„æ˜¯é”®ç›˜ä¸Šæ— æ³•æ‰¾åˆ°çš„ã€‚

ç„¶åæ˜¯å…¨éƒ¨ä¸åŒï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦æ²¡æœ‰é‡å¤çš„ï¼Œå†æ¬¡ï¼Œä¸å‡†ä½¿ç”¨é¢å¤–çš„å‚¨å­˜ç»“æ„ï¼Œä¸”å­—ç¬¦ä¸²å°äºç­‰äº3000ã€‚

å¦‚æœå…è®¸å…¶ä»–é¢å¤–å‚¨å­˜ç»“æ„ï¼Œè¿™ä¸ªé¢˜ç›®å¾ˆå¥½åšã€‚å¦‚æœä¸å…è®¸çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨golangå†…ç½®çš„æ–¹å¼å®ç°ã€‚

**æºç å‚è€ƒ**

é€šè¿‡`strings.Count` å‡½æ•°åˆ¤æ–­ï¼š

```
func isUniqueString(s string) bool {
	if strings.Count(s,"") > 3000{
		return  false
	}
	for _,v := range s {
		if v > 127 {
			return false
		}
		if strings.Count(s,string(v)) > 1 {
			return false
		}
	}
	return true
}
```

é€šè¿‡`strings.Index`å’Œ`strings.LastIndex`å‡½æ•°åˆ¤æ–­ï¼š

```
func isUniqueString2(s string) bool {
	if strings.Count(s,"") > 3000{
		return  false
	}
	for k,v := range s {
		if v > 127 {
			return false
		}
		if strings.Index(s,string(v)) != k {
			return false
		}
	}
	return true
}
```

**æºç è§£æ**

ä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥å®ç°è¿™ä¸ªç®—æ³•ã€‚

ç¬¬ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨çš„æ˜¯golangå†…ç½®æ–¹æ³•`strings.Count`,å¯ä»¥ç”¨æ¥åˆ¤æ–­åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­åŒ…å«çš„å¦å¤–ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ•°é‡ã€‚

ç¬¬äºŒä¸ªæ–¹æ³•ä½¿ç”¨çš„æ˜¯golangå†…ç½®æ–¹æ³•`strings.Index`å’Œ`strings.LastIndex`ï¼Œç”¨æ¥åˆ¤æ–­æŒ‡å®šå­—ç¬¦ä¸²åœ¨å¦å¤–ä¸€ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•æœªçŸ¥ï¼Œåˆ†åˆ«æ˜¯ç¬¬ä¸€æ¬¡å‘ç°ä½ç½®å’Œæœ€åå‘ç°ä½ç½®ã€‚
## 1 çº¢é»‘æ ‘

çº¢é»‘æ ‘ä¸AVLçš„æ¯”è¾ƒï¼š

AVLæ˜¯ä¸¥æ ¼å¹³è¡¡æ ‘ï¼Œå› æ­¤åœ¨å¢åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæ ¹æ®ä¸åŒæƒ…å†µï¼Œæ—‹è½¬çš„æ¬¡æ•°æ¯”çº¢é»‘æ ‘è¦å¤šï¼›

çº¢é»‘æ˜¯ç”¨éä¸¥æ ¼çš„å¹³è¡¡æ¥æ¢å–å¢åˆ èŠ‚ç‚¹æ—¶å€™æ—‹è½¬æ¬¡æ•°çš„é™ä½ï¼›

æ‰€ä»¥ç®€å•è¯´ï¼Œå¦‚æœä½ çš„åº”ç”¨ä¸­ï¼Œæœç´¢çš„æ¬¡æ•°è¿œè¿œå¤§äºæ’å…¥å’Œåˆ é™¤ï¼Œé‚£ä¹ˆé€‰æ‹©AVLï¼Œå¦‚æœæœç´¢ï¼Œæ’å…¥åˆ é™¤æ¬¡æ•°å‡ ä¹å·®ä¸å¤šï¼Œåº”è¯¥é€‰æ‹©RBã€‚

çº¢é»‘æ ‘è¯¦è§£: https://xieguanglei.github.io/blog/post/red-black-tree.html

æ•™ä½ é€å½»äº†è§£çº¢é»‘æ ‘: https://github.com/julycoding/The-Art-Of-Programming-By-July/blob/master/ebook/zh/03.01.md<!-- TOC -->

- [ç³»ç»Ÿç¼–ç¨‹](#%e7%b3%bb%e7%bb%9f%e7%bc%96%e7%a8%8b)
  - [1.select,pollå’Œepoll](#1selectpoll%e5%92%8cepoll)
  - [2.è°ƒåº¦ç®—æ³•](#2%e8%b0%83%e5%ba%a6%e7%ae%97%e6%b3%95)
  - [3.æ­»é”](#3%e6%ad%bb%e9%94%81)
  - [4.ç¨‹åºç¼–è¯‘ä¸é“¾æ¥](#4%e7%a8%8b%e5%ba%8f%e7%bc%96%e8%af%91%e4%b8%8e%e9%93%be%e6%8e%a5)
  - [5.é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥](#5%e9%9d%99%e6%80%81%e9%93%be%e6%8e%a5%e5%92%8c%e5%8a%a8%e6%80%81%e9%93%be%e6%8e%a5)
  - [6.è™šæ‹Ÿå†…å­˜æŠ€æœ¯](#6%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98%e6%8a%80%e6%9c%af)
  - [7.åˆ†é¡µå’Œåˆ†æ®µ](#7%e5%88%86%e9%a1%b5%e5%92%8c%e5%88%86%e6%ae%b5)
  - [8.é¡µé¢ç½®æ¢ç®—æ³•](#8%e9%a1%b5%e9%9d%a2%e7%bd%ae%e6%8d%a2%e7%ae%97%e6%b3%95)
  - [9.è¾¹æ²¿è§¦å‘å’Œæ°´å¹³è§¦å‘](#9%e8%be%b9%e6%b2%bf%e8%a7%a6%e5%8f%91%e5%92%8c%e6%b0%b4%e5%b9%b3%e8%a7%a6%e5%8f%91)
  - [10.unixè¿›ç¨‹é—´é€šä¿¡æ–¹å¼(IPC)](#10unix%e8%bf%9b%e7%a8%8b%e9%97%b4%e9%80%9a%e4%bf%a1%e6%96%b9%e5%bc%8fipc)
  - [11.è¿›ç¨‹æ€»ç»“](#11%e8%bf%9b%e7%a8%8b%e6%80%bb%e7%bb%93)
  - [12.Pythonå¼‚æ­¥ä½¿ç”¨åœºæ™¯æœ‰é‚£äº›ï¼Ÿ](#12python%e5%bc%82%e6%ad%a5%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af%e6%9c%89%e9%82%a3%e4%ba%9b)
  - [13.å¤šçº¿ç¨‹å…±åŒæ“ä½œåŒä¸€ä¸ªæ•°æ®äº’æ–¥é”åŒæ­¥ï¼Ÿ](#13%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%85%b1%e5%90%8c%e6%93%8d%e4%bd%9c%e5%90%8c%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e4%ba%92%e6%96%a5%e9%94%81%e5%90%8c%e6%ad%a5)
  - [14.ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç«äº‰ï¼Ÿ](#14%e4%bb%80%e4%b9%88%e6%98%af%e5%a4%9a%e7%ba%bf%e7%a8%8b%e7%ab%9e%e4%ba%89)
  - [15.è¯·ä»‹ç»ä¸€ä¸‹Pythonçš„çº¿ç¨‹åŒæ­¥ï¼Ÿ](#15%e8%af%b7%e4%bb%8b%e7%bb%8d%e4%b8%80%e4%b8%8bpython%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5)
  - [16.è§£é‡Šä»¥ä¸‹ä»€ä¹ˆæ˜¯é”ï¼Œæœ‰å“ªå‡ ç§é”ï¼Ÿ](#16%e8%a7%a3%e9%87%8a%e4%bb%a5%e4%b8%8b%e4%bb%80%e4%b9%88%e6%98%af%e9%94%81%e6%9c%89%e5%93%aa%e5%87%a0%e7%a7%8d%e9%94%81)
  - [17.ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ](#17%e4%bb%80%e4%b9%88%e6%98%af%e6%ad%bb%e9%94%81)
  - [18.å¤šçº¿ç¨‹äº¤äº’è®¿é—®æ•°æ®ï¼Œå¦‚æœè®¿é—®åˆ°äº†å°±ä¸è®¿é—®äº†ï¼Ÿ](#18%e5%a4%9a%e7%ba%bf%e7%a8%8b%e4%ba%a4%e4%ba%92%e8%ae%bf%e9%97%ae%e6%95%b0%e6%8d%ae%e5%a6%82%e6%9e%9c%e8%ae%bf%e9%97%ae%e5%88%b0%e4%ba%86%e5%b0%b1%e4%b8%8d%e8%ae%bf%e9%97%ae%e4%ba%86)
  - [19.ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Œä»€ä¹ˆæ˜¯äº’æ–¥é”ï¼Ÿ](#19%e4%bb%80%e4%b9%88%e6%98%af%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e4%bb%80%e4%b9%88%e6%98%af%e4%ba%92%e6%96%a5%e9%94%81)
  - [20.è¯´è¯´ä¸‹é¢å‡ ä¸ªæ¦‚å¿µï¼šåŒæ­¥ï¼Œå¼‚æ­¥ï¼Œé˜»å¡ï¼Œéé˜»å¡ï¼Ÿ](#20%e8%af%b4%e8%af%b4%e4%b8%8b%e9%9d%a2%e5%87%a0%e4%b8%aa%e6%a6%82%e5%bf%b5%e5%90%8c%e6%ad%a5%e5%bc%82%e6%ad%a5%e9%98%bb%e5%a1%9e%e9%9d%9e%e9%98%bb%e5%a1%9e)
  - [21.ä»€ä¹ˆæ˜¯åƒµå°¸è¿›ç¨‹å’Œå­¤å„¿è¿›ç¨‹ï¼Ÿæ€ä¹ˆé¿å…åƒµå°¸è¿›ç¨‹ï¼Ÿ](#21%e4%bb%80%e4%b9%88%e6%98%af%e5%83%b5%e5%b0%b8%e8%bf%9b%e7%a8%8b%e5%92%8c%e5%ad%a4%e5%84%bf%e8%bf%9b%e7%a8%8b%e6%80%8e%e4%b9%88%e9%81%bf%e5%85%8d%e5%83%b5%e5%b0%b8%e8%bf%9b%e7%a8%8b)
  - [22.pythonä¸­è¿›ç¨‹ä¸çº¿ç¨‹çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ](#22python%e4%b8%ad%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b%e7%9a%84%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af)
  - [23.çº¿ç¨‹æ˜¯å¹¶å‘è¿˜æ˜¯å¹¶è¡Œï¼Œè¿›ç¨‹æ˜¯å¹¶å‘è¿˜æ˜¯å¹¶è¡Œï¼Ÿ](#23%e7%ba%bf%e7%a8%8b%e6%98%af%e5%b9%b6%e5%8f%91%e8%bf%98%e6%98%af%e5%b9%b6%e8%a1%8c%e8%bf%9b%e7%a8%8b%e6%98%af%e5%b9%b6%e5%8f%91%e8%bf%98%e6%98%af%e5%b9%b6%e8%a1%8c)
  - [24.å¹¶è¡Œï¼ˆparallelï¼‰å’Œå¹¶å‘ï¼ˆconcurrencyï¼‰?](#24%e5%b9%b6%e8%a1%8cparallel%e5%92%8c%e5%b9%b6%e5%8f%91concurrency)
  - [25.IOå¯†é›†å‹å’ŒCPUå¯†é›†å‹åŒºåˆ«ï¼Ÿ](#25io%e5%af%86%e9%9b%86%e5%9e%8b%e5%92%8ccpu%e5%af%86%e9%9b%86%e5%9e%8b%e5%8c%ba%e5%88%ab)
  - [26.python asyncioçš„åŸç†ï¼Ÿ](#26python-asyncio%e7%9a%84%e5%8e%9f%e7%90%86)
  - [27.è°ˆè°ˆä½ å¯¹å¤šè¿›ç¨‹ï¼Œå¤šçº¿ç¨‹ï¼Œä»¥åŠåç¨‹çš„ç†è§£ï¼Œé¡¹ç›®æ˜¯å¦ç”¨ï¼Ÿ](#27%e8%b0%88%e8%b0%88%e4%bd%a0%e5%af%b9%e5%a4%9a%e8%bf%9b%e7%a8%8b%e5%a4%9a%e7%ba%bf%e7%a8%8b%e4%bb%a5%e5%8f%8a%e5%8d%8f%e7%a8%8b%e7%9a%84%e7%90%86%e8%a7%a3%e9%a1%b9%e7%9b%ae%e6%98%af%e5%90%a6%e7%94%a8)

<!-- /TOC -->

## ç³»ç»Ÿç¼–ç¨‹

### 1.select,pollå’Œepoll

å…¶å®æ‰€æœ‰çš„I/Oéƒ½æ˜¯è½®è¯¢çš„æ–¹æ³•ï¼Œåªä¸è¿‡å®ç°çš„å±‚é¢ä¸åŒç½¢äº†ã€‚

è¿™ä¸ªé—®é¢˜å¯èƒ½æœ‰ç‚¹æ·±å…¥äº†ï¼Œä½†ç›¸ä¿¡èƒ½å›ç­”å‡ºè¿™ä¸ªé—®é¢˜æ˜¯å¯¹I/Oå¤šè·¯å¤ç”¨æœ‰å¾ˆå¥½çš„äº†è§£äº†ï¼Œå…¶ä¸­tornadoä½¿ç”¨çš„å°±æ˜¯ epollã€‚

[selec,pollå’ŒepollåŒºåˆ«æ€»ç»“](http://www.cnblogs.com/Anker/p/3265058.html)

åŸºæœ¬ä¸Šselectæœ‰3ä¸ªç¼ºç‚¹:

1. è¿æ¥æ•°å—é™
2. æŸ¥æ‰¾é…å¯¹é€Ÿåº¦æ…¢
3. æ•°æ®ç”±å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·æ€

pollæ”¹å–„äº†ç¬¬ä¸€ä¸ªç¼ºç‚¹ï¼Œepollæ”¹äº†ä¸‰ä¸ªç¼ºç‚¹ã€‚

å…³äºepollçš„: http://www.cnblogs.com/my_life/articles/3968782.html

### 2.è°ƒåº¦ç®—æ³•

1. å…ˆæ¥å…ˆæœåŠ¡(FCFS, First Come First Serve)
2. çŸ­ä½œä¸šä¼˜å…ˆ(SJF, Shortest Job First)
3. æœ€é«˜ä¼˜å…ˆæƒè°ƒåº¦(Priority Scheduling)
4. æ—¶é—´ç‰‡è½®è½¬(RR, Round Robin)
5. å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦(multilevel feedback queue scheduling)

å¸¸è§çš„è°ƒåº¦ç®—æ³•æ€»ç»“:http://www.jianshu.com/p/6edf8174c1eb

å®æ—¶è°ƒåº¦ç®—æ³•:

1. æœ€æ—©æˆªè‡³æ—¶é—´ä¼˜å…ˆ EDF
2. æœ€ä½æ¾å¼›åº¦ä¼˜å…ˆ LLF

### 3.æ­»é”

åŸå› :

1. ç«äº‰èµ„æº
2. ç¨‹åºæ¨è¿›é¡ºåºä¸å½“

å¿…è¦æ¡ä»¶:

1. äº’æ–¥æ¡ä»¶
2. è¯·æ±‚å’Œä¿æŒæ¡ä»¶
3. ä¸å‰¥å¤ºæ¡ä»¶
4. ç¯è·¯ç­‰å¾…æ¡ä»¶

å¤„ç†æ­»é”åŸºæœ¬æ–¹æ³•:

1. é¢„é˜²æ­»é”(æ‘’å¼ƒé™¤1ä»¥å¤–çš„æ¡ä»¶)
2. é¿å…æ­»é”(é“¶è¡Œå®¶ç®—æ³•)
3. æ£€æµ‹æ­»é”(èµ„æºåˆ†é…å›¾)
4. è§£é™¤æ­»é”
   1. å‰¥å¤ºèµ„æº
   2. æ’¤é”€è¿›ç¨‹

æ­»é”æ¦‚å¿µå¤„ç†ç­–ç•¥è¯¦ç»†ä»‹ç»:https://wizardforcel.gitbooks.io/wangdaokaoyan-os/content/10.html

### 4.ç¨‹åºç¼–è¯‘ä¸é“¾æ¥

æ¨è: http://www.ruanyifeng.com/blog/2014/11/compiler.html

Bulidè¿‡ç¨‹å¯ä»¥åˆ†è§£ä¸º4ä¸ªæ­¥éª¤:é¢„å¤„ç†(Prepressing), ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)ã€é“¾æ¥(Linking)

ä»¥cè¯­è¨€ä¸ºä¾‹:

1ã€é¢„å¤„ç†

é¢„ç¼–è¯‘è¿‡ç¨‹ä¸»è¦å¤„ç†é‚£äº›æºæ–‡ä»¶ä¸­çš„ä»¥â€œ#â€å¼€å§‹çš„é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œä¸»è¦å¤„ç†è§„åˆ™æœ‰ï¼š

1. å°†æ‰€æœ‰çš„â€œ#defineâ€åˆ é™¤ï¼Œå¹¶å±•å¼€æ‰€ç”¨çš„å®å®šä¹‰
2. å¤„ç†æ‰€æœ‰æ¡ä»¶é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œæ¯”å¦‚â€œ#ifâ€ã€â€œ#ifdefâ€ã€ â€œ#elifâ€ã€â€œ#endifâ€
3. å¤„ç†â€œ#includeâ€é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œå°†è¢«åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ï¼Œæ³¨ï¼šæ­¤è¿‡ç¨‹æ˜¯é€’å½’è¿›è¡Œçš„
4. åˆ é™¤æ‰€æœ‰æ³¨é‡Š
5. æ·»åŠ è¡Œå·å’Œæ–‡ä»¶åæ ‡è¯†ï¼Œä»¥ä¾¿äºç¼–è¯‘æ—¶ç¼–è¯‘å™¨äº§ç”Ÿè°ƒè¯•ç”¨çš„è¡Œå·ä¿¡æ¯ä»¥åŠç”¨äºç¼–è¯‘æ—¶äº§ç”Ÿç¼–è¯‘é”™è¯¯æˆ–è­¦å‘Šæ—¶å¯æ˜¾ç¤ºè¡Œå·
6. ä¿ç•™æ‰€æœ‰çš„#pragmaç¼–è¯‘å™¨æŒ‡ä»¤ã€‚

2ã€ç¼–è¯‘

ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—çš„è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç æ–‡ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ•´ä¸ªç¨‹åºæ„å»ºçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚

3ã€æ±‡ç¼–

æ±‡ç¼–å™¨æ˜¯å°†æ±‡ç¼–ä»£ç è½¬åŒ–æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œæ¯ä¸€æ¡æ±‡ç¼–è¯­å¥å‡ ä¹éƒ½æ˜¯ä¸€æ¡æœºå™¨æŒ‡ä»¤ã€‚ç»è¿‡ç¼–è¯‘ã€é“¾æ¥ã€æ±‡ç¼–è¾“å‡ºçš„æ–‡ä»¶æˆä¸ºç›®æ ‡æ–‡ä»¶(Object File)

4ã€é“¾æ¥

é“¾æ¥çš„ä¸»è¦å†…å®¹å°±æ˜¯æŠŠå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸äº’å¼•ç”¨çš„éƒ¨åˆ†å¤„ç†å¥½ï¼Œä½¿å„ä¸ªæ¨¡å—å¯ä»¥æ­£ç¡®çš„æ‹¼æ¥ã€‚ä¸»è¦è¿‡ç¨‹åŒ…å—åœ°å€å’Œç©ºé—´çš„åˆ†é…ï¼ˆAddress and Storage Allocationï¼‰ã€ç¬¦å·å†³è®®(Symbol Resolution)å’Œé‡å®šä½(Relocation)ç­‰æ­¥éª¤ã€‚

### 5.é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥

é™æ€é“¾æ¥æ–¹æ³•ï¼šé™æ€é“¾æ¥çš„æ—¶å€™ï¼Œè½½å…¥ä»£ç å°±ä¼šæŠŠç¨‹åºä¼šç”¨åˆ°çš„åŠ¨æ€ä»£ç æˆ–åŠ¨æ€ä»£ç çš„åœ°å€ç¡®å®šä¸‹æ¥ã€‚é™æ€åº“çš„é“¾æ¥å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥ï¼ŒåŠ¨æ€é“¾æ¥åº“ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•é“¾æ¥å¯¼å…¥åº“ã€‚

åŠ¨æ€é“¾æ¥æ–¹æ³•ï¼šä½¿ç”¨è¿™ç§æ–¹å¼çš„ç¨‹åºå¹¶ä¸åœ¨ä¸€å¼€å§‹å°±å®ŒæˆåŠ¨æ€é“¾æ¥ï¼Œè€Œæ˜¯ç›´åˆ°çœŸæ­£è°ƒç”¨åŠ¨æ€åº“ä»£ç æ—¶ï¼Œè½½å…¥ç¨‹åºæ‰è®¡ç®—(è¢«è°ƒç”¨çš„é‚£éƒ¨åˆ†)åŠ¨æ€ä»£ç çš„é€»è¾‘åœ°å€ï¼Œç„¶åç­‰åˆ°æŸä¸ªæ—¶å€™ï¼Œç¨‹åºåˆéœ€è¦è°ƒç”¨å¦å¤–æŸå—åŠ¨æ€ä»£ç æ—¶ï¼Œè½½å…¥ç¨‹åºåˆå»è®¡ç®—è¿™éƒ¨åˆ†ä»£ç çš„é€»è¾‘åœ°å€ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ–¹å¼ä½¿ç¨‹åºåˆå§‹åŒ–æ—¶é—´è¾ƒçŸ­ï¼Œä½†è¿è¡ŒæœŸé—´çš„æ€§èƒ½æ¯”ä¸ä¸Šé™æ€é“¾æ¥çš„ç¨‹åºã€‚

### 6.è™šæ‹Ÿå†…å­˜æŠ€æœ¯

è™šæ‹Ÿå­˜å‚¨å™¨æ˜¯æŒ‡å…·æœ‰è¯·æ±‚è°ƒå…¥åŠŸèƒ½å’Œç½®æ¢åŠŸèƒ½ï¼Œèƒ½ä»é€»è¾‘ä¸Šå¯¹å†…å­˜å®¹é‡åŠ ä»¥æ‰©å……çš„ä¸€ç§å­˜å‚¨ç³»ç»Ÿ.

### 7.åˆ†é¡µå’Œåˆ†æ®µ

åˆ†é¡µ: ç”¨æˆ·ç¨‹åºçš„åœ°å€ç©ºé—´è¢«åˆ’åˆ†æˆè‹¥å¹²å›ºå®šå¤§å°çš„åŒºåŸŸï¼Œç§°ä¸ºâ€œé¡µâ€ï¼Œç›¸åº”åœ°ï¼Œå†…å­˜ç©ºé—´åˆ†æˆè‹¥å¹²ä¸ªç‰©ç†å—ï¼Œé¡µå’Œå—çš„å¤§å°ç›¸ç­‰ã€‚å¯å°†ç”¨æˆ·ç¨‹åºçš„ä»»ä¸€é¡µæ”¾åœ¨å†…å­˜çš„ä»»ä¸€å—ä¸­ï¼Œå®ç°äº†ç¦»æ•£åˆ†é…ã€‚

åˆ†æ®µ: å°†ç”¨æˆ·ç¨‹åºåœ°å€ç©ºé—´åˆ†æˆè‹¥å¹²ä¸ªå¤§å°ä¸ç­‰çš„æ®µï¼Œæ¯æ®µå¯ä»¥å®šä¹‰ä¸€ç»„ç›¸å¯¹å®Œæ•´çš„é€»è¾‘ä¿¡æ¯ã€‚å­˜å‚¨åˆ†é…æ—¶ï¼Œä»¥æ®µä¸ºå•ä½ï¼Œæ®µä¸æ®µåœ¨å†…å­˜ä¸­å¯ä»¥ä¸ç›¸é‚»æ¥ï¼Œä¹Ÿå®ç°äº†ç¦»æ•£åˆ†é…ã€‚

åˆ†é¡µä¸åˆ†æ®µçš„ä¸»è¦åŒºåˆ«ï¼š

1. é¡µæ˜¯ä¿¡æ¯çš„ç‰©ç†å•ä½,åˆ†é¡µæ˜¯ä¸ºäº†å®ç°éè¿ç»­åˆ†é…,ä»¥ä¾¿è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜,æˆ–è€…è¯´åˆ†é¡µæ˜¯ç”±äºç³»ç»Ÿç®¡ç†çš„éœ€è¦.æ®µæ˜¯ä¿¡æ¯çš„é€»è¾‘å•ä½,å®ƒå«æœ‰ä¸€ç»„æ„ä¹‰ç›¸å¯¹å®Œæ•´çš„ä¿¡æ¯,åˆ†æ®µçš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½åœ°å®ç°å…±äº«,æ»¡è¶³ç”¨æˆ·çš„éœ€è¦.
2. é¡µçš„å¤§å°å›ºå®š,ç”±ç³»ç»Ÿç¡®å®š,å°†é€»è¾‘åœ°å€åˆ’åˆ†ä¸ºé¡µå·å’Œé¡µå†…åœ°å€æ˜¯ç”±æœºå™¨ç¡¬ä»¶å®ç°çš„.è€Œæ®µçš„é•¿åº¦å´ä¸å›ºå®š,å†³å®šäºç”¨æˆ·æ‰€ç¼–å†™çš„ç¨‹åº,é€šå¸¸ç”±ç¼–è¯‘ç¨‹åºåœ¨å¯¹æºç¨‹åºè¿›è¡Œç¼–è¯‘æ—¶æ ¹æ®ä¿¡æ¯çš„æ€§è´¨æ¥åˆ’åˆ†.
3. åˆ†é¡µçš„ä½œä¸šåœ°å€ç©ºé—´æ˜¯ä¸€ç»´çš„.åˆ†æ®µçš„åœ°å€ç©ºé—´æ˜¯äºŒç»´çš„.

### 8.é¡µé¢ç½®æ¢ç®—æ³•

1. æœ€ä½³ç½®æ¢ç®—æ³•OPT:ä¸å¯èƒ½å®ç°
2. å…ˆè¿›å…ˆå‡ºFIFO
3. æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ç®—æ³•LRU:æœ€è¿‘ä¸€æ®µæ—¶é—´é‡Œæœ€ä¹…æ²¡æœ‰ä½¿ç”¨è¿‡çš„é¡µé¢äºˆä»¥ç½®æ¢.
4. clockç®—æ³•

### 9.è¾¹æ²¿è§¦å‘å’Œæ°´å¹³è§¦å‘

è¾¹ç¼˜è§¦å‘æ˜¯æŒ‡æ¯å½“çŠ¶æ€å˜åŒ–æ—¶å‘ç”Ÿä¸€ä¸ª io äº‹ä»¶ï¼Œæ¡ä»¶è§¦å‘æ˜¯åªè¦æ»¡è¶³æ¡ä»¶å°±å‘ç”Ÿä¸€ä¸ª io äº‹ä»¶ã€‚

### 10.unixè¿›ç¨‹é—´é€šä¿¡æ–¹å¼(IPC)

1. ç®¡é“ï¼ˆPipeï¼‰ï¼šç®¡é“å¯ç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå…è®¸ä¸€ä¸ªè¿›ç¨‹å’Œå¦ä¸€ä¸ªä¸å®ƒæœ‰å…±åŒç¥–å…ˆçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚
2. å‘½åç®¡é“ï¼ˆnamed pipeï¼‰ï¼šå‘½åç®¡é“å…‹æœäº†ç®¡é“æ²¡æœ‰åå­—çš„é™åˆ¶ï¼Œå› æ­¤ï¼Œé™¤å…·æœ‰ç®¡é“æ‰€å…·æœ‰çš„åŠŸèƒ½å¤–ï¼Œå®ƒè¿˜å…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ã€‚å‘½åç®¡é“åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰å¯¹åº”çš„æ–‡ä»¶åã€‚å‘½åç®¡é“é€šè¿‡å‘½ä»¤mkfifoæˆ–ç³»ç»Ÿè°ƒç”¨mkfifoæ¥åˆ›å»ºã€‚
3. ä¿¡å·ï¼ˆSignalï¼‰ï¼šä¿¡å·æ˜¯æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥å—è¿›ç¨‹æœ‰æŸç§äº‹ä»¶å‘ç”Ÿï¼Œé™¤äº†ç”¨äºè¿›ç¨‹é—´é€šä¿¡å¤–ï¼Œè¿›ç¨‹è¿˜å¯ä»¥å‘é€ä¿¡å·ç»™è¿›ç¨‹æœ¬èº«ï¼›linuxé™¤äº†æ”¯æŒUnixæ—©æœŸä¿¡å·è¯­ä¹‰å‡½æ•°sigalå¤–ï¼Œè¿˜æ”¯æŒè¯­ä¹‰ç¬¦åˆPosix.1æ ‡å‡†çš„ä¿¡å·å‡½æ•°sigactionï¼ˆå®é™…ä¸Šï¼Œè¯¥å‡½æ•°æ˜¯åŸºäºBSDçš„ï¼ŒBSDä¸ºäº†å®ç°å¯é ä¿¡å·æœºåˆ¶ï¼Œåˆèƒ½å¤Ÿç»Ÿä¸€å¯¹å¤–æ¥å£ï¼Œç”¨sigactionå‡½æ•°é‡æ–°å®ç°äº†signalå‡½æ•°ï¼‰ã€‚
4. æ¶ˆæ¯ï¼ˆMessageï¼‰é˜Ÿåˆ—ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾æ¥è¡¨ï¼ŒåŒ…æ‹¬Posixæ¶ˆæ¯é˜Ÿåˆ—system Væ¶ˆæ¯é˜Ÿåˆ—ã€‚æœ‰è¶³å¤Ÿæƒé™çš„è¿›ç¨‹å¯ä»¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ¶ˆæ¯ï¼Œè¢«èµ‹äºˆè¯»æƒé™çš„è¿›ç¨‹åˆ™å¯ä»¥è¯»èµ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·æ‰¿è½½ä¿¡æ¯é‡å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼º
5. å…±äº«å†…å­˜ï¼šä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œæ˜¯æœ€å¿«çš„å¯ç”¨IPCå½¢å¼ã€‚æ˜¯é’ˆå¯¹å…¶ä»–é€šä¿¡æœºåˆ¶è¿è¡Œæ•ˆç‡è¾ƒä½è€Œè®¾è®¡çš„ã€‚å¾€å¾€ä¸å…¶å®ƒé€šä¿¡æœºåˆ¶ï¼Œå¦‚ä¿¡å·é‡ç»“åˆä½¿ç”¨ï¼Œæ¥è¾¾åˆ°è¿›ç¨‹é—´çš„åŒæ­¥åŠäº’æ–¥ã€‚
6. å†…å­˜æ˜ å°„ï¼ˆmapped memoryï¼‰ï¼šå†…å­˜æ˜ å°„å…è®¸ä»»ä½•å¤šä¸ªè¿›ç¨‹é—´é€šä¿¡ï¼Œæ¯ä¸€ä¸ªä½¿ç”¨è¯¥æœºåˆ¶çš„è¿›ç¨‹é€šè¿‡æŠŠä¸€ä¸ªå…±äº«çš„æ–‡ä»¶æ˜ å°„åˆ°è‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´æ¥å®ç°å®ƒã€‚
7. ä¿¡å·é‡ï¼ˆsemaphoreï¼‰ï¼šä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚
8. å¥—æ¥å£ï¼ˆSocketï¼‰ï¼šæ›´ä¸ºä¸€èˆ¬çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå¯ç”¨äºä¸åŒæœºå™¨ä¹‹é—´çš„è¿›ç¨‹é—´é€šä¿¡ã€‚èµ·åˆæ˜¯ç”±Unixç³»ç»Ÿçš„BSDåˆ†æ”¯å¼€å‘å‡ºæ¥çš„ï¼Œä½†ç°åœ¨ä¸€èˆ¬å¯ä»¥ç§»æ¤åˆ°å…¶å®ƒç±»Unixç³»ç»Ÿä¸Šï¼šLinuxå’ŒSystem Vçš„å˜ç§éƒ½æ”¯æŒå¥—æ¥å­—ã€‚

### 11.è¿›ç¨‹æ€»ç»“

è¿›ç¨‹ï¼šç¨‹åºè¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€ä¸ªå®ä¾‹ï¼Œå°±ç§°ä¹‹ä¸ºè¿›ç¨‹ã€‚è¿›ç¨‹éœ€è¦ç›¸åº”çš„ç³»ç»Ÿèµ„æºï¼šå†…å­˜ã€æ—¶é—´ç‰‡ã€pidã€‚

åˆ›å»ºè¿›ç¨‹ï¼š

é¦–å…ˆè¦å¯¼å…¥ multiprocessing ä¸­çš„ Processï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Process å¯¹è±¡ï¼Œåˆ›å»º Process å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä¼ é€’å‚æ•°ï¼š

```python
p = Process(target=XXX, args=(tuple,), kwargs={key: value})
# target = XXX æŒ‡å®šçš„ä»»åŠ¡å‡½æ•°ï¼Œä¸ç”¨åŠ (),
# args=(tuple,)kwargs={key:value}ç»™ä»»åŠ¡å‡½æ•°ä¼ é€’çš„å‚æ•°
```

ä½¿ç”¨start()å¯åŠ¨è¿›ç¨‹ï¼š

```python
import os
import time
from mulitprocessing import Process


def pro_func(name, age, **kwargs):
    for i in range(5):
        print("å­è¿›ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œname=%s,age=%d,pid=%d"%(name,age,os.getpid()))
        print(kwargs)
        time.sleep(0.2)

if __name__ =="__main__":
    #åˆ›å»ºProcesså¯¹è±¡
    p = Process(target=pro_func,args=('å°æ˜',18),kwargs={'m':20})
    #å¯åŠ¨è¿›ç¨‹
    p.start()
    time.sleep(1)
    #1ç§’é’Ÿä¹‹åï¼Œç«‹åˆ»ç»“æŸå­è¿›ç¨‹
    p.terminate()
    p.join()
```

æ³¨æ„ï¼šè¿›ç¨‹é—´ä¸å…±äº«å…¨å±€å˜é‡ã€‚

è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡-Queue

åœ¨åˆå§‹åŒ–Queue()å¯¹è±¡æ—¶ï¼ˆä¾‹å¦‚q=Queue(),è‹¥åœ¨æ‹¬å·ä¸­æ²¡æœ‰æŒ‡å®šæœ€å¤§å¯æ¥å—çš„æ¶ˆæ¯æ•°é‡ï¼Œè·æ•°é‡ä¸ºè´Ÿå€¼æ—¶ï¼Œé‚£ä¹ˆå°±ä»£è¡¨å¯æ¥å—çš„æ¶ˆæ¯æ•°é‡æ²¡æœ‰ä¸Šé™ä¸€ç›´åˆ°å†…å­˜å°½å¤´ï¼‰

Queue.qsize():è¿”å›å½“å‰é˜Ÿåˆ—åŒ…å«çš„æ¶ˆæ¯æ•°é‡

Queue.empty():å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›Trueï¼Œåä¹‹False

Queue.full():å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè¿”å›True,åä¹‹False

Queue.get([block[,timeout]]):è·å–é˜Ÿåˆ—ä¸­çš„ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åå°†å…¶ä»é˜Ÿåˆ—ä¸­ç§»é™¤

blocké»˜è®¤å€¼ä¸ºTrueã€‚

å¦‚æœblockä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸”æ²¡æœ‰è®¾ç½®timeoutï¼ˆå•ä½ç§’)ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¦‚æœä¸ºç©ºï¼Œæ­¤æ—¶ç¨‹åºå°†è¢«é˜»å¡ï¼ˆåœåœ¨è¯»ä¸­çŠ¶æ€ï¼‰ï¼Œç›´åˆ°æ¶ˆæ¯é˜Ÿåˆ—è¯»åˆ°æ¶ˆæ¯ä¸ºæ­¢ï¼Œå¦‚æœè®¾ç½®äº†timeoutï¼Œåˆ™ä¼šç­‰å¾…timeoutç§’ï¼Œè‹¥è¿˜æ²¡è¯»å–åˆ°ä»»ä½•æ¶ˆæ¯ï¼Œåˆ™æŠ›å‡ºâ€œQueue.Empty"å¼‚å¸¸ï¼š

Queue.get_nowait()ç›¸å½“äºQueue.get(False)

Queue.put(item,[block[,timeout]]):å°†itemæ¶ˆæ¯å†™å…¥é˜Ÿåˆ—ï¼Œblocké»˜è®¤å€¼ä¸ºTrue;

å¦‚æœblockä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸”æ²¡æœ‰è®¾ç½®timeoutï¼ˆå•ä½ç§’ï¼‰ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¦‚æœå·²ç»æ²¡æœ‰ç©ºé—´å¯å†™å…¥ï¼Œæ­¤æ—¶ç¨‹åºå°†è¢«é˜»å¡ï¼ˆåœåœ¨å†™å…¥çŠ¶æ€ï¼‰ï¼Œç›´åˆ°ä»æ¶ˆæ¯é˜Ÿåˆ—è…¾å‡ºç©ºé—´ä¸ºæ­¢ï¼Œå¦‚æœè®¾ç½®äº†timeoutï¼Œåˆ™ä¼šç­‰å¾…timeoutç§’ï¼Œè‹¥è¿˜æ²¡ç©ºé—´ï¼Œåˆ™æŠ›å‡ºâ€Queue.Full"å¼‚å¸¸ï¼›å¦‚æœblockå€¼ä¸ºFalseï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¦‚æœæ²¡æœ‰ç©ºé—´å¯å†™å…¥ï¼Œåˆ™ä¼šç«‹åˆ»æŠ›å‡º"Queue.Full"å¼‚å¸¸;

Queue.put_nowait(item):ç›¸å½“Queue.put(item,False)

è¿›ç¨‹é—´é€šä¿¡Demo:

```python
import os
import time
import random
from multiprocessing import Process.Queue

#å†™æ•°æ®è¿›ç¨‹æ‰§è¡Œçš„ä»£ç ï¼š
def write(q):
    for value in ['A','B','C']:
        print("Put %s to queue...",%value)
        q.put(value)
        time.sleep(random.random())

#è¯»æ•°æ®è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
def read(q):
    while True:
        if not q.empty():
            value = q.get(True)
            print("Get %s from queue.",%value)
            time.sleep(random.random())
        else:
            break

if __name__=='__main__':
    #çˆ¶è¿›ç¨‹åˆ›å»ºQueueï¼Œå¹¶ä¼ ç»™å„ä¸ªå­è¿›ç¨‹
    q = Queue()
    pw = Process(target=write,args=(q,))
    pr = Process(target=read,args=(q,))
    #å¯åŠ¨å­è¿›ç¨‹pw ï¼Œå†™å…¥ï¼š
    pw.start()
    #ç­‰å¾…pwç»“æŸ
    pw.join()
    #å¯åŠ¨å­è¿›ç¨‹prï¼Œè¯»å–ï¼š
    pr.start()
    pr.join()
    #pr è¿›ç¨‹é‡Œæ˜¯æ­»å¾ªç¯ï¼Œæ— æ³•ç­‰å¾…å…¶ç»“æŸï¼Œåªèƒ½å¼ºè¡Œç»ˆæ­¢:
    print('')
    print('æ‰€æœ‰æ•°æ®éƒ½å†™å…¥å¹¶ä¸”è¯»å®Œ')
```

è¿›ç¨‹æ± Pool

```python
#coding:utf-8

import os
import time
import random
from multiprocessing import Pool

def worker(msg):
    t_start = time.time()
    print("%s å¼€å§‹æ‰§è¡Œï¼Œè¿›ç¨‹å·ä¸º%d"%(msg,os.getpid()))
    # random.random()éšæœºç”Ÿæˆ0-1ä¹‹é—´çš„æµ®ç‚¹æ•°
    time.sleep(random.random()*2)
    t_stop = time.time()
    print(msg,"æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶%0.2fâ€%ï¼ˆt_stop-t_start))

po = Pool(3)#å®šä¹‰ä¸€ä¸ªè¿›ç¨‹æ± ï¼Œæœ€å¤§è¿›ç¨‹æ•°3
for i in range(0,10):
    po.apply_async(worker,(i,))

print("---start----")
po.close()
po.join()
print("----end----")
```

è¿›ç¨‹æ± ä¸­ä½¿ç”¨Queue

å¦‚æœè¦ä½¿ç”¨Poolåˆ›å»ºè¿›ç¨‹ï¼Œå°±éœ€è¦ä½¿ç”¨multiprocessing.Manager()ä¸­çš„Queue()ï¼Œè€Œä¸æ˜¯multiprocessing.Queue()ï¼Œå¦åˆ™ä¼šå¾—åˆ°å¦‚ä¸‹çš„é”™è¯¯ä¿¡æ¯ï¼š

RuntimeErrorï¼š Queue objects should only be shared between processs through inheritance

```python
import os
import time
import random
from multiprocessing import Manager, Pool

def reader(q):
    print("reader å¯åŠ¨(%s),çˆ¶è¿›ç¨‹ä¸ºï¼ˆ%s)"%(os.getpid(),os.getpid()))
    for i in range(q.qsize()):
        print("reader ä»Queueè·å–åˆ°æ¶ˆæ¯:%s"%q.get(True))

def writer(q):
    print("writer å¯åŠ¨ï¼ˆ%s),çˆ¶è¿›ç¨‹ä¸º(%s)"%(os.getpid(),os.getpid()))
    for i ini "itcast":
        q.put(i)
        
if __name__ == "__main__":
    print("(%s)start"%os.getpid())
    q = Manager().Queue()#ä½¿ç”¨Managerä¸­çš„Queue
    po = Pool()
    po.apply_async(wrtier,(q,))
    time.sleep(1)
    po.apply_async(reader,(q,))
    po.close()
    po.join()
    print("(%s)End"%os.getpid())
```

### 12.Pythonå¼‚æ­¥ä½¿ç”¨åœºæ™¯æœ‰é‚£äº›ï¼Ÿ

å¼‚æ­¥çš„ä½¿ç”¨åœºæ™¯:

1ã€ ä¸æ¶‰åŠå…±äº«èµ„æºï¼Œè·å¯¹å…±äº«èµ„æºåªè¯»ï¼Œå³éäº’æ–¥æ“ä½œ

2ã€ æ²¡æœ‰æ—¶åºä¸Šçš„ä¸¥æ ¼å…³ç³»

3ã€ ä¸éœ€è¦åŸå­æ“ä½œï¼Œæˆ–å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼æ§åˆ¶åŸå­æ€§

4ã€ å¸¸ç”¨äºIOæ“ä½œç­‰è€—æ—¶æ“ä½œï¼Œå› ä¸ºæ¯”è¾ƒå½±å“å®¢æˆ·ä½“éªŒå’Œä½¿ç”¨æ€§èƒ½

5ã€ ä¸å½±å“ä¸»çº¿ç¨‹é€»è¾‘

### 13.å¤šçº¿ç¨‹å…±åŒæ“ä½œåŒä¸€ä¸ªæ•°æ®äº’æ–¥é”åŒæ­¥ï¼Ÿ

```python
import time
import threading

class MyThread(threading.Thread):
    def run(self):
        global num
        time.sleep(1)
    
        if mutex.acquire(1):
            num +=1
            msg = self.name + 'set num to ' +str(num)
            print msg
            mutex.release()

num = 0
mutex = threading.Lock()
def test():
    for i in range(5):
        t = MyThread()
        t.start()
        
if __name__=="__main__":
    test()
```
### 14.ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç«äº‰ï¼Ÿ

çº¿ç¨‹æ˜¯éç‹¬ç«‹çš„ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹é‡Œçº¿ç¨‹æ˜¯æ•°æ®å…±äº«çš„ï¼Œå½“å„ä¸ªçº¿ç¨‹è®¿é—®æ•°æ®èµ„æºæ—¶ä¼šå‡ºç°ç«äº‰çŠ¶æ€å³ï¼šæ•°æ®å‡ ä¹åŒæ­¥ä¼šè¢«å¤šä¸ªçº¿ç¨‹å ç”¨ï¼Œé€ æˆæ•°æ®æ··ä¹±ï¼Œå³æ‰€è°“çš„çº¿ç¨‹ä¸å®‰å…¨ã€‚

é‚£ä¹ˆæ€ä¹ˆè§£å†³å¤šçº¿ç¨‹ç«äº‰é—®é¢˜ï¼Ÿ---é”

é”çš„å¥½å¤„ï¼š ç¡®ä¿äº†æŸæ®µå…³é”®ä»£ç ï¼ˆå…±äº«æ•°æ®èµ„æºï¼‰åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹ä»å¤´åˆ°å°¾å®Œæ•´åœ°æ‰§è¡Œèƒ½è§£å†³å¤šçº¿ç¨‹èµ„æºç«äº‰ä¸‹çš„åŸå­æ“ä½œé—®é¢˜ã€‚

é”çš„åå¤„ï¼š é˜»æ­¢äº†å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼ŒåŒ…å«é”çš„æŸæ®µä»£ç å®é™…ä¸Šåªèƒ½ä»¥å•çº¿ç¨‹æ¨¡å¼æ‰§è¡Œï¼Œæ•ˆç‡å°±å¤§å¤§åœ°ä¸‹é™äº†ã€‚

é”çš„è‡´å‘½é—®é¢˜: æ­»é”

### 15.è¯·ä»‹ç»ä¸€ä¸‹Pythonçš„çº¿ç¨‹åŒæ­¥ï¼Ÿ

1ã€setDaemon(False)

å½“ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨ä¹‹åï¼Œä¼šé»˜è®¤äº§ç”Ÿä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå› ä¸ºçº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œå½“è®¾ç½®å¤šçº¿ç¨‹æ—¶ï¼Œä¸»çº¿ç¨‹ä¼šåˆ›å»ºå¤šä¸ªå­çº¿ç¨‹ï¼Œåœ¨Pythonä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹å°±æ˜¯setDaemon(False)ï¼Œä¸»çº¿ç¨‹æ‰§è¡Œå®Œè‡ªå·±çš„ä»»åŠ¡ä»¥åï¼Œå°±é€€å‡ºäº†ï¼Œæ­¤æ—¶å­çº¿ç¨‹ä¼šç»§ç»­æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼Œç›´åˆ°è‡ªå·±çš„ä»»åŠ¡ç»“æŸã€‚

```python
import time
import threading 


def thread():
    time.sleep(2)
    print('---å­çº¿ç¨‹ç»“æŸ---')

def main():
    t1 = threading.Thread(target=thread)
    t1.start()
    print('---ä¸»çº¿ç¨‹--ç»“æŸ')

if __name__ =='__main__':
    main()

# output
# ---ä¸»çº¿ç¨‹--ç»“æŸ
# ---å­çº¿ç¨‹ç»“æŸ---
```

2ã€setDaemon(True)

å½“æˆ‘ä»¬ä½¿ç”¨setDaemon(True)æ—¶ï¼Œè¿™æ˜¯å­çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ä¸€æ—¦æ‰§è¡Œç»“æŸï¼Œåˆ™å…¨éƒ¨å­çº¿ç¨‹è¢«å¼ºåˆ¶ç»ˆæ­¢ã€‚

```python
import time
import threading

def thread():
    time.sleep(2)
    print(â€™---å­çº¿ç¨‹ç»“æŸ---')

def main():
    t1 = threading.Thread(target=thread)
    t1.setDaemon(True)#è®¾ç½®å­çº¿ç¨‹å®ˆæŠ¤ä¸»çº¿ç¨‹
    t1.start()
    print('---ä¸»çº¿ç¨‹ç»“æŸ---')

if __name__ =='__main__':
    main()

# æ‰§è¡Œç»“æœ
# ---ä¸»çº¿ç¨‹ç»“æŸ--- #åªæœ‰ä¸»çº¿ç¨‹ç»“æŸï¼Œå­çº¿ç¨‹æ¥ä¸åŠæ‰§è¡Œå°±è¢«å¼ºåˆ¶ç»“æŸ
```

3ã€joinï¼ˆçº¿ç¨‹åŒæ­¥)

join æ‰€å®Œæˆçš„å·¥ä½œå°±æ˜¯çº¿ç¨‹åŒæ­¥ï¼Œå³ä¸»çº¿ç¨‹ä»»åŠ¡ç»“æŸä»¥åï¼Œè¿›å…¥å µå¡çŠ¶æ€ï¼Œä¸€ç›´ç­‰å¾…æ‰€æœ‰çš„å­çº¿ç¨‹ç»“æŸä»¥åï¼Œä¸»çº¿ç¨‹å†ç»ˆæ­¢ã€‚

å½“è®¾ç½®å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼Œå«ä¹‰æ˜¯ä¸»çº¿ç¨‹å¯¹äºå­çº¿ç¨‹ç­‰å¾…timeoutçš„æ—¶é—´å°†ä¼šæ€æ­»è¯¥å­çº¿ç¨‹ï¼Œæœ€åé€€å‡ºç¨‹åºï¼Œæ‰€ä»¥è¯´ï¼Œå¦‚æœæœ‰10ä¸ªå­çº¿ç¨‹ï¼Œå…¨éƒ¨çš„ç­‰å¾…æ—¶é—´å°±æ˜¯æ¯ä¸ªtimeoutçš„ç´¯åŠ å’Œï¼Œç®€å•çš„æ¥è¯´ï¼Œå°±æ˜¯ç»™æ¯ä¸ªå­çº¿ç¨‹ä¸€ä¸ªtimeouçš„æ—¶é—´ï¼Œè®©ä»–å»æ‰§è¡Œï¼Œæ—¶é—´ä¸€åˆ°ï¼Œä¸ç®¡ä»»åŠ¡æœ‰æ²¡æœ‰å®Œæˆï¼Œç›´æ¥æ€æ­»ã€‚

æ²¡æœ‰è®¾ç½®å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼Œä¸»çº¿ç¨‹å°†ä¼šç­‰å¾…timeoutçš„ç´¯åŠ å’Œè¿™æ ·çš„ä¸€æ®µæ—¶é—´ï¼Œæ—¶é—´ä¸€åˆ°ï¼Œä¸»çº¿ç¨‹ç»“æŸï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ€æ­»å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹ä¾ç„¶å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å­çº¿ç¨‹å…¨éƒ¨ç»“æŸï¼Œç¨‹åºé€€å‡ºã€‚

```python
import threading
import time

def thread():
    time.sleep(2)
    print('---å­çº¿ç¨‹ç»“æŸ---')

def main():
    t1 = threading.Thread(target=thread)
    t1.setDaemon(True)
    t1.start()
    t1.join(timeout=1)  #1 çº¿ç¨‹åŒæ­¥ï¼Œä¸»çº¿ç¨‹å µå¡1s ç„¶åä¸»çº¿ç¨‹ç»“æŸï¼Œå­çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
                        #2 å¦‚æœä¸è®¾ç½®timeoutå‚æ•°å°±ç­‰å­çº¿ç¨‹ç»“æŸä¸»çº¿ç¨‹å†ç»“æŸ
                        #3 å¦‚æœè®¾ç½®äº†setDaemon=Trueå’Œtimeout=1ä¸»çº¿ç¨‹ç­‰å¾…1såä¼šå¼ºåˆ¶æ€æ­»å­çº¿ç¨‹ï¼Œç„¶åä¸»çº¿ç¨‹ç»“æŸ
    print('---ä¸»çº¿ç¨‹ç»“æŸ---')

if __name__=='__main___':
    main()
```

### 16.è§£é‡Šä»¥ä¸‹ä»€ä¹ˆæ˜¯é”ï¼Œæœ‰å“ªå‡ ç§é”ï¼Ÿ

é”(Lock)æ˜¯pythonæä¾›çš„å¯¹çº¿ç¨‹æ§åˆ¶çš„å¯¹è±¡ã€‚

æœ‰äº’æ–¥é”ï¼Œå¯é‡å…¥é”ï¼Œæ­»é”ã€‚

### 17.ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ

è‹¥å¹²å­çº¿ç¨‹åœ¨ç³»ç»Ÿèµ„æºç«äº‰æ—¶ï¼Œéƒ½åœ¨ç­‰å¾…å¯¹æ–¹å¯¹æŸéƒ¨åˆ†èµ„æºè§£é™¤å ç”¨çŠ¶æ€ï¼Œç»“æœæ˜¯è°ä¹Ÿä¸æ„¿å…ˆè§£é”ï¼Œäº’ç›¸å¹²ç­‰ç€ï¼Œç¨‹åºæ— æ³•æ‰§è¡Œä¸‹å»ï¼Œè¿™å°±æ˜¯æ­»é”ã€‚

GILé” å…¨å±€è§£é‡Šå™¨é”

ä½œç”¨ï¼š é™åˆ¶å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥cythoné‡Œçš„å¤šçº¿ç¨‹å…¶å®æ˜¯ä¼ªå¤šçº¿ç¨‹ï¼

æ‰€ä»¥pythoné‡Œå¸¸å¸¸ä½¿ç”¨åç¨‹æŠ€æœ¯æ¥ä»£æ›¿å¤šçº¿ç¨‹ï¼Œåç¨‹æ˜¯ä¸€ç§æ›´è½»é‡çº§çš„çº¿ç¨‹ã€‚

è¿›ç¨‹å’Œçº¿ç¨‹çš„åˆ‡æ¢æ—¶ç”±ç³»ç»Ÿå†³å®šï¼Œè€Œåç¨‹ç”±æˆ‘ä»¬ç¨‹åºå‘˜è‡ªå·±å†³å®šï¼Œè€Œæ¨¡å—geventä¸‹åˆ‡æ¢æ˜¯é‡åˆ°äº†è€—æ—¶æ“ä½œæ—¶æ‰ä¼šåˆ‡æ¢

ä¸‰è€…çš„å…³ç³»ï¼šè¿›ç¨‹é‡Œæœ‰çº¿ç¨‹ï¼Œçº¿ç¨‹é‡Œæœ‰åç¨‹ã€‚

### 18.å¤šçº¿ç¨‹äº¤äº’è®¿é—®æ•°æ®ï¼Œå¦‚æœè®¿é—®åˆ°äº†å°±ä¸è®¿é—®äº†ï¼Ÿ

æ€ä¹ˆé¿å…é‡è¯»ï¼Ÿ

åˆ›å»ºä¸€ä¸ªå·²è®¿é—®æ•°æ®åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨å·²ç»è®¿é—®è¿‡çš„æ•°æ®ï¼Œå¹¶åŠ ä¸Šäº’æ–¥é”ï¼Œåœ¨å¤šçº¿ç¨‹è®¿é—®æ•°æ®çš„æ—¶å€™å…ˆæŸ¥çœ‹æ•°æ®æ˜¯å¦åœ¨å·²è®¿é—®çš„åˆ—è¡¨ä¸­ï¼Œè‹¥å·²å­˜åœ¨å°±ç›´æ¥è·³è¿‡ã€‚

### 19.ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Œä»€ä¹ˆæ˜¯äº’æ–¥é”ï¼Ÿ

æ¯ä¸ªå¯¹è±¡éƒ½å¯¹åº”äºä¸€ä¸ªå¯ç§°ä¸ºã€Œäº’æ–¥é”ã€çš„æ ‡è®°ï¼Œè¿™ä¸ªæ ‡è®°ç”¨æ¥ä¿è¯åœ¨ä»»ä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥å¯¹è±¡ã€‚

åŒä¸€è¿›ç¨‹ä¸­çš„å¤šçº¿ç¨‹ä¹‹é—´æ˜¯å…±äº«ç³»ç»Ÿèµ„æºçš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œæ“ä½œï¼Œä¸€ä¸ªçº¿ç¨‹æ“ä½œå°šæœªç»“æŸï¼Œå¦ä¸€çº¿ç¨‹å·²ç»å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œå¯¼è‡´æœ€ç»ˆç»“æœå‡ºç°é”™è¯¯ï¼Œæ­¤æ—¶éœ€è¦å¯¹è¢«æ“ä½œå¯¹è±¡æ·»åŠ äº’æ–¥é”ï¼Œä¿è¯æ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å¯¹è±¡çš„æ“ä½œéƒ½å¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚

### 20.è¯´è¯´ä¸‹é¢å‡ ä¸ªæ¦‚å¿µï¼šåŒæ­¥ï¼Œå¼‚æ­¥ï¼Œé˜»å¡ï¼Œéé˜»å¡ï¼Ÿ

åŒæ­¥ï¼š å¤šä¸ªä»»åŠ¡ä¹‹é—´æœ‰å…ˆåé¡ºåºæ‰§è¡Œï¼Œä¸€ä¸ªæ‰§è¡Œå®Œä¸‹ä¸ªæ‰èƒ½æ‰§è¡Œã€‚

å¼‚æ­¥ï¼š å¤šä¸ªä»»åŠ¡ä¹‹é—´æ²¡æœ‰å…ˆåé¡ºåºï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œæœ‰æ—¶å€™ä¸€ä¸ªä»»åŠ¡å¯èƒ½è¦åœ¨å¿…è¦çš„æ—¶å€™è·å–å¦ä¸€ä¸ªåŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡çš„ç»“æœï¼Œè¿™ä¸ªå°±å«å›è°ƒï¼

é˜»å¡ï¼š å¦‚æœå¡ä½äº†è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…ä¸èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå°±æ˜¯è¯´è°ƒç”¨è€…é˜»å¡äº†ã€‚

éé˜»å¡ï¼š å¦‚æœä¸ä¼šå¡ä½ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå°±æ˜¯è¯´éé˜»å¡çš„ã€‚

åŒæ­¥å¼‚æ­¥ç›¸å¯¹äºå¤šä»»åŠ¡è€Œè¨€ï¼Œé˜»å¡éé˜»å¡ç›¸å¯¹äºä»£ç æ‰§è¡Œè€Œè¨€ã€‚

### 21.ä»€ä¹ˆæ˜¯åƒµå°¸è¿›ç¨‹å’Œå­¤å„¿è¿›ç¨‹ï¼Ÿæ€ä¹ˆé¿å…åƒµå°¸è¿›ç¨‹ï¼Ÿ

å­¤å„¿è¿›ç¨‹ï¼š çˆ¶è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œçš„è¿™äº›å­è¿›ç¨‹éƒ½æ˜¯å­¤å„¿è¿›ç¨‹ï¼Œå­¤å„¿è¿›ç¨‹å°†è¢« init è¿›ç¨‹ï¼ˆè¿›ç¨‹å·ä¸º1ï¼‰æ‰€æ”¶å…»ï¼Œå¹¶ç”± init è¿›ç¨‹å¯¹ä»–ä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚

åƒµå°¸è¿›ç¨‹ï¼š è¿›ç¨‹ä½¿ç”¨ fork åˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ wait æˆ– waitpid è·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­çš„è¿™äº›è¿›ç¨‹æ˜¯åƒµå°¸è¿›ç¨‹ã€‚

é¿å…åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•ï¼š

1.fork ä¸¤æ¬¡ç”¨å­™å­è¿›ç¨‹å»å®Œæˆå­è¿›ç¨‹çš„ä»»åŠ¡

2.ç”¨ wait() å‡½æ•°ä½¿çˆ¶è¿›ç¨‹é˜»å¡

3.ä½¿ç”¨ä¿¡å·é‡ï¼Œåœ¨ signal handler ä¸­è°ƒç”¨ waitpidï¼Œè¿™æ ·çˆ¶è¿›ç¨‹ä¸ç”¨é˜»å¡ã€‚

###  22.pythonä¸­è¿›ç¨‹ä¸çº¿ç¨‹çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ

å¤šè¿›ç¨‹é€‚åˆåœ¨CPUå¯†é›†æ“ä½œï¼ˆcpuæ“ä½œæŒ‡ä»¤æ¯”è¾ƒå¤šï¼Œå¦‚ä½å¤šçš„çš„æµ®ç‚¹è¿ç®—ï¼‰ã€‚

å¤šçº¿ç¨‹é€‚åˆåœ¨IOå¯†æ€§å‹æ“ä½œï¼ˆè¯»å†™æ•°æ®æ“ä½œæ¯”å¤šçš„çš„ï¼Œæ¯”å¦‚çˆ¬è™«ï¼‰

###  23.çº¿ç¨‹æ˜¯å¹¶å‘è¿˜æ˜¯å¹¶è¡Œï¼Œè¿›ç¨‹æ˜¯å¹¶å‘è¿˜æ˜¯å¹¶è¡Œï¼Ÿ

çº¿ç¨‹æ˜¯å¹¶å‘ï¼Œè¿›ç¨‹æ˜¯å¹¶è¡Œ;

è¿›ç¨‹ä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œæ˜¯ç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€å°å•ä½ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹å…±äº«èµ„æºã€‚

### 24.å¹¶è¡Œï¼ˆparallelï¼‰å’Œå¹¶å‘ï¼ˆconcurrencyï¼‰?

å¹¶è¡Œï¼š åŒä¸€æ—¶åˆ»å¤šä¸ªä»»åŠ¡åŒæ—¶åœ¨è¿è¡Œ

ä¸ä¼šåœ¨åŒä¸€æ—¶åˆ»åŒæ—¶è¿è¡Œï¼Œå­˜åœ¨äº¤æ›¿æ‰§è¡Œçš„æƒ…å†µã€‚

å®ç°å¹¶è¡Œçš„åº“æœ‰ï¼š multiprocessing

å®ç°å¹¶å‘çš„åº“æœ‰:  threading

ç¨‹åºéœ€è¦æ‰§è¡Œè¾ƒå¤šçš„è¯»å†™ã€è¯·æ±‚å’Œå›å¤ä»»åŠ¡çš„éœ€è¦å¤§é‡çš„IOæ“ä½œï¼ŒIOå¯†é›†å‹æ“ä½œä½¿ç”¨å¹¶å‘æ›´å¥½ã€‚

CPUè¿ç®—é‡å¤§çš„ç¨‹åºï¼Œä½¿ç”¨å¹¶è¡Œä¼šæ›´å¥½

### 25.IOå¯†é›†å‹å’ŒCPUå¯†é›†å‹åŒºåˆ«ï¼Ÿ

IOå¯†é›†å‹ï¼š ç³»ç»Ÿè¿è¡Œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰ I/Oï¼ˆç¡¬ç›˜/å†…å­˜ï¼‰çš„è¯»/å†™

CPUå¯†é›†å‹ï¼š å¤§éƒ¨åˆ†æ—¶é—´ç”¨æ¥åšè®¡ç®—ï¼Œé€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPUå¯†é›†å‹ã€‚

### 26.python asyncioçš„åŸç†ï¼Ÿ

asyncioè¿™ä¸ªåº“å°±æ˜¯ä½¿ç”¨pythonçš„yieldè¿™ä¸ªå¯ä»¥æ‰“æ–­ä¿å­˜å½“å‰å‡½æ•°çš„ä¸Šä¸‹æ–‡çš„æœºåˆ¶ï¼Œ å°è£…å¥½äº† selector æ‘†è„±æ‰äº†å¤æ‚çš„å›è°ƒå…³ç³»ã€‚

### 27.è°ˆè°ˆä½ å¯¹å¤šè¿›ç¨‹ï¼Œå¤šçº¿ç¨‹ï¼Œä»¥åŠåç¨‹çš„ç†è§£ï¼Œé¡¹ç›®æ˜¯å¦ç”¨ï¼Ÿ

è¿™ä¸ªé—®é¢˜è¢«é—®çš„æ¦‚å¿µç›¸å½“ä¹‹å¤§ï¼š

è¿›ç¨‹ï¼šä¸€ä¸ªè¿è¡Œçš„ç¨‹åºï¼ˆä»£ç ï¼‰å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ²¡æœ‰è¿è¡Œçš„ä»£ç å«ç¨‹åºï¼Œè¿›ç¨‹æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œè¿›ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹é—´æ•°æ®ä¸å…±äº«ï¼Œå¼€é”€å¤§ã€‚

çº¿ç¨‹: cpuè°ƒåº¦æ‰§è¡Œçš„æœ€å°å•ä½ï¼Œä¹Ÿå«æ‰§è¡Œè·¯å¾„ï¼Œä¸èƒ½ç‹¬ç«‹å­˜åœ¨ï¼Œä¾èµ–è¿›ç¨‹å­˜åœ¨ï¼Œä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå«ä¸»çº¿ç¨‹ï¼Œè€Œå¤šä¸ªçº¿ç¨‹å…±äº«å†…å­˜ï¼ˆæ•°æ®å…±äº«ï¼Œå…±äº«å…¨å±€å˜é‡)ï¼Œä»è€Œæå¤§åœ°æé«˜äº†ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚

åç¨‹: æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä¸­æ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚


1ã€æ“ä½œç³»ç»Ÿä¸­çš„é˜»å¡ã€éé˜»å¡ã€åŒæ­¥ã€å¼‚æ­¥ã€BIOã€NIOã€AIO ç»†èŠ‚ã€‚

2ã€Linux å¸¸è§æŒ‡ä»¤

3ã€è¿›ç¨‹é—´é€šä¿¡å‡ ç§æ–¹å¼ï¼Œæ¯ç§æ–¹å¼çš„ä¼˜åŠ£æ€§ã€‚

4ã€HTTP çš„å‘å±•å²ç†è§£ä¼˜ç¼ºç‚¹ï¼Œå…¬é’¥ã€ç§é’¥ç†è§£è·ŸåŠ å¯†è¿‡ç¨‹ã€‚

5ã€æ“ä½œç³»ç»Ÿå†…å­˜ã€è¿›ç¨‹ã€IOã€æ–‡ä»¶ç®¡ç†çš„ç†è§£ï¼Œè‡ªå·±å¤§è‡´è¯´ä¸‹ç†è§£ã€‚<!-- TOC -->

- [ç¼–ç¨‹è¯­è¨€](#ç¼–ç¨‹è¯­è¨€)
    - [1ã€Pythonå®ç°å•ä¾‹æ¨¡å¼](#1Pythonå®ç°å•ä¾‹æ¨¡å¼)

- [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„)
    - [2ã€äºŒç»´æ•°ç»„ä¸­çš„æŸ¥æ‰¾](#2äºŒç»´æ•°ç»„ä¸­çš„æŸ¥æ‰¾)
    - [3ã€æ›¿æ¢ç©ºæ ¼](#3æ›¿æ¢ç©ºæ ¼)
    - [4ã€ä»å°¾åˆ°å¤´æ‰“å°å•é“¾è¡¨](#4ä»å°¾åˆ°å¤´æ‰“å°å•é“¾è¡¨)
    - [5ã€é‡å»ºäºŒå‰æ ‘](#5é‡å»ºäºŒå‰æ ‘)
    - [6ã€ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—](#6ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—)
- [ç®—æ³•å’Œæ•°æ®æ“ä½œ](ç®—æ³•å’Œæ•°æ®æ“ä½œ)
    - [7ã€æ—‹è½¬æ•°ç»„çš„æœ€å°æ•°å­—](#7æ—‹è½¬æ•°ç»„çš„æœ€å°æ•°å­—)
    - [8ã€æ–æ³¢é‚£å¥‘æ•°åˆ—](#8æ–æ³¢é‚£å¥‘æ•°åˆ—)
    - [9ã€äºŒè¿›åˆ¶ä¸­1çš„ä¸ªæ•°](#9äºŒè¿›åˆ¶ä¸­1çš„ä¸ªæ•°)


<!-- /TOC -->
## ç¼–ç¨‹è¯­è¨€
### 1ã€Pythonå®ç°å•ä¾‹æ¨¡å¼

#### æ–¹æ³•ä¸€ ä½¿ç”¨__new__å®ç°å•ä¾‹æ¨¡å¼
> ä½¿ç”¨__new__å®ç°å•ä¾‹æ¨¡å¼ï¼Œå…·ä½“æˆ‘å¯¹__new__çš„ç†è§£å¯ä»¥ç‚¹[è¿™é‡Œ](http://www.cnblogs.com/qiaojushuang/p/7805973.html)
```python
# coding=utf-8
"""
ä½¿ç”¨__new__å®ç°å•ä¾‹æ¨¡å¼
"""


class SingleTon(object):
    _instance = {}

    def __new__(cls, *args, **kwargs):
        if cls not in cls._instance:
            cls._instance[cls] = super(SingleTon, cls).__new__(cls, *args, **kwargs)
        # print cls._instance
        return cls._instance[cls]


class MyClass(SingleTon):
    class_val = 22

    def __init__(self, val):
        self.val = val

    def obj_fun(self):
        print self.val, 'obj_fun'

    @staticmethod
    def static_fun():
        print 'staticmethod'

    @classmethod
    def class_fun(cls):
        print cls.class_val, 'classmethod'


if __name__ == '__main__':
    a = MyClass(1)
    b = MyClass(2)
    print a is b   # True
    print id(a), id(b)  # 4367665424 4367665424
    # ç±»å‹éªŒè¯
    print type(a)  # <class '__main__.MyClass'>
    print type(b)  # <class '__main__.MyClass'>
    # å®ä¾‹æ–¹æ³•
    a.obj_fun()  # 2 obj_fun
    b.obj_fun()  # 2 obj_fun
    # ç±»æ–¹æ³•
    MyClass.class_fun()  # 22 classmethod
    a.class_fun()  # 22 classmethod
    b.class_fun()  # 22 classmethod
    # é™æ€æ–¹æ³•
    MyClass.static_fun()  # staticmethod
    a.static_fun()  # staticmethod
    b.static_fun()  # staticmethod
    # ç±»å˜é‡
    a.class_val = 33
    print MyClass.class_val  # 22
    print a.class_val  # 33
    print b.class_val  # 33
    # å®ä¾‹å˜é‡
    print b.val  # 2
    print a.val  # 2
```

#### æ–¹æ³•äºŒ ä½¿ç”¨è£…é¥°å™¨å®ç°å•ä¾‹æ¨¡å¼
```python
from functools import wraps


def single_ton(cls):
    _instance = {}

    @wraps(cls)
    def single(*args, **kwargs):
        if cls not in _instance:
            _instance[cls] = cls(*args, **kwargs)
        return _instance[cls]
    return single


@single_ton
class SingleTon(object):
    val = 123

    def __init__(self, a):
        self.a = a

if __name__ == '__main__':
    s = SingleTon(1)
    t = SingleTon(2)
    print s is t
    print s.a, t.a
    print s.val, t.val
```

#### æ–¹æ³•ä¸‰ ä½¿ç”¨æ¨¡å—å®ç°å•ä¾‹æ¨¡å¼
> å¯ä»¥ä½¿ç”¨æ¨¡å—åˆ›å»ºå•ä¾‹æ¨¡å¼ï¼Œç„¶ååœ¨å…¶ä»–æ¨¡å—ä¸­å¯¼å…¥è¯¥å•ä¾‹ï¼Œè¿™ä¸ªéœ€è¦æ‰€æœ‰äººéµå®ˆå¯¼å…¥è§„åˆ™ï¼Œä¸ç„¶å°±æ²¡æ³•å®ç°å•ä¾‹äº†

```python
# use_module.py
class SingleTon(object):

    def __init__(self, val):
        self.val = val

single = SingleTon(2)

# test_module.py
from use_module import single

a = single
b = single
print a.val, b.val
print a is b
a.val = 233
print a.val, b.val
```

#### æ–¹æ³•å›› ä½¿ç”¨metaclasså®ç°å•ä¾‹æ¨¡å¼
> ç›®å‰æˆ‘å¯¹å…ƒç±»è¿˜äº†è§£ä¸æ·±ï¼Œä»¥åæ¥å¡«å‘

## æ•°æ®ç»“æ„

### 2ã€äºŒç»´æ•°ç»„ä¸­çš„æŸ¥æ‰¾
> é¢˜ç›®ï¼šäºŒç»´æ•°ç»„ä¸­ï¼Œæ¯è¡Œä»å·¦åˆ°å³é€’å¢ï¼Œæ¯åˆ—ä»ä¸Šåˆ°ä¸‹é€’å¢ï¼Œç»™å‡ºä¸€ä¸ªæ•°ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦åœ¨æ•°ç»„ä¸­ ([LeetCode](https://leetcode.com/problems/search-a-2d-matrix-ii/))
>
> æ€è·¯ï¼šä»å·¦ä¸‹è§’æˆ–è€…å³ä¸Šè§’å¼€å§‹æ¯”è¾ƒ

```python
# coding=utf-8
# äºŒç»´æ•°ç»„ä¸­ï¼Œæ¯è¡Œä»å·¦åˆ°å³é€’å¢ï¼Œæ¯åˆ—ä»ä¸Šåˆ°ä¸‹é€’å¢ï¼Œç»™å‡ºä¸€ä¸ªæ•°ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦åœ¨æ•°ç»„ä¸­
# ä»å·¦ä¸‹è§’ï¼ˆæˆ–å³ä¸Šè§’ï¼‰å¼€å§‹éå†æ•°ç»„


def find_integer(matrix, num):
    """
    :param matrix: [[]]
    :param num: int
    :return: bool
    """
    if not matrix:
        return False
    rows, cols = len(matrix), len(matrix[0])
    row, col = rows - 1, 0
    while row >= 0 and col <= cols - 1:
        if matrix[row][col] == num:
            return True
        elif matrix[row][col] > num:
            row -= 1
        else:
            col += 1
    return False


if __name__ == '__main__':
    matrix = [[1, 2, 3],
              [2, 3, 6],
              [3, 6, 7]]
    num = 6
    print find_integer(matrix, num)
```

### 3ã€æ›¿æ¢ç©ºæ ¼
> é¢˜ç›®ï¼šæŠŠå­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼æ›¿æ¢æˆ'20%'
>
>æ–¹æ³•1ï¼šç›´æ¥ä½¿ç”¨Pythonå­—ç¬¦ä¸²çš„å†…ç½®å‡½æ•°

```python
>>> ' a  b  '.replace(' ', '20%')
```
> æ–¹æ³•2: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼

```python
>>> import re
>>> ret = re.compile(' ')
>>> ret.sub('20%', '  a  b  ')
```

### 4ã€ä»å°¾åˆ°å¤´æ‰“å°å•é“¾è¡¨
> æ–¹æ³•1ï¼šä½¿ç”¨æ ˆ,å¯ä»¥ä½¿ç”¨åˆ—è¡¨æ¨¡æ‹Ÿ

```python
# coding=utf-8
"""
ä»å°¾åˆ°å¤´æ‰“å°å•é“¾è¡¨
æ€è·¯1ï¼šä½¿ç”¨æ ˆ
æ€è·¯2ï¼šé€’å½’
"""


class ListNode(object):
    def __init__(self, x):
        self.val = x
        self.next = None


class Link(object):

    @staticmethod
    def link(values):
        head = ListNode(0)
        move = head
        try:
            for val in values:
                tmp = ListNode(val)
                move.next = tmp
                move = move.next
        except Exception as e:
            print e
        return head.next


def print_links(links):
    stack = []
    while links:
        stack.append(links.val)
        links = links.next
    while stack:
        print stack.pop()


def print_link_recursion(links):
    if links:
        print_link_recursion(links.next)
        print links.val

if __name__ == '__main__':
    head = Link.link([1, 2, 3, 4, 5, 6])
    # print_links(head)
    print_link_recursion(head)
```
> æ–¹æ³•2ï¼šç›´æ¥é€’å½’

```python
def print_link_recursion(links):
    if links:
        print_link_recursion(links.next)
        print links.val
```

### 5ã€é‡å»ºäºŒå‰æ ‘ [LeetCode](https://leetcode.com/problems/construct-binary-tree-from-preorder-and-inorder-traversal/)
> è¦æ±‚ï¼šç”¨å‰åºå’Œä¸­åºéå†ç»“æœæ„å»ºäºŒå‰æ ‘ï¼Œéå†ç»“æœä¸­ä¸åŒ…å«é‡å¤å€¼
>
> æ€è·¯ï¼šå‰åºçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ ¹ç»“ç‚¹çš„å€¼ï¼Œåœ¨ä¸­åºä¸­æ‰¾åˆ°è¯¥å€¼ï¼Œä¸­åºä¸­è¯¥å€¼çš„å·¦è¾¹çš„å…ƒç´ æ˜¯æ ¹ç»“ç‚¹çš„å·¦å­æ ‘ï¼Œå³è¾¹æ˜¯å³å­æ ‘ï¼Œç„¶åé€’å½’çš„å¤„ç†å·¦è¾¹å’Œå³è¾¹
>
> **æç¤º**ï¼šäºŒå‰æ ‘ç»“ç‚¹ï¼Œä»¥åŠå¯¹äºŒå‰æ ‘çš„å„ç§æ“ä½œï¼Œæµ‹è¯•ä»£ç è§six.py
```python
# coding=utf-8

"""
ä½¿ç”¨å…ˆåºéå†å’Œä¸­åºéå†çš„ç»“æœé‡å»ºäºŒå‰æ ‘
"""
from collections import deque


class TreeNode(object):
    """
    äºŒå‰æ ‘ç»“ç‚¹å®šä¹‰
    """
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    """
    äºŒå‰æ ‘
    """
    def __init__(self):
        self.root = None

    def bfs(self):
        ret = []
        queue = deque([self.root])
        while queue:
            node = queue.popleft()
            if node:
                ret.append(node.val)
                queue.append(node.left)
                queue.append(node.right)
        return ret

    def pre_traversal(self):
        ret = []

        def traversal(head):
            if not head:
                return
            ret.append(head.val)
            traversal(head.left)
            traversal(head.right)

        traversal(self.root)
        return ret

    def in_traversal(self):
        ret = []

        def traversal(head):
            if not head:
                return
            traversal(head.left)
            ret.append(head.val)
            traversal(head.right)

        traversal(self.root)
        return ret

    def post_traversal(self):
        ret = []

        def traversal(head):
            if not head:
                return
            traversal(head.left)
            traversal(head.right)
            ret.append(head.val)

        traversal(self.root)
        return ret


def construct_tree(preorder=None, inorder=None):
    """
    æ„å»ºäºŒå‰æ ‘
    """
    if not preorder or not inorder:
        return None
    index = inorder.index(preorder[0])
    left = inorder[0:index]
    right = inorder[index+1:]
    root = TreeNode(preorder[0])
    root.left = construct_tree(preorder[1:1+len(left)], left)
    root.right = construct_tree(preorder[-len(right):], right)
    return root


if __name__ == '__main__':
    t = Tree()
    root = construct_tree([1, 2, 4, 7, 3, 5, 6, 8], [4, 7, 2, 1, 5, 3, 8, 6])
    t.root = root
    print t.bfs()
    print t.pre_traversal()
    print t.in_traversal()
    print t.post_traversal()
```

### 6ã€ç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—
> è¦æ±‚ï¼šç”¨ä¸¤ä¸ªæ ˆå®ç°é˜Ÿåˆ—ï¼Œåˆ†åˆ«å®ç°å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ
> æ€è·¯ï¼šä¸€ä¸ªæ ˆè´Ÿè´£å…¥é˜Ÿï¼Œå¦ä¸€ä¸ªè´Ÿè´£å‡ºé˜Ÿï¼Œå‡ºæ ˆä¸ºç©ºåˆ™ä»å…¥æ ˆä¸­å¯¼å…¥åˆ°å‡ºæ ˆä¸­

```python
class MyQueue(object):
    def __init__(self):
        self.stack = []
        self.stack2 = []

    def push(self, val):
        self.stack.append(val)

    def pop(self):
        if self.stack2:
            return self.stack2.pop()
        while self.stack:
            self.stack2.append(self.stack.pop())
        return self.stack2.pop() if self.stack2 else u'é˜Ÿåˆ—ä¸ºç©º'
```

## ç®—æ³•å’Œæ•°æ®æ“ä½œ

### 7ã€æ—‹è½¬æ•°ç»„çš„æœ€å°æ•°å­—
> è¦æ±‚ï¼šæŠŠé€’å¢æ•°ç»„çš„å‰é¢éƒ¨åˆ†æ•°å­—ç§»åˆ°é˜Ÿå°¾ï¼Œæ±‚æ•°ç»„ä¸­çš„æœ€å°å€¼ï¼Œä¾‹å¦‚[3,4,5,6,1,2]
>
> æ€è·¯ï¼šä½¿ç”¨äºŒåˆ†æ³•ï¼Œä½†è¦è€ƒè™‘[1, 0, 0, 1]è¿™ç§æ•°æ®ï¼Œåªèƒ½é¡ºåºæŸ¥æ‰¾

```python
# coding=utf-8
"""
æ±‚æ—‹è½¬æ•°ç»„ä¸­çš„æœ€å°å€¼
äºŒåˆ†æ³•
éœ€è¦è€ƒè™‘[1, 0, 0, 1]è¿™ç§æ•°æ®ï¼Œåªèƒ½ä»å¤´æŸ¥æ‰¾
"""


def find_min(nums):
    if not nums:
        return False
    length = len(nums)
    left, right = 0, length - 1
    while nums[left] >= nums[right]:
        if right - left == 1:
            return nums[right]
        mid = (left + right) / 2
        if nums[left] == nums[mid] == nums[right]:
            return min(nums)
        if nums[left] <= nums[mid]:
            left = mid
        if nums[right] >= nums[mid]:
            right = mid
    return nums[0]

if __name__ == '__main__':
    print find_min([2, 2, 4, 5, 6, 2])
    print find_min([1, 0, 0, 1])
```

### 8ã€æ–æ³¢é‚£å¥‘æ•°åˆ—
> æ€è·¯ï¼šç”¨ç”Ÿæˆå™¨

```python
# coding=utf-8
"""
æ–æ³¢é‚£å¥‘æ•°åˆ—
ç›´æ¥ä½¿ç”¨ç”Ÿæˆå™¨ï¼Œ èŠ‚çœå†…å­˜
"""


def fib(num):
    a, b = 0, 1
    for i in xrange(num):
        yield b
        a, b = b, a + b


if __name__ == '__main__':
    print [n for n in fib(10)]
```

### 9ã€äºŒè¿›åˆ¶ä¸­1çš„ä¸ªæ•°
> è¦æ±‚ï¼šæ±‚ä¸€ä¸ªæ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œ1çš„ä¸ªæ•°
>
> æ€è·¯ï¼šäºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œæœ€åçš„é‚£ä¸ª1è¢«å‡å»åï¼Œä½ä½éƒ½å˜ä¸º0ï¼Œé«˜ä½ä¸å˜ï¼ŒæŒ‰ä½ä¸å°±å¯ä»¥å»æ‰è¿™ä¸ª1


```python
# coding=utf-8
"""
æ±‚ä¸€ä¸ªæ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œ1çš„ä¸ªæ•°
äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œæœ€åçš„é‚£ä¸ª1è¢«å‡å»åï¼Œä½ä½éƒ½å˜ä¸º0ï¼Œé«˜ä½ä¸å˜ï¼ŒæŒ‰ä½ä¸å°±å¯ä»¥å»æ‰è¿™ä¸ª1
"""


def num_of_1(n):
    ret = 0
    while n:
        ret += 1
        n = n & n-1
    return ret

if __name__ == '__main__':
    print bin(100).count('1') == num_of_1(100)
```
<!-- TOC -->

- [ä»£ç çš„å®Œæ•´æ€§](#ä»£ç çš„å®Œæ•´æ€§)
    - [1ã€æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹](#1æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹)
    - [2ã€æ‰“å°1åˆ°æœ€å¤§çš„nä½æ•°](#2æ‰“å°1åˆ°æœ€å¤§çš„nä½æ•°)
    - [3ã€O(1)æ—¶é—´åˆ é™¤é“¾è¡¨ç»“ç‚¹](#3O(1)æ—¶é—´åˆ é™¤é“¾è¡¨ç»“ç‚¹)
    - [4ã€è°ƒæ•´æ•°ç»„é¡ºåºä½¿å¯„æ•°ä½äºå¶æ•°å‰é¢](#4è°ƒæ•´æ•°ç»„é¡ºåºä½¿å¯„æ•°ä½äºå¶æ•°å‰é¢)

- [ä»£ç çš„é²æ£’æ€§](#ä»£ç çš„é²æ£’æ€§)
    - [5ã€é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªç»“ç‚¹](#5é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªç»“ç‚¹)
    - [6ã€åè½¬é“¾è¡¨](#6åè½¬é“¾è¡¨)
    - [7ã€åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨](#7åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨)
    - [8ã€æ ‘çš„å­ç»“æ„](#8æ ‘çš„å­ç»“æ„)



<!-- /TOC -->
## ä»£ç çš„å®Œæ•´æ€§
### 1ã€æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹

> è¦æ±‚ï¼šæ±‚ä¸€ä¸ªæ•°çš„æ•´æ•°æ¬¡æ–¹
>
> æ€è·¯ï¼šéœ€è¦è€ƒè™‘æ¬¡æ–¹æ˜¯æ­£æ•°ã€è´Ÿæ•°å’Œ0ï¼ŒåŸºæ•°æ˜¯0
>
> æµ®ç‚¹æ•°ç›¸ç­‰ä¸èƒ½ç›´æ¥ç”¨==

```python
def power(base, exponent):
    if equal_zero(base) and exponent < 0:
        raise ZeroDivisionError
    ret = power_value(base, abs(exponent))
    if exponent < 0:
        return 1.0 / ret
    else:
        return ret


def equal_zero(num):
    if abs(num - 0.0) < 0.0000001:
        return True


def power_value(base, exponent):
    if exponent == 0:
        return 1
    if exponent == 1:
        return base
    ret = power_value(base, exponent >> 1)
    ret *= ret
    if exponent & 1 == 1:
        ret *= base
    return ret
```

### 2ã€æ‰“å°1åˆ°æœ€å¤§çš„nä½æ•°
> è¦æ±‚ï¼šè¾“å…¥nï¼Œæ‰“å°å‡ºä»1åˆ°æœ€å¤§çš„nä½æ•°
>
> æ€è·¯ï¼šPythonä¸­å·²ç»å¯¹å¤§æ•´æ•°å¯ä»¥è¿›è¡Œè‡ªåŠ¨è½¬æ¢äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘å¤§æ•´æ•°æº¢å‡ºé—®é¢˜

```python
def print_max_n(n):
    for i in xrange(10 ** n):
        print i
```

### 3ã€O(1)æ—¶é—´åˆ é™¤é“¾è¡¨ç»“ç‚¹
> è¦æ±‚ï¼šO(1)æ—¶é—´åˆ é™¤é“¾è¡¨ç»“ç‚¹
>
> æ€è·¯ï¼šå¦‚æœæœ‰åç»­ç»“ç‚¹ï¼Œåç»­ç»“ç‚¹çš„å€¼å‰ç§»ï¼Œåˆ é™¤åç»­ç»“ç‚¹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåªèƒ½é¡ºåºæŸ¥æ‰¾äº†

```python
def delete_node(link, node):
    if node == link:  # åªæœ‰ä¸€ä¸ªç»“ç‚¹
        del node
    if node.next is None:  # nodeæ˜¯å°¾ç»“ç‚¹
        while link:
            if link.next == node:
                link.next = None
            link = link.next
    else:
        node.val = node.next.val
        n_node = node.next
        node.next = n_node.next
        del n_node
```
### 4ã€è°ƒæ•´æ•°ç»„é¡ºåºä½¿å¥‡æ•°ä½äºå¶æ•°å‰é¢
> æ€è·¯ï¼šä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œå‰åå„ä¸€ä¸ªï¼Œä¸ºäº†æ›´å¥½çš„æ‰©å±•æ€§ï¼Œå¯ä»¥æŠŠåˆ¤æ–­å¥‡å¶éƒ¨åˆ†æŠ½å–å‡ºæ¥

```python
def reorder(nums, func):
    left, right = 0, len(nums) - 1
    while left < right:
        while not func(nums[left]):
            left += 1
        while func(nums[right]):
            right -= 1
        if left < right:
            nums[left], nums[right] = nums[right], nums[left]


def is_even(num):
    return (num & 1) == 0
```

## ä»£ç çš„é²æ£’æ€§

### 5ã€é“¾è¡¨ä¸­å€’æ•°ç¬¬kä¸ªç»“ç‚¹
> è¦æ±‚ï¼šæ±‚å•é“¾è¡¨ä¸­çš„å€’æ•°ç¬¬kä¸ªç»“ç‚¹
>
> æ€è·¯ï¼šä½¿ç”¨å¿«æ…¢æŒ‡é’ˆï¼Œå¿«çš„å…ˆèµ°k-1æ­¥ï¼Œéœ€è¦è€ƒè™‘ç©ºé“¾è¡¨ä»¥åŠkä¸º0

```python
def last_kth(link, k):
    if not link or k <= 0:
        return None
    move = link
    while move and k-1 >= 0:
        move = move.next
        k -= 1
    while move:
        move = move.next
        link = link.next
    if k == 0:
        return link.val
    return None
```

### 6ã€åè½¬é“¾è¡¨
> è¦æ±‚ï¼šåè½¬é“¾è¡¨
>
> æ€è·¯ï¼šéœ€è¦è€ƒè™‘ç©ºé“¾è¡¨ï¼Œåªæœ‰ä¸€ä¸ªç»“ç‚¹çš„é“¾è¡¨

```python
def reverse_link(head):
    if not head or not head.next:
        return head
    then = head.next
    head.next = None
    last = then.next
    while then:
        then.next = head
        head = then
        then = last
        if then:
            last = then.next
    return head
```

### 7ã€åˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨
> è¦æ±‚ï¼šåˆå¹¶ä¸¤ä¸ªæ’åºçš„é“¾è¡¨
>
> æ€è·¯ï¼šä½¿ç”¨é€’å½’

```python
def merge_link(head1, head2):
    if not head1:
        return head2
    if not head2:
        return head1
    if head1.val <= head2.val:
        ret = head1
        ret.next = merge_link(head1.next, head2)
    else:
        ret = head2
        ret.next = merge_link(head1, head2.next)
    return ret

```

### 8ã€æ ‘çš„å­ç»“æ„
> è¦æ±‚ï¼šåˆ¤æ–­ä¸€æ£µäºŒå‰æ ‘æ˜¯ä¸æ˜¯å¦ä¸€ä¸ªçš„å­ç»“æ„
>
> æ€è·¯ï¼šä½¿ç”¨é€’å½’

```python
def sub_tree(tree1, tree2):
    if tree1 and tree2:
        if tree1.val == tree2.val:
            return sub_tree(tree1.left, tree2.left) and sub_tree(tree1.right, tree2.right)
        else:
            return sub_tree(tree1.left, tree2) or sub_tree(tree1.right, tree2)
    if not tree1 and tree2:
        return False
    return True
```<!-- TOC -->

- [ç”»å›¾è®©æŠ½è±¡é—®é¢˜å½¢è±¡åŒ–](#ç”»å›¾è®©æŠ½è±¡é—®é¢˜å½¢è±¡åŒ–)
    - [1ã€äºŒå‰æ ‘çš„é•œåƒ](#1äºŒå‰æ ‘çš„é•œåƒ)
    - [2ã€é¡ºæ—¶é’ˆæ‰“å°çŸ©é˜µ](#2é¡ºæ—¶é’ˆæ‰“å°çŸ©é˜µ)

- [ä¸¾ä¾‹è®©æŠ½è±¡é—®é¢˜å…·ä½“åŒ–](#ä¸¾ä¾‹è®©æŠ½è±¡é—®é¢˜å…·ä½“åŒ–)
    - [3ã€åŒ…å«minå‡½æ•°çš„æ ˆ](#3åŒ…å«minå‡½æ•°çš„æ ˆ)
    - [4ã€æ ˆçš„å‹å…¥å¼¹å‡ºåºåˆ—](#4æ ˆçš„å‹å…¥å¼¹å‡ºåºåˆ—)
    - [5ã€ä»ä¸Šå¾€ä¸‹æ‰“å°äºŒå‰æ ‘](#5ä»ä¸Šå¾€ä¸‹æ‰“å°äºŒå‰æ ‘)
    - [6ã€äºŒå‰æ ‘çš„ååºéå†åºåˆ—](#6äºŒå‰æ ‘çš„ååºéå†åºåˆ—)
    - [7ã€äºŒå‰æ ‘ä¸­å’Œä¸ºæŸä¸€å€¼çš„è·¯å¾„](#7äºŒå‰æ ‘ä¸­å’Œä¸ºæŸä¸€å€¼çš„è·¯å¾„)

- [åˆ†è§£è®©å¤æ‚é—®é¢˜ç®€å•åŒ–](#åˆ†è§£è®©å¤æ‚é—®é¢˜ç®€å•åŒ–)
    - [8ã€å¤æ‚é“¾è¡¨çš„å¤åˆ¶](#8å¤æ‚é“¾è¡¨çš„å¤åˆ¶)
    - [9ã€äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨](#9äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨)
    - [10ã€å­—ç¬¦ä¸²çš„æ’åˆ—](#10å­—ç¬¦ä¸²çš„æ’åˆ—)


<!-- /TOC -->
## ç”»å›¾è®©æŠ½è±¡é—®é¢˜å½¢è±¡åŒ–
### 1ã€äºŒå‰æ ‘çš„é•œåƒ

> æ€è·¯ä¸€ï¼šå¯ä»¥æŒ‰å±‚æ¬¡éå†ï¼Œæ¯ä¸€å±‚ä»å³åˆ°å·¦
>
> æ€è·¯äºŒï¼šä½¿ç”¨é€’å½’


```python
# coding=utf-8
"""
æ±‚äºŒå‰æ ‘çš„é•œåƒ
æ€è·¯ä¸€ï¼šæŒ‰å±‚æ¬¡éå†ï¼Œæ¯ä¸€å±‚ä»å³åˆ°å·¦
æ€è·¯äºŒï¼šé€’å½’éå†
"""
from collections import deque


class TreeNode(object):
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    def __init__(self):
        self.root = None

    def construct_tree(self, values=None):
        if not values:
            return None
        self.root = TreeNode(values[0])
        queue = deque([self.root])
        leng = len(values)
        nums = 1
        while nums < leng:
            node = queue.popleft()
            if node:
                node.left = TreeNode(values[nums]) if values[nums] else None
                queue.append(node.left)
                if nums + 1 < leng:
                    node.right = TreeNode(values[nums + 1]) if values[nums + 1] else None
                    queue.append(node.right)
                    nums += 1
                nums += 1

    def bfs(self):
        ret = []
        queue = deque([self.root])
        while queue:
            node = queue.popleft()
            if node:
                ret.append(node.val)
                queue.append(node.left)
                queue.append(node.right)
        return ret


def mirror_bfs(root):
    ret = []
    queue = deque([root])
    while queue:
        node = queue.popleft()
        if node:
            ret.append(node.val)
            queue.append(node.right)
            queue.append(node.left)
    return ret


def mirror_pre(root):
    ret = []

    def traversal(root):
        if root:
            ret.append(root.val)
            traversal(root.right)
            traversal(root.left)
    traversal(root)
    return ret


if __name__ == '__main__':
    t = Tree()
    t.construct_tree([1, 2, 6, 4, 3, 7, 5])
    print t.bfs()
    print mirror_bfs(t.root)
    print mirror_pre(t.root)
```

### 2ã€é¡ºæ—¶é’ˆæ‰“å°çŸ©é˜µ

> æ€è·¯ï¼šæ¯ä¸€åœˆçš„å¼€å§‹ä½ç½®æ€»æ˜¯åä¸Šè§’å…ƒç´ [0, 0], [1, 1]...

```python
# coding=utf-8
"""
æŒ‰ä»å¤–åˆ°é‡Œçš„é¡ºåºé¡ºæ—¶é’ˆæ‰“å°çŸ©é˜µ
æ¯ä¸€åœˆçš„å¼€å§‹ä½ç½®æ€»æ˜¯åä¸Šè§’å…ƒç´ [0, 0], [1, 1]...
"""


def print_matrix(matrix):
    """
    :param matrix: [[]]
    """
    rows = len(matrix)
    cols = len(matrix[0]) if matrix else 0
    start = 0
    ret = []
    while start * 2 < rows and start * 2 < cols:
        print_circle(matrix, start, rows, cols, ret)
        start += 1
    print ret


def print_circle(matrix, start, rows, cols, ret):
    row = rows - start - 1  # æœ€åä¸€è¡Œ
    col = cols - start - 1
    # left->right
    for c in range(start, col+1):
        ret.append(matrix[start][c])
    # top->bottom
    if start < row:
        for r in range(start+1, row+1):
            ret.append(matrix[r][col])
    # right->left
    if start < row and start < col:
        for c in range(start, col)[::-1]:
            ret.append(matrix[row][c])
    # bottom->top
    if start < row and start < col:
        for r in range(start+1, row)[::-1]:
            ret.append(matrix[r][start])


if __name__ == '__main__':
    """
    mat = [[1, 2, 3],
           [5, 6, 7],
           [9, 10, 11]]
    mat = [[]]
    mat = [[1]]
    mat = [[1, 2, 3, 4]]
    mat = [[1], [2], [3], [4]]
    """
    mat = [[1, 2],
           [5, 6]]
    print_matrix(mat)
```

## ä¸¾ä¾‹è®©æŠ½è±¡é—®é¢˜å…·ä½“åŒ–

### 3ã€åŒ…å«minå‡½æ•°çš„æ ˆ
> è¦æ±‚ï¼šæ ˆçš„pushï¼Œpopï¼Œminæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)
>
> æ€è·¯ï¼šä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ ˆä¿å­˜æœ€å°å€¼

```python
# coding=utf-8
"""
åŒ…å«minå‡½æ•°çš„æ ˆ
æ ˆçš„pushï¼Œpopï¼Œminæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)
ä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ ˆä¿å­˜æœ€å°å€¼
"""


class MyStack(object):

    def __init__(self):
        self.stack = []
        self.min = []

    def push(self, val):
        self.stack.append(val)
        if self.min and self.min[-1] < val:
            self.min.append(self.min[-1])
        else:
            self.min.append(val)

    def pop(self):
        if self.stack:
            self.min.pop()
            return self.stack.pop()
        return None

    def min(self):
        return self.min[-1] if self.min else None

if __name__ == '__main__':
    s = MyStack()
    s.push(2)
    s.push(1)
    s.push(3)
    s.pop()
    s.push(2)
    print s.stack
    print s.min
```

### 4ã€æ ˆçš„å‹å…¥å¼¹å‡ºåºåˆ—
> è¦æ±‚ï¼šåˆ¤æ–­ç»™å®šçš„ä¸¤ä¸ªåºåˆ—ä¸­ï¼Œåè€…æ˜¯ä¸æ˜¯å‰è€…çš„å¼¹å‡ºåºåˆ—ï¼Œç»™å®šæ ˆä¸åŒ…å«ç›¸åŒå€¼
>
> æ€è·¯ï¼šä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ ˆ, å¦‚æœè¾…åŠ©æ ˆæ ˆé¡¶å…ƒç´ ä¸ç­‰äºå‡ºæ ˆå…ƒç´ ï¼Œåˆ™ä»å…¥æ ˆä¸­æ‰¾æ”¹å€¼ï¼Œç›´åˆ°å…¥æ ˆä¸ºç©º
> å¦‚æœæœ€åå‡ºæ ˆåºåˆ—ä¸ºç©ºï¼Œåˆ™æ˜¯å…¥æ ˆçš„å¼¹å‡ºåºåˆ—å€¼

```python
# coding=utf-8
"""
æ ˆçš„å‹å…¥å¼¹å‡ºåºåˆ—ï¼Œåˆ¤æ–­ç»™å®šçš„ä¸¤ä¸ªåºåˆ—ä¸­ï¼Œåè€…æ˜¯ä¸æ˜¯å‰è€…çš„å¼¹å‡ºåºåˆ—
åºåˆ—ä¸­ä¸å­˜åœ¨ç›¸åŒå€¼
ä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ ˆ, å¦‚æœè¾…åŠ©æ ˆæ ˆé¡¶å…ƒç´ ä¸ç­‰äºå‡ºæ ˆå…ƒç´ ï¼Œåˆ™ä»å…¥æ ˆä¸­æ‰¾æ”¹å€¼ï¼Œç›´åˆ°å…¥æ ˆä¸ºç©º
å¦‚æœæœ€åå‡ºæ ˆåºåˆ—ä¸ºç©ºï¼Œåˆ™æ˜¯å…¥æ ˆçš„å¼¹å‡ºåºåˆ—
"""


def pop_order(push_stack, pop_stack):
    if not push_stack or not pop_stack:
        return False
    stack = []
    while pop_stack:
        pop_val = pop_stack[0]
        if stack and stack[-1] == pop_val:
            stack.pop()
            pop_stack.pop(0)
        else:
            while push_stack:
                if push_stack[0] != pop_val:
                    stack.append(push_stack.pop(0))
                else:
                    push_stack.pop(0)
                    pop_stack.pop(0)
                    break
        if not push_stack:
            while stack:
                if stack.pop() != pop_stack.pop(0):
                    return False
    if not pop_stack:
        return True
    return False


if __name__ == '__main__':
    print pop_order([1, 2, 3], [2, 3, 1])
```

### 5ã€ä»ä¸Šå¾€ä¸‹æ‰“å°äºŒå‰æ ‘
> æ€è·¯ï¼šå¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ŒæŒ‰å±‚æ¬¡éå†

```python
# coding=utf-8
"""
ä»ä¸Šå¾€ä¸‹æ‰“å°äºŒå‰æ ‘
æ ‘çš„å¹¿åº¦ä¼˜å…ˆï¼ŒæŒ‰å±‚æ¬¡éå†ï¼Œä½¿ç”¨ä¸€ä¸ªè¾…åŠ©é˜Ÿåˆ—å°±å¯ä»¥
"""


from collections import deque


class TreeNode(object):
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    def __init__(self):
        self.root = None

    def construct_tree(self, values=None):
        if not values:
            return None
        self.root = TreeNode(values[0])
        queue = deque([self.root])
        leng = len(values)
        nums = 1
        while nums < leng:
            node = queue.popleft()
            if node:
                node.left = TreeNode(values[nums]) if values[nums] else None
                queue.append(node.left)
                if nums + 1 < leng:
                    node.right = TreeNode(values[nums + 1]) if values[nums + 1] else None
                    queue.append(node.right)
                    nums += 1
                nums += 1

    def bfs(self):
        ret = []
        queue = deque([self.root])
        while queue:
            node = queue.popleft()
            if node:
                ret.append(node.val)
                queue.append(node.left)
                queue.append(node.right)
        return ret


def bfs(tree):
    if not tree:
        return None
    stack = [tree]
    ret = []
    while stack:
        node = stack.pop(0)
        ret.append(node.val)
        if node.left:
            stack.append(node.left)
        if node.right:
            stack.append(node.right)
    return ret

if __name__ == '__main__':
    t = Tree()
    t.construct_tree([1, 2, 6, 4, 3, 7, 5])
    print t.bfs()
    print bfs(t.root)
```

### 6ã€äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—
> è¦æ±‚ï¼šåˆ¤æ–­ç»™å®šçš„æ•´æ•°æ•°ç»„æ˜¯ä¸æ˜¯äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—
>
> æ•´æ•°æ•°ç»„ä¸­ä¸åŒ…å«é‡å¤å€¼
>
> æ•´æ•°åºåˆ—çš„æœ€åä¸€ä¸ªå€¼æ˜¯æ ¹ç»“ç‚¹ï¼Œç„¶åæ¯”æ ¹ç»“ç‚¹å°çš„å€¼æ˜¯å·¦å­æ ‘ï¼Œå‰©ä¸‹çš„æ˜¯å³å­æ ‘ï¼Œé€’å½’å·¦å³å­æ ‘

```python
# coding=utf-8
"""
åˆ¤æ–­ç»™å®šçš„æ•´æ•°æ•°ç»„æ˜¯ä¸æ˜¯äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—
æ•´æ•°æ•°ç»„ä¸­ä¸åŒ…å«é‡å¤å€¼
æ•´æ•°åºåˆ—çš„æœ€åä¸€ä¸ªå€¼æ˜¯æ ¹ç»“ç‚¹ï¼Œç„¶åæ¯”æ ¹ç»“ç‚¹å°çš„å€¼æ˜¯å·¦å­æ ‘ï¼Œå‰©ä¸‹çš„æ˜¯å³å­æ ‘ï¼Œé€’å½’å·¦å³å­æ ‘
"""


def is_post_order(order):
    length = len(order)
    if length:
        root = order[-1]
        left = 0
        while order[left] < root:
            left += 1
        right = left
        while right < length - 1:
            if order[right] < root:
                return False
            right += 1
        left_ret = True if left == 0 else is_post_order(order[:left])
        right_ret = True if left == right else is_post_order(order[left:right])
        return left_ret and right_ret
    return False


if __name__ == '__main__':
    print is_post_order([9, 6, 7])
```

### 7ã€äºŒå‰æ ‘ä¸­å’Œä¸ºæŸä¸€å€¼çš„è·¯å¾„
> è¦æ±‚ï¼šè¾“å…¥ä¸€æ£µäºŒå‰æ ‘å’Œä¸€ä¸ªå€¼ï¼Œæ±‚ä»æ ¹ç»“ç‚¹åˆ°å¶ç»“ç‚¹çš„å’Œç­‰äºè¯¥å€¼çš„è·¯å¾„
>
> æ·±åº¦ä¼˜å…ˆæœç´¢å˜å½¢

```python
# coding=utf-8
"""
è¾“å…¥ä¸€æ£µäºŒå‰æ ‘å’Œä¸€ä¸ªå€¼ï¼Œæ±‚ä»æ ¹ç»“ç‚¹åˆ°å¶ç»“ç‚¹çš„å’Œç­‰äºè¯¥å€¼çš„è·¯å¾„
æ·±åº¦ä¼˜å…ˆæœç´¢å˜å½¢
"""


from collections import deque


class TreeNode(object):
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    def __init__(self):
        self.root = None

    def construct_tree(self, values=None):
        if not values:
            return None
        self.root = TreeNode(values[0])
        queue = deque([self.root])
        leng = len(values)
        nums = 1
        while nums < leng:
            node = queue.popleft()
            if node:
                node.left = TreeNode(values[nums]) if values[nums] else None
                queue.append(node.left)
                if nums + 1 < leng:
                    node.right = TreeNode(values[nums + 1]) if values[nums + 1] else None
                    queue.append(node.right)
                    nums += 1
                nums += 1


def find_path(tree, num):
    ret = []
    if not tree:
        return ret
    path = [tree]
    sums = [tree.val]

    def dfs(tree):
        if tree.left:
            path.append(tree.left)
            sums.append(sums[-1]+tree.left.val)
            dfs(tree.left)
        if tree.right:
            path.append(tree.right)
            sums.append(sums[-1] + tree.right.val)
            dfs(tree.right)
        if not tree.left and not tree.right:
            if sums[-1] == num:
                ret.append([p.val for p in path])
        path.pop()
        sums.pop()

    dfs(tree)
    return ret


if __name__ == '__main__':
    t = Tree()
    t.construct_tree([1, 3, 6, 4, 3, 1, 1])
    print find_path(t.root, 8)
```

## åˆ†è§£è®©å¤æ‚é—®é¢˜ç®€å•åŒ–
### 8ã€å¤æ‚é“¾è¡¨çš„å¤åˆ¶

> è¦æ±‚ï¼šé“¾è¡¨ä¸­é™¤äº†æŒ‡å‘åä¸€ä¸ªç»“ç‚¹çš„æŒ‡é’ˆä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä»»æ„ç»“ç‚¹
>
> åˆ†ä¸ºä¸‰æ­¥å®Œæˆï¼š
> 
> ä¸€:å¤åˆ¶æ¯ä¸ªç»“ç‚¹ï¼Œå¹¶æŠŠæ–°ç»“ç‚¹æ”¾åœ¨è€ç»“ç‚¹åé¢ï¼Œå¦‚1->2,å¤åˆ¶ä¸º1->1->2->2
> 
> äºŒ:ä¸ºæ¯ä¸ªæ–°ç»“ç‚¹è®¾ç½®otheræŒ‡é’ˆ
> 
> ä¸‰:æŠŠå¤åˆ¶åçš„ç»“ç‚¹é“¾è¡¨æ‹†å¼€
> 
> é¢˜ç›®è®¾ç½®äº†å¤æ‚é“¾è¡¨çš„å®ç°ï¼Œæµ‹è¯•ä»£ç è§æ–‡ä»¶twenth_six.py


```python
# coding=utf-8
"""
å¤æ‚é“¾è¡¨çš„å¤åˆ¶
é“¾è¡¨ä¸­é™¤äº†æŒ‡å‘åä¸€ä¸ªç»“ç‚¹çš„æŒ‡é’ˆä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä»»æ„ç»“ç‚¹
åˆ†ä¸ºä¸‰æ­¥å®Œæˆï¼š
ä¸€å¤åˆ¶æ¯ä¸ªç»“ç‚¹ï¼Œå¹¶æŠŠæ–°ç»“ç‚¹æ”¾åœ¨è€ç»“ç‚¹åé¢ï¼Œå¦‚1->2,å¤åˆ¶ä¸º1->1->2->2
äºŒä¸ºæ¯ä¸ªæ–°ç»“ç‚¹è®¾ç½®otheræŒ‡é’ˆ
ä¸‰æŠŠå¤åˆ¶åçš„ç»“ç‚¹é“¾è¡¨æ‹†å¼€
"""
import random


class Node(object):

    def __init__(self, val):
        self.val = val
        self.next = None
        self.other = None


class Solution(object):

    @staticmethod
    def clone_nodes(head):
        # ç»“ç‚¹å¤åˆ¶
        move = head
        while move:
            tmp = Node(move.val)
            tmp.next = move.next
            move.next = tmp
            move = tmp.next
        return head

    @staticmethod
    def set_nodes(head):
        # otheræŒ‡é’ˆè®¾ç½®
        move = head
        while move:
            m_next = move.next
            if move.other:
                m_next.other = move.other.next
            move = m_next.next
        return head

    @staticmethod
    def reconstruct_nodes(head):
        # ç»“ç‚¹æ‹†åˆ†
        ret = head.next if head else Node
        move = ret
        while head:
            head = move.next
            if head:
                move.next = head.next
                move = move.next
        return ret

    @staticmethod
    def clone_link(head):
        # ç»“æœ
        h = Solution.clone_nodes(head)
        h = Solution.set_nodes(h)
        ret = Solution.reconstruct_nodes(h)
        return ret

    @staticmethod
    def print_nodes(head):
        # æ‰“å°ç»“ç‚¹å€¼ï¼Œç»“ç‚¹otherçš„å€¼ï¼Œç”¨æ¥æ¯”è¾ƒ
        ret = []
        while head:
            tmp = [head.val]
            if head.other:
                tmp.append(head.other.val)
            ret.append(tmp)
            head = head.next
        print ret

    @staticmethod
    def construct_nodes(vals):
        """
        æ„é€ ä¸€ä¸ªç®€å•çš„å¤æ‚é“¾è¡¨
        :param vals: list
        :return: Nodes
        """
        if not vals:
            return Node
        move = head = Node(vals.pop(0))
        nodes = [None, head]
        for v in vals:
            tmp = Node(v)
            move.next = tmp
            nodes.append(tmp)
            move = move.next
        # print [node.val for node in nodes if node]
        move = head
        while move:
            # è®¾ç½®otheræŒ‡é’ˆä¸ºéšæœºç»“ç‚¹
            move.other = random.choice(nodes)
            move = move.next
        return head


if __name__ == '__main__':
    link = Solution.construct_nodes([1, 2, 3, 4, 5])
    Solution.print_nodes(link)
    test = Solution.clone_link(link)  # å¤åˆ¶
    Solution.print_nodes(test)
```

### 9ã€äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨

> è¦æ±‚: å°†äºŒå‰æœç´¢æ ‘è½¬åŒ–æˆä¸€ä¸ªæ’åºçš„åŒå‘é“¾è¡¨ï¼Œåªè°ƒæ•´æ ‘ä¸­ç»“ç‚¹çš„æŒ‡å‘
> 
> æ€è·¯: ä¸­åºéå†ï¼Œæ ¹ç»“ç‚¹çš„leftæŒ‡å‘å·¦å­æ ‘çš„æœ€åä¸€ä¸ª(æœ€å¤§)å€¼ï¼ŒrightæŒ‡å‘å³å­æ ‘çš„(æœ€å°)å€¼
>
> æ³¨æ„: é¢˜ç›®æ„é€ äº†ä¸€ä¸ªæ™®é€šäºŒå‰æ ‘ç”¨æ¥æµ‹è¯•ï¼Œæ„é€ æ—¶æŒ‰ç…§äºŒå‰æœç´¢æ ‘çš„é¡ºåºè¾“å…¥ç»“ç‚¹ï¼Œç©ºç»“ç‚¹ç”¨Noneè¡¨ç¤ºï¼Œè¯¦æƒ…è§twenty_seven.py


```python
# coding=utf-8
"""
å°†äºŒå‰æœç´¢æ ‘è½¬åŒ–æˆä¸€ä¸ªæ’åºçš„åŒå‘é“¾è¡¨ï¼Œåªè°ƒæ•´æ ‘ä¸­ç»“ç‚¹çš„æŒ‡å‘ï¼Œä¸ç”¨æ–°ç»“ç‚¹
ä¸­åºéå†ï¼Œæ ¹ç»“ç‚¹çš„leftæŒ‡å‘å·¦å­æ ‘çš„æœ€åä¸€ä¸ª(æœ€å¤§)å€¼ï¼ŒrightæŒ‡å‘å³å­æ ‘çš„(æœ€å°)å€¼
"""

from collections import deque


class TreeNode(object):
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    """
    éäºŒå‰æœç´¢æ ‘ï¼Œå»ºæ ‘çš„æ—¶å€™valuesä¸­çš„é¡ºåºéœ€è¦æ³¨æ„
    ä¹‹åæœ‰æ—¶é—´ä¼šæ”¹æˆäºŒå‰æœç´¢æ ‘
    """
    def __init__(self):
        self.root = None

    def construct_tree(self, values=None):
        # ç»“ç‚¹å€¼ä¸å­˜åœ¨çš„è¯ï¼Œvaluesä¸­ç”¨Noneè¡¨ç¤º
        if not values:
            return None
        self.root = TreeNode(values[0])
        queue = deque([self.root])
        leng = len(values)
        nums = 1
        while nums < leng:
            node = queue.popleft()
            if node:
                node.left = TreeNode(values[nums]) if values[nums] else None
                queue.append(node.left)
                if nums + 1 < leng:
                    node.right = TreeNode(values[nums + 1]) if values[nums + 1] else None
                    queue.append(node.right)
                    nums += 1
                nums += 1

    def bfs(self):
        ret = []
        queue = deque([self.root])
        while queue:
            node = queue.popleft()
            if node:
                ret.append(node.val)
                queue.append(node.left)
                queue.append(node.right)
        return ret


class Solution(object):

    @staticmethod
    def convert(tree):
        """ç»“ç‚¹è½¬æ¢"""
        if not tree:
            return None
        p_last = Solution.convert_nodes(tree, None)
        while p_last and p_last.left:  # è·å–é“¾è¡¨å¤´ç»“ç‚¹
            p_last = p_last.left
        return p_last

    @staticmethod
    def convert_nodes(tree, last):
        if not tree:
            return None
        if tree.left:
            last = Solution.convert_nodes(tree.left, last)
        if last:
            last.right = tree
        tree.left = last
        last = tree
        if tree.right:
            last = Solution.convert_nodes(tree.right, last)
        return last

    @staticmethod
    def print_nodes(tree):
        # æ­£åºé“¾è¡¨æ‰“å°
        ret = []
        while tree:
            tmp = []
            tmp.append(tree.left.val if tree.left else None)
            tmp.append(tree.val)
            tmp.append(tree.right.val if tree.right else None)
            ret.append(tmp)
            tree = tree.right
        print ret

if __name__ == '__main__':
    r = Tree()
    # r.construct_tree([2, 1])
    # r.construct_tree([2, None, 3])
    # r.construct_tree([2, 1, 3])
    # r.construct_tree([])
    r.construct_tree([5, 3, 6, 2, 4, None, 7, 1])
    t = Solution.convert(r.root)
    Solution.print_nodes(t)
```

### 10ã€å­—ç¬¦ä¸²çš„æ’åˆ—

> è¦æ±‚ï¼šæ±‚è¾“å…¥å­—ç¬¦ä¸²çš„å…¨æ’åˆ—
>
> æ€è·¯ï¼šé€’å½’å®Œæˆï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨åº“å‡½æ•°


```python
# coding=utf-8
"""
æ±‚è¾“å…¥å­—ç¬¦ä¸²çš„å…¨æ’åˆ—
é€’å½’å®Œæˆï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨åº“å‡½æ•°
"""

from itertools import permutations


def my_permutation(s):
    str_set = []
    ret = []  # æœ€åçš„ç»“æœ

    def permutation(string):
        for i in string:
            str_tem = string.replace(i, '')
            str_set.append(i)
            if len(str_tem) > 0:
                permutation(str_tem)
            else:
                ret.append(''.join(str_set))
            str_set.pop()

    permutation(s)
    return ret


if __name__ == '__main__':
    s = 'abc'
    print my_permutation(s)
    print [''.join(p) for p in permutations(s)]
```
<!-- TOC -->

- [æ—¶é—´æ•ˆç‡](#æ—¶é—´æ•ˆç‡)
    - [1ã€æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—](#1æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—)
    - [2ã€æœ€å°çš„kä¸ªæ•°](#2æœ€å°çš„kä¸ªæ•°)
    - [3ã€è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ](#3è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ)
    - [4ã€ä»1åˆ°næ•´æ•°ä¸­1å‡ºç°çš„æ¬¡æ•°](#4ä»1åˆ°næ•´æ•°ä¸­1å‡ºç°çš„æ¬¡æ•°)
    - [5ã€æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°](#5æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°)

- [æ—¶é—´æ•ˆç‡ä¸ç©ºé—´æ•ˆç‡çš„å¹³è¡¡](#æ—¶é—´æ•ˆç‡ä¸ç©ºé—´æ•ˆç‡çš„å¹³è¡¡)
    - [6ã€ä¸‘æ•°](#6ä¸‘æ•°)
    - [7ã€ç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦](#7ç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦)
    - [8ã€æ•°ç»„ä¸­çš„é€†åºå¯¹](#8æ•°ç»„ä¸­çš„é€†åºå¯¹)
    - [9ã€ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±ç»“ç‚¹](#5ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±ç»“ç‚¹)



<!-- /TOC -->
## æ—¶é—´æ•ˆç‡
### 1ã€æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—

> æ€è·¯: ä½¿ç”¨hashï¼Œkeyæ˜¯æ•°å­—ï¼Œvalueæ˜¯å‡ºç°çš„æ¬¡æ•°
>
> æ³¨æ„: åˆ—è¡¨çš„lenæ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)
>

```python
# coding=utf-8
"""
æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—
æ€è·¯: ä½¿ç”¨hashï¼Œkeyæ˜¯æ•°å­—ï¼Œvalueæ˜¯å‡ºç°çš„æ¬¡æ•°
æ³¨æ„: åˆ—è¡¨çš„lenæ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)
"""


def get_more_half_num(nums):
    hashes = dict()
    length = len(nums)
    for n in nums:
        hashes[n] = hashes[n] + 1 if hashes.get(n) else 1
        if hashes[n] > length / 2:
            return n

if __name__ == '__main__':
    test = [1, 2, 1, 2, 3, 1, 1]
    print get_more_half_num(test)
```

### 2ã€æœ€å°çš„kä¸ªæ•°
> è¦æ±‚ï¼šæ±‚æ•°ç»„ä¸­å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°å­—
>
> æ€è·¯: ä½¿ç”¨heapqï¼Œè¯¥æ¨¡å—æ˜¯ä¸€ä¸ªæœ€å°å †ï¼Œéœ€è¦è½¬åŒ–æˆæœ€å¤§å †ï¼Œåªè¦åœ¨å…¥å †çš„æ—¶å€™æŠŠå€¼å–åå°±å¯ä»¥è½¬åŒ–æˆæœ€å¤§å †(ä»…é€‚ç”¨äºæ•°å­—)
>
> æ€è·¯äºŒ: æ•°ç»„æ¯”è¾ƒå°çš„æ—¶å€™å¯ä»¥ç›´æ¥ä½¿ç”¨heapqçš„nsmallestæ–¹æ³•

```python
# coding=utf-8
"""
æ±‚æ•°ç»„ä¸­æœ€å°çš„kä¸ªæ•°
æ€è·¯ï¼šä½¿ç”¨heapqï¼Œè¯¥æ¨¡å—æ˜¯ä¸€ä¸ªæœ€å°å †ï¼Œéœ€è¦è½¬åŒ–æˆæœ€å¤§å †ï¼Œ
åªè¦åœ¨å…¥å †çš„æ—¶å€™æŠŠå€¼å–åå°±å¯ä»¥è½¬åŒ–æˆæœ€å¤§å †ï¼Œä»…é€‚ç”¨äºæ•°å­—
"""
import random
import heapq


def get_least_k_nums(nums, k):
    # æ•°ç»„æ¯”è¾ƒå°çš„æ—¶å€™å¯ä»¥ç›´æ¥ä½¿ç”¨
    return heapq.nsmallest(k, nums)


class MaxHeap(object):
    def __init__(self, k):
        self.k = k
        self.data = []

    def push(self, elem):
        elem = -elem  # å…¥å †çš„æ—¶å€™å–åï¼Œå †é¡¶å°±æ˜¯æœ€å¤§å€¼çš„ç›¸åæ•°äº†
        if len(self.data) < self.k:
            heapq.heappush(self.data, elem)
        else:
            least = self.data[0]
            if elem > least:
                heapq.heapreplace(self.data, elem)

    def get_least_k_nums(self):
        return sorted([-x for x in self.data])

if __name__ == '__main__':
    test = random.sample(xrange(100000), 100)
    print get_least_k_nums(test, 4)
    h = MaxHeap(4)
    for t in test:
        h.push(t)
    print h.get_least_k_nums()
```

### 3ã€è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ
> æ€è·¯: åŠ¨æ€è§„åˆ’é—®é¢˜

```python
# coding=utf-8
"""
è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ
åŠ¨æ€è§„åˆ’é—®é¢˜
"""


def max_sum(nums):
    ret = float("-inf")  # è´Ÿæ— ç©·
    if not nums:
        return ret
    current = 0
    for i in nums:
        if current <= 0:
            current = i
        else:
            current += i
        ret = max(ret, current)
    return ret

if __name__ == '__main__':
    test = [1, 2, -2, 3, 6, 0, -2]
    print max_sum(test)
```
### 4ã€ä»1åˆ°næ•´æ•°ä¸­1å‡ºç°çš„æ¬¡æ•°
> è¦æ±‚ï¼šæ±‚ä»1åˆ°næ•´æ•°çš„åè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œ1å‡ºç°çš„æ¬¡æ•°
>
> æ€è·¯: è·å–æ¯ä¸ªä½æ•°åŒºé—´ä¸Šæ‰€æœ‰æ•°ä¸­åŒ…å«1çš„ä¸ªæ•°ï¼Œç„¶ååˆ†åˆ«å¯¹é«˜ä½åˆ†æï¼Œç„¶åé€’å½’çš„å¤„ç†ä½ä½æ•°
>
> æ­¤é¢˜ä¸­ï¼Œä½œè€…çš„æè¿°æˆ‘æ²¡æœ‰ç†è§£ï¼ŒæŒ‰ç…§è‡ªå·±çš„ç†è§£å†™äº†ä¸€ä¸‹ï¼Œå…·ä½“å†…å®¹è¯·ç‚¹å‡»[è¿™é‡Œ](http://www.cnblogs.com/qiaojushuang/p/7780445.html)

```python
# coding=utf-8
"""
æ±‚ä»1åˆ°næ•´æ•°çš„åè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œ1å‡ºç°çš„æ¬¡æ•°
æ€è·¯ï¼šè·å–æ¯ä¸ªä½æ•°åŒºé—´ä¸Šæ‰€æœ‰æ•°ä¸­åŒ…å«1çš„ä¸ªæ•°ï¼Œç„¶ååˆ†åˆ«å¯¹é«˜ä½åˆ†æï¼Œç„¶åé€’å½’çš„å¤„ç†ä½ä½æ•°
"""


def get_digits(n):
    # æ±‚æ•´æ•°nçš„ä½æ•°
    ret = 0
    while n:
        ret += 1
        n /= 10
    return ret


def get_1_digits(n):
    """
    è·å–æ¯ä¸ªä½æ•°ä¹‹é—´1çš„æ€»æ•°
    :param n: ä½æ•°
    """
    if n <= 0:
        return 0
    if n == 1:
        return 1
    current = 9 * get_1_digits(n-1) + 10 ** (n-1)
    return get_1_digits(n-1) + current


def get_1_nums(n):
    if n < 10:
        return 1 if n >= 1 else 0
    digit = get_digits(n)  # ä½æ•°
    low_nums = get_1_digits(digit-1)  # æœ€é«˜ä½ä¹‹å‰çš„1çš„ä¸ªæ•°
    high = int(str(n)[0])  # æœ€é«˜ä½
    low = n - high * 10 ** (digit-1)  # ä½ä½

    if high == 1:
        high_nums = low + 1  # æœ€é«˜ä½ä¸Š1çš„ä¸ªæ•°
        all_nums = high_nums
    else:
        high_nums = 10 ** (digit - 1)
        all_nums = high_nums + low_nums * (high - 1)  # æœ€é«˜ä½å¤§äº1çš„è¯ï¼Œç»Ÿè®¡æ¯ä¸ªå¤šä½æ•°åé¢åŒ…å«çš„1
    return low_nums + all_nums + get_1_nums(low)


def test_n(num):
    # å¸¸è§„æ–¹æ³•ç”¨æ¥æ¯”è¾ƒ
    ret = 0
    for n in range(1, num+1):
        for s in str(n):
            if s == '1':
                ret += 1
    return ret

if __name__ == '__main__':
    test = 9923446
    import time
    t = time.clock()
    print test_n(test)
    print time.clock() - t
    t1 = time.clock()
    print get_1_nums(test)
    print time.clock() - t1
```


### 5ã€æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°
> è¦æ±‚ï¼šæŠŠæ•°ç»„ä¸­çš„å€¼æ‹¼æ¥ï¼Œæ‰¾å‡ºèƒ½äº§ç”Ÿçš„æœ€å°çš„æ•°[321,32,3]æœ€å°çš„æ•°æ˜¯321323
>
> æ€è·¯: Pythonä¸­ä¸éœ€è¦è€ƒè™‘å¤§æ•´æ•°ï¼Œéœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªæ•°ç»„æ’åºè§„åˆ™ï¼Œç›´æ¥è°ƒç”¨åº“å‡½æ•°å°±å¯ä»¥

```python
# coding=utf-8
"""
æŠŠæ•°ç»„ä¸­çš„å€¼æ‹¼æ¥ï¼Œæ‰¾å‡ºèƒ½äº§ç”Ÿçš„æœ€å°çš„æ•°[321,32,3]æœ€å°çš„æ•°æ˜¯321323
Pythonä¸­ä¸éœ€è¦è€ƒè™‘å¤§æ•´æ•°ï¼Œéœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªæ•°ç»„æ’åºè§„åˆ™ï¼Œç›´æ¥è°ƒç”¨åº“å‡½æ•°å°±å¯ä»¥
"""


def cmp(a, b):
    return int(str(a)+str(b)) - int(str(b)+str(a))


def print_mini(nums):
    if not nums:
        return
    print int(''.join([str(num) for num in sorted(nums, cmp=cmp)]))


if __name__ == '__main__':
    test = []
    print_mini(test)
```

## æ—¶é—´æ•ˆç‡ä¸ç©ºé—´æ•ˆç‡çš„å¹³è¡¡

### 6ã€ä¸‘æ•° [LeetCode](https://leetcode.com/problems/ugly-number-ii/)
> è¦æ±‚ï¼šåªå«æœ‰2ã€3ã€5å› å­çš„æ•°æ˜¯ä¸‘æ•°ï¼Œæ±‚ç¬¬1500ä¸ªä¸‘æ•°
>
> æ€è·¯: æŒ‰é¡ºåºä¿å­˜å·²çŸ¥çš„ä¸‘æ•°ï¼Œä¸‹ä¸€ä¸ªæ˜¯å·²çŸ¥ä¸‘æ•°ä¸­æŸä¸‰ä¸ªæ•°ä¹˜ä»¥2ï¼Œ3ï¼Œ5ä¸­çš„æœ€å°å€¼

```python
# coding=utf-8
"""
åªå«æœ‰2ã€3ã€5å› å­çš„æ•°æ˜¯ä¸‘æ•°ï¼Œæ±‚ç¬¬1500ä¸ªä¸‘æ•°
æŒ‰é¡ºåºä¿å­˜å·²çŸ¥çš„ä¸‘æ•°ï¼Œä¸‹ä¸€ä¸ªæ˜¯å·²çŸ¥ä¸‘æ•°ä¸­æŸä¸‰ä¸ªæ•°ä¹˜ä»¥2ï¼Œ3ï¼Œ5ä¸­çš„æœ€å°å€¼
"""


class Solution(object):
    def nthUglyNumber(self, n):
        """
        :type n: int
        :rtype: int
        """
        ugly = [1]
        t2 = t3 = t5 = 0
        while len(ugly) < n:
            while ugly[t2] * 2 <= ugly[-1]:
                t2 += 1
            while ugly[t3] * 3 <= ugly[-1]:
                t3 += 1
            while ugly[t5] * 5 <= ugly[-1]:
                t5 += 1
            ugly.append(min(ugly[t2]*2, ugly[t3]*3, ugly[t5]*5))
        return ugly[-1]


if __name__ == '__main__':
    print Solution().nthUglyNumber(1500)
```

### 7ã€ç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦
> è¦æ±‚ï¼šæ±‚å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦
>
> æ€è·¯: ä½¿ç”¨ä¸¤ä¸ªhashï¼Œä¸€ä¸ªè®°å½•æ¯ä¸ªå­—ç¬¦ç©¿çº¿çš„æ¬¡æ•°ï¼Œå¦ä¸€ä¸ªè®°å½•æ¯ä¸ªå­—ç¬¦ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®

```python
# coding=utf-8
"""
æ±‚å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€ä¸ªåªå‡ºç°ä¸€æ¬¡çš„å­—ç¬¦
ä½¿ç”¨ä¸¤ä¸ªhashï¼Œä¸€ä¸ªè®°å½•æ¯ä¸ªå­—ç¬¦ç©¿çº¿çš„æ¬¡æ•°ï¼Œå¦ä¸€ä¸ªè®°å½•æ¯ä¸ªå­—ç¬¦ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®
"""


def first_not_repeating_char(string):
    if not string:
        return -1
    count = {}
    loc = {}
    for k, s in enumerate(string):
        count[s] = count[s] + 1 if count.get(s) else 1
        loc[s] = loc[s] if loc.get(s) else k
    ret = float('inf')
    for k in loc.keys():
        if count.get(k) == 1 and loc[k] < ret:
            ret = loc[k]
    return ret

if __name__ == '__main__':
    test = 'abaccbdse'
    print first_not_repeating_char(test)
```

### 8ã€æ•°ç»„ä¸­çš„é€†åºå¯¹
> è¦æ±‚ï¼šåœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå‰é¢çš„æ•°å­—æ¯”åé¢çš„å¤§ï¼Œå°±æ˜¯ä¸€ä¸ªé€†åºå¯¹ï¼Œæ±‚æ€»æ•°
>
> æ€è·¯: å½’å¹¶æ’åº,å…ˆæŠŠæ•°ç»„ä¾æ¬¡æ‹†å¼€ï¼Œç„¶ååˆå¹¶çš„æ—¶å€™ç»Ÿè®¡é€†åºå¯¹æ•°ç›®ï¼Œå¹¶æ’åº

```python
# coding=utf-8
"""
åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå‰é¢çš„æ•°å­—æ¯”åé¢çš„å¤§ï¼Œå°±æ˜¯ä¸€ä¸ªé€†åºå¯¹ï¼Œæ±‚æ€»æ•°
å½’å¹¶æ’åº,å…ˆæŠŠæ•°ç»„ä¾æ¬¡æ‹†å¼€ï¼Œç„¶ååˆå¹¶çš„æ—¶å€™ç»Ÿè®¡é€†åºå¯¹æ•°ç›®ï¼Œå¹¶æ’åº
"""
import copy


def get_inverse_pairs(nums):
    if not nums:
        return 0
    start, end = 0, len(nums) - 1
    tmp = copy.deepcopy(nums)
    return inverse_pairs(tmp, start, end)


def inverse_pairs(tmp, start, end):
    if start == end:  # é€’å½’ç»“æŸæ¡ä»¶
        return 0
    mid = (end - start) / 2  # åˆ†åˆ«å¯¹å·¦å³ä¸¤è¾¹é€’å½’æ±‚å€¼
    left = inverse_pairs(tmp, start, start+mid)
    right = inverse_pairs(tmp, start+mid+1, end)

    count = 0  # æœ¬æ¬¡é€†åºå¯¹æ•°ç›®
    l_right, r_right = start + mid, end
    t = []
    while l_right >= start and r_right >= start + mid + 1:
        if tmp[l_right] > tmp[r_right]:
            t.append(tmp[l_right])
            count += (r_right - mid - start)
            l_right -= 1
        else:
            t.append(tmp[r_right])
            r_right -= 1
    while l_right >= start:
        t.append(tmp[l_right])
        l_right -= 1
    while r_right >= start+mid+1:
        t.append(tmp[r_right])
        r_right -= 1
    tmp[start:end+1] = t[::-1]
    return count + left + right

if __name__ == '__main__':
    test = [7, 5, 6, 4, 8, 1, 2, 9]
    print get_inverse_pairs(test)
```

### 9ã€ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±ç»“ç‚¹
> æ€è·¯: å…ˆè·å–åˆ°ä¸¤ä¸ªé“¾è¡¨çš„é•¿åº¦ï¼Œç„¶åé•¿çš„é“¾è¡¨å…ˆèµ°å¤šçš„å‡ æ­¥ï¼Œä¹‹åä¸€èµ·éå†
>
> æ–‡ä»¶thirty_seven.pyä¸­åŒ…å«äº†è®¾ç½®é“¾è¡¨å…¬å…±ç»“ç‚¹çš„ä»£ç ï¼Œå¯ä»¥ç”¨æ¥æµ‹è¯•

```python
# coding=utf-8
"""
æ±‚ä¸¤ä¸ªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…¬å…±ç»“ç‚¹
å…ˆè·å–åˆ°ä¸¤ä¸ªé“¾è¡¨çš„é•¿åº¦ï¼Œç„¶åé•¿çš„é“¾è¡¨å…ˆèµ°å¤šçš„å‡ æ­¥ï¼Œä¹‹åä¸€èµ·éå†
"""


def get_first_common_node(link1, link2):
    if not link1 or not link2:
        return None
    length1 = length2 = 0
    move1, move2 = link1, link2
    while move1:  # è·å–é“¾è¡¨é•¿åº¦
        length1 += 1
        move1 = move1.next
    while move2:
        length2 += 1
        move2 = move2.next
    while length1 > length2:  # é•¿é“¾è¡¨å…ˆèµ°å¤šçš„é•¿åº¦
        length1 -= 1
        link1 = link1.next
    while length2 > length1:
        length2 -= 1
        link2 = link2.next
    while link1:  # é“¾è¡¨ä¸€èµ·èµ°
        if link1 == link2:
            return link1
        link1, link2 = link1.next, link2.next
    return None


class ListNode(object):
    def __init__(self, x):
        self.val = x
        self.next = None


class Nodes(object):
    def __init__(self, values=None):
        self.nodes = self._set_link(values) if values else None

    def get_link(self):
        return self.nodes

    def get_tail(self):
        # è·å–å°¾æŒ‡é’ˆ
        tail = self.nodes
        while tail.next:
            tail = tail.next
        return tail

    def print_self(self):
        Nodes.print_link(self.nodes)

    @staticmethod
    def print_link(link=None):
        count = 1
        while link:
            if count == 1:
                print link.val,
            elif count % 5 == 0:
                print '->', link.val
            else:
                print '->', link.val,
            count += 1
            link = link.next
        print

    def _set_link(self, values):
        head = ListNode(0)
        move = head
        try:
            for val in values:
                tmp = ListNode(val)
                move.next = tmp
                move = move.next
        except Exception as e:
            print e
        return head.next

if __name__ == '__main__':
    t1 = [1, 2, 3, 4]
    t2 = [5, 6, 7, 8, 12]
    t3 = [9, 10, 11]
    node1, node2, common = Nodes(t1), Nodes(t2), Nodes(t3)
    h1 = node1.get_link()
    h2 = node2.get_link()
    h3 = common.get_link()
    tail1 = node1.get_tail()
    tail2 = node2.get_tail()
    tail2.next = h3  # è®¾ç½®å…¬å…±é“¾è¡¨
    tail1.next = h3
    print get_first_common_node(h1, h2)
    print h3
```
<!-- TOC -->

- [çŸ¥è¯†è¿ç§»èƒ½åŠ›](#çŸ¥è¯†è¿ç§»èƒ½åŠ›)
    - [1ã€æ•°å­—åœ¨æ’åºæ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°](#1æ•°å­—åœ¨æ’åºæ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°)
    - [2ã€äºŒå‰æ ‘çš„æ·±åº¦](#2äºŒå‰æ ‘çš„æ·±åº¦)
    - [3ã€æ•°ç»„ä¸­åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—](#3æ•°ç»„ä¸­åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—)
    - [4ã€å’Œä¸ºsçš„ä¸¤ä¸ªæ•°å­—VSå’Œä¸ºsçš„è¿ç»­æ­£æ•°åºåˆ—](#4å’Œä¸ºsçš„ä¸¤ä¸ªæ•°å­—VSå’Œä¸ºsçš„è¿ç»­æ­£æ•°åºåˆ—)
    - [5ã€ç¿»è½¬å•è¯é¡ºåºä¸å·¦æ—‹è½¬å­—ç¬¦ä¸²](#5ç¿»è½¬å•è¯é¡ºåºä¸å·¦æ—‹è½¬å­—ç¬¦ä¸²)

- [æŠ½è±¡å»ºæ¨¡èƒ½åŠ›](#æŠ½è±¡å»ºæ¨¡èƒ½åŠ›)
    - [6ã€nä¸ªéª°å­çš„ç‚¹æ•°](#6nä¸ªéª°å­çš„ç‚¹æ•°)
    - [7ã€æ‰‘å…‹ç‰Œçš„é¡ºå­](#7æ‰‘å…‹ç‰Œçš„é¡ºå­)
    - [8ã€åœ†åœˆä¸­æœ€åå‰©ä¸‹çš„æ•°å­—](#8åœ†åœˆä¸­æœ€åå‰©ä¸‹çš„æ•°å­—)

- [å‘æ•£æ€ç»´èƒ½åŠ›](#å‘æ•£æ€ç»´èƒ½åŠ›)
    - [9ã€æ±‚1+2...+n](#9æ±‚1+2...+n)
    - [10ã€ä¸ç”¨åŠ å‡ä¹˜é™¤åšåŠ æ³•](#10ä¸ç”¨åŠ å‡ä¹˜é™¤åšåŠ æ³•)
    - [11ã€ä¸èƒ½è¢«ç»§æ‰¿çš„ç±»](#8ä¸èƒ½è¢«ç»§æ‰¿çš„ç±»)

- [æ¡ˆä¾‹](#æ¡ˆä¾‹)
    - [12ã€æŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆæ•´æ•°](#12æŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆæ•´æ•°)
    - [13ã€æ ‘ä¸­ä¸¤ä¸ªç»“ç‚¹çš„æœ€ä½å…¬å…±ç¥–å…ˆ]](#13æ ‘ä¸­ä¸¤ä¸ªç»“ç‚¹çš„æœ€ä½å…¬å…±ç¥–å…ˆ])


<!-- /TOC -->
## çŸ¥è¯†è¿ç§»èƒ½åŠ›
### 1ã€æ•°å­—åœ¨æ’åºæ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°

> æ€è·¯: ä½¿ç”¨äºŒåˆ†æ³•åˆ†åˆ«æ‰¾åˆ°æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå‡ºç°çš„å€¼çš„åæ ‡ï¼Œç„¶åç›¸å‡

```python
# coding=utf-8
"""
ç»Ÿè®¡ä¸€ä¸ªæ•°å­—åœ¨æ’åºæ•°ç»„ä¸­å‡ºç°çš„æ¬¡æ•°
ä½¿ç”¨äºŒåˆ†æ³•åˆ†åˆ«æ‰¾åˆ°æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå‡ºç°çš„å€¼çš„åæ ‡ï¼Œç„¶åç›¸å‡
"""


def get_k_counts(nums, k):
    first = get_first_k(nums, k)
    last = get_last_k(nums, k)
    if first < 0 and last < 0:
        return 0
    if first < 0 or last < 0:
        return 1
    return last - first + 1


def get_first_k(nums, k):
    left, right = 0, len(nums) - 1
    while left <= right:
        mid = (left + right) / 2
        if nums[mid] < k:
            if mid + 1 < len(nums) and nums[mid+1] == k:
                return mid + 1
            left = mid + 1
        elif nums[mid] == k:
            if mid - 1 < 0 or (mid - 1 >= 0 and nums[mid-1] < k):
                return mid
            right = mid - 1
        else:
            right = mid - 1
    return -1


def get_last_k(nums, k):
    left, right = 0, len(nums) - 1
    while left <= right:
        mid = (left + right) / 2
        if nums[mid] < k:
            left = mid + 1
        elif nums[mid] == k:
            if mid + 1 == len(nums) or (mid + 1 < len(nums) and nums[mid+1] > k):
                return mid
            left = mid + 1
        else:
            if mid - 1 >= 0 and nums[mid-1] == k:
                return mid - 1
            right = mid - 1
    return -1

if __name__ == '__main__':
    test = [1, 2, 2, 3, 3, 3, 4]
    print get_k_counts(test, 5)
```

### 2ã€äºŒå‰æ ‘çš„æ·±åº¦

> æ€è·¯: åˆ†åˆ«é€’å½’çš„æ±‚å·¦å³å­æ ‘çš„æ·±åº¦

```python
# coding=utf-8
"""
æ±‚äºŒå‰æ ‘çš„æ·±åº¦
åˆ†åˆ«é€’å½’çš„æ±‚å·¦å³å­æ ‘çš„æ·±åº¦
"""
from collections import deque


def get_depth(tree):
    if not tree:
        return 0
    if not tree.left and not tree.right:
        return 1
    return 1 + max(get_depth(tree.left), get_depth(tree.right))


class TreeNode(object):
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    def __init__(self):
        self.root = None

    def construct_tree(self, values=None):
        if not values:
            return None
        self.root = TreeNode(values[0])
        queue = deque([self.root])
        leng = len(values)
        nums = 1
        while nums < leng:
            node = queue.popleft()
            if node:
                node.left = TreeNode(values[nums]) if values[nums] else None
                queue.append(node.left)
                if nums + 1 < leng:
                    node.right = TreeNode(values[nums + 1]) if values[nums + 1] else None
                    queue.append(node.right)
                    nums += 1
                nums += 1

    def bfs(self):
        ret = []
        queue = deque([self.root])
        while queue:
            node = queue.popleft()
            if node:
                ret.append(node.val)
                queue.append(node.left)
                queue.append(node.right)
        return ret


def bfs(tree):
    if not tree:
        return None
    stack = [tree]
    ret = []
    while stack:
        node = stack.pop(0)
        ret.append(node.val)
        if node.left:
            stack.append(node.left)
        if node.right:
            stack.append(node.right)
    return ret

if __name__ == '__main__':
    t = Tree()
    t.construct_tree([1, 2, 3])
    print t.bfs()
    print get_depth(t.root)
```

### 3ã€æ•°ç»„ä¸­åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—
> è¦æ±‚ï¼šæ•°ç»„ä¸­é™¤äº†ä¸¤ä¸ªåªå‡ºç°ä¸€æ¬¡çš„æ•°å­—å¤–ï¼Œå…¶ä»–æ•°å­—éƒ½å‡ºç°äº†ä¸¤é
>
> æ€è·¯: æŒ‰ä½å¼‚æˆ–ï¼Œåœ¨å¾—åˆ°çš„å€¼ä¸­æ‰¾åˆ°äºŒè¿›åˆ¶æœ€åä¸€ä¸ª1ï¼Œç„¶åæŠŠæ•°ç»„æŒ‰ç…§è¯¥ä½æ˜¯0è¿˜æ˜¯1åˆ†ä¸ºä¸¤ç»„

```python
# coding=utf-8
"""
æ•°ç»„ä¸­é™¤äº†ä¸¤ä¸ªåªå‡ºç°ä¸€æ¬¡çš„æ•°å­—å¤–ï¼Œå…¶ä»–æ•°å­—éƒ½å‡ºç°äº†ä¸¤é
æŒ‰ä½å¼‚æˆ–ï¼Œåœ¨å¾—åˆ°çš„å€¼ä¸­æ‰¾åˆ°äºŒè¿›åˆ¶æœ€åä¸€ä¸ª1ï¼Œç„¶åæŠŠæ•°ç»„æŒ‰ç…§è¯¥ä½æ˜¯0è¿˜æ˜¯1åˆ†ä¸ºä¸¤ç»„
"""


def get_only_one_number(nums):
    if not nums:
        return None
    tmp_ret = 0
    for n in nums:  # è·å–ä¸¤ä¸ªå€¼çš„å¼‚æˆ–ç»“æœ
        tmp_ret ^= n
    last_one = get_bin(tmp_ret)
    a_ret, b_ret = 0, 0
    for n in nums:
        if is_one(n, last_one):
            a_ret ^= n
        else:
            b_ret ^= n
    return [a_ret, b_ret]


def get_bin(num):  # å¾—åˆ°ç¬¬ä¸€ä¸ª1
    ret = 0
    while num & 1 == 0 and ret < 32:
        num = num >> 1
        ret += 1
    return ret


def is_one(num, t):  # éªŒè¯tä½æ˜¯ä¸æ˜¯1
    num = num >> t
    return num & 0x01


if __name__ == '__main__':
    test = [1, 2, 3, 4, 3, 1, -1, -1]
    print get_only_one_number(test)
```

### 4ã€å’Œä¸ºsçš„ä¸¤ä¸ªæ•°å­—VSå’Œä¸ºsçš„è¿ç»­æ­£æ•°åºåˆ—
#### å’Œä¸ºsçš„ä¸¤ä¸ªæ•°å­—
> è¦æ±‚ï¼šè¾“å…¥ä¸€ä¸ªé€’å¢æ’åºçš„æ•°ç»„å’Œä¸€ä¸ªæ•°å­—sï¼Œåœ¨æ•°ç»„ä¸­æŸ¥æ‰¾ä¸¤ä¸ªæ•°ï¼Œä½¿å…¶å’Œä¸ºs
>
> æ€è·¯: è®¾ç½®å¤´å°¾ä¸¤ä¸ªæŒ‡é’ˆï¼Œå’Œå¤§äºsï¼Œå°¾æŒ‡é’ˆå‡å°ï¼Œå¦ç ¸å¤´æŒ‡é’ˆå¢åŠ 

```python
# coding=utf-8
"""
è¾“å…¥ä¸€ä¸ªé€’å¢æ’åºçš„æ•°ç»„å’Œä¸€ä¸ªæ•°å­—sï¼Œåœ¨æ•°ç»„ä¸­æŸ¥æ‰¾ä¸¤ä¸ªæ•°ï¼Œä½¿å…¶å’Œä¸ºs
è®¾ç½®å¤´å°¾ä¸¤ä¸ªæŒ‡é’ˆï¼Œå’Œå¤§äºsï¼Œå°¾æŒ‡é’ˆå‡å°ï¼Œå¦ç ¸å¤´æŒ‡é’ˆå¢åŠ 
"""


def sum_to_s(nums, s):
    head, end = 0, len(nums) - 1
    while head < end:
        if nums[head] + nums[end] == s:
            return [nums[head], nums[end]]
        elif nums[head] + nums[end] > s:
            end -= 1
        else:
            head += 1
    return None

if __name__ == '__main__':
    test = [-4, 0, 1, 2, 4, 6, 8, 10, 12, 15, 18]
    s = 12
    print sum_to_s(test, s)
```

#### å’Œä¸ºsçš„è¿ç»­æ•´æ•°åºåˆ—
> è¦æ±‚ï¼šè¾“å…¥ä¸€ä¸ªæ­£æ•°sï¼Œ æ‰“å°å‡ºæ‰€æœ‰å’Œä¸ºsçš„æ­£æ•´æ•°åºåˆ—(è‡³å°‘ä¸¤ä¸ªæ•°)
>
> æ€è·¯: ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œå’Œæ¯”så°ï¼Œå¤§æŒ‡é’ˆåç§»ï¼Œæ¯”så¤§ï¼Œå°æŒ‡é’ˆåç§»

```python
# coding=utf-8
"""
è¾“å…¥ä¸€ä¸ªæ­£æ•°sï¼Œ æ‰“å°å‡ºæ‰€æœ‰å’Œä¸ºsçš„æ­£æ•´æ•°åºåˆ—(è‡³å°‘ä¸¤ä¸ªæ•°)
ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œå’Œæ¯”så°ï¼Œå¤§æŒ‡é’ˆåç§»ï¼Œæ¯”så¤§ï¼Œå°æŒ‡é’ˆåç§»
"""


def sum_to_s(s):
    a, b = 1, 2
    ret = []
    while a < s / 2 + 1:
        if sum(range(a, b+1)) == s:
            ret.append(range(a, b+1))
            a += 1
        elif sum(range(a, b+1)) < s:
            b += 1
        else:
            a += 1
    return ret

if __name__ == '__main__':
    test = 199
    print sum_to_s(test)
```

### 5ã€ç¿»è½¬å•è¯é¡ºåºä¸å·¦æ—‹è½¬å­—ç¬¦ä¸²
#### ç¿»è½¬å•è¯é¡ºåº
> è¦æ±‚ï¼šç¿»è½¬ä¸€ä¸ªè‹±æ–‡å¥å­ä¸­çš„å•è¯é¡ºåºï¼Œæ ‡ç‚¹å’Œæ™®é€šå­—ç¬¦ä¸€æ ·å¤„ç†
>
> æ€è·¯: Pythonä¸­å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œä¸èƒ½ç”¨ä¹¦ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è½¬åŒ–æˆåˆ—è¡¨ç„¶åè½¬å›å»

```python
# coding=utf-8
"""
ç¿»è½¬ä¸€ä¸ªè‹±æ–‡å¥å­ä¸­çš„å•è¯é¡ºåºï¼Œæ ‡ç‚¹å’Œæ™®é€šå­—ç¬¦ä¸€æ ·å¤„ç†
Pythonä¸­å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œä¸èƒ½ç”¨ä¹¦ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è½¬åŒ–æˆåˆ—è¡¨ç„¶åè½¬å›å»
"""


def reverse_words(sentence):
    tmp = sentence.split()
    return ' '.join(tmp[::-1])  # ä½¿ç”¨joinæ•ˆç‡æ›´å¥½ï¼Œ+æ¯æ¬¡éƒ½ä¼šåˆ›å»ºæ–°çš„å­—ç¬¦ä¸²

if __name__ == '__main__':
    test = 'I am a engineer.'
    print reverse_words(test)

```
#### å·¦æ—‹è½¬å­—ç¬¦ä¸²
> æ€è·¯: æŠŠå­—ç¬¦ä¸²çš„å‰é¢çš„è‹¥å¹²ä½ç§»åˆ°å­—ç¬¦ä¸²çš„åé¢

```python
# coding=utf-8
"""
æŠŠå­—ç¬¦ä¸²çš„å‰é¢çš„è‹¥å¹²ä½ç§»åˆ°å­—ç¬¦ä¸²çš„åé¢
"""


def rotate_string(s, n):
    if not s:
        return ''
    n %= len(s)
    return s[n:] + s[:n]

if __name__ == '__main__':
    test = 'abcdefg'
    print rotate_string(test, 1)

```

## æŠ½è±¡å»ºæ¨¡èƒ½åŠ›



### 6ã€nä¸ªéª°å­çš„ç‚¹æ•°
> è¦æ±‚ï¼šæ±‚å‡ºnä¸ªéª°å­æœä¸Šä¸€é¢ä¹‹å’Œsæ‰€æœ‰å¯èƒ½å€¼å‡ºç°çš„æ¦‚ç‡
>
> æ€è·¯ï¼šnå‡ºç°çš„å¯èƒ½æ˜¯å‰é¢n-1åˆ°n-6å‡ºç°å¯èƒ½çš„å’Œï¼Œè®¾ç½®ä¸¤ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«ä¿å­˜æ¯ä¸€è½®

```python
# coding=utf-8
"""
æ±‚å‡ºnä¸ªéª°å­æœä¸Šä¸€é¢ä¹‹å’Œsæ‰€æœ‰å¯èƒ½å€¼å‡ºç°çš„æ¦‚ç‡
nå‡ºç°çš„å¯èƒ½æ˜¯å‰é¢n-1åˆ°n-6å‡ºç°å¯èƒ½çš„å’Œï¼Œè®¾ç½®ä¸¤ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«ä¿å­˜æ¯ä¸€è½®
"""


def get_probability(n):
    if n < 1:
        return []
    data1 = [0] + [1] * 6 + [0] * 6 * (n - 1)
    data2 = [0] + [0] * 6 * n   # å¼€å¤´å¤šä¸€ä¸ª0ï¼Œæ–¹ä¾¿æŒ‰ç…§ä¹ æƒ¯ä»1è®¡æ•°
    flag = 0
    for v in range(2, n+1):  # æ§åˆ¶æ¬¡æ•°
        if flag:
            for k in range(v, 6*v+1):
                data1[k] = sum([data2[k-j] for j in range(1, 7) if k > j])
            flag = 0
        else:
            for k in range(v, 6*v+1):
                data2[k] = sum([data1[k-j] for j in range(1, 7) if k > j])
            flag = 1
    ret = []
    total = 6 ** n
    data = data2[n:] if flag else data1[n:]
    for v in data:
        ret.append(v*1.0/total)
    print data
    return ret

if __name__ == '__main__':
    print get_probability(3)
```

### 7ã€æ‰‘å…‹ç‰Œçš„é¡ºå­
> è¦æ±‚ï¼šä»æ‰‘å…‹ç‰Œä¸­éšæœºæŠ½å–5å¼ ç‰Œï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯é¡ºå­ï¼Œå¤§å°ç‹å¯ä»¥å½“ä»»æ„å€¼
>
> æ€è·¯: ä½¿ç”¨æ’åº

```python
# coding=utf-8
"""
ä»æ‰‘å…‹ç‰Œä¸­éšæœºæŠ½å–5å¼ ç‰Œï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯é¡ºå­ï¼Œå¤§å°ç‹å¯ä»¥å½“ä»»æ„å€¼
ä½¿ç”¨æ’åº
"""
import random


def is_continus(nums, k):
    data = [random.choice(nums) for _ in range(k)]
    data.sort()
    print data
    zero = data.count(0)
    small, big = zero, zero + 1
    while big < k:
        if data[small] == data[big]:
            return False
        tmp = data[big] - data[small]
        if tmp > 1:
            if tmp - 1 > zero:
                return False
            else:
                zero -= tmp - 1
                small += 1
                big += 1
        else:
            small += 1
            big += 1
    return True

if __name__ == '__main__':
    test = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,
            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,
            0, 0]
    t = 5
    print is_continus(test, t)
```

### 8ã€åœ†åœˆä¸­æœ€åå‰©ä¸‹çš„æ•°å­—
> è¦æ±‚ï¼š0åˆ°n-1æ’æˆä¸€åœˆï¼Œä»0å¼€å§‹æ¯æ¬¡æ•°mä¸ªæ•°åˆ é™¤ï¼Œæ±‚æœ€åå‰©ä½™çš„æ•°
>
> æ€è·¯ï¼šå½“ n > 1 æ—¶ï¼š f(n,m) = [f(n-1, m)+m]%n,å½“ n = 1 æ—¶ï¼š f(n,m)=0ï¼Œ*å…³é”®æ˜¯æ¨å¯¼å‡ºå…³ç³»è¡¨è¾¾å¼*


```python
# coding=utf-8
"""
0åˆ°n-1æ’æˆä¸€åœˆï¼Œä»0å¼€å§‹æ¯æ¬¡æ•°mä¸ªæ•°åˆ é™¤ï¼Œæ±‚æœ€åå‰©ä½™çš„æ•°
å½“ n > 1 æ—¶ï¼š f(n,m) = [f(n-1, m)+m]%n,å½“ n = 1 æ—¶ï¼š f(n,m)=0
"""


def last_num(n, m):
    ret = 0
    if n == 1:
        return 0
    for i in range(2, n+1):
        ret = (m + ret) % i
    return ret

if __name__ == '__main__':
    print last_num(3, 4)

```

## å‘æ•£æ€ç»´èƒ½åŠ›


### 9ã€æ±‚1+2...+n
> è¦æ±‚ï¼šä¸èƒ½ä½¿ç”¨ä¹˜é™¤ã€forã€whileã€ifã€elseç­‰
>
>æ–¹æ³•ä¸€ï¼šä½¿ç”¨rangeå’Œsum
>
>æ–¹æ³•äºŒï¼šä½¿ç”¨reduce


```python
# coding=utf-8
"""
ä¸èƒ½ä½¿ç”¨ä¹˜é™¤ã€forã€whileã€ifã€elseç­‰
æ–¹æ³•ä¸€ï¼šä½¿ç”¨rangeå’Œsum
æ–¹æ³•äºŒï¼šä½¿ç”¨reduce
"""


def get_sum1(n):
    return sum(range(1, n+1))


def get_sum2(n):
    return reduce(lambda x, y: x+y, range(1, n+1))


if __name__ == '__main__':
    print get_sum1(4)
    print get_sum2(40)
```

### 10ã€ä¸ç”¨åŠ å‡ä¹˜é™¤åšåŠ æ³•
> è¦æ±‚ï¼šä¸ç”¨åŠ å‡ä¹˜é™¤åšåŠ æ³•
>
>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ä½è¿ç®—ï¼ŒPythonä¸­å¤§æ•´æ•°ä¼šè‡ªåŠ¨å¤„ç†ï¼Œå› æ­¤å¯¹carryéœ€è¦åŠ ä¸ªåˆ¤æ–­
>
>æ–¹æ³•äºŒï¼šä½¿ç”¨sum


```python
# coding=utf-8
"""
ä¸ç”¨åŠ å‡ä¹˜é™¤åšåŠ æ³•
æ–¹æ³•ä¸€ï¼šä½¿ç”¨ä½è¿ç®—ï¼ŒPythonä¸­å¤§æ•´æ•°ä¼šè‡ªåŠ¨å¤„ç†ï¼Œå› æ­¤å¯¹carryéœ€è¦åŠ ä¸ªåˆ¤æ–­
æ–¹æ³•äºŒï¼šä½¿ç”¨sum
"""


def bit_add(n1, n2):
    carry = 1
    while carry:
        s = n1 ^ n2
        carry = 0xFFFFFFFF & ((n1 & n2) << 1)
        carry = -(~(carry - 1) & 0xFFFFFFFF) if carry > 0x7FFFFFFF else carry
        n1 = s
        n2 = carry
    return n1


def add(n1, n2):
    return sum([n1, n2])

if __name__ == '__main__':
    a = 222
    b = -199
    print bit_add(a, b)
    print add(a, b)
```

### 11ã€ä¸èƒ½è¢«ç»§æ‰¿çš„ç±»
>Pythonä¸­ä¸çŸ¥é“æ€ä¹ˆå®ç°ä¸èƒ½è¢«ç»§æ‰¿çš„ç±»ã€‚ä»¥åè¡¥å……ä»£ç æˆ–è€…åŸå› ã€‚

## æ¡ˆä¾‹


### 12ã€æŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆæ•´æ•°
> è¦æ±‚ï¼šæŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆæ•´æ•°
>
> æµ‹è¯•ç”¨ä¾‹ï¼šæ­£è´Ÿæ•°å’Œ0ï¼Œç©ºå­—ç¬¦ï¼ŒåŒ…å«å…¶ä»–å­—ç¬¦
>
> å¤‡æ³¨ï¼šä½¿ç”¨raiseæŠ›å‡ºå¼‚å¸¸ä½œä¸ºéæ³•æç¤º


```python
# coding=utf-8
"""
æŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆæ•´æ•°
æµ‹è¯•ç”¨ä¾‹ï¼šæ­£è´Ÿæ•°å’Œ0ï¼Œç©ºå­—ç¬¦ï¼ŒåŒ…å«å…¶ä»–å­—ç¬¦
å¤‡æ³¨ï¼šä½¿ç”¨raiseæŠ›å‡ºå¼‚å¸¸ä½œä¸ºéæ³•æç¤º
"""


def str_to_int(string):
    if not string:  # ç©ºå­—ç¬¦è¿”å›å¼‚å¸¸
        raise Exception('string cannot be None', string)
    flag = 0  # ç”¨æ¥è¡¨ç¤ºç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º+ã€-
    ret = 0  # ç»“æœ
    for k, s in enumerate(string):
        if s.isdigit():  # æ•°å­—ç›´æ¥è¿ç®—
            val = ord(s) - ord('0')
            ret = ret * 10 + val
        else:
            if not flag:
                if s == '+' and k == 0:  # é¿å…ä¸­é—´å‡ºç°+ã€-
                    flag = 1
                elif s == '-' and k == 0:
                    flag = -1
                else:
                    raise Exception('digit is need', string)
            else:
                raise Exception('digit is need', string)
    if flag and len(string) == 1:  # åˆ¤æ–­æ˜¯ä¸æ˜¯åªæœ‰+ã€-
        raise Exception('digit is need', string)
    return ret if flag >= 0 else -ret


if __name__ == '__main__':
    test = '12399+'
    print str_to_int(test)
```

### 13ã€æ ‘ä¸­ä¸¤ä¸ªç»“ç‚¹çš„æœ€ä½å…¬å…±ç¥–å…ˆ
> è¦æ±‚ï¼šæ±‚æ™®é€šäºŒå‰æ ‘ä¸­ä¸¤ä¸ªç»“ç‚¹çš„æœ€ä½å…¬å…±ç¥–å…ˆ
>
>æ–¹æ³•ä¸€ï¼šå…ˆæ±‚å‡ºä¸¤ä¸ªç»“ç‚¹åˆ°æ ¹ç»“ç‚¹çš„è·¯å¾„ï¼Œç„¶åä»è·¯å¾„ä¸­æ‰¾å‡ºæœ€åä¸€ä¸ªå…¬å…±ç»“ç‚¹
>
>å¤‡æ³¨ï¼šæ–‡ä»¶fifty.pyä¸­åŒ…å«è¯¥ä»£ç çš„å…·ä½“æµ‹è¯•æ•°æ®


```python
# coding=utf-8
"""
æ±‚æ™®é€šäºŒå‰æ ‘ä¸­ä¸¤ä¸ªç»“ç‚¹çš„æœ€ä½å…¬å…±ç¥–å…ˆ
å…ˆæ±‚å‡ºä¸¤ä¸ªç»“ç‚¹åˆ°æ ¹ç»“ç‚¹çš„è·¯å¾„ï¼Œç„¶åä»è·¯å¾„ä¸­æ‰¾å‡ºæœ€åä¸€ä¸ªå…¬å…±ç»“ç‚¹
"""
from collections import deque


class TreeNode(object):
    """æ ‘ç»“ç‚¹"""
    def __init__(self, x):
        self.val = x
        self.left = None
        self.right = None


class Tree(object):
    def __init__(self):
        self.root = None
        self.nodes = []  # æ ‘ä¸­çš„ç»“ç‚¹

    def construct_tree(self, values=None):
        """ä½¿ç”¨åˆ—è¡¨æ„é€ äºŒå‰æ ‘"""
        if not values:
            return None
        self.root = TreeNode(values[0])
        self.nodes.append(self.root)
        queue = deque([self.root])
        leng = len(values)
        nums = 1
        while nums < leng:
            node = queue.popleft()
            if node:
                node.left = TreeNode(values[nums]) if values[nums] else None
                queue.append(node.left)
                self.nodes.append(node.left)
                if nums + 1 < leng:
                    node.right = TreeNode(values[nums + 1]) if values[nums + 1] else None
                    queue.append(node.right)
                    self.nodes.append(node.right)
                    nums += 1
                nums += 1

    def get_node(self, index):
        """æ ¹æ®ç´¢å¼•è¿”å›æ ‘ä¸­çš„æŸä¸ªç»“ç‚¹"""
        if index >= len(self.nodes):
            return None
        return self.nodes[index]


class Solution(object):

    def __init__(self, root, node1, node2):
        self.root = root  # æ ‘çš„æ ¹ç»“ç‚¹
        self.node1 = node1
        self.node2 = node2  # éœ€è¦æ±‚çš„ä¸¤ä¸ªç»“ç‚¹

    @staticmethod
    def get_path(root, node, ret):
        """è·å–ç»“ç‚¹çš„è·¯å¾„"""
        if not root or not node:
            return False
        ret.append(root)
        if root == node:
            return True
        left = Solution.get_path(root.left, node, ret)
        right = Solution.get_path(root.right, node, ret)
        if left or right:
            return True
        ret.pop()

    def get_last_common_node(self):
        """è·å–å…¬å…±ç»“ç‚¹"""
        route1 = []
        route2 = []  # ä¿å­˜ç»“ç‚¹è·¯å¾„
        ret1 = Solution.get_path(self.root, self.node1, route1)
        ret2 = Solution.get_path(self.root, self.node2, route2)
        ret = None
        if ret1 and ret2:  # è·¯å¾„æ¯”è¾ƒ
            length = len(route1) if len(route1) <= len(route2) else len(route2)
            index = 0
            while index < length:
                if route1[index] == route2[index]:
                    ret = route1[index]
                index += 1
        return ret

if __name__ == '__main__':
    vals = [0, 1, 2, 3, 4, 5, 6, 7]
    tree = Tree()
    tree.construct_tree(vals)
    r = tree.root  # æ ‘çš„æ ¹ç»“ç‚¹
    n1 = tree.get_node(7)  # ç»“ç‚¹1
    n2 = tree.get_node(4)  # ç»“ç‚¹2
    s = Solution(r, n1, n2)
    parent = s.get_last_common_node()  # å…¬å…±ç»“ç‚¹
    print parent, parent.val if parent else None
```## 1 å°é˜¶é—®é¢˜/æ–æ³¢é‚£å¥‘

ä¸€åªé’è›™ä¸€æ¬¡å¯ä»¥è·³ä¸Š1çº§å°é˜¶ï¼Œä¹Ÿå¯ä»¥è·³ä¸Š2çº§ã€‚æ±‚è¯¥é’è›™è·³ä¸Šä¸€ä¸ªnçº§çš„å°é˜¶æ€»å…±æœ‰å¤šå°‘ç§è·³æ³•ã€‚

```python
fib = lambda n: n if n <= 2 else fib(n - 1) + fib(n - 2)
```

ç¬¬äºŒç§è®°å¿†æ–¹æ³•

```python
def memo(func):
    cache = {}
    def wrap(*args):
        if args not in cache:
            cache[args] = func(*args)
        return cache[args]
    return wrap


@memo
def fib(i):
    if i < 2:
        return 1
    return fib(i-1) + fib(i-2)
```

ç¬¬ä¸‰ç§æ–¹æ³•

```python
def fib(n):
    a, b = 0, 1
    for _ in xrange(n):
        a, b = b, a + b
    return b
```

## 2 å˜æ€å°é˜¶é—®é¢˜

ä¸€åªé’è›™ä¸€æ¬¡å¯ä»¥è·³ä¸Š1çº§å°é˜¶ï¼Œä¹Ÿå¯ä»¥è·³ä¸Š2çº§â€¦â€¦å®ƒä¹Ÿå¯ä»¥è·³ä¸Šnçº§ã€‚æ±‚è¯¥é’è›™è·³ä¸Šä¸€ä¸ªnçº§çš„å°é˜¶æ€»å…±æœ‰å¤šå°‘ç§è·³æ³•ã€‚

```python
fib = lambda n: n if n < 2 else 2 * fib(n - 1)
```

## 3 çŸ©å½¢è¦†ç›–

æˆ‘ä»¬å¯ä»¥ç”¨`2*1`çš„å°çŸ©å½¢æ¨ªç€æˆ–è€…ç«–ç€å»è¦†ç›–æ›´å¤§çš„çŸ©å½¢ã€‚è¯·é—®ç”¨nä¸ª`2*1`çš„å°çŸ©å½¢æ— é‡å åœ°è¦†ç›–ä¸€ä¸ª`2*n`çš„å¤§çŸ©å½¢ï¼Œæ€»å…±æœ‰å¤šå°‘ç§æ–¹æ³•ï¼Ÿ

> ç¬¬`2*n`ä¸ªçŸ©å½¢çš„è¦†ç›–æ–¹æ³•ç­‰äºç¬¬`2*(n-1)`åŠ ä¸Šç¬¬`2*(n-2)`çš„æ–¹æ³•ã€‚

```python
f = lambda n: 1 if n < 2 else f(n - 1) + f(n - 2)
```

## 4 æ¨æ°çŸ©é˜µæŸ¥æ‰¾

åœ¨ä¸€ä¸ªmè¡Œnåˆ—äºŒç»´æ•°ç»„ä¸­ï¼Œæ¯ä¸€è¡Œéƒ½æŒ‰ç…§ä»å·¦åˆ°å³é€’å¢çš„é¡ºåºæ’åºï¼Œæ¯ä¸€åˆ—éƒ½æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹é€’å¢çš„é¡ºåºæ’åºã€‚è¯·å®Œæˆä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥è¿™æ ·çš„ä¸€ä¸ªäºŒç»´æ•°ç»„å’Œä¸€ä¸ªæ•´æ•°ï¼Œåˆ¤æ–­æ•°ç»„ä¸­æ˜¯å¦å«æœ‰è¯¥æ•´æ•°ã€‚

ä½¿ç”¨Step-wiseçº¿æ€§æœç´¢ã€‚

```python
def get_value(l, r, c):
    return l[r][c]

def find(l, x):
    m = len(l) - 1
    n = len(l[0]) - 1
    r = 0
    c = n
    while c >= 0 and r <= m:
        value = get_value(l, r, c)
        if value == x:
            return True
        elif value > x:
            c = c - 1
        elif value < x:
            r = r + 1
    return False
```

## 5 å»é™¤åˆ—è¡¨ä¸­çš„é‡å¤å…ƒç´ 

ç”¨é›†åˆ

```python
list(set(l))
```

ç”¨å­—å…¸

```python
l1 = ['b','c','d','b','c','a','a']
l2 = {}.fromkeys(l1).keys()
print l2
```

ç”¨å­—å…¸å¹¶ä¿æŒé¡ºåº

```python
l1 = ['b','c','d','b','c','a','a']
l2 = list(set(l1))
l2.sort(key=l1.index)
print l2
```

åˆ—è¡¨æ¨å¯¼å¼

```python
l1 = ['b','c','d','b','c','a','a']
l2 = []
[l2.append(i) for i in l1 if not i in l2]
```

sortedæ’åºå¹¶ä¸”ç”¨åˆ—è¡¨æ¨å¯¼å¼.

l = ['b','c','d','b','c','a','a']
[single.append(i) for i in sorted(l) if i not in single]
print single

## 6 é“¾è¡¨æˆå¯¹è°ƒæ¢

`1->2->3->4`è½¬æ¢æˆ`2->1->4->3`.

```python
class ListNode:
    def __init__(self, x):
        self.val = x
        self.next = None

class Solution:
    # @param a ListNode
    # @return a ListNode
    def swapPairs(self, head):
        if head != None and head.next != None:
            next = head.next
            head.next = self.swapPairs(next.next)
            next.next = head
            return next
        return head
```

## 7 åˆ›å»ºå­—å…¸çš„æ–¹æ³•

### 1 ç›´æ¥åˆ›å»º

```python
dict = {'name':'earth', 'port':'80'}
```

### 2 å·¥å‚æ–¹æ³•

```python
items=[('name','earth'),('port','80')]
dict2=dict(items)
dict1=dict((['name','earth'],['port','80']))
```

### 3 fromkeys()æ–¹æ³•

```python
dict1={}.fromkeys(('x','y'),-1)
dict={'x':-1,'y':-1}
dict2={}.fromkeys(('x','y'))
dict2={'x':None, 'y':None}
```

## 8 åˆå¹¶ä¸¤ä¸ªæœ‰åºåˆ—è¡¨

çŸ¥ä¹è¿œç¨‹é¢è¯•è¦æ±‚ç¼–ç¨‹

> å°¾é€’å½’

```python
def _recursion_merge_sort2(l1, l2, tmp):
    if len(l1) == 0 or len(l2) == 0:
        tmp.extend(l1)
        tmp.extend(l2)
        return tmp
    else:
        if l1[0] < l2[0]:
            tmp.append(l1[0])
            del l1[0]
        else:
            tmp.append(l2[0])
            del l2[0]
        return _recursion_merge_sort2(l1, l2, tmp)

def recursion_merge_sort2(l1, l2):
    return _recursion_merge_sort2(l1, l2, [])
```

> å¾ªç¯ç®—æ³•

æ€è·¯ï¼š

å®šä¹‰ä¸€ä¸ªæ–°çš„ç©ºåˆ—è¡¨

æ¯”è¾ƒä¸¤ä¸ªåˆ—è¡¨çš„é¦–ä¸ªå…ƒç´ 

å°çš„å°±æ’å…¥åˆ°æ–°åˆ—è¡¨é‡Œ

æŠŠå·²ç»æ’å…¥æ–°åˆ—è¡¨çš„å…ƒç´ ä»æ—§åˆ—è¡¨åˆ é™¤

ç›´åˆ°ä¸¤ä¸ªæ—§åˆ—è¡¨æœ‰ä¸€ä¸ªä¸ºç©º

å†æŠŠæ—§åˆ—è¡¨åŠ åˆ°æ–°åˆ—è¡¨åé¢

```pyhton
def loop_merge_sort(l1, l2):
    tmp = []
    while len(l1) > 0 and len(l2) > 0:
        if l1[0] < l2[0]:
            tmp.append(l1[0])
            del l1[0]
        else:
            tmp.append(l2[0])
            del l2[0]
    tmp.extend(l1)
    tmp.extend(l2)
    return tmp
```

> popå¼¹å‡º

```Python
a = [1,2,3,7]
b = [3,4,5]

def merge_sortedlist(a,b):
    c = []
    while a and b:
        if a[0] >= b[0]:
            c.append(b.pop(0))
        else:
            c.append(a.pop(0))
    while a:
        c.append(a.pop(0))
    while b:
        c.append(b.pop(0))
    return c
print merge_sortedlist(a,b)
    
```

## 9 äº¤å‰é“¾è¡¨æ±‚äº¤ç‚¹

> å…¶å®æ€æƒ³å¯ä»¥æŒ‰ç…§ä»å°¾å¼€å§‹æ¯”è¾ƒä¸¤ä¸ªé“¾è¡¨ï¼Œå¦‚æœç›¸äº¤ï¼Œåˆ™ä»å°¾å¼€å§‹å¿…ç„¶ä¸€è‡´ï¼Œåªè¦ä»å°¾å¼€å§‹æ¯”è¾ƒï¼Œç›´è‡³ä¸ä¸€è‡´çš„åœ°æ–¹å³ä¸ºäº¤å‰ç‚¹ï¼Œå¦‚å›¾æ‰€ç¤º

![](http://hi.csdn.net/attachment/201106/28/0_1309244136MWLP.gif)

```python
# ä½¿ç”¨a,bä¸¤ä¸ªlistæ¥æ¨¡æ‹Ÿé“¾è¡¨ï¼Œå¯ä»¥çœ‹å‡ºäº¤å‰ç‚¹æ˜¯ 7è¿™ä¸ªèŠ‚ç‚¹
a = [1,2,3,7,9,1,5]
b = [4,5,7,9,1,5]

for i in range(1,min(len(a),len(b))):
    if i==1 and (a[-1] != b[-1]):
        print "No"
        break
    else:
        if a[-i] != b[-i]:
            print "äº¤å‰èŠ‚ç‚¹ï¼š",a[-i+1]
            break
        else:
            pass
```

> å¦å¤–ä¸€ç§æ¯”è¾ƒæ­£è§„çš„æ–¹æ³•ï¼Œæ„é€ é“¾è¡¨ç±»

```python
class ListNode:
    def __init__(self, x):
        self.val = x
        self.next = None
def node(l1, l2):
    length1, lenth2 = 0, 0
    # æ±‚ä¸¤ä¸ªé“¾è¡¨é•¿åº¦
    while l1.next:
        l1 = l1.next
        length1 += 1
    while l2.next:
        l2 = l2.next
        length2 += 1
    # é•¿çš„é“¾è¡¨å…ˆèµ°
    if length1 > lenth2:
        for _ in range(length1 - length2):
            l1 = l1.next
    else:
        for _ in range(length2 - length1):
            l2 = l2.next
    while l1 and l2:
        if l1.next == l2.next:
            return l1.next
        else:
            l1 = l1.next
            l2 = l2.next
```

ä¿®æ”¹äº†ä¸€ä¸‹:

```python
#coding:utf-8
class ListNode:
    def __init__(self, x):
        self.val = x
        self.next = None

def node(l1, l2):
    length1, length2 = 0, 0
    # æ±‚ä¸¤ä¸ªé“¾è¡¨é•¿åº¦
    while l1.next:
        l1 = l1.next#å°¾èŠ‚ç‚¹
        length1 += 1
    while l2.next:
        l2 = l2.next#å°¾èŠ‚ç‚¹
        length2 += 1

    #å¦‚æœç›¸äº¤
    if l1.next == l2.next:
        # é•¿çš„é“¾è¡¨å…ˆèµ°
        if length1 > length2:
            for _ in range(length1 - length2):
                l1 = l1.next
            return l1#è¿”å›äº¤ç‚¹
        else:
            for _ in range(length2 - length1):
                l2 = l2.next
            return l2#è¿”å›äº¤ç‚¹
    # å¦‚æœä¸ç›¸äº¤
    else:
        return
```

æ€è·¯: http://humaoli.blog.163.com/blog/static/13346651820141125102125995/

## 10 äºŒåˆ†æŸ¥æ‰¾

```python
#coding:utf-8
def binary_search(list,item):
    low = 0
    high = len(list)-1
    while low<=high:
        mid = (low+high)/2
        guess = list[mid]
        if guess>item:
            high = mid-1
        elif guess<item:
            low = mid+1
        else:
            return mid
    return None
mylist = [1,3,5,7,9]
print binary_search(mylist,3)

```

å‚è€ƒ: http://blog.csdn.net/u013205877/article/details/76411718

## 11 å¿«æ’

```python
#coding:utf-8
def quicksort(list):
    if len(list)<2:
        return list
    else:
        midpivot = list[0]
        lessbeforemidpivot = [i for i in list[1:] if i<=midpivot]
        biggerafterpivot = [i for i in list[1:] if i > midpivot]
        finallylist = quicksort(lessbeforemidpivot)+[midpivot]+quicksort(biggerafterpivot)
        return finallylist

print quicksort([2,4,6,7,1,2,5])
```

> æ›´å¤šæ’åºé—®é¢˜å¯è§ï¼š[æ•°æ®ç»“æ„ä¸ç®—æ³•-æ’åºç¯‡-Pythonæè¿°](http://blog.csdn.net/mrlevo520/article/details/77829204)

## 12 æ‰¾é›¶é—®é¢˜

```python
#coding:utf-8
#valuesæ˜¯ç¡¬å¸çš„é¢å€¼values = [ 25, 21, 10, 5, 1]
#valuesCounts   é’±å¸å¯¹åº”çš„ç§ç±»æ•°
#money  æ‰¾å‡ºæ¥çš„æ€»é’±æ•°
#coinsUsed   å¯¹åº”äºç›®å‰é’±å¸æ€»æ•°iæ‰€ä½¿ç”¨çš„ç¡¬å¸æ•°ç›®

def coinChange(values,valuesCounts,money,coinsUsed):
    #éå†å‡ºä»1åˆ°moneyæ‰€æœ‰çš„é’±æ•°å¯èƒ½
    for cents in range(1,money+1):
        minCoins = cents
        #æŠŠæ‰€æœ‰çš„ç¡¬å¸é¢å€¼éå†å‡ºæ¥å’Œé’±æ•°åšå¯¹æ¯”
        for kind in range(0,valuesCounts):
            if (values[kind] <= cents):
                temp = coinsUsed[cents - values[kind]] +1
                if (temp < minCoins):
                    minCoins = temp
        coinsUsed[cents] = minCoins
        print ('é¢å€¼:{0}çš„æœ€å°‘ç¡¬å¸ä½¿ç”¨æ•°ä¸º:{1}'.format(cents, coinsUsed[cents]))

```

æ€è·¯: http://blog.csdn.net/wdxin1322/article/details/9501163

æ–¹æ³•: http://www.cnblogs.com/ChenxofHit/archive/2011/03/18/1988431.html

## 13 å¹¿åº¦éå†å’Œæ·±åº¦éå†äºŒå‰æ ‘

ç»™å®šä¸€ä¸ªæ•°ç»„ï¼Œæ„å»ºäºŒå‰æ ‘ï¼Œå¹¶ä¸”æŒ‰å±‚æ¬¡æ‰“å°è¿™ä¸ªäºŒå‰æ ‘

## 14 äºŒå‰æ ‘èŠ‚ç‚¹

```python
class Node(object):
    def __init__(self, data, left=None, right=None):
        self.data = data
        self.left = left
        self.right = right

tree = Node(1, Node(3, Node(7, Node(0)), Node(6)), Node(2, Node(5), Node(4)))

```

## 15 å±‚æ¬¡éå†

```python
def lookup(root):
    row = [root]
    while row:
 Â  Â  Â  Â print(row)
 Â  Â  Â  Â row = [kid for item in row for kid in (item.left, item.right) if kid]

```

## 16 æ·±åº¦éå†

```python
def deep(root):
    if not root:
        return
    print root.data
    deep(root.left)
    deep(root.right)

if __name__ == '__main__':
    lookup(tree)
    deep(tree)
```

## 17 å‰ä¸­ååºéå†

æ·±åº¦éå†æ”¹å˜é¡ºåºå°±OKäº†

```python
#coding:utf-8
#äºŒå‰æ ‘çš„éå†
#ç®€å•çš„äºŒå‰æ ‘èŠ‚ç‚¹ç±»
class Node(object):
    def __init__(self,value,left,right):
        self.value = value
        self.left = left
        self.right = right

#ä¸­åºéå†:éå†å·¦å­æ ‘,è®¿é—®å½“å‰èŠ‚ç‚¹,éå†å³å­æ ‘

def mid_travelsal(root):
    if root.left is not None:
        mid_travelsal(root.left)
    #è®¿é—®å½“å‰èŠ‚ç‚¹
    print(root.value)
    if root.right is not None:
        mid_travelsal(root.right)

#å‰åºéå†:è®¿é—®å½“å‰èŠ‚ç‚¹,éå†å·¦å­æ ‘,éå†å³å­æ ‘

def pre_travelsal(root):
    print (root.value)
    if root.left is not None:
        pre_travelsal(root.left)
    if root.right is not None:
        pre_travelsal(root.right)

#åç»­éå†:éå†å·¦å­æ ‘,éå†å³å­æ ‘,è®¿é—®å½“å‰èŠ‚ç‚¹

def post_trvelsal(root):
    if root.left is not None:
        post_trvelsal(root.left)
    if root.right is not None:
        post_trvelsal(root.right)
    print (root.value)

```

## 18 æ±‚æœ€å¤§æ ‘æ·±

```python
def maxDepth(root):
        if not root:
            return 0
        return max(maxDepth(root.left), maxDepth(root.right)) + 1
```

## 19 æ±‚ä¸¤æ£µæ ‘æ˜¯å¦ç›¸åŒ

```python
def isSameTree(p, q):
    if p == None and q == None:
        return True
    elif p and q :
        return p.val == q.val and isSameTree(p.left,q.left) and isSameTree(p.right,q.right)
    else :
        return False
```

## 20 å‰åºä¸­åºæ±‚ååº

æ¨è: http://blog.csdn.net/hinyunsin/article/details/6315502

```python
def rebuild(pre, center):
    if not pre:
        return
    cur = Node(pre[0])
    index = center.index(pre[0])
    cur.left = rebuild(pre[1:index + 1], center[:index])
    cur.right = rebuild(pre[index + 1:], center[index + 1:])
    return cur

def deep(root):
    if not root:
        return
    deep(root.left)
    deep(root.right)
    print root.data
```

## 21 å•é“¾è¡¨é€†ç½®

```python
class Node(object):
    def __init__(self, data=None, next=None):
        self.data = data
        self.next = next

link = Node(1, Node(2, Node(3, Node(4, Node(5, Node(6, Node(7, Node(8, Node(9)))))))))

def rev(link):
    pre = link
    cur = link.next
    pre.next = None
    while cur:
        tmp = cur.next
        cur.next = pre
        pre = cur
        cur = tmp
    return pre

root = rev(link)
while root:
    print root.data
    root = root.next
```

æ€è·¯: http://blog.csdn.net/feliciafay/article/details/6841115

æ–¹æ³•: http://www.xuebuyuan.com/2066385.html?mobile=1

## 22 ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ˜¯å˜ä½è¯

```python
class Anagram:
    """
    @:param s1: The first string
    @:param s2: The second string
    @:return true or false
    """
    def Solution1(s1,s2):
        alist = list(s2)

        pos1 = 0
        stillOK = True

        while pos1 < len(s1) and stillOK:
            pos2 = 0
            found = False
            while pos2 < len(alist) and not found:
                if s1[pos1] == alist[pos2]:
                    found = True
                else:
                    pos2 = pos2 + 1

            if found:
                alist[pos2] = None
            else:
                stillOK = False

            pos1 = pos1 + 1

        return stillOK

    print(Solution1('abcd','dcba'))

    def Solution2(s1,s2):
        alist1 = list(s1)
        alist2 = list(s2)

        alist1.sort()
        alist2.sort()


        pos = 0
        matches = True

        while pos < len(s1) and matches:
            if alist1[pos] == alist2[pos]:
                pos = pos + 1
            else:
                matches = False

        return matches

    print(Solution2('abcde','edcbg'))

    def Solution3(s1,s2):
        c1 = [0]*26
        c2 = [0]*26

        for i in range(len(s1)):
            pos = ord(s1[i])-ord('a')
            c1[pos] = c1[pos] + 1

        for i in range(len(s2)):
            pos = ord(s2[i])-ord('a')
            c2[pos] = c2[pos] + 1

        j = 0
        stillOK = True
        while j<26 and stillOK:
            if c1[j] == c2[j]:
                j = j + 1
            else:
                stillOK = False

        return stillOK

    print(Solution3('apple','pleap'))
```



## 23 åŠ¨æ€è§„åˆ’é—®é¢˜

> å¯å‚è€ƒï¼š[åŠ¨æ€è§„åˆ’(DP)çš„æ•´ç†-Pythonæè¿°](http://blog.csdn.net/mrlevo520/article/details/75676160)

<!-- TOC -->

- [ç½‘ç»œç¼–ç¨‹](#%e7%bd%91%e7%bb%9c%e7%bc%96%e7%a8%8b)
  - [1.ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹](#1%e4%b8%89%e6%ac%a1%e6%8f%a1%e6%89%8b%e5%92%8c%e5%9b%9b%e6%ac%a1%e6%8c%a5%e6%89%8b)
  - [2.ARPåè®®](#2arp%e5%8d%8f%e8%ae%ae)
  - [3.urllibå’Œurllib2çš„åŒºåˆ«](#3urllib%e5%92%8curllib2%e7%9a%84%e5%8c%ba%e5%88%ab)
  - [4.Postå’ŒGet](#4post%e5%92%8cget)
  - [5.Cookieå’ŒSession](#5cookie%e5%92%8csession)
  - [6.apacheå’Œnginxçš„åŒºåˆ«](#6apache%e5%92%8cnginx%e7%9a%84%e5%8c%ba%e5%88%ab)
  - [7.ç½‘ç«™ç”¨æˆ·å¯†ç ä¿å­˜](#7%e7%bd%91%e7%ab%99%e7%94%a8%e6%88%b7%e5%af%86%e7%a0%81%e4%bf%9d%e5%ad%98)
  - [8.HTTPå’ŒHTTPS](#8http%e5%92%8chttps)
  - [9.CSRFå’ŒXSS](#9csrf%e5%92%8cxss)
  - [10.å¹‚ç­‰ Idempotence](#10%e5%b9%82%e7%ad%89-idempotence)
  - [11.RESTfulæ¶æ„(SOAP,RPC)](#11restful%e6%9e%b6%e6%9e%84soaprpc)
  - [12.SOAP](#12soap)
  - [13.RPC](#13rpc)
  - [14.CGIå’ŒWSGI](#14cgi%e5%92%8cwsgi)
  - [15.ä¸­é—´äººæ”»å‡»](#15%e4%b8%ad%e9%97%b4%e4%ba%ba%e6%94%bb%e5%87%bb)
  - [16.c10ké—®é¢˜](#16c10k%e9%97%ae%e9%a2%98)
  - [17.socket](#17socket)
  - [18.æµè§ˆå™¨ç¼“å­˜](#18%e6%b5%8f%e8%a7%88%e5%99%a8%e7%bc%93%e5%ad%98)
  - [19.HTTP1.0å’ŒHTTP1.1](#19http10%e5%92%8chttp11)
  - [20.Ajax](#20ajax)
  - [21.æ€ä¹ˆå®ç°å¼ºè¡Œå…³é—­å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥?](#21%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e5%bc%ba%e8%a1%8c%e5%85%b3%e9%97%ad%e5%ae%a2%e6%88%b7%e7%ab%af%e5%92%8c%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b9%8b%e9%97%b4%e7%9a%84%e8%bf%9e%e6%8e%a5)
  - [22.ç®€è¿°TCPå’ŒUDPçš„åŒºåˆ«ä»¥åŠä¼˜ç¼ºç‚¹?](#22%e7%ae%80%e8%bf%b0tcp%e5%92%8cudp%e7%9a%84%e5%8c%ba%e5%88%ab%e4%bb%a5%e5%8f%8a%e4%bc%98%e7%bc%ba%e7%82%b9)
  - [23.ç®€è¿°æµè§ˆå™¨é€šè¿‡WSGIè¯·æ±‚åŠ¨æ€èµ„æºçš„è¿‡ç¨‹?](#23%e7%ae%80%e8%bf%b0%e6%b5%8f%e8%a7%88%e5%99%a8%e9%80%9a%e8%bf%87wsgi%e8%af%b7%e6%b1%82%e5%8a%a8%e6%80%81%e8%b5%84%e6%ba%90%e7%9a%84%e8%bf%87%e7%a8%8b)
  - [24.æè¿°ç”¨æµè§ˆå™¨è®¿é—®www.baidu.comçš„è¿‡ç¨‹](#24%e6%8f%8f%e8%bf%b0%e7%94%a8%e6%b5%8f%e8%a7%88%e5%99%a8%e8%ae%bf%e9%97%aewwwbaiducom%e7%9a%84%e8%bf%87%e7%a8%8b)
  - [25.åˆ—å‡ºä½ çŸ¥é“çš„HTTPåè®®çš„çŠ¶æ€ç ï¼Œè¯´å‡ºè¡¨ç¤ºä»€ä¹ˆæ„æ€ï¼Ÿ](#25%e5%88%97%e5%87%ba%e4%bd%a0%e7%9f%a5%e9%81%93%e7%9a%84http%e5%8d%8f%e8%ae%ae%e7%9a%84%e7%8a%b6%e6%80%81%e7%a0%81%e8%af%b4%e5%87%ba%e8%a1%a8%e7%a4%ba%e4%bb%80%e4%b9%88%e6%84%8f%e6%80%9d)
  - [26.è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯tcpçš„2MSLï¼Ÿ](#26%e8%af%b4%e4%b8%80%e4%b8%8b%e4%bb%80%e4%b9%88%e6%98%aftcp%e7%9a%842msl)
  - [27.ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯åœ¨TIME-WAITçŠ¶æ€å¿…é¡»ç­‰å¾…2MSLçš„æ—¶é—´ï¼Ÿ](#27%e4%b8%ba%e4%bb%80%e4%b9%88%e5%ae%a2%e6%88%b7%e7%ab%af%e5%9c%a8time-wait%e7%8a%b6%e6%80%81%e5%bf%85%e9%a1%bb%e7%ad%89%e5%be%852msl%e7%9a%84%e6%97%b6%e9%97%b4)
  - [28.è°ˆä¸€ä¸‹HTTPåè®®ä»¥åŠåè®®å¤´éƒ¨ä¸­è¡¨ç¤ºæ•°æ®ç±»å‹çš„å­—æ®µï¼Ÿ](#28%e8%b0%88%e4%b8%80%e4%b8%8bhttp%e5%8d%8f%e8%ae%ae%e4%bb%a5%e5%8f%8a%e5%8d%8f%e8%ae%ae%e5%a4%b4%e9%83%a8%e4%b8%ad%e8%a1%a8%e7%a4%ba%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b%e7%9a%84%e5%ad%97%e6%ae%b5)
  - [29.ä½¿ç”¨Socketå¥—æ¥å­—éœ€è¦ä¼ å…¥å“ªäº›å‚æ•° ï¼Ÿ](#29%e4%bd%bf%e7%94%a8socket%e5%a5%97%e6%8e%a5%e5%ad%97%e9%9c%80%e8%a6%81%e4%bc%a0%e5%85%a5%e5%93%aa%e4%ba%9b%e5%8f%82%e6%95%b0)
  - [30.HTTPå¸¸è§è¯·æ±‚å¤´ï¼Ÿ](#30http%e5%b8%b8%e8%a7%81%e8%af%b7%e6%b1%82%e5%a4%b4)
  - [31.ä¸ƒå±‚æ¨¡å‹ï¼Ÿ](#31%e4%b8%83%e5%b1%82%e6%a8%a1%e5%9e%8b)
  - [32.urlçš„å½¢å¼ï¼Ÿ](#32url%e7%9a%84%e5%bd%a2%e5%bc%8f)

<!-- /TOC -->

## ç½‘ç»œç¼–ç¨‹
### 1.ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹

ä¸‰æ¬¡æ¡æ‰‹ï¼š

1. å®¢æˆ·ç«¯é€šè¿‡å‘æœåŠ¡å™¨ç«¯å‘é€ä¸€ä¸ªSYNæ¥åˆ›å»ºä¸€ä¸ªä¸»åŠ¨æ‰“å¼€ï¼Œä½œä¸ºä¸‰æ¬¡æ¡æ‰‹çš„ä¸€éƒ¨åˆ†ã€‚å®¢æˆ·ç«¯æŠŠè¿™æ®µè¿æ¥çš„åºå·è®¾å®šä¸ºéšæœºæ•° Aã€‚
2. æœåŠ¡å™¨ç«¯åº”å½“ä¸ºä¸€ä¸ªåˆæ³•çš„SYNå›é€ä¸€ä¸ªSYN/ACKã€‚ACK çš„ç¡®è®¤ç åº”ä¸º A+1ï¼ŒSYN/ACK åŒ…æœ¬èº«åˆæœ‰ä¸€ä¸ªéšæœºåºå· Bã€‚
3. æœ€åï¼Œå®¢æˆ·ç«¯å†å‘é€ä¸€ä¸ªACKã€‚å½“æœåŠ¡ç«¯å—åˆ°è¿™ä¸ªACKçš„æ—¶å€™ï¼Œå°±å®Œæˆäº†ä¸‰è·¯æ¡æ‰‹ï¼Œå¹¶è¿›å…¥äº†è¿æ¥åˆ›å»ºçŠ¶æ€ã€‚æ­¤æ—¶åŒ…åºå·è¢«è®¾å®šä¸ºæ”¶åˆ°çš„ç¡®è®¤å· A+1ï¼Œè€Œå“åº”åˆ™ä¸º B+1ã€‚

å››æ¬¡æŒ¥æ‰‹ï¼š

æ³¨æ„: ä¸­æ–­è¿æ¥ç«¯å¯ä»¥æ˜¯å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨ç«¯ã€‚ä¸‹é¢ä»…ä»¥å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¸¾ä¾‹ï¼Œåä¹‹äº¦ç„¶ï¼š

1. å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ•°æ®åˆ†æ®µ, å…¶ä¸­çš„ FIN æ ‡è®°è®¾ç½®ä¸º1. å®¢æˆ·ç«¯è¿›å…¥ FIN-WAIT çŠ¶æ€. è¯¥çŠ¶æ€ä¸‹å®¢æˆ·ç«¯åªæ¥æ”¶æ•°æ®, ä¸å†å‘é€æ•°æ®.
2. æœåŠ¡å™¨æ¥æ”¶åˆ°å¸¦æœ‰ FIN = 1 çš„æ•°æ®åˆ†æ®µ, å‘é€å¸¦æœ‰ ACK = 1 çš„å‰©ä½™æ•°æ®åˆ†æ®µ, ç¡®è®¤æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„ FIN ä¿¡æ¯.
3. æœåŠ¡å™¨ç­‰åˆ°æ‰€æœ‰æ•°æ®ä¼ è¾“ç»“æŸ, å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå¸¦æœ‰ FIN = 1 çš„æ•°æ®åˆ†æ®µ, å¹¶è¿›å…¥ CLOSE-WAIT çŠ¶æ€, ç­‰å¾…å®¢æˆ·ç«¯å‘æ¥å¸¦æœ‰ ACK = 1 çš„ç¡®è®¤æŠ¥æ–‡.
4. å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥å¸¦æœ‰ FIN = 1 çš„æŠ¥æ–‡, è¿”å› ACK = 1 çš„æŠ¥æ–‡ç¡®è®¤, ä¸ºäº†é˜²æ­¢æœåŠ¡å™¨ç«¯æœªæ”¶åˆ°éœ€è¦é‡å‘, è¿›å…¥ TIME-WAIT çŠ¶æ€. æœåŠ¡å™¨æ¥æ”¶åˆ°æŠ¥æ–‡åå…³é—­è¿æ¥. å®¢æˆ·ç«¯ç­‰å¾… 2MSL åæœªæ”¶åˆ°å›å¤, åˆ™è®¤ä¸ºæœåŠ¡å™¨æˆåŠŸå…³é—­, å®¢æˆ·ç«¯å…³é—­è¿æ¥.

å›¾è§£: http://blog.csdn.net/whuslei/article/details/6667471

### 2.ARPåè®®

åœ°å€è§£æåè®®(Address Resolution Protocol)ï¼Œå…¶åŸºæœ¬åŠŸèƒ½ä¸ºé€è¿‡ç›®æ ‡è®¾å¤‡çš„IPåœ°å€ï¼ŒæŸ¥è¯¢ç›®æ ‡çš„MACåœ°å€ï¼Œä»¥ä¿è¯é€šä¿¡çš„é¡ºåˆ©è¿›è¡Œã€‚å®ƒæ˜¯IPv4ç½‘ç»œå±‚å¿…ä¸å¯å°‘çš„åè®®ï¼Œä¸è¿‡åœ¨IPv6ä¸­å·²ä¸å†é€‚ç”¨ï¼Œå¹¶è¢«é‚»å±…å‘ç°åè®®ï¼ˆNDPï¼‰æ‰€æ›¿ä»£ã€‚

### 3.urllibå’Œurllib2çš„åŒºåˆ«

è¿™ä¸ªé¢è¯•å®˜ç¡®å®é—®è¿‡ï¼Œå½“æ—¶ç­”çš„urllib2å¯ä»¥Postè€Œurllibä¸å¯ä»¥ã€‚

1. urllibæä¾›urlencodeæ–¹æ³•ç”¨æ¥GETæŸ¥è¯¢å­—ç¬¦ä¸²çš„äº§ç”Ÿï¼Œè€Œurllib2æ²¡æœ‰ã€‚è¿™æ˜¯ä¸ºä½•urllibå¸¸å’Œurllib2ä¸€èµ·ä½¿ç”¨çš„åŸå› ã€‚
2. urllib2å¯ä»¥æ¥å—ä¸€ä¸ªRequestç±»çš„å®ä¾‹æ¥è®¾ç½®URLè¯·æ±‚çš„headersï¼Œurllibä»…å¯ä»¥æ¥å—URLã€‚è¿™æ„å‘³ç€ï¼Œä½ ä¸å¯ä»¥ä¼ªè£…ä½ çš„User Agentå­—ç¬¦ä¸²ç­‰ã€‚

### 4.Postå’ŒGet

[GETå’ŒPOSTæœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸåŠä¸ºä»€ä¹ˆç½‘ä¸Šçš„å¤šæ•°ç­”æ¡ˆéƒ½æ˜¯é”™çš„](http://www.cnblogs.com/nankezhishi/archive/2012/06/09/getandpost.html)

[çŸ¥ä¹å›ç­”](https://www.zhihu.com/question/31640769?rf=37401322)

get: [RFC 2616 - Hypertext Transfer Protocol -- HTTP/1.1](http://tools.ietf.org/html/rfc2616#section-9.3)
post: [RFC 2616 - Hypertext Transfer Protocol -- HTTP/1.1](http://tools.ietf.org/html/rfc2616#section-9.5)

### 5.Cookieå’ŒSession

|          | Cookie                                               | Session  |
| :------- | :--------------------------------------------------- | :------- |
| å‚¨å­˜ä½ç½® | å®¢æˆ·ç«¯                                               | æœåŠ¡å™¨ç«¯ |
| ç›®çš„     | è·Ÿè¸ªä¼šè¯ï¼Œä¹Ÿå¯ä»¥ä¿å­˜ç”¨æˆ·åå¥½è®¾ç½®æˆ–è€…ä¿å­˜ç”¨æˆ·åå¯†ç ç­‰ | è·Ÿè¸ªä¼šè¯ |
| å®‰å…¨æ€§   | ä¸å®‰å…¨                                               | å®‰å…¨     |

sessionæŠ€æœ¯æ˜¯è¦ä½¿ç”¨åˆ°cookieçš„ï¼Œä¹‹æ‰€ä»¥å‡ºç°sessionæŠ€æœ¯ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®‰å…¨ã€‚

### 6.apacheå’Œnginxçš„åŒºåˆ«

nginx ç›¸å¯¹ apache çš„ä¼˜ç‚¹ï¼š

- è½»é‡çº§ï¼ŒåŒæ ·èµ· web æœåŠ¡ï¼Œæ¯” apache å ç”¨æ›´å°‘çš„å†…å­˜åŠèµ„æº
- æŠ—å¹¶å‘ï¼Œnginx å¤„ç†è¯·æ±‚æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œæ”¯æŒæ›´å¤šçš„å¹¶å‘è¿æ¥ï¼Œè€Œ apache åˆ™æ˜¯é˜»å¡å‹çš„ï¼Œåœ¨é«˜å¹¶å‘ä¸‹ nginx èƒ½ä¿æŒä½èµ„æºä½æ¶ˆè€—é«˜æ€§èƒ½
- é…ç½®ç®€æ´
- é«˜åº¦æ¨¡å—åŒ–çš„è®¾è®¡ï¼Œç¼–å†™æ¨¡å—ç›¸å¯¹ç®€å•
- ç¤¾åŒºæ´»è·ƒ

apache ç›¸å¯¹ nginx çš„ä¼˜ç‚¹ï¼š

- rewrite ï¼Œæ¯” nginx çš„ rewrite å¼ºå¤§
- æ¨¡å—è¶…å¤šï¼ŒåŸºæœ¬æƒ³åˆ°çš„éƒ½å¯ä»¥æ‰¾åˆ°
- å°‘ bug ï¼Œnginx çš„ bug ç›¸å¯¹è¾ƒå¤š
- è¶…ç¨³å®š

### 7.ç½‘ç«™ç”¨æˆ·å¯†ç ä¿å­˜

1. æ˜æ–‡ä¿å­˜
2. æ˜æ–‡hashåä¿å­˜,å¦‚md5
3. MD5+Saltæ–¹å¼,è¿™ä¸ªsaltå¯ä»¥éšæœº
4. çŸ¥ä¹ä½¿ç”¨äº†Bcrypy(å¥½åƒ)åŠ å¯†

### 8.HTTPå’ŒHTTPS

| çŠ¶æ€ç          | å®šä¹‰                            |
| :------------- | :------------------------------ |
| 1xx æŠ¥å‘Š       | æ¥æ”¶åˆ°è¯·æ±‚ï¼Œç»§ç»­è¿›ç¨‹            |
| 2xx æˆåŠŸ       | æ­¥éª¤æˆåŠŸæ¥æ”¶ï¼Œè¢«ç†è§£ï¼Œå¹¶è¢«æ¥å—  |
| 3xx é‡å®šå‘     | ä¸ºäº†å®Œæˆè¯·æ±‚,å¿…é¡»é‡‡å–è¿›ä¸€æ­¥æªæ–½ |
| 4xx å®¢æˆ·ç«¯å‡ºé”™ | è¯·æ±‚åŒ…æ‹¬é”™çš„é¡ºåºæˆ–ä¸èƒ½å®Œæˆ      |
| 5xx æœåŠ¡å™¨å‡ºé”™ | æœåŠ¡å™¨æ— æ³•å®Œæˆæ˜¾ç„¶æœ‰æ•ˆçš„è¯·æ±‚    |

403: Forbidden
404: Not Found

HTTPSæ¡æ‰‹,å¯¹ç§°åŠ å¯†,éå¯¹ç§°åŠ å¯†,TLS/SSL,RSA

### 9.CSRFå’ŒXSS

- CSRF(Cross-site request forgery)è·¨ç«™è¯·æ±‚ä¼ªé€ 
- XSS(Cross Site Scripting)è·¨ç«™è„šæœ¬æ”»å‡»

CSRF é‡ç‚¹åœ¨è¯·æ±‚ï¼ŒXSS é‡ç‚¹åœ¨è„šæœ¬ã€‚

### 10.å¹‚ç­‰ Idempotence

HTTPæ–¹æ³•çš„å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºåº”è¯¥å…·æœ‰åŒæ ·çš„**å‰¯ä½œç”¨**ã€‚(æ³¨æ„æ˜¯å‰¯ä½œç”¨)

`GET http://www.bank.com/account/123456`ï¼Œä¸ä¼šæ”¹å˜èµ„æºçš„çŠ¶æ€ï¼Œä¸è®ºè°ƒç”¨ä¸€æ¬¡è¿˜æ˜¯Næ¬¡éƒ½æ²¡æœ‰å‰¯ä½œç”¨ã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œå¼ºè°ƒçš„æ˜¯ä¸€æ¬¡å’ŒNæ¬¡å…·æœ‰ç›¸åŒçš„å‰¯ä½œç”¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡GETçš„ç»“æœç›¸åŒã€‚`GET http://www.news.com/latest-news`è¿™ä¸ªHTTPè¯·æ±‚å¯èƒ½ä¼šæ¯æ¬¡å¾—åˆ°ä¸åŒçš„ç»“æœï¼Œä½†å®ƒæœ¬èº«å¹¶æ²¡æœ‰äº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œå› è€Œæ˜¯æ»¡è¶³å¹‚ç­‰æ€§çš„ã€‚

DELETEæ–¹æ³•ç”¨äºåˆ é™¤èµ„æºï¼Œæœ‰å‰¯ä½œç”¨ï¼Œä½†å®ƒåº”è¯¥æ»¡è¶³å¹‚ç­‰æ€§ã€‚æ¯”å¦‚ï¼š`DELETE http://www.forum.com/article/4231`ï¼Œè°ƒç”¨ä¸€æ¬¡å’ŒNæ¬¡å¯¹ç³»ç»Ÿäº§ç”Ÿçš„å‰¯ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œå³åˆ æ‰idä¸º4231çš„å¸–å­ï¼›å› æ­¤ï¼Œè°ƒç”¨è€…å¯ä»¥å¤šæ¬¡è°ƒç”¨æˆ–åˆ·æ–°é¡µé¢è€Œä¸å¿…æ‹…å¿ƒå¼•èµ·é”™è¯¯ã€‚

POSTæ‰€å¯¹åº”çš„URIå¹¶éåˆ›å»ºçš„èµ„æºæœ¬èº«ï¼Œè€Œæ˜¯èµ„æºçš„æ¥æ”¶è€…ã€‚æ¯”å¦‚ï¼š`POST http://www.forum.com/articles`çš„è¯­ä¹‰æ˜¯åœ¨`http://www.forum.com/articles`ä¸‹åˆ›å»ºä¸€ç¯‡å¸–å­ï¼ŒHTTPå“åº”ä¸­åº”åŒ…å«å¸–å­çš„åˆ›å»ºçŠ¶æ€ä»¥åŠå¸–å­çš„URIã€‚ä¸¤æ¬¡ç›¸åŒçš„POSTè¯·æ±‚ä¼šåœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸¤ä»½èµ„æºï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„URIï¼›æ‰€ä»¥ï¼ŒPOSTæ–¹æ³•ä¸å…·å¤‡å¹‚ç­‰æ€§ã€‚

PUTæ‰€å¯¹åº”çš„URIæ˜¯è¦åˆ›å»ºæˆ–æ›´æ–°çš„èµ„æºæœ¬èº«ã€‚æ¯”å¦‚ï¼š`PUT http://www.forum/articles/4231`çš„è¯­ä¹‰æ˜¯åˆ›å»ºæˆ–æ›´æ–°IDä¸º4231çš„å¸–å­ã€‚å¯¹åŒä¸€URIè¿›è¡Œå¤šæ¬¡PUTçš„å‰¯ä½œç”¨å’Œä¸€æ¬¡PUTæ˜¯ç›¸åŒçš„ï¼›å› æ­¤ï¼ŒPUTæ–¹æ³•å…·æœ‰å¹‚ç­‰æ€§ã€‚

### 11.RESTfulæ¶æ„(SOAP,RPC)

æ¨è: http://www.ruanyifeng.com/blog/2011/09/restful.html

### 12.SOAP

SOAPï¼ˆåŸä¸ºSimple Object Access Protocolçš„é¦–å­—æ¯ç¼©å†™ï¼Œå³ç®€å•å¯¹è±¡è®¿é—®åè®®ï¼‰æ˜¯äº¤æ¢æ•°æ®çš„ä¸€ç§åè®®è§„èŒƒï¼Œä½¿ç”¨åœ¨è®¡ç®—æœºç½‘ç»œWebæœåŠ¡ï¼ˆweb serviceï¼‰ä¸­ï¼Œäº¤æ¢å¸¦ç»“æ„ä¿¡æ¯ã€‚SOAPä¸ºäº†ç®€åŒ–ç½‘é¡µæœåŠ¡å™¨ï¼ˆWeb Serverï¼‰ä»XMLæ•°æ®åº“ä¸­æå–æ•°æ®æ—¶ï¼ŒèŠ‚çœå»æ ¼å¼åŒ–é¡µé¢æ—¶é—´ï¼Œä»¥åŠä¸åŒåº”ç”¨ç¨‹åºä¹‹é—´æŒ‰ç…§HTTPé€šä¿¡åè®®ï¼Œéµä»XMLæ ¼å¼æ‰§è¡Œèµ„æ–™äº’æ¢ï¼Œä½¿å…¶æŠ½è±¡äºè¯­è¨€å®ç°ã€å¹³å°å’Œç¡¬ä»¶ã€‚

### 13.RPC

RPCï¼ˆRemote Procedure Call Protocolï¼‰â€”â€”è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œå®ƒæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚RPCåè®®å‡å®šæŸäº›ä¼ è¾“åè®®çš„å­˜åœ¨ï¼Œå¦‚TCPæˆ–UDPï¼Œä¸ºé€šä¿¡ç¨‹åºä¹‹é—´æºå¸¦ä¿¡æ¯æ•°æ®ã€‚åœ¨OSIç½‘ç»œé€šä¿¡æ¨¡å‹ä¸­ï¼ŒRPCè·¨è¶Šäº†ä¼ è¾“å±‚å’Œåº”ç”¨å±‚ã€‚RPCä½¿å¾—å¼€å‘åŒ…æ‹¬ç½‘ç»œåˆ†å¸ƒå¼å¤šç¨‹åºåœ¨å†…çš„åº”ç”¨ç¨‹åºæ›´åŠ å®¹æ˜“ã€‚

æ€»ç»“:æœåŠ¡æä¾›çš„ä¸¤å¤§æµæ´¾.ä¼ ç»Ÿæ„ä¹‰ä»¥æ–¹æ³•è°ƒç”¨ä¸ºå¯¼å‘é€šç§°RPCã€‚ä¸ºäº†ä¼ä¸šSOA,è‹¥å¹²å‚å•†è”åˆæ¨å‡ºwebservice,åˆ¶å®šäº†wsdlæ¥å£å®šä¹‰,ä¼ è¾“soap.å½“äº’è”ç½‘æ—¶ä»£,è‡ƒè‚¿SOAè¢«ç®€åŒ–ä¸ºhttp+xml/json.ä½†æ˜¯ç®€åŒ–å‡ºç°å„ç§æ··ä¹±ã€‚ä»¥èµ„æºä¸ºå¯¼å‘,ä»»ä½•æ“ä½œæ— éæ˜¯å¯¹èµ„æºçš„å¢åˆ æ”¹æŸ¥ï¼Œäºæ˜¯ç»Ÿä¸€çš„RESTå‡ºç°äº†.

è¿›åŒ–çš„é¡ºåº: RPC -> SOAP -> RESTful

### 14.CGIå’ŒWSGI

CGIæ˜¯é€šç”¨ç½‘å…³æ¥å£ï¼Œæ˜¯è¿æ¥webæœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºçš„æ¥å£ï¼Œç”¨æˆ·é€šè¿‡CGIæ¥è·å–åŠ¨æ€æ•°æ®æˆ–æ–‡ä»¶ç­‰ã€‚
CGIç¨‹åºæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºï¼Œå®ƒå¯ä»¥ç”¨å‡ ä¹æ‰€æœ‰è¯­è¨€æ¥å†™ï¼ŒåŒ…æ‹¬perlï¼Œcï¼Œluaï¼Œpythonç­‰ç­‰ã€‚

WSGI, Web Server Gateway Interfaceï¼Œæ˜¯Pythonåº”ç”¨ç¨‹åºæˆ–æ¡†æ¶å’ŒWebæœåŠ¡å™¨ä¹‹é—´çš„ä¸€ç§æ¥å£ï¼ŒWSGIçš„å…¶ä¸­ä¸€ä¸ªç›®çš„å°±æ˜¯è®©ç”¨æˆ·å¯ä»¥ç”¨ç»Ÿä¸€çš„è¯­è¨€(Python)ç¼–å†™å‰åç«¯ã€‚

å®˜æ–¹è¯´æ˜ï¼š[PEP-3333](https://www.python.org/dev/peps/pep-3333/)

### 15.ä¸­é—´äººæ”»å‡»

ä¸­é—´äººæ”»å‡»ï¼ˆMan-in-the-middle attackï¼Œé€šå¸¸ç¼©å†™ä¸ºMITMï¼‰æ˜¯æŒ‡æ”»å‡»è€…ä¸é€šè®¯çš„ä¸¤ç«¯åˆ†åˆ«åˆ›å»ºç‹¬ç«‹çš„è”ç³»ï¼Œå¹¶äº¤æ¢å…¶æ‰€æ”¶åˆ°çš„æ•°æ®ï¼Œä½¿é€šè®¯çš„ä¸¤ç«¯è®¤ä¸ºä»–ä»¬æ­£åœ¨é€šè¿‡ä¸€ä¸ªç§å¯†çš„è¿æ¥ä¸å¯¹æ–¹ç›´æ¥å¯¹è¯ï¼Œä½†äº‹å®ä¸Šæ•´ä¸ªä¼šè¯éƒ½è¢«æ”»å‡»è€…å®Œå…¨æ§åˆ¶ã€‚

### 16.c10ké—®é¢˜

æ‰€è°“c10ké—®é¢˜ï¼ŒæŒ‡çš„æ˜¯æœåŠ¡å™¨åŒæ—¶æ”¯æŒæˆåƒä¸Šä¸‡ä¸ªå®¢æˆ·ç«¯çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯concurrent 10 000 connectionï¼ˆè¿™ä¹Ÿæ˜¯c10kè¿™ä¸ªåå­—çš„ç”±æ¥ï¼‰ã€‚

æ¨è: https://my.oschina.net/xianggao/blog/664275

### 17.socket

æ¨è: http://www.360doc.com/content/11/0609/15/5482098_122692444.shtml

Socket=Ip address+ TCP/UDP + port

### 18.æµè§ˆå™¨ç¼“å­˜

æ¨è: http://www.cnblogs.com/skynet/archive/2012/11/28/2792503.html

### 19.HTTP1.0å’ŒHTTP1.1

æ¨è: http://blog.csdn.net/elifefly/article/details/3964766

1. è¯·æ±‚å¤´Hostå­—æ®µ,ä¸€ä¸ªæœåŠ¡å™¨å¤šä¸ªç½‘ç«™
2. é•¿é“¾æ¥
3. æ–‡ä»¶æ–­ç‚¹ç»­ä¼ 
4. èº«ä»½è®¤è¯,çŠ¶æ€ç®¡ç†,Cacheç¼“å­˜

HTTPè¯·æ±‚8ç§æ–¹æ³•ä»‹ç» 

HTTP/1.1åè®®ä¸­å…±å®šä¹‰äº†8ç§HTTPè¯·æ±‚æ–¹æ³•ï¼ŒHTTPè¯·æ±‚æ–¹æ³•ä¹Ÿè¢«å«åšâ€œè¯·æ±‚åŠ¨ä½œâ€ï¼Œä¸åŒçš„æ–¹æ³•è§„å®šäº†ä¸åŒçš„æ“ä½œæŒ‡å®šçš„èµ„æºæ–¹å¼ã€‚æœåŠ¡ç«¯ä¹Ÿä¼šæ ¹æ®ä¸åŒçš„è¯·æ±‚æ–¹æ³•åšä¸åŒçš„å“åº”ã€‚

GET

GETè¯·æ±‚ä¼šæ˜¾ç¤ºè¯·æ±‚æŒ‡å®šçš„èµ„æºã€‚ä¸€èˆ¬æ¥è¯´GETæ–¹æ³•åº”è¯¥åªç”¨äºæ•°æ®çš„è¯»å–ï¼Œè€Œä¸åº”å½“ç”¨äºä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„éå¹‚ç­‰çš„æ“ä½œä¸­ã€‚

GETä¼šæ–¹æ³•è¯·æ±‚æŒ‡å®šçš„é¡µé¢ä¿¡æ¯ï¼Œå¹¶è¿”å›å“åº”ä¸»ä½“ï¼ŒGETè¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„æ–¹æ³•ï¼Œå› ä¸ºGETæ–¹æ³•ä¼šè¢«ç½‘ç»œèœ˜è››ç­‰ä»»æ„çš„è®¿é—®ã€‚

HEAD

HEADæ–¹æ³•ä¸GETæ–¹æ³•ä¸€æ ·ï¼Œéƒ½æ˜¯å‘æœåŠ¡å™¨å‘å‡ºæŒ‡å®šèµ„æºçš„è¯·æ±‚ã€‚ä½†æ˜¯ï¼ŒæœåŠ¡å™¨åœ¨å“åº”HEADè¯·æ±‚æ—¶ä¸ä¼šå›ä¼ èµ„æºçš„å†…å®¹éƒ¨åˆ†ï¼Œå³ï¼šå“åº”ä¸»ä½“ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ä¼ è¾“å…¨éƒ¨å†…å®¹çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥è·å–æœåŠ¡å™¨çš„å“åº”å¤´ä¿¡æ¯ã€‚HEADæ–¹æ³•å¸¸è¢«ç”¨äºå®¢æˆ·ç«¯æŸ¥çœ‹æœåŠ¡å™¨çš„æ€§èƒ½ã€‚

POST

POSTè¯·æ±‚ä¼š å‘æŒ‡å®šèµ„æºæäº¤æ•°æ®ï¼Œè¯·æ±‚æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼Œå¦‚ï¼šè¡¨å•æ•°æ®æäº¤ã€æ–‡ä»¶ä¸Šä¼ ç­‰ï¼Œè¯·æ±‚æ•°æ®ä¼šè¢«åŒ…å«åœ¨è¯·æ±‚ä½“ä¸­ã€‚POSTæ–¹æ³•æ˜¯éå¹‚ç­‰çš„æ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªè¯·æ±‚å¯èƒ½ä¼šåˆ›å»ºæ–°çš„èµ„æºæˆ–/å’Œä¿®æ”¹ç°æœ‰èµ„æºã€‚

PUT

PUTè¯·æ±‚ä¼šèº«å‘æŒ‡å®šèµ„æºä½ç½®ä¸Šä¼ å…¶æœ€æ–°å†…å®¹ï¼ŒPUTæ–¹æ³•æ˜¯å¹‚ç­‰çš„æ–¹æ³•ã€‚é€šè¿‡è¯¥æ–¹æ³•å®¢æˆ·ç«¯å¯ä»¥å°†æŒ‡å®šèµ„æºçš„æœ€æ–°æ•°æ®ä¼ é€ç»™æœåŠ¡å™¨å–ä»£æŒ‡å®šçš„èµ„æºçš„å†…å®¹ã€‚

DELETE

DELETEè¯·æ±‚ç”¨äºè¯·æ±‚æœåŠ¡å™¨åˆ é™¤æ‰€è¯·æ±‚URIï¼ˆç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼ŒUniform Resource Identifierï¼‰æ‰€æ ‡è¯†çš„èµ„æºã€‚DELETEè¯·æ±‚åæŒ‡å®šèµ„æºä¼šè¢«åˆ é™¤ï¼ŒDELETEæ–¹æ³•ä¹Ÿæ˜¯å¹‚ç­‰çš„ã€‚

CONNECT

CONNECTæ–¹æ³•æ˜¯HTTP/1.1åè®®é¢„ç•™çš„ï¼Œèƒ½å¤Ÿå°†è¿æ¥æ”¹ä¸ºç®¡é“æ–¹å¼çš„ä»£ç†æœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äºSSLåŠ å¯†æœåŠ¡å™¨çš„é“¾æ¥ä¸éåŠ å¯†çš„HTTPä»£ç†æœåŠ¡å™¨çš„é€šä¿¡ã€‚

OPTIONS

OPTIONSè¯·æ±‚ä¸HEADç±»ä¼¼ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ç”¨äºå®¢æˆ·ç«¯æŸ¥çœ‹æœåŠ¡å™¨çš„æ€§èƒ½ã€‚ è¿™ä¸ªæ–¹æ³•ä¼šè¯·æ±‚æœåŠ¡å™¨è¿”å›è¯¥èµ„æºæ‰€æ”¯æŒçš„æ‰€æœ‰HTTPè¯·æ±‚æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šç”¨â€™*â€™æ¥ä»£æ›¿èµ„æºåç§°ï¼Œå‘æœåŠ¡å™¨å‘é€OPTIONSè¯·æ±‚ï¼Œå¯ä»¥æµ‹è¯•æœåŠ¡å™¨åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚JavaScriptçš„XMLHttpRequestå¯¹è±¡è¿›è¡ŒCORSè·¨åŸŸèµ„æºå…±äº«æ—¶ï¼Œå°±æ˜¯ä½¿ç”¨OPTIONSæ–¹æ³•å‘é€å—…æ¢è¯·æ±‚ï¼Œä»¥åˆ¤æ–­æ˜¯å¦æœ‰å¯¹æŒ‡å®šèµ„æºçš„è®¿é—®æƒé™ã€‚ å…è®¸

TRACE

TRACEè¯·æ±‚æœåŠ¡å™¨å›æ˜¾å…¶æ”¶åˆ°çš„è¯·æ±‚ä¿¡æ¯ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äºHTTPè¯·æ±‚çš„æµ‹è¯•æˆ–è¯Šæ–­ã€‚

HTTP/1.1ä¹‹åå¢åŠ çš„æ–¹æ³•

åœ¨HTTP/1.1æ ‡å‡†åˆ¶å®šä¹‹åï¼Œåˆé™†ç»­æ‰©å±•äº†ä¸€äº›æ–¹æ³•ã€‚å…¶ä¸­ä½¿ç”¨ä¸­è¾ƒå¤šçš„æ˜¯ PATCH æ–¹æ³•ï¼š

PATCH

PATCHæ–¹æ³•å‡ºç°çš„è¾ƒæ™šï¼Œå®ƒåœ¨2010å¹´çš„RFC 5789æ ‡å‡†ä¸­è¢«å®šä¹‰ã€‚PATCHè¯·æ±‚ä¸PUTè¯·æ±‚ç±»ä¼¼ï¼ŒåŒæ ·ç”¨äºèµ„æºçš„æ›´æ–°ã€‚äºŒè€…æœ‰ä»¥ä¸‹ä¸¤ç‚¹ä¸åŒï¼š

1ã€PATCHä¸€èˆ¬ç”¨äºèµ„æºçš„éƒ¨åˆ†æ›´æ–°ï¼Œè€ŒPUTä¸€èˆ¬ç”¨äºèµ„æºçš„æ•´ä½“æ›´æ–°ã€‚ 

2ã€å½“èµ„æºä¸å­˜åœ¨æ—¶ï¼ŒPATCHä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè€ŒPUTåªä¼šå¯¹å·²åœ¨èµ„æºè¿›è¡Œæ›´æ–°ã€‚

### 20.Ajax

AJAX,Asynchronous JavaScript and XMLï¼ˆå¼‚æ­¥çš„ JavaScript å’Œ XMLï¼‰, æ˜¯ä¸åœ¨ä¸é‡æ–°åŠ è½½æ•´ä¸ªé¡µé¢çš„æƒ…å†µä¸‹ï¼Œä¸æœåŠ¡å™¨äº¤æ¢æ•°æ®å¹¶æ›´æ–°éƒ¨åˆ†ç½‘é¡µçš„æŠ€æœ¯ã€‚

### 21.æ€ä¹ˆå®ç°å¼ºè¡Œå…³é—­å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥?
### 22.ç®€è¿°TCPå’ŒUDPçš„åŒºåˆ«ä»¥åŠä¼˜ç¼ºç‚¹?

æ¨èï¼š[ç®€è¿°TCPå’ŒUDPçš„åŒºåˆ«ä»¥åŠä¼˜ç¼ºç‚¹](https://github.com/yongxinz/tech-blog/blob/master/TCP%E5%92%8CUDP%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BC%98%E7%BC%BA%E7%82%B9%E5%92%8C%E5%8C%BA%E5%88%AB.md)

### 23.ç®€è¿°æµè§ˆå™¨é€šè¿‡WSGIè¯·æ±‚åŠ¨æ€èµ„æºçš„è¿‡ç¨‹?

æµè§ˆå™¨å‘é€çš„è¯·æ±‚è¢«Nginxç›‘å¬åˆ°ï¼ŒNginxæ ¹æ®è¯·æ±‚çš„URLçš„PATHæˆ–è€…åç¼€æŠŠè¯·æ±‚é™æ€èµ„æºçš„åˆ†å‘åˆ°é™æ€èµ„æºçš„ç›®å½•ï¼Œåˆ«çš„è¯·æ±‚æ ¹æ®é…ç½®å¥½çš„è½¬å‘åˆ°ç›¸åº”ç«¯å£ã€‚

å®ç°äº†WSGIçš„ç¨‹åºä¼šç›‘å¬æŸä¸ªç«¯å£ï¼Œç›‘å¬åˆ°Nginxè½¬å‘è¿‡æ¥çš„è¯·æ±‚æ¥æ”¶å(ä¸€èˆ¬ç”¨socketçš„recvæ¥æ¥æ”¶HTTPçš„æŠ¥æ–‡)ä»¥åæŠŠè¯·æ±‚çš„æŠ¥æ–‡å°è£…æˆ`environ`çš„å­—å…¸å¯¹è±¡ï¼Œç„¶åå†æä¾›ä¸€ä¸ª`start_response`çš„æ–¹æ³•ã€‚æŠŠè¿™ä¸¤ä¸ªå¯¹è±¡å½“æˆå‚æ•°ä¼ å…¥æŸä¸ªæ–¹æ³•æ¯”å¦‚`wsgi_app(environ, start_response)`æˆ–è€…å®ç°äº†`__call__(self, environ, start_response)`æ–¹æ³•çš„æŸä¸ªå®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹å†è°ƒç”¨`start_response`è¿”å›ç»™å®ç°äº†WSGIçš„ä¸­é—´ä»¶ï¼Œå†ç”±ä¸­é—´ä»¶è¿”å›ç»™Nginxã€‚

### 24.æè¿°ç”¨æµè§ˆå™¨è®¿é—®www.baidu.comçš„è¿‡ç¨‹

æ¨èï¼šhttps://www.zhihu.com/question/34873227/answer/518086565

1ã€å®¢æˆ·ç«¯æµè§ˆå™¨é€šè¿‡DNSè§£æåˆ°www.baidu.comçš„IPåœ°å€202.108.22.5ï¼Œé€šè¿‡è¿™ä¸ªIPåœ°å€æ‰¾åˆ°å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„è·¯å¾„ã€‚å®¢æˆ·ç«¯æµè§ˆå™¨å‘èµ·ä¸€ä¸ªHTTPä¼šè¯åˆ°202.108.22.5ï¼Œç„¶åé€šè¿‡TCPè¿›è¡Œå°è£…æ•°æ®åŒ…ï¼Œè¾“å…¥åˆ°ç½‘ç»œå±‚ã€‚

2ã€åœ¨å®¢æˆ·ç«¯çš„ä¼ è¾“å±‚ï¼ŒæŠŠHTTPä¼šè¯è¯·æ±‚åˆ†æˆæŠ¥æ–‡æ®µï¼Œæ·»åŠ æºå’Œç›®çš„ç«¯å£ï¼Œå¦‚æœåŠ¡å™¨ä½¿ç”¨80ç«¯å£ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ç”±ç³»ç»Ÿéšæœºé€‰æ‹©ä¸€ä¸ªç«¯å£å¦‚5000ï¼Œä¸æœåŠ¡å™¨è¿›è¡Œäº¤æ¢ï¼ŒæœåŠ¡å™¨æŠŠç›¸åº”çš„è¯·æ±‚è¿”å›ç»™å®¢æˆ·ç«¯çš„5000ç«¯å£ã€‚ç„¶åä½¿ç”¨IPå±‚çš„IPåœ°å€æŸ¥æ‰¾ç›®çš„ç«¯ã€‚

3ã€å®¢æˆ·ç«¯çš„ç½‘ç»œå±‚ä¸ç”¨å…³å¿ƒåº”ç”¨å±‚æˆ–è€…ä¼ è¾“å±‚çš„ä¸œè¥¿ï¼Œä¸»è¦åšçš„æ˜¯é€šè¿‡æŸ¥æ‰¾è·¯ç”±è¡¨ç¡®å®šå¦‚ä½•åˆ°è¾¾æœåŠ¡å™¨ï¼ŒæœŸé—´å¯èƒ½ç»è¿‡å¤šä¸ªè·¯ç”±å™¨ï¼Œè¿™äº›éƒ½æ˜¯ç”±è·¯ç”±å™¨æ¥å®Œæˆçš„å·¥ä½œï¼Œæˆ‘ä¸ä½œè¿‡å¤šçš„æè¿°ï¼Œæ— éå°±æ˜¯é€šè¿‡æŸ¥æ‰¾è·¯ç”±è¡¨å†³å®šé€šè¿‡é‚£ä¸ªè·¯å¾„åˆ°è¾¾æœåŠ¡å™¨ã€‚

4ã€å®¢æˆ·ç«¯çš„é“¾è·¯å±‚ï¼ŒåŒ…é€šè¿‡é“¾è·¯å±‚å‘é€åˆ°è·¯ç”±å™¨ï¼Œé€šè¿‡é‚»å±…åè®®æŸ¥æ‰¾ç»™å®šIPåœ°å€çš„MACåœ°å€ï¼Œç„¶åå‘é€ARPè¯·æ±‚æŸ¥æ‰¾ç›®çš„åœ°å€ï¼Œå¦‚æœå¾—åˆ°å›åº”åå°±å¯ä»¥ä½¿ç”¨ARPçš„è¯·æ±‚åº”ç­”äº¤æ¢çš„IPæ•°æ®åŒ…ç°åœ¨å°±å¯ä»¥ä¼ è¾“äº†ï¼Œç„¶åå‘é€IPæ•°æ®åŒ…åˆ°è¾¾æœåŠ¡å™¨çš„åœ°å€ã€‚

**äº‹ä»¶é¡ºåºï¼š**

1. æµè§ˆå™¨è·å–è¾“å…¥çš„åŸŸå www.baidu.com
1. æµè§ˆå™¨å‘DNSè¯·æ±‚è§£æwww.baidu.comçš„IPåœ°å€
1. åŸŸåç³»ç»ŸDNSè§£æå‡ºç™¾åº¦æœåŠ¡å™¨çš„IPåœ°å€
1. æµè§ˆå™¨ä¸è¯¥æœåŠ¡å™¨å»ºç«‹TCPè¿æ¥(é»˜è®¤ç«¯å£å·80)
1. æµè§ˆå™¨å‘å‡ºHTTPè¯·æ±‚ï¼Œè¯·æ±‚ç™¾åº¦é¦–é¡µ
1. æœåŠ¡å™¨é€šè¿‡HTTPå“åº”æŠŠé¦–é¡µæ–‡ä»¶å‘é€ç»™æµè§ˆå™¨
1. TCPè¿æ¥é‡Šæ”¾
1. æµè§ˆå™¨å°†é¦–é¡µæ–‡ä»¶è¿›è¡Œè§£æï¼Œå¹¶å°†Webé¡µæ˜¾ç¤ºç»™ç”¨æˆ·ã€‚

**æ¶‰åŠåˆ°çš„åè®®ï¼š**

1ã€åº”ç”¨å±‚ï¼šHTTP(wwwè®¿é—®åè®®)ï¼ŒDNS(åŸŸåè§£ææœåŠ¡)DNSè§£æåŸŸåä¸ºç›®çš„IPï¼Œé€šè¿‡IPæ‰¾åˆ°æœåŠ¡å™¨è·¯å¾„ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·HTTPä¼šè¯ï¼Œç„¶åé€šè¿‡è¿è¾“å±‚TCPåè®®å°è£…æ•°æ®åŒ…ï¼Œåœ¨TCPåè®®åŸºç¡€ä¸Šè¿›è¡Œä¼ è¾“ã€‚

2ã€ä¼ è¾“å±‚ï¼šTCP(ä¸ºHTTPæä¾›å¯é çš„æ•°æ®ä¼ è¾“)ï¼ŒUDP(DNSä½¿ç”¨UDPä¼ è¾“)HTTPä¼šè¯ä¼šè¢«åˆ†æˆæŠ¥æ–‡æ®µï¼Œæ·»åŠ æºã€ç›®çš„ç«¯å£ï¼›TCPåè®®è¿›è¡Œä¸»è¦å·¥ä½œã€‚

3ã€ç½‘ç»œå±‚ï¼šIP(IPæ•°æ®æ•°æ®åŒ…ä¼ è¾“å’Œè·¯ç”±é€‰æ‹©)ï¼ŒICMP(æä¾›ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­çš„å·®é”™æ£€æµ‹)ï¼ŒARP(å°†æœ¬æœºçš„é»˜è®¤ç½‘å…³IPåœ°å€æ˜ å°„æˆç‰©ç†MACåœ°å€)ä¸ºæ•°æ®åŒ…é€‰æ‹©è·¯ç”±ï¼ŒIPåè®®è¿›è¡Œä¸»è¦å·¥ä½œï¼Œç›¸é‚»ç»“ç‚¹çš„å¯é ä¼ è¾“ï¼ŒARPåè®®å°†IPåœ°å€è½¬æˆMACåœ°å€ã€‚

### 25.åˆ—å‡ºä½ çŸ¥é“çš„HTTPåè®®çš„çŠ¶æ€ç ï¼Œè¯´å‡ºè¡¨ç¤ºä»€ä¹ˆæ„æ€ï¼Ÿ

æ¨èï¼šhttps://www.cnblogs.com/starof/p/5035119.html

### 26.è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯tcpçš„2MSLï¼Ÿ
### 27.ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯åœ¨TIME-WAITçŠ¶æ€å¿…é¡»ç­‰å¾…2MSLçš„æ—¶é—´ï¼Ÿ
### 28.è°ˆä¸€ä¸‹HTTPåè®®ä»¥åŠåè®®å¤´éƒ¨ä¸­è¡¨ç¤ºæ•°æ®ç±»å‹çš„å­—æ®µï¼Ÿ
### 29.ä½¿ç”¨Socketå¥—æ¥å­—éœ€è¦ä¼ å…¥å“ªäº›å‚æ•° ï¼Ÿ
### 30.HTTPå¸¸è§è¯·æ±‚å¤´ï¼Ÿ

æ¨èï¼šhttps://juejin.im/post/5c17d3cd5188250d9e604628

### 31.ä¸ƒå±‚æ¨¡å‹ï¼Ÿ

æ¨èï¼šhttps://juejin.im/post/59eb06b1f265da430f313c7f

### 32.urlçš„å½¢å¼ï¼Ÿ

1ã€TCP é˜»å¡å¦‚ä½•è§£å†³ã€‚1ã€é¡¹ç›®ç»†èŠ‚è®²è§£ï¼Œæµç¨‹å›¾ï¼Œç“¶é¢ˆåœ¨å“ªå„¿

é¡¹ç›®æ•´ä½“æ¶æ„
å…±åŒ…å«å“ªäº›æœåŠ¡
æœåŠ¡ä¹‹é—´ä¿¡æ¯æµæ˜¯å¦‚ä½•æµè½¬çš„
åœ¨é¡¹ç›®ä¸­ï¼Œæœ‰æ²¡æœ‰é‡åˆ°ä»€ä¹ˆéš¾ç‚¹
æœ‰æ²¡æœ‰æ’æŸ¥è¿‡é¡¹ç›®çš„çº¿ä¸Šé—®é¢˜
ä½ è§‰å¾—ä½ ç°åœ¨çš„è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ä¹ˆï¼Ÿ
å¦‚æœä½ è´Ÿè´£çš„æœåŠ¡ä»100TPSå˜æˆ1ä¸‡TPSä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿæ€ä¹ˆå¤„ç†ï¼Ÿ
å¦‚æœä½ è´Ÿè´£çš„è¿™ä¸ªåŠŸèƒ½ä¹‹åéœ€è¦é¢‘ç¹å˜æ›´ï¼Œä½ æ€ä¹ˆè®¾è®¡ï¼Ÿ
ç­‰ç­‰ç­‰

2ã€QPSï¼Œå¦‚ä½•å‹æµ‹ï¼Œæ€§èƒ½æµ‹è¯•ï¼Œæ€§èƒ½æŒ‡æ ‡ï¼Œæ€§èƒ½ä¼˜åŒ–ã€‚

3ã€ç§’æ€åœºæ™¯è®¾è®¡

4ã€é«˜å¹¶å‘

5ã€åˆ†å¸ƒå¼é”å®ç°æ–¹æ¡ˆã€‚

6ã€1G å†…å­˜ï¼Œ1T æ–‡ä»¶ï¼Œæƒ³æ‰¾åˆ°å‡ºç°æ¬¡æ•°ç¬¬äºŒå¤§çš„å­—ç¬¦ä¸²ã€‚

7ã€é¡¹ç›®æ¶æ„å›¾ï¼Œè‡ªæˆ‘æ„Ÿè§‰é¡¹ç›®éš¾ç‚¹ï¼Œç°åœ¨å†è®©ä½ é‡æ–°åšè¿™ä¸ªé¡¹ç›®ä½ ä¼šæœ‰ä»€ä¹ˆä¿®æ”¹è·Ÿè°ƒæ•´

8ã€å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œè‡ªå·±é€‰æ‹©ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•æ¥å®ç°å¹¶è¿›è¡Œè‡ªæµ‹ã€‚

9ã€å¸¸ç”¨é™æµæ–¹æ³•ï¼Œè‡ªå·±å’‹å®ç°ã€‚

10ã€åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªçš„å®ç°è·Ÿç†è§£ã€‚
## ç¿»è½¬å­—ç¬¦ä¸²

**é—®é¢˜æè¿°**

è¯·å®ç°ä¸€ä¸ªç®—æ³•ï¼Œåœ¨ä¸ä½¿ç”¨ã€é¢å¤–æ•°æ®ç»“æ„å’Œå‚¨å­˜ç©ºé—´ã€‘çš„æƒ…å†µä¸‹ï¼Œç¿»è½¬ä¸€ä¸ªç»™å®šçš„å­—ç¬¦ä¸²(å¯ä»¥ä½¿ç”¨å•ä¸ªè¿‡ç¨‹å˜é‡)ã€‚

ç»™å®šä¸€ä¸ªstringï¼Œè¯·è¿”å›ä¸€ä¸ªstringï¼Œä¸ºç¿»è½¬åçš„å­—ç¬¦ä¸²ã€‚ä¿è¯å­—ç¬¦ä¸²çš„é•¿åº¦å°äºç­‰äº5000ã€‚

**è§£é¢˜æ€è·¯**

ç¿»è½¬å­—ç¬¦ä¸²å…¶å®æ˜¯å°†ä¸€ä¸ªå­—ç¬¦ä¸²ä»¥ä¸­é—´å­—ç¬¦ä¸ºè½´ï¼Œå‰åç¿»è½¬ï¼Œå³å°†str[len]èµ‹å€¼ç»™str[0],å°†str[0] èµ‹å€¼ str[len]ã€‚

**æºç å‚è€ƒ**

```
func reverString(s string) (string, bool) {
    str := []rune(s)
    l := len(str)
    if l > 5000 {
        return s, false
    }
    for i := 0; i < l/2; i++ {
        str[i], str[l-1-i] = str[l-1-i], str[i]
    }
    return string(str), true
}
```

**æºç è§£æ**

ä»¥å­—ç¬¦ä¸²é•¿åº¦çš„1/2ä¸ºè½´ï¼Œå‰åèµ‹å€¼
## åˆ¤æ–­ä¸¤ä¸ªç»™å®šçš„å­—ç¬¦ä¸²æ’åºåæ˜¯å¦ä¸€è‡´

**é—®é¢˜æè¿°**

ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œè¯·ç¼–å†™ç¨‹åºï¼Œç¡®å®šå…¶ä¸­ä¸€ä¸ªå­—ç¬¦ä¸²çš„å­—ç¬¦é‡æ–°æ’åˆ—åï¼Œèƒ½å¦å˜æˆå¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚
è¿™é‡Œè§„å®šã€å¤§å°å†™ä¸ºä¸åŒå­—ç¬¦ã€‘ï¼Œä¸”è€ƒè™‘å­—ç¬¦ä¸²é‡ç‚¹ç©ºæ ¼ã€‚ç»™å®šä¸€ä¸ªstring s1å’Œä¸€ä¸ªstring s2ï¼Œè¯·è¿”å›ä¸€ä¸ªboolï¼Œä»£è¡¨ä¸¤ä¸²æ˜¯å¦é‡æ–°æ’åˆ—åå¯ç›¸åŒã€‚
ä¿è¯ä¸¤ä¸²çš„é•¿åº¦éƒ½å°äºç­‰äº5000ã€‚

**è§£é¢˜æ€è·¯**

é¦–å…ˆè¦ä¿è¯å­—ç¬¦ä¸²é•¿åº¦å°äº5000ã€‚ä¹‹ååªéœ€è¦ä¸€æ¬¡å¾ªç¯éå†s1ä¸­çš„å­—ç¬¦åœ¨s2æ˜¯å¦éƒ½å­˜åœ¨å³å¯ã€‚

**æºç å‚è€ƒ**

```
func isRegroup(s1,s2 string) bool {
	sl1 := len([]rune(s1))
	sl2 := len([]rune(s2))

	if sl1 > 5000 || sl2 > 5000 || sl1 != sl2{
		return false
	}

	for _,v := range s1 {
		if strings.Count(s1,string(v)) != strings.Count(s2,string(v)) {
			return false
		}
	}
	return true
}
```

**æºç è§£æ**

è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨golangå†…ç½®æ–¹æ³• `strings.Count` æ¥åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸€è‡´ã€‚
## å­—ç¬¦ä¸²æ›¿æ¢é—®é¢˜

**é—®é¢˜æè¿°**

è¯·ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼å…¨éƒ¨æ›¿æ¢ä¸ºâ€œ%20â€ã€‚
å‡å®šè¯¥å­—ç¬¦ä¸²æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜æ”¾æ–°å¢çš„å­—ç¬¦ï¼Œå¹¶ä¸”çŸ¥é“å­—ç¬¦ä¸²çš„çœŸå®é•¿åº¦(å°äºç­‰äº1000)ï¼ŒåŒæ—¶ä¿è¯å­—ç¬¦ä¸²ç”±ã€å¤§å°å†™çš„è‹±æ–‡å­—æ¯ç»„æˆã€‘ã€‚
ç»™å®šä¸€ä¸ªstringä¸ºåŸå§‹çš„ä¸²ï¼Œè¿”å›æ›¿æ¢åçš„stringã€‚

**è§£é¢˜æ€è·¯**

ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯åªèƒ½æ˜¯è‹±æ–‡å­—æ¯ï¼Œç¬¬äºŒä¸ªæ˜¯æ›¿æ¢ç©ºæ ¼ã€‚

**æºç å‚è€ƒ**

```
func replaceBlank(s string) (string, bool) {
	if len([]rune(s)) > 1000 {
		return s, false
	}
	for _, v := range s {
		if string(v) != " " && unicode.IsLetter(v) == false {
			return s, false
		}
	}
	return strings.Replace(s, " ", "%20", -1), true
}
```

**æºç è§£æ**

è¿™é‡Œä½¿ç”¨äº†golangå†…ç½®æ–¹æ³•`unicode.IsLetter`åˆ¤æ–­å­—ç¬¦æ˜¯å¦æ˜¯å­—æ¯ï¼Œä¹‹åä½¿ç”¨`strings.Replace`æ¥æ›¿æ¢ç©ºæ ¼ã€‚## æœºå™¨äººåæ ‡é—®é¢˜

**é—®é¢˜æè¿°**

æœ‰ä¸€ä¸ªæœºå™¨äººï¼Œç»™ä¸€ä¸²æŒ‡ä»¤ï¼ŒLå·¦è½¬ Rå³è½¬ï¼ŒFå‰è¿›ä¸€æ­¥ï¼ŒBåé€€ä¸€æ­¥ï¼Œé—®æœ€åæœºå™¨äººçš„åæ ‡ï¼Œæœ€å¼€å§‹ï¼Œæœºå™¨äººä½äº 0 0ï¼Œæ–¹å‘ä¸ºæ­£Yã€‚
å¯ä»¥è¾“å…¥é‡å¤æŒ‡ä»¤n ï¼š æ¯”å¦‚ R2(LF) è¿™ä¸ªç­‰äºæŒ‡ä»¤ RLFLFã€‚
é—®æœ€åæœºå™¨äººçš„åæ ‡æ˜¯å¤šå°‘ï¼Ÿ

**è§£é¢˜æ€è·¯**

è¿™é‡Œçš„ä¸€ä¸ªéš¾ç‚¹æ˜¯è§£æé‡å¤æŒ‡ä»¤ã€‚ä¸»è¦æŒ‡ä»¤è§£ææˆåŠŸï¼Œè®¡ç®—åæ ‡å°±ç®€å•äº†ã€‚

**æºç å‚è€ƒ**

```
package main

import (
	"unicode"
)

const (
	Left = iota
	Top
	Right
	Bottom
)

func main() {
	println(move("R2(LF)", 0, 0, Top))
}

func move(cmd string, x0 int, y0 int, z0 int) (x, y, z int) {
	x, y, z = x0, y0, z0
	repeat := 0
	repeatCmd := ""
	for _, s := range cmd {
		switch {
		case unicode.IsNumber(s):
			repeat = repeat*10 + (int(s) - '0')
		case s == ')':
			for i := 0; i < repeat; i++ {
				x, y, z = move(repeatCmd, x, y, z)
			}
			repeat = 0
			repeatCmd = ""
		case repeat > 0 && s != '(' && s != ')':
			repeatCmd = repeatCmd + string(s)
		case s == 'L':
			z = (z + 1) % 4
		case s == 'R':
			z = (z - 1 + 4) % 4
		case s == 'F':
			switch {
			case z == Left || z == Right:
				x = x - z + 1
			case z == Top || z == Bottom:
				y = y - z + 2
			}
		case s == 'B':
			switch {
			case z == Left || z == Right:
				x = x + z - 1
			case z == Top || z == Bottom:
				y = y + z - 2
			}
		}
	}
	return
}

```

**æºç è§£æ**

è¿™é‡Œä½¿ç”¨ä¸‰ä¸ªå€¼è¡¨ç¤ºæœºå™¨äººå½“å‰çš„çŠ¶å†µï¼Œåˆ†åˆ«æ˜¯ï¼šxè¡¨ç¤ºxåæ ‡ï¼Œyè¡¨ç¤ºyåæ ‡ï¼Œzè¡¨ç¤ºå½“å‰æ–¹å‘ã€‚
Lã€R å‘½ä»¤ä¼šæ”¹å˜å€¼zï¼ŒFã€Bå‘½ä»¤ä¼šæ”¹å˜å€¼xã€yã€‚
å€¼xã€yçš„æ”¹å˜è¿˜å—å½“å‰çš„zå€¼å½±å“ã€‚

å¦‚æœæ˜¯é‡å¤æŒ‡ä»¤ï¼Œé‚£ä¹ˆå°†é‡å¤æ¬¡æ•°å’Œé‡å¤çš„æŒ‡ä»¤å­˜èµ·æ¥é€’å½’è°ƒç”¨å³å¯ã€‚
## å¸¸è§è¯­æ³•é¢˜ç›® ä¸€

### 1ã€ä¸‹é¢ä»£ç èƒ½è¿è¡Œå—ï¼Ÿä¸ºä»€ä¹ˆã€‚

```go
type Param map[string]interface{}

type Show struct {
	Param
}

func main1() {
	s := new(Show)
	s.Param["RMB"] = 10000
}
```

**è§£æ**

å…±å‘ç°ä¸¤ä¸ªé—®é¢˜ï¼š

1. `main` å‡½æ•°ä¸èƒ½åŠ æ•°å­—ã€‚
2. `new` å…³é”®å­—æ— æ³•åˆå§‹åŒ– `Show` ç»“æ„ä½“ä¸­çš„ `Param` å±æ€§ï¼Œæ‰€ä»¥ç›´æ¥å¯¹ `s.Param` æ“ä½œä¼šå‡ºé”™ã€‚

### 2ã€è¯·è¯´å‡ºä¸‹é¢ä»£ç å­˜åœ¨ä»€ä¹ˆé—®é¢˜ã€‚

```go
type student struct {
	Name string
}

func zhoujielun(v interface{}) {
	switch msg := v.(type) {
	case *student, student:
		msg.Name
	}
}
```

**è§£æï¼š**

golangä¸­æœ‰è§„å®šï¼Œ`switch type`çš„`case T1`ï¼Œç±»å‹åˆ—è¡¨åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆ`v := m.(type)`ä¸­çš„`v`çš„ç±»å‹å°±æ˜¯T1ç±»å‹ã€‚

å¦‚æœæ˜¯`case T1, T2`ï¼Œç±»å‹åˆ—è¡¨ä¸­æœ‰å¤šä¸ªï¼Œé‚£`v`çš„ç±»å‹è¿˜æ˜¯å¤šå¯¹åº”æ¥å£çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯`m`çš„ç±»å‹ã€‚

æ‰€ä»¥è¿™é‡Œ`msg`çš„ç±»å‹è¿˜æ˜¯`interface{}`ï¼Œæ‰€ä»¥ä»–æ²¡æœ‰`Name`è¿™ä¸ªå­—æ®µï¼Œç¼–è¯‘é˜¶æ®µå°±ä¼šæŠ¥é”™ã€‚å…·ä½“è§£é‡Šè§ï¼š <https://golang.org/ref/spec#Type_switches>

### 3ã€å†™å‡ºæ‰“å°çš„ç»“æœã€‚

```go
type People struct {
	name string `json:"name"`
}

func main() {
	js := `{
		"name":"11"
	}`
	var p People
	err := json.Unmarshal([]byte(js), &p)
	if err != nil {
		fmt.Println("err: ", err)
		return
	}
	fmt.Println("people: ", p)
}
```

**è§£æï¼š**

æŒ‰ç…§ golang çš„è¯­æ³•ï¼Œå°å†™å¼€å¤´çš„æ–¹æ³•ã€å±æ€§æˆ– `struct` æ˜¯ç§æœ‰çš„ï¼ŒåŒæ ·ï¼Œåœ¨`json` è§£ç æˆ–è½¬ç çš„æ—¶å€™ä¹Ÿæ— æ³•ä¸Šçº¿ç§æœ‰å±æ€§çš„è½¬æ¢ã€‚

é¢˜ç›®ä¸­æ˜¯æ— æ³•æ­£å¸¸å¾—åˆ°`People`çš„`name`å€¼çš„ã€‚è€Œä¸”ï¼Œç§æœ‰å±æ€§`name`ä¹Ÿä¸åº”è¯¥åŠ `json`çš„æ ‡ç­¾ã€‚


### 4ã€ä¸‹é¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œè¯·è¯´æ˜åŸå› ã€‚

```go
type People struct {
	Name string
}

func (p *People) String() string {
	return fmt.Sprintf("print: %v", p)
}

func main() {
 	p := &People{}
	p.String()
}
```

**è§£æï¼š**

åœ¨golangä¸­`String() string` æ–¹æ³•å®é™…ä¸Šæ˜¯å®ç°äº†`String`çš„æ¥å£çš„ï¼Œè¯¥æ¥å£å®šä¹‰åœ¨`fmt/print.go`  ä¸­ï¼š

```go
type Stringer interface {
	String() string
}
```

åœ¨ä½¿ç”¨ `fmt` åŒ…ä¸­çš„æ‰“å°æ–¹æ³•æ—¶ï¼Œå¦‚æœç±»å‹å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œä¼šç›´æ¥è°ƒç”¨ã€‚è€Œé¢˜ç›®ä¸­æ‰“å° `p` çš„æ—¶å€™ä¼šç›´æ¥è°ƒç”¨ `p` å®ç°çš„ `String()` æ–¹æ³•ï¼Œç„¶åå°±äº§ç”Ÿäº†å¾ªç¯è°ƒç”¨ã€‚


### 5ã€è¯·æ‰¾å‡ºä¸‹é¢ä»£ç çš„é—®é¢˜æ‰€åœ¨ã€‚

```go
func main() {
	ch := make(chan int, 1000)
	go func() {
		for i := 0; i < 10; i++ {
			ch <- i
		}
	}()
	go func() {
		for {
			a, ok := <-ch
			if !ok {
				fmt.Println("close")
				return
			}
			fmt.Println("a: ", a)
		}
	}()
	close(ch)
	fmt.Println("ok")
	time.Sleep(time.Second * 100)
}
```


**è§£æï¼š**

åœ¨ golang ä¸­ `goroutine` çš„è°ƒåº¦æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œåœ¨é¢˜ç›®ä¸­ï¼Œç¬¬ä¸€ä¸ªå†™ `channel` çš„ `goroutine` å¯èƒ½è¿˜æœªè°ƒç”¨ï¼Œæˆ–å·²è°ƒç”¨ä½†æ²¡æœ‰å†™å®Œæ—¶ç›´æ¥ `close` ç®¡é“ï¼Œå¯èƒ½å¯¼è‡´å†™å¤±è´¥ï¼Œæ—¢ç„¶å‡ºç° `panic` é”™è¯¯ã€‚



### 6ã€è¯·è¯´æ˜ä¸‹é¢ä»£ç ä¹¦å†™æ˜¯å¦æ­£ç¡®ã€‚

```go
var value int32

func SetValue(delta int32) {
	for {
		v := value
		if atomic.CompareAndSwapInt32(&value, v, (v+delta)) {
			break
		}
	}
}
```


    
**è§£æï¼š**

`atomic.CompareAndSwapInt32` å‡½æ•°ä¸éœ€è¦å¾ªç¯è°ƒç”¨ã€‚


### 7ã€ä¸‹é¢çš„ç¨‹åºè¿è¡Œåä¸ºä»€ä¹ˆä¼šçˆ†å¼‚å¸¸ã€‚

```go
type Project struct{}

func (p *Project) deferError() {
	if err := recover(); err != nil {
		fmt.Println("recover: ", err)
	}
}

func (p *Project) exec(msgchan chan interface{}) {
	for msg := range msgchan {
		m := msg.(int)
		fmt.Println("msg: ", m)
	}
}

func (p *Project) run(msgchan chan interface{}) {
	for {
		defer p.deferError()
		go p.exec(msgchan)
		time.Sleep(time.Second * 2)
	}
}

func (p *Project) Main() {
	a := make(chan interface{}, 100)
	go p.run(a)
	go func() {
		for {
			a <- "1"
			time.Sleep(time.Second)
		}
	}()
	time.Sleep(time.Second * 100000000000000)
}

func main() {
	p := new(Project)
	p.Main()
}
```

**è§£æï¼š**

æœ‰ä¸€ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. `time.Sleep` çš„å‚æ•°æ•°å€¼å¤ªå¤§ï¼Œè¶…è¿‡äº† `1<<63 - 1` çš„é™åˆ¶ã€‚
2. `defer p.deferError()` éœ€è¦åœ¨åç¨‹å¼€å§‹å‡ºè°ƒç”¨ï¼Œå¦åˆ™æ— æ³•æ•è· `panic`ã€‚


### 8ã€è¯·è¯´å‡ºä¸‹é¢ä»£ç å“ªé‡Œå†™é”™äº†

```go
func main() {
	abc := make(chan int, 1000)
	for i := 0; i < 10; i++ {
		abc <- i
	}
	go func() {
		for  a := range abc  {
			fmt.Println("a: ", a)
		}
	}()
	close(abc)
	fmt.Println("close")
	time.Sleep(time.Second * 100)
}
```

**è§£æï¼š**

åç¨‹å¯èƒ½è¿˜æœªå¯åŠ¨ï¼Œç®¡é“å°±å…³é—­äº†ã€‚


### 9ã€è¯·è¯´å‡ºä¸‹é¢ä»£ç ï¼Œæ‰§è¡Œæ—¶ä¸ºä»€ä¹ˆä¼šæŠ¥é”™

```go
type Student struct {
	name string
}

func main() {
	m := map[string]Student{"people": {"zhoujielun"}}
	m["people"].name = "wuyanzu"
}

```

**è§£æï¼š**

mapçš„valueæœ¬èº«æ˜¯ä¸å¯å¯»å€çš„ï¼Œå› ä¸ºmapä¸­çš„å€¼ä¼šåœ¨å†…å­˜ä¸­ç§»åŠ¨ï¼Œå¹¶ä¸”æ—§çš„æŒ‡é’ˆåœ°å€åœ¨mapæ”¹å˜æ—¶ä¼šå˜å¾—æ— æ•ˆã€‚æ•…å¦‚æœéœ€è¦ä¿®æ”¹mapå€¼ï¼Œå¯ä»¥å°†`map`ä¸­çš„éæŒ‡é’ˆç±»å‹`value`ï¼Œä¿®æ”¹ä¸ºæŒ‡é’ˆç±»å‹ï¼Œæ¯”å¦‚ä½¿ç”¨`map[string]*Student`.


### 10ã€è¯·è¯´å‡ºä¸‹é¢çš„ä»£ç å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```go
type query func(string) string

func exec(name string, vs ...query) string {
	ch := make(chan string)
	fn := func(i int) {
		ch <- vs[i](name)
	}
	for i, _ := range vs {
		go fn(i)
	}
	return <-ch
}

func main() {
	ret := exec("111", func(n string) string {
		return n + "func1"
	}, func(n string) string {
		return n + "func2"
	}, func(n string) string {
		return n + "func3"
	}, func(n string) string {
		return n + "func4"
	})
	fmt.Println(ret)
}
```

**è§£æï¼š** 

ä¾æ®4ä¸ªgoroutineçš„å¯åŠ¨åæ‰§è¡Œæ•ˆç‡ï¼Œå¾ˆå¯èƒ½æ‰“å°111func4ï¼Œä½†å…¶ä»–çš„111func*ä¹Ÿå¯èƒ½å…ˆæ‰§è¡Œï¼Œexecåªä¼šè¿”å›ä¸€æ¡ä¿¡æ¯ã€‚


### 11ã€ä¸‹é¢è¿™æ®µä»£ç ä¸ºä»€ä¹ˆä¼šå¡æ­»ï¼Ÿ

```go
package main

import (
    "fmt"
    "runtime"
)

func main() {
    var i byte
    go func() {
        for i = 0; i <= 255; i++ {
        }
    }()
    fmt.Println("Dropping mic")
    // Yield execution to force executing other goroutines
    runtime.Gosched()
    runtime.GC()
    fmt.Println("Done")
}
```

**è§£æï¼š**

Golang ä¸­ï¼Œbyte å…¶å®è¢« alias åˆ° uint8 ä¸Šäº†ã€‚æ‰€ä»¥ä¸Šé¢çš„ for å¾ªç¯ä¼šå§‹ç»ˆæˆç«‹ï¼Œå› ä¸º i++ åˆ° i=255 çš„æ—¶å€™ä¼šæº¢å‡ºï¼Œi <= 255 ä¸€å®šæˆç«‹ã€‚

ä¹Ÿå³æ˜¯ï¼Œ for å¾ªç¯æ°¸è¿œæ— æ³•é€€å‡ºï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç å…¶å®å¯ä»¥ç­‰ä»·äºè¿™æ ·ï¼š
```go
go func() {
    for {}
}
```

æ­£åœ¨è¢«æ‰§è¡Œçš„ goroutine å‘ç”Ÿä»¥ä¸‹æƒ…å†µæ—¶è®©å‡ºå½“å‰ goroutine çš„æ‰§è¡Œæƒï¼Œå¹¶è°ƒåº¦åé¢çš„ goroutine æ‰§è¡Œï¼š

- IO æ“ä½œ
- Channel é˜»å¡
- system call
- è¿è¡Œè¾ƒé•¿æ—¶é—´

å¦‚æœä¸€ä¸ª goroutine æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œscheduler ä¼šåœ¨å…¶ G å¯¹è±¡ä¸Šæ‰“ä¸Šä¸€ä¸ªæ ‡å¿—ï¼ˆ preemptï¼‰ï¼Œå½“è¿™ä¸ª goroutine å†…éƒ¨å‘ç”Ÿå‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå…ˆä¸»åŠ¨æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœä¸º true åˆ™ä¼šè®©å‡ºæ‰§è¡Œæƒã€‚

main å‡½æ•°é‡Œå¯åŠ¨çš„ goroutine å…¶å®æ˜¯ä¸€ä¸ªæ²¡æœ‰ IO é˜»å¡ã€æ²¡æœ‰ Channel é˜»å¡ã€æ²¡æœ‰ system callã€æ²¡æœ‰å‡½æ•°è°ƒç”¨çš„æ­»å¾ªç¯ã€‚

ä¹Ÿå°±æ˜¯ï¼Œå®ƒæ— æ³•ä¸»åŠ¨è®©å‡ºè‡ªå·±çš„æ‰§è¡Œæƒï¼Œå³ä½¿å·²ç»æ‰§è¡Œå¾ˆé•¿æ—¶é—´ï¼Œscheduler å·²ç»æ ‡å¿—äº† preemptã€‚

è€Œ golang çš„ GC åŠ¨ä½œæ˜¯éœ€è¦æ‰€æœ‰æ­£åœ¨è¿è¡Œ `goroutine` éƒ½åœæ­¢åè¿›è¡Œçš„ã€‚å› æ­¤ï¼Œç¨‹åºä¼šå¡åœ¨ `runtime.GC()` ç­‰å¾…æ‰€æœ‰åç¨‹é€€å‡ºã€‚
